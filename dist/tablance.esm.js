const e=Symbol("schemaWrapper"),t=new Set(["raw","parent","main","details","columns","entry","entries","_autoId","_path","sortDiv","_dataContextPath","_dataPath","dependencyPaths","dependsOnCellPaths","dependsOnDataPath","pxWidth",e]);class s{hostEl;rootEl;neighbourTables;_containerHeight=0;_containerWidth=0;_colSchemaNodes;_cols=[];_headerTr;_headerTable;_allData=[];_data=[];_scrollRowIndex=0;_scrollBody;_scrollingContent;_scrollMarginPx=150;_tableSizer;_mainTable;_mainTbody;_bulkEditArea;_bulkEditTable;_bulkEditAreaOpen=!1;_bulkEditSchemaNodes;_bulkEditAreaHeightPx;_numberOfRowsSelectedSpan;_borderSpacingY;_rowHeight=0;_rowInnerHeight=0;_staticRowHeight;_spreadsheet;_opts;_sortingCols=[];_searchInput;_filter;_cellCursor;_mainRowIndex;_mainColIndex;_activeSchemaNode;_cellCursorDataObj;_selectedCellVal;_selectedCell;_inEditMode;_inputVal;_highlightOnFocus=!0;_detailsBordersHeight;_scrollMethod;_rowsMeta={keys:[],vals:[]};_filesMeta={keys:[],vals:[]};_selectedRows=[];_scrollY=0;_numRenderedRows=0;_openDetailsPanes={};_activeDetailsCell;_ignoreClicksUntil;_highlightRowsOnView={};_lastCheckedIndex;_numRowsSelected=0;_numRowsInViewSelected=0;_animations={};_onlyDetails;_tooltip;_dropdownAlignmentContainer;constructor(e,t,s=!1,i=!1,l=null){this.hostEl=e;const a=this.rootEl=document.createElement("div");this.hostEl.appendChild(this.rootEl),this._spreadsheet=i,this._staticRowHeight=s,this._opts=l??{},a.classList.add("tablance"),this._schema=this._buildSchemaFacade(t),t.main?.columns?(this._colSchemaNodes=this._schema.main.columns,0!=this._opts.searchbar&&this._setupSearchbar(),this._createTableHeader(),this._createTableBody(),new ResizeObserver(this._updateSizesOfViewportAndCols.bind(this)).observe(e),this._setupSpreadsheet(!1),null==this._opts.sortAscHtml&&(this._opts.sortAscHtml='<svg viewBox="0 0 8 10" style="height:1em"><polygon style="fill:#ccc" points="4,0,8,4,0,4"/><polygon style="fill:#000" points="4,10,0,6,8,6"/></svg>'),null==this._opts.sortDescHtml&&(this._opts.sortDescHtml='<svg viewBox="0 0 8 10" style="height:1em"><polygon style="fill:#000" points="4,0,8,4,0,4"/><polygon style="fill:#ccc" points="4,10,0,6,8,6"/></svg>'),null==this._opts.sortNoneHtml&&(this._opts.sortNoneHtml='<svg viewBox="0 0 8 10" style="height:1em"><polygon style="fill:#ccc" points="4,0,8,4,0,4"/><polygon style="fill:#ccc" points="4,10,0,6,8,6"/></svg>'),this._updateHeaderSortHtml(),this._buildDependencyGraph(this._schema),this._createBulkEditArea(t),this._updateSizesOfViewportAndCols()):(this._setupSpreadsheet(!0),this._onlyDetails=!0)}addData(e,t=!1){if(this._onlyDetails)return this._setDataForOnlyDetails(e);const s=this._data.length;t&&(this._searchInput.value=this._filter=""),this._data=this._allData=this._allData.concat(e);let i=this._sortData();if(this._filter)this._filterData(this._filter);else{i?this._refreshTable():this._maybeAddTrs();const e=this._data.length-s;this._tableSizer.style.height=parseInt(this._tableSizer.style.height||0)+e*this._rowHeight+"px"}if(t){for(let t of e)this._highlightRowIndex(this._data.indexOf(t));this.scrollToDataRow(e[0],!1)}}updateData(e,t,s,i=!1,l=!1){let a,n,o=[];if(isNaN(e)?n=this._data.indexOf(a=e):a=this._data[n=e],t="string"==typeof t?t.split(/\.|(?=\[\d*\])/):t,!l){let e=a;for(let i=0;i<t.length;i++){const l=i%2?t[i].replace(/^\[|\]$/g,""):t[i];i==t.length-1?e[l||e.length]=s:e=l?e[l]??(e[l]=i%2?[]:{}):e[e.length]={}}}if(n<this._scrollRowIndex||n>=this._scrollRowIndex+this._numRenderedRows)return;if(1==t.length)for(let e,s=-1;e=this._colSchemaNodes[++s];)if(e.id==t[0]){const t=this._mainTbody.querySelector(`[data-data-row-index="${n}"]:not(.details)`);return this._updateMainRowCell(t.cells[s],e)}let r=this._openDetailsPanes[n];if(r){for(let e,s=0;e=t[s];s+=2){const i=t[s+1]?.replace(/^\[|\]$/g,"");if(r=this._findDescendantInstanceNodeById(r,e),"repeated"==r.schemaNode.type){if(s==t.length-1){const e=r.children;for(let t,s=e.length-!!r.schemaNode.create;t=e[--s];)this._deleteCell(t,!0);r.dataObj=r.parent.dataObj[r.schemaNode.id],r.dataObj.forEach(e=>o.push(this._repeatInsert(r,!1,e)));break}if(!i){o.push(this._repeatInsert(r,!1,r.dataObj.at(-1)));break}r=r.children[i]}}"field"==r.schemaNode.type&&this._updateDetailsCell(r,a),i&&(r.el.scrollIntoView({behavior:"smooth",block:"center"}),o.forEach(e=>this._highlightElements([e,...e.getElementsByTagName("*")]))),this._adjustCursorPosSize(this._selectedCell,!0)}}_buildSchemaFacade(s,i=null){if(!s||"object"!=typeof s)return null;if(s[e])return s;const l=Object.getPrototypeOf(s);if(!(l===Object.prototype||null===l)&&!Array.isArray(s))return null;const a=function(s,i){const l=Object.assign(Object.create(null),{raw:s,[e]:!0});i&&(l.parent=i);return new Proxy(l,{get:(e,s)=>t.has(s)?e[s]:e.raw[s],set(e,s,i){if(t.has(s))return e[s]=i,!0;throw new Error(`Cannot write ${s} to schema-node. Add it to SCHEMA_WRAPPER_KEYS if intended.`)}})}(s,i);if(s.main&&"object"==typeof s.main&&(a.main=this._buildSchemaFacade(s.main,a)),s.details&&"object"==typeof s.details&&(a.details=this._buildSchemaFacade(s.details,a)),Array.isArray(s.columns)){const e=[];for(const t of s.columns){const s=this._buildSchemaFacade(t,a);s&&e.push(s)}e.length&&(a.columns=e)}if(s.entry&&"object"==typeof s.entry&&(a.entry=this._buildSchemaFacade(s.entry,a)),Array.isArray(s.entries)){const e=[];for(const t of s.entries){const s=this._buildSchemaFacade(t,a);s&&e.push(s)}a.entries=e}return a}_closestMeta(e,t){for(let s=e;s;s=s.parent)if(s.meta&&t in s.meta)return s.meta[t]}_findDescendantInstanceNodeById(e,t){for(const s of e.children){if(s.schemaNode.id==t)return s;if(s.children){const e=this._findDescendantInstanceNodeById(s,t);if(e)return e}}}expandRow(e){if(this._onlyDetails)return this._openDetailsPanes[0];let t=this._mainTbody.querySelector(`[data-data-row-index="${e}"]`);return t||(this.scrollToDataRow(this._data[e],!1,!1),this._scrollMethod(),t=this._mainTbody.querySelector(`[data-data-row-index="${e}"]`)),this._expandRow(t),this._openDetailsPanes[e]}scrollToDataRow(e,t=!0,s=!0){let i=0;for(let l,a=-1;l=this._data[++a];){if(l==e)return i=i-this._scrollBody.offsetHeight/2+this._rowHeight,this._scrollBody.scrollTo({top:i,behavior:s?"smooth":"auto"}),void(t&&this._highlightRowIndex(a));i+=this._rowMetaGet(a)?.h??this._rowHeight}}chainTables(...e){const t=[this,...e];t.sort(function(e,t){let s=e.container,i=t.container;for(;!s.parentElement.contains(i);s=s.parentElement);const l=s.parentElement;for(;s.parentElement!=i.parentElement;i=i.parentElement);return Array.from(l.children).indexOf(s)>Array.from(l.children).indexOf(i)?1:-1});for(let e,s=-1;e=t[++s];)e.neighbourTables={up:t[s-1],down:t[s+1]}}selectTopBottomCellOnlyDetails(e){this._highlightOnFocus=!1,this._selectFirstSelectableDetailsCell(this._openDetailsPanes[0],e)}_buildDependencyGraph(e){const t=this._dep_pass1_assignAutoIdsAndMaps(e);this._dep_pass2_assignPathsAndData(e),this._dep_pass3_resolveDependencies(t),this._dep_pass4_cleanup(t)}_dep_pass1_assignAutoIdsAndMaps(e){const t=Object.create(null);t.autoIdCounter=0,t.explicitIdToAutoId=Object.create(null),t.implicitIdToAutoId=Object.create(null),t.schemaNodeByAutoId=Object.create(null),t.seenCellIds=Object.create(null);const s=[],i=e.main&&Array.isArray(e.main.columns)?e.main.columns:[];for(let e=0;e<i.length;e++)s.push(i[e]);e.details&&s.push(e.details),t.initialRoots=s;let l=[...s];for(let e;e=l.pop();){const s=++t.autoIdCounter;if(e._autoId=s,t.schemaNodeByAutoId[s]=e,null!=e.cellId){if(t.seenCellIds[e.cellId])throw new Error(`Duplicate cellId "${e.cellId}".`);t.seenCellIds[e.cellId]=!0,t.explicitIdToAutoId[e.cellId]=s}else null!=e.id&&(t.implicitIdToAutoId[e.id]=s);l.push(...this._dep_children(e))}return t.autoIdByName=Object.assign(Object.create(null),t.implicitIdToAutoId,t.explicitIdToAutoId),t}_dep_pass2_assignPathsAndData(e){e.details&&this._dep_assignPathsAndData(e.details,[],[]);const t=e.main&&Array.isArray(e.main.columns)?e.main.columns:[];for(let e=0;e<t.length;e++)this._dep_assignPathsAndData(t[e],["m",e],[])}_dep_assignPathsAndData(e,t,s=[]){e._path=t;let i=s;if(e.dataPath){const t=Array.isArray(e.dataPath)?e.dataPath:String(e.dataPath).split(".").filter(Boolean);i=[...s,...t]}e._dataContextPath=i,null!=e.id&&(e._dataPath=[...i,String(e.id)]);const l=this._dep_children(e);for(let e=0;e<l.length;e++)this._dep_assignPathsAndData(l[e],[...t,e],i)}_dep_pass3_resolveDependencies(e){let t=[...e.initialRoots];for(let s;s=t.pop();){if(s.dependsOn){const t=Array.isArray(s.dependsOn)?s.dependsOn:[s.dependsOn],i=s._path&&"m"!==s._path[0],l=[],a=[];for(const n of t){const t=e.autoIdByName[n];if(null==t){console.warn(`Unknown dependsOn "${n}".`,s);continue}const o=e.schemaNodeByAutoId[t],r=o._path&&"m"!==o._path[0],h=this._dep_computeForwardPath(o,s);if(h&&(o.dependencyPaths??=[]).push(h),i&&r){const e=this._dep_computeReversePath(s,o);e&&e.length&&l.push(e)}else o._dataPath?a.push(o._dataPath):null==o.id&&null==o.cellId||console.warn("Dependee has no dataPath:",o)}this._dep_finalizeDependency(s,l,a)}t.push(...this._dep_children(s))}}_dep_pass4_cleanup(e){let t=[...e.initialRoots];for(let e;e=t.pop();)delete e._autoId,delete e._path,delete e._dataContextPath,delete e._dataPath,t.push(...this._dep_children(e))}_dep_children(e){for(;e.entry;)e=e.entry;return Array.isArray(e.entries)?e.entries:[]}_dep_computeForwardPath(e,t){const s=e._path,i=t._path;if(!s||!i)return null;if("m"===s[0]&&"m"===i[0])return["m",i[1]];if("m"!==s[0]&&"m"===i[0])return["m",i[1]];if("m"===s[0]&&"m"!==i[0])return["e",...i];let l=0;for(;l<s.length&&l<i.length&&s[l]===i[l];)l++;return["r",...Array(s.length-l).fill(".."),...i.slice(l)]}_dep_computeReversePath(e,t){if(!e._path||!t._path)return null;if("m"===e._path[0]||"m"===t._path[0])return null;const s=e._path,i=t._path;let l=0;for(;l<s.length&&l<i.length&&s[l]===i[l];)l++;return[...Array(s.length-l).fill(".."),...i.slice(l)]}_dep_finalizeDependency(e,t,s){return t.length?(e.dependsOnCellPaths=t,void delete e.dependsOnDataPath):1===s.length?(e.dependsOnDataPath=s[0],delete e.dependsOnCellPaths,void(e._dataPath||(e._dataPath=s[0]))):void(s.length>1&&(console.warn("Multiple data dependencies not supported:",e),e.dependsOnDataPath=s[0],delete e.dependsOnCellPaths,e._dataPath||(e._dataPath=s[0])))}_updateViewportHeight=()=>{this._scrollBody.style.height=this.hostEl.clientHeight-this._headerTable.offsetHeight-(this._searchInput?.offsetHeight??0)-this._bulkEditArea.offsetHeight+"px"};_attachInputFormatter(e,t){(t=this._normalizeInputFormat(t)).numericOnly&&(e.addEventListener("beforeinput",e=>{e.data&&/\D/.test(e.data)&&e.preventDefault()}),e.setAttribute("inputmode","numeric")),e.addEventListener("keydown",s=>{if("Backspace"!==s.key||!t.delimiter)return;const i=e.selectionStart;i>0&&e.value[i-1]===t.delimiter&&(s.preventDefault(),e.value=e.value.slice(0,i-2)+e.value.slice(i),e.setSelectionRange(i-2,i-2),e.dispatchEvent(new Event("input")))});const s=()=>{e.value=this._applyInputFormatting(e.value,t)};e.addEventListener("input",s),s()}_normalizeInputFormat(e){return e.date?(void 0===(e={...e}).blocks&&(e.blocks=[4,2,2]),void 0===e.delimiter&&(e.delimiter="-"),void 0===e.numericOnly&&(e.numericOnly=!0),e):e}_applyInputFormatting(e,t){if(t.numericOnly&&(e=e.replace(/\D/g,"")),t.date)return this._formatDateValue(e,t);if(Array.isArray(t.blocks)){let s="",i=0;const l=t.delimiter??"";for(const a of t.blocks){const t=e.slice(i,i+a);s+=t,i+=t.length,t.length===a&&l&&(s+=l)}return s}return e}_formatDateValue(e,t){if(e.length>=5){const t=e.slice(0,4);let s=e.slice(4,6);if(1===s.length&&+s>1)s="0"+s;else if(2===s.length){let e=Math.min(Math.max(+s,1),12);s=String(e).padStart(2,"0")}e=t+s+e.slice(6)}if(e.length>=7){const t=+e.slice(0,4),s=+e.slice(4,6);let i=e.slice(6,8);if(1===i.length&&+i>3)i="0"+i;else if(2===i.length){let e=+i;const l=new Date(t,s,0).getDate();i=String(Math.min(Math.max(e,1),l)).padStart(2,"0")}e=e.slice(0,6)+i+e.slice(8)}const s=t.blocks,i=t.delimiter??"-";let l="",a=0;for(let t=0;t<s.length;t++){const n=e.slice(a,a+s[t]);l+=n,a+=n.length,n.length===s[t]&&t<s.length-1&&(l+=i)}return l}_setupSearchbar(){this._searchInput=this.rootEl.appendChild(document.createElement("input")),this._searchInput.type=this._searchInput.className="search",this._searchInput.placeholder=this._opts.lang?.filterPlaceholder??"Search",this._searchInput.addEventListener("input",e=>this._onSearchInput(e))}_onSearchInput(e){this._filterData(this._searchInput.value)}_setupSpreadsheet(e){this.rootEl.classList.add("spreadsheet"),this._cellCursor=document.createElement("div"),this._cellCursor.className="cell-cursor",this._cellCursor.style.display="none",e||(this._mainTable.style.borderSpacing=this._headerTable.style.borderSpacing=this._borderSpacingY=0),this.rootEl.addEventListener("focus",e=>this._spreadsheetOnFocus(e)),this.rootEl.addEventListener("blur",e=>this._spreadsheetOnBlur(e)),this.rootEl.tabIndex=0,this.rootEl.addEventListener("keydown",e=>this._spreadsheetKeyDown(e)),this.rootEl.addEventListener("mousedown",e=>this._spreadsheetMouseDown(e)),this._cellCursor.addEventListener("dblclick",e=>this._enterCell(e)),this._tooltip=document.createElement("div"),this._tooltip.classList.add("tooltip"),this._tooltip.appendChild(document.createElement("span"))}_rowMetaGet(e){return this._rowsMeta.vals[this._rowsMeta.keys.indexOf(this._data[e])]}_rowMetaSet(e,t,s){const i=this._rowsMeta.keys.indexOf(this._data[e]);return-1==i&&null!=s?(this._rowsMeta.vals.push({[t]:s}),this._rowsMeta.keys.push(this._data[e])):-1!=i&&null==s?(delete this._rowsMeta.vals[i][t],Object.keys(this._rowsMeta.vals[i]).length||(this._rowsMeta.vals.splice(i,1),this._rowsMeta.keys.splice(i,1))):-1!=i&&null!=s&&(this._rowsMeta.vals[i][t]=s),s}_spreadsheetOnFocus(e){const t=this._highlightOnFocus;null==this._mainRowIndex&&null==this._mainColIndex&&this._data.length&&t&&(this._onlyDetails?this.selectTopBottomCellOnlyDetails(!0):this._selectMainTableCell(this._mainTbody.rows[0].cells[0])),!this._onlyDetails&&this._highlightOnFocus?this.rootEl.style.removeProperty("outline"):this.rootEl.style.outline="none",t&&this._scrollToCursor()}_spreadsheetOnBlur(e){setTimeout(()=>{this.rootEl.contains(document.activeElement)&&!this._bulkEditArea?.contains(document.activeElement)||(this._highlightOnFocus=!0,this._cellCursor.style.display="none")})}_moveCellCursor(e,t,s){if(!this._exitEditMode(!0))return!1;if(null!=this._mainRowIndex||null!=this._mainColIndex){if(s?.preventDefault(),this._onlyDetails||this._scrollToCursor(),"lineup"===this._activeDetailsCell?.parent?.schemaNode.type)this._moveInsideLineup(e,t);else if(t){let e=this._mainColIndex;this._activeDetailsCell?this._selectAdjacentDetailsCell(this._activeDetailsCell,1==t):1===t&&this._rowMetaGet(this._mainRowIndex)?.h?this._selectFirstSelectableDetailsCell(this._openDetailsPanes[this._mainRowIndex],!0):-1===t&&this._rowMetaGet(this._mainRowIndex-1)?.h?this._selectFirstSelectableDetailsCell(this._openDetailsPanes[this._mainRowIndex-1],!1):this._selectMainTableCell(this._selectedCell.parentElement[(t>0?"next":"previous")+"Sibling"]?.cells[e])}else this._activeDetailsCell||this._selectMainTableCell(this._selectedCell[(e>0?"next":"previous")+"Sibling"]);this._onlyDetails&&null!=this._mainRowIndex&&this._scrollToCursor()}}_moveInsideLineup(e,t){const s=this._activeDetailsCell.el.offsetLeft,i=this._activeDetailsCell.el.offsetTop,l=i+this._activeDetailsCell.el.offsetHeight;if(e){for(let t,a=this._activeDetailsCell.index;t=this._activeDetailsCell.parent.children[a+=e];)if(null!=t.el.offsetParent&&t?.el.offsetLeft>s==e>0){l>t.el.offsetTop&&t.el.offsetTop+t.el.offsetHeight>i&&this._selectDetailsCell(t);break}}else{let e,a;const n=this._activeDetailsCell.parent.children;for(let o,r=this._activeDetailsCell.index;o=n[r+=t];){if(!(Math.max(o.el.offsetTop,i)<=Math.min(o.el.offsetTop+o.el.offsetHeight,l)||null==o.el.offsetParent)){if(e&&o.el.offsetLeft<a==t>0)break;if(e&&!(Math.abs(o.el.offsetLeft-s)<Math.abs(a-s)))break;e=o,a=e.el.offsetLeft}}e?this._selectDetailsCell(e):this._selectAdjacentDetailsCell(this._activeDetailsCell.parent,1==t)}}_selectAdjacentDetailsCell(e,t){let s=this._getAdjacentDetailsCell(e,t);if(s)return this._selectDetailsCell(s);if(this._onlyDetails){const e=this.neighbourTables?.[t?"down":"up"];e&&(this._mainColIndex=this._mainRowIndex=this._activeDetailsCell=null,e.container.style.outline=this._cellCursor.style.display="none",e.selectTopBottomCellOnlyDetails(t))}else this._selectMainTableCell(this._mainTbody.querySelector(`[data-data-row-index="${this._mainRowIndex+t}"]`)?.cells[this._mainColIndex])}_getAdjacentDetailsCell(e,t){if(!e.parent)return;const s=e.parent.children;for(let i=e.index+(t||-1);i>=0&&i<s.length;i+=t||-1){const e=s[i];if(e.hidden)continue;if(e.el)return e;const l=this._getFirstSelectableDetailsCell(e,t);if(l)return l}return e.parent.parent?this._getAdjacentDetailsCell(e.parent,t):void 0}_selectFirstSelectableDetailsCell(e,t,s=!1){const i=this._getFirstSelectableDetailsCell(e,t,s);if(i)return this._selectDetailsCell(i);this._selectMainTableCell(this._mainTbody.querySelector(`[data-data-row-index="${this._mainRowIndex+(t||-1)}"]`)?.cells[this._mainColIndex])}_getFirstSelectableDetailsCell(e,t,s=!1){if(!s&&e.el)return e;const i=e.children;let l=t?0:i.length-1;if("lineup"===e.schemaNode.type&&!t){let e;for(let t,s=l;t=i[s--];)if(t.el.offsetParent){if(e&&!(t.el.offsetLeft<e.el.offsetLeft))break;e=t}l=e.index}for(let e=l;e>=0&&e<i.length;e+=t||-1)if(!i[e].hidden&&(i[e].children||i[e].select))return this._getFirstSelectableDetailsCell(i[e],t)}_spreadsheetKeyDown(e){if(!this._bulkEditArea?.contains(document.activeElement))if(this._tooltip.style.visibility="hidden",this._inEditMode&&"date"===this._activeSchemaNode.input.type&&("Arrow"===e.key.slice(0,5)?e.ctrlKey?e.stopPropagation():e.preventDefault():"Backspace"===e.key&&e.stopPropagation()),this.rootEl.style.outline="none",this._inEditMode)switch(e.key){case"Enter":this._moveCellCursor(0,e.shiftKey?-1:1,e);break;case"Escape":this._exitEditMode(!1)}else switch(e.code){case"ArrowUp":this._moveCellCursor(0,-1,e);break;case"ArrowDown":this._moveCellCursor(0,1,e);break;case"ArrowLeft":this._moveCellCursor(-1,0,e);break;case"ArrowRight":this._moveCellCursor(1,0,e);break;case"Escape":this._groupEscape();break;case"NumpadAdd":this._scrollToCursor(),this._expandRow(this._selectedCell.closest(".main-table>tbody>tr"));break;case"NumpadSubtract":this._scrollToCursor(),this._contractRow(this._selectedCell.closest(".main-table>tbody>tr"));break;case"Enter":case"NumpadEnter":case"Space":if("Space"==e.code&&e.preventDefault(),this._scrollToCursor(),"expand"==this._activeSchemaNode.type)return requestAnimationFrame(()=>this._toggleRowExpanded(this._selectedCell.parentElement));if("select"==this._activeSchemaNode.type)return this._rowCheckboxChange(this._selectedCell,e.shiftKey);if(e.code.endsWith("Enter")||"button"===this._activeSchemaNode.input?.type)return e.preventDefault(),this._enterCell(e)}}_groupEscape(){for(let e=this._activeDetailsCell;e=e?.parent;)if("group"===e.schemaNode.type)return this._selectDetailsCell(e)}_insertAtCursor(e,t){if(document.selection){e.focus();document.selection.createRange().text=t}else if(e.selectionStart||"0"==e.selectionStart){var s=e.selectionStart,i=e.selectionEnd;e.value=e.value.substring(0,s)+t+e.value.substring(i,e.value.length)}else e.value+=t}_unsortCol(e,t){for(let s,i=-1;s=this._sortingCols[++i];)if(e&&e==s.id||t&&t==s.type)return this._sortingCols.splice(i,1),void this._updateHeaderSortHtml()}_renderDetails(e,t){e.classList.add("expanded");const s=e.parentElement.insertRow(e.rowIndex+1);s.className="details",s.dataset.dataRowIndex=t;const i=s.insertCell();i.colSpan=this._cols.length;const l=i.appendChild(document.createElement("div"));l.style.height="auto",l.className="content",l.addEventListener("transitionend",this._detailsAnimationEnd.bind(this));l.appendChild(document.createElement("div")).className="details-shadow";const a=this._openDetailsPanes[t]={};return this._generateDetailsContent(this._schema.details,t,a,l,[],this._data[t]),a.rowIndex=t,s}_detailsAnimationEnd(e){if(e.currentTarget===e.target)if(parseInt(e.target.style.height))e.target.style.height="auto";else{const t=e.target.closest("tr"),s=t.previousSibling,i=s.dataset.dataRowIndex;s.classList.remove("expanded"),this._tableSizer.style.height=parseInt(this._tableSizer.style.height)-this._rowMetaGet(i).h+this._rowHeight+"px",t.remove(),this._rowMetaSet(i,"h",null),delete this._openDetailsPanes[i]}}_generateDetailsContent(e,t,s,i,l,a,n){let o=n,r=a;if(e.dataPath){const t=Array.isArray(e.dataPath)?e.dataPath:String(e.dataPath).split(".").filter(Boolean);let s=r;for(const e of t)s[e]&&"object"==typeof s[e]||(s[e]={},o=!0),s=s[e];r=s}switch(l.length||(s.rowIndex=t),s.path=[...l],s.dataObj=r,s.schemaNode=e,e.visibleIf&&this._applyVisibleIf(s),e.type){case"list":return this._generateDetailsList(e,t,s,i,l,r,o);case"field":return this._generateField(e,t,s,i,l,r);case"group":return this._generateDetailsGroup(e,t,s,i,l,r,o);case"repeated":return this._generateDetailsRepeated(e,t,s,i,l,r,o);case"lineup":return this._generateDetailsLineup(e,t,s,i,l,r,o)}}_repeatedOnDelete=(e,t,s,i,l)=>{this._deleteCell(l.parent.parent),l.parent.parent.parent.schemaNode.onDelete?.(l.parent.parent.dataObj,l.parent.parent)};_fileOnDelete=(e,t,s,i,l)=>{const a=l.parent.parent,n=a.fileInputSchemaNode,o=a.parent.dataObj;delete o[n.id];const r=a.el.parentElement;r.innerHTML="",r.classList.remove("group-cell"),this._generateDetailsContent(n,s,a,r,a.path,o),n.deleteHandler?.(e,t,n,a.parent.dataObj,s,a),this._selectDetailsCell(a)};_onOpenCreationGroup=(e,t)=>{e.preventDefault(),this._repeatInsert(t.parent,!0,t.parent.dataObj[t.parent.dataObj.length]={})};_generateDetailsRepeated(e,t,s,i,l,a,n){s.children=[];let o=s.dataObj=a[e.id]??(a[e.id]=[]);return s.insertionPoint=i.appendChild(document.createComment("repeated-insert")),e.create&&this._generateRepeatedCreator(s),o?.forEach(e=>this._repeatInsert(s,!1,e)),!!o?.length||e.create}_generateRepeatedCreator(e){const t=e.schemaNode.creationText??this._opts.lang?.insertNew??"Insert new",s={type:"group",closedRender:()=>t,entries:[],creator:!0,onOpen:this._onOpenCreationGroup,cssClass:"repeat-insertion"},i=this._buildSchemaFacade(s);this._repeatInsert(e,!1,{},i).parentElement.classList.add("empty")}_beginDeleteRepeated(e,t,s,i,l){l.parent.parent.creating?this._deleteCell(l.parent.parent):(l.parent.containerEl.classList.add("delete-confirming"),this._selectDetailsCell(l.parent.children[1]))}_cancelDelete(e,t,s,i,l){l.parent.containerEl.classList.remove("delete-confirming"),this._selectDetailsCell(l.parent.children[0])}_schemaCopyWithDeleteButton(t,s){const i={type:"lineup",cssClass:"delete-controls",onBlur:e=>e.selEl.querySelector(".lineup").classList.remove("delete-confirming"),entries:[{type:"field",input:{type:"button",btnText:t.deleteText??this._opts.lang?.delete??"Delete",clickHandler:this._beginDeleteRepeated.bind(this)},cssClass:"delete"},{type:"field",input:{type:"button",btnText:t.areYouSureNoText??this._opts.lang?.deleteAreYouSureNo??"No",clickHandler:this._cancelDelete.bind(this)},cssClass:"no",title:t.deleteAreYouSureText??this._opts.lang?.deleteAreYouSure??"Are you sure?"},{type:"field",input:{type:"button",btnText:t.areYouSureYesText??this._opts.lang?.deleteAreYouSureYes??"Yes",clickHandler:s},cssClass:"yes"}]},l=t?.[e]?t.raw:t,a=t?.[e]?t.parent:null;if(!l)return t;const n=[...l.entries??[],i],o={...l,entries:n},r=this._buildSchemaFacade(o,a);return t?.[e]&&this._cloneDependencyMetadata(t,r),r}_cloneDependencyMetadata(e,t){const s=e=>Array.isArray(e)?e.map(e=>Array.isArray(e)?[...e]:e):e&&"object"==typeof e?{...e}:e;for(const i of["dependencyPaths","dependsOnCellPaths","dependsOnDataPath"])void 0!==e?.[i]&&(t[i]=s(e[i]));const i=this._dep_children(e),l=this._dep_children(t);for(let e=0;e<i.length&&e<l.length;e++)this._cloneDependencyMetadata(i[e],l[e])}_generateButton(e,t,s,i,l=null){const a=s.appendChild(document.createElement("button"));return a.tabIndex="-1",a.innerHTML=e.input.btnText,a.addEventListener("click",s=>e.input.clickHandler?.(s,i,t,e,l)),a.addEventListener("mousedown",e=>e.preventDefault()),!0}_generateDetailsGroup(e,t,s,i,l,a,n){s.select=()=>this._selectDetailsCell(s);const o=i.appendChild(document.createElement("table")),r=s.containerEl=o.appendChild(document.createElement("tbody"));if(o.dataset.path=l.join("-"),i.classList.add("group-cell"),s.el=o,this._generateDetailsCollection(e,t,s,i,l,a),o.className="details-group "+(e.cssClass??""),n)s.creating=!0;else if(e.closedRender){o.classList.add("closed-render");const t=r.insertRow();t.dataset.path=l.join("-"),t.className="group-render";t.insertCell().innerText=e.closedRender(a)}return!0}_generateDetailsList(e,t,s,i,l,a,n){const o=i.appendChild(document.createElement("table"));if(s.containerEl=o.appendChild(document.createElement("tbody")),o.className="details-list",0!=e.titlesColWidth){let t=document.createElement("col");o.appendChild(document.createElement("colgroup")).appendChild(t),null!=e.titlesColWidth&&(t.style.width=e.titlesColWidth)}return this._generateDetailsCollection(e,t,s,i,l,a)}_generateDetailsLineup(e,t,s,i,l,a,n){return s.containerEl=i.appendChild(document.createElement("div")),s.containerEl.classList.add("lineup","collection",...e.cssClass?.split(" ")??[]),this._generateDetailsCollection(e,t,s,i,l,a)}_generateDetailsCollection(e,t,s,i,l,a){s.containerEl.classList.add("collection"),s.children=[];for(let i,n=-1;i=e.entries[++n];)if("repeated"===i.type){const e=a[i.id]??(a[i.id]=[]),t=s.children[n]={parent:s,index:n,children:[],schemaNode:i,dataObj:e,path:[...l,n]};t.insertionPoint=s.containerEl.appendChild(document.createComment("repeat-insert")),i.create&&this._generateRepeatedCreator(t),e?.forEach(e=>this._repeatInsert(t,!1,e))}else this._generateCollectionItem(i,t,s,l,a);return!0}_buildCollectionItemDOM(e,t,s,i){let l,a;const n=t.schemaNode.type;if("list"==n){if(l=document.createElement("tr"),0!=t.schemaNode.titlesColWidth){const t=l.insertCell();t.className="title",t.innerText=e.title??""}a=l.insertCell()}else if("lineup"==n)l=document.createElement("span"),i&&l.appendChild(i),a=s.selEl=l.appendChild(document.createElement("div"));else if("group"==n){l=document.createElement("tr"),l.className="empty";const t=l.insertCell();t.classList.toggle("disabled","field"==e.type&&!e.input),"group"!=e.type&&(t.appendChild(document.createElement("hr")).className="separator"),i&&t.appendChild(i),a=t.appendChild(document.createElement("div")),Object.assign(s,{nonEmptyDescentants:0,grpTr:l,selEl:t})}else l=a=document.createElement("div");return{outerContainerEl:l,containerEl:a}}_insertCollectionItem(e,t,s,i,l,a){let n=null;if("repeated"==l.schemaNode.type){const e=l.insertionPoint.nextSibling,s=l.children.length,i=(e?.rowIndex??s)-s+t;n=l.children[i]}const o=n?.el.closest(".collection>*")??l.insertionPoint;a.insertBefore(i,o),l.children.splice(t,0,s),e.cssClass&&(i.className+=" "+e.cssClass)}_generateCollectionItem(e,t,s,i,l,a=null,n=!1){const o="repeated"==s.schemaNode.type?s.parent:s,r=o.containerEl;a??=s.children.length;const h=Object.assign(Object.create(null),{parent:s,index:a});let d;e.title&&(d=document.createElement("span"),d.className="title",d.innerHTML=e.title);const{outerContainerEl:c,containerEl:p}=this._buildCollectionItemDOM(e,o,h,d);if(e.input&&"button"!=e.input.type&&p.classList.add("input-cell"),p.classList.add("value"),e.input&&c.classList.add((e.input.type??"text")+"-container"),a<s.children.length)for(let e,t=a-1;e=s.children[++t];)this._changeInstanceNodeIndex(e,t+1);i.push(a),h.outerContainerEl=c;return this._generateDetailsContent(e,t,h,p,i,l,n)&&this._insertCollectionItem(e,a,h,c,s,r),i.pop(),h}_generateField(e,t,s,i,l,a){return s.select=()=>this._selectDetailsCell(s),s.el=i,this._updateDetailsCell(s,a),s[s.selEl?"selEl":"el"].dataset.path=l.join("-"),!0}_spreadsheetMouseDown(e){if(this._highlightOnFocus=!1,this.rootEl.style.outline="none",this._tooltip.style.visibility="hidden",Date.now()<this._ignoreClicksUntil)return;if(3===e.which)return;const t=e.target.closest(".main-table>tbody>tr");if(this._onlyDetails||t?.classList.contains("details")){const s=e.target.closest("[data-path]");if(!s)return;let i=this._openDetailsPanes[t?.dataset.dataRowIndex??0];for(let e of s.dataset.path.split("-"))if(i=i.children[e],"group"===i.schemaNode.type&&!i.el.classList.contains("open"))break;this._selectDetailsCell(i)}else{const t=e.target.closest(".main-table>tbody>tr>td");if(t?.classList.contains("expand-col")||t?.classList.contains("select-col"))return e.shiftKey&&e.preventDefault(),null==this._mainRowIndex&&(this._selectMainTableCell(t),this.rootEl.focus({preventScroll:!0})),t.classList.contains("expand-col")?this._toggleRowExpanded(t.parentElement):this._rowCheckboxChange(t,e.shiftKey);this._selectMainTableCell(t)}}_toggleRowExpanded(e){e.classList.contains("expanded")?this._contractRow(e):this._expandRow(e)}_rowCheckboxChange(e,t){const s=!e.querySelector("input").checked,i=parseInt(e.parentElement.dataset.dataRowIndex);t||(this._lastCheckedIndex=i),this._toggleRowsSelected(s,...[i,this._lastCheckedIndex??i].sort((e,t)=>e-t)),this._lastCheckedIndex=i}_toggleRowsSelected(e,t,s){this._unsortCol(null,"select");for(var i=t;i<=s;i++){if(i>=this._scrollRowIndex&&i<this._scrollRowIndex+this._numRenderedRows){const t=this._mainTbody.querySelector(`[data-data-row-index="${i}"]`);t.querySelector(".select-col input").checked=e,t.classList.toggle("selected",e)}e&&-1==this._selectedRows.indexOf(this._data[i])?(this._selectedRows.push(this._data[i]),this._numRowsSelected++,this._numRowsInViewSelected++):e||-1==this._selectedRows.indexOf(this._data[i])||(this._selectedRows.splice(this._selectedRows.indexOf(this._data[i]),1),this._numRowsSelected--,this._numRowsInViewSelected--)}this._numberOfRowsSelectedSpan.innerText=this._numRowsSelected,this._updateNumRowsSelectionState(),this._updateBulkEditAreaCells()}_updateNumRowsSelectionState(){const e=this._headerTr.querySelector(".select-col input");this._numRowsInViewSelected!=this._data.length&&this._numRowsInViewSelected?e.indeterminate=!0:(e.indeterminate=!1,e.checked=this._numRowsInViewSelected),this._numRowsSelected^this._bulkEditAreaOpen&&(this._bulkEditAreaOpen=!!this._numRowsSelected,this._bulkEditArea.style.height=this._bulkEditAreaOpen?this._bulkEditAreaHeightPx+"px":0,this._animate(this._updateViewportHeight,1/0,"adjustViewportHeight"))}_animate(e,t,s){const i=Date.now()+t,l=this._animations;l[s]?l[s]=i:(l[s]=i,requestAnimationFrame(function t(){e(),Date.now()<l[s]?requestAnimationFrame(t):delete l[s]}))}_autoTextAreaResize(e){const t=this._activeSchemaNode.maxHeight??1/0;e.target.style.height="auto",this._cellCursor.style.height=this._selectedCell.style.height=Math.min(t,e.target.scrollHeight+1)+"px",e.target.style.height="100%",this._updateDetailsHeight(this._selectedCell.closest("tr.details"))}_updateDetailsHeight(e){const t=e.querySelector(".content"),s=parseInt(e.dataset.dataRowIndex);t.style.height="auto";const i=this._rowMetaGet(s).h,l=this._rowHeight+e.offsetHeight+this._borderSpacingY;this._rowMetaSet(s,"h",l),this._tableSizer.style.height=parseInt(this._tableSizer.style.height)+l-i+"px"}_openDateEdit(e){const t=document.createElement("input");let s,i;this._attachInputFormatter(t,{date:!0}),window.Pikaday?(i=this._cellCursor.parentElement.appendChild(document.createElement("div")),i.className="pika-container",s=new Pikaday({field:t,toString:e=>e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2),onClose:()=>{i.remove(),s.destroy(),setTimeout(()=>this._exitEditMode(!0))},container:i,firstDay:1,showWeekNumber:!0,defaultDate:this._selectedCellVal?new Date(this._selectedCellVal):void 0,setDefaultDate:!0,i18n:{previousMonth:"Tidigare Månad",nextMonth:"Nästa Månad",months:["Januari","Februari","Mars","April","Maj","Juni","Juli","Augusti","September","Oktober","November","December"],weekdays:["Söndag","Måndag","Tisdag","Onsdag","Torsdag","Fredag","Lördag"],weekdaysShort:["Sön","Mån","Tis","Ons","Tor","Fre","Lör"]},onOpen:()=>this._alignDropdown(i),onDraw:()=>this._alignDropdown(i)}),s.el.style.position="static",e instanceof KeyboardEvent&&e.stopPropagation(),t.addEventListener("input",function(e){const i=t.value;s.setDate(t.value),t.value=i}.bind(this)),t.addEventListener("change",()=>this._inputVal=t.value)):console.warn("Pikaday-library not found"),this._cellCursor.appendChild(t),t.value=this._selectedCellVal??"",t.placeholder=this._activeSchemaNode.input.placeholder??this._opts.lang?.datePlaceholder??"YYYY-MM-DD",t.focus()}_alignDropdown(e,t=this._cellCursor){const s=this._dropdownAlignmentContainer,i=this._getElPos(t),l=s===e.offsetParent?i:this._getElPos(t,s);e.classList.remove("above","below","left","right"),l.y+t.clientHeight/2>s.scrollTop+s.clientHeight/2?(e.style.top=i.y-e.offsetHeight+"px",e.classList.add("above")):(e.style.top=i.y+t.clientHeight+"px",e.classList.add("below")),s.clientWidth-l.x>e.offsetWidth?(e.style.left=i.x+"px",e.classList.add("left")):(e.style.left=i.x-(e.offsetWidth-t.offsetWidth)+"px",e.classList.add("right"))}_enterCell(e){if(!this._inEditMode&&!this._cellCursor.classList.contains("disabled"))if(this._activeSchemaNode.input){if(e.preventDefault(),"button"===this._activeSchemaNode.input.type)return this._activeDetailsCell.el.click();this._inputVal=this._selectedCellVal,this._inEditMode=!0,this._cellCursor.classList.add("edit-mode"),({textarea:this._openTextAreaEdit,date:this._openDateEdit,select:this._openSelectEdit,file:this._openFileEdit}[this._activeSchemaNode.input.type]??this._openTextEdit).call(this,e)}else"group"===this._activeSchemaNode.type&&this._openGroup(this._activeDetailsCell)}_openGroup(e){let t=!0;e.schemaNode.onOpen?.({preventDefault:()=>t=!1},e),t&&(e.el.classList.add("open"),this._selectDetailsCell(this._getFirstSelectableDetailsCell(e,!0,!0)),e.schemaNode.onOpenAfter?.(e))}_closeGroup(e){if(e.creating&&!this._closeRepeatedInsertion(e))return!1;if(e.el.classList.remove("open"),this._ignoreClicksUntil=Date.now()+500,e.updateRenderOnClose){let t,s;for(delete e.updateRenderOnClose,t=e.parent;!t.dataObj&&t.parent;t=t.parent);s=e.schemaNode.closedRender(e.dataObj),e.el.rows[e.el.rows.length-1].cells[0].innerText=s}return e.schemaNode.onClose?.(e),!0}_repeatInsert(e,t,s,i=null){let l,a;if(i??=e.schemaNode.entry,t||!e.schemaNode.sortCompare||i.creator)l=e.children.length-(e.schemaNode.create&&!i.creator);else for(l=0;l<e.children.length-!!e.schemaNode.create&&!(e.schemaNode.sortCompare(s,e.children[l].dataObj)<0);l++);for(let t=e.parent;t.parent;t=t.parent,a=t.rowIndex);let n=i;e.schemaNode.create&&"group"===i.type&&(n=this._schemaCopyWithDeleteButton(i,this._repeatedOnDelete));const o=this._generateCollectionItem(n,a,e,e.path,s,l,t);return t&&(o.creating=!0,this._selectFirstSelectableDetailsCell(o,!0,!0),e.schemaNode.onCreateOpen?.(e)),o.el}_changeInstanceNodeIndex(e,t){e.index=t;const s=e.path.length-1;for(const i of e.el.parentElement.querySelectorAll("[data-path]")){const e=i.dataset.path.split("-");e[s]=t,i.dataset.path=e.join("-")}!function e(i){i.path&&(i.path[s]=t);i.children?.forEach(e)}(e)}_deleteCell(e,t=!1){let s;for(let t,s=e.index;t=e.parent.children[++s];)this._changeInstanceNodeIndex(t,s-1);e.parent.children.length>=e.index+1?s=e.parent.children[e.index+1]:e.parent.children.length>1&&(s=e.parent.children[e.index-1]),e.parent.children.splice(e.index,1),t||e.parent.dataObj.splice(e.index,1),"repeated"===e.parent.schemaNode.type&&"list"===e.parent.parent.schemaNode.type?e.el.parentElement.parentElement.remove():e.el.parentElement.remove(),this._activeDetailsCell=null,t||this._selectDetailsCell(s??e.parent.parent),e.creating&&e.parent.schemaNode.onCreateCancel?.(e.parent)}_openTextEdit(){const e=this._cellCursor.appendChild(document.createElement("input"));e.addEventListener("blur",()=>setTimeout(this._exitEditMode.bind(this,!0))),e.addEventListener("change",()=>this._inputVal=e.value),e.value=this._selectedCellVal??"",this._activeSchemaNode.input.format&&this._attachInputFormatter(e,this._activeSchemaNode.input.format),e.focus(),this._activeSchemaNode.input.maxLength&&(e.maxLength=this._activeSchemaNode.input.maxLength),e.placeholder=this._activeSchemaNode.input.placeholder??""}_mapAdd(e,t,s){e.keys.push(t),e.vals.push(s)}_mapGet(e,t){const s=e.keys.indexOf(t);if(-1!=s)return e.vals[s]}_mapRemove(e,t){const s=e.keys.indexOf(t);e.keys.splice(s,1),e.vals.splice(s,1)}_openFileEdit(){window.getSelection().empty();const e=this._cellCursor.appendChild(document.createElement("div"));e.classList.add("file"),e.tabIndex=0,e.focus();const t=e.appendChild(document.createElement("input"));t.type="file",e.innerHTML=this._opts.lang?.fileChooseOrDrag??"<b>Press to choose a file</b> or drag it here";const s=e.appendChild(document.createElement("div"));s.classList.add("drop"),s.innerHTML=this._opts.lang?.fileDropToUpload??"Drop to upload";const i=this._processFileUpload.bind(this);e.addEventListener("keydown",e=>{"Escape"!==e.key&&(e.stopPropagation(),e.key.startsWith("Arrow")?e.preventDefault():"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t.click()))}),e.addEventListener("click",()=>t.click()),e.addEventListener("dragenter",()=>s.style.display="block"),s.addEventListener("dragleave",()=>s.style.display="none"),s.addEventListener("dragover",e=>e.preventDefault()),e.addEventListener("drop",e=>{e.preventDefault(),e.stopPropagation(),i(e.dataTransfer.files[0])}),t.addEventListener("change",e=>i(e.target.files[0]))}_processFileUpload(e){this._inputVal=e;const t=Object.assign(Object.create(null),{uploadedBytes:0,bars:[]});this._mapAdd(this._filesMeta,e,t);const s=this._opts.useFakeFileUploadTest?new i({totalBytes:e.size||1,rate:this._opts.fakeUploadRate,startAt:this._opts.fakeUploadStartAt}):new XMLHttpRequest,l=(e,s)=>{for(let i=0;i<t.bars.length;i++){const l=t.bars[i];if(!l.isConnected){t.bars.splice(i--,1);continue}t.uploadedBytes=e;const a=s?parseInt(e/s*100):0;l.style.width=l.firstChild.innerText=a+"%"}},a=()=>{this._mapRemove(this._filesMeta,e);for(const e of t.bars)e.isConnected&&(e.parentElement.classList.remove("active"),e.firstChild.innerText=this._opts.lang?.fileUploadDone??"Done!")},n=e.size||1;s.upload.addEventListener("progress",e=>l(e.loaded,e.total)),s.addEventListener("load",()=>{l(n,n),a()}),this._activeSchemaNode.input.fileUploadHandler?.(s,e,this._activeSchemaNode,this._cellCursorDataObj,this._mainRowIndex,this._activeDetailsCell);const o=new FormData;o.append("file",e),s.send(o),this._exitEditMode(!0),this._selectDetailsCell(this._activeDetailsCell)}_openTextAreaEdit(){const e=this._cellCursor.appendChild(document.createElement("textarea"));e.addEventListener("input",this._autoTextAreaResize.bind(this));{const{paddingLeft:t,paddingRight:s,paddingTop:i,paddingBottom:l}=window.getComputedStyle(this._selectedCell);Object.assign(e.style,{paddingLeft:t,paddingRight:s,paddingTop:i,paddingBottom:l})}e.value=this._selectedCellVal??"",e.addEventListener("keydown",function(t){"Enter"===t.key&&t.ctrlKey?(this._insertAtCursor(e,"\r\n"),e.dispatchEvent(new Event("input")),t.stopPropagation()):"Escape"===t.key&&(e.value=this._selectedCellVal??"",e.dispatchEvent(new Event("input")))}.bind(this)),e.focus(),e.addEventListener("change",t=>this._inputVal=e.value),this._activeSchemaNode.input.maxLength&&(e.maxLength=this._activeSchemaNode.input.maxLength),e.placeholder=this._activeSchemaNode.input.placeholder??""}_renderSelectOptions(e,t,s,i){let l=!1;e.innerHTML="";for(const a of t){const t=e.appendChild(document.createElement("li"));a.cssClass&&(t.className=a.cssClass),t.innerText=a.text,s==a&&(l=!0,t.classList.add("selected","highlighted"),i.highlightLiIndex=e.children.length-1,i.highlightUlIndex=parseInt(e.dataset.ulIndex))}return l}_highlightSelectOption(e,t,s,i){const l=e.ulDiv.getElementsByClassName("highlighted")[0];l&&l.classList.remove("highlighted");const a=e.ulDiv.children[e.highlightUlIndex=t],n=a.children[e.highlightLiIndex=s];n&&(n.classList.add("highlighted"),t&&i&&(a.scrollTop=n.offsetTop-a.offsetTop+n.offsetHeight/2-a.offsetHeight/2))}_handleSelectInputChange(e){const t=e.input.value,s=!!e.filterText,i=!t.includes(e.filterText)||!s;e.canCreate=!!t,i&&e.looseOpts.splice(0,1/0,...e.strctInp.options);for(let s,i=-1;s=e.looseOpts[++i];)!s.text.includes(t)||s.pinned?e.looseOpts.splice(i--,1):s.text.toLowerCase()==t.toLowerCase()&&(e.canCreate=!1);this._updateCreateOptionVisibility(e);this._renderSelectOptions(e.mainUl,e.looseOpts,this._inputVal,e)?e.pinnedUl.querySelector(".highlighted")?.classList.remove("highlighted"):e.highlightUlIndex&&(e.looseOpts.length?this._highlightSelectOption(e,1,0,!0):e.pinnedUl.children.length&&this._highlightSelectOption(e,0,0,!0)),e.noResults.style.display=e.looseOpts.length?"none":"block",e.filterText=t,e.creationLi&&(e.creationLi.innerText=`Create [${e.filterText}]`)}_updateCreateOptionVisibility(e){e.creationLi&&(e.canCreate?e.creationLi.parentElement!=e.pinnedUl&&e.pinnedUl.appendChild(e.creationLi):e.creationLi.parentElement==e.pinnedUl&&e.pinnedUl.removeChild(e.creationLi))}_handleSelectKeyDown(e,t){if("ArrowDown"===e.key||"ArrowUp"===e.key){e.preventDefault();const s="ArrowDown"===e.key?1:-1,i=(null==t.highlightLiIndex?0:t.highlightLiIndex)+s;t.highlightUlIndex??1?t.looseOpts.length&&i<t.looseOpts.length&&i>=0?this._highlightSelectOption(t,1,i,!0):-1==i&&t.pinnedUl.children.length&&this._highlightSelectOption(t,0,t.pinnedUl.children.length-1,!0):i>=0&&i<t.pinnedUl.children.length?this._highlightSelectOption(t,0,i,!0):i>=t.pinnedUl.children.length&&t.looseOpts.length&&this._highlightSelectOption(t,1,0,!0)}else"Enter"===e.key?(this._closeSelectDropdown(t,e),this._moveCellCursor(0,e.shiftKey?-1:1),e.stopPropagation()):"Escape"===e.key&&this._closeSelectDropdown(t,e)}_handleSelectMouseMove(e,t){const s=e.target.closest("li");if(!s)return;const i=s.parentNode,l=parseInt(i.dataset.ulIndex),a=[...i.children].indexOf(s);this._highlightSelectOption(t,l,a,!1)}_handleSelectClick(e,t){const s=e.target.closest("li");if(!s)return;const i=e.currentTarget;t.highlightUlIndex=parseInt(i.dataset.ulIndex),t.highlightLiIndex=Array.prototype.indexOf.call(i.children,s),this._closeSelectDropdown(t,e),this._exitEditMode(!0)}_createSelectDropdownContext(e){const t=document.createElement("div"),s=[],i=[],l=t.appendChild(document.createElement("div")),a=l.appendChild(document.createElement("input"));l.classList.add("input-wrapper");const n=t.appendChild(document.createElement("div")),o=n.appendChild(document.createElement("ul"));o.classList.add("pinned");const r=n.appendChild(document.createElement("ul"));r.classList.add("main");const h=t.appendChild(document.createElement("div"));h.innerHTML=e.noResultsText??this._opts.lang?.selectNoResultsFound??"No results found",h.className="no-results";for(const t of e.options){(!t.visibleIf||t.visibleIf({dataContext:this._cellCursorDataObj,schemaNode:this._activeSchemaNode,rowIndex:this._mainRowIndex,instanceNode:this._activeDetailsCell}))&&(t.pinned?s:i).push(t)}return Object.assign(Object.create(null),{strctInp:e,selectContainer:t,inputWrapper:l,input:a,ulDiv:n,pinnedUl:o,mainUl:r,noResults:h,pinnedOpts:s,looseOpts:i,creationLi:null,canCreate:!1,filterText:"",highlightLiIndex:null,highlightUlIndex:null,windowMouseDown:null})}_closeSelectDropdown(e,t){e.selectContainer.parentElement&&(e.highlightUlIndex||"create"!=e.pinnedUl.children[e.highlightLiIndex]?.dataset.type?this._inputVal=(e.highlightUlIndex?e.looseOpts:e.pinnedOpts)[e.highlightLiIndex]:(e.filterText=e.filterText??e.input.value,this._inputVal={text:e.filterText},e.strctInp.options.push(this._inputVal),e.strctInp.createNewOptionHandler?.(this._inputVal,t,this._cellCursorDataObj,this._mainRowIndex,this._activeSchemaNode,this._activeDetailsCell)),e.selectContainer.remove(),e.windowMouseDown&&window.removeEventListener("mousedown",e.windowMouseDown))}_openSelectEdit(){const e=this._activeSchemaNode.input;this._inputVal=this._cellCursorDataObj[this._activeSchemaNode.id];const t=this._createSelectDropdownContext(e);this._cellCursor.style.backgroundColor="transparent";e.allowCreateNew||t.looseOpts.length>=(e.minOptsFilter??this._opts.defaultMinOptsFilter??5)?t.input.addEventListener("input",()=>this._handleSelectInputChange(t)):t.inputWrapper.classList.add("hide"),t.input.addEventListener("keydown",e=>this._handleSelectKeyDown(e,t)),t.input.placeholder=e.selectInputPlaceholder??"",t.input.addEventListener("blur",t.input.focus);for(let e,s=-1;e=[t.pinnedUl,t.mainUl][++s];)e.dataset.ulIndex=s,e.addEventListener("mousemove",e=>this._handleSelectMouseMove(e,t)),e.addEventListener("click",e=>this._handleSelectClick(e,t));e.allowCreateNew&&(t.creationLi=document.createElement("li"),t.creationLi.dataset.type="create"),this._renderSelectOptions(t.pinnedUl,t.pinnedOpts,this._inputVal,t),this._renderSelectOptions(t.mainUl,t.looseOpts,this._inputVal,t),this._cellCursor.parentElement.appendChild(t.selectContainer),t.selectContainer.className="tablance-select-container",this._alignDropdown(t.selectContainer);const s=e=>{let s=e.target;for(;s&&s!=t.selectContainer;)s=s.parentElement;s||(this._closeSelectDropdown(t,e),this._exitEditMode(!1))};t.windowMouseDown=s,window.addEventListener("mousedown",s),t.input.focus()}_validateInput(e){let t;const s=this._cellCursor.querySelector("input");if(this._activeSchemaNode.input.validation(e,e=>t=e,this._activeSchemaNode,this._cellCursorDataObj,this._mainRowIndex,this._activeDetailsCell))return!0;s.focus(),t&&this._showTooltip(t)}_updateDependentCells(e,t){for(const i of e.dependencyPaths??[])if("m"===i[0]){const e=this._mainTbody.querySelector(`[data-data-row-index="${this._mainRowIndex}"]:not(.details)`);this._updateMainRowCell(e.cells[i[1]],this._colSchemaNodes[i[1]])}else if(this._openDetailsPanes[this._mainRowIndex]){let e="r"===i[0]?[t]:[this._openDetailsPanes[this._mainRowIndex]];for(var s=1;".."===i[s];s++)e[0]=e[0].parent;for(;s<i.length;s++){if("repeated"===e[0].schemaNode.type){const t=[];for(const s of e)t.push(...s.children);e=t}for(let t=0;t<e.length;t++)e[t]=e[t].children[i[s]]}for(const t of e)this._updateDetailsCell(t,t.dataObj)}}_exitEditMode(e){if(!this._inEditMode)return!0;const t=this._cellCursor.querySelector("input");return this._activeSchemaNode.input.format?.stripDelimiterOnSave&&this._activeSchemaNode.input.format.delimiter&&(t.value=t.value.replaceAll(this._activeSchemaNode.input.format.delimiter,"")),!(this._activeSchemaNode.input.validation&&e&&!this._validateInput(t.value))&&(this.rootEl.focus({preventScroll:!0}),this._inEditMode=!1,this._cellCursor.classList.remove("edit-mode"),e&&this._inputVal!=this._selectedCellVal&&this._doEditSave(),this._cellCursor.innerHTML="",this._adjustCursorPosSize(this._selectedCell),this._highlightOnFocus=!1,!0)}_showTooltip(e,t=this._cellCursor){return this._cellCursor.parentElement.appendChild(this._tooltip),setTimeout(()=>this._tooltip.style.visibility="visible"),this._tooltip.firstChild.innerText=e,this._alignDropdown(this._tooltip,t),this._scrollElementIntoView(this._tooltip),!0}_scrollElementIntoView(){}_closeRepeatedInsertion(e){if(!Object.values(e.dataObj).filter(e=>null!=e).length)return this._deleteCell(e),!1;{let s;for(var t=e;t.parent;t=t.parent);let i=!0;if(e.schemaNode.creationValidation&&(i=e.schemaNode.creationValidation(e=>s=e,e.schemaNode,e.dataObj,t.rowIndex,e)),!i)return s&&this._showTooltip(s,e.el),!1;const l="group"==e.schemaNode.type?e:e.parent,a=l.parent,n=a?.parent?.dataObj??this._data[t.rowIndex],o={newDataItem:e.dataObj,dataContext:n,dataArray:a?.dataObj,dataKey:a?.schemaNode.id,itemIndex:e.index,repeatedSchemaNode:a?.schemaNode,entrySchemaNode:l.schemaNode,newInstanceNode:e,mainIndex:t.rowIndex,bulkEdit:!1,closestMeta:e=>this._closestMeta(l.schemaNode,e),cancelCreate:()=>i=!1};if(e.creating=!1,l.schemaNode.onCreate?.(o),!i)return this._deleteCell(e),!1}return!0}_closeActiveDetailsCell(){if(this._activeDetailsCell){for(let e=this._activeDetailsCell;e=e.parent;){if("group"===e.schemaNode.type){if(!this._closeGroup(e))return!1;this._ignoreClicksUntil=Date.now()+500}e.schemaNode.onBlur?.(e,this._mainRowIndex)}this._activeDetailsCell=null}return!0}_selectMainTableCell(e){if(!e)return;if(!this._exitEditMode(!0))return!1;this._mainColIndex=e.cellIndex;const t=parseInt(e.parentElement.dataset.dataRowIndex);this._closeActiveDetailsCell()&&(this._selectCell(e,this._colSchemaNodes[this._mainColIndex],this._data[t]),this._mainRowIndex=t)}_selectDetailsCell(e){if(!this._exitEditMode(!0))return!1;const t=this._activeDetailsCell;for(var s=e;s.parent;s=s.parent);const i=s.rowIndex;if(t)for(let s=t;s=s?.parent;)if("group"===s.schemaNode.type||s.schemaNode.onBlur||s.creating){for(let t=e;t=t.parent;)if(t===s){s=null;break}if(s){if("group"===s.schemaNode.type&&!this._closeGroup(s))return!1;s.schemaNode.onBlur&&s.schemaNode.onBlur?.(s,i)}}this._selectCell(e.selEl??e.el,e.schemaNode,e.dataObj,!1),this._mainRowIndex=i;for(let t=e;t=t.parent;)"group"==t.schemaNode.type&&t.el.classList.add("open");return this._adjustCursorPosSize(e.selEl??e.el),this._activeDetailsCell=e,e}_selectCell(e,t,s,i=!0){this.rootEl.focus({preventScroll:!0}),i&&this._adjustCursorPosSize(e),this._cellCursor.classList.toggle("details",e.closest(".details")),this._cellCursor.classList.toggle("disabled",e.classList.contains("disabled")),(this._scrollingContent??this.rootEl).appendChild(this._cellCursor),this._selectedCell=e,this._activeSchemaNode=t;const l="expand"===t.type||"select"===t.type||"button"===t.input?.type;this._cellCursor.style.pointerEvents=l?"none":"auto",this._cellCursor.style.removeProperty("background-color"),this._cellCursorDataObj=s,this._selectedCellVal=s?.[t.id]}_getElPos(e,t){const s=e.getBoundingClientRect();t||(t=this._tableSizer??this.rootEl);const i=t.getBoundingClientRect();return{x:s.x-i.x,y:s.y-i.y+(this._tableSizer?.offsetTop??0)}}_adjustCursorPosSize(e,t=!1){if(!e)return;const s=this._getElPos(e);this._cellCursor.style.top=s.y+"px",this._cellCursor.style.left=s.x+"px",this._cellCursor.style.display="block",t||(this._cellCursor.style.height=e.offsetHeight+"px",this._cellCursor.style.width=e.offsetWidth+"px")}_createTableHeader(){this._headerTable=this.rootEl.appendChild(document.createElement("table")),this._headerTable.classList.add("header-table");const e=this._headerTable.appendChild(document.createElement("thead"));this._headerTr=e.insertRow();for(let e of this._colSchemaNodes){let t=this._headerTr.appendChild(document.createElement("th"));if(t.addEventListener("click",e=>this._onThClick(e)),"select"==e.type)t.appendChild(this._createCheckbox()),t.classList.add("select-col");else if("expand"==e.type){t.appendChild(document.createElement("div")).classList.add("expand-div"),t.classList.add("expand-col")}else t.innerText=e.title??" ";e.sortDiv=t.appendChild(document.createElement("DIV")),e.sortDiv.className="sortSymbol"}this._headerTr.appendChild(document.createElement("th"))}_onThClick(e){const t=e.currentTarget.cellIndex;if("select"==this._colSchemaNodes[t].type&&"input"==e.target.tagName.toLowerCase())return this._toggleRowsSelected(e.target.checked,0,this._data.length-1);if(e.target.closest(".expand-div"))return this._expandOrContractAll(!e.target.closest("tr").classList.contains("expanded"));let s,i=-1;for(;s=this._sortingCols[++i];)if(s.index===t){e.shiftKey&&this._sortingCols.length>1&&"desc"==s.order?(this._sortingCols.splice(i,1),i=0):s.order="asc"==s.order?"desc":"asc",e.shiftKey||(this._sortingCols=[s]);break}if(i==this._sortingCols.length){const{id:s,type:i}=this._colSchemaNodes[t],l={id:s,type:i,order:"asc",index:t};e.shiftKey||(this._sortingCols=[]),this._sortingCols.push(l)}this._updateHeaderSortHtml(),e.preventDefault(),this._sortData(),this._refreshTable()}_expandOrContractAll(e){let t;if(this._scrollBody.scrollTop=0,this._scrollMethod(),e){t=this._tableSizer.querySelectorAll(".main-table>tbody>tr:not(.details):not(.expanded)");for(const e of t)this._expandRow(e);for(const e of this._data){const t=this._rowsMeta.keys.indexOf(e);-1!=t?this._rowsMeta.vals[t].h??=-1:(this._rowsMeta.keys.push(e),this._rowsMeta.vals.push({h:-1}))}}}_updateHeaderSortHtml(){for(let[e,t]of Object.entries(this._headerTr.cells)){if(e==this._headerTr.cells.length-1)break;let s=null,i=this._colSchemaNodes[e].sortDiv;for(let t of this._sortingCols)if(t.index==e){s=t.order;break}s&&!t.classList.contains("asc"==s?"desc":"asc")||t.classList.remove("asc","desc"),s?(t.classList.add(s),i.innerHTML=("asc"==s?this._opts?.sortAscHtml:this._opts?.sortDescHtml)??""):i.innerHTML=this._opts?.sortNoneHtml??""}}_sortData(){const e=this._sortingCols;return!!e.length&&(this._data.sort(function(t,s){for(let i of e)if("expand"===i.type){let e;if((e=!!this._rowMetaGet(this._data.indexOf(t))?.h)!=!!this._rowMetaGet(this._data.indexOf(s))?.h)return(e?-1:1)*("asc"==i.order?1:-1)}else if("select"===i.type){let e;if((e=-1!=this._selectedRows.indexOf(t))!=(-1!=this._selectedRows.indexOf(s)))return(e?-1:1)*("asc"==i.order?1:-1)}else if(t[i.id]!=s[i.id])return(t[i.id]>s[i.id]?1:-1)*("asc"==i.order?1:-1)}.bind(this)),this._mainRowIndex>=0&&(this._mainRowIndex=this._data.indexOf(this._cellCursorDataObj)),!0)}_createTableBody(){this._scrollBody=this.rootEl.appendChild(document.createElement("div")),this._staticRowHeight&&!this._schema.details?this._scrollMethod=this._onScrollStaticRowHeightNoDetails:this._staticRowHeight&&this._schema.details&&(this._scrollMethod=this._onScrollStaticRowHeightDetails),this._scrollBody.addEventListener("scroll",e=>this._scrollMethod(e),{passive:!0}),this._scrollBody.className="scroll-body",this._scrollingContent=this._scrollBody.appendChild(document.createElement("div")),this._scrollingContent.className="scrolling-content",this._tableSizer=this._scrollingContent.appendChild(document.createElement("div")),this._tableSizer.style.position="relative",this._tableSizer.style.top="0px",this._tableSizer.className="table-sizer",this._mainTable=this._tableSizer.appendChild(document.createElement("table")),this._mainTable.className="main-table",this._mainTbody=this._mainTable.appendChild(document.createElement("tbody"));for(let e=0;e<this._colSchemaNodes.length;e++){let e=document.createElement("col");this._cols.push(e),this._mainTable.appendChild(document.createElement("colgroup")).appendChild(e)}this._borderSpacingY=parseInt(window.getComputedStyle(this._mainTable)["border-spacing"].split(" ")[1])}_createBulkEditArea(e){this._bulkEditArea=this.rootEl.appendChild(document.createElement("div")),this._bulkEditArea.classList.add("bulk-edit-area"),this._bulkEditArea.addEventListener("transitionend",()=>{delete this._animations.adjustViewportHeight,"0px"!=this._bulkEditArea.style.height&&(this._bulkEditArea.style.overflow="visible")});const t=this._bulkEditArea.appendChild(document.createElement("div")),s=t.appendChild(document.createElement("div"));s.innerText="Number of selected rows: ",this._numberOfRowsSelectedSpan=s.appendChild(document.createElement("span"));const i=t.appendChild(document.createElement("div"));i.classList.add("pages");const a=i.appendChild(document.createElement("div")),n=a.appendChild(document.createElement("div"));a.classList.add("main"),a.style.display="block";const o=this._buildBulkEditSchemaNodes(e.details);for(const t of e.main.columns)o.push(...this._buildBulkEditSchemaNodes(t));const r={details:{type:"lineup",entries:o}};this._bulkEditTable=new l(n,r,null,!0,null),this._bulkEditTable.mainInstance=this,this._bulkEditTable._dropdownAlignmentContainer=this._bulkEditArea,this._bulkEditTable.addData([{}]),this._bulkEditAreaHeightPx=this._bulkEditArea.firstChild.offsetHeight,this._bulkEditArea.style.height=0}_isObject(e){return e&&"object"==typeof e&&!Array.isArray(e)}_buildBulkEditSchemaNodes(e){const t=[];if(e.type&&"field"!=e.type||!e.bulkEdit){if(e.entries?.length&&e.bulkEdit||e===this._schema.details)for(const s of e.entries)t.push(...this._buildBulkEditSchemaNodes(s))}else t.push(Object.assign(Object.create(null),e,{type:"field"}));return t}_updateBulkEditAreaCells(e=this._bulkEditTable._schema.details.entries){const t="(Mixed)";for(let s,i=-1;s=e[++i];){let e,l,a=!1;for(let t,i=-1;t=this._selectedRows[++i];){if(e=t[s.id],i&&e!=l){a=!0;break}l=e}this._bulkEditTable.updateData(0,s.id,a?t:e?.text??e??"");this._bulkEditTable._openDetailsPanes[0].children[i].el.innerText=a?t:e?.text??e??"",this._bulkEditTable._data[0][s.id]=a?"":e}}_updateSizesOfViewportAndCols(){this.hostEl.offsetHeight!=this._containerHeight&&(this._updateViewportHeight(),this.hostEl.offsetHeight>this._containerHeight?this._maybeAddTrs():this._maybeRemoveTrs(),this._containerHeight=this.hostEl.offsetHeight),this._updateColsWidths(),this._headerTable.style.width=this._scrollBody.offsetWidth+"px",this._adjustCursorPosSize(this._selectedCell)}_updateColsWidths(){if(this.rootEl.offsetWidth>this._containerWidth){let t=this._tableSizer.offsetWidth;const s=/\d+%/;let i=0,l=0;for(let e of this._colSchemaNodes)e.width?s.test(e)||(i+=e.pxWidth=parseInt(e.width)):l++;let a=i;for(let e of this._colSchemaNodes)e.width&&s.test(e)&&(a+=e.pxWidth=(t-i)*parseFloat(e.width)/100);for(let e of this._colSchemaNodes)e.width||(e.pxWidth=(t-a)/l);for(var e=0;e<this._colSchemaNodes.length;e++)this._cols[e].style.width=this._headerTr.cells[e].style.width=this._colSchemaNodes[e].pxWidth+"px";this._headerTr.cells[e].style.width=this._scrollBody.offsetWidth-t+"px"}}_filterData(e){this._openDetailsPanes={},this._rowsMeta={keys:[],vals:[]};for(const e of this._mainTbody.querySelectorAll("tr.details"))e.remove();this._filter=e;const t=[],s={};for(let e of this._colSchemaNodes)if("expand"!==e.type&&"select"!==e.type){if("select"==e.input?.type){const i=s[t.length]={};for(const t of e.input.options)i[t.value]=t}t.push(e)}if(e){this._data=[];for(let i of this._allData)for(let l,a=-1;l=t[++a];)if(null!=i[l.id]){let t=!1;if(t="select"==l.input?.type?"string"==typeof i[l.id]?s[i[l.id]].text.includes(e):i[l.id].text.includes(e):i[l.id].includes(e),t){this._data.push(i);break}}}else this._data=this._allData;this._scrollRowIndex=0,this._refreshTable(),this._refreshTableSizerNoDetails()}_setDataForOnlyDetails(e){this._allData=this._data=[e[e.length-1]],this.rootEl.innerHTML="";const t=this.rootEl.appendChild(document.createElement("div"));t.classList.add("details"),this._generateDetailsContent(this._schema.details,0,this._openDetailsPanes[0]={},t,[],this._data[0])}_refreshTable(){this._scrollRowIndex=this._scrollY=0,this._lastCheckedIndex=null,this._tableSizer.style.height=parseInt(this._tableSizer.style.height)+parseInt(this._tableSizer.style.top)+"px",this._tableSizer.style.top=this._numRenderedRows=0,this._cellCursor.style.display="none",this._mainTbody.replaceChildren(),this._maybeAddTrs(),this._scrollMethod()}_onScrollStaticRowHeightNoDetails(){const e=Math.max(this._scrollBody.scrollTop-this._scrollMarginPx,0),t=Math.min(parseInt(e/this._rowHeight),this._data.length-this._mainTbody.rows.length);if(t!=this._scrollRowIndex){if(Math.abs(t-this._scrollRowIndex)>this._mainTbody.rows.length)this._scrollRowIndex=parseInt(e/this._rowHeight),this._refreshTable();else{const e=Math.sign(t-this._scrollRowIndex);do{if(this._scrollRowIndex+=e,1==e){const e=this._scrollRowIndex+this._numRenderedRows-1;this._updateRowValues(this._mainTbody.appendChild(this._mainTbody.firstChild),e)}else{let e=this._mainTbody.lastChild;this._mainTbody.prepend(e),this._updateRowValues(e,this._scrollRowIndex)}}while(this._scrollRowIndex!=t)}this._refreshTableSizerNoDetails()}}_onScrollStaticRowHeightDetails(e){const t=Math.max(this._scrollBody.scrollTop-this._scrollMarginPx,0);if(t>parseInt(this._scrollY))for(;t-parseInt(this._tableSizer.style.top)>(this._rowMetaGet(this._scrollRowIndex)?.h??this._rowHeight)&&!(this._scrollRowIndex+this._numRenderedRows>this._data.length-1);){let e;(e=this._rowMetaGet(this._scrollRowIndex)?.h)?(delete this._openDetailsPanes[this._scrollRowIndex],this._mainTbody.rows[1].remove()):e=this._rowHeight;const t=this._numRenderedRows+this._scrollRowIndex,s=this._updateRowValues(this._mainTbody.appendChild(this._mainTbody.firstChild),t);this._doRowScrollDetails(s,t,this._scrollRowIndex,-e),this._scrollRowIndex++}else if(t<parseInt(this._scrollY))for(;t<parseInt(this._tableSizer.style.top);){this._scrollRowIndex--,this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows)?.h&&(delete this._openDetailsPanes[this._scrollRowIndex+this._numRenderedRows],this._mainTbody.lastChild.remove());let e=this._mainTbody.lastChild;this._mainTbody.prepend(e),this._updateRowValues(e,this._scrollRowIndex);const t=this._rowMetaGet(this._scrollRowIndex)?.h??this._rowHeight;this._doRowScrollDetails(e,this._scrollRowIndex,this._scrollRowIndex+this._numRenderedRows,t)}this._scrollY=t}_doRowScrollDetails(e,t,s,i){const l=this._rowMetaGet(t)?.h;if(l>0?this._renderDetails(e,t):-1==l?this._scrollBody.scrollTop+=this._expandRow(e,!1):e.classList.remove("expanded"),this._tableSizer.style.height=parseInt(this._tableSizer.style.height)+i+"px",this._tableSizer.style.top=parseInt(this._tableSizer.style.top)-i+"px",s===this._mainRowIndex){this._selectedCell=null;for(let e=this._activeDetailsCell;e&&(e=e.parent);)if(e.creating)for(e.creating=!1,this._exitEditMode(!1),e.parent.dataObj.splice(e.parent.dataObj.indexOf(e.dataObj),1);e&&(e=e.parent);)if(e.select){e.select();break}}this._lookForActiveCellInRow(e)}_lookForActiveCellInRow(e){if(e.dataset.dataRowIndex==this._mainRowIndex){if(this._activeDetailsCell){let e=[];for(let t=this._activeDetailsCell;t.parent;t=t.parent)e.unshift(t.index);let t=this._openDetailsPanes[this._mainRowIndex];for(let s of e)t=t.children[s];this._selectedCell=t.el,this._activeDetailsCell=t}else this._selectedCell=e.cells[this._mainColIndex];this._adjustCursorPosSize(this._selectedCell)}}_refreshTableSizerNoDetails(){this._tableSizer.style.top=this._scrollRowIndex*this._rowHeight+"px",this._tableSizer.style.height=(this._data.length-this._scrollRowIndex)*this._rowHeight+"px"}_createExpandContractButton(){const e=document.createElement("a");return e.appendChild(document.createElement("span")),e}_createCheckbox(e){const t=document.createElement("input");return t.type="checkbox",t.tabIndex="-1",e&&t.addEventListener("click",this._preventDefault),t.addEventListener("mousedown",this._preventDefault),t}_maybeAddTrs(){let e=this._mainTbody.lastChild;const t=this._scrollBody.offsetHeight+2*this._scrollMarginPx,s=this._data.length;for(;(this._numRenderedRows-1)*this._rowHeight<t&&this._scrollRowIndex+this._numRenderedRows<s;){e=this._mainTable.insertRow(),this._numRenderedRows++;for(let t=0;t<this._colSchemaNodes.length;t++){const s=e.insertCell(),i=s.appendChild(document.createElement("div"));i.style.height=this._rowInnerHeight||"auto","expand"===this._colSchemaNodes[t].type?(i.appendChild(this._createExpandContractButton()),s.classList.add("expand-col")):"select"===this._colSchemaNodes[t].type&&(i.appendChild(this._createCheckbox(!0)),s.classList.add("select-col"))}if(this._updateRowValues(e,this._scrollRowIndex+this._numRenderedRows-1),this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows-1)?.h&&this._renderDetails(e,this._scrollRowIndex+this._numRenderedRows-1),this._lookForActiveCellInRow(e),!this._rowHeight){this._rowHeight=e.offsetHeight+this._borderSpacingY;const t=window.getComputedStyle(e.firstChild);for(let e of["paddingTop","paddingBottom","borderBottomWidth","borderTopWidth"])this._rowInnerHeight-=parseInt(t[e]);this._rowInnerHeight=this._rowInnerHeight+e.offsetHeight+"px"}}}_preventDefault(e){e.preventDefault()}_maybeRemoveTrs(){const e=this._scrollBody.offsetHeight+2*this._scrollMarginPx;for(;(this._numRenderedRows-2)*this._rowHeight>e;)this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows-1)?.h&&(this._mainTbody.lastChild.remove(),delete this._openDetailsPanes[this._scrollRowIndex+this._numRenderedRows]),this._mainTbody.lastChild.remove(),this._numRenderedRows--}_updateRowValues(e,t){e.dataset.dataRowIndex=t;const s=-1!=this._selectedRows.indexOf(this._data[t]);e.classList.toggle("selected",!!s);for(let t=0;t<this._colSchemaNodes.length;t++){let i=e.cells[t],l=this._colSchemaNodes[t];"expand"!=l.type&&"select"!=l.type?this._updateMainRowCell(i,l):"select"==l.type&&(i.querySelector("input").checked=s)}return this._highlightRowsOnView[t]&&(delete this._highlightRowsOnView[t],this._highlightRowIndex(t)),e}_humanFileSize(e,t=!1,s=1){const i=t?1e3:1024;if(Math.abs(e)<i)return e+" B";const l=t?["kB","MB","GB","TB","PB","EB","ZB","YB"]:["KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"];let a=-1;const n=10**s;do{e/=i,++a}while(Math.round(Math.abs(e)*n)/n>=i&&a<l.length-1);return e.toFixed(s)+" "+l[a]}_generateFileCell(e,t,s,i){const l=e.schemaNode;e.fileInputSchemaNode=l;const a=this._opts.lang??{};let n=[{type:"field",title:a.fileName??"Filename",id:"name"},{type:"field",title:a.fileLastModified??"Last Modified",id:"lastModified",render:e=>new Date(e).toISOString().slice(0,16).replace("T"," ")},{type:"field",title:a.fileSize??"Size",id:"size",render:e=>this._humanFileSize(e)},{type:"field",title:a.fileType??"Type",id:"type"}];for(let e,t=-1;e=["filename","lastModified","size","type"][++t];)(l.input.fileMetasToShow?.[e]??this._opts.defaultFileMetasToShow?.[e]??1)||n.splice(t,1);const o=this._schemaCopyWithDeleteButton({type:"group",entries:[]},this._fileOnDelete);o.entries[0].entries.unshift({type:"field",input:{type:"button",btnText:"Open",clickHandler:(t,i,a,n,o)=>{s??=this._data[a],l.input.openHandler?.(t,i,l,e.dataObj,a,o)}}}),o.entries.push({type:"lineup",entries:n});const r=this._buildSchemaFacade(o),h=s[e.schemaNode.id];this._generateDetailsContent(r,i,e,t,e.path,h);const d=this._mapGet(this._filesMeta,h);if(null!=d){const e=t.appendChild(document.createElement("div"));e.classList.add("progressbar","active");const s=e.appendChild(document.createElement("div"));s.style.transition="none",d.bars.push(s),s.role="progressbar";const i=s.appendChild(document.createElement("span"));s.style.width=i.innerText=parseInt(d.uploadedBytes/h.size*100)+"%",s.style.removeProperty("transition")}}_updateDetailsCell(e,t=null){let s=e.el;e.schemaNode.maxHeight&&(s.innerHTML="",s=s.appendChild(document.createElement("div")),s.style.maxHeight=e.schemaNode.maxHeight,s.style.overflow="auto");for(var i=e;i.parent;i=i.parent);const l=s.innerText;if("file"==e.schemaNode.input?.type&&t[e.schemaNode.id])this._generateFileCell(e,s,t,i.rowIndex);else if(e.schemaNode.visibleIf&&this._applyVisibleIf(e),this._updateCell(e.schemaNode,s,e.selEl,t,i.rowIndex,e),"button"!==e.schemaNode.input?.type){const t=s.innerText;if(!t!=!l){for(let s=e;s;s=s.parent)null!=s.nonEmptyDescentants&&s.grpTr.classList.toggle("empty",!(s.nonEmptyDescentants+=t?1:-1));return!0}}else e.el=e.selEl=e.el.querySelector("button")}_getValueByPath(e,t){let s=e;for(const e of t){if(null==s)return;s=s[e]}return s}_resolveCellPaths(e,t){let s=e;for(var i=0;i<t.length&&".."===t[i];i++){if(!s?.parent)return null;s=s.parent}for(;i<t.length;i++)if(s=s?.children?.[t[i]],!s)return null;return s}_getTargetVal(e,t,s,i=s.dataObj){if(e&&t.id)return i[t.id];if(t.dependsOnDataPath){if(s)for(var l=s;l.parent;i=(l=l.parent).dataObj);return this._getValueByPath(i,t.dependsOnDataPath)}if(t.dependsOnCellPaths){const e=this._resolveCellPaths(s,t.dependsOnCellPaths[0]);return e?.dataObj?.[e.schemaNode.id]}return i[t.id]}_updateCell(e,t,s,i,l,a=null){if("button"===e.input?.type)this._generateButton(e,l,t,i,a);else{let n;if(e.render||"select"!=e.input?.type)n=this._getTargetVal(!0,e,a,i),e.render&&(n=e.render(n,i,e,l,a));else{let t=i[e.id];t&&"object"!=typeof t&&(t=i[e.id]=e.input.options.find(t=>t.value==i[e.id])),n=t?.text??""}let o=!1;if(this._spreadsheet&&"expand"!==e.type){const t=e.input?.enabled?.(e,i,l,a);e.input&&0!=t&&0!=t?.enabled||(o=!0)}(s??t).classList.toggle("disabled",o),e.html?t.innerHTML=n??"":t.innerText=n??""}}_updateMainRowCell(e,t){e.firstChild.innerHTML="";const s=e.closest(".main-table>tbody>tr").dataset.dataRowIndex;this._updateCell(t,e.firstChild,e,this._data[s],s)}_highlightRowIndex(e){const t=this._mainTbody.querySelector(`[data-data-row-index="${e}"]`);t?this._highlightElements(t.children):this._highlightRowsOnView[e]=!0}_highlightElements(e){const t=[];for(const s of e)t.push(window.getComputedStyle(s).backgroundColor),s.style.transition="none",s.style.backgroundColor="blue";setTimeout(()=>{for(const s of e)s.style.transition="background-color 1s linear",s.style.backgroundColor=t.shift()})}_scrollToCursor(){}_applyVisibleIf(){}}class i{constructor({totalBytes:e,rate:t=1,startAt:s=0}){this.totalBytes=e||1;const i=parseFloat(t);this.pctPerSecond=Math.max(1e-4,isNaN(i)?1:i);const l=parseFloat(s),a=isNaN(l)?0:l;this.startPercent=Math.max(0,Math.min(100,a)),this._listeners=Object.create(null),this._uploadListeners=Object.create(null),this.upload={addEventListener:(e,t)=>this._addListener(this._uploadListeners,e,t)}}_addListener(e,t,s){(e[t]??=[]).push(s)}addEventListener(e,t){this._addListener(this._listeners,e,t)}open(){}setRequestHeader(){}abort(){this._clearTimer()}send(){let e=this.totalBytes*this.startPercent/100;this._emit(this._uploadListeners.progress,{loaded:e,total:this.totalBytes}),e>=this.totalBytes?Promise.resolve().then(()=>this._emit(this._listeners.load,{})):this._timer=setInterval(()=>{e=Math.min(this.totalBytes,e+this.totalBytes*this.pctPerSecond/100),this._emit(this._uploadListeners.progress,{loaded:e,total:this.totalBytes}),e>=this.totalBytes&&(this._clearTimer(),this._emit(this._listeners.load,{}))},1e3)}_emit(e,t){if(e)for(const s of e)s(t)}_clearTimer(){this._timer&&(clearInterval(this._timer),this._timer=null)}}class l extends s{mainInstance;_dropdownAlignmentContainer=this.rootEl;constructor(){super(...arguments)}_doEditSave(){const e="select"===this._activeSchemaNode.input.type?this._inputVal.value:this._inputVal;this._cellCursorDataObj[this._activeSchemaNode.id]=this._inputVal;for(const t of this.mainInstance._selectedRows)t[this._activeSchemaNode.id]=e;for(const t of this.mainInstance._mainTbody.querySelectorAll("tr.selected"))this.mainInstance.updateData(t.dataset.dataRowIndex,this._activeSchemaNode.id,e,!1,!0);this._updateDetailsCell(this._activeDetailsCell,this._cellCursorDataObj)}}class a extends s{static version="1.1.0";static build="2025-12-13T06:13:29.295Z";constructor(){super(...arguments),this._dropdownAlignmentContainer=this._onlyDetails?this.rootEl:this._scrollBody}_doEditSave(){let e=!0;const t="select"===this._activeSchemaNode.input.type?this._inputVal.value:this._inputVal;if(this._activeSchemaNode.input.onChange?.({newValue:t,oldValue:this._selectedCellVal,dataKey:this._activeSchemaNode.id,dataContext:this._cellCursorDataObj,schemaNode:this._activeSchemaNode,instanceNode:this._activeDetailsCell,closestMeta:e=>this._closestMeta(this._activeSchemaNode,e),cancelUpdate:()=>e=!1}),e){if(this._cellCursorDataObj[this._activeSchemaNode.id]=this._inputVal,this._activeDetailsCell){this._updateDetailsCell(this._activeDetailsCell,this._cellCursorDataObj)&&!this._onlyDetails&&this._updateDetailsHeight(this._selectedCell.closest("tr.details"));for(let e=this._activeDetailsCell.parent;e;e=e.parent)e.schemaNode.closedRender&&(e.updateRenderOnClose=!0)}else this._updateMainRowCell(this._selectedCell,this._activeSchemaNode),this._unsortCol(this._activeSchemaNode.id);-1!=this._selectedRows.indexOf(this._cellCursorDataObj)&&this._updateBulkEditAreaCells([this._activeSchemaNode]),this._updateDependentCells(this._activeSchemaNode,this._activeDetailsCell)}else this._inputVal=this._selectedCellVal;this._selectedCellVal=this._inputVal}_scrollToCursor(){if(this._onlyDetails)return this._cellCursor.scrollIntoView({block:"center"});const e=this._scrollBody.scrollTop,t=this._scrollBody.offsetHeight,s=parseInt(this._cellCursor.style.top),i=this._cellCursor.offsetHeight,l=s+i/2-e-t/2,a=Math.abs(l/t);a>.25&&(this._scrollBody.scrollTop=a>.5?s-t/2+this._rowHeight/2:s-t/2+i/2+(l<0?1:-1)*t*.5/2),this._scrollMethod()}_expandRow(e,t=!0){const s=parseInt(e.dataset.dataRowIndex);if(!this._schema.details||this._rowMetaGet(s)?.h>0)return;const i=this._renderDetails(e,s),l=this._rowMetaSet(s,"h",this._rowHeight+i.offsetHeight+this._borderSpacingY),a=i.querySelector(".content");return this._detailsBordersHeight||(this._detailsBordersHeight=l-a.offsetHeight),this._tableSizer.style.height=parseInt(this._tableSizer.style.height)+l-this._rowHeight+"px",t?(this._unsortCol(null,"expand"),a.style.transition="",a.style.height="0px",setTimeout(()=>a.style.height=l-this._detailsBordersHeight+"px"),this._animate(()=>this._adjustCursorPosSize(this._selectedCell,!0),500,"cellCursor")):(a.style.transition="none",a.style.height=l-this._detailsBordersHeight+"px"),l}_contractRow(e){e.classList.contains("details")&&(e=e.previousSibling);const t=parseInt(e.dataset.dataRowIndex);if(t==this._mainRowIndex&&this._activeDetailsCell&&this._exitEditMode(!1),!this._schema.details||!this._rowMetaGet(t)?.h)return;this._unsortCol(null,"expand"),this._mainRowIndex==t&&this._activeDetailsCell&&(this._selectMainTableCell(e.cells[this._mainColIndex]),this._scrollToCursor());const s=e.nextSibling.querySelector(".content");"auto"===s.style.height?(s.style.height=this._rowMetaGet(t).h-this._detailsBordersHeight+"px",setTimeout(()=>s.style.height=0)):0==parseInt(s.style.height)?s.dispatchEvent(new Event("transitionend")):s.style.height=0,this._animate(()=>this._adjustCursorPosSize(this._selectedCell,!0),500,"cellCursor")}_scrollElementIntoView(e){if(this._onlyDetails)this._tooltip.scrollIntoView({behavior:"smooth",block:"center"});else{const t=this._getElPos(e);this._scrollBody.scrollTop=t.y+e.offsetHeight/2-this._scrollBody.offsetHeight/2,this._scrollMethod()}}_applyVisibleIf(e,t){const s=e.schemaNode;let i=this._getTargetVal(!1,s,e);return"select"===s.input?.type&&i?.value&&(i=i.value),e.hidden=!!e.hidden,!!s.visibleIf(i,e.dataObj,s,t,e)==e.hidden&&(e.hidden=!e.hidden,e.outerContainerEl.style.display=e.hidden?"none":""),!e.hidden}}export{a as default};
//# sourceMappingURL=tablance.esm.js.map
