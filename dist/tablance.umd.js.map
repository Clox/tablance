{"version":3,"file":"tablance.umd.js","sources":["../src/tablance.js"],"sourcesContent":["/** \n * Base class providing shared table logic, structure management,\n * data handling, and rendering helpers etc used by both Tablance and TablanceBulk.\n */\nclass TablanceBase {\n\thostEl;//the element that is passed to the constructor and which the table is added to\n\trootEl;//Readonly, container-element for table\n\tneighbourTables;//Object of other Tablance-instances. Possible keys are \"up\" and \"down\". If any of these are set\n\t\t\t\t//then if one keeps pressing up/down until there are no more cells then one will get o the next table.\n\t\t\t\t//Except for manually this can also be set via chainTables()\n\t_containerHeight=0;//height of #container. Used to keep track of if height shrinks or grows\n\t_containerWidth=0;//height of #container. Used to keep track of if width shrinks or grows\n\t_colSchemaNodes=[];//column-objects. Essentially the same as schema.main.columns but have been processed an may in\n\t\t// addition contain \"sortDiv\" reffering to the div with the sorting-html (see for example opts->sortAscHtml)\n\t_cols=[];//array of col-elements for each column\n\t_headerTr;//the tr for the top header-row\n\t_headerTable;//the tabe for the #headerTr. This table only contains that one row.\n\t_allData=[];//contains all, unfiltered data that has been added via addData()\n\t_data=[];//with no filter applied(empty seachbar) then this is reference to _allData, otherwise is a subset of it\n\t_scrollRowIndex=0;//the index in the #data of the top row in the view\n\t_scrollBody;//resides directly inside #container and is the element with the scrollbar. It contains #scrollingDiv\n\t_scrollingContent;//a div that is inside #scrollbody and holds #tablesizer and #cellCursor if spreadsheet\n\t\t\t\t\t//this is needed because putting #cellCursor directly inside #scrollBody will not make it scroll\n\t\t\t\t\t//because it has position absolute and needs that. And putting it inside #tableSizer will cause it\n\t\t\t\t\t//to jump up and down when pos and height of #tableSizer is adjusted to keep correct scroll-height\n\t_scrollMarginPx=150;//is used to allow for more rows to be rendered outside of the view so to speak. At least in\n\t\t\t\t\t\t//firefox when scrolling it is really noticable that the scrolling is done before the rows are\n\t\t\t\t\t\t//moved which reveals white area before the rows are rendered. Increasing this number will\n\t\t\t\t\t\t//basically add that many pixels to the height of the viewport on top and bottom. It will not\n\t\t\t\t\t\t//actually be higher but the scroll-method will see it as if it is higher than it is\n\t_tableSizer;//a div inside #scrollingDiv which wraps #mainTable. The purpose of it is to set its height to the \n\t\t\t\t//\"true\" height of the table so that the scrollbar reflects all the data that can be scrolled through\n\t_mainTable;//the actual main-table that contains the actual data. Resides inside #tableSizer\n\t_mainTbody;//tbody of #mainTable\n\n\t_bulkEditArea;//a div displayed under #scrollBody if rows are selected/checked using select-column. This \n\t\t\t\t\t\t//section is used to edit multiple rows at once\n\t_bulkEditTable;//this holds another instance of the Tablance class which is used inside the bulk-edit-area\n\t_bulkEditAreaOpen=false;//whether the section is currently open or not\n\t_bulkEditSchemaNodes;//Array of schema-nodes with inputs that are present in the bulk-edit-area\n\t_bulkEditAreaHeightPx;//height of bulk-edit-area in px. Used to animate from 0 to full height when opening/closing\n\t_numberOfRowsSelectedSpan;//resides in the bulk-edit-area. Should be set to the number of rows selected\n\t_borderSpacingY;//the border-spacing of #mainTable. This needs to be summed with offsetHeight of tr (#rowHeight) to \n\t\t\t\t\t//get real distance between the top of adjacent rows\n\t_rowHeight=0;//the height of (non expanded) rows with #borderSpacingY included. Assume 0 first until first row added\n\t_rowInnerHeight=0;//this is the height that the div inside main-tds should be set to. It's calculated from \n\t\t\t\t\t//#rowHeight minus top&bottom-padding minus #borderSpacingY of td. This is needed to make sure each\n\t\t\t\t\t//row is always of the same height and things don't get messed up because some row is heigher\n\t\t\t\t\t//because it has high content.\n\t_staticRowHeight;//This is set in the constructor. If it is true then all rows should be of same height which\n\t\t\t\t\t //improves performance.\n\t_spreadsheet;//whether the table is a spreadsheet, which is set in the constructor\n\t_opts; //reference to the object passed as opts in the constructor\n\t_sortingCols=[];//contains data on how the table currently is sorted. It is an array of \n\t\t\t\t\t\t\t\t\t\t//objects which each contain \"index\" which is the index of the column and\n\t\t\t\t\t\t\t\t\t\t//\"order\" which value should be either \"desc\" or \"asc\". The array may contain\n\t\t\t\t\t\t\t\t\t\t//multiple of these objects for having it sorted on multiple ones.\n\t_searchInput;//the input-element used for filtering data\n\t_filter;//the currently applied filter. Same as #searchInput.value but also used for comparing old & new values\n\t\n\t_cellCursor;//The element that for spreadsheets shows which cell is selected\n\t_mainRowIndex;//the index of the row that the cellcursor is at\n\t_mainColIndex;//the index of the column that the cellcursor is at.\n\t_activeSchemaNode;//reference to the schemaNode-object of the selcted cell. For cells in the maintable this would\n\t\t\t\t\t\t//point to an object in #colSchemaNodes, otherwise to the schemaNode-object of details-cells\n\t_cellCursorDataObj;//reference to the actual object holding the data that the cell-cursor currently is at.\n\t\t\t\t\t\t//Usually this will simply point to an object in #data but for data that is nested with\n\t\t\t\t\t\t//repeat-entries this will point to the correct inner object\n\t_selectedCellVal;//the value of the cell that the cellCursor is at\n\t_selectedCell;//the HTML-element of the cell-cursor. probably TD's most of the time.\n\t_inEditMode;//whether the user is currently in edit-mode\n\t//and values are px as ints. This is used to offset the position and adjust position of #cellCursor in order to\n\t//center it around the cell. It is also used in conjunction with cellCursorOutlineWidth to adjust margins of the\n\t//main-table in order to reveal the outermost line when an outermost cell is selected\n\t_inputVal;//the current val of the input when in edit-mode. Will be read and commited if cell is exited correctly\n\t_highlightOnFocus=true;//when the spreadsheet is focused  we want focus-outline to appear but only if focused by\n\t\t\t\t//keyboard-tabbing, and not when clicking or exiting out of edit-mode which again focuses the table.\n\t\t\t\t//By setting this to true in mouseDownEvent we can \n\t\t\t\t//check which input was used last when the focus-method is triggerd\n\t_detailsBordersHeight;//when animating details for expanding/contracting the height of them fully\n\t\t\t//expanded needs to be known to know where to animate to and from. This is different from \n\t\t\t//#expandedRowIndicesHeights because that is the height of the whole row and not the div inside.\n\t\t\t//we could retrieve offsetheight of the div each time a row needs to be animated or instead we can get\n\t\t\t//the border-top-width + border-bottom-width once and then substract that from the value of  what's in\n\t\t\t//#expandedRowIndicesHeights instead\n\t_scrollMethod;//this will be set to a reference of the scroll-method that will be used. This depends on settings for\n\t\t\t\t//staticRowHeight and details\n\t_rowsMeta={keys:[],vals:[]};//This holds meta-data for the data-rows. The structure is essentially like a hashmap\n\t\t\t//from Java where objects are used as keys which in this case it is the data-row-object. This is done by\n\t\t\t//having 2 arrays: keys & vals. A references to a row is placed in \"keys\" and meta-data placed in \"vals\"\n\t\t\t//and index X in \"keys\" always corresponds to index X in \"values\". As for the meta-data itself this is\n\t\t\t//another object:\n\t\t\t//\th Integer \tIf this is present then the row is expanded, otherwise not. The value is the combined height\n\t\t\t//\t\t\t\tof the main row and its details-row.\n\t_filesMeta={keys:[],vals:[]};//Similiar to rowsMeta as it is structured the same but used for files that the user\n\t\t\t\t\t\t\t\t//has uploaded during the current session. This is to keep track of upload-progress.\n\t\t\t\t\t\t\t\t//keys are filled with File-objects while vals is filled with objects containing\n\t\t\t\t\t\t\t\t//metadata: uploadedBytes\n\t_selectedRows=[];//array of the actual data-objects of rows that are currently selected/checked using the select-col\n\t_scrollY=0;//this keeps track of the \"old\" scrollTop of the table when a scroll occurs to know \n\t_numRenderedRows=0;//number of tr-elements in the table excluding tr's that are details (details too are tr's)\n\t_openDetailsPanes={};//for any row that is expanded and also in view this will hold navigational data which\n\t\t\t\t\t\t//is read from when clicking or navigating using keyboard to know which cell is next, and\n\t\t\t\t\t\t//which elements even are selectable and so on. Keys are data-row-index. As soon as a row\n\t\t\t\t\t\t//is either contracted or scrolled out of view it is removed from here and then re-added\n\t\t\t\t\t\t//if expanded again or scrolled into view.\n\t\t\t\t\t\t//keys are rowDataindex and the values are instanceTrees rooted at an instance-node shaped as:\n\t\t\t\t\t\t//\tel: HTMLElement the cell-element itself\n\t\t\t\t\t\t//\tchildren: Array May be null but groups can have children which would be put in here\n\t\t\t\t\t\t//  \t\t\t\teach element would be another instance-node\n\t\t\t\t\t\t//\tparent: points to the parent instance-node. for non nested cells this would point to a\n\t\t\t\t\t\t//\t\t\t\t\t\troot instance-node. and for the root instance-node this would be null.\n\t\t\t\t\t\t//\t\t\t\t\t\tdespite the root being an instance-node it cant be naviagted to. \n\t\t\t\t\t\t//\t\t\t\t\t\tit simply holds the top instance-nodes\n\t\t\t\t\t\t//  index: the index of the node in the children-array of its parent\n\t\t\t\t\t\t//}\n\t_activeDetailsCell;\t//points to an object in #openDetailsNavMap and in extension the cell of an details.\n\t\t\t\t\t\t\t//If this is set then it means the cursor is inside an details.\n\t/* #generatingDetails=false;//this is a flag that gets set to true when a row gets expanded or an already expanded\n\t\t//row gets scrolled into view, in short whenver the details-elements are generated. Then it gets unset when\n\t\t//creation finishes. The reason for having this flag is so that update */\n\t_ignoreClicksUntil;//when being inside an open group and trying to double-click on another cell further down to\n\n\n\t\t//interact with it the first click will highlight it but then the current group closes and what's below it will\n\t\t//get shifted up and the second click hits something else. By setting this var to current time plus 500 ms\n\t\t//when a group closes and checking if current time is past this one in mouseDown handler we'll ignore the second\n\t\t//click which is better user-experience\n\t_highlightRowsOnView={};//Rows can be added to this object with rowindex in #data as key, value needs to be truthy.\n\t\t//Rows that are outside of view can be added and when scrolled into view they will be highlighted. \n\t_lastCheckedIndex;//This is the index of the row that was last (un)checked/selected, meaning the checkbox in the\n\t\t\t\t\t//select-column was interacted with. This is used if the user interacts with another checkbox while\n\t\t\t\t\t//shift is being held\n\t_numRowsSelected=0;//number of rows that are selected/checked using the select-column\n\t_numRowsInViewSelected=0;//number of rows in the current view/filter that are selected/checked using select-column\n\t_animations={};//keeps tracks of animations. Key is a unique id-string, identifying the animation so multiple\n\t\t\t\t\t//instances of the same animation can't run. Value is the end-time in ms since epoch.\n\t_onlyDetails;//If this is set to true then the table will not have any actual rows and will instead only have an\n\t\t\t\t\t// details specified in param details. It will also not have a scrollpane and the details will\n\t\t\t\t\t// always be expanded. Method addData is still used to add the actual data but it will only use the\n\t\t\t\t\t// last row sent. So adding multiple ones will cause it to discard all but the last.\n\t_tooltip;//reference to html-element used as tooltip\n\t_dropdownAlignmentContainer;\t\t\t\t\t\t\n\n\t/**\n\t * @param {HTMLElement} hostEl An element which the table is going to be added to\n\t * @param {{}[]} columns An array of objects where each object has the following structure: {\n\t * \t\t\tid String A unique identifier for the column. The value in the data that has this key will be used as\n\t * \t\t\t\tthe value in the cell.\n\t * \t\t\ttitle String The header-string of the column\n\t * \t\t\twidth String The width of the column. This can be in either px or % units.\n\t * \t\t\t\tIn case of % it will be calculated on the remaining space after all the fixed widths\n\t * \t\t\t\thave been accounted for.\n\t * \t\t\tinput: See param details -> input. This is the same as that one except textareas are only valid for\n\t * \t\t\t\t\t\t\t\t\t\t\t\tdetails-cells and not directly in a maintable-cell\n\t * \t\t\trender Function Function that can be set to render the content of the cell. The return-value is what\n\t * \t\t\t\t\twill be displayed in the cell. Similiarly to columns->render it gets passed the following:\n\t * \t\t\t\t\t1: The value from data pointed to by \"id\". If id is not set but dependsOn is then this will \n\t * \t\t\t\t\t\tinstead get passed the value that the id of the depended cell points to, \n\t * \t\t\t\t\t2: data-row, \n\t * \t\t\t\t\t3: schemaNode,\n\t * \t\t\t\t\t4: main-index \n\t * \t\t\thtml Bool Default is false. If true then the content of the cell will be rendered as html\n\t * 1: The value from data pointed to by \"id\", 2: data-row, 3: schemaNode,4: main-index, 5: instanceNode\n\t * \t\t\ttype String The default is \"data\". Possible values are:\n\t * \t\t\t\t\"data\" - As it it implies, simply to display data but also input-elements such as fields or buttons\n\t * \t\t\t\t\"expand\" - The column will be buttons used for expanding/contracting the rows. See param details\n\t * \t\t\t\t\"select\" - The column will be checkboxes used to (un)select rows\t\n\t * \t\t}\n\t * \t\t\t\n\t * \t@param\t{Boolean} staticRowHeight Set to true if all rows are of same height. With this option on, scrolling\n\t * \t\t\t\tquickly through large tables will be more performant.\n\t * \t@param\t{Boolean} spreadsheet If true then the table will work like a spreadsheet. Cells can be selected and the\n\t * \t\t\t\tkeyboard can be used for navigating the cell-selection.\n\t * \t@param\t{Object} details This allows for having rows that can be expanded to show more data. An \"entry\"-object\n\t * \t\t\tis expected and some of them can hold other entry-objects so that they can be nested.\n\t * \t\t\tProperties that are valid for all types of entries:\n\t * \t\t\t\t* title String displayed title if placed in a container which displays the title\n\t *\n\t * \t\t\t\t* visibleIf Function Optional callback that determines whether this entry should be visible.\n\t * \t\t\t\t\tThe function is called whenever the entry is rendered or any of its dependencies\n\t * \t\t\t\t\t(see `dependsOn`) change. It receives the following arguments:\n\t * \t\t\t\t\t\t(1: The value from data pointed to by \"id\"(or if dependsOn is set the value of that cell)\n\t * \t\t\t\t\t\t2: data-row, 3: schemaNode, 4: main-index, 5: instanceNode)\n\t * \t\t\t\t\tReturn `true` to make the entry visible, or `false` to hide it.\n\t *\n\t * \t\t\t\t\tWhen hidden:\n\t *   \t\t\t\t\t- The entry’s DOM element is not displayed.\n\t *   \t\t\t\t\t- `render` will not be called for this entry.\n\t *\n\t * \t\t\t\t\tVisibility state:\n\t *   \t\t\t\t\t- The instanceNode receives an internal `hidden` flag when the entry is hidden.\n\t *   \t\t\t\t\t- `hidden` is read-only and should not be modified manually.\n\t *   \t\t\t\t\t- If the entry is visible, no `hidden` property is present.\n\t *\n\t *\n\t * \t\t\t\t* dependsOn String Optional string identifying another entry that this entry depends on.\n\t * \t\t\t\t\tWhenever the referenced entry is edited, this entry automatically refreshes.\n\t * \t\t\t\t\tThe refresh cycle includes:\n \t *\t\t\t\t\t\t- Re-evaluating `visibleIf` (if provided).\n\t *\t\t\t\t\t\t- Re-rendering this entry (unless it is hidden).\n\t *\n \t *\t\t\t\t\tTargeting rules:\n\t * \t\t\t\t\t\t1. If `cellId` is set on the schemaNode of a field, that ID is the identifier of that entry.\n\t * \t\t\t\t\t\t2. If `id` is set (and `cellId` is not), the value of `id` becomes the entry’s identifier.\n\t * \t\t\t\t\t\t3. `dependsOn` must match the identifier of another entry. If both `id` and `cellId` exist,\n\t * \t\t\t\t\t\t\t`cellId` takes priority.\n\t * \t\t\tTypes of entries:\n\t * \t\t\t{\n  \t *\t\t\t\ttype \"list\" this is an entry that holds multiple rows laid out vertically, each item in the list \n\t *\t\t\t\t\t\t\tcan have a title on the left side by specifying \"title\" in each item within the list\n\t * \t\t\t\tentries Array each element should be another entry\n\t * \t\t\t\ttitlesColWidth:String Width of the column with the titles. Don't forget adding the unit.\n\t * \t\t\t\t\tDefault is null which enables setting the width via css.Setting 0/false turns it off completely.\n\t * \t\t\t\tonBlur: Function Callback fired when cellcursor goes from being inside the container to outside\n\t * \t\t\t\t\tIt will get passed arguments 1:instanceNode, 2:mainIndex\n\t * \t\t\t\tbulkEdit Bool Besides setting bulkEdit on input of fields it can also be set on containers which\n\t * \t\t\t\t\t\t\twill add the container to the bulk-edit-area. Any input-fields in the container that\n\t * \t\t\t\t\t\t\thave bulkEdit true will appear in the container there. Remember that both the container\n\t * \t\t\t\t\t\t\tand input of fields have to have true bulkEdit for this to work. These can also be\n\t * \t\t\t\t\t\t\tnested so if there's another group in the group where both have true bulkEdit and the\n\t * \t\t\t\t\t\t\tinner group has inputs with true bulkEdit as well then multi-level groups will be \n\t * \t\t\t\t\t\t\tadded to the bulk-edit-area. Containers in the bulk-edit-area appear as a normal cell\n\t * \t\t\t\t\t\t\tat first but by entering it a page dedicated to that container is changed to.\n\t * \t\t\t\tdependsOn String Can be set up to \n\t *\t\t\t}\n\t *\t\t\t{\t\n\t *\t\t\t\ttype \"lineup\" similiar to a list but each item is inlined, meaning they will be lined up\n\t *\t\t\t\t\t\t\t\t\tin a horizontal line and will also wrap to multiple lines if needed\n\t * \t\t\t\tentries Array each element should be another entry\n\t * \t\t\t\tcssClass String Css-classes to be added to the lineup-div\n\t * \t\t\t\tonBlur Function Callback fired when cellcursor goes from being inside the container to outside\n\t * \t\t\t\t\tIt will get passed arguments 1:instanceNode, 2:mainIndex\n\t * \t\t\t\tbulkEdit Bool Besides setting bulkEdit on input of fields it can also be set on containers which\n\t * \t\t\t\t\t\t\twill add the container to the bulk-edit-area. Any input-fields in the container that\n\t * \t\t\t\t\t\t\thave bulkEdit true will appear in the container there. Remember that both the container\n\t * \t\t\t\t\t\t\tand input of fields have to have true bulkEdit for this to work. These can also be\n\t * \t\t\t\t\t\t\tnested so if there's another group in the group where both have true bulkEdit and the\n\t * \t\t\t\t\t\t\tinner group has inputs with true bulkEdit as well then multi-level groups will be \n\t * \t\t\t\t\t\t\tadded to the bulk-edit-area. Containers in the bulk-edit-area appear as a normal cell\n\t * \t\t\t\t\t\t\tat first but by entering it a page dedicated to that container is changed to.\n\t *\t \t\t}\n\t *\t\t\t{\n  \t * \t\t\t\ttype \"field\" this is what will display data and which also can be editable by specifying \"input\"\n  \t * \t\t\t\tid String the key of the property in the data that the row should display\n\t * \t\t\t\tcssClass String Css-classes to be added to the field\n\t * \t\t\t\trender Function Function that can be set to render the content of the cell. The return-value is what\n\t * \t\t\t\t\twill be displayed in the cell. Similiarly to columns->render it gets passed the following:\n\t * \t\t\t\t\t1: The value from data pointed to by \"id\". If id is not set but dependsOn is then this will \n\t * \t\t\t\t\t\tinstead get passed the value that the id of the depended cell points to, \n\t * \t\t\t\t\t2: data-row, \n\t * \t\t\t\t\t3: schemaNode,\n\t * \t\t\t\t\t4: main-index, \n\t * \t\t\t\t\t5: instanceNode\n\t * \t\t\t\tinput Object field is editable if this object is supplied and its \"disabled\"-prop is not true\n\t * \t\t\t\t\t{\n\t * \t\t\t\t\ttype String This is mandatory and specifies the type of input. Se further down for properties \n\t * \t\t\t\t\t\tspecific to each type of input. The possible types are:\n\t * \t\t\t\t\t\t\t\"text\"(single line text),\n\t * \t\t\t\t\t\t\t\"textarea\"(multi-line text),\n\t * \t\t\t\t\t\t\t\"number\"(number with stepper),\n\t * \t\t\t\t\t\t\t\"date\"(a date and possibly time with a calendar),\n\t * \t\t\t\t\t\t\t\"select\"(selection from a list of items. The values for cells may either be the \"value\" \n\t * \t\t\t\t\t\t\t\t\t\tspecified in one the the options in \"options\", or it can be an actual \n\t * \t\t\t\t\t\t\t\t\t\treference to the option)\n\t * \t\t\t\t\t\t\t\"button\"(simple button)\n\t * \t\t\t\t\t\t\t\"file\" (An input for uploading files. The data for a file entry may be a \n\t * \t\t\t\t\t\t\t\tFile-object which it will be if the file has been uploaded during the current\n\t * \t\t\t\t\t\t\t\tsession. Or it may be an object which basically have the same properties\n\t * \t\t\t\t\t\t\t\tas File:lastModified, name, size, type altough none of those properties are\n\t * \t\t\t\t\t\t\t\tmandatory. Use property \"fileUploadHandler\" to handle the actual upload.)\n\t * \t\t\t\t\t----Properties valid for ALL types of inputs----\n\t * \t\t\t\t\t\tplaceholder String adds a placeholder-string to the input-element\n\t * \t\t\t\t\t\tvalidation Function A callback function which can be used to validate the data upon\n\t * \t\t\t\t\t\t\tcomitting it. Return true if validation was successfull.\n\t * \t\t\t\t\t\t\tIt gets passed the following arguments:\n\t * \t\t\t\t\t\t\t1:newValue, 2: message-function - A function that that takes a message-string as its\n\t * \t\t\t\t\t\t\tfirst argument. If it the validation didn't go through then this string will be\n\t * \t\t\t\t\t\t\tdisplayed to the user. 3:schemaNode, 4:rowData, 5:mainIndex, \n\t * \t\t\t\t\t\t\t6:instanceNode(if details-cell)\n\t *\t\t\t\t\t\ttitle String String displayed title if placed in a container which displays the title\n\t * \t\t\t\t\t\tbulkEdit Bool Whether this input should be editable via bulk-edit-area, the section that \n\t * \t\t\t\t\t\t\tappears when selecting/checking multiple rows using the select-col. Default is true if\n\t * \t\t\t\t\t\t\tnot in details, or false if in details.\n\t * \t\t\t\t\t\t\tContainers can too be added to the bulk-edit-area by setting bulkEdit on the container.\n\t * \t\t\t\t\t\tmultiCellWidth Int For inputs that are present in the bulk-edit-area. This property can be \n\t * \t\t\t\t\t\t\tused to specify the number of pixels in width of the cell in that section.\n\t * \t\t\t\t\t\tonChange Function Callback fired when the user has changed the value of the input.\n\t * \t\t\t\t\t\t\tIt will get passed arguments:\n\t * \t\t\t\t\t\t\t1:TablanceEvent. It has a method with key \"preventDefault\" which if called prevents the\n\t * \t\t\t\t\t\t\tdata/cell from actually being changed. ,2:property-name (id) of edited value\n\t * \t\t\t\t\t\t\t,3:newValue,4:oldValue,5:rowData or rowData[] if bulk-edit-cell was edited,6:schemaNode\n\t * \t\t\t\t\t\t\t,7:instanceNode of the input if in details,null if not inside details\n\t * \t\t\t\t\t\tonBlur Function Callback fired when cellcursor goes from being inside the container\n\t * \t\t\t\t\t\t\tto outside. It will get passed arguments 1:instanceNode, 2:mainIndex\n\t * \t\t\t\t\t\tenabled Function - If present then this function will be run and if it returns falsey then\n\t * \t\t\t\t\t\t\tthe cell will not be editable. It may also return an object structured as:\n\t * \t\t\t\t\t\t\t{enabled:Bool, message:String}. The message will be displayed to the user \n\t * \t\t\t\t\t\t\tif edit is attempted and enabled is set to false, disabling the field\n\t * \t\t\t\t\t\t\tIt gets passed the following arguments - \n\t * \t\t\t\t\t\t\t1:schemaNode,2:rowData,3:mainIndex,4:instanceNode(if in details)\n\t * \t\t\t\t\t----Properties specific to input \"text\"----\n\t * \t\t\t\t\t\tformat object When defined, Tablance automatically applies the specified pattern to \n\t * \t\t\t\t\t\t\tthe <input> element as the user types. It can enforce numeric-only input, insert\n\t * \t\t\t\t\t\t\tdelimiters, and handle smart date validation.\n\t * \t\t\t\t\t\t\tSupported properties:\n\t * \t\t\t\t\t\t\t - blocks:        \t\t\tArray of block lengths to group the input (e.g. [4,2,2])\n\t * \t\t\t\t\t\t\t - delimiter:     \t\t\tString inserted between blocks (default: none)\n\t * \t\t\t\t\t\t\t - numericOnly:   \t\t\tBoolean, removes all non-digit characters\n\t * \t\t\t\t\t\t\t - date:          \t\t\tBoolean, enables smart date validation\n\t * \t\t\t\t\t\t\t - stripDelimiterOnSave:\tBoolean, if true delimiters are excluded in the saved data\n\t * \t\t\t\t\t\t\tExamples:\n\t * \t\t\t\t\t\t\t// Personnummer: 19900218-9999\n\t * \t\t\t\t\t\t\tinput: {\n\t * \t\t\t\t\t\t\t\ttype: \"text\",\n\t * \t\t\t\t\t\t\t\tformat: { blocks: [8, 4], delimiter: \"-\", numericOnly: true }\n\t * \t\t\t\t\t\t\t}\n\t * \t\t\t\t\t\t\t// Date (YYYY-MM-DD) with month/day clamping and leap-year handling\n\t * \t\t\t\t\t\t\tinput: {\n\t * \t\t\t\t\t\t\t\ttype: \"text\",\n\t * \t\t\t\t\t\t\t\tformat: { date: true, blocks: [4, 2, 2], delimiter: \"-\", numericOnly: true }\n\t * \t\t\t\t\t\t\t}\n\t * \t\t\t\t\t\t\t\n\t * \t\t\t\t\t\tmaxLength int Sets max-length for the string\t\t\t\t\t\t\t\n\t * \t\t\t\t\t----Properties specific to input \"textarea\"----\n\t * \t\t\t\t\t\tmaxHeight int Sets the max-height in pixels that it should be able to be resized to\n\t * \t\t\t\t\t----Properties specific to input \"file\"----\n\t * \t\t\t\t\t\tfileUploadHandler Function This callback will be triggered when the user does a file-upload.\n\t * \t\t\t\t\t\t\tArguments: 1:XMLHttpRequest - call open() on this to specify url and such,\n\t * \t\t\t\t\t\t\t2: The File-object, 3:schemaNode,4:rowData,5:mainIndex,6:instanceNode(if in details)\n\t * \t\t\t\t\t\tfileMetasToShow Object An object specifying which meta-bits to show. Default of all are true\n\t * \t\t\t\t\t\t\t{filename Bool, lastModified Bool, size Bool, type Bool}\n\t * \t\t\t\t\t\t\tMay also be set via opts->defaultFileMetasToShow\n\t * \t\t\t\t\t\topenHandler Function callback-function for when the open-button is pressed. It gets the\n\t * \t\t\t\t\t\t\tfollowing arguments passed to it: \n\t * \t\t\t\t\t\t\t1: Event, 2: File-object, 3:schemaNode,4:rowData,5:mainIndex,\n\t * \t\t\t\t\t\t\t6:instanceNode(if in details)\n\t * \t\t\t\t\t\tdeleteHandler Function callback-function for when the user deletes a file. It gets the \n\t * \t\t\t\t\t\t\tfollowing arguments passed to it:\n\t * \t\t\t\t\t\t\t1: Event, 2: File-object, 3:schemaNode,4:rowData,5:mainIndex,\n\t * \t\t\t\t\t\t\t6:instanceNode(if in details)\n\t * \t\t\t\t\t----Properties specific to input \"select\"----\n\t * \t\t\t\t\t\tminOptsFilter Integer - The minimum number of options required for the filter-input to\n\t * \t\t\t\t\t\t\tappear. Can also be set via param opts->defaultMinOptsFilter\n\t * \t\t\t\t\t\tnoResultsText String A string which is displayed when a user filters the \n\t * \t\t\t\t\t\t\toptions in a select and there are no results. \n\t * \t\t\t\t\t\t\tCan also be set globally via param opts->lang->selectNoResultsFound\n\t * \t\t\t\t\t\toptions: Array Each element should be an object: {\n\t * \t\t\t\t\t\t\tvalue * The value of the cell will be mapped to the option with the same value\n\t * \t\t\t\t\t\t\ttext String Unless a render-method has been set then this string will be shown\n\t * \t\t\t\t\t\t\tpinned Bool If true then this option will be pinned at the top. Default is false\n\t * \t\t\t\t\t\t\tcssClass: Css-classes to be added to the opt which actually is a li-element\n\t * \t\t\t\t\t\t}\n\t * \t\t\t\t\t\tallowCreateNew bool - Allows user to create new options.\n\t * \t\t\t\t\t\t\t\tIf this is true then minOptsFilter will be ignored, input-field is required anyway.\n\t * \t\t\t\t\t\tcreateNewOptionHandler Function - Callback which is called when the user creates a new \n\t * \t\t\t\t\t\t\toption, which can be done if allowCreateNew is true. It will get passed arguments \n\t * \t\t\t\t\t\t\t1:new option-object,2:event, 3:dataObject,4:mainDataIndex,\n\t * \t\t\t\t\t\t\t5:schemaNode,6:instanceNode(if inside details)\n\t * \t\t\t\t\t\tselectInputPlaceholder String - A placeholder for the input which is\n\t * \t\t\t\t\t\t\tvisible either if the number of options exceed minOptsFilter or allowCreateNew is true\n\t * \t\t\t\t\t}\n\t * \t\t\t\t\t----Properties specific to input \"button\"----\n\t * \t\t\t\t\t\tbtnText String If type is \"button\" then this will be the text on it\n\t * \t\t\t\t\t\tclickHandler Function A callback-function that will get called  when the button is pressed. \n\t * \t\t\t\t\t\t\tIt will get passed arguments 1:event, 2:dataObject\n\t * \t\t\t\t\t\t\t,3:mainDataIndex,4:schemaNode,5:instanceNode(if inside details)\n  \t * \t\t\t\t}\n\t * \t\t\t}\n\t * \t\t\t{\n  \t * \t\t\t\ttype:\"repeated\" Used for \"repeated\" sets of data. The same data-structure is repeated as many times \n\t * \t\t\t\t\tas there are data for it. This also allows adding/removing data on the fly and besides doing it \n\t * \t\t\t\t\tprogramatically there's a built in interface for the user to do that.\n\t * \t\t\t\t\tHaving a list-structure with a repeated->field basically works the same as having a list with\n\t * \t\t\t\t\tmultiple field-structures. List-structures can mix repeated(dynamic) and static fields.\n\t * \t\t\t\t\tThe structure could look something like:\n\t * \t\t\t\t\t\t\t\tlist\n\t * \t\t\t\t\t\t\t\t\trepeated\n\t * \t\t\t\t\t\t\t\t\t\tfield\n\t * \t\t\t\t\t\t\t\t\tfield1\n\t * \t\t\t\t\t\t\t\t\tfield2\n  \t * \t\t\t\tid String this should be the key of an array in the data where each object corresponds to each\n\t * \t\t\t\t\t\t\telement in this repeated rows.\n  \t * \t\t\t\tentry Object Any entry. May be item or list for instance. The data retrieved for these will be 1\n\t * \t\t\t\t\t\t\t\tlevel deeper so the path from the base would be idOfRepeatedRows->arrayIndex->*\n\t * \t\t\t\tcreate: Bool If true then there will be a user-interface for creating and deleting entries\n\t * \t\t\t\tonCreate Function Callback fired when the user has created an entry via the interface available if\n\t * \t\t\t\t\t\"create\" is true. It is considered committed when the cell-cursor has left the repeat-row after\n\t * \t\t\t\t\thaving created it. It will normally get passed arguments: 1:new data,2:rowData,\n\t * \t\t\t\t\t3:repeatedSchemaNode,4:instanceNode\n\t * \t\t\t\t\tHowever if in the bulk-edit-area by setting \"bulkEdit\" to true then it will get passed\n\t * \t\t\t\t\t1:new data, 2:array of rowData, 3:repeatedSchemaNode,\n\t * \t\t\t\t\t4:true (to easily check for bulk-edit-row edit)\n\t * \t\t\t\tonCreateOpen Function If the entry of the repeated is group and \"create\" is set to true, then this\n\t * \t\t\t\t\tcallback-function will be called when a new group is added, i.e. when the user interacts with\n\t * \t\t\t\t\tinsertNew-cell, not when the data is actually created, that triggers \"onCreate\".\n\t * \t\t\t\t\tIt will get passed arguments: 1:instanceNode of the repeated-object\n\t * \t\t\t\tonCreateCancel Function If the entry of the repeated is group and \"create\" is set to true, then this\n\t * \t\t\t\t\tcallback-function will be called when the creation of a new entry is canceled, either by leaving\n\t * \t\t\t\t\tthe group with no data inserted, or by pressing the delete/cancel-button.\n\t * \t\t\t\t\tIt will get passed arguments: 1:instanceNode of the repeated-object\n\t * \t\t\t\tonDelete Function Callback fired when the user has deleted an entry via the interface available if\n\t * \t\t\t\t\t\"create\" is true. It will get passed arguments: 1:rowData,2:instanceNode\n\t * \t\t\t\tsortCompare Function Passing in a function allows for sorting the entries. As expected this\n\t * \t\t\t\t\tfunction will get called multiple times to compare the entries to one another.\n\t * \t\t\t\t\tIt gets 4 arguments: 1: object A, 2: object B, 3: rowData, 4: instanceNode\n\t * \t\t\t\t\tReturn >0 to sort A after B, <0 to sort B after A, or ===0 to keep original order of A and B\n\t * \t\t\t\tcreationText String Used if \"create\" is true. the text of the creation-cell. Default is \"Insert new\"\n\t * \t\t\t\t\tMay also be set via opts->lang->insertNew\n\t * \t\t\t\tdeleteText String used if \"create\" is true. the text of the deletion-button. Default is \"Delete\"\n\t * \t\t\t\t\tcan also be set via param opts->lang->delete\n\t * \t\t\t\tdeleteAreYouSureText String Used if \"create\" is true. Text above yes/no-btns.\n\t * \t\t\t\t\tDefault is \"Are you sure?\". Can also be set via param opts->lang->deleteAreYouSure\n\t * \t\t\t\tareYouSureYesText String Used if \"create\" is true. Text of confirm-button for delete.\n\t * \t\t\t\t\tDefault is \"Yes\". Can also be set via param opts->lang->deleteAreYouSureYes\n\t * \t\t\t\tareYouSureNoText String Used if \"create\" is true. Text of cancel-button for delete. Default is \"No\"\n\t * \t\t\t\t\tCan also be set via param opts->lang->deleteAreYouSureNo\n\t * \t\t\t\tbulkEdit Bool If set to true then this will appear in the bulk-edit-area which allows editing\n\t * \t\t\t\t\trepeated data for multiple data-rows at once. Applying the data does not append the data but it\n\t * \t\t\t\t\treplaces it meaning the repeated rows already present in the selected rows are removed.\n  \t * \t\t\t}\n  \t * \t\t\t{\n  \t * \t\t\t\ttype \"group\" Used when a set of data should be grouped. An example is when having an address and\n\t * \t\t\t\t\tall the rows in it belongs together. The group also has to be entered/opened with enter/dblclick\n  \t * \t\t\t\ttitle String String displayed title if placed in a container which displays the title\n\t * \t\t\t\tcssClass String Css-classes to be added to the group\n  \t * \t\t\t\tentries Array Array of entries. fields, lists, etc.. \n\t * \t\t\t\tclosedRender Function pass a method here that will get the data for the group as first arg.\n\t * \t\t\t\t\t\t\t\tit needs to return a string which will replace the group-content when it is closed\n\t * \t\t\t\tcreationValidation Function If this group is placed within a repeated-container with create set to\n\t * \t\t\t\t\t\t\t\ttrue then this function will be executed upon commiting the creation. If the\n\t * \t\t\t\t\t\t\t\tfunction returns true then the validation succeeded and the group will be created.\n\t * \t\t\t\t\t\t\t\tIt will get passed the following arguments:\n\t * \t\t\t\t\t\t\t\t1: message-function - A function that that takes a message-string as its first\n\t * \t\t\t\t\t\t\t\t\targument. If it the validation didn't go through then this string will be\n\t * \t\t\t\t\t\t\t\t\tdisplayed to the user.\n\t * \t\t\t\t\t\t\t\t2:schemaNode, 3:rowData(all the entered data of the group), 4:mainIndex, \n\t * \t\t\t\t\t\t\t\t5:instanceNode\n\t * \t\t\t\tbulkEdit Bool Besides setting bulkEdit on input of fields it can also be set on containers which\n\t * \t\t\t\t\t\t\twill add the container to the bulk-edit-area. Any input-fields in the container that\n\t * \t\t\t\t\t\t\thave bulkEdit true will appear in the container there. Remember that both the container\n\t * \t\t\t\t\t\t\tand input of fields have to have true bulkEdit for this to work. These can also be\n\t * \t\t\t\t\t\t\tnested so if there's another group in the group where both have true bulkEdit and the\n\t * \t\t\t\t\t\t\tinner group has inputs with true bulkEdit as well then multi-level groups will be \n\t * \t\t\t\t\t\t\tadded to the bulk-edit-area. Containers in the bulk-edit-area appear as a normal cell\n\t * \t\t\t\t\t\t\tat first but by entering it a page dedicated to that container is changed to.\n\t * \t\t\t\tonOpen Function Function that fires when the group is opened, before it has been rendered.\n\t * \t\t\t\t\tGets passed the following arguments:\n\t * \t\t\t\t\t1: tablanceEvent-object. It has a preventDefault-function that can be called in order to\n\t * \t\t\t\t\tprevent the group from actually opening. 2: group-object\n\t * \t\t\t\tonOpenAfter Function Function that fires when the group is opened, but after it has been rendered.\n\t * \t\t\t\t\tGets passed the following arguments:\n\t * \t\t\t\t\t1: group-object\n\t * \t\t\t\tonClose Function Callback that is fired when the group closes. Gets passed the following arguments:\n\t * \t\t\t\t\t1: group-object\n  \t * \t\t\t}\n\t * \t\t\t{\n\t * \t\t\t\ttype \"context\" Used when a set of entries should be evaluated within the scope of a nested object\n\t * \t\t\t\t\ton the current record. It does not render any visible content of its own, but changes\n\t * \t\t\t\t\tthe data context for its child entries. This is useful when the data is stored as a single\n\t * \t\t\t\t\tobject rather than an array, for example when a client record has a single homeAddress\n\t * \t\t\t\t\tobject instead of an array of addresses.\n\t * \t\t\t\tid String The property name of the nested object to use as the new context.\n\t * \t\t\t\tentry Object Any entry. May be field or list for instance or even further context or group entries\n\t * \t\t\t\tNotes:\n\t * \t\t\t\t\t- The context entry itself produces no DOM elements; it simply delegates rendering to its\n\t * \t\t\t\t\t  child entries with a modified data scope.\n\t * \t\t\t\t\t- Context entries can be nested multiple levels deep to traverse complex object structures.\n\t * \t\t\t\t\t- Unlike \"group\" or \"list\", context entries cannot be directly opened or closed by the user\n\t * \t\t\t\t\t  and have no visual representation on their own.\n\t * \n\t * \t\t\t\tExample:\n\t * \t\t\t\t{\n\t * \t\t\t\t\ttype: \"context\",\n\t * \t\t\t\t\tid: \"homeAddress\",\n\t * \t\t\t\t\tentry: {\n\t * \t\t\t\t\t\ttype:\"group\",\n\t * \t\t\t\t\t\tentries:[\n\t * \t\t\t\t\t\t\t{ title: \"Street\", id: \"street\", editable: \"text\" },\n\t * \t\t\t\t\t\t\t{ title: \"City\", id: \"city\", editable: \"text\" }\n\t * \t\t\t\t\t\t]\n\t * \t\t\t\t\t}\n\t * \t\t\t\t}\n\t * \t\t\t}\n\t * \t@param\t{Object} opts An object where different options may be set. The following options/keys are valid:\n\t * \t\t\t\t\t\t\tsearchbar Bool that defaults to true. If true then there will be a searchbar that\n\t * \t\t\t\t\t\t\t\tcan be used to filter the data.\n\t * \t\t\t\t\t\t\tsortAscHtml String - html to be added to the end of the th-element when the column\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tis sorted in ascending order\n\t * \t\t\t\t\t\t\tsortDescHtml String - html to be added to the end of the th-element when the column\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tis sorted in descending order\n\t * \t\t\t\t\t\t\tsortNoneHtml String - html to be added to the end of the th-element when the column\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tis not sorted\n\t * \t\t\t\t\t\t\tdefaultMinOptsFilter Integer The minimum number of options required for the\n\t * \t\t\t\t\t\t\t\tfilter-input of input-type \"select\" to appear\n\t * \t\t\t\t\t\t\tdefaultFileMetasToShow Object Default meta-data for files to show.\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tSee prop fileMetasToShow in param details\n\t * \t\t\t\t\t\t\tlang Object {  Object to replace language-specific text. The strings may be html-code\n\t * \t\t\t\t\t\t\t\t\t\texcept for ones used as placeholders. Below are the keys and defaults.\n\t * \t\t\t\t\t\t\t\tfileName \"Filename\"\n\t * \t\t\t\t\t\t\t\tfileLastModified \"Last Modified\"\n\t * \t\t\t\t\t\t\t\tfileSize \"Size\"\n\t * \t\t\t\t\t\t\t\tfileType \"Type\"\n\t * \t\t\t\t\t\t\t\tfileUploadDone \"Done!\"\n\t * \t\t\t\t\t\t\t\tfileChooseOrDrag \"<b>Press to choose a file</b> or drag it here\"\n\t * \t\t\t\t\t\t\t\tfileDropToUpload \"<b>Drop to upload</b>\"\n\t *\t\t\t\t\t\t\t\tfilterPlaceholder \"Search\"\n\t * \t\t\t\t\t\t\t\tdelete \"Delete\" (used in the deletion of repeat-items or files)\n\t * \t\t\t\t\t\t\t\tdeleteAreYouSure \"Are you sure?\" (Used in the deletion of repeat-items or files)\n\t * \t\t\t\t\t\t\t\tdeleteAreYouSureYes \"Yes\"  (Used in the deletion of repeat-items or files)\n\t * \t\t\t\t\t\t\t\tdeleteAreYouSureNo\t\"No\" (Used in the deletion of repeat-items)\n\t * \t\t\t\t\t\t\t\tdatePlaceholder \"YYYY-MM-DD\"\n\t * \t\t\t\t\t\t\t\tselectNoResultsFound \"No results found\"\n\t * \t\t\t\t\t\t\t\tinsertNew \"Insert New\" (Used in repeat-schemaNode if create is set to true)\n\t * \t\t\t\t\t\t\t}\n\t * */\n\tconstructor(hostEl,schema,staticRowHeight=false,spreadsheet=false,opts=null){\n\t\tthis.hostEl=hostEl;\n\t\tconst rootEl=this.rootEl = document.createElement(\"div\");\n\t\tthis.hostEl.appendChild(this.rootEl);\n\t\tthis._spreadsheet=spreadsheet;\n\t\tthis._staticRowHeight=staticRowHeight;\n\t\tthis._opts=opts??{};\n\t\trootEl.classList.add(\"tablance\");\n\t\tthis.schema=this._cloneSchema(schema);\n\t\t//const allowedColProps=[\"id\",\"title\",\"width\",\"input\",\"type\",\"render\",\"html\"];//should we really do filtering?\n\t\tif (!schema.main?.columns) {\n\t\t\tthis._setupSpreadsheet(true);\n\t\t\tthis._onlyDetails=true;\n\t\t} else {\n\t\t\tfor (let col of this.schema.main.columns) {\n\t\t\t\tlet processedCol={};\n\t\t\t\tif ((col.type==\"expand\"||col.type==\"select\")&&!col.width)\n\t\t\t\t\tprocessedCol.width=50;\n\t\t\t\tfor (let [colKey,colVal] of Object.entries(col))\n\t\t\t\t\t//if (allowedColProps.includes(colKey))\n\t\t\t\t\t\tprocessedCol[colKey]=colVal;\n\t\t\t\tthis._colSchemaNodes.push(processedCol);\n\t\t\t}\n\t\t\tif (opts?.searchbar!=false)\n\t\t\t\tthis._setupSearchbar();\n\t\t\tthis._createTableHeader();\n\t\t\tthis._createTableBody();\n\t\t\t(new ResizeObserver(this._updateSizesOfViewportAndCols.bind(this))).observe(hostEl);\n\t\t\tthis._setupSpreadsheet(false);\n\t\t\tthis._updateSizesOfViewportAndCols();\n\t\t\tif (opts?.sortAscHtml==null)\n\t\t\t\topts.sortAscHtml='<svg viewBox=\"0 0 8 10\" style=\"height:1em\"><polygon style=\"fill:#ccc\" '\n\t\t\t\t\t\t\t\t\t+'points=\"4,0,8,4,0,4\"/><polygon style=\"fill:#000\" points=\"4,10,0,6,8,6\"/></svg>';\n\t\t\tif (opts?.sortDescHtml==null)\n\t\t\t\topts.sortDescHtml='<svg viewBox=\"0 0 8 10\" style=\"height:1em\"><polygon style=\"fill:#000\" '\n\t\t\t\t\t\t\t\t\t+'points=\"4,0,8,4,0,4\"/><polygon style=\"fill:#ccc\" points=\"4,10,0,6,8,6\"/></svg>';\n\t\t\tif (opts?.sortNoneHtml==null)\n\t\t\t\topts.sortNoneHtml='<svg viewBox=\"0 0 8 10\" style=\"height:1em\"><polygon style=\"fill:#ccc\" '\n\t\t\t\t\t\t\t\t\t+'points=\"4,0,8,4,0,4\"/><polygon style=\"fill:#ccc\" points=\"4,10,0,6,8,6\"/></svg>';\n\t\t\tthis._updateHeaderSortHtml();\n\t\t\tthis._buildDependencyGraph();\n\t\t}\n\t}\n\n\taddData(data, highlight=false) {\n\t\tif (this._onlyDetails)\n\t\t\treturn this._setDataForOnlyDetails(data)\n\t\tconst oldLen=this._data.length;\n\t\tif (highlight)\n\t\t\tthis._searchInput.value=this._filter=\"\";//remove any filter\n\t\tthis._data=this._allData=this._allData.concat(data);\n\t\t//this._data.push(...data);//much faster than above but causes \"Maximum call stack size exceeded\" for large data\n\t\tlet sortingOccured=this._sortData();\n\t\tif (this._filter)\n\t\t\tthis._filterData(this._filter);\n\t\telse {\n\t\t\tif (sortingOccured)\n\t\t\t\tthis._refreshTable();\n\t\t\telse\n\t\t\t\tthis._maybeAddTrs();\n\t\t\tconst numNewInData=this._data.length-oldLen;\n\t\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height||0)+numNewInData*this._rowHeight+\"px\";\n\t\t}\n\t\tif (highlight) {\n\t\t\tfor (let dataRow of data)\n\t\t\t\tthis._highlightRowIndex(this._data.indexOf(dataRow));\n\t\t\tthis.scrollToDataRow(data[0],false);//false for not highlighting, above line does the highlight anyway\n\t\t}\n\t}\n\n\t/**Change or add any data in the table\n\t * @param {int|object} dataRow_or_mainIndex Either the actual data-object that should be updated, or its index in\n\t * \t\t\t\t\t\t\t\t\t\t\tthe current view\n\t * @param {string|string[]} dataPath The path to the data-value that should be updated or added to. For a value in\n\t * \t\t\tthe base which is not nested within repeated-containers it should simply be the id of the property.\n\t * \t\t\tIt can either be a string of keys separated by dots(.) or an array where each element is a key.\n\t * \t\t\tFor repeated-arrays which data should be added to, \"[]\" can be used similiar to how it's done in PHP.\n\t * \t\t\tFor instance the path could be \"foo[]\" or \"foo[].bar\". Objects/arrays will be created recursively\n\t * \t\t\tif they don't yet exist.\n\t * @param {*} newData The actual data to be replaced with or added\n\t * @param {bool} scrollTo Whether the modified/added data should be scrolled to and highlighted.\n\t * @param {bool} onlyRefresh If true then no new data will be written and argument \"data\" will be ignored.\n\t * \t\t\t\t\t\t\tThe cell will only be refreshed with the value already present in the data.\n\t * @returns The tablance-object, for chaining*/\n\tupdateData(dataRow_or_mainIndex,dataPath,newData,scrollTo=false,onlyRefresh=false) {\n\t\tlet dataRow;//simply an element from #data, e.g. a whole dataset for a row of the maintable.\n\t\tlet mainIndx;//the index of dataRow\n\t\tlet updatedEls=[];\n\t\tif (!isNaN(dataRow_or_mainIndex))\n\t\t\tdataRow=this._data[mainIndx=dataRow_or_mainIndex];\n\t\telse //if (typeof dataRow_or_mainIndex==\"object\")\n\t\t\tmainIndx=this._data.indexOf(dataRow=dataRow_or_mainIndex);\n\t\tdataPath=typeof dataPath==\"string\"?dataPath.split(/\\.|(?=\\[\\d*\\])/):dataPath;\n\n\t\tif (!onlyRefresh) {//if we're not only refreshing the cell but actually modifying/adding data\n\t\t\t//update the actual data, deal with the dom later\n\t\t\tlet dataPortion=dataRow;//object that is going to have a property updated, or array that will be pushed to\n\t\t\tfor (let i=0; i<dataPath.length; i++) {\n\t\t\t\tconst key=i%2?dataPath[i].replace(/^\\[|\\]$/g,\"\"):dataPath[i];//get rid of brackets. \n\t\t\t\t//key is now either property-name, string-int for index, or empty string for pushing\n\t\t\t\tif (i==dataPath.length-1)//if last step\n\t\t\t\t\tdataPortion[key||dataPortion.length]=newData;//assign the data\n\t\t\t\telse if (!key)//not last step and empty string, meaning push\n\t\t\t\t\tdataPortion=dataPortion[dataPortion.length]={};//do push\n\t\t\t\telse//not last step and key is index or property-name\n\t\t\t\t\tdataPortion=dataPortion[key]??(dataPortion[key]=i%2?[]:{});\n\t\t\t}\n\t\t}\n\n\t\tif (mainIndx<this._scrollRowIndex||mainIndx>=this._scrollRowIndex+this._numRenderedRows)\n\t\t\treturn;//the row to be updated is outside of view. It'll be updated automatically if scrolled into view\n\t\t\n\t\t//is it a column of the main-table?\n\t\tif (dataPath.length==1) //it's possible only if the path is a single id-key. (but still not guaranteed)\n\t\t\tfor (let colI=-1,colSchemaNode;colSchemaNode=this._colSchemaNodes[++colI];)\n\t\t\t\tif (colSchemaNode.id==dataPath[0]) {//if true then yes, it was a column of main-table\n\t\t\t\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${mainIndx}\"]:not(.details)`);\n\t\t\t\t\treturn this._updateMainRowCell(tr.cells[colI],colSchemaNode);//update it and be done with this\n\t\t\t\t}\n\n\t\t//The data is somewhere in details\n\t\t\n\t\tlet nodeToUpdate=this._openDetailsPanes[mainIndx];//points to the instance-node that will be subject for update\n\t\tif (!nodeToUpdate)//if the updates details is not open\n\t\t\treturn;\n\n\t\t//look through the celObjToUpdate and its descendants-tree (currently set to whole details), following the\n\t\t//dataPath. At the end of this loop celObjToUpdate should be set to the deepest down object that dataPath points\n\t\t//to, and pathIndex should be the index in dataPath that is the last step pointing to celObjToUpdate.\n\t\t//When simply editing an already existing field then celObjToUpdate would be the container of that cell, and\n\t\t//pathIndex would be set to the index of the last element in dataPath\n\t\tfor (let i=0,instanceNodeId; instanceNodeId=dataPath[i]; i+=2) {\n\t\t\tconst arrayIndex=dataPath[i+1]?.replace(/^\\[|\\]$/g,\"\");\n\t\t\tnodeToUpdate=this._findDescendantInstanceNodeById(nodeToUpdate,instanceNodeId);\n\t\t\tif (nodeToUpdate.schemaNode.type==\"repeated\") {//should be true until possibly last iteration\n\t\t\t\tif (i==dataPath.length-1) {//final array-index not specified. replace all of the data in repeated\n\n\t\t\t\t\t//remove all the current entries. Do it backwards so that the remaining entries doesn't have to\n\t\t\t\t\t//have their index&path updates each time\n\t\t\t\t\tconst children=nodeToUpdate.children;\n\t\t\t\t\tfor (let entryI=children.length-!!nodeToUpdate.schemaNode.create,entry; entry=children[--entryI];)\n\t\t\t\t\t\tthis._deleteCell(entry,true);\n\n\t\t\t\t\t//insert all the new data\n\t\t\t\t\tnodeToUpdate.dataObj=nodeToUpdate.parent.dataObj[nodeToUpdate.schemaNode.id];\n\t\t\t\t\tnodeToUpdate.dataObj.forEach(\n\t\t\t\t\t\t\t\t\tdataEntry=>updatedEls.push(this._repeatInsert(nodeToUpdate,false,dataEntry)));\n\t\t\t\t\tbreak;\n\t\t\t\t} else if (arrayIndex) {//index pointing at existing repeated-child\n\t\t\t\t\tnodeToUpdate=nodeToUpdate.children[arrayIndex];\n\t\t\t\t} else {//[] - insert new\n\t\t\t\t\tupdatedEls.push(this._repeatInsert(nodeToUpdate,false,nodeToUpdate.dataObj.at(-1)));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (nodeToUpdate.schemaNode.type==\"field\")\n\t\t\tthis._updateDetailsCell(nodeToUpdate,dataRow);\n\t\tif (scrollTo) {\n\t\t\tnodeToUpdate.el.scrollIntoView({behavior:'smooth',block:\"center\"});\n\t\t\tupdatedEls.forEach(el=>this._highlightElements([el,...el.getElementsByTagName('*')]));\n\t\t}\n\t\tthis._adjustCursorPosSize(this._selectedCell,true);\n\t}\n\n\t/**\n\t * Clone a schema tree safely.\n\t *\n\t * Rules:\n\t * - Recurse ONLY into plain objects (POJOs) and arrays.\n\t * - Only objects inside `entry` / `entries` of a schema-node are schema-nodes.\n\t * - Schema-nodes get `.parent`; config objects never do.\n\t * - Functions, DOM nodes and non-POJO objects (Date, Map, class instances, etc.)\n\t *   are preserved by reference.\n\t *\n\t * @param {*} schema     The value to clone.\n\t * @returns {*}          The cloned value.\n\t */\n\t_cloneSchema(schema) {\n\t\t//\"normally\" when determining if an object is a a schema-node we check if it is pointed to either by entry or\n\t\t//entries of a schema-node. E.g. if an object is not a schema-node then any items of entry or entries wont\n\t\t//be schema-nodes either. However the root schema, main and details are schema-nodes as well and this is what's\n\t\t//stated by including them in pathNodes here. filter(Boolean) removes any undefined/null roots/columns.\n\t\tconst nodeSeeds=new Set([schema,schema.main,schema.details,...(schema.main?.columns??[])].filter(Boolean));\n\t\t\n\t\treturn cloneRec(schema, null, true);\n\n\t\tfunction cloneRec(obj, parent, isNode) {\n\t\t\tif (!obj || typeof obj!=\"object\")\n\t\t\t\treturn obj\n\n\t\t\tif (typeof Node!=\"undefined\" && obj instanceof Node)\n\t\t\t\treturn obj\n\n\t\t\tconst proto = Object.getPrototypeOf(obj)\n\t\t\tconst isPojo = proto===Object.prototype || proto===null\n\n\t\t\tif (!isPojo && !Array.isArray(obj))\n\t\t\t\treturn obj\n\t\t\tisNode||=nodeSeeds.has(obj);\n\n\t\t\tif (Array.isArray(obj)) { // preserve Array prototype; children keep the same parent ref\n\t\t\t\tconst arr=[]\n\t\t\t\tfor (const item of obj)\n\t\t\t\t\tarr.push(cloneRec(item, parent, false))\n\t\t\t\treturn arr\n\t\t\t}\n\n\t\t\tconst clone = Object.create(null)\n\t\t\tif (parent&&isNode)\n\t\t\t\tclone.parent = parent\n\n\t\t\tfor (const [key, val] of Object.entries(obj)) {\n\n\t\t\t\tif (typeof val==\"function\" || key==\"meta\") {\n\t\t\t\t\tclone[key]=val\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\n\t\t\t\tif (!isNode && key==\"parent\")\n\t\t\t\t\tcontinue\n\n\t\t\t\t// entry/entries → always schema-nodes if parent is node\n\t\t\t\tif (isNode && key==\"entries\" && Array.isArray(val)) {\n\t\t\t\t\tconst arr=[]\n\t\t\t\t\tfor (const child of val)\n\t\t\t\t\t\tarr.push(cloneRec(child, clone, true))\n\t\t\t\t\tclone[key]=arr\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\n\t\t\t\tif (isNode && key==\"entry\" && val && typeof val==\"object\") {\n\t\t\t\t\tclone[key]=cloneRec(val, clone, true)\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\n\t\t\t\t// config objects → non-schema OR schema-nodes defined by pathNodes\n\t\t\t\tif (val && typeof val==\"object\") {\n\t\t\t\t\t\n\t\t\t\t\t// Objects inside arrays inherit the same parent.\n\t\t\t\t\t// Objects inside non-arrays inherit this object as parent (if they become nodes).\n\t\t\t\t\tclone[key] = cloneRec(val, Array.isArray(obj)?parent:clone, false);\n\t\t\t\t\tcontinue\n\t\t\t\t}\n\n\t\t\t\tclone[key]=val\n\t\t\t}\n\n\t\t\treturn clone\n\t\t}\n\t}\n\n\n\t/**\n\t * Searches upward through schema-node parents to find a meta value.\n\t * @param {*} startNode  The schema-node where the search begins.\n\t * @param {string} metaKey  The meta key to look for.\n\t * @returns {*} The found value or undefined.\n\t */\n\t_closestMeta(startNode, metaKey) {\n\t\tfor (let node=startNode; node; node=node.parent)\n\t\t\tif (node.meta && metaKey in node.meta)\n\t\t\t\treturn node.meta[metaKey];\n\t}\n\n\t_findDescendantInstanceNodeById(searchInObj,idToFind) {\n\t\tfor (const child of searchInObj.children)\n\t\t\tif (child.schemaNode.id==idToFind)//if true then its the repeated-obj we're looking for\n\t\t\t\treturn child;\n\t\t\telse if (child.children) {//if container-obj\n\t\t\t\tconst result=this._findDescendantInstanceNodeById(child,idToFind);\n\t\t\t\tif (result)\n\t\t\t\t\treturn result;\n\t\t\t}\n\t}\n\n\t/**Expands a row and returns the details instance-tree root.\n\t * @param int mainIndex\n\t * @returns Object Root instance-node (outer-most instanceNode)*/\n\texpandRow(mainIndex) {\n\t\tif (this._onlyDetails)\n\t\t\treturn this._openDetailsPanes[0];\n\t\tlet tr=this._mainTbody.querySelector(`[data-data-row-index=\"${mainIndex}\"]`);\n\t\tif (!tr) {\n\t\t\tthis.scrollToDataRow(this._data[mainIndex],false,false);\n\t\t\tthis._scrollMethod();//needed to get everythig to render before having to wait for next frame\n\t\t\ttr=this._mainTbody.querySelector(`[data-data-row-index=\"${mainIndex}\"]`);\n\t\t}\n\t\tthis._expandRow(tr);\n\t\treturn this._openDetailsPanes[mainIndex];\n\t}\n\n\tscrollToDataRow(dataRow,highlight=true,smooth=true) {\n\t\tlet scrollY=0;\n\t\tfor (let i=-1,otherDataRow;otherDataRow=this._data[++i];) {\n\t\t\tif (otherDataRow==dataRow) {\n\t\t\t\tscrollY=scrollY-this._scrollBody.offsetHeight/2+this._rowHeight;\n\t\t\t\tthis._scrollBody.scrollTo({top:scrollY,behavior:smooth?\"smooth\":\"auto\"});\n\t\t\t\tif (highlight)\n\t\t\t\t\tthis._highlightRowIndex(i);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tscrollY+=this._rowMetaGet(i)?.h??this._rowHeight;\n\t\t}\n\t}\n\n\t/**Use this method to set neighbourTables automatically by just supplying all the other tables. It will figure out\n\t * in which order they appear in the html and set neighbourTables accordingly.\n\t * @param  {...Tablance} otherTablances */\n\tchainTables(...otherTablances) {\n\t\tconst tablances=[this,...otherTablances];\n\t\ttablances.sort(sort);\n\t\tfor (let i=-1,tablance;tablance=tablances[++i];)\n\t\t\ttablance.neighbourTables={up:tablances[i-1],down:tablances[i+1]};\n\t\tfunction sort(a,b) {\n\t\t\tlet elA=a.container, elB=b.container;\n\t\t\t//set elA to its (grand)parent which is the closest element where the parent also holds elB in its hiearchy\n\t\t\tfor (;!elA.parentElement.contains(elB);elA=elA.parentElement);\n\t\t\tconst commonCont=elA.parentElement;//the closest element that holds both elA and elB\n\t\t\t//set elB to the closest element that is a direct child of commonCont\n\t\t\tfor (;elA.parentElement!=elB.parentElement;elB=elB.parentElement);\n\t\t\treturn Array.from(commonCont.children).indexOf(elA)>Array.from(commonCont.children).indexOf(elB)?1:-1;\n\t\t}\n\t}\n\n\tselectTopBottomCellOnlyDetails(top) {\n\t\tthis._highlightOnFocus=false;\n\t\tthis._selectFirstSelectableDetailsCell(this._openDetailsPanes[0],top);\n\t}\n\n\t/**\n\t * Build a complete dependency graph and assign internal autoIds.\n\t *\n\t * This walks the column + details schemaNode tree and enriches each node with\n\t * the metadata needed for dependency resolution and runtime lookups.\n\t *\n\t * Permanent runtime metadata produced:\n\t *  - schemaNode.dependencyPaths: UI-forward paths (dependee → dependent)\n\t *  - schemaNode.dependsOnCellPaths: reverse structural path(s) (exp→exp)\n\t *  - schemaNode.dependsOnDataPath: absolute data path for non-exp→exp deps\n\t *\n\t * Temporary builder-only metadata (removed in Pass 4):\n\t *  - schemaNode._autoId\n\t *  - schemaNode._path\n\t *  - schemaNode._dataContextPath\n\t *  - schemaNode._dataPath\n\t *  - ctx.explicitIdToAutoId, ctx.implicitIdToAutoId, ctx.schemaNodeByAutoId, ctx.autoIdByName, etc.\n\t */\n\t_buildDependencyGraph() {\n\n\t\t//---- PASS 1 — Assign autoIds + collect ID maps ----\n\t\tconst ctx = this._pass1_assignAutoIdsAndMaps();\n\n\t\t//---- PASS 2 — Compute UI path & data paths ----\n\t\tfor (let i = 0; i < this.schema.details.entries.length; i++)// Details roots\n\t\t\tthis._assignPathsAndData(this.schema.details.entries[i], [i], []);\n\t\tfor (let i = 0; i < this._colSchemaNodes.length; i++)// Main columns\n\t\t\tthis._assignPathsAndData(this._colSchemaNodes[i], [\"m\", i], []);\n\n\t\t//---- PASS 3 — Resolve dependsOn and build dependency metadata ----\n\t\tthis._pass3_resolveDependencies(ctx);\n\n\t\t//---- PASS 4 — Cleanup: remove all temporary builder-only metadata ----\n\t\tlet stack = [...ctx.initialRoots];\n\t\tfor (let schemaNode; schemaNode = stack.pop();) {\n\t\t\tdelete schemaNode._autoId;\n\t\t\tdelete schemaNode._path;\n\t\t\tdelete schemaNode._dataContextPath;\n\t\t\tdelete schemaNode._dataPath;\n\t\t\tstack.push(...this._schemaChildren(schemaNode));\n\t\t}\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tPASS 1 — Assign autoIds + collect ID maps\n\t───────────────────────────────────────────────────────────*/\n\t_pass1_assignAutoIdsAndMaps() {\n\t\tconst ctx = Object.create(null);\n\t\tctx.autoIdCounter       = 0;\n\t\tctx.explicitIdToAutoId  = Object.create(null);\n\t\tctx.implicitIdToAutoId  = Object.create(null);\n\t\tctx.schemaNodeByAutoId      = Object.create(null);\n\t\tctx.seenCellIds         = Object.create(null);\n\n\t\tctx.initialRoots = [...this._colSchemaNodes, ...this.schema.details.entries];\n\n\t\tlet stack = [...ctx.initialRoots];\n\n\t\tfor (let schemaNode; schemaNode = stack.pop();) {\n\n\t\t\tconst autoId = ++ctx.autoIdCounter;\n\t\t\tschemaNode._autoId = autoId;\n\t\t\tctx.schemaNodeByAutoId[autoId] = schemaNode;\n\n\t\t\tif (schemaNode.cellId != null) {\n\n\t\t\t\tif (ctx.seenCellIds[schemaNode.cellId])\n\t\t\t\t\tthrow new Error(`Duplicate cellId \"${schemaNode.cellId}\".`);\n\n\t\t\t\tctx.seenCellIds[schemaNode.cellId] = true;\n\t\t\t\tctx.explicitIdToAutoId[schemaNode.cellId] = autoId;\n\t\t\t} else if (schemaNode.id != null)\n\t\t\t\tctx.implicitIdToAutoId[schemaNode.id] = autoId;\n\n\t\t\tstack.push(...this._schemaChildren(schemaNode));\n\t\t}\n\n\t\t// Id/cellId → autoId lookup\n\t\tctx.autoIdByName = Object.assign(Object.create(null), ctx.implicitIdToAutoId, ctx.explicitIdToAutoId);\n\n\t\treturn ctx;\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tPASS 3 — Resolve dependsOn and build dependency metadata\n\t───────────────────────────────────────────────────────────*/\n\t_pass3_resolveDependencies(ctx) {\n\t\tlet stack = [...ctx.initialRoots];\n\n\t\tfor (let schemaNode; schemaNode = stack.pop();) {\n\n\t\t\tif (schemaNode.dependsOn) {\n\t\t\t\tconst deps = Array.isArray(schemaNode.dependsOn) ? schemaNode.dependsOn : [schemaNode.dependsOn];\n\n\t\t\t\tconst dependentIsExp = schemaNode._path[0] !== \"m\";\n\t\t\t\tconst cellPaths = [];\n\t\t\t\tconst dataPaths = [];\n\n\t\t\t\tfor (const depName of deps) {\n\n\t\t\t\t\tconst depAutoId = ctx.autoIdByName[depName];\n\n\t\t\t\t\tif (depAutoId == null) {\n\t\t\t\t\t\tconsole.warn(`Unknown dependsOn \"${depName}\".`, schemaNode);\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst dependee = ctx.schemaNodeByAutoId[depAutoId];\n\t\t\t\t\tconst dependeeIsExp = dependee._path[0] !== \"m\";\n\n\t\t\t\t\t// UI-forward dependency path\n\t\t\t\t\tconst fwd = this._computeDependencyPath(dependee, schemaNode);\n\n\t\t\t\t\tif (fwd)\n\t\t\t\t\t\t(dependee.dependencyPaths ??= []).push(fwd);\n\n\t\t\t\t\t// classify dependency type\n\t\t\t\t\tif (dependentIsExp && dependeeIsExp) {\n\t\t\t\t\t\tconst rev = this._computeReversePath(schemaNode, dependee);\n\t\t\t\t\t\tif (rev && rev.length)\n\t\t\t\t\t\t\tcellPaths.push(rev);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (dependee._dataPath)\n\t\t\t\t\t\t\tdataPaths.push(dependee._dataPath);\n\t\t\t\t\t\telse if (dependee.id != null || dependee.cellId != null)\n\t\t\t\t\t\t\tconsole.warn(\"Dependee has no dataPath:\", dependee);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis._finalizeDependency(schemaNode, cellPaths, dataPaths);\n\t\t\t}\n\n\t\t\tstack.push(...this._schemaChildren(schemaNode));\n\t\t}\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Normalize schemaNode children\n\t───────────────────────────────────────────────────────────*/\n\t_schemaChildren(schemaNode) {\n\t\twhile (schemaNode.entry)\n\t\t\tschemaNode = schemaNode.entry;\n\t\tif (Array.isArray(schemaNode.entries))\n\t\t\treturn schemaNode.entries;\n\t\treturn [];\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Assign _path, _dataContextPath, and _dataPath\n\t───────────────────────────────────────────────────────────*/\n\t_assignPathsAndData(schemaNode, uiPath, parentCtx = []) {\n\t\tschemaNode._path = uiPath;\n\n\t\tconst hasCtx = typeof schemaNode.context === \"string\" && schemaNode.context.length;\n\t\tconst myCtx = hasCtx ? [...parentCtx, schemaNode.context] : parentCtx;\n\n\t\tschemaNode._dataContextPath = myCtx;\n\n\t\tif (schemaNode.id != null)\n\t\t\tschemaNode._dataPath = [...myCtx, String(schemaNode.id)];\n\n\t\tconst kids = this._schemaChildren(schemaNode);\n\n\t\tfor (let i = 0; i < kids.length; i++)\n\t\t\tthis._assignPathsAndData(kids[i], [...uiPath, i], myCtx);\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Compute UI-forward dependency path\n\t───────────────────────────────────────────────────────────*/\n\t_computeDependencyPath(dependee, dependent) {\n\t\tconst from = dependee._path;\n\t\tconst to   = dependent._path;\n\n\t\tif (!from || !to)\n\t\t\treturn null;\n\n\t\t// main → main\n\t\tif (from[0] === \"m\" && to[0] === \"m\")\n\t\t\treturn [\"m\", to[1]];\n\n\t\t// details → main\n\t\tif (from[0] !== \"m\" && to[0] === \"m\")\n\t\t\treturn [\"m\", to[1]];\n\n\t\t// main → details\n\t\tif (from[0] === \"m\" && to[0] !== \"m\")\n\t\t\treturn [\"e\", ...to];\n\n\t\t// details → details\n\t\tlet common = 0;\n\n\t\twhile (common < from.length && common < to.length && from[common] === to[common])\n\t\t\tcommon++;\n\n\t\tconst up   = Array(from.length - common).fill(\"..\");\n\t\tconst down = to.slice(common);\n\n\t\treturn [\"r\", ...up, ...down];\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Compute reverse dependency path (exp→exp)\n\t───────────────────────────────────────────────────────────*/\n\t_computeReversePath(from, to) {\n\t\tif (from._path[0] === \"m\" || to._path[0] === \"m\")\n\t\t\treturn null;\n\n\t\tconst a = from._path;\n\t\tconst b = to._path;\n\n\t\tlet common = 0;\n\n\t\twhile (common < a.length && common < b.length && a[common] === b[common])\n\t\t\tcommon++;\n\n\t\tconst up   = Array(a.length - common).fill(\"..\");\n\t\tconst down = b.slice(common);\n\n\t\treturn [...up, ...down];\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Finalize dependency classification (exclusive)\n\t───────────────────────────────────────────────────────────*/\n\t_finalizeDependency(schemaNode, cellPaths, dataPaths) {\n\n\t\tif (cellPaths.length) {\n\t\t\tschemaNode.dependsOnCellPaths = cellPaths;\n\t\t\tdelete schemaNode.dependsOnDataPath;\n\t\t\treturn;\n\t\t}\n\n\t\tif (dataPaths.length === 1) {\n\t\t\tschemaNode.dependsOnDataPath = dataPaths[0];\n\t\t\tdelete schemaNode.dependsOnCellPaths;\n\n\t\t\tif (!schemaNode._dataPath)\n\t\t\t\tschemaNode._dataPath = dataPaths[0];\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (dataPaths.length > 1) {\n\t\t\tconsole.warn(\"Multiple data dependencies not supported:\", schemaNode);\n\n\t\t\tschemaNode.dependsOnDataPath = dataPaths[0];\n\t\t\tdelete schemaNode.dependsOnCellPaths;\n\n\t\t\tif (!schemaNode._dataPath)\n\t\t\t\tschemaNode._dataPath = dataPaths[0];\n\t\t}\n\t}\n\n\n\n\n\n\t_updateViewportHeight = () => {\n\t\tthis._scrollBody.style.height = this.hostEl.clientHeight - this._headerTable.offsetHeight\n\t\t- (this._searchInput?.offsetHeight ?? 0) - this._bulkEditArea.offsetHeight + \"px\";\n\t}\n\n\t_attachInputFormatter(el, format) {\n\t\tformat = this._normalizeInputFormat(format);\n\t\n\t\t// Numeric filtering\n\t\tif (format.numericOnly) {\n\t\t\tel.addEventListener(\"beforeinput\", e => {\n\t\t\t\tif (e.data && /\\D/.test(e.data))\n\t\t\t\t\te.preventDefault();\n\t\t\t});\n\t\t\tel.setAttribute(\"inputmode\", \"numeric\");\n\t\t}\n\t\n\t\t// Backspace over delimiter\n\t\tel.addEventListener(\"keydown\", e => {\n\t\t\tif (e.key !== \"Backspace\" || !format.delimiter)\n\t\t\t\treturn;\n\t\n\t\t\tconst pos = el.selectionStart;\n\t\t\tif (pos > 0 && el.value[pos - 1] === format.delimiter) {\n\t\t\t\te.preventDefault();\n\t\t\t\tel.value = el.value.slice(0, pos - 2) + el.value.slice(pos);\n\t\t\t\tel.setSelectionRange(pos - 2, pos - 2);\n\t\t\t\tel.dispatchEvent(new Event(\"input\"));\n\t\t\t}\n\t\t});\n\t\n\t\t// Main formatting\n\t\tconst apply = () => {\n\t\t\tel.value = this._applyInputFormatting(el.value, format);\n\t\t};\n\t\n\t\tel.addEventListener(\"input\", apply);\n\t\tapply();\n\t}\n\t\n\t_normalizeInputFormat(format) {\n\t\tif (!format.date)\n\t\t\treturn format;\n\t\n\t\tformat = { ...format };\n\t\n\t\tif (format.blocks === undefined)\n\t\t\tformat.blocks = [4, 2, 2];\n\t\tif (format.delimiter === undefined)\n\t\t\tformat.delimiter = \"-\";\n\t\tif (format.numericOnly === undefined)\n\t\t\tformat.numericOnly = true;\n\t\n\t\treturn format;\n\t}\n\n\t_applyInputFormatting(value, format) {\n\t\tif (format.numericOnly)\n\t\t\tvalue = value.replace(/\\D/g, \"\");\n\t\n\t\t// Date mode\n\t\tif (format.date)\n\t\t\treturn this._formatDateValue(value, format);\n\t\n\t\t// Generic block formatting\n\t\tif (Array.isArray(format.blocks)) {\n\t\t\tlet out = \"\", i = 0;\n\t\t\tconst delim = format.delimiter ?? \"\";\n\t\t\tfor (const block of format.blocks) {\n\t\t\t\tconst part = value.slice(i, i + block);\n\t\t\t\tout += part;\n\t\t\t\ti += part.length;\n\t\t\t\tif (part.length === block && delim)\n\t\t\t\t\tout += delim;\n\t\t\t}\n\t\t\treturn out;\n\t\t}\n\t\n\t\treturn value;\n\t}\n\n\t_formatDateValue(digits, format) {\n\t\t// --- clamp month ---\n\t\tif (digits.length >= 5) {\n\t\t\tconst y = digits.slice(0, 4);\n\t\t\tlet m = digits.slice(4, 6);\n\t\n\t\t\tif (m.length === 1 && +m > 1)\n\t\t\t\tm = \"0\" + m;\n\t\t\telse if (m.length === 2) {\n\t\t\t\tlet mm = Math.min(Math.max(+m, 1), 12);\n\t\t\t\tm = String(mm).padStart(2, \"0\");\n\t\t\t}\n\t\t\tdigits = y + m + digits.slice(6);\n\t\t}\n\t\n\t\t// --- clamp day ---\n\t\tif (digits.length >= 7) {\n\t\t\tconst y = +digits.slice(0, 4);\n\t\t\tconst m = +digits.slice(4, 6);\n\t\t\tlet d = digits.slice(6, 8);\n\t\n\t\t\tif (d.length === 1 && +d > 3)\n\t\t\t\td = \"0\" + d;\n\t\t\telse if (d.length === 2) {\n\t\t\t\tlet dd = +d;\n\t\t\t\tconst max = new Date(y, m, 0).getDate();\n\t\t\t\td = String(Math.min(Math.max(dd, 1), max)).padStart(2, \"0\");\n\t\t\t}\n\t\t\tdigits = digits.slice(0, 6) + d + digits.slice(8);\n\t\t}\n\t\n\t\t// --- rebuild output ---\n\t\tconst blocks = format.blocks;\n\t\tconst delim  = format.delimiter ?? \"-\";\n\t\tlet out = \"\", i = 0;\n\t\n\t\tfor (let b = 0; b < blocks.length; b++) {\n\t\t\tconst part = digits.slice(i, i + blocks[b]);\n\t\t\tout += part;\n\t\t\ti += part.length;\n\t\t\tif (part.length === blocks[b] && b < blocks.length - 1)\n\t\t\t\tout += delim;\n\t\t}\n\t\n\t\treturn out;\n\t}\n\t\n\t\n\t\n\t\t\n\t\n\t_setupSearchbar() {\n\t\tthis._searchInput=this.rootEl.appendChild(document.createElement(\"input\"));\n\t\tthis._searchInput.type=this._searchInput.className=\"search\";\n\t\tthis._searchInput.placeholder=this._opts.lang?.filterPlaceholder??\"Search\";\n\t\tthis._searchInput.addEventListener(\"input\",e=>this._onSearchInput(e));\n\t}\n\n\t_onSearchInput(_e) {\n\t\tthis._filterData(this._searchInput.value);\n\t}\n\n\t_setupSpreadsheet(onlyDetails) {\n\t\tthis.rootEl.classList.add(\"spreadsheet\");\n\t\tthis._cellCursor=document.createElement(\"div\");\n\t\tthis._cellCursor.className=\"cell-cursor\";\n\t\tthis._cellCursor.style.display=\"none\";\n\t\tif (!onlyDetails) {\n\t\t\tthis._createBulkEditArea();\n\t\t\t//remove any border-spacing beacuse if spacing is clicked the target-element will be the table itself and\n\t\t\t//no cell will be selected which is bad user experience. Set it to 0 for headerTable too in order to match\n\t\t\tthis._mainTable.style.borderSpacing=this._headerTable.style.borderSpacing=this._borderSpacingY=0;\n\t\t}\n\t\tthis.rootEl.addEventListener(\"focus\",e=>this._spreadsheetOnFocus(e));\n\t\tthis.rootEl.addEventListener(\"blur\",e=>this._spreadsheetOnBlur(e));\n\t\tthis.rootEl.tabIndex=0;//so that the table can be tabbed to\n\t\tthis.rootEl.addEventListener(\"keydown\",e=>this._spreadsheetKeyDown(e));\n\t\tthis.rootEl.addEventListener(\"mousedown\",e=>this._spreadsheetMouseDown(e));\n\t\tthis._cellCursor.addEventListener(\"dblclick\",e=>this._enterCell(e));\n\n\t\tthis._tooltip=document.createElement(\"div\");\n\t\tthis._tooltip.classList.add(\"tooltip\");\n\t\tthis._tooltip.appendChild(document.createElement(\"span\"));\n\t}\n\n\t_rowMetaGet(dataIndex) {\n\t\treturn this._rowsMeta.vals[this._rowsMeta.keys.indexOf(this._data[dataIndex])];\n\t}\n\n\t_rowMetaSet(dataIndex,key,val) {\n\t\tconst linkIndex=this._rowsMeta.keys.indexOf(this._data[dataIndex]);\n\t\tif (linkIndex==-1&&val!=null) {\n\t\t\tthis._rowsMeta.vals.push({[key]:val});\n\t\t\tthis._rowsMeta.keys.push(this._data[dataIndex]);\n\t\t} else if (linkIndex!=-1&&val==null) {\n\t\t\tdelete this._rowsMeta.vals[linkIndex][key];\n\t\t\tif (!Object.keys(this._rowsMeta.vals[linkIndex]).length) {\n\t\t\t\tthis._rowsMeta.vals.splice(linkIndex,1);\n\t\t\t\tthis._rowsMeta.keys.splice(linkIndex,1);\n\t\t\t}\n\t\t} else if (linkIndex!=-1&&val!=null)\n\t\t\tthis._rowsMeta.vals[linkIndex][key]=val;\t\n\t\treturn val;\n\t}\n\n\t_spreadsheetOnFocus(_e) {\n\t\tconst tabbedTo=this._highlightOnFocus;\n\t\tif (this._mainRowIndex==null&&this._mainColIndex==null&&this._data.length&&tabbedTo)\n\t\t\t\tif (this._onlyDetails)\n\t\t\t\t\tthis.selectTopBottomCellOnlyDetails(true);\n\t\t\t\telse\n\t\t\t\t\tthis._selectMainTableCell(this._mainTbody.rows[0].cells[0]);\n\t\t//when the table is tabbed to, whatever focus-outline that the css has set for it should show, but then when the\n\t\t//user starts to navigate using the keyboard we want to hide it because it is a bit distracting when both it and\n\t\t//a cell is highlighted. Thats why #spreadsheetKeyDown sets outline to none, and this line undos that\n\t\t//also, we dont want it to show when focusing by mouse so we use #focusMethod (see its declaration)\n\t\tif (!this._onlyDetails&&this._highlightOnFocus)\n\t\t\tthis.rootEl.style.removeProperty(\"outline\");\n\t\telse\n\t\t\tthis.rootEl.style.outline=\"none\";\n\t\t\n\t\t//why is this needed? it messes things up when cellcursor is in mainpage of bulk-edit-area but hidden because\n\t\t//other page is open, and the tablance gets focus because then it will be visible through the active page\n\t\t//this._cellCursor.style.display=\"block\";\n\t\t\n\t\tif (tabbedTo)\n\t\t\tthis._scrollToCursor();\n\t}\n\n\t_spreadsheetOnBlur(_e) {\n\t\tsetTimeout(()=>{\n\t\t\tif (!this.rootEl.contains(document.activeElement)||this._bulkEditArea?.contains(document.activeElement)) {\n\t\t\t\tthis._highlightOnFocus=true;\n\t\t\t\t//if (this.neighbourTables&&Object.values(this.neighbourTables).filter(Boolean).length)\n\t\t\t\t\tthis._cellCursor.style.display=\"none\";\n\t\t\t}\n\t\t});\n\t}\n\n\t_moveCellCursor(hSign,vSign,e) {\n\t\t\n\t\tif (!this._exitEditMode(true))//try to exit-mode and commit any changes.\n\t\t\treturn false;//if exiting edit-mode was denied then do nothing more\n\t\t//it's important to run this here before deciding on the cell to move to, because exiting edit-mode may have\n\t\t//triggered visibleIf changes that may have changed which cells are selectable.\n\n\n\t\tif (this._mainRowIndex==null&&this._mainColIndex==null)//if table has focus but no cell is selected.\n\t\t\treturn;//can happen if table is clicked but not on a cell\n\t\te?.preventDefault();//to prevent native scrolling when pressing arrow-keys. Needed if #onlyDetails==true but\n\t\t\t\t\t\t\t//not otherwise. Seems the native scrolling is only done on the body and not scrollpane..?\n\t\t//const newColIndex=Math.min(this._cols.length-1,Math.max(0,this._cellCursorColIndex+numCols));\n\t\tif (!this._onlyDetails)\n\t\t\tthis._scrollToCursor();//need this first to make sure adjacent cell is even rendered\n\n\t\tif (this._activeDetailsCell?.parent?.schemaNode.type===\"lineup\")\n\t\t\tthis._moveInsideLineup(hSign,vSign);\n\t\telse if (vSign) {//moving up or down\n\t\t\tlet newColIndex=this._mainColIndex;\n\t\t\tif (this._activeDetailsCell) {//moving from inside details.might move to another cell inside,or outside\n\t\t\t\t\tthis._selectAdjacentDetailsCell(this._activeDetailsCell,vSign==1);\n\t\t\t} else if (vSign===1&&this._rowMetaGet(this._mainRowIndex)?.h){//moving down into details\n\t\t\t\tthis._selectFirstSelectableDetailsCell(this._openDetailsPanes[this._mainRowIndex],true);\n\t\t\t} else if (vSign===-1&&this._rowMetaGet(this._mainRowIndex-1)?.h){//moving up into details\n\t\t\t\tthis._selectFirstSelectableDetailsCell(this._openDetailsPanes[this._mainRowIndex-1],false);\n\t\t\t} else {//moving from and to maintable-cells\n\t\t\t\tthis._selectMainTableCell(\n\t\t\t\t\tthis._selectedCell.parentElement[(vSign>0?\"next\":\"previous\")+\"Sibling\"]?.cells[newColIndex]);\n\t\t\t}\n\t\t} else if (!this._activeDetailsCell)\n\t\t\tthis._selectMainTableCell(this._selectedCell[(hSign>0?\"next\":\"previous\")+\"Sibling\"]);\n\t\tif (this._onlyDetails&&this._mainRowIndex!=null)\n\t\t\tthis._scrollToCursor();\n\t}\n\n\t_moveInsideLineup(numCols,numRows) {\n\t\tconst currentCellX=this._activeDetailsCell.el.offsetLeft;\n\t\tconst currCelTop=this._activeDetailsCell.el.offsetTop;\n\t\tconst currCelBottom=currCelTop+this._activeDetailsCell.el.offsetHeight;\n\t\tif (numCols) {//moving left or right\n\t\t\tfor (let i=this._activeDetailsCell.index,nextCel;nextCel=this._activeDetailsCell.parent.children[i+=numCols];) {\n\t\t\t\tif (nextCel.el.offsetParent != null && (nextCel?.el.offsetLeft>currentCellX)==(numCols>0)) {\n\t\t\t\t\tif (currCelBottom>nextCel.el.offsetTop&&nextCel.el.offsetTop+nextCel.el.offsetHeight>currCelTop)\n\t\t\t\t\t\tthis._selectDetailsCell(nextCel);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {//moving up or down\n\t\t\tlet closestCell,closestCellX;\n\t\t\tconst siblings=this._activeDetailsCell.parent.children;\n\t\t\tfor (let i=this._activeDetailsCell.index,otherCell;otherCell=siblings[i+=numRows];) {\n\t\t\t\tconst skipCell=Math.max(otherCell.el.offsetTop,currCelTop) <= \t\t\t\t\t //cell is on the\n\t\t\t\t\t\t\t\tMath.min(otherCell.el.offsetTop+otherCell.el.offsetHeight,currCelBottom)//same line\n\t\t\t\t\t\t\t\t||otherCell.el.offsetParent == null;//cell is hidden\n\t\t\t\tif (skipCell)\n\t\t\t\t\tcontinue;\n\t\t\t\telse if (closestCell&&(otherCell.el.offsetLeft<closestCellX)===(numRows>0))//scrolled past whole row\n\t\t\t\t\tbreak;\n\t\t\t\tif (!closestCell||Math.abs(otherCell.el.offsetLeft-currentCellX)<Math.abs(closestCellX-currentCellX)) {\n\t\t\t\t\tclosestCell=otherCell;\n\t\t\t\t\tclosestCellX=closestCell.el.offsetLeft;\n\t\t\t\t} else//if further away than current closest one.\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (closestCell)\n\t\t\t\tthis._selectDetailsCell(closestCell);\n\t\t\telse\n\t\t\t\tthis._selectAdjacentDetailsCell(this._activeDetailsCell.parent,numRows==1?true:false);\n\t\t}\n\t}\n\n\t_selectAdjacentDetailsCell(instanceNode,isGoingDown) {\n\t\tlet cell=this._getAdjacentDetailsCell(instanceNode,isGoingDown);//repeat this line until valid cell is found?\n\t\tif (cell)\n\t\t\treturn this._selectDetailsCell(cell);\n\t\tif (!this._onlyDetails)\n\t\t\tthis._selectMainTableCell(this._mainTbody.querySelector(\n\t\t\t\t`[data-data-row-index=\"${this._mainRowIndex+isGoingDown}\"]`)?.cells[this._mainColIndex]);\n\t\telse {\n\t\t\tconst nextTable=this.neighbourTables?.[isGoingDown?\"down\":\"up\"];\n\t\t\tif (nextTable) {\n\t\t\t\tthis._mainColIndex=this._mainRowIndex=this._activeDetailsCell=null;\n\t\t\t\tnextTable.container.style.outline=this._cellCursor.style.display=\"none\";\n\t\t\t\tnextTable.selectTopBottomCellOnlyDetails(isGoingDown);\n\t\t\t}\n\t\t}\n\t}\n\t\n\t_getAdjacentDetailsCell (instanceNode,isGoingDown) {\n\t\tif (!instanceNode.parent)//parent is null if the class-instance is in the bulk-edit-area\n\t\t\treturn;\n\t\tconst siblings=instanceNode.parent.children;\n\t\tconst index=instanceNode.index;\n\t\tfor (let i=index+(isGoingDown||-1); i>=0&&i<siblings.length; i+=isGoingDown||-1) {\n\t\t\tconst sibling=siblings[i];\n\t\t\tif (sibling.hidden)\n\t\t\t\tcontinue;\n\t\t\tif (sibling.el)\n\t\t\t\treturn sibling;\n\t\t\t//else if sibling.children\n\t\t\tconst niece=this._getFirstSelectableDetailsCell(sibling,isGoingDown);\n\t\t\tif (niece)\n\t\t\t\treturn niece;\n\t\t}\n\t\tif (instanceNode.parent.parent)\n\t\t\treturn this._getAdjacentDetailsCell(instanceNode.parent,isGoingDown);\n\t}\n\n\t_selectFirstSelectableDetailsCell(instanceNode,isGoingDown,onlyGetChild=false) {\n\t\tconst newInstanceNode=this._getFirstSelectableDetailsCell(instanceNode,isGoingDown,onlyGetChild);\n\t\tif (newInstanceNode)\n\t\t\treturn this._selectDetailsCell(newInstanceNode);\n\t\tthis._selectMainTableCell(this._mainTbody.querySelector(\n\t\t\t\t`[data-data-row-index=\"${this._mainRowIndex+(isGoingDown||-1)}\"]`)?.cells[this._mainColIndex]);\n\t}\n\n\t/**Given an instanceNode, like the details of a row or any of its sub-containers, it will return the first\n\t * selectable cell from top or bottom\n\t * @param {*} instanceNode\n\t * @param {Boolean} isGoingDown \n\t * @param {Boolean} onlyGetChild if set to true then it will never return the passed in instanceNode and instead\n\t *\t\t\tonly look at its (grand)children. Used for groups where both itself and its children can be selected*/\n\t_getFirstSelectableDetailsCell(instanceNode,isGoingDown,onlyGetChild=false) {\n\t\tif (!onlyGetChild&&instanceNode.el)\n\t\t\treturn instanceNode;\n\t\tconst children=instanceNode.children;\n\t\tlet startI=isGoingDown?0:children.length-1;\n\t\tif (instanceNode.schemaNode.type===\"lineup\"&&!isGoingDown) {\n\t\t\tlet chosenCell;\n\t\t\tfor (let i=startI,otherCell;otherCell=children[i--];)\n\t\t\t\tif (otherCell.el.offsetParent)\n\t\t\t\t\tif (!chosenCell||otherCell.el.offsetLeft<chosenCell.el.offsetLeft)\n\t\t\t\t\t\tchosenCell=otherCell;\n\t\t\t\t\telse\n\t\t\t\t\t\tbreak;\n\t\t\tstartI=chosenCell.index;\n\t\t}\n\t\tfor (let childI=startI;childI>=0&&childI<children.length; childI+=isGoingDown||-1)\n\t\t\tif (!children[childI].hidden&&(children[childI].children||children[childI].select))\n\t\t\t\t return this._getFirstSelectableDetailsCell(children[childI],isGoingDown);\n\t}\n\t\n\t_spreadsheetKeyDown(e) {\n\t\t//prevent this from running in outer Tablance if an inner Tablance-instance is selected\n\t\tif (this._bulkEditArea?.contains(document.activeElement))\n\t\t\treturn;\n\t\tthis._tooltip.style.visibility=\"hidden\";\n\t\tif (this._inEditMode&&this._activeSchemaNode.input.type===\"date\") {\n\t\t\tif (e.key.slice(0,5)===\"Arrow\") {\n\t\t\t\tif (e.ctrlKey)\n\t\t\t\t\te.stopPropagation();//allow moving textcursor if ctrl is held so prevent date-change then\n\t\t\t\telse\n\t\t\t\t\te.preventDefault();//prevent textcursor from moving when arrowkey-selecting dates in date-picker\n\t\t\t} else if (e.key===\"Backspace\")\n\t\t\t\te.stopPropagation();\n\t\t}\n\t\tthis.rootEl.style.outline=\"none\";//see #spreadsheetOnFocus\n\t\tif (!this._inEditMode) {\n\t\t\tswitch (e.code) {\n\t\t\t\tcase \"ArrowUp\":\n\t\t\t\t\tthis._moveCellCursor(0,-1,e);\n\t\t\t\tbreak; case \"ArrowDown\":\n\t\t\t\t\tthis._moveCellCursor(0,1,e);\n\t\t\t\tbreak; case \"ArrowLeft\":\n\t\t\t\t\tthis._moveCellCursor(-1,0,e);\n\t\t\t\tbreak; case \"ArrowRight\":\n\t\t\t\t\tthis._moveCellCursor(1,0,e);\n\t\t\t\tbreak; case \"Escape\":\n\t\t\t\t\tthis._groupEscape();\n\t\t\t\tbreak; case \"NumpadAdd\":\n\t\t\t\t\tthis._scrollToCursor();\n\t\t\t\t\tthis. _expandRow(this._selectedCell.closest(\".main-table>tbody>tr\"));\n\t\t\t\tbreak; case \"NumpadSubtract\":\n\t\t\t\t\tthis._scrollToCursor();\n\t\t\t\t\tthis._contractRow(this._selectedCell.closest(\".main-table>tbody>tr\"));\n\t\t\t\tbreak; case \"Enter\": case \"NumpadEnter\": case \"Space\":\n\t\t\t\t\tif (e.code==\"Space\")\n\t\t\t\t\t\te.preventDefault();//prevent scrolling when pressing space\n\t\t\t\t\tthis._scrollToCursor();\n\t\t\t\t\tif (this._activeSchemaNode.type==\"expand\")\n\t\t\t\t\t\t// the preventDefault() above can SOMETIMES suppress transitionend;\n\t\t\t\t\t\t// deferring one frame ensures the animation completes and details is closed properly.\n\t\t\t\t\t\treturn requestAnimationFrame(()=>this._toggleRowExpanded(this._selectedCell.parentElement));\n\t\t\t\t\tif (this._activeSchemaNode.type==\"select\")\n\t\t\t\t\t\treturn this._rowCheckboxChange(this._selectedCell,e.shiftKey);\n\t\t\t\t\tif (e.code.endsWith(\"Enter\")||this._activeSchemaNode.input?.type===\"button\") {\n\t\t\t\t\t\te.preventDefault();//prevent newline from being entered into textareas\n\t\t\t\t\t\treturn this._enterCell(e);\n\t\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tswitch (e.key) {\n\t\t\t\tcase \"Enter\":\n\t\t\t\t\tthis._moveCellCursor(0,e.shiftKey?-1:1,e);\n\t\t\t\tbreak; case \"Escape\":\n\t\t\t\t\tthis._exitEditMode(false);\n\t\t\t}\n\t\t}\n\t}\n\n\t_groupEscape() {\n\t\tfor (let instanceNode=this._activeDetailsCell; instanceNode=instanceNode?.parent;)\n\t\t\tif (instanceNode.schemaNode.type===\"group\")\n\t\t\t\treturn this._selectDetailsCell(instanceNode);\n\t}\n\n\t_insertAtCursor(myField, myValue) {\n\t\t\n\t\tif (document.selection) {//IE support\n\t\t\tmyField.focus();\n\t\t\tconst sel = document.selection.createRange();\n\t\t\tsel.text = myValue;\n\t\t} else if (myField.selectionStart || myField.selectionStart == '0') {//MOZILLA and others\n\t\t\tvar startPos = myField.selectionStart;\n\t\t\tvar endPos = myField.selectionEnd;\n\t\t\tmyField.value = myField.value.substring(0, startPos)\n\t\t\t\t+ myValue\n\t\t\t\t+ myField.value.substring(endPos, myField.value.length);\n\t\t} else {\n\t\t\tmyField.value += myValue;\n\t\t}\n\t}\n\n\t_unsortCol(id,type) {\n\t\tfor (let sortCol,i=-1;sortCol=this._sortingCols[++i];)\n\t\t\tif (id&&id==sortCol.id||type&&type==sortCol.type) {\n\t\t\t\tthis._sortingCols.splice(i,1);\n\t\t\t\tthis._updateHeaderSortHtml();\n\t\t\t\treturn;\n\t\t\t}\n\t}\n\n\t/**Creates the actual content of a expanded row. When the user expands a row #expandRow is first called which in\n\t * turn calls this one. When scrolling and already expanded rows are found only this one needs to be called.\n\t * @param {*} tr \n\t * @param {*} rowIndex \n\t * @returns */\n\t_renderDetails(tr,rowIndex) {\n\t\ttr.classList.add(\"expanded\");\n\t\tconst detailsRow=tr.parentElement.insertRow(tr.rowIndex+1);\n\t\tdetailsRow.className=\"details\";\n\t\tdetailsRow.dataset.dataRowIndex=rowIndex;\n\t\tconst detailsCell=detailsRow.insertCell();\n\t\tdetailsCell.colSpan=this._cols.length;\n\t\tconst detailsDiv=detailsCell.appendChild(document.createElement(\"div\"));//single div inside td for animate\n\t\tdetailsDiv.style.height=\"auto\";\n\t\tdetailsDiv.className=\"content\";\n\t\tdetailsDiv.addEventListener(\"transitionend\",this._detailsAnimationEnd.bind(this));\n\t\tconst shadowLine=detailsDiv.appendChild(document.createElement(\"div\"));\n\t\tshadowLine.className=\"details-shadow\";\n\t\tconst instanceNode=this._openDetailsPanes[rowIndex]={};\n\t\tthis._generateDetailsContent(this.schema.details,rowIndex,instanceNode,detailsDiv,[],this._data[rowIndex]);\n\t\tinstanceNode.rowIndex=rowIndex;\n\t\treturn detailsRow;\n\t}\n\n\t_detailsAnimationEnd(e) {\n\t\tif (e.currentTarget!==e.target)\n\t\t\treturn;//otherwise it will apply to transitions of child-elements as well\n\t\tif (parseInt(e.target.style.height)) {//if expand finished\n\n\t\t\te.target.style.height=\"auto\";\n\t\t} else {//if contract finished\n\n\t\t\tconst detailsTr=e.target.closest(\"tr\");\n\t\t\tconst mainTr=detailsTr.previousSibling;\n\t\t\tconst dataRowIndex=mainTr.dataset.dataRowIndex;\n\t\t\tmainTr.classList.remove(\"expanded\");\n\t\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)\n\t\t\t\t -this._rowMetaGet(dataRowIndex).h+this._rowHeight+\"px\";\n\t\t\tdetailsTr.remove();\n\t\t\tthis._rowMetaSet(dataRowIndex,\"h\",null);\n\t\t\tdelete this._openDetailsPanes[dataRowIndex];\n\t\t}\n\t}\n\n\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} schemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when the context points to a data object that will be created when the user adds data.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsContent(schemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tif (!path.length)\n\t\t\tinstanceNode.rowIndex=mainIndex;\n\t\tinstanceNode.path=[...path];\n\t\tinstanceNode.dataObj=rowData;\n\t\tinstanceNode.schemaNode=schemaNode;\n\t\tif (schemaNode.visibleIf)\n\t\t\tthis._applyVisibleIf(instanceNode);\n\t\tswitch (schemaNode.type) {\n\t\t\tcase \"list\": return this._generateDetailsList(...arguments);\n\t\t\tcase \"field\": return this._generateField(...arguments);\n\t\t\tcase \"group\": return this._generateDetailsGroup(...arguments);\n\t\t\tcase \"repeated\": return this._generateDetailsRepeated(...arguments);\n\t\t\tcase \"lineup\": return this._generateDetailsLineup(...arguments);\n\t\t\tcase \"context\": return this._generateContext(...arguments);\n\t\t}\n\t}\n\n\t_repeatedOnDelete=(e,data,index,schemaNode,cel)=>{\n\t\tthis._deleteCell(cel.parent.parent);\n\t\tcel.parent.parent.parent.schemaNode.onDelete?.(cel.parent.parent.dataObj,cel.parent.parent);\n\t}\n\n\t_fileOnDelete=(e,data,index,strct,cel)=>{\n\t\tconst fileCell=cel.parent.parent;\n\t\tconst inputSchemaNode=fileCell.fileInputSchemaNode;\n\t\tconst dataRow=fileCell.parent.dataObj;\n\t\tdelete dataRow[inputSchemaNode.id];\n\t\tconst fileTd=fileCell.el.parentElement;\n\t\tfileTd.innerHTML=\"\";\n\t\tfileTd.classList.remove(\"group-cell\");\n\t\tthis._generateDetailsContent(inputSchemaNode,index,fileCell,fileTd,fileCell.path,dataRow);\n\t\tinputSchemaNode.deleteHandler?.(e,data,inputSchemaNode,fileCell.parent.dataObj,index,fileCell);\n\t\tthis._selectDetailsCell(fileCell);\n\t}\n\n\t_onOpenCreationGroup=(e,groupObject)=>{\n\t\te.preventDefault();\n\t\tthis._repeatInsert(groupObject.parent,true,groupObject.parent.dataObj[groupObject.parent.dataObj.length]={});\n\t}\n\n\t/**\n\t * This is \"supposed\" to get called when a repeated-schemaNode is found however in #generateDetailsList,\n\t * repeated schema-nodes are looked for and handled by that method instead so that titles can be added to the list\n\t * which isn't handled by #generateDetailsContent but by the list-method itself\n\t *\n\t * @param {object} repeatedSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when the context points to a data object that will be created when the user adds data.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsRepeated(repeatedSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tinstanceNode.children=[];\n\t\tlet repeatData=instanceNode.dataObj=rowData[repeatedSchemaNode.id]??(rowData[repeatedSchemaNode.id]=[]);\n\t\tinstanceNode.insertionPoint=parentEl.appendChild(document.createComment(\"repeated-insert\"));\n\t\trepeatedSchemaNode.create&&this._generateRepeatedCreator(instanceNode);\n\t\trepeatData?.forEach(repeatData=>this._repeatInsert(instanceNode,false,repeatData));\n\t\treturn !!repeatData?.length||repeatedSchemaNode.create;\n\t}\n\n\t/**For repeated schema-nodes with create set to true (meaning users can create more entries via user-interface),\n\t * this method creates the last entry that the user interacts with to create another entry\n\t * @param {Object} repeatedObj The object representing the repeated-container*/\n\t_generateRepeatedCreator(repeatedObj) {\n\t\tconst creationTxt=repeatedObj.schemaNode.creationText??this._opts.lang?.insertNew??\"Insert new\";\n\t\tconst creationSchemaNode={type:\"group\",closedRender:()=>creationTxt,entries:[],\n\t\t\t\t\t\t\tcreator:true//used to know that this entry is the creator and that it should not be sorted\n\t\t\t\t\t\t\t,onOpen:this._onOpenCreationGroup,cssClass:\"repeat-insertion\"};\n\t\tconst el=this._repeatInsert(repeatedObj,false,{},creationSchemaNode);\n\t\tel.parentElement.classList.add(\"empty\");//this will make it hidden if inside a group that is closed\n\t}\n\n\t_beginDeleteRepeated(e,data,mainIndex,schemaNode,cell) {\n\t\tif (!cell.parent.parent.creating) {\n\t\t\tcell.parent.containerEl.classList.add(\"delete-confirming\");\n\t\t\tthis._moveInsideLineup(1);//move away from the delete-button which now dissapeared, to the next btn\n\t\t} else\n\t\t\tthis._deleteCell(cell.parent.parent);\n\t}\n\n\t_cancelDelete(e,data,mainIndex,schemaNode,cell) {\n\t\t\tcell.parent.containerEl.classList.remove(\"delete-confirming\");\n\t\t\tthis._selectDetailsCell(cell.parent.children[0]);\n\t}\n\n\t_schemaCopyWithDeleteButton(schemaNode,deleteHandler) {\n\t\tconst deleteControls={type:\"lineup\",cssClass:\"delete-controls\"\n\t\t\t,onBlur:cel=>cel.selEl.querySelector(\".lineup\").classList.remove(\"delete-confirming\")\n\t\t\t,entries:[{type:\"field\",input:{type:\"button\",\n\t\t\t\tbtnText:schemaNode.deleteText??this._opts.lang?.delete??\"Delete\"\n\t\t\t\t,clickHandler:this._beginDeleteRepeated.bind(this)},cssClass:\"delete\"},\n\t\t\t{type:\"field\",input:{type:\"button\"\n\t\t\t\t,btnText:schemaNode.areYouSureNoText??this._opts.lang?.deleteAreYouSureNo??\"No\",\n\t\t\t\tclickHandler:this._cancelDelete.bind(this)},cssClass:\"no\"\n\t\t\t\t,title:schemaNode.deleteAreYouSureText??this._opts.lang?.deleteAreYouSure??\"Are you sure?\"},\n\t\t\t{type:\"field\",input:{type:\"button\"\n\t\t\t\t,btnText:schemaNode.areYouSureYesText??this._opts.lang?.deleteAreYouSureYes??\"Yes\",\n\t\t\t\tclickHandler:deleteHandler},cssClass:\"yes\"}]};\n\t\tschemaNode={...schemaNode};//make shallow copy so original is not affected\n\t\tschemaNode.entries=[...schemaNode.entries,deleteControls];\n\t\treturn schemaNode;\n\t}\n\n\t_generateButton(schemaNode,mainIndex,parentEl,rowData,instanceNode=null) {\n\t\tconst btn=parentEl.appendChild(document.createElement(\"button\"));\n\t\tbtn.tabIndex=\"-1\";//so it can't be tabbed to\n\t\tbtn.innerHTML=schemaNode.input.btnText;\n\t\tbtn.addEventListener(\"click\",e=>schemaNode.input.clickHandler?.(e,rowData,mainIndex,schemaNode,instanceNode));\n\n\t\t//prevent gaining focus upon clicking it whhich would cause problems. It should be \"focused\" by having the\n\t\t//cellcursor on its cell which triggers it with enter-key anyway\n\t\tbtn.addEventListener(\"mousedown\",e=>e.preventDefault());\n\t\treturn true;\n\t}\n\n\t\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} groupSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when the context points to a data object that will be created when the user adds data.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsGroup(groupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,notYetCreated) {\n\t\tinstanceNode.select=()=>this._selectDetailsCell(instanceNode);\n\t\tconst groupTable=parentEl.appendChild(document.createElement(\"table\"));\n\t\tconst tbody=instanceNode.containerEl=groupTable.appendChild(document.createElement(\"tbody\"));\n\t\tgroupTable.dataset.path=path.join(\"-\");\n\t\tparentEl.classList.add(\"group-cell\");\n\t\tinstanceNode.el=groupTable;//so that the whole group-table can be selectedf\n\t\tif (notYetCreated)\n\t\t\tinstanceNode.creating=true;\n\t\tgroupTable.className=\"details-group \"+(groupSchemaNode.cssClass??\"\");\n\t\tthis._generateDetailsCollection(groupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData);\n\t\tif (groupSchemaNode.closedRender) {\n\t\t\tgroupTable.classList.add(\"closed-render\");\n\t\t\tconst renderRow=tbody.insertRow();\n\t\t\trenderRow.dataset.path=path.join(\"-\");\n\t\t\trenderRow.className=\"group-render\";\n\t\t\tconst renderCell=renderRow.insertCell();\n\t\t\trenderCell.innerText=groupSchemaNode.closedRender(rowData);\n\t\t}\n\t\treturn true;\n\t}\n\n\t\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} listSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when the context points to a data object that will be created when the user adds data.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsList(listSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tconst listTable=parentEl.appendChild(document.createElement(\"table\"));\n\t\tinstanceNode.containerEl=listTable.appendChild(document.createElement(\"tbody\"));\n\t\tlistTable.className=\"details-list\";\n\t\tif (listSchemaNode.titlesColWidth!=false) {\n\t\t\tlet titlesCol=document.createElement(\"col\");\n\t\t\tlistTable.appendChild(document.createElement(\"colgroup\")).appendChild(titlesCol);\n\t\t\tif (listSchemaNode.titlesColWidth!=null)\n\t\t\t\ttitlesCol.style.width=listSchemaNode.titlesColWidth;\n\t\t}\n\t\treturn this._generateDetailsCollection(listSchemaNode,mainIndex,instanceNode,parentEl,path,rowData);\n\t}\n\n\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} lineupSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when the context points to a data object that will be created when the user adds data.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsLineup(lineupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tinstanceNode.containerEl=parentEl.appendChild(document.createElement(\"div\"));\n\t\tinstanceNode.containerEl.classList.add(\"lineup\",\"collection\",...lineupSchemaNode.cssClass?.split(\" \")??[]);\n\t\treturn this._generateDetailsCollection(lineupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData);\n\t}\n\n\t/**\n\t * Generates a \"context\"-entry.\n\t * A context entry does not produce its own visible container but instead\n\t * changes the data scope to a nested object on the current row.\n\t * Its child entries are then generated using this nested object as their data source.\n\t * @param {object} contextSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when the context points to a data object that will be created when the user adds data.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateContext(contextSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,notYetCreated) {\n\t\tif (!rowData[contextSchemaNode.id]) {//if the structure point to data within objects that doesn't yet exist\n\t\t\tnotYetCreated=true;\n\t\t\trowData[contextSchemaNode.id]={};\n\t\t}\n\t\treturn this._generateDetailsContent(contextSchemaNode.entry, mainIndex, instanceNode, parentEl, path\n\t\t\t,rowData[contextSchemaNode.id],notYetCreated);\n\t}\n\t\n\n\t_generateDetailsCollection(containerSchemaNode,mainIndex,collectionObj,parentEl,path,rowData) {\n\t\t//allows for easily finding the outer-most parent of elements that are placed in collection\n\t\tcollectionObj.containerEl.classList.add(\"collection\");\n\n\t\tcollectionObj.children=[];\n\t\tfor (let entryI=-1,childSchemaNode; childSchemaNode=containerSchemaNode.entries[++entryI];) {\n\t\t\tif (childSchemaNode.type===\"repeated\") {\n\t\t\t\tconst repeatData=rowData[childSchemaNode.id]??(rowData[childSchemaNode.id]=[]);\n\t\t\t\tconst rptCelObj=collectionObj.children[entryI]={parent:collectionObj,index:entryI,children:[]\n\t\t\t\t\t\t\t\t\t\t\t\t,schemaNode:childSchemaNode,dataObj:repeatData,path:[...path,entryI]};\n\t\t\t\trptCelObj.insertionPoint=collectionObj.containerEl.appendChild(document.createComment(\"repeat-insert\"));\n\t\t\t\tchildSchemaNode.create&&this._generateRepeatedCreator(rptCelObj);\n\t\t\t\trepeatData?.forEach(repeatData=>this._repeatInsert(rptCelObj,false,repeatData));\n\t\t\t} else\n\t\t\t\tthis._generateCollectionItem(childSchemaNode,mainIndex,collectionObj,path,rowData);\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * Build correct DOM structure for a collection item depending on collection type.\n\t * Returns both outermost element (outerContainerEl) and the inner element (containerEl)\n\t * where the content will be placed.\n\t * \n\t * Also sets special properties on itemObj for group items.\n\t */\n\t_buildCollectionItemDOM(schemaNode,collection,itemObj,title) {\n\t\tlet outerContainerEl,containerEl;\n\t\tconst type=collection.schemaNode.type;\n\n\t\t// LIST: Each item is a <tr> with title cell optionally + value cell\n\t\tif (type==\"list\") {\n\t\t\touterContainerEl=document.createElement(\"tr\");\n\t\t\tif (collection.schemaNode.titlesColWidth!=false) {\n\t\t\t\tconst td=outerContainerEl.insertCell();\n\t\t\t\ttd.className=\"title\";\n\t\t\t\ttd.innerText=schemaNode.title??\"\";\n\t\t\t}\n\t\t\tcontainerEl=outerContainerEl.insertCell();\n\t\t} else if (type==\"lineup\") {// LINEUP: Items rendered inline, outerContainerEl wraps title + inner content\n\t\t\touterContainerEl=document.createElement(\"span\");\n\t\t\tif (title)\n\t\t\t\touterContainerEl.appendChild(title);\n\t\t\tcontainerEl=itemObj.selEl=outerContainerEl.appendChild(document.createElement(\"div\"));\n\t\t} else if (type==\"group\") {//GROUP: More complex <tr> with special rules for empty/hiding and more\n\t\t\touterContainerEl=document.createElement(\"tr\");\n\t\t\touterContainerEl.className=\"empty\";\t// Will be hidden while group is closed until content becomes non-empty\n\n\t\t\tconst td=outerContainerEl.insertCell();\n\t\t\ttd.classList.toggle(\"disabled\",schemaNode.type==\"field\"&&!schemaNode.input);\n\n\t\t\t// Add separator for non-group members\n\t\t\tif (schemaNode.type!=\"group\")\n\t\t\t\ttd.appendChild(document.createElement(\"hr\")).className=\"separator\";\n\n\t\t\tif (title)\n\t\t\t\ttd.appendChild(title);\n\n\t\t\tcontainerEl=td.appendChild(document.createElement(\"div\"));\n\n\t\t\t// Track non-empty descendants so empty group rows can hide visually\n\t\t\tObject.assign(itemObj,{\n\t\t\t\tnonEmptyDescentants:0,\n\t\t\t\tgrpTr:outerContainerEl,\n\t\t\t\tselEl:td\n\t\t\t});\n\t\t} else\n\t\t\touterContainerEl=containerEl=document.createElement(\"div\");\n\t\treturn {outerContainerEl,containerEl};\n\t}\n\n\t/**\n\t * Insert the newly generated collection item into the DOM, either at end or at a precise insert position.\n\t * Handles \"repeated\" collections where insertion point is not always end of list.\n\t */\n\t_insertCollectionItem(schemaNode,index,itemObj,outerContainerEl,collectionOrRepeated,collectionEl) {\n\t\tlet siblingAfter=null;\n\n\t\t// For repeated collections: determine the real insertion position based on insertionPoint\n\t\tif (collectionOrRepeated.schemaNode.type==\"repeated\") {\n\t\t\tconst next=collectionOrRepeated.insertionPoint.nextSibling;\n\t\t\tconst base=collectionOrRepeated.children.length;\n\t\t\tconst pos=(next?.rowIndex??base)-base+index;\n\t\t\tsiblingAfter=collectionOrRepeated.children[pos];\n\t\t}\n\n\t\t// Where to insert in the DOM\n\t\tconst beforeEl=siblingAfter?.el.closest(\".collection>*\")?? collectionOrRepeated.insertionPoint;\n\n\t\tcollectionEl.insertBefore(outerContainerEl,beforeEl);\n\n\t\t// Insert into internal children array\n\t\tcollectionOrRepeated.children.splice(index,0,itemObj);\n\n\t\t// Extra CSS class if defined in schemaNode\n\t\tif (schemaNode.cssClass)\n\t\t\touterContainerEl.className+=\" \"+schemaNode.cssClass;\n\t}\n\t\n\t\n\n\t/**\n\t * Generate one item inside a collection or repeated block.\n\t * Creates DOM, updates indices, generates inner content, and inserts into DOM\n\t * only if details content was actually created (e.g., repeated with empty data should not add item).\n\t */\n\t_generateCollectionItem(schemaNode,mainIndex,collectionOrRepeated,path,data,index=null) {\n\t\t// Determine actual collection (repeated uses parent collection visually)\n\t\tconst collection=collectionOrRepeated.schemaNode.type==\"repeated\"\n\t\t\t\t\t\t\t\t\t?collectionOrRepeated.parent:collectionOrRepeated;\n\n\t\tconst collectionEl=collection.containerEl;\n\t\tindex??=collectionOrRepeated.children.length;\n\n\t\t// Item object (holds metadata for this item)\n\t\tconst itemObj=Object.assign(Object.create(null),{parent:collectionOrRepeated,index:index});\n\n\t\t// Optional title element\n\t\tlet title;\n\t\tif (schemaNode.title) {\n\t\t\ttitle=document.createElement(\"span\");\n\t\t\ttitle.className=\"title\";\n\t\t\ttitle.innerHTML=schemaNode.title;\n\t\t}\n\n\t\t// Build DOM structure for this item\n\t\tconst {outerContainerEl,containerEl}=this._buildCollectionItemDOM(schemaNode,collection,itemObj,title);\n\n\n\t\t// Visual CSS classes\n\t\tif (schemaNode.input&&schemaNode.input.type!=\"button\")\n\t\t\tcontainerEl.classList.add(\"input-cell\");\n\t\tcontainerEl.classList.add(\"value\");\n\t\tif (schemaNode.input)\n\t\t\touterContainerEl.classList.add((schemaNode.input.type??\"text\")+\"-container\");\n\n\t\t// If inserting in middle: update sibling item indices\n\t\tif (index<collectionOrRepeated.children.length)\n\t\t\tfor (let i=index-1,sibling; sibling=collectionOrRepeated.children[++i];)\n\t\t\t\tthis._changeInstanceNodeIndex(sibling,i+1);\n\n\t\tpath.push(index);\n\n\t\titemObj.outerContainerEl=outerContainerEl;//reference to outer-most container belonging exclusively to this item\n\n\t\t// Expand inner content; may return false if nothing should be rendered\n\t\tconst generated=this._generateDetailsContent(\n\t\t\t\t\t\t\t\t\t\t\t\tschemaNode,mainIndex,itemObj,containerEl,path,data,outerContainerEl);\n\n\t\t// Only insert if it actually has content (important for sparse repeated arrays)\n\t\tif (generated)\n\t\t\tthis._insertCollectionItem(schemaNode,index,itemObj,outerContainerEl,collectionOrRepeated,collectionEl);\n\n\t\tpath.pop();\n\t\treturn itemObj;\n\t}\n\n\t_generateField(fieldSchemaNode,mainIndex,instanceNode,parentEl,path,rowData) {\n\t\tinstanceNode.select=()=>this._selectDetailsCell(instanceNode);\n\t\tinstanceNode.el=parentEl;\n\t\tthis._updateDetailsCell(instanceNode,rowData);\n\t\tinstanceNode[instanceNode.selEl?\"selEl\":\"el\"].dataset.path=path.join(\"-\");\n\t\treturn true;\n\t}\n\t\n\t_spreadsheetMouseDown(e) {\n\t\tthis._highlightOnFocus=false;//see decleration\n\t\tthis.rootEl.style.outline=\"none\";//see #spreadsheetOnFocus\n\t\tthis._tooltip.style.visibility=\"hidden\";\n\t\tif (Date.now()<this._ignoreClicksUntil)//see decleration of #ignoreClicksUntil\n\t\t\treturn;\n\t\tif (e.which===3)//if right click\n\t\t\treturn;\n\t\tconst mainTr=e.target.closest(\".main-table>tbody>tr\");\n\t\tif (this._onlyDetails||mainTr?.classList.contains(\"details\")) {//in details\n\t\t\tconst interactiveEl=e.target.closest('[data-path]');\n\t\t\tif (!interactiveEl)\n\t\t\t\treturn;\n\t\t\tlet instanceNode=this._openDetailsPanes[mainTr?.dataset.dataRowIndex??0];\n\t\t\tfor (let step of interactiveEl.dataset.path.split(\"-\")) {\n\t\t\t\tinstanceNode=instanceNode.children[step];\n\t\t\t\tif (instanceNode.schemaNode.type===\"group\"&&!instanceNode.el.classList.contains(\"open\"))\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tthis._selectDetailsCell(instanceNode);\n\t\t} else {//not in details\n\t\t\tconst td=e.target.closest(\".main-table>tbody>tr>td\");\n\t\t\tif (td?.classList.contains(\"expand-col\")||td?.classList.contains(\"select-col\")) {\n\t\t\t\tif (e.shiftKey)\n\t\t\t\t\te.preventDefault();//prevent text-selection when shift-clicking checkboxes\n\t\t\t\tif (this._mainRowIndex==null) {\n\t\t\t\t\tthis._selectMainTableCell(td);\n\t\t\t\t\tthis.rootEl.focus({preventScroll:true});\n\t\t\t\t}\n\t\t\t\tif (td.classList.contains(\"expand-col\"))\n\t\t\t\t\treturn this._toggleRowExpanded(td.parentElement);\n\t\t\t\treturn this._rowCheckboxChange(td,e.shiftKey);\n\t\t\t}\n\t\t\tthis._selectMainTableCell(td);\n\t\t}\n\t}\n\n\t_toggleRowExpanded(tr) {\n\t\tif (tr.classList.contains(\"expanded\"))\n\t\t\tthis._contractRow(tr);\n\t\telse\n\t\t\tthis._expandRow(tr);\n\t}\n\n\t_rowCheckboxChange(td,shift) {\n\t\tconst checked=!td.querySelector(\"input\").checked;\n\t\tconst mainIndex=parseInt(td.parentElement.dataset.dataRowIndex);\n\t\tif (!shift)//shift not held, \n\t\t\tthis._lastCheckedIndex=mainIndex;//set #lastCheckedIndex to the current index to both start and stop at it\n\t\tthis._toggleRowsSelected(checked,...[mainIndex,this._lastCheckedIndex??mainIndex].sort((a,b)=>a-b));\n\t\tthis._lastCheckedIndex=mainIndex;//if shift held next time then rows between this and new mainIndex are checked\n\t}\n\n\t_toggleRowsSelected(checked,fromIndex,toIndex) {\n\t\tthis._unsortCol(null,\"select\");\n\t\tfor (var i=fromIndex;i<=toIndex; i++){\n\t\t\tif (i>=this._scrollRowIndex&&i<this._scrollRowIndex+this._numRenderedRows) {\n\t\t\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${i}\"]`);\n\t\t\t\ttr.querySelector(\".select-col input\").checked=checked;\n\t\t\t\ttr.classList.toggle(\"selected\",checked);\n\t\t\t}\n\t\t\tif (checked&&this._selectedRows.indexOf(this._data[i])==-1) {\n\t\t\t\tthis._selectedRows.push(this._data[i]);\n\t\t\t\tthis._numRowsSelected++;\n\t\t\t\tthis._numRowsInViewSelected++;\n\t\t\t} else if (!checked&&this._selectedRows.indexOf(this._data[i])!=-1) {\n\t\t\t\tthis._selectedRows.splice(this._selectedRows.indexOf(this._data[i]),1);\n\t\t\t\tthis._numRowsSelected--;\n\t\t\t\tthis._numRowsInViewSelected--;\n\t\t\t}\n\t\t}\n\t\tthis._numberOfRowsSelectedSpan.innerText=this._numRowsSelected;\n\t\tthis._updateNumRowsSelectionState();\n\t\tthis._updateBulkEditAreaCells();\n\t}\n\n\t_updateNumRowsSelectionState() {\n\t\tconst checkbox=this._headerTr.querySelector(\".select-col input\");\n\t\tif (this._numRowsInViewSelected==this._data.length||!this._numRowsInViewSelected) {\n\t\t\tcheckbox.indeterminate=false;\n\t\t\tcheckbox.checked=this._numRowsInViewSelected;\n\t\t} else\n\t\t\tcheckbox.indeterminate=true;\n\t\tif (this._numRowsSelected^this._bulkEditAreaOpen) {\n\t\t\tthis._bulkEditAreaOpen=!!this._numRowsSelected;\n\t\t\tthis._bulkEditArea.style.height=this._bulkEditAreaOpen?this._bulkEditAreaHeightPx+\"px\":0;\n\t\t\tthis._animate(this._updateViewportHeight,Infinity,\"adjustViewportHeight\");\n\t\t}\n\t}\n\n\t_animate(func,runForMs,id) {\n\t\tconst runUntil=Date.now()+runForMs;\n\t\tconst animations=this._animations;\n\t\tif (!animations[id]) {\n\t\t\tanimations[id]=runUntil;\n\t\t\trequestAnimationFrame(frame);\n\t\t} else\n\t\t\tanimations[id]=runUntil;\n\t\tfunction frame() {\n\t\t\tfunc();\n\t\t\tif (Date.now()<animations[id])\n\t\t\t\trequestAnimationFrame(frame);\n\t\t\telse\n\t\t\t\tdelete animations[id];\n\t\t}\n\t}\n\n\t_autoTextAreaResize(e) {\n\t\tconst maxHeight=this._activeSchemaNode.maxHeight??Infinity;\n\t\t\n\t\t//__auto-resize__\n\t\t//first set height to auto.This won't make it auto-resize or anything but will rather set its height to about 40\n\t\te.target.style.height=\"auto\";\n\t\t//then set size of cellcursor, and also the underlying cell in order to make details-height adjust to scroll-\n\t\t//height of the textarea. Also add 1px because *sometimes* without logic the textarea would recieve a scrollbar\n\t\t//which can scroll about 1 px. Not sure if 1px is actually sufficent but let's start there.\n\t\tthis._cellCursor.style.height=this._selectedCell.style.height=Math.min(maxHeight,e.target.scrollHeight+1)+\"px\";\n\t\t//now set height of textarea to 100% of cellcursor which height is set with above line. this line and the one\n\t\t//setting it to auto \"could\" be skipped but that will result in the textarea not shrinking when needed.\n\t\te.target.style.height=\"100%\";\n\n\t\t//need to call this to make the height of the details adjust and reflect the change in size of the textarea\n\t\tthis._updateDetailsHeight(this._selectedCell.closest(\"tr.details\"));\n\t}\n\n\t_updateDetailsHeight(detailsTr) {\n\t\tconst contentDiv=detailsTr.querySelector(\".content\");\n\t\tconst mainRowIndex=parseInt(detailsTr.dataset.dataRowIndex);\n\t\tcontentDiv.style.height=\"auto\";//set to auto in case of in middle of animation, get correct height\n\t\tconst prevRowHeight=this._rowMetaGet(mainRowIndex).h;\n\t\tconst newRowHeight=this._rowHeight+detailsTr.offsetHeight+this._borderSpacingY;\n\t\tthis._rowMetaSet(mainRowIndex,\"h\",newRowHeight);\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)//adjust scroll-height reflect change...\n\t\t\t+newRowHeight-prevRowHeight+\"px\";//...in height of the table\n\t}\n\n\t_openDateEdit(e) {\n\t\tconst input=document.createElement(\"input\");\n\t\tlet pika,pikaContainer;\n\t\t//this._input.type=\"date\";//using Pikaday instead which I find more user-friendly. Calendar can be opened\n\t\t\t\t\t\t\t\t//up right away and typing manualy is still permitted\n\t\tthis._attachInputFormatter(input,{date:true});\n\t\tif (!window.Pikaday)\n\t\t\tconsole.warn(\"Pikaday-library not found\");\n\t\telse {\n\t\t\tpikaContainer=this._cellCursor.parentElement.appendChild(document.createElement(\"div\"));\n\t\t\tpikaContainer.className=\"pika-container\";\n\t\t\tpika=new Pikaday({field:input,\n\t\t\t\ttoString: d=>d.getFullYear()+\"-\"+('0'+(d.getMonth()+1)).slice(-2)+\"-\"+('0'+d.getDate()).slice(-2),\n\t\t\t\tonClose:()=>{\n\t\t\t\t\tpikaContainer.remove();\n\t\t\t\t\tpika.destroy();\n\t\t\t\t\tsetTimeout(()=>this._exitEditMode(true));\n\t\t\t\t},\n\t\t\t\tcontainer:pikaContainer,\n\t\t\t\tfirstDay:1,//week starts on monday\n\t\t\t\tshowWeekNumber:true,\n\t\t\t\tdefaultDate: this._selectedCellVal ? new Date(this._selectedCellVal) : undefined,\n\t\t\t\tsetDefaultDate:true,\n\t\t\t\ti18n: {\n\t\t\t\t\tpreviousMonth : 'Tidigare Månad',\n\t\t\t\t\tnextMonth     : 'Nästa Månad',\n\t\t\t\t\tmonths        : ['Januari','Februari','Mars','April','Maj','Juni','Juli','Augusti','September'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,'Oktober','November','December'],\n\t\t\t\t\tweekdays      : ['Söndag','Måndag','Tisdag','Onsdag','Torsdag','Fredag','Lördag'],\n\t\t\t\t\tweekdaysShort : ['Sön','Mån','Tis','Ons','Tor','Fre','Lör']\n\t\t\t\t},\n\t\t\t\tonOpen:()=>this._alignDropdown(pikaContainer),//have to wait until onOpen or size is 0\n\t\t\t\tonDraw: () => this._alignDropdown(pikaContainer)//not all months include the same number of weeks,\n\t\t\t\t\t\t\t\t//so sometimes the calendar gets taller or shorter and that's why we have to re-align\n\t\t\t});\n\t\t\tpika.el.style.position=\"static\";//otherwise size of pikaContainer will be 0 and alignDropdown wont work\n\t\t\tif (e instanceof KeyboardEvent)\n\t\t\t\te.stopPropagation();//otherwise the enter-press is propagated to Pikaday, immediately closing it\n\t\t\tinput.addEventListener(\"input\",onInput.bind(this));\n\t\t\tinput.addEventListener(\"change\",()=>this._inputVal=input.value);\n\t\t}\n\t\t\n\t\tthis._cellCursor.appendChild(input);\n\t\tinput.value=this._selectedCellVal??\"\";\n\t\tinput.placeholder=this._activeSchemaNode.input.placeholder??this._opts.lang?.datePlaceholder??\"YYYY-MM-DD\";\n\t\tinput.focus();\n\t\t\n\t\tfunction onInput(_e) {\n\t\t\tconst inputVal=input.value;\n\t\t\tpika.setDate(input.value);\n\t\t\t//the above line will change the text above by guessing where there should be zeroes and such so prevent\n\t\t\t//that by setting it back so that the user can type freely\n\t\t\tinput.value=inputVal;\n\t\t}\n\t}\n\n\t/**Aligns dropdowns like select and date-picker correctly by the cellcursor or any other target-element specified */\n\t_alignDropdown(dropdown,target=this._cellCursor) {\n\n\t\tconst alignmentContainer=this._dropdownAlignmentContainer;//container of the dropdown\n\t\tconst alignmentPos=this._getElPos(target);//and its position inside\n\t\t\n\t\t//if target-element is below middle of viewport or if in bulk-edit-area\n\t\tdropdown.classList.remove(\"above\",\"below\",\"left\",\"right\");\n\t\tif (alignmentPos.y+target.clientHeight/2>alignmentContainer.scrollTop+alignmentContainer.clientHeight/2) {\n\t\t\t//then place dropdown above target-element\n\t\t\tdropdown.style.top=alignmentPos.y-dropdown.offsetHeight+\"px\";\n\t\t\tdropdown.classList.add(\"above\");\n\t\t} else {\n\t\t\t//else place dropdown below target-element\n\t\t\tdropdown.style.top=alignmentPos.y+target.clientHeight+\"px\";\n\t\t\tdropdown.classList.add(\"below\");\n\t\t}\n\n\t\t//if there's enough space to the right of target-element\n\t\tif (alignmentContainer.clientWidth-alignmentPos.x>dropdown.offsetWidth) {\n\t\t\t//then align the left of the dropdown with the left of the target-element\n\t\t\tdropdown.style.left=alignmentPos.x+\"px\";\n\t\t\tdropdown.classList.add(\"left\");\n\t\t} else {\n\t\t\t//otherwise align the right of the dropdown with the right of the target-element\n\t\t\tdropdown.style.left=alignmentPos.x-(dropdown.offsetWidth-target.offsetWidth)+\"px\";\n\t\t\tdropdown.classList.add(\"right\");\n\t\t}\n\t}\n\n\t_enterCell(e) {\n\t\tif (this._inEditMode||this._cellCursor.classList.contains(\"disabled\"))\n\t\t\treturn;\n\t\tif (this._activeSchemaNode.input) {\n\t\t\te.preventDefault();//prevent text selection upon entering editmode\n\t\t\tif (this._activeSchemaNode.input.type===\"button\")\n\t\t\t\treturn this._activeDetailsCell.el.click();\n\t\t\tthis._inputVal=this._selectedCellVal;\n\t\t\tthis._inEditMode=true;\n\t\t\tthis._cellCursor.classList.add(\"edit-mode\");\n\t\t\t({textarea:this._openTextAreaEdit,date:this._openDateEdit,select:this._openSelectEdit\n\t\t\t\t,file:this._openFileEdit}[this._activeSchemaNode.input.type]??this._openTextEdit).call(this,e);\n\t\t} else if (this._activeSchemaNode.type===\"group\") {\n\t\t\tthis._openGroup(this._activeDetailsCell);\n\t\t}\n\t}\n\n\t_openGroup(groupObj) {\n\t\tlet doOpen=true;\n\t\tgroupObj.schemaNode.onOpen?.({preventDefault:()=>doOpen=false},groupObj);\n\t\tif (!doOpen)\n\t\t\treturn;\n\t\tgroupObj.el.classList.add(\"open\");\n\t\tthis._selectDetailsCell(this._getFirstSelectableDetailsCell(groupObj,true,true));\n\t\tgroupObj.schemaNode.onOpenAfter?.(groupObj);\n\t\t\n\t}\n\n\t_closeGroup(groupObject) {\n\t\tif (groupObject.creating&&!this._closeRepeatedInsertion(groupObject))\n\t\t\treturn false;\n\t\tgroupObject.el.classList.remove(\"open\");\n\t\tthis._ignoreClicksUntil=Date.now()+500;\n\t\tif (groupObject.updateRenderOnClose) {//if group is flagged for having its closed-render updated on close\n\t\t\tdelete groupObject.updateRenderOnClose;//delete the flag so it doesn't get triggered again\n\t\t\tlet cell,renderText;\n\t\t\t//look for ancestor-cell with rowData which repeated rows have. It's a sub-data-row of #data.\n\t\t\t//if we got all the way to the root without finding any repeated-rows then use datarow directly from #data\n\t\t\tfor (cell=groupObject.parent;!cell.dataObj&&cell.parent;cell=cell.parent);//look for ancestor with rowData\n\t\t\trenderText=groupObject.schemaNode.closedRender(groupObject.dataObj);\n\t\t\tgroupObject.el.rows[groupObject.el.rows.length-1].cells[0].innerText=renderText;\n\t\t}\n\t\tgroupObject.schemaNode.onClose?.(groupObject);\n\t\treturn true;\n\t}\n\n\t_repeatInsert(repeated,creating,data,entrySchemaNode=null) {\n\t\t//normally entrySchemaNode should be the entry of repeated, \n\t\t// but schemaNode can be supplied for creating creation-entries\n\t\tentrySchemaNode??=repeated.schemaNode.entry;\n\n\t\tlet indexOfNew,rowIndex;\n\t\tif (!creating&&repeated.schemaNode.sortCompare&&!entrySchemaNode.creator) {\n\t\t\tfor (indexOfNew=0;indexOfNew<repeated.children.length-!!repeated.schemaNode.create; indexOfNew++)\n\t\t\t\tif (repeated.schemaNode.sortCompare(data,repeated.children[indexOfNew].dataObj)<0)\n\t\t\t\t\tbreak;\n\t\t} else\n\t\t\tindexOfNew=repeated.children.length-(repeated.schemaNode.create&&!entrySchemaNode.creator)//pos be4 creator\n\t\tfor (let root=repeated.parent; root.parent; root=root.parent,rowIndex=root.rowIndex);//get main-index\n\t\tlet schemaNode=repeated.schemaNode;\n\t\tif (schemaNode.create&&entrySchemaNode.type===\"group\")\n\t\t\t(schemaNode={...schemaNode}).entry=this._schemaCopyWithDeleteButton(entrySchemaNode,this._repeatedOnDelete);\n\t\t\t//copy repeat-schemaNode not to edit orig.Then add delete-controls to its inner group which also gets copied\n\t\tconst newObj=this._generateCollectionItem(schemaNode.entry,rowIndex,repeated,repeated.path,data,indexOfNew);\n\t\tif (creating) {\n\t\t\tnewObj.creating=true;//creating means it hasn't been commited yet.\n\t\t\tthis._selectFirstSelectableDetailsCell(newObj,true,true);\n\t\t\trepeated.schemaNode.onCreateOpen?.(repeated);\n\t\t}\n\t\treturn newObj.el;\n\t}\n\n\t_changeInstanceNodeIndex(instanceNode,newIndex) {\n\t\tinstanceNode.index=newIndex;\n\t\tconst level=instanceNode.path.length-1;\n\t\tfor (const pathEl of instanceNode.el.parentElement.querySelectorAll('[data-path]')) {\n\t\t\tconst path=pathEl.dataset.path.split(\"-\");\n\t\t\tpath[level]=newIndex;\n\t\t\tpathEl.dataset.path=path.join(\"-\");\n\t\t}\n\t\tfixObjPath(instanceNode,newIndex);\n\t\tfunction fixObjPath(instanceNode) {\n\t\t\tif (instanceNode.path)\n\t\t\t\tinstanceNode.path[level]=newIndex;\n\t\t\tinstanceNode.children?.forEach(fixObjPath);\n\t\t}\n\t}\n\n\t_deleteCell(instanceNode,programatically=false) {\n\t\tlet newSelectedCell;\n\t\tfor (let i=instanceNode.index,otherCell; otherCell=instanceNode.parent.children[++i];)\n\t\t\tthis._changeInstanceNodeIndex(otherCell,i-1)\n\t\tif (instanceNode.parent.children.length>=instanceNode.index+1)\n\t\t\tnewSelectedCell=instanceNode.parent.children[instanceNode.index+1];\n\t\telse if (instanceNode.parent.children.length>1)\n\t\t\tnewSelectedCell=instanceNode.parent.children[instanceNode.index-1];\n\t\tinstanceNode.parent.children.splice(instanceNode.index,1);\n\t\tif (!programatically)\n\t\t\tinstanceNode.parent.dataObj.splice(instanceNode.index,1);\n\t\tif (instanceNode.parent.schemaNode.type===\"repeated\"&&instanceNode.parent.parent.schemaNode.type===\"list\")\n\t\t\tinstanceNode.el.parentElement.parentElement.remove();\n\t\telse\n\t\t\tinstanceNode.el.parentElement.remove();\n\t\tthis._activeDetailsCell=null;//causes problem otherwise when #selectDetailsCell checks old cell\n\t\tif (!programatically)\n\t\t\tthis._selectDetailsCell(newSelectedCell??instanceNode.parent.parent);\n\t\tinstanceNode.creating&&instanceNode.parent.schemaNode.onCreateCancel?.(instanceNode.parent);\n\t}\n\n\t_openTextEdit() {\n\t\tconst input=this._cellCursor.appendChild(document.createElement(\"input\"));\n\n\t\t//for when blurring by clicking outside of table etc. exit edit-mode and commit the change but keep the cell\n\t\t//selected. not sure why the timeout is needed but it is.\n\t\tinput.addEventListener(\"blur\",()=>setTimeout(this._exitEditMode.bind(this,true)));\n\t\t\n\t\tinput.addEventListener(\"change\",()=>this._inputVal=input.value);\n\t\tinput.value=this._selectedCellVal??\"\";\n\t\tif (this._activeSchemaNode.input.format)\n\t\t\tthis._attachInputFormatter(input,this._activeSchemaNode.input.format);\n\t\tinput.focus();\n\t\tif (this._activeSchemaNode.input.maxLength)\n\t\t\tinput.maxLength=this._activeSchemaNode.input.maxLength;\n\t\tinput.placeholder=this._activeSchemaNode.input.placeholder??\"\";\n\t}\n\n\t_mapAdd(map,key,val) {\n\t\tmap.keys.push(key);\n\t\tmap.vals.push(val);\n\t}\n\n\t_mapGet(map,key) {\n\t\tconst index=map.keys.indexOf(key);\n\t\tif (index!=-1)\n\t\t\treturn map.vals[index];\n\t}\n\n\t_mapRemove(map,key) {\n\t\tconst index=map.keys.indexOf(key);\n\t\tmap.keys.splice(index,1);\n\t\tmap.vals.splice(index,1);\n\t}\n\n\n\t/**\n\t * Enter \"file edit mode\" for a file-input cell.\n\t *\n\t * This method is called when the user activates a file-input cell\n\t * (via Enter, double-click, etc). It temporarily replaces the cell\n\t * contents with an interactive file-drop zone that supports:\n\t *\n\t *   - Clicking or pressing Enter/Space to open the system file picker.\n\t *   - Drag-and-drop of a file directly onto the cell.\n\t *   - Visual feedback while dragging a file over the target.\n\t *\n\t * During this mode:\n\t *   - The cell is replaced with a small UI component containing\n\t *     a text prompt and a hidden <input type=\"file\">.\n\t *   - Once a file is selected or dropped, the event is forwarded to\n\t *     #processFileUpload(), which performs the actual upload logic.\n\t *\n\t * After a file is chosen, the edit mode automatically exits and\n\t * the details cell is re-selected.\n\t */\n\t_openFileEdit() {\n\t\twindow.getSelection().empty();\n\t\n\t\tconst fileDiv = this._cellCursor.appendChild(document.createElement(\"div\"));\n\t\tfileDiv.classList.add(\"file\");\n\t\tfileDiv.tabIndex = 0;\n\t\tfileDiv.focus();\n\t\n\t\tconst fileInput = fileDiv.appendChild(document.createElement(\"input\"));\n\t\tfileInput.type = \"file\";\n\t\n\t\tfileDiv.innerHTML = this._opts.lang?.fileChooseOrDrag ?? \"<b>Press to choose a file</b> or drag it here\";\n\t\n\t\tconst dropDiv = fileDiv.appendChild(document.createElement(\"div\"));\n\t\tdropDiv.classList.add(\"drop\");\n\t\tdropDiv.innerHTML = this._opts.lang?.fileDropToUpload ?? \"Drop to upload\";\n\t\n\t\t// Local small handler\n\t\tconst keydown = e => {\n\t\t\tif (e.key === \"Escape\")\n\t\t\t\treturn; // let Tablance handle it\n\t\t\t\n\t\t\te.stopPropagation();\n\t\n\t\t\tif (e.key.startsWith(\"Arrow\"))\n\t\t\t\te.preventDefault();\n\t\t\telse if (e.key === \"Enter\" || e.key === \" \") {\n\t\t\t\te.preventDefault();\n\t\t\t\tfileInput.click();\n\t\t\t}\n\t\t};\n\t\n\t\t// Bind handleFile to preserve `this`\n\t\tconst handleFile = this._processFileUpload.bind(this);\n\t\n\t\t// Events\n\t\tfileDiv.addEventListener(\"keydown\", keydown);\n\t\tfileDiv.addEventListener(\"click\", () => fileInput.click());\n\t\tfileDiv.addEventListener(\"dragenter\", () => dropDiv.style.display = \"block\");\n\t\tdropDiv.addEventListener(\"dragleave\", () => dropDiv.style.display = \"none\");\n\t\tdropDiv.addEventListener(\"dragover\", e => e.preventDefault());\n\t\tfileDiv.addEventListener(\"drop\", e => {\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t\thandleFile(e.dataTransfer.files[0]);\n\t\t});\n\t\tfileInput.addEventListener(\"change\", e => handleFile(e.target.files[0]));\n\t}\n\n\t/**\n\t * Called by #openFileEdit() after the user selects or drops a file.\n\t * Handle the actual upload of a selected file.\n\t *\n\t * This method:\n\t *\n\t *   1. Stores the file as the cell's input value.\n\t *   2. Creates and registers a metadata object for tracking:\n\t *        - uploadedBytes (updated during upload)\n\t *        - progress bars currently displayed for this file\n\t *   3. Initiates an XMLHttpRequest upload and wires up:\n\t *        - upload progress events (to update progress bars)\n\t *        - final load event (to mark completion and clean up metadata)\n\t *   4. Invokes the user-defined fileUploadHandler attached to the\n\t *      cell’s schemaNode, allowing full customization of how the file\n\t *      is handled on the server side.\n\t *   5. Sends the file using multipart/form-data via FormData.\n\t *\n\t * After initiating the upload:\n\t *   - The cell exits edit mode.\n\t *   - The original details cell is automatically re-selected.\n\t *\n\t * This method does not handle UI creation — only the upload workflow\n\t * and progress bookkeeping.\n\t */\n\t_processFileUpload(file) {\n\t\tthis._inputVal = file;\n\t\n\t\tconst meta = Object.assign(Object.create(null), {uploadedBytes: 0,bars: []});\n\t\tthis._mapAdd(this._filesMeta, file, meta);\n\t\n\t\tconst xhr = new XMLHttpRequest();\n\t\n\t\txhr.upload.addEventListener(\"progress\", e => {\n\t\t\tfor (let i = 0; i < meta.bars.length; i++) {\n\t\t\t\tconst bar = meta.bars[i];\n\t\t\t\tif (!bar.isConnected) {\n\t\t\t\t\tmeta.bars.splice(i--, 1);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tmeta.uploadedBytes = e.loaded;\n\t\t\t\tconst pct = parseInt(e.loaded / e.total * 100);\n\t\t\t\tbar.style.width = bar.firstChild.innerText = pct + \"%\";\n\t\t\t}\n\t\t});\n\t\n\t\tthis._activeSchemaNode.input.fileUploadHandler?.(xhr,file,this._activeSchemaNode,this._cellCursorDataObj,\n\t\t\tthis._mainRowIndex,this._activeDetailsCell);\n\t\n\t\txhr.addEventListener(\"load\", () => {\n\t\t\tthis._mapRemove(this._filesMeta, file);\n\t\t\tfor (const bar of meta.bars)\n\t\t\t\tif (bar.isConnected) {\n\t\t\t\t\tbar.parentElement.classList.remove(\"active\");\n\t\t\t\t\tbar.firstChild.innerText = this._opts.lang?.fileUploadDone ?? \"Done!\";\n\t\t\t\t}\n\t\t});\n\t\n\t\tconst formData = new FormData();\n\t\tformData.append(\"file\", file);\n\t\txhr.send(formData);\n\t\n\t\tthis._exitEditMode(true);\n\t\tthis._selectDetailsCell(this._activeDetailsCell);\n\t}\n\t\n\t\n\n\t_openTextAreaEdit() {\n\t\tconst textarea=this._cellCursor.appendChild(document.createElement(\"textarea\"));\n\t\ttextarea.addEventListener('input', this._autoTextAreaResize.bind(this));\n\n\t\t{\tconst {paddingLeft,paddingRight,paddingTop,paddingBottom}=window.getComputedStyle(this._selectedCell);\n\t\t\t//add the padding of the cell to the textarea for consistency\n\t\t\tObject.assign(textarea.style,{paddingLeft,paddingRight,paddingTop,paddingBottom});}\n\t\t\n\t\ttextarea.value=this._selectedCellVal??\"\";\n\t\ttextarea.addEventListener(\"keydown\",keydown.bind(this));\n\t\ttextarea.focus();\n\t\ttextarea.addEventListener(\"change\",_e=>this._inputVal=textarea.value);\n\t\tif (this._activeSchemaNode.input.maxLength)\n\t\t\ttextarea.maxLength=this._activeSchemaNode.input.maxLength;\n\t\ttextarea.placeholder=this._activeSchemaNode.input.placeholder??\"\";\n\t\tfunction keydown(e) {\n\t\t\tif (e.key===\"Enter\"&&e.ctrlKey) {\n\t\t\t\tthis._insertAtCursor(textarea,\"\\r\\n\");\n\t\t\t\ttextarea.dispatchEvent(new Event('input'));//trigger input so that autoTextAreaResize gets called\n\t\t\t\te.stopPropagation();\n\t\t\t} else if (e.key===\"Escape\") {\n\t\t\t\ttextarea.value=this._selectedCellVal??\"\";\n\t\t\t\ttextarea.dispatchEvent(new Event('input'));\n\t\t\t}\n\t\t}\n\t}\n\n\t\t/**\n\t * Render all select options into a given <ul> and update highlighted indices if the selected value is found.\n\t * @param {HTMLUListElement} ul\n\t * @param {Array} opts\n\t * @param {*} selectedVal\n\t * @param {Object} ctx\n\t * @returns {boolean} true if the selected option was found among opts\n\t */\n\t\t_renderSelectOptions(ul,opts,selectedVal,ctx) {\n\t\t\tlet foundSelected=false;\n\t\t\tul.innerHTML=\"\";\n\t\t\tfor (const opt of opts) {\n\t\t\t\tconst li=ul.appendChild(document.createElement(\"li\"));\n\t\t\t\tif (opt.cssClass)\n\t\t\t\t\tli.className=opt.cssClass;\n\t\t\t\tli.innerText=opt.text;\n\t\t\t\tif (selectedVal==opt) {\n\t\t\t\t\tfoundSelected=true;\n\t\t\t\t\tli.classList.add(\"selected\",\"highlighted\");\n\t\t\t\t\tctx.highlightLiIndex=ul.children.length-1;\n\t\t\t\t\tctx.highlightUlIndex=parseInt(ul.dataset.ulIndex);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn foundSelected;\n\t\t}\n\t\n\t\t/**\n\t\t * Highlight a specific option in one of the ULs and optionally scroll it into view when keyboard navigating.\n\t\t * @param {Object} ctx\n\t\t * @param {number} ulIndex 0 for pinned, 1 for main\n\t\t * @param {number} liIndex index within the selected UL\n\t\t * @param {boolean} keyboardNavigating whether the change came from arrow keys\n\t\t */\n\t\t_highlightSelectOption(ctx,ulIndex,liIndex,keyboardNavigating) {\n\t\t\tconst highlighted=ctx.ulDiv.getElementsByClassName(\"highlighted\")[0];\n\t\t\tif (highlighted)\n\t\t\t\thighlighted.classList.remove(\"highlighted\");\n\t\t\tconst ul=ctx.ulDiv.children[ctx.highlightUlIndex=ulIndex];\n\t\t\tconst li=ul.children[ctx.highlightLiIndex=liIndex];\n\t\t\tif (!li)\n\t\t\t\treturn;\n\t\t\tli.classList.add(\"highlighted\");\n\t\t\tif (ulIndex&&keyboardNavigating)\n\t\t\t\tul.scrollTop=li.offsetTop-ul.offsetTop+li.offsetHeight/2-ul.offsetHeight/2;\n\t\t}\n\t\n\t\t/**\n\t\t * Filter loose options based on the current input value and update rendered lists and create-option state.\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectInputChange(ctx) {\n\t\t\tconst value=ctx.input.value;\n\t\t\tconst hadFilter=!!ctx.filterText;\n\t\t\tconst filterChangedAtEdges=!value.includes(ctx.filterText)||!hadFilter;\n\t\t\tctx.canCreate=!!value;\n\t\t\tif (filterChangedAtEdges)\n\t\t\t\tctx.looseOpts.splice(0,Infinity,...ctx.strctInp.options);\n\t\t\tfor (let i=-1,opt; opt=ctx.looseOpts[++i];)\n\t\t\t\tif (!opt.text.includes(value)||opt.pinned)\n\t\t\t\t\tctx.looseOpts.splice(i--,1);\n\t\t\t\telse if (opt.text.toLowerCase()==value.toLowerCase())\n\t\t\t\t\tctx.canCreate=false;\n\t\t\tthis._updateCreateOptionVisibility(ctx);\n\t\t\tconst foundSelected=this._renderSelectOptions(ctx.mainUl,ctx.looseOpts,this._inputVal,ctx);\n\t\t\tif (foundSelected)\n\t\t\t\tctx.pinnedUl.querySelector(\".highlighted\")?.classList.remove(\"highlighted\");\n\t\t\telse if (ctx.highlightUlIndex) {\n\t\t\t\tif (ctx.looseOpts.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,1,0,true);\n\t\t\t\telse if (ctx.pinnedUl.children.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,0,0,true);\n\t\t\t}\n\t\t\tctx.noResults.style.display=ctx.looseOpts.length?\"none\":\"block\";\n\t\t\tctx.filterText=value;\n\t\t\tif (ctx.creationLi)\n\t\t\t\tctx.creationLi.innerText=`Create [${ctx.filterText}]`;\n\t\t}\n\t\n\t\t/**\n\t\t * Show or hide the \"create new option\" list item depending on ctx.canCreate and current DOM state.\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_updateCreateOptionVisibility(ctx) {\n\t\t\tif (!ctx.creationLi)\n\t\t\t\treturn;\n\t\t\tif (ctx.canCreate) {\n\t\t\t\tif (ctx.creationLi.parentElement!=ctx.pinnedUl)\n\t\t\t\t\tctx.pinnedUl.appendChild(ctx.creationLi);\n\t\t\t} else if (ctx.creationLi.parentElement==ctx.pinnedUl)\n\t\t\t\tctx.pinnedUl.removeChild(ctx.creationLi);\n\t\t}\n\t\n\t\t/**\n\t\t * Handle keyboard navigation and selection inside the open select dropdown.\n\t\t * @param {KeyboardEvent} e\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectKeyDown(e,ctx) {\n\t\t\tif (e.key===\"ArrowDown\"||e.key===\"ArrowUp\") {\n\t\t\t\te.preventDefault();\n\t\t\t\tconst direction=e.key===\"ArrowDown\"?1:-1;\n\t\t\t\tconst currentIndex=ctx.highlightLiIndex==null?0:ctx.highlightLiIndex;\n\t\t\t\tconst newIndex=currentIndex+direction;\n\t\t\t\tif (ctx.highlightUlIndex??true) {\n\t\t\t\t\tif (ctx.looseOpts.length&&newIndex<ctx.looseOpts.length&&newIndex>=0)\n\t\t\t\t\t\tthis._highlightSelectOption(ctx,1,newIndex,true);\n\t\t\t\t\telse if (newIndex==-1&&ctx.pinnedUl.children.length)\n\t\t\t\t\t\tthis._highlightSelectOption(ctx,0,ctx.pinnedUl.children.length-1,true);\n\t\t\t\t} else if (newIndex>=0&&newIndex<ctx.pinnedUl.children.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,0,newIndex,true);\n\t\t\t\telse if (newIndex>=ctx.pinnedUl.children.length&&ctx.looseOpts.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,1,0,true);\n\t\t\t} else if (e.key===\"Enter\") {\n\t\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t\t\tthis._moveCellCursor(0,e.shiftKey?-1:1);\n\t\t\t\te.stopPropagation();\n\t\t\t} else if (e.key===\"Escape\")\n\t\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t}\n\t\n\t\t/**\n\t\t * Handle mouse movement over list items by updating the highlighted option.\n\t\t * @param {MouseEvent} e\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectMouseMove(e,ctx) {\n\t\t\tconst li=e.target.closest(\"li\");\n\t\t\tif (!li)\n\t\t\t\treturn;\n\t\t\tconst ul=li.parentNode;\n\t\t\tconst ulIndex=parseInt(ul.dataset.ulIndex);\n\t\t\tconst liIndex=[...ul.children].indexOf(li);\n\t\t\tthis._highlightSelectOption(ctx,ulIndex,liIndex,false);\n\t\t}\n\t\n\t\t/**\n\t\t * Handle mouse click on a list item: select it, close the dropdown and exit edit mode.\n\t\t * @param {MouseEvent} e\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectClick(e,ctx) {\n\t\t\tconst li=e.target.closest(\"li\");\n\t\t\tif (!li)\n\t\t\t\treturn;\n\t\t\tconst ul=e.currentTarget;\n\t\t\tctx.highlightUlIndex=parseInt(ul.dataset.ulIndex);\n\t\t\tctx.highlightLiIndex=Array.prototype.indexOf.call(ul.children,li);\n\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t\tthis._exitEditMode(true);\n\t\t}\n\t\n\t\t/**\n\t\t * Create base DOM structure and context object for the select dropdown.\n\t\t * Splits options into pinned/loose arrays and prepares elements but does not attach listeners.\n\t\t * @param {Object} strctInp the input-definition object from the active cell schemaNode\n\t\t * @returns {Object} ctx a state container for the open select dropdown\n\t\t */\n\t\t_createSelectDropdownContext(strctInp) {\n\t\t\tconst selectContainer=document.createElement(\"div\");\n\t\t\tconst pinnedOpts=[];\n\t\t\tconst looseOpts=[];\n\t\t\tconst inputWrapper=selectContainer.appendChild(document.createElement(\"div\"));\n\t\t\tconst input=inputWrapper.appendChild(document.createElement(\"input\"));\n\t\t\tinputWrapper.classList.add(\"input-wrapper\");\n\t\t\tconst ulDiv=selectContainer.appendChild(document.createElement(\"div\"));\n\t\t\tconst pinnedUl=ulDiv.appendChild(document.createElement(\"ul\"));\n\t\t\tpinnedUl.classList.add(\"pinned\");\n\t\t\tconst mainUl=ulDiv.appendChild(document.createElement(\"ul\"));\n\t\t\tmainUl.classList.add(\"main\");\n\t\t\tconst noResults=selectContainer.appendChild(document.createElement(\"div\"));\n\t\t\tnoResults.innerHTML=strctInp.noResultsText??this._opts.lang?.selectNoResultsFound??\"No results found\";\n\t\t\tnoResults.className=\"no-results\";\n\t\t\tfor (const opt of strctInp.options)\n\t\t\t\t(opt.pinned?pinnedOpts:looseOpts).push(opt);\n\t\t\tconst ctx=Object.assign(Object.create(null),{\n\t\t\t\tstrctInp,\n\t\t\t\tselectContainer,\n\t\t\t\tinputWrapper,\n\t\t\t\tinput,\n\t\t\t\tulDiv,\n\t\t\t\tpinnedUl,\n\t\t\t\tmainUl,\n\t\t\t\tnoResults,\n\t\t\t\tpinnedOpts,\n\t\t\t\tlooseOpts,\n\t\t\t\tcreationLi:null,\n\t\t\t\tcanCreate:false,\n\t\t\t\tfilterText:\"\",\n\t\t\t\thighlightLiIndex:null,\n\t\t\t\thighlightUlIndex:null,\n\t\t\t\twindowMouseDown:null\n\t\t\t});\n\t\t\treturn ctx;\n\t\t}\n\t\n\t\t/**\n\t\t * Close the select dropdown, update the current value (including create-new if applicable) \n\t\t * and clean up listeners.\n\t\t * @param {Object} ctx\n\t\t * @param {Event} e the event that triggered the close (click, keydown, etc.)\n\t\t */\n\t\t_closeSelectDropdown(ctx,e) {\n\t\t\tif (!ctx.selectContainer.parentElement)\n\t\t\t\treturn;\n\t\t\tif (!ctx.highlightUlIndex&&ctx.pinnedUl.children[ctx.highlightLiIndex]?.dataset.type==\"create\") {\n\t\t\t\tctx.filterText=ctx.filterText??ctx.input.value;\n\t\t\t\tthis._inputVal={text:ctx.filterText};\n\t\t\t\tctx.strctInp.options.push(this._inputVal);\n\t\t\t\tctx.strctInp.createNewOptionHandler?.(this._inputVal,e,this._cellCursorDataObj,this._mainRowIndex\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,this._activeSchemaNode,this._activeDetailsCell);\n\t\t\t} else\n\t\t\t\tthis._inputVal=(ctx.highlightUlIndex?ctx.looseOpts:ctx.pinnedOpts)[ctx.highlightLiIndex];\n\t\t\tctx.selectContainer.remove();\n\t\t\tif (ctx.windowMouseDown)\n\t\t\t\twindow.removeEventListener(\"mousedown\",ctx.windowMouseDown);\n\t\t}\n\t\n\t\t/**\n\t\t * Open edit mode for a cell that uses a select-input: creates the dropdown UI,\n\t\t * wires up filtering, keyboard navigation and mouse interaction, and focuses the input.\n\t\t */\n\t\t_openSelectEdit() {\n\t\t\tconst strctInp=this._activeSchemaNode.input;\n\t\t\tthis._inputVal=this._cellCursorDataObj[this._activeSchemaNode.id];\n\t\t\tconst ctx=this._createSelectDropdownContext(strctInp);\n\t\t\tthis._cellCursor.style.backgroundColor=\"transparent\";\n\t\t\tconst allowCreateNew=strctInp.allowCreateNew;\n\t\t\tif (allowCreateNew||ctx.looseOpts.length>=(strctInp.minOptsFilter??this._opts.defaultMinOptsFilter??5))\n\t\t\t\tctx.input.addEventListener(\"input\",()=>this._handleSelectInputChange(ctx));\n\t\t\telse\n\t\t\t\tctx.inputWrapper.classList.add(\"hide\");\n\t\t\tctx.input.addEventListener(\"keydown\",e=>this._handleSelectKeyDown(e,ctx));\n\t\t\tctx.input.placeholder=strctInp.selectInputPlaceholder??\"\";\n\t\t\tctx.input.addEventListener(\"blur\",ctx.input.focus);\n\t\t\tfor (let i=-1,ul;ul=[ctx.pinnedUl,ctx.mainUl][++i];) {\n\t\t\t\tul.dataset.ulIndex=i;\n\t\t\t\tul.addEventListener(\"mousemove\",e=>this._handleSelectMouseMove(e,ctx));\n\t\t\t\tul.addEventListener(\"click\",e=>this._handleSelectClick(e,ctx));\n\t\t\t}\n\t\t\tif (strctInp.allowCreateNew) {\n\t\t\t\tctx.creationLi=document.createElement(\"li\");\n\t\t\t\tctx.creationLi.dataset.type=\"create\";\n\t\t\t}\n\t\t\tthis._renderSelectOptions(ctx.pinnedUl,ctx.pinnedOpts,this._inputVal,ctx);\n\t\t\tthis._renderSelectOptions(ctx.mainUl,ctx.looseOpts,this._inputVal,ctx);\n\t\t\tthis._cellCursor.parentElement.appendChild(ctx.selectContainer);\n\t\t\tctx.selectContainer.className=\"tablance-select-container\";\n\t\t\tthis._alignDropdown(ctx.selectContainer);\n\t\t\tconst windowMouseDown=e=>{\n\t\t\t\tlet el=e.target;\n\t\t\t\twhile (el&&el!=ctx.selectContainer)\n\t\t\t\t\tel=el.parentElement;\n\t\t\t\tif (!el) {\n\t\t\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t\t\t\tthis._exitEditMode(false);\n\t\t\t\t}\n\t\t\t};\n\t\t\tctx.windowMouseDown=windowMouseDown;\n\t\t\twindow.addEventListener(\"mousedown\",windowMouseDown);\n\t\t\tctx.input.focus();\n\t\t}\n\t\n\n\t_validateInput(newVal) {\n\t\tlet message;\n\t\tconst input=this._cellCursor.querySelector(\"input\");\n\t\tconst doCommit=this._activeSchemaNode.input.validation(newVal,m=>message=m,this._activeSchemaNode\n\t\t\t\t\t\t\t\t\t\t\t\t,this._cellCursorDataObj,this._mainRowIndex,this._activeDetailsCell);\n\t\tif (doCommit)\n\t\t\treturn true;\n\t\tinput.focus();\n\t\tif (message)\n\t\t\tthis._showTooltip(message);\n\t}\n\n\t/**\n\t * Updates dependent cells when a cell's value changes.\n\t *\n\t * This method propagates changes from a modified cell to its dependent cells,\n\t * ensuring that the dependent cells are updated accordingly. It traverses the\n\t * hierarchical structure of cells and updates both details cells and main-row\n\t * cells as needed.\n\t *\n\t * @param {Object} editedCellSchemaNode - The schema-node of the cell that was edited.\n\t * @param {Object} [editedInstanceNode] - The instance-node representing the edited cell. This is used to determine\n\t *                                   the closest scope for dependency updates.\n\t */\n\t_updateDependentCells(editedCellSchemaNode, editedInstanceNode) {\n\t\tfor (const depPath of editedCellSchemaNode.dependencyPaths??[])\n\t\t\tif (depPath[0]===\"m\") {//if cell is in main row cell\n\t\t\t\t// Find the corresponding table row for the main data row\n\t\t\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${this._mainRowIndex}\"]:not(.details)`);\n\t\t\t\t// Update the content of the dependent cell in the main table\n\t\t\t\tthis._updateMainRowCell(tr.cells[depPath[1]], this._colSchemaNodes[depPath[1]]);\n\t\t\t} else if (this._openDetailsPanes[this._mainRowIndex]) {//if cell is in details and details is open\n\t\t\t\t//cells is an array that potentially can hold more than 1 cell. The reason is that when going into\n\t\t\t\t//repeated structures, it \"splits\" into multiple cells if there are multiple repeated-entries/instances\n\t\t\t\tlet cells=depPath[0]===\"r\"?[editedInstanceNode]:[this._openDetailsPanes[this._mainRowIndex]];\n\n\t\t\t\tfor (var step=1; depPath[step]===\"..\"; step++)//if there are any, iterate all the \"..\"\n\t\t\t\t\tcells[0] = cells[0].parent;//go up one level per \"..\". At this point cells will only have one cell\n\n\t\t\t\tfor (; step<depPath.length; step++) {//iterate the steps\n\t\t\t\t\tif (cells[0].schemaNode.type===\"repeated\") {\n\t\t\t\t\t\tconst newCells=[];//will hold the new set of cells after this step\n\t\t\t\t\t\tfor (const cell of cells)\n\t\t\t\t\t\t\tnewCells.push(...cell.children);//add all repeated-children of current cell\n\t\t\t\t\t\tcells=newCells;//set cells to the new set of cells\n\t\t\t\t\t}\n\t\t\t\t\tfor (let cellI=0; cellI<cells.length; cellI++)//iterate the cell(s)\n\t\t\t\t\t\tcells[cellI]=cells[cellI].children[depPath[step]];//and do the step\n\t\t\t\t}\n\t\t\t\tfor (const cell of cells)//iterate the cell(s) again\n\t\t\t\t\tthis._updateDetailsCell(cell,cell.dataObj);//and do the actual update\n\t\t\t}\n\t}\n\n\t_exitEditMode(save) {\n\t\tif (!this._inEditMode)\n\t\t\treturn true;\t\n\t\tconst input=this._cellCursor.querySelector(\"input\");\n\t\tif (this._activeSchemaNode.input.format?.stripDelimiterOnSave&&this._activeSchemaNode.input.format.delimiter)\n\t\t\tinput.value=input.value.replaceAll(this._activeSchemaNode.input.format.delimiter, \"\");\n\t\tif (this._activeSchemaNode.input.validation&&save&&!this._validateInput(input.value))\n\t\t\treturn false;\n\t\t//make the table focused again so that it accepts keystrokes and also trigger any blur-event on input-element\n\t\tthis.rootEl.focus({preventScroll:true});//so that #inputVal gets updated-\n\n\n\t\tthis._inEditMode=false;\n\t\tthis._cellCursor.classList.remove(\"edit-mode\");\n\t\tif (save&&this._inputVal!=this._selectedCellVal) {\n\t\t\tthis._doEditSave();\n\t\t}\n\t\tthis._cellCursor.innerHTML=\"\";\n\t\t//if (this._activeSchemaNode.input.type===\"textarea\")//also needed for file..\n\t\tthis._adjustCursorPosSize(this._selectedCell);\n\t\tthis._highlightOnFocus=false;\n\t\treturn true;\n\t}\n\n\t_showTooltip(message,target=this._cellCursor) {\n\t\tthis._cellCursor.parentElement.appendChild(this._tooltip);\n\t\tsetTimeout(()=>this._tooltip.style.visibility=\"visible\");//set it on a delay because mouseDownHandler might\n\t\t\t\t\t\t//otherwise immediately set it back to hidden when bubbling up depending on where the click was\n\t\tthis._tooltip.firstChild.innerText=message;\n\t\tthis._alignDropdown(this._tooltip,target);\n\t\tthis._scrollElementIntoView(this._tooltip);\n\t\treturn true;\n\t}\n\n\t_scrollElementIntoView(){}//default is to do nothing. Tablance (main) overrides this.\n\n\t_closeRepeatedInsertion(repeatEntry) {\n\t\tif (Object.values(repeatEntry.dataObj).filter(x=>x!=null).length) {\n\t\t\tlet message;//message to show to the user if creation was unsucessful\n\t\t\tfor (var root=repeatEntry; root.parent; root=root.parent);//get root-object in order to retrieve rowIndex\n\t\t\tlet doCreate=true;\n\t\t\tif (repeatEntry.schemaNode.creationValidation)\n\t\t\t\tdoCreate=repeatEntry.schemaNode.creationValidation(m=>message=m,repeatEntry.schemaNode\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,repeatEntry.dataObj,root.rowIndex,repeatEntry);\n\t\t\tif (!doCreate) {\n\t\t\t\tif (message)\n\t\t\t\t\tthis._showTooltip(message,repeatEntry.el);\n\t\t\t\treturn false;//prevent commiting/closing the group\n\t\t\t}\n\t\t\trepeatEntry.creating=false;\n\t\t\tconst creationContainer=repeatEntry.schemaNode.type==\"group\"?repeatEntry:repeatEntry.parent;\n\t\t\tcreationContainer.schemaNode.onCreate?.\n\t\t\t\t\t\t\t(repeatEntry.dataObj,this._data[root.rowIndex],creationContainer.schemaNode,repeatEntry);\n\t\t} else {\n\t\t\tthis._deleteCell(repeatEntry);\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\t_closeActiveDetailsCell() {\n\t\tif (this._activeDetailsCell) {\n\t\t\tfor (let oldCellParent=this._activeDetailsCell; oldCellParent=oldCellParent.parent;) {\n\t\t\t\tif (oldCellParent.schemaNode.type===\"group\") {\n\t\t\t\t\tif (!this._closeGroup(oldCellParent))//close any open group above old cell\n\t\t\t\t\t\treturn false;\n\t\t\t\t\tthis._ignoreClicksUntil=Date.now()+500;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\toldCellParent.schemaNode.onBlur?.(oldCellParent,this._mainRowIndex);\n\t\t\t}\n\t\t\tthis._activeDetailsCell=null;//should be null when not inside details\n\t\t}\n\t\treturn true;\n\t}\n\n\n\t_selectMainTableCell(cell) {\n\t\tif (!cell)\t//in case of trying to move up from top row etc,\n\t\t\treturn;\n\t\tif (!this._exitEditMode(true))//try to exit-mode and commit any changes.\n\t\t\treturn false;//if exiting edit-mode was denied then do nothing more\n\t\t\t\n\t\t\n\t\tthis._mainColIndex=cell.cellIndex;\n\t\tconst mainRowIndex=parseInt(cell.parentElement.dataset.dataRowIndex);//save it here rather than setting it \n\t\t\t\t\t//directly because we do not want it to change if #selectCell returns false, preventing the select\n\t\t\t\t\t\n\t\tif (this._closeActiveDetailsCell()) {\n\t\t\tthis._selectCell(cell,this._colSchemaNodes[this._mainColIndex],this._data[mainRowIndex]);\n\t\t\tthis._mainRowIndex=mainRowIndex;\n\t\t}\n\t}\n\n\t_selectDetailsCell(instanceNode) {\n\t\tif (!this._exitEditMode(true))//try to exit-mode and commit any changes.\n\t\t\treturn false;//if exiting edit-mode was denied then do nothing more\n\n\t\tconst oldExpCell=this._activeDetailsCell;//need to know the current/old details-cell if any for closing groups\n\t\t\t\t\t//etc but we can't just use this._activeDetailsCell because #selectCell changes it and we do want\n\t\t\t\t\t//to call #selectCell first in order to know if changing cell is being prevented by validation()\n\n\t\tfor (var root=instanceNode; root.parent; root=root.parent);\n\t\tconst mainRowIndex=root.rowIndex;\n\t\tif (oldExpCell)//changing from an old detailsCell\n\t\t\tfor (let oldParnt=oldExpCell; oldParnt=oldParnt?.parent;)//traverse parents of old cell\n\t\t\t\tif(oldParnt.schemaNode.type===\"group\"||oldParnt.schemaNode.onBlur||oldParnt.creating){//found group/cell\n\t\t\t\t\t//...with onBlur or cell that is being created. For any of these we want to observe the cell being\n\t\t\t\t\t//left so that appropriate action can be taken\n\t\t\t\t\tfor (let newParent=instanceNode; newParent=newParent.parent;)//traverse parents of new cell\n\t\t\t\t\t\tif (newParent===oldParnt) {//if this new parent-group is also part of old parents\n\t\t\t\t\t\t\toldParnt=null;//break out of outer loop\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\tif (oldParnt) {\n\t\t\t\t\t\tif (oldParnt.schemaNode.type===\"group\"&&!this._closeGroup(oldParnt))\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\tif (oldParnt.schemaNode.onBlur)\n\t\t\t\t\t\t\toldParnt.schemaNode.onBlur?.(oldParnt,mainRowIndex);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\tthis._selectCell(instanceNode.selEl??instanceNode.el,instanceNode.schemaNode,instanceNode.dataObj,false);\n\t\tthis._mainRowIndex=mainRowIndex;\n\n\t\t//in case this was called via instanceNode.select() it might be necessary to make sure parent-groups are open\n\t\tfor (let parentCell=instanceNode; parentCell=parentCell.parent;)\n\t\t\tif (parentCell.schemaNode.type==\"group\")\n\t\t\t\tparentCell.el.classList.add(\"open\");\n\n\t\tthis._adjustCursorPosSize(instanceNode.selEl??instanceNode.el);\n\t\tthis._activeDetailsCell=instanceNode;\n\t\treturn instanceNode;\n\t}\n\n\t_selectCell(cellEl,schemaNode,dataObj,adjustCursorPosSize=true) {\n\t\tthis.rootEl.focus({preventScroll:true});\n\t\tif (adjustCursorPosSize)\n\t\t\tthis._adjustCursorPosSize(cellEl);\n\t\tthis._cellCursor.classList.toggle(\"details\",cellEl.closest(\".details\"));\n\t\tthis._cellCursor.classList.toggle(\"disabled\",cellEl.classList.contains(\"disabled\"));\n\t\t(this._scrollingContent??this.rootEl).appendChild(this._cellCursor);\n\t\tthis._selectedCell=cellEl;\n\t\tthis._activeSchemaNode=schemaNode;\n\t\t//make cellcursor click-through if it's on an expand-row-button-td, select-row-button-td or button\n\t\tconst noPtrEvent=schemaNode.type===\"expand\"||schemaNode.type===\"select\"||schemaNode.input?.type===\"button\";\n\t\tthis._cellCursor.style.pointerEvents=noPtrEvent?\"none\":\"auto\";\n\t\tthis._cellCursor.style.removeProperty(\"background-color\");//select-input sets it to transparent, revert here\n\t\tthis._cellCursorDataObj=dataObj;\n\t\tthis._selectedCellVal=dataObj?.[schemaNode.id];\n\t}\n\n\t_getElPos(el,container) {\n\t\tconst cellPos=el.getBoundingClientRect();\n\t\tif (!container)\n\t\t\tcontainer=this._tableSizer??this.rootEl;\n\t\tconst contPos=container.getBoundingClientRect();\n\t\treturn {x:cellPos.x-contPos.x, y:cellPos.y-contPos.y+(this._tableSizer?.offsetTop??0)}\n\t}\n\n\t_adjustCursorPosSize(el,onlyPos=false) {\n\t\tif (!el)\n\t\t\treturn;\n\t\tconst elPos=this._getElPos(el);\n\t\tthis._cellCursor.style.top=elPos.y+\"px\";\n\t\tthis._cellCursor.style.left=elPos.x+\"px\";\n\t\tthis._cellCursor.style.display=\"block\";//it starts at display none since #setupSpreadsheet, so make visible now\n\t\tif (!onlyPos) {\n\t\t\tthis._cellCursor.style.height=el.offsetHeight+\"px\";\n\t\t\tthis._cellCursor.style.width=el.offsetWidth+\"px\";\n\t\t}\n\t}\n\n\t_createTableHeader() {\n\t\tthis._headerTable=this.rootEl.appendChild(document.createElement(\"table\"));\n\t\tthis._headerTable.classList.add(\"header-table\");\n\t\tconst thead=this._headerTable.appendChild(document.createElement(\"thead\"));\n\t\tthis._headerTr=thead.insertRow();\n\t\tfor (let col of this._colSchemaNodes) {\n\t\t\tlet th=this._headerTr.appendChild(document.createElement(\"th\"));\n\t\t\tth.addEventListener(\"click\",e=>this._onThClick(e));\n\t\t\tif (col.type==\"select\") {\n\t\t\t\tth.appendChild(this._createCheckbox());\n\t\t\t\tth.classList.add(\"select-col\");\n\t\t\t} else if (col.type==\"expand\") {\n\t\t\t\tconst expandDiv=th.appendChild(document.createElement(\"div\"));\n\t\t\t\texpandDiv.classList.add(\"expand-div\");//used to identify if expand-button was clicked in click-handler\n\t\t\t\t//expandDiv.appendChild(this._createExpandContractButton());//functionality not fully implemented yet\n\t\t\t\tth.classList.add(\"expand-col\");\n\t\t\t} else\n\t\t\t\tth.innerText=col.title??\"\\xa0\";//non breaking space if nothing else or else\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//sorting arrows wont be positioned correctly\n\n\t\t\t//create the divs used for showing html for sorting-up/down-arrow or whatever has been configured\n\t\t\tcol.sortDiv=th.appendChild(document.createElement(\"DIV\"));\n\t\t\tcol.sortDiv.className=\"sortSymbol\";\n\t\t}\n\t\tthis._headerTr.appendChild(document.createElement(\"th\"));\n\t}\n\n\t_onThClick(e) {\n\t\tconst clickedIndex=e.currentTarget.cellIndex;\n\t\tif (this._colSchemaNodes[clickedIndex].type==\"select\"&&e.target.tagName.toLowerCase()==\"input\")\n\t\t\treturn this._toggleRowsSelected(e.target.checked,0,this._data.length-1);\n\t\tif (e.target.closest(\".expand-div\"))\n\t\t\treturn this._expandOrContractAll(!e.target.closest(\"tr\").classList.contains(\"expanded\"));\n\t\tlet sortingColIndex=-1,sortingCol;\n\t\twhile (sortingCol=this._sortingCols[++sortingColIndex]) {\n\t\t\tif (sortingCol.index===clickedIndex) {\n\t\t\t\tif (e.shiftKey&&this._sortingCols.length>1&&sortingCol.order==\"desc\") {\n\t\t\t\t\tthis._sortingCols.splice(sortingColIndex,1);\n\t\t\t\t\tsortingColIndex=0;//to not make condition below loop fall true\n\t\t\t\t} else\n\t\t\t\t\tsortingCol.order=sortingCol.order==\"asc\"?\"desc\":\"asc\";\n\t\t\t\tif (!e.shiftKey)\n\t\t\t\t\tthis._sortingCols=[sortingCol];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (sortingColIndex==this._sortingCols.length) {//if the clicked header wasn't sorted upon at all\n\t\t\tconst {id,type}=this._colSchemaNodes[clickedIndex];\n\t\t\tconst sortCol={id,type,order:\"asc\",index:clickedIndex};\n\t\t\tif (!e.shiftKey)\n\t\t\t\tthis._sortingCols=[];\n\t\t\tthis._sortingCols.push(sortCol);\n\t\t}\n\t\tthis._updateHeaderSortHtml();\n\t\te.preventDefault();//prevent text-selection when shift-clicking and double-clicking\n\t\tthis._sortData();\n\t\tthis._refreshTable();\n\t}\n\n\t_expandOrContractAll(expand) {\n\t\tthis._scrollBody.scrollTop=0;\n\t\tthis._scrollMethod();\n\t\tlet rows;\n\t\tif (expand) {\n\t\t\trows=this._tableSizer.querySelectorAll(\".main-table>tbody>tr:not(.details):not(.expanded)\");\n\t\t\tfor (const row of rows)\n\t\t\t\tthis._expandRow(row);\n\t\t\tfor (const dataRow of this._data) {\n\t\t\t\tconst index=this._rowsMeta.keys.indexOf(dataRow);\n\t\t\t\tif (index!=-1) {\n\t\t\t\t\tthis._rowsMeta.vals[index].h??=-1;\n\t\t\t\t} else {\n\t\t\t\t\tthis._rowsMeta.keys.push(dataRow);\n\t\t\t\t\tthis._rowsMeta.vals.push({h:-1});\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t\t\n\n\t\t//#expandRow(tr,dataRowIndex) {\n\t}\n\n\t_updateHeaderSortHtml() {\n\t\tfor (let [thIndex,th] of Object.entries(this._headerTr.cells)) {\n\t\t\tif (thIndex==this._headerTr.cells.length-1)\n\t\t\t\tbreak;\n\t\t\tlet order=null;\n\t\t\tlet sortDiv=this._colSchemaNodes[thIndex].sortDiv;\n\t\t\tfor (let sortingCol of this._sortingCols) {\n\t\t\t\tif (sortingCol.index==thIndex) {\n\t\t\t\t\torder=sortingCol.order;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!order||th.classList.contains(order==\"asc\"?\"desc\":\"asc\"))\n\t\t\t\tth.classList.remove(\"asc\",\"desc\");\n\t\t\tif (order) {\n\t\t\t\tth.classList.add(order);\n\t\t\t\tsortDiv.innerHTML=(order==\"asc\"?this._opts?.sortAscHtml:this._opts?.sortDescHtml)??\"\";\n\t\t\t} else\n\t\t\t\tsortDiv.innerHTML=this._opts?.sortNoneHtml??\"\";\n\t\t}\n\t}\n\n\t_sortData() {\n\t\tconst sortCols=this._sortingCols;\n\t\tif (!sortCols.length)\n\t\t\treturn false;\n\t\tthis._data.sort(compare.bind(this));\n\t\tif (this._mainRowIndex>=0)//if there is a selected row\n\t\t\tthis._mainRowIndex=this._data.indexOf(this._cellCursorDataObj);//then find it's new pos\n\t\treturn true;\n\t\t\n\t\tfunction compare(a,b) {\n\t\t\tfor (let sortCol of sortCols) {\n\t\t\t\tif (sortCol.type===\"expand\") {\n\t\t\t\t\tlet aV;\n\t\t\t\t\tif ((aV=!!this._rowMetaGet(this._data.indexOf(a))?.h)!=!!this._rowMetaGet(this._data.indexOf(b))?.h)\n\t\t\t\t\t\treturn (aV?-1:1)*(sortCol.order==\"asc\"?1:-1);\n\t\t\t\t} else if (sortCol.type===\"select\") {\n\t\t\t\t\tlet aSel;\n\t\t\t\t\tif ((aSel=this._selectedRows.indexOf(a)!=-1)!=(this._selectedRows.indexOf(b)!=-1))\n\t\t\t\t\t\treturn (aSel?-1:1)*(sortCol.order==\"asc\"?1:-1);\n\t\t\t\t} else if (a[sortCol.id]!=b[sortCol.id])\n\t\t\t\t\treturn (a[sortCol.id]>b[sortCol.id]?1:-1)*(sortCol.order==\"asc\"?1:-1);\n\t\t\t}\n\t\t}\n\t}\n\n\t_createTableBody() {\n\t\tthis._scrollBody=this.rootEl.appendChild(document.createElement(\"div\"));\n\n\t\tif (this._staticRowHeight&&!this.schema.details)\n\t\t\tthis._scrollMethod=this._onScrollStaticRowHeightNoDetails;\n\t\telse if (this._staticRowHeight&&this.schema.details)\n\t\t\tthis._scrollMethod=this._onScrollStaticRowHeightDetails;\n\t\tthis._scrollBody.addEventListener(\"scroll\",e=>this._scrollMethod(e),{passive:true});\n\t\tthis._scrollBody.className=\"scroll-body\";\n\t\t\n\t\tthis._scrollingContent=this._scrollBody.appendChild(document.createElement(\"div\"));\n\t\tthis._scrollingContent.className=\"scrolling-content\";\n\n\t\tthis._tableSizer=this._scrollingContent.appendChild(document.createElement(\"div\"));\n\t\tthis._tableSizer.style.position=\"relative\";\n\t\tthis._tableSizer.style.top=\"0px\";//need to have so that scrolling works properly when reading parseInt of it\n\t\tthis._tableSizer.className=\"table-sizer\";\n\n\t\tthis._mainTable=this._tableSizer.appendChild(document.createElement(\"table\"));\n\t\tthis._mainTable.className=\"main-table\";\n\t\tthis._mainTbody=this._mainTable.appendChild(document.createElement(\"tbody\"));\n\t\tfor (let i = 0; i < this._colSchemaNodes.length; i++) {\n\t\t\tlet col=document.createElement(\"col\");\n\t\t\tthis._cols.push(col);\n\t\t\tthis._mainTable.appendChild(document.createElement(\"colgroup\")).appendChild(col);\n\t\t}\n\t\tthis._borderSpacingY=parseInt(window.getComputedStyle(this._mainTable)['border-spacing'].split(\" \")[1]);\n\t}\n\n\t_createBulkEditArea() {\n\t\tthis._bulkEditArea=this.rootEl.appendChild(document.createElement(\"div\"));\n\t\tthis._bulkEditArea.classList.add(\"bulk-edit-area\");\n\t\tthis._bulkEditArea.addEventListener(\"transitionend\",()=>{\n\t\t\tdelete this._animations[\"adjustViewportHeight\"];\n\t\t\tif (this._bulkEditArea.style.height!=\"0px\")\n\t\t\tthis._bulkEditArea.style.overflow=\"visible\";//have to shift between hidden/visible because hidden is needed\n\t\t\t\t\t\t\t\t\t//for animation but visible is needed for dropdowns to be able to go outside of area\n\t\t});\n\n\t\t//extra div needed for having padding while also being able to animate height all the way to 0\n\t\tconst bulkContent=this._bulkEditArea.appendChild(document.createElement(\"div\"));\n\n\t\tconst numberOfRowsSelectedDiv=bulkContent.appendChild(document.createElement(\"div\"));\n\t\tnumberOfRowsSelectedDiv.innerText=\"Number of selected rows: \";\n\t\tthis._numberOfRowsSelectedSpan=numberOfRowsSelectedDiv.appendChild(document.createElement(\"span\"));\n\n\t\tconst pagesDiv=bulkContent.appendChild(document.createElement(\"div\"));//for having multiple pages\n\t\tpagesDiv.classList.add(\"pages\");\t\t\t\t\t\t\t\t\t\t//which is needed if having groups in it\n\t\t\n\t\tconst mainPage=pagesDiv.appendChild(document.createElement(\"div\"));\n\t\tconst tableContainer=mainPage.appendChild(document.createElement(\"div\"));\n\t\tmainPage.classList.add(\"main\");\n\t\tmainPage.style.display=\"block\";\n\n\t\tconst bulkEditFields=this._buildBulkEditSchemaNodes(this.schema.details);\n\t\tfor (const column of this.schema.main.columns)\n\t\t\tbulkEditFields.push(...this._buildBulkEditSchemaNodes(column));\n\n\t\t//Build schema for bulk-edit-area based on the real schema\n\t\tconst schema={details:{type:\"lineup\",entries:bulkEditFields}};\n\n\t\tthis._bulkEditTable=new TablanceBulk(tableContainer,schema,null,true,null);\n\t\tthis._bulkEditTable.mainInstance=this;\n\t\tthis._bulkEditTable.addData([{}]);\n\n\t\tthis._bulkEditAreaHeightPx=this._bulkEditArea.firstChild.offsetHeight;\n\t\tthis._bulkEditArea.style.height=0;//start at height 0 before expanded. but do this after having measured above\n\t}\n\n\t_isObject(val) {\n\t\treturn val&&typeof val===\"object\"&&!Array.isArray(val);\n\t}\n\n\t/**Given a schemaNode like details or column, will add inputs to this._bulkEditSchemaNodes which later is iterated\n\t * and the contents added to the bulk-edit-area. \n\t * @param {*} schema Should be details or column when called from outside, but it calls itself recursively\n\t * \t\t\t\t\t\twhen hitting upon containers which then are passed to this param\n\t * @returns */\n\t_buildBulkEditSchemaNodes(schema) {\n\t\tconst mainCol=this.schema.main.columns.includes(schema);\n\t\tconst result=[];\n\t\tif ((mainCol||schema.type==\"field\")&&schema.bulkEdit) {\n\t\t\t//schema-nodes of main-columns don't need to specify this, but it's needed in details\n\t\t\tresult.push(Object.assign(Object.create(null), schema, {type:\"field\"}));\n\t\t} else if ((schema.entries?.length&&schema.bulkEdit)||schema===this.schema.details) {\n\t\t\tfor (const schemaNode of schema.entries)\n\t\t\t\tresult.push(...this._buildBulkEditSchemaNodes(schemaNode));\n\t\t}\n\t\treturn result;\n\t}\n\n\t/**Updates the displayed values in the bulk-edit-area */\n\t_updateBulkEditAreaCells(schemaNodesToUpdateCellsFor=this._bulkEditTable.schema.details.entries) {\n\t\tconst mixedText=\"(Mixed)\";\n\t\tfor (let multiCellI=-1, multiCellSchemaNode; multiCellSchemaNode=schemaNodesToUpdateCellsFor[++multiCellI];) {\n\n\t\t\t//work out if there are mixed values for this cell among the selected rows, or if all are same\n\t\t\tlet mixed=false;\n\t\t\tlet val,lastVal;\n\t\t\tfor (let rowI=-1,row; row=this._selectedRows[++rowI];) {\n\t\t\t\tval=row[multiCellSchemaNode.id];\n\t\t\t\tif (rowI&&val!=lastVal) {\n\t\t\t\t\tmixed=true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tlastVal=val;\n\t\t\t}\n\n\n\t\t\t//update both the data and the dom\n\t\t\tthis._bulkEditTable.updateData(0,multiCellSchemaNode.id,mixed?mixedText:val?.text??val??\"\");\n\t\t\tconst el=this._bulkEditTable._openDetailsPanes[0].children[multiCellI].el;\n\t\t\tel.innerText=mixed?mixedText:val?.text??val??\"\";\n\t\t\tthis._bulkEditTable._data[0][multiCellSchemaNode.id]=mixed?\"\":val;\n\t\t}\n\t}\n\n\t_updateSizesOfViewportAndCols() {\n\t\tif (this.hostEl.offsetHeight != this._containerHeight) {\n\t\t\tthis._updateViewportHeight();\n\t\t\tif (this.hostEl.offsetHeight > this._containerHeight)\n\t\t\t\tthis._maybeAddTrs();\n\t\t\telse\n\t\t\t\tthis._maybeRemoveTrs();\n\t\t\tthis._containerHeight = this.hostEl.offsetHeight;\n\t\t}\n\t\tthis._updateColsWidths();\n\t\tthis._headerTable.style.width = this._scrollBody.offsetWidth + \"px\";\n\t\tthis._adjustCursorPosSize(this._selectedCell);\n\t}\n\n\t_updateColsWidths() {\n\t\tif (this.rootEl.offsetWidth>this._containerWidth) {\n\t\t\tlet areaWidth=this._tableSizer.offsetWidth;\n\t\t\tconst percentageWidthRegex=/\\d+%/;\n\t\t\tlet totalFixedWidth=0;\n\t\t\tlet numUndefinedWidths=0;\n\t\t\tfor (let col of this._colSchemaNodes)\n\t\t\t\tif (!col.width)\n\t\t\t\t\tnumUndefinedWidths++;\n\t\t\t\telse if (!percentageWidthRegex.test(col))//if fixed width\n\t\t\t\t\ttotalFixedWidth+=(col.pxWidth=parseInt(col.width));\n\t\t\tlet sumFixedAndFlexibleWidth=totalFixedWidth;\n\t\t\tfor (let col of this._colSchemaNodes)\n\t\t\t\tif (col.width&&percentageWidthRegex.test(col))//if flexible width\n\t\t\t\t\tsumFixedAndFlexibleWidth+=(col.pxWidth=(areaWidth-totalFixedWidth)*parseFloat(col.width)/100);\n\t\t\tfor (let col of this._colSchemaNodes)\n\t\t\t\tif (!col.width)//if undefined width\n\t\t\t\t\tcol.pxWidth=(areaWidth-sumFixedAndFlexibleWidth)/numUndefinedWidths;\n\t\t\tfor (var colI=0; colI<this._colSchemaNodes.length; colI++) \n\t\t\t\tthis._cols[colI].style.width=this._headerTr.cells[colI].style.width\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t=this._colSchemaNodes[colI].pxWidth+\"px\";\n\t\t\t//last col is empty col with the width of table-scrollbar if its present in order to make the header span\n\t\t\t//the whole with while not actually using that last bit in the calculations for the normal cols\n\t\t\tthis._headerTr.cells[colI].style.width=this._scrollBody.offsetWidth-areaWidth+\"px\";\n\t\t}\n\t}\n\n\t_filterData(filterString) {\n\t\tthis._openDetailsPanes={};\n\t\tthis._rowsMeta={keys:[],vals:[]};\n\t\tfor (const tr of this._mainTbody.querySelectorAll(\"tr.details\"))\n\t\t \ttr.remove();\n\t\tthis._filter=filterString;\n\t\tconst colsToFilterBy=[];\n\t\tconst selectsOptsByVal={};//for each col that is of the select type, a entry will be placed in this with the\n\t\t\t//col-index as key and an object as val. the object holds all the options but they are keyed by teir value\n\t\t\t//rather than being in an indexed array.This is to simplify and likely improve speed of filtering by the col\n\n\t\tfor (let col of this._colSchemaNodes)\n\t\t\tif (col.type!==\"expand\"&&col.type!==\"select\") {\n\t\t\t\tif (col.input?.type==\"select\") {\n\t\t\t\t\tconst optsByVal=selectsOptsByVal[colsToFilterBy.length]={};\n\t\t\t\t\tfor (const opt of col.input.options)\n\t\t\t\t\t\toptsByVal[opt.value]=opt;\n\t\t\t\t}\n\t\t\t\tcolsToFilterBy.push(col);\n\t\t\t}\n\t\tif (filterString) {\n\t\t\tthis._data=[];\n\t\t\tfor (let dataRow of this._allData)\n\t\t\t\tfor (let colI=-1,col; col=colsToFilterBy[++colI];) {\n\t\t\t\t\tif (dataRow[col.id]!=null) {\n\t\t\t\t\t\tlet match=false;\n\t\t\t\t\t\tif (col.input?.type==\"select\") {\n\t\t\t\t\t\t\tif (typeof dataRow[col.id]==\"string\")\n\t\t\t\t\t\t\t\tmatch=selectsOptsByVal[dataRow[col.id]].text.includes(filterString);\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\tmatch=dataRow[col.id].text.includes(filterString);\n\t\t\t\t\t\t} else\n\t\t\t\t\t\t\tmatch=dataRow[col.id].includes(filterString);\n\t\t\t\t\t\tif (match) {\n\t\t\t\t\t\t\tthis._data.push(dataRow);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t} else\n\t\t\tthis._data=this._allData;\n\t\tthis._scrollRowIndex=0;\n\t\tthis._refreshTable();\n\t\tthis._refreshTableSizerNoDetails();\n\t}\n\n\t_setDataForOnlyDetails(data) {\n\t\tthis._allData=this._data=[data[data.length-1]];\n\t\tthis.rootEl.innerHTML=\"\";\n\t\tconst detailsDiv=this.rootEl.appendChild(document.createElement(\"div\"));\n\t\tdetailsDiv.classList.add(\"details\");\n\t\tthis._generateDetailsContent(this.schema.details,0,this._openDetailsPanes[0]={},detailsDiv,[],this._data[0]);\n\t}\n\n\t/**Refreshes the table-rows. Should be used after sorting or filtering or such.*/\n\t_refreshTable() {\n\t\t//In order to render everything correctly and know which rows should be rendered in the view we need to go from\n\t\t//top to bottom because the number of expanded rows above the view might have changed. So go to \n\t\t//#scrollRowIndex 0 to start at top row, also set #scrollY to 0 so the scrollMethod compares the current\n\t\t//scrollTop with 0.\n\t\tthis._scrollRowIndex=this._scrollY=0;\n\n\t\tthis._lastCheckedIndex=null;\n\n\t\t//adjust the sizer to what its top and height would be when scrolled all the way up.\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)+parseInt(this._tableSizer.style.top)+\"px\";\n\t\tthis._tableSizer.style.top=this._numRenderedRows=0;\n\n\t\t//its position and size needs to be udated.Hide for now and let #updateRowValues or #renderDetails add it back\n\t\tthis._cellCursor.style.display=\"none\";\n\n\t\tthis._mainTbody.replaceChildren();//remove all the tr-elements\n\t\tthis._maybeAddTrs();//add them again and with their correct data, at least based on them being the top rows \n\t\tthis._scrollMethod();//now scroll back to the real scroll-position\n\t}\n\n\t/**This onScroll-handler is used when rows are of static height and can't be expanded either.\n\t * It is the fastest scroll-method since row-heights are known and it is easy to calculate which rows should be\n\t * rendered even when scrolling more than a whole page at once as each row won't have to be iterated, and rows\n\t * will only have to be created or deleted if the table is resized so the same tr-elements are reused.* \n\t * @returns */\n\t_onScrollStaticRowHeightNoDetails() {\n\t\tconst scrY=Math.max(this._scrollBody.scrollTop-this._scrollMarginPx,0);\n\t\tconst newScrollRowIndex=Math.min(parseInt(scrY/this._rowHeight),this._data.length-this._mainTbody.rows.length);\n\t\t\n\t\tif (newScrollRowIndex==this._scrollRowIndex)\n\t\t\treturn;\n\t\tif(Math.abs(newScrollRowIndex-this._scrollRowIndex)>this._mainTbody.rows.length){//if scrolling by whole page(s)\n\t\t\tthis._scrollRowIndex=parseInt(scrY/this._rowHeight);\n\t\t\tthis._refreshTable();\n\t\t} else {\n\t\t\tconst scrollSignum=Math.sign(newScrollRowIndex-this._scrollRowIndex);//1 if moving down, -1 if up\n\t\t\tdo {\n\t\t\t\tthis._scrollRowIndex+=scrollSignum;\n\t\t\t\tif (scrollSignum==1) {//moving down\t\t\t\t\t\t\t\t\t\t\t\tmove top row to bottom\n\t\t\t\t\tconst dataIndex=this._scrollRowIndex+this._numRenderedRows-1;\n\t\t\t\t\tthis._updateRowValues(this._mainTbody.appendChild(this._mainTbody.firstChild),dataIndex);\n\t\t\t\t} else {//moving up\n\t\t\t\t\tlet trToMove=this._mainTbody.lastChild;\t\t\t\t\t\t\t\t\t//move bottom row to top\n\t\t\t\t\tthis._mainTbody.prepend(trToMove);\n\t\t\t\t\tthis._updateRowValues(trToMove,this._scrollRowIndex);\n\t\t\t\t}\n\t\t\t} while (this._scrollRowIndex!=newScrollRowIndex);\n\t\t}\n\t\tthis._refreshTableSizerNoDetails();\n\t}\n\n\t_onScrollStaticRowHeightDetails(_e) {\n\t\tconst newScrY=Math.max(this._scrollBody.scrollTop-this._scrollMarginPx,0);\n\t\tif (newScrY>parseInt(this._scrollY)) {//if scrolling down\n\t\t\twhile (newScrY-parseInt(this._tableSizer.style.top)\n\t\t\t>(this._rowMetaGet(this._scrollRowIndex)?.h??this._rowHeight)) {//if a whole top row is outside\n\t\t\t\tif (this._scrollRowIndex+this._numRenderedRows>this._data.length-1)\n\t\t\t\t\tbreak;\n\t\t\t\tlet topShift;//height of the row that is at the top before scroll and which will be removed which is the\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// amount of pixels the whole table is shiftet by\n\t\t\t\t//check if the top row (the one that is to be moved to the bottom) is expanded\n\t\t\t\tif (topShift=this._rowMetaGet(this._scrollRowIndex)?.h) {\n\t\t\t\t\tdelete this._openDetailsPanes[this._scrollRowIndex];\n\t\t\t\t\tthis._mainTbody.rows[1].remove();\n\t\t\t\t} else\n\t\t\t\t\ttopShift=this._rowHeight;\n\t\t\t\tconst dataIndex=this._numRenderedRows+this._scrollRowIndex;//the data-index of the new row\n\n\t\t\t\t//move the top row to bottom and update its values\n\t\t\t\tconst trToMove=this._updateRowValues(this._mainTbody.appendChild(this._mainTbody.firstChild),dataIndex);\n\n\t\t\t\t//move the table down by the height of the removed row to compensate,else the whole table would shift up\n\n\t\t\t\tthis._doRowScrollDetails(trToMove,dataIndex,this._scrollRowIndex,-topShift);\n\t\t\t\tthis._scrollRowIndex++;\n\t\t\t}\n\t\t} else if (newScrY<parseInt(this._scrollY)) {//if scrolling up\n\t\t\twhile (newScrY<parseInt(this._tableSizer.style.top)) {//while top row is below top of viewport\n\t\t\t\tthis._scrollRowIndex--;\n\n\t\t\t\t//check if the bottom row (the one that is to be moved to the top) is expanded\n\t\t\t\tif (this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows)?.h) {\n\t\t\t\t\tdelete this._openDetailsPanes[this._scrollRowIndex+this._numRenderedRows];\n\t\t\t\t\tthis._mainTbody.lastChild.remove();//remove the details-tr\n\t\t\t\t}\n\n\t\t\t\tlet trToMove=this._mainTbody.lastChild;\t\t\t\t\t\t\t\t\t//move bottom row to top\n\t\t\t\tthis._mainTbody.prepend(trToMove);\n\t\t\t\tthis._updateRowValues(trToMove,this._scrollRowIndex);//the data of the new row;\n\n\t\t\t\t//height of the row that is added at the top which is amount of pixels the whole table is shiftet by\n\t\t\t\tconst topShift=this._rowMetaGet(this._scrollRowIndex)?.h??this._rowHeight;\n\n\t\t\t\tthis._doRowScrollDetails(trToMove,this._scrollRowIndex,this._scrollRowIndex+this._numRenderedRows,topShift);\n\t\t\t}\n\t\t}\n\t\tthis._scrollY=newScrY;\n\t}\n\n\t/**Used by #onScrollStaticRowHeightDetails whenever a row is actually added/removed(or rather moved)*/\n\t_doRowScrollDetails(trToMove,newMainIndex,oldMainIndex,topShift) {\n\t\tconst detailsHeight=this._rowMetaGet(newMainIndex)?.h;\n\t\tif (detailsHeight>0) {\n\t\t\tthis._renderDetails(trToMove,newMainIndex);\n\t\t} else if (detailsHeight==-1) {\n\t\t\tthis._scrollBody.scrollTop+=this._expandRow(trToMove,false);\n\t\t} else\n\t\t\ttrToMove.classList.remove(\"expanded\");\n\t\t\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)+topShift+\"px\";\n\t\tthis._tableSizer.style.top=parseInt(this._tableSizer.style.top)-topShift+\"px\";\n\n\t\tif (oldMainIndex===this._mainRowIndex) {//cell-cursor is on moved row\n\t\t\tthis._selectedCell=null;\n\t\t\tfor (let cell=this._activeDetailsCell; cell&&(cell=cell.parent);)\n\t\t\t\tif (cell.creating) {\n\t\t\t\t\tcell.creating=false;//otherwise cell.select() below will not work\n\t\t\t\t\tthis._exitEditMode(false);//in case field is validated. Could prevent cell.select() too otherwise\n\t\t\t\t\tcell.parent.dataObj.splice(cell.parent.dataObj.indexOf(cell.dataObj),1);\n\t\t\t\t\twhile (cell&&(cell=cell.parent))\n\t\t\t\t\t\tif (cell.select) {\n\t\t\t\t\t\t\tcell.select();\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n\n\t\tthis._lookForActiveCellInRow(trToMove);//look for active cell (cellcursor) in the row. This is needed\n\t\t//in order to reassign the dom-element and such and also adjust the pos of the cellcursor in case\n\t\t//the pos of the cell is not the same due to sorting/filtering\n\t}\n\t\n\n\t/**This should be called on each row that is being scrolled into view that might hold the active cell in order\n\t * to set #selectedCell to the correct element\n\t * @param {HTMLTableRowElement} tr */\n\t_lookForActiveCellInRow(tr) {\n\t\tif (tr.dataset.dataRowIndex==this._mainRowIndex) {\n\t\t\tif (!this._activeDetailsCell)\n\t\t\t\tthis._selectedCell=tr.cells[this._mainColIndex];\n\t\t\telse {//if inside details\n\t\t\t\t//generate the path to the instanceNode in #activeDetailsCell by stepping through its parents to root\n\t\t\t\tlet path=[];\n\t\t\t\tfor (let instanceNode=this._activeDetailsCell; instanceNode.parent; instanceNode=instanceNode.parent)\n\t\t\t\t\tpath.unshift(instanceNode.index);\n\t\t\t\t//now follow the same path in the new #openDetailsNavMap[rowIndex], eg the instanceNodes..\n\t\t\t\tlet instanceNode=this._openDetailsPanes[this._mainRowIndex];\n\t\t\t\tfor (let step of path)\n\t\t\t\t\tinstanceNode=instanceNode.children[step];\n\t\t\t\tthis._selectedCell=instanceNode.el;\n\t\t\t\tthis._activeDetailsCell=instanceNode;//should be identical but this allows for the old one to be gc'd\n\t\t\t}\n\t\t\tthis._adjustCursorPosSize(this._selectedCell);\n\t\t}\n\t}\n\n\t_refreshTableSizerNoDetails() {\t\n\t\tthis._tableSizer.style.top=this._scrollRowIndex*this._rowHeight+\"px\";\n\t\tthis._tableSizer.style.height=(this._data.length-this._scrollRowIndex)*this._rowHeight+\"px\";\n\t}\n\n\t_createExpandContractButton() {\n\t\tconst a=document.createElement(\"a\");\n\t\ta.appendChild(document.createElement(\"span\"));\n\t\treturn a;\n\t}\n\n\t_createCheckbox(preventClickSelect) {\n\t\tconst checkbox=document.createElement(\"input\");\n\t\tcheckbox.type=\"checkbox\";\n\t\tcheckbox.tabIndex=\"-1\";\n\n\t\tif (preventClickSelect)//prevent checking and leave to #toggleRowSelected for consistant behavior when \n\t\t\tcheckbox.addEventListener(\"click\",this._preventDefault);//clicking checkbox vs clicking its cell\n\n\t\t//prevent gaining focus when clicking it. Otherwise it does gain focus despite tabIndex -1\n\t\tcheckbox.addEventListener(\"mousedown\",this._preventDefault);\n\n\t\treturn checkbox;\n\t}\n\n\t/**Should be called if tr-elements might need to be created which is when data is added or if table grows*/\n\t_maybeAddTrs() {\n\t\tlet lastTr=this._mainTbody.lastChild;\n\t\tconst scrH=this._scrollBody.offsetHeight+this._scrollMarginPx*2;\n\t\tconst dataLen=this._data.length;\n\t\t//if there are fewer trs than datarows, and if there is empty space below bottom tr\n\t\twhile ((this._numRenderedRows-1)*this._rowHeight<scrH&&this._scrollRowIndex+this._numRenderedRows<dataLen) {\n\t\t\tlastTr=this._mainTable.insertRow();\n\t\t\tthis._numRenderedRows++;\n\t\t\tfor (let i=0; i<this._colSchemaNodes.length; i++) {\n\t\t\t\tconst cell=lastTr.insertCell();\n\t\t\t\tconst div=cell.appendChild(document.createElement(\"div\"));//used to set height of cells\n\t\t\t\tdiv.style.height=this._rowInnerHeight||\"auto\";\t\t\t\t\n\t\t\t\tif (this._colSchemaNodes[i].type===\"expand\") {\n\t\t\t\t\tdiv.appendChild(this._createExpandContractButton());\n\t\t\t\t\tcell.classList.add(\"expand-col\");\n\t\t\t\t} else if (this._colSchemaNodes[i].type===\"select\") {\n\t\t\t\t\tdiv.appendChild(this._createCheckbox(true));\n\t\t\t\t\tcell.classList.add(\"select-col\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._updateRowValues(lastTr,this._scrollRowIndex+this._numRenderedRows-1);\n\t\t\tif (this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows-1)?.h)\n\t\t\t\tthis._renderDetails(lastTr,this._scrollRowIndex+this._numRenderedRows-1);\n\t\t\tthis._lookForActiveCellInRow(lastTr);//look for active cell (cellcursor) in the row\n\t\t\tif (!this._rowHeight) {//if there were no rows prior to this\n\t\t\t\tthis._rowHeight=lastTr.offsetHeight+this._borderSpacingY;\n\t\t\t\tconst tdComputedStyle=window.getComputedStyle(lastTr.firstChild);\n\t\t\t\tfor (let prop of [\"paddingTop\",\"paddingBottom\",\"borderBottomWidth\",\"borderTopWidth\"])\n\t\t\t\t\tthis._rowInnerHeight-=parseInt(tdComputedStyle[prop]);\n\t\t\t\tthis._rowInnerHeight=this._rowInnerHeight+lastTr.offsetHeight+\"px\";\n\t\t\t}\n\t\t}\n\t}\n\n\t_preventDefault(e){\n\t\te.preventDefault();\n\t}\n\n\t/**Should be called if tr-elements might need to be removed which is when table shrinks*/\n\t_maybeRemoveTrs() {\n\t\tconst scrH=this._scrollBody.offsetHeight+this._scrollMarginPx*2;\n\t\twhile ((this._numRenderedRows-2)*this._rowHeight>scrH) {\n\t\t\tif (this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows-1)?.h) {\n\t\t\t\tthis._mainTbody.lastChild.remove();\n\t\t\t\tdelete this._openDetailsPanes[this._scrollRowIndex+this._numRenderedRows];\n\t\t\t}\n\t\t\tthis._mainTbody.lastChild.remove();\n\t\t\tthis._numRenderedRows--;\n\t\t}\n\t}\n\n\t/**Update the values of a row in the table. The tr needs to be passed in as well as the index of the data in #data\n\t * The row needs to already have the right amount of td's.\n\t * @param {HTMLTableRowElement} tr The tr-element whose cells that should be updated*/\n\t_updateRowValues(tr,mainIndex) {\n\t\ttr.dataset.dataRowIndex=mainIndex;\n\t\tconst selected=this._selectedRows.indexOf(this._data[mainIndex])!=-1;\n\t\ttr.classList.toggle(\"selected\",!!selected);\n\t\tfor (let colI=0; colI<this._colSchemaNodes.length; colI++) {\n\t\t\tlet td=tr.cells[colI];\n\t\t\tlet colSchemaNode=this._colSchemaNodes[colI];\n\t\t\tif (colSchemaNode.type!=\"expand\"&&colSchemaNode.type!=\"select\")\n\t\t\t\tthis._updateMainRowCell(td,colSchemaNode);\n\t\t\telse if (colSchemaNode.type==\"select\")\n\t\t\t\ttd.querySelector(\"input\").checked=selected;\n\t\t}\n\t\tif (this._highlightRowsOnView[mainIndex]) {\n\t\t\tdelete this._highlightRowsOnView[mainIndex];\n\t\t\tthis._highlightRowIndex(mainIndex);\n\t\t}\n\t\treturn tr;\n\t}\n\n\t/**\n\t * Format bytes as human-readable text.\n\t * \n\t * @param bytes Number of bytes.\n\t * @param si True to use metric (SI) units, aka powers of 1000. False to use \n\t *           binary (IEC), aka powers of 1024.\n\t * @param dp Number of decimal places to display.\n\t * \n\t * @return Formatted string.\n\t */\n\t_humanFileSize(bytes, si=false, dp=1) {\n\t\tconst thresh = si ? 1000 : 1024;\n\t\n\t\tif (Math.abs(bytes) < thresh) {\n\t\treturn bytes + ' B';\n\t\t}\n\t\n\t\tconst units = si \n\t\t? ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'] \n\t\t: ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];\n\t\tlet u = -1;\n\t\tconst r = 10**dp;\n\t\n\t\tdo {\n\t\tbytes /= thresh;\n\t\t++u;\n\t\t} while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);\n\t\n\t\n\t\treturn bytes.toFixed(dp) + ' ' + units[u];\n\t}\n\n\t_generateFileCell(fileInstanceNode,cellEl,rowData,dataIndex) {\n\t\t//schemaNode of instanceNode will get overwritten. Save reference here.\n\t\tconst fileSchemaNode=fileInstanceNode.schemaNode;\n\n\t\t//saving this ref here which is used to revert with if user deletes file\n\t\tfileInstanceNode.fileInputSchemaNode=fileSchemaNode;\n\n\t\t//define all the file-meta-props\n\t\tconst lang=this._opts.lang??{};\n\t\tlet metaEntries=[{type:\"field\",title:lang.fileName??\"Filename\",id:\"name\"},\n\t\t\t{type:\"field\",title:lang.fileLastModified??\"Last Modified\",id:\"lastModified\",render:date=>\n\t\t\tnew Date(date).toISOString().slice(0, 16).replace('T', ' ')},\n\t\t\t{type:\"field\",title:lang.fileSize??\"Size\",id:\"size\",render:size=>this._humanFileSize(size)},\n\t\t\t{type:\"field\",title:lang.fileType??\"Type\",id:\"type\"}];\n\t\tfor (let metaI=-1,metaName; metaName=[\"filename\",\"lastModified\",\"size\",\"type\"][++metaI];)\n\t\t\tif(!(fileSchemaNode.input.fileMetasToShow?.[metaName]??this._opts.defaultFileMetasToShow?.[metaName]??true))\n\t\t\t\tmetaEntries.splice(metaI,1);//potentially remove (some of) them\n\t\t//define the group-structure for the file\n\t\t\n\t\tconst fileGroup=this._schemaCopyWithDeleteButton({type:\"group\",entries:[]},this._fileOnDelete);\n\t\tfileGroup.entries[0].entries.unshift({type:\"field\",input:{type:\"button\",btnText:\"Open\"\n\t\t\t\t,clickHandler:(e,file,mainIndex,schemaNode,btnObj)=>{\n\t\t\t\t\trowData??=this._data[mainIndex];\n\t\t\t\t\tfileSchemaNode.input.openHandler?.(e,file,fileSchemaNode,fileInstanceNode.dataObj,mainIndex,btnObj);\n\t\t\t}},\n\t\t});\n\t\tfileGroup.entries.push({type:\"lineup\",entries:metaEntries});\n\t\t\n\t\tconst fileData=rowData[fileInstanceNode.schemaNode.id];\n\t\tthis._generateDetailsContent(fileGroup,dataIndex,fileInstanceNode,cellEl,fileInstanceNode.path,fileData);\n\t\tconst fileMeta=this._mapGet(this._filesMeta,fileData);\n\t\tif (fileMeta!=null) {\n\t\t\tconst progressbarOuter=cellEl.appendChild(document.createElement(\"div\"));\n\t\t\tprogressbarOuter.classList.add(\"progressbar\",\"active\");\n\t\t\tconst progressbarInner=progressbarOuter.appendChild(document.createElement(\"div\"));\n\t\t\tprogressbarInner.style.transition=\"none\";//get to the current pos immediately in case running from before\n\t\t\tfileMeta.bars.push(progressbarInner);\n\t\t\tprogressbarInner.role=\"progressbar\";\n\t\t\tconst progressSpan=progressbarInner.appendChild(document.createElement(\"span\"));\n\t\t\tprogressbarInner.style.width=progressSpan.innerText=parseInt(fileMeta.uploadedBytes/fileData.size*100)+\"%\";\n\t\t\tprogressbarInner.style.removeProperty(\"transition\");//enable transitioning again, it was disabled above\n\t\t}\n\t}\n\n\n\t/**Updates the html-element of a cell inside an details. Also updates nonEmptyDescentants of the instanceNode of \n\t * \tgroup-rows as well as toggling the empty-class of them. Reports back whether visibility has been changed.\n\t * @param {*} instanceNode */\n\t_updateDetailsCell(instanceNode,rowData=null) {\n\t\tlet cellEl=instanceNode.el;\n\t\tif (instanceNode.schemaNode.maxHeight) {//if there's a maxHeight stated, which is used for textareas\n\t\t\tcellEl.innerHTML=\"\";//empty the cell, otherwise multiple calls to this would add more and more content to it\n\t\t\tcellEl=cellEl.appendChild(document.createElement(\"div\"));//then put a div inside and change cellEl to that\n\t\t\tcellEl.style.maxHeight=instanceNode.schemaNode.maxHeight;//then set its maxHeight\n\t\t\tcellEl.style.overflow=\"auto\";//and male it scrollable\n\t\t\t//can't make td directly scrollable which is why the div is needed\n\t\t}\n\t\tfor (var rootCell=instanceNode;rootCell.parent;rootCell=rootCell.parent);\n\t\tconst oldCellContent=cellEl.innerText;\n\t\tif (instanceNode.schemaNode.input?.type==\"file\"&&rowData[instanceNode.schemaNode.id]) {\n\t\t\tthis._generateFileCell(instanceNode,cellEl,rowData,rootCell.rowIndex);\n\t\t} else {\n\t\t\tif (instanceNode.schemaNode.visibleIf)\n\t\t\t\tthis._applyVisibleIf(instanceNode);\n\t\t\tthis._updateCell(instanceNode.schemaNode,cellEl,instanceNode.selEl,rowData,rootCell.rowIndex,instanceNode);\n\t\t\tif (instanceNode.schemaNode.input?.type!==\"button\") {\n\t\t\t\tconst newCellContent=cellEl.innerText;\n\t\t\t\tif (!newCellContent!=!oldCellContent) {\n\t\t\t\t\tfor (let cellI=instanceNode; cellI; cellI=cellI.parent)\n\t\t\t\t\t\tif (cellI.nonEmptyDescentants!=null)\n\t\t\t\t\t\t\tcellI.grpTr.classList.toggle(\"empty\",!(cellI.nonEmptyDescentants+=newCellContent?1:-1));\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t} else\n\t\t\t\tinstanceNode.el=instanceNode.selEl=instanceNode.el.querySelector(\"button\");\n\t\t}\n\t}\n\n\t_getValueByPath(obj, path) {\n\t\tlet cur = obj;\n\t\tfor (const key of path) {\n\t\t\tif (cur == null)\n\t\t\t\treturn undefined;\n\t\t\tcur = cur[key];\n\t\t}\n\t\treturn cur;\n\t}\n\n\t_resolveCellPaths(baseCell, path) {\n\t\tlet target = baseCell;\n\n\t\t// Step 1: go up for each \"..\"\n\t\tfor (var i=0; i < path.length && path[i] === \"..\"; i++)\n\t\t\ttarget = target.parent;\n\n\t\t// Step 2: go down via the remaining indices\n\t\tfor (; i < path.length; i++)\n\t\t\ttarget = target.children[path[i]];\n\t\treturn target;\n\t}\n\n\t/**\n\t * Gets the value of a cell, pointed to by its ID, or if it depends on another cell, gets that value. The value\n\t * is the raw data from the data-object, not rendered.\n\t * @param {*} schemaNode \n\t * @param {*} rowData \n\t * @param {*} instanceNode \n\t * @returns \n\t */\n\t_getTargetVal(idOverDependee,schemaNode, instanceNode, rowData=instanceNode.dataObj) {\n\t\tif (idOverDependee&&schemaNode.id)\n\t\t\treturn rowData[schemaNode.id];\n\t\tif (schemaNode.dependsOnDataPath) {\n\t\t\tif (instanceNode)\n\t\t\t\tfor (var root=instanceNode; root.parent; root=root.parent,rowData=root.dataObj);\n\t\t\t return this._getValueByPath(rowData,schemaNode.dependsOnDataPath);\n\t\t}\n\t\tif (schemaNode.dependsOnCellPaths) {\n\t\t\tconst dependee=this._resolveCellPaths(instanceNode,schemaNode.dependsOnCellPaths[0]);\n\t\t\treturn dependee.dataObj[dependee.schemaNode.id];\n\t\t}\n\t\treturn rowData[schemaNode.id];\n\t}\n\t\n\n\t_updateCell(schemaNode,el,selEl,rowData,mainIndex,instanceNode=null) {\n\t\tif (schemaNode.input?.type===\"button\") {\n\t\t\tthis._generateButton(schemaNode,mainIndex,el,rowData,instanceNode);\n\t\t} else {\n\t\t\tlet newCellContent;\n\t\t\tif (schemaNode.render||schemaNode.input?.type!=\"select\") {\n\t\t\t\tnewCellContent=this._getTargetVal(true,schemaNode, instanceNode, rowData);\n\t\t\t\tif (schemaNode.render)\n\t\t\t\t\tnewCellContent=schemaNode.render(newCellContent,rowData,schemaNode,mainIndex,instanceNode);\n\t\t\t} else { //if (schemaNode.input?.type===\"select\") {\n\t\t\t\tlet selOptObj=rowData[schemaNode.id];\n\t\t\t\tif (selOptObj&&typeof selOptObj!==\"object\")\n\t\t\t\t\tselOptObj=rowData[schemaNode.id]=schemaNode.input.options.find(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\topt=>opt.value==rowData[schemaNode.id]);\n\t\t\t\tnewCellContent=selOptObj?.text??\"\";\n\t\t\t}\n\t\t\tlet isDisabled=false;\n\t\t\tif (this._spreadsheet&&schemaNode.type!==\"expand\") {\n\t\t\t\tconst enabledFuncResult=schemaNode.input?.enabled?.(schemaNode,rowData,mainIndex,instanceNode);\n\t\t\t\tif (!schemaNode.input||enabledFuncResult==false||enabledFuncResult?.enabled==false)\n\t\t\t\t\tisDisabled=true;\n\t\t\t}\n\t\t\t(selEl??el).classList.toggle(\"disabled\",isDisabled);\n\t\t\tif (schemaNode.html)\n\t\t\t\tel.innerHTML=newCellContent??\"\";\n\t\t\telse\n\t\t\t\tel.innerText=newCellContent??\"\";\n\t\t}\n\t}\n\n\t/**Updates the html-element of a main-table-cell\n\t * @param {*} cellEl \n\t * @param {*} colSchemaNode */\n\t_updateMainRowCell(cellEl,colSchemaNode) {\n\t\tcellEl.firstChild.innerHTML=\"\";\n\t\tconst mainIndex=cellEl.closest(\".main-table>tbody>tr\").dataset.dataRowIndex;\n\t\tthis._updateCell(colSchemaNode,cellEl.firstChild,cellEl,this._data[mainIndex],mainIndex);\n\t}\n\n\t_highlightRowIndex(index) {\n\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${index}\"]`);\n\t\tif (tr)\n\t\t\tthis._highlightElements(tr.children);\n\t\telse\n\t\t\tthis._highlightRowsOnView[index]=true;\n\t}\n\n\t_highlightElements(elements) {\n\t\tconst origColors=[];\n\t\tfor (const el of elements) {\n\t\t\torigColors.push(window.getComputedStyle(el).backgroundColor);\n\t\t\tel.style.transition = \"none\";\n\t\t\tel.style.backgroundColor=\"blue\";\n\t\t}\n\t\tsetTimeout(()=>{\n\t\t\tfor (const el of elements) {\n\t\t\t\tel.style.transition=\"background-color 1s linear\";\n\t\t\t\tel.style.backgroundColor=origColors.shift();\n\t\t\t}\n\t\t});\n\t}\n\n\t_scrollToCursor(){}//default is to do nothing. Tablance (main) overrides this.\n\t_applyVisibleIf(){}//default is to do nothing. Tablance (main) overrides this.\n}\n\n/**\n * Secondary Tablance used for the bulk-edit area.\n * Reflects and updates selected rows in the main Tablance instance.\n */\nclass TablanceBulk extends TablanceBase {\n\n\t/** @type {Tablance} main tablance owning this bulk instance */\n\tmainInstance;\n\t_dropdownAlignmentContainer=this.rootEl;\n\tconstructor() {\n\t\tsuper(...arguments);\n\t}\n\n\t\n\n\t_doEditSave() {\n\t\tconst inputVal=this._activeSchemaNode.input.type===\"select\"?this._inputVal.value:this._inputVal;\n\t\tthis._cellCursorDataObj[this._activeSchemaNode.id]=this._inputVal;\n\t\tfor (const selectedRow of this.mainInstance._selectedRows)\n\t\t\tselectedRow[this._activeSchemaNode.id]=inputVal;\n\t\tfor (const selectedTr of this.mainInstance._mainTbody.querySelectorAll(\"tr.selected\"))\n\t\t\tthis.mainInstance.updateData(selectedTr.dataset.dataRowIndex,this._activeSchemaNode.id,inputVal,false,true);\n\t\tthis._updateDetailsCell(this._activeDetailsCell,this._cellCursorDataObj);\n\t}\n}\n\n/**\n * Primary Tablance component representing the main interactive table.\n * Handles full data display, user interaction, editing, details, and rendering.\n */\nexport default class Tablance extends TablanceBase {\n\tconstructor() {\n\t\tsuper(...arguments);\n\t\tthis._dropdownAlignmentContainer=this._onlyDetails?this.rootEl:this._scrollBody;\n\t}\n\t\n\t_doEditSave() {\n\t\tlet doUpdate=true;//if false then the data will not actually change in either dataObject or the html\n\t\tconst inputVal=this._activeSchemaNode.input.type===\"select\"?this._inputVal.value:this._inputVal;\n\n\t\tthis._activeSchemaNode.input.onChange?.({newValue: inputVal,oldValue: this._selectedCellVal,\n\t\t\trowData: this._cellCursorDataObj,schemaNode: this._activeSchemaNode,instanceNode: this._activeDetailsCell,\n\t\t\tclosestMeta: key => this._closestMeta(this._activeSchemaNode, key),cancelUpdate: ()=> doUpdate=false\n\t\t});\n\n\t\tif (doUpdate) {\n\t\t\tthis._cellCursorDataObj[this._activeSchemaNode.id]=this._inputVal;\n\t\t\tif (this._activeDetailsCell){\n\t\t\t\tconst doHeightUpdate=this._updateDetailsCell(this._activeDetailsCell,this._cellCursorDataObj);\n\t\t\t\tif (doHeightUpdate&&!this._onlyDetails)\n\t\t\t\t\tthis._updateDetailsHeight(this._selectedCell.closest(\"tr.details\"));\n\t\t\t\tfor (let cell=this._activeDetailsCell.parent; cell; cell=cell.parent)\n\t\t\t\t\tif (cell.schemaNode.closedRender)//found a group with a closed-group-render func\n\t\t\t\t\t\tcell.updateRenderOnClose=true;//update closed-group-render\n\t\t\t} else {\n\t\t\t\tthis._updateMainRowCell(this._selectedCell,this._activeSchemaNode);\n\t\t\t\tthis._unsortCol(this._activeSchemaNode.id);\n\t\t\t}\n\t\t\tif (this._selectedRows.indexOf(this._cellCursorDataObj)!=-1)//if edited row is checked/selected\n\t\t\t\tthis._updateBulkEditAreaCells([this._activeSchemaNode]);\n\t\t\tthis._updateDependentCells(this._activeSchemaNode,this._activeDetailsCell);\n\t\t} else\n\t\t\tthis._inputVal=this._selectedCellVal;\n\t\tthis._selectedCellVal=this._inputVal;\n\t}\n\n\t_scrollToCursor() {\n\t\tif (this._onlyDetails)\n\t\t\treturn this._cellCursor.scrollIntoView({block: \"center\"});\n\t\tconst distanceRatioDeadzone=.5;//when moving the cellcursor within this distance from center of view no \n\t\t\t\t\t\t\t\t\t\t//scrolling will be done. 0.5 is half of view, 1 is entire height of view\n\t\tconst distanceRatioCenteringTollerance=1;//if moving the cellcursor within this ratio, but outside of \n\t\t\t\t\t//distanceRatioDeadzone then minimum scrolling will occur only to get within distanceRatioDeadzone\n\t\tconst scrollPos=this._scrollBody.scrollTop;\n\t\tconst scrollHeight=this._scrollBody.offsetHeight;\n\t\tconst cursorY=parseInt(this._cellCursor.style.top);\n\t\tconst cursorHeight=this._cellCursor.offsetHeight;\n\t\tconst distanceFromCenter=cursorY+cursorHeight/2-scrollPos-scrollHeight/2;\n\t\tconst distanceFromCenterRatio=Math.abs(distanceFromCenter/scrollHeight);\n\t\tif (distanceFromCenterRatio>distanceRatioDeadzone/2) {\n\t\t\tif (distanceFromCenterRatio>distanceRatioCenteringTollerance/2)\n\t\t\t\tthis._scrollBody.scrollTop=cursorY-scrollHeight/2+this._rowHeight/2;\n\t\t\telse\n\t\t\t\tthis._scrollBody.scrollTop=cursorY-scrollHeight/2+cursorHeight/2\n\t\t\t\t\t\t\t\t+(distanceFromCenter<0?1:-1)*scrollHeight*distanceRatioDeadzone/2;\n\t\t}\n\t\t//need to call this manually so that elements that are expected to exist after scroll are guaranteed to do so.\n\t\t//changing this._scrollBody.scrollTop actually calls this method anyway but not until all other code as hun.\n\t\t//This will cause it to run it twice but it's not a big deal.\n\t\tthis._scrollMethod();\n\t}\n\n\t_expandRow(tr,animate=true) {\n\t\tconst dataRowIndex=parseInt(tr.dataset.dataRowIndex);\n\t\tif (!this.schema.details||this._rowMetaGet(dataRowIndex)?.h>0)\n\t\t\treturn;\n\t\tconst expRow=this._renderDetails(tr,dataRowIndex);\n\t\tconst expHeight=this._rowMetaSet(dataRowIndex,\"h\",this._rowHeight+expRow.offsetHeight+this._borderSpacingY);\n\t\tconst contentDiv=expRow.querySelector(\".content\");\n\t\tif (!this._detailsBordersHeight)//see declarataion of _detailsTopBottomBorderWidth\n\t\t\tthis._detailsBordersHeight=expHeight-contentDiv.offsetHeight;\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)//adjust scroll-height reflect change...\n\t\t\t+expHeight-this._rowHeight+\"px\";//...in height of the table\n\t\tif (animate) {\n\t\t\tthis._unsortCol(null,\"expand\");\n\t\t\tcontentDiv.style.transition=\"\";\n\t\t\tcontentDiv.style.height=\"0px\";//start at 0\n\t\t\tsetTimeout(()=>contentDiv.style.height=expHeight-this._detailsBordersHeight+\"px\");\n\t\t\tthis._animate(()=>this._adjustCursorPosSize(this._selectedCell,true),500,\"cellCursor\");\n\t\t} else {\n\t\t\tcontentDiv.style.transition=\"none\";\n\t\t\tcontentDiv.style.height=expHeight-this._detailsBordersHeight+\"px\";\n\t\t}\n\t\treturn expHeight;\n\t}\n\n\t_contractRow(tr) {\n\t\tif (tr.classList.contains(\"details\"))\n\t\t\ttr=tr.previousSibling;\n\t\tconst dataRowIndex=parseInt(tr.dataset.dataRowIndex);\n\t\tif (dataRowIndex==this._mainRowIndex&&this._activeDetailsCell)\n\t\t\tthis._exitEditMode(false);//cancel out of edit-mode so field-validation doesn't cause problems\n\t\tif (!this.schema.details||!this._rowMetaGet(dataRowIndex)?.h)\n\t\t\treturn;\n\t\tthis._unsortCol(null,\"expand\");\n\t\tif (this._mainRowIndex==dataRowIndex&&this._activeDetailsCell) {//if cell-cursor is inside the details\n\t\t\tthis._selectMainTableCell(tr.cells[this._mainColIndex]);//then move it out\n\t\t\tthis._scrollToCursor();\n\t\t}\n\t\tconst contentDiv=tr.nextSibling.querySelector(\".content\");\n\t\tif (contentDiv.style.height===\"auto\") {//if fully expanded\n\t\t\tcontentDiv.style.height=this._rowMetaGet(dataRowIndex).h-this._detailsBordersHeight+\"px\";\n\t\t\tsetTimeout(()=>contentDiv.style.height=0);\n\t\t} else if (parseInt(contentDiv.style.height)==0)//if previous closing-animation has reached 0 but transitionend \n\t\t//hasn't been called yet which happens easily, for instance by selecting expand-button and holding space/enter\n\t\t\tcontentDiv.dispatchEvent(new Event('transitionend'));\n\t\telse//if in the middle of animation, either expanding or contracting. make it head towards 0\n\t\t\tcontentDiv.style.height=0;\n\t\tthis._animate(()=>this._adjustCursorPosSize(this._selectedCell,true),500,\"cellCursor\");\n\t}\n\n\t_scrollElementIntoView(element) {\n\t\tif (!this._onlyDetails) {\n\t\t\tconst pos=this._getElPos(element);\n\t\t\tthis._scrollBody.scrollTop=pos.y+element.offsetHeight/2-this._scrollBody.offsetHeight/2;\n\t\t\tthis._scrollMethod();\n\t\t} else\n\t\t\tthis._tooltip.scrollIntoView({behavior:'smooth',block:\"center\"});\n\t}\n\n\t_applyVisibleIf(instanceNode,mainIndex) {\n\t\tconst schemaNode=instanceNode.schemaNode;\n\t\tlet val=this._getTargetVal(false,schemaNode,instanceNode);\n\t\tif (schemaNode.input?.type===\"select\"&&val?.value)\n\t\t\tval=val.value;\n\t\n\t\tinstanceNode.hidden = !!instanceNode.hidden;\n\t\n\t\t//the !! is needed or else undefined will be treated the same as true\n\t\tif (!!schemaNode.visibleIf(val,instanceNode.dataObj,schemaNode,mainIndex,instanceNode) == instanceNode.hidden) {\n\t\t\tinstanceNode.hidden=!instanceNode.hidden;\n\t\t\tinstanceNode.outerContainerEl.style.display=instanceNode.hidden?\"none\":\"\";\n\t\t}\n\t\n\t\treturn !instanceNode.hidden;\n\t}\n}\n"],"names":["TablanceBase","hostEl","rootEl","neighbourTables","_containerHeight","_containerWidth","_colSchemaNodes","_cols","_headerTr","_headerTable","_allData","_data","_scrollRowIndex","_scrollBody","_scrollingContent","_scrollMarginPx","_tableSizer","_mainTable","_mainTbody","_bulkEditArea","_bulkEditTable","_bulkEditAreaOpen","_bulkEditSchemaNodes","_bulkEditAreaHeightPx","_numberOfRowsSelectedSpan","_borderSpacingY","_rowHeight","_rowInnerHeight","_staticRowHeight","_spreadsheet","_opts","_sortingCols","_searchInput","_filter","_cellCursor","_mainRowIndex","_mainColIndex","_activeSchemaNode","_cellCursorDataObj","_selectedCellVal","_selectedCell","_inEditMode","_inputVal","_highlightOnFocus","_detailsBordersHeight","_scrollMethod","_rowsMeta","keys","vals","_filesMeta","_selectedRows","_scrollY","_numRenderedRows","_openDetailsPanes","_activeDetailsCell","_ignoreClicksUntil","_highlightRowsOnView","_lastCheckedIndex","_numRowsSelected","_numRowsInViewSelected","_animations","_onlyDetails","_tooltip","_dropdownAlignmentContainer","constructor","schema","staticRowHeight","spreadsheet","opts","this","document","createElement","appendChild","classList","add","_cloneSchema","main","columns","col","processedCol","type","width","colKey","colVal","Object","entries","push","searchbar","_setupSearchbar","_createTableHeader","_createTableBody","ResizeObserver","_updateSizesOfViewportAndCols","bind","observe","_setupSpreadsheet","sortAscHtml","sortDescHtml","sortNoneHtml","_updateHeaderSortHtml","_buildDependencyGraph","addData","data","highlight","_setDataForOnlyDetails","oldLen","length","value","concat","sortingOccured","_sortData","_filterData","_refreshTable","_maybeAddTrs","numNewInData","style","height","parseInt","dataRow","_highlightRowIndex","indexOf","scrollToDataRow","updateData","dataRow_or_mainIndex","dataPath","newData","scrollTo","onlyRefresh","mainIndx","updatedEls","isNaN","split","dataPortion","i","key","replace","colSchemaNode","colI","id","tr","querySelector","_updateMainRowCell","cells","nodeToUpdate","instanceNodeId","arrayIndex","_findDescendantInstanceNodeById","schemaNode","children","entry","entryI","create","_deleteCell","dataObj","parent","forEach","dataEntry","_repeatInsert","at","_updateDetailsCell","el","scrollIntoView","behavior","block","_highlightElements","getElementsByTagName","_adjustCursorPosSize","nodeSeeds","Set","details","filter","Boolean","cloneRec","obj","isNode","Node","proto","getPrototypeOf","prototype","Array","isArray","has","arr","item","clone","val","child","_closestMeta","startNode","metaKey","node","meta","searchInObj","idToFind","result","expandRow","mainIndex","_expandRow","smooth","scrollY","otherDataRow","offsetHeight","top","_rowMetaGet","h","chainTables","otherTablances","tablances","sort","a","b","elA","container","elB","parentElement","contains","commonCont","from","tablance","up","down","selectTopBottomCellOnlyDetails","_selectFirstSelectableDetailsCell","ctx","_pass1_assignAutoIdsAndMaps","_assignPathsAndData","_pass3_resolveDependencies","stack","initialRoots","pop","_autoId","_path","_dataContextPath","_dataPath","_schemaChildren","autoIdCounter","explicitIdToAutoId","implicitIdToAutoId","schemaNodeByAutoId","seenCellIds","autoId","cellId","Error","autoIdByName","assign","dependsOn","deps","dependentIsExp","cellPaths","dataPaths","depName","depAutoId","console","warn","dependee","dependeeIsExp","fwd","_computeDependencyPath","dependencyPaths","rev","_computeReversePath","_finalizeDependency","uiPath","parentCtx","myCtx","context","String","kids","dependent","to","common","fill","slice","dependsOnCellPaths","dependsOnDataPath","_updateViewportHeight","clientHeight","_attachInputFormatter","format","_normalizeInputFormat","numericOnly","addEventListener","e","test","preventDefault","setAttribute","delimiter","pos","selectionStart","setSelectionRange","dispatchEvent","Event","apply","_applyInputFormatting","date","undefined","blocks","_formatDateValue","out","delim","part","digits","y","m","mm","Math","min","max","padStart","d","dd","Date","getDate","className","placeholder","lang","filterPlaceholder","_onSearchInput","_e","onlyDetails","display","_createBulkEditArea","borderSpacing","_spreadsheetOnFocus","_spreadsheetOnBlur","tabIndex","_spreadsheetKeyDown","_spreadsheetMouseDown","_enterCell","dataIndex","_rowMetaSet","linkIndex","splice","tabbedTo","_selectMainTableCell","rows","removeProperty","outline","_scrollToCursor","setTimeout","activeElement","_moveCellCursor","hSign","vSign","_exitEditMode","_moveInsideLineup","newColIndex","_selectAdjacentDetailsCell","numCols","numRows","currentCellX","offsetLeft","currCelTop","offsetTop","currCelBottom","nextCel","index","offsetParent","_selectDetailsCell","closestCell","closestCellX","siblings","otherCell","abs","instanceNode","isGoingDown","cell","_getAdjacentDetailsCell","nextTable","sibling","hidden","niece","_getFirstSelectableDetailsCell","onlyGetChild","newInstanceNode","startI","chosenCell","childI","select","visibility","input","ctrlKey","stopPropagation","shiftKey","code","_groupEscape","closest","_contractRow","requestAnimationFrame","_toggleRowExpanded","_rowCheckboxChange","endsWith","_insertAtCursor","myField","myValue","selection","focus","createRange","text","startPos","endPos","selectionEnd","substring","_unsortCol","sortCol","_renderDetails","rowIndex","detailsRow","insertRow","dataset","dataRowIndex","detailsCell","insertCell","colSpan","detailsDiv","_detailsAnimationEnd","_generateDetailsContent","currentTarget","target","detailsTr","mainTr","previousSibling","remove","parentEl","path","rowData","_notYetCreated","visibleIf","_applyVisibleIf","_generateDetailsList","arguments","_generateField","_generateDetailsGroup","_generateDetailsRepeated","_generateDetailsLineup","_generateContext","_repeatedOnDelete","cel","onDelete","_fileOnDelete","strct","fileCell","inputSchemaNode","fileInputSchemaNode","fileTd","innerHTML","deleteHandler","_onOpenCreationGroup","groupObject","repeatedSchemaNode","repeatData","insertionPoint","createComment","_generateRepeatedCreator","repeatedObj","creationTxt","creationText","insertNew","creationSchemaNode","closedRender","creator","onOpen","cssClass","_beginDeleteRepeated","creating","containerEl","_cancelDelete","_schemaCopyWithDeleteButton","deleteControls","onBlur","selEl","btnText","deleteText","delete","clickHandler","areYouSureNoText","deleteAreYouSureNo","title","deleteAreYouSureText","deleteAreYouSure","areYouSureYesText","deleteAreYouSureYes","_generateButton","btn","groupSchemaNode","notYetCreated","groupTable","tbody","join","_generateDetailsCollection","renderRow","innerText","listSchemaNode","listTable","titlesColWidth","titlesCol","lineupSchemaNode","contextSchemaNode","containerSchemaNode","collectionObj","childSchemaNode","rptCelObj","_generateCollectionItem","_buildCollectionItemDOM","collection","itemObj","outerContainerEl","td","toggle","nonEmptyDescentants","grpTr","_insertCollectionItem","collectionOrRepeated","collectionEl","siblingAfter","next","nextSibling","base","beforeEl","insertBefore","_changeInstanceNodeIndex","fieldSchemaNode","now","which","interactiveEl","step","preventScroll","shift","checked","_toggleRowsSelected","fromIndex","toIndex","_updateNumRowsSelectionState","_updateBulkEditAreaCells","checkbox","indeterminate","_animate","Infinity","func","runForMs","runUntil","animations","frame","_autoTextAreaResize","maxHeight","scrollHeight","_updateDetailsHeight","contentDiv","mainRowIndex","prevRowHeight","newRowHeight","_openDateEdit","pika","pikaContainer","window","Pikaday","field","toString","getFullYear","getMonth","onClose","destroy","firstDay","showWeekNumber","defaultDate","setDefaultDate","i18n","previousMonth","nextMonth","months","weekdays","weekdaysShort","_alignDropdown","onDraw","position","KeyboardEvent","inputVal","setDate","datePlaceholder","dropdown","alignmentContainer","alignmentPos","_getElPos","scrollTop","clientWidth","x","offsetWidth","left","click","textarea","_openTextAreaEdit","_openSelectEdit","file","_openFileEdit","_openTextEdit","call","_openGroup","groupObj","doOpen","onOpenAfter","_closeGroup","_closeRepeatedInsertion","updateRenderOnClose","renderText","repeated","entrySchemaNode","indexOfNew","sortCompare","root","newObj","onCreateOpen","newIndex","level","pathEl","querySelectorAll","fixObjPath","programatically","newSelectedCell","onCreateCancel","maxLength","_mapAdd","map","_mapGet","_mapRemove","getSelection","empty","fileDiv","fileInput","fileChooseOrDrag","dropDiv","fileDropToUpload","handleFile","_processFileUpload","startsWith","dataTransfer","files","uploadedBytes","bars","xhr","XMLHttpRequest","upload","bar","isConnected","loaded","pct","total","firstChild","fileUploadHandler","fileUploadDone","formData","FormData","append","send","paddingLeft","paddingRight","paddingTop","paddingBottom","getComputedStyle","_renderSelectOptions","ul","selectedVal","foundSelected","opt","li","highlightLiIndex","highlightUlIndex","ulIndex","_highlightSelectOption","liIndex","keyboardNavigating","highlighted","ulDiv","getElementsByClassName","_handleSelectInputChange","hadFilter","filterText","filterChangedAtEdges","includes","canCreate","looseOpts","strctInp","options","pinned","toLowerCase","_updateCreateOptionVisibility","mainUl","pinnedUl","noResults","creationLi","removeChild","_handleSelectKeyDown","direction","_closeSelectDropdown","_handleSelectMouseMove","parentNode","_handleSelectClick","_createSelectDropdownContext","selectContainer","pinnedOpts","inputWrapper","noResultsText","selectNoResultsFound","windowMouseDown","createNewOptionHandler","removeEventListener","backgroundColor","allowCreateNew","minOptsFilter","defaultMinOptsFilter","selectInputPlaceholder","_validateInput","newVal","message","validation","_showTooltip","_updateDependentCells","editedCellSchemaNode","editedInstanceNode","depPath","newCells","cellI","save","stripDelimiterOnSave","replaceAll","_doEditSave","_scrollElementIntoView","repeatEntry","values","doCreate","creationValidation","creationContainer","onCreate","_closeActiveDetailsCell","oldCellParent","cellIndex","_selectCell","oldExpCell","oldParnt","newParent","parentCell","cellEl","adjustCursorPosSize","noPtrEvent","pointerEvents","cellPos","getBoundingClientRect","contPos","onlyPos","elPos","thead","th","_onThClick","_createCheckbox","sortDiv","clickedIndex","tagName","_expandOrContractAll","sortingCol","sortingColIndex","order","expand","row","thIndex","sortCols","aV","aSel","_onScrollStaticRowHeightNoDetails","_onScrollStaticRowHeightDetails","passive","overflow","bulkContent","numberOfRowsSelectedDiv","pagesDiv","mainPage","tableContainer","bulkEditFields","_buildBulkEditSchemaNodes","column","TablanceBulk","mainInstance","_isObject","bulkEdit","schemaNodesToUpdateCellsFor","mixedText","multiCellSchemaNode","multiCellI","lastVal","mixed","rowI","_maybeRemoveTrs","_updateColsWidths","areaWidth","percentageWidthRegex","totalFixedWidth","numUndefinedWidths","pxWidth","sumFixedAndFlexibleWidth","parseFloat","filterString","colsToFilterBy","selectsOptsByVal","optsByVal","match","_refreshTableSizerNoDetails","replaceChildren","scrY","newScrollRowIndex","scrollSignum","sign","_updateRowValues","trToMove","lastChild","prepend","newScrY","topShift","_doRowScrollDetails","newMainIndex","oldMainIndex","detailsHeight","_lookForActiveCellInRow","unshift","_createExpandContractButton","preventClickSelect","_preventDefault","lastTr","scrH","dataLen","div","tdComputedStyle","prop","selected","_humanFileSize","bytes","si","dp","thresh","units","u","r","round","toFixed","_generateFileCell","fileInstanceNode","fileSchemaNode","metaEntries","fileName","fileLastModified","render","toISOString","fileSize","size","fileType","metaName","metaI","fileMetasToShow","defaultFileMetasToShow","fileGroup","btnObj","openHandler","fileData","fileMeta","progressbarOuter","progressbarInner","transition","role","progressSpan","rootCell","oldCellContent","_updateCell","newCellContent","_getValueByPath","cur","_resolveCellPaths","baseCell","_getTargetVal","idOverDependee","selOptObj","find","isDisabled","enabledFuncResult","enabled","html","elements","origColors","super","selectedRow","selectedTr","doUpdate","onChange","newValue","oldValue","closestMeta","cancelUpdate","scrollPos","cursorY","cursorHeight","distanceFromCenter","distanceFromCenterRatio","distanceRatioDeadzone","distanceRatioCenteringTollerance","animate","expRow","expHeight","element"],"mappings":"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"}