{"version":3,"file":"tablance.esm.js","sources":["../src/tablance.js"],"sourcesContent":["\n/** Symbol used to tag wrapper objects to avoid ever double-wrapping. Symbol used over string but not really needed. */\nconst SCHEMA_WRAPPER_MARKER=Symbol(\"schemaWrapper\");\n/** Set of properties allowed on wrapper nodes; access outside this set is forwarded to the raw schema node. */\nconst SCHEMA_WRAPPER_KEYS=new Set([\"raw\", \"parent\", \"main\", \"details\", \"columns\", \"entry\", \"entries\", \"_autoId\",\n\t\"_path\", \"sortDiv\",\"_dataContextPath\",\"_dataPath\", \"dependencyPaths\", \"dependsOnCellPaths\", \"dependsOnDataPath\",\n\t\"pxWidth\", SCHEMA_WRAPPER_MARKER]);\n\nconst TABLANCE_VERSION = typeof __TABLANCE_VERSION__!==\"undefined\"?__TABLANCE_VERSION__:\"dev\";\nconst TABLANCE_BUILD = typeof __TABLANCE_BUILD__!==\"undefined\"?__TABLANCE_BUILD__:\"dev\";\n\n// Shared prototype for instance-nodes so utility getters stay in sync after inserts/deletes.\nconst INSTANCE_NODE_PROTOTYPE=Object.create(null);\nObject.defineProperties(INSTANCE_NODE_PROTOTYPE,{\n\tprevSibling:{get() {\n\t\tconst siblings=this.parent?.children;\n\t\treturn siblings!=null&&Number.isInteger(this.index)?siblings[this.index-1]:undefined;\n\t}},\n\tnextSibling:{get() {\n\t\tconst siblings=this.parent?.children;\n\t\treturn siblings!=null&&Number.isInteger(this.index)?siblings[this.index+1]:undefined;\n\t}}\n});\n\n\n/** \n * Base class providing shared table logic, structure management,\n * data handling, and rendering helpers etc used by both Tablance and TablanceBulk.\n */\nclass TablanceBase {\n\thostEl;//the element that is passed to the constructor and which the table is added to\n\trootEl;//Readonly, container-element for table\n\tneighbourTables;//Object of other Tablance-instances. Possible keys are \"up\" and \"down\". If any of these are set\n\t\t\t\t//then if one keeps pressing up/down until there are no more cells then one will get o the next table.\n\t\t\t\t//Except for manually this can also be set via chainTables()\n\t_containerHeight=0;//height of #container. Used to keep track of if height shrinks or grows\n\t_containerWidth=0;//height of #container. Used to keep track of if width shrinks or grows\n\t_colSchemaNodes;//column-objects. Essentially the same as schema.main.columns but have been processed an may in\n\t\t// addition contain \"sortDiv\" reffering to the div with the sorting-html (see for example opts->sortAscHtml)\n\t_cols=[];//array of col-elements for each column\n\t_headerTr;//the tr for the top header-row\n\t_headerTable;//the tabe for the #headerTr. This table only contains that one row.\n\t_allData=[];//contains all, unfiltered data that has been added via addData()\n\t_data=[];//with no filter applied(empty seachbar) then this is reference to _allData, otherwise is a subset of it\n\t_scrollRowIndex=0;//the index in the #data of the top row in the view\n\t_scrollBody;//resides directly inside #container and is the element with the scrollbar. It contains #scrollingDiv\n\t_scrollingContent;//a div that is inside #scrollbody and holds #tablesizer and #cellCursor if spreadsheet\n\t\t\t\t\t//this is needed because putting #cellCursor directly inside #scrollBody will not make it scroll\n\t\t\t\t\t//because it has position absolute and needs that. And putting it inside #tableSizer will cause it\n\t\t\t\t\t//to jump up and down when pos and height of #tableSizer is adjusted to keep correct scroll-height\n\t_scrollMarginPx=150;//is used to allow for more rows to be rendered outside of the view so to speak. At least in\n\t\t\t\t\t\t//firefox when scrolling it is really noticable that the scrolling is done before the rows are\n\t\t\t\t\t\t//moved which reveals white area before the rows are rendered. Increasing this number will\n\t\t\t\t\t\t//basically add that many pixels to the height of the viewport on top and bottom. It will not\n\t\t\t\t\t\t//actually be higher but the scroll-method will see it as if it is higher than it is\n\t_tableSizer;//a div inside #scrollingDiv which wraps #mainTable. The purpose of it is to set its height to the \n\t\t\t\t//\"true\" height of the table so that the scrollbar reflects all the data that can be scrolled through\n\t_mainTable;//the actual main-table that contains the actual data. Resides inside #tableSizer\n\t_mainTbody;//tbody of #mainTable\n\n\t_bulkEditArea;//a div displayed under #scrollBody if rows are selected/checked using select-column. This \n\t\t\t\t\t\t//section is used to edit multiple rows at once\n\t_bulkEditTable;//this holds another instance of the Tablance class which is used inside the bulk-edit-area\n\t_bulkEditAreaOpen=false;//whether the section is currently open or not\n\t_bulkEditSchemaNodes;//Array of schema-nodes with inputs that are present in the bulk-edit-area\n\t_bulkEditAreaHeightPx;//height of bulk-edit-area in px. Used to animate from 0 to full height when opening/closing\n\t_numberOfRowsSelectedSpan;//resides in the bulk-edit-area. Should be set to the number of rows selected\n\t_borderSpacingY;//the border-spacing of #mainTable. This needs to be summed with offsetHeight of tr (#rowHeight) to \n\t\t\t\t\t//get real distance between the top of adjacent rows\n\t_rowHeight=0;//the height of (non expanded) rows with #borderSpacingY included. Assume 0 first until first row added\n\t_rowInnerHeight=0;//this is the height that the div inside main-tds should be set to. It's calculated from \n\t\t\t\t\t//#rowHeight minus top&bottom-padding minus #borderSpacingY of td. This is needed to make sure each\n\t\t\t\t\t//row is always of the same height and things don't get messed up because some row is heigher\n\t\t\t\t\t//because it has high content.\n\t_staticRowHeight;//This is set in the constructor. If it is true then all rows should be of same height which\n\t\t\t\t\t //improves performance.\n\t_spreadsheet;//whether the table is a spreadsheet, which is set in the constructor\n\t_opts; //reference to the object passed as opts in the constructor\n\t_sortingCols=[];//contains data on how the table currently is sorted. It is an array of \n\t\t\t\t\t\t\t\t\t\t//objects which each contain \"index\" which is the index of the column and\n\t\t\t\t\t\t\t\t\t\t//\"order\" which value should be either \"desc\" or \"asc\". The array may contain\n\t\t\t\t\t\t\t\t\t\t//multiple of these objects for having it sorted on multiple ones.\n\t_searchInput;//the input-element used for filtering data\n\t_filter;//the currently applied filter. Same as #searchInput.value but also used for comparing old & new values\n\t\n\t_cellCursor;//The element that for spreadsheets shows which cell is selected\n\t_mainRowIndex;//the index of the row that the cellcursor is at\n\t_mainColIndex;//the index of the column that the cellcursor is at.\n\t_activeSchemaNode;//reference to the schemaNode-object of the selcted cell. For cells in the maintable this would\n\t\t\t\t\t\t//point to an object in #colSchemaNodes, otherwise to the schemaNode-object of details-cells\n\t_cellCursorDataObj;//reference to the actual object holding the data that the cell-cursor currently is at.\n\t\t\t\t\t\t//Usually this will simply point to an object in #data but for data that is nested with\n\t\t\t\t\t\t//repeat-entries this will point to the correct inner object\n\t_selectedCellVal;//the value of the cell that the cellCursor is at\n\t_selectedCell;//the HTML-element of the cell-cursor. probably TD's most of the time.\n\t_inEditMode;//whether the user is currently in edit-mode\n\t//and values are px as ints. This is used to offset the position and adjust position of #cellCursor in order to\n\t//center it around the cell. It is also used in conjunction with cellCursorOutlineWidth to adjust margins of the\n\t//main-table in order to reveal the outermost line when an outermost cell is selected\n\t_inputVal;//the current val of the input when in edit-mode. Will be read and commited if cell is exited correctly\n\t_highlightOnFocus=true;//when the spreadsheet is focused  we want focus-outline to appear but only if focused by\n\t\t\t\t//keyboard-tabbing, and not when clicking or exiting out of edit-mode which again focuses the table.\n\t\t\t\t//By setting this to true in mouseDownEvent we can \n\t\t\t\t//check which input was used last when the focus-method is triggerd\n\t_detailsBordersHeight;//when animating details-pane for expanding/contracting the height of them fully\n\t\t\t//expanded needs to be known to know where to animate to and from. This is different from \n\t\t\t//#expandedRowIndicesHeights because that is the height of the whole row and not the div inside.\n\t\t\t//we could retrieve offsetheight of the div each time a row needs to be animated or instead we can get\n\t\t\t//the border-top-width + border-bottom-width once and then substract that from the value of  what's in\n\t\t\t//#expandedRowIndicesHeights instead\n\t_scrollMethod;//this will be set to a reference of the scroll-method that will be used. This depends on settings for\n\t\t\t\t//staticRowHeight and details\n\t_rowsMeta={keys:[],vals:[]};//This holds meta-data for the data-rows. The structure is essentially like a hashmap\n\t\t\t//from Java where objects are used as keys which in this case it is the data-row-object. This is done by\n\t\t\t//having 2 arrays: keys & vals. A references to a row is placed in \"keys\" and meta-data placed in \"vals\"\n\t\t\t//and index X in \"keys\" always corresponds to index X in \"values\". As for the meta-data itself this is\n\t\t\t//another object:\n\t\t\t//\th Integer \tIf this is present then the row is expanded, otherwise not. The value is the combined height\n\t\t\t//\t\t\t\tof the main row and its details-row.\n\t_filesMeta={keys:[],vals:[]};//Similiar to rowsMeta as it is structured the same but used for files that the user\n\t\t\t\t\t\t\t\t//has uploaded during the current session. This is to keep track of upload-progress.\n\t\t\t\t\t\t\t\t//keys are filled with File-objects while vals is filled with objects containing\n\t\t\t\t\t\t\t\t//metadata: uploadedBytes\n\t_selectedRows=[];//array of the actual data-objects of rows that are currently selected/checked using the select-col\n\t_scrollY=0;//this keeps track of the \"old\" scrollTop of the table when a scroll occurs to know \n\t_numRenderedRows=0;//number of tr-elements in the table excluding tr's that are details (details too are tr's)\n\t_openDetailsPanes={};//for any row that is expanded and also in view this will hold navigational data which\n\t\t\t\t\t\t//is read from when clicking or navigating using keyboard to know which cell is next, and\n\t\t\t\t\t\t//which elements even are selectable and so on. Keys are data-row-index. As soon as a row\n\t\t\t\t\t\t//is either contracted or scrolled out of view it is removed from here and then re-added\n\t\t\t\t\t\t//if expanded again or scrolled into view.\n\t\t\t\t\t\t//keys are rowDataindex and the values are instanceTrees rooted at an instance-node shaped as:\n\t\t\t\t\t\t//\tel: HTMLElement the cell-element itself\n\t\t\t\t\t\t//\tchildren: Array May be null but groups can have children which would be put in here\n\t\t\t\t\t\t//  \t\t\t\teach element would be another instance-node\n\t\t\t\t\t\t//\tparent: points to the parent instance-node. for non nested cells this would point to a\n\t\t\t\t\t\t//\t\t\t\t\t\troot instance-node. and for the root instance-node this would be null.\n\t\t\t\t\t\t//\t\t\t\t\t\tdespite the root being an instance-node it cant be naviagted to. \n\t\t\t\t\t\t//\t\t\t\t\t\tit simply holds the top instance-nodes\n\t\t\t\t\t\t//  index: the index of the node in the children-array of its parent\n\t\t\t\t\t\t//\tprevSibling/nextSibling: getters for adjacent siblings (null if none)\n\t\t\t\t\t\t//}\n\t_activeDetailsCell;\t//points to an object in #openDetailsNavMap and in extension the cell of an details.\n\t\t\t\t\t\t\t//If this is set then it means the cursor is inside an details.\n\t/* #generatingDetails=false;//this is a flag that gets set to true when a row gets expanded or an already expanded\n\t\t//row gets scrolled into view, in short whenever the details-elements are generated. Then it gets unset when\n\t\t//creation finishes. The reason for having this flag is so that update */\n\t_ignoreClicksUntil;//when being inside an open group and trying to double-click on another cell further down to\n\n\n\t\t//interact with it the first click will highlight it but then the current group closes and what's below it will\n\t\t//get shifted up and the second click hits something else. By setting this var to current time plus 500 ms\n\t\t//when a group closes and checking if current time is past this one in mouseDown handler we'll ignore the second\n\t\t//click which is better user-experience\n\t_highlightRowsOnView={};//Rows can be added to this object with rowindex in #data as key, value needs to be truthy.\n\t\t//Rows that are outside of view can be added and when scrolled into view they will be highlighted. \n\t_lastCheckedIndex;//This is the index of the row that was last (un)checked/selected, meaning the checkbox in the\n\t\t\t\t\t//select-column was interacted with. This is used if the user interacts with another checkbox while\n\t\t\t\t\t//shift is being held\n\t_numRowsSelected=0;//number of rows that are selected/checked using the select-column\n\t_numRowsInViewSelected=0;//number of rows in the current view/filter that are selected/checked using select-column\n\t_animations={};//keeps tracks of animations. Key is a unique id-string, identifying the animation so multiple\n\t\t\t\t\t//instances of the same animation can't run. Value is the end-time in ms since epoch.\n\t_onlyDetails;//If this is set to true then the table will not have any actual rows and will instead only have an\n\t\t\t\t\t// details specified in param details. It will also not have a scrollpane and the details will\n\t\t\t\t\t// always be expanded. Method addData is still used to add the actual data but it will only use the\n\t\t\t\t\t// last row sent. So adding multiple ones will cause it to discard all but the last.\n\t_tooltip;//reference to html-element used as tooltip\n\t_dropdownAlignmentContainer;\t\t\t\t\t\t\n\n\t/**\n\t * @param {HTMLElement} hostEl An element which the table is going to be added to\n\t * @param {{}[]} columns An array of objects where each object has the following structure: {\n\t * \t\t\tid String A unique identifier for the column. The value in the data that has this key will be used as\n\t * \t\t\t\tthe value in the cell.\n\t * \t\t\ttitle String The header-string of the column\n\t * \t\t\twidth String The width of the column. This can be in either px or % units.\n\t * \t\t\t\tIn case of % it will be calculated on the remaining space after all the fixed widths\n\t * \t\t\t\thave been accounted for.\n\t * \t\t\tinput: See param details -> input. This is the same as that one except textareas are only valid for\n\t * \t\t\t\t\t\t\t\t\t\t\t\tdetails-cells and not directly in a maintable-cell\n\t * \t\t\trender Function Function that can be set to render the content of the cell. The return-value is what\n\t * \t\t\t\t\twill be displayed in the cell. Similiarly to columns->render it gets passed the following:\n\t * \t\t\t\t\t1: The value from data pointed to by \"id\". If id is not set but dependsOn is then this will \n\t * \t\t\t\t\t\tinstead get passed the value that the id of the depended cell points to, \n\t * \t\t\t\t\t2: data-row, \n\t * \t\t\t\t\t3: schemaNode,\n\t * \t\t\t\t\t4: main-index \n\t * \t\t\thtml Bool Default is false. If true then the content of the cell will be rendered as html\n\t * 1: The value from data pointed to by \"id\", 2: data-row, 3: schemaNode,4: main-index, 5: instanceNode\n\t * \t\t\ttype String The default is \"data\". Possible values are:\n\t * \t\t\t\t\"data\" - As it it implies, simply to display data but also input-elements such as fields or buttons\n\t * \t\t\t\t\"expand\" - The column will be buttons used for expanding/contracting the rows. See param details\n\t * \t\t\t\t\"select\" - The column will be checkboxes used to (un)select rows\t\n\t * \t\t}\n\t * \t\t\t\n\t * \t@param\t{Boolean} staticRowHeight Set to true if all rows are of same height. With this option on, scrolling\n\t * \t\t\t\tquickly through large tables will be more performant.\n\t * \t@param\t{Boolean} spreadsheet If true then the table will work like a spreadsheet. Cells can be selected and the\n\t * \t\t\t\tkeyboard can be used for navigating the cell-selection.\n\t * \t@param\t{Object} details This allows for having rows that can be expanded to show more data. An \"entry\"-object\n\t * \t\t\tis expected and some of them can hold other entry-objects so that they can be nested.\n\t * \t\t\tProperties that are valid for all types of entries:\n\t * \t\t\t\t* title String displayed title if placed in a container which displays the title\n\t *\n\t * \t\t\t\t* visibleIf Function Optional callback that determines whether this entry should be visible.\n\t * \t\t\t\t\tThe function is called whenever the entry is rendered or any of its dependencies\n\t * \t\t\t\t\t(see `dependsOn`) change. It receives the following arguments:\n\t * \t\t\t\t\t\t(1: The value from data pointed to by \"id\"(or if dependsOn is set the value of that cell)\n\t * \t\t\t\t\t\t2: data-row, 3: schemaNode, 4: main-index, 5: instanceNode)\n\t * \t\t\t\t\tReturn `true` to make the entry visible, or `false` to hide it.\n\t *\n\t * \t\t\t\t\tWhen hidden:\n\t *   \t\t\t\t\t- The entry’s DOM element is not displayed.\n\t *   \t\t\t\t\t- `render` will not be called for this entry.\n\t *\n\t * \t\t\t\t\tVisibility state:\n\t *   \t\t\t\t\t- The instanceNode receives an internal `hidden` flag when the entry is hidden.\n\t *   \t\t\t\t\t- `hidden` is read-only and should not be modified manually.\n\t *   \t\t\t\t\t- If the entry is visible, no `hidden` property is present.\n\t *\n\t *\n\t * \t\t\t\t* dependsOn String Optional string identifying another entry that this entry depends on.\n\t * \t\t\t\t\tWhenever the referenced entry is edited, this entry automatically refreshes.\n\t * \t\t\t\t\tThe refresh cycle includes:\n \t *\t\t\t\t\t\t- Re-evaluating `visibleIf` (if provided).\n\t *\t\t\t\t\t\t- Re-rendering this entry (unless it is hidden).\n\t *\n \t *\t\t\t\t\tTargeting rules:\n\t * \t\t\t\t\t\t1. If `cellId` is set on the schemaNode of a field, that ID is the identifier of that entry.\n\t * \t\t\t\t\t\t2. If `id` is set (and `cellId` is not), the value of `id` becomes the entry’s identifier.\n\t * \t\t\t\t\t\t3. `dependsOn` must match the identifier of another entry. If both `id` and `cellId` exist,\n\t * \t\t\t\t\t\t\t`cellId` takes priority.\n\t * \t\t\tTypes of entries:\n\t * \t\t\t{\n  \t *\t\t\t\ttype \"list\" this is an entry that holds multiple rows laid out vertically, each item in the list \n\t *\t\t\t\t\t\t\tcan have a title on the left side by specifying \"title\" in each item within the list\n\t * \t\t\t\tentries Array each element should be another entry\n\t * \t\t\t\ttitlesColWidth:String Width of the column with the titles. Don't forget adding the unit.\n\t * \t\t\t\t\tDefault is null which enables setting the width via css.Setting 0/false turns it off completely.\n\t * \t\t\t\tonBlur: Function Callback fired when cellcursor goes from being inside the container to outside\n\t * \t\t\t\t\tIt will get passed arguments 1:instanceNode, 2:mainIndex\n\t * \t\t\t\tbulkEdit Bool Besides setting bulkEdit on input of fields it can also be set on containers which\n\t * \t\t\t\t\t\t\twill add the container to the bulk-edit-area. Any input-fields in the container that\n\t * \t\t\t\t\t\t\thave bulkEdit true will appear in the container there. Remember that both the container\n\t * \t\t\t\t\t\t\tand input of fields have to have true bulkEdit for this to work. These can also be\n\t * \t\t\t\t\t\t\tnested so if there's another group in the group where both have true bulkEdit and the\n\t * \t\t\t\t\t\t\tinner group has inputs with true bulkEdit as well then multi-level groups will be \n\t * \t\t\t\t\t\t\tadded to the bulk-edit-area. Containers in the bulk-edit-area appear as a normal cell\n\t * \t\t\t\t\t\t\tat first but by entering it a page dedicated to that container is changed to.\n\t * \t\t\t\tdependsOn String Can be set up to \n\t *\t\t\t}\n\t *\t\t\t{\t\n\t *\t\t\t\ttype \"lineup\" similiar to a list but each item is inlined, meaning they will be lined up\n\t *\t\t\t\t\t\t\t\t\tin a horizontal line and will also wrap to multiple lines if needed\n\t * \t\t\t\tentries Array each element should be another entry\n\t * \t\t\t\tcssClass String Css-classes to be added to the lineup-div\n\t * \t\t\t\tonBlur Function Callback fired when cellcursor goes from being inside the container to outside\n\t * \t\t\t\t\tIt will get passed arguments 1:instanceNode, 2:mainIndex\n\t * \t\t\t\tbulkEdit Bool Besides setting bulkEdit on input of fields it can also be set on containers which\n\t * \t\t\t\t\t\t\twill add the container to the bulk-edit-area. Any input-fields in the container that\n\t * \t\t\t\t\t\t\thave bulkEdit true will appear in the container there. Remember that both the container\n\t * \t\t\t\t\t\t\tand input of fields have to have true bulkEdit for this to work. These can also be\n\t * \t\t\t\t\t\t\tnested so if there's another group in the group where both have true bulkEdit and the\n\t * \t\t\t\t\t\t\tinner group has inputs with true bulkEdit as well then multi-level groups will be \n\t * \t\t\t\t\t\t\tadded to the bulk-edit-area. Containers in the bulk-edit-area appear as a normal cell\n\t * \t\t\t\t\t\t\tat first but by entering it a page dedicated to that container is changed to.\n\t *\t \t\t}\n\t *\t\t\t{\n  \t * \t\t\t\ttype \"field\" this is what will display data and which also can be editable by specifying \"input\"\n  \t * \t\t\t\tid String the key of the property in the data that the row should display\n\t * \t\t\t\tcssClass String Css-classes to be added to the field\n\t * \t\t\t\trender Function Function that can be set to render the content of the cell. The return-value is what\n\t * \t\t\t\t\twill be displayed in the cell. Similiarly to columns->render it gets passed the following:\n\t * \t\t\t\t\t1: The value from data pointed to by \"id\". If id is not set but dependsOn is then this will \n\t * \t\t\t\t\t\tinstead get passed the value that the id of the depended cell points to, \n\t * \t\t\t\t\t2: data-row, \n\t * \t\t\t\t\t3: schemaNode,\n\t * \t\t\t\t\t4: main-index, \n\t * \t\t\t\t\t5: instanceNode\n\t * \t\t\t\tinput Object field is editable if this object is supplied and its \"disabled\"-prop is not true\n\t * \t\t\t\t\t{\n\t * \t\t\t\t\ttype String This is mandatory and specifies the type of input. Se further down for properties \n\t * \t\t\t\t\t\tspecific to each type of input. The possible types are:\n\t * \t\t\t\t\t\t\t\"text\"(single line text),\n\t * \t\t\t\t\t\t\t\"textarea\"(multi-line text),\n\t * \t\t\t\t\t\t\t\"number\"(number with stepper),\n\t * \t\t\t\t\t\t\t\"date\"(a date and possibly time with a calendar),\n\t * \t\t\t\t\t\t\t\"select\"(selection from a list of items. The values for cells may either be the \"value\" \n\t * \t\t\t\t\t\t\t\t\t\tspecified in one the the options in \"options\", or it can be an actual \n\t * \t\t\t\t\t\t\t\t\t\treference to the option)\n\t * \t\t\t\t\t\t\t\"button\"(simple button)\n\t * \t\t\t\t\t\t\t\"file\" (An input for uploading files. The data for a file entry may be a \n\t * \t\t\t\t\t\t\t\tFile-object which it will be if the file has been uploaded during the current\n\t * \t\t\t\t\t\t\t\tsession. Or it may be an object which basically have the same properties\n\t * \t\t\t\t\t\t\t\tas File:lastModified, name, size, type altough none of those properties are\n\t * \t\t\t\t\t\t\t\tmandatory. Use property \"fileUploadHandler\" to handle the actual upload.)\n\t * \t\t\t\t\t----Properties valid for ALL types of inputs----\n\t * \t\t\t\t\t\tplaceholder String adds a placeholder-string to the input-element\n\t * \t\t\t\t\t\tvalidation Function A callback function which can be used to validate the data upon\n\t * \t\t\t\t\t\t\tcomitting it. Return true if validation was successfull.\n\t * \t\t\t\t\t\t\tIt gets passed the following arguments:\n\t * \t\t\t\t\t\t\t1:newValue, 2: message-function - A function that that takes a message-string as its\n\t * \t\t\t\t\t\t\tfirst argument. If it the validation didn't go through then this string will be\n\t * \t\t\t\t\t\t\tdisplayed to the user. 3:schemaNode, 4:rowData, 5:mainIndex, \n\t * \t\t\t\t\t\t\t6:instanceNode(if details-cell)\n\t *\t\t\t\t\t\ttitle String String displayed title if placed in a container which displays the title\n\t * \t\t\t\t\t\tbulkEdit Bool Whether this input should be editable via bulk-edit-area, the section that \n\t * \t\t\t\t\t\t\tappears when selecting/checking multiple rows using the select-col. Default is true if\n\t * \t\t\t\t\t\t\tnot in details, or false if in details.\n\t * \t\t\t\t\t\t\tContainers can too be added to the bulk-edit-area by setting bulkEdit on the container.\n\t * \t\t\t\t\t\tmultiCellWidth Int For inputs that are present in the bulk-edit-area. This property can be \n\t * \t\t\t\t\t\t\tused to specify the number of pixels in width of the cell in that section.\n\t * \t\t\t\t\t\tonChange Function Callback fired when the user has changed the value of the input.\n\t * \t\t\t\t\t\t\tIt receives a single object with:\n\t * \t\t\t\t\t\t\t- newValue: the incoming value\n\t * \t\t\t\t\t\t\t- oldValue: the previous value\n\t * \t\t\t\t\t\t\t- dataKey: schemaNode.id of the edited field\n\t * \t\t\t\t\t\t\t- dataContext: the data object being edited (row or nested object)\n\t * \t\t\t\t\t\t\t- schemaNode: schema node for the edited field\n\t * \t\t\t\t\t\t\t- instanceNode: the instance node if in details\n\t * \t\t\t\t\t\t\t- closestMeta: function(key) to read meta data closest to the schema node. In the schema\n\t * \t\t\t\t\t\t\t\tobjects may be specified via \"meta\" propert and this object may contain any custom\n\t * \t\t\t\t\t\t\t\tdata. This function allows reading that data easily. It traverses up the schema tree\n\t * \t\t\t\t\t\t\t\tuntil it finds a meta with the specified key or reaches the root.\n\t * \t\t\t\t\t\t\t- cancelUpdate: function() to prevent the value from being persisted\n\t * \t\t\t\t\t\tonBlur Function Callback fired when cellcursor goes from being inside the container\n\t * \t\t\t\t\t\t\tto outside. It will get passed arguments 1:instanceNode, 2:mainIndex\n\t * \t\t\t\t\t\tenabled Function - If present then this function will be run and if it returns falsey then\n\t * \t\t\t\t\t\t\tthe cell will not be editable. It may also return an object structured as:\n\t * \t\t\t\t\t\t\t{enabled:Bool, message:String}. The message will be displayed to the user \n\t * \t\t\t\t\t\t\tif edit is attempted and enabled is set to false, disabling the field\n\t * \t\t\t\t\t\t\tIt gets passed the following arguments - \n\t * \t\t\t\t\t\t\t1:schemaNode,2:rowData,3:mainIndex,4:instanceNode(if in details)\n\t * \t\t\t\t\t----Properties specific to input \"text\"----\n\t * \t\t\t\t\t\tformat object When defined, Tablance automatically applies the specified pattern to \n\t * \t\t\t\t\t\t\tthe <input> element as the user types. It can enforce numeric-only input, insert\n\t * \t\t\t\t\t\t\tdelimiters, and handle smart date validation.\n\t * \t\t\t\t\t\t\tSupported properties:\n\t * \t\t\t\t\t\t\t - blocks:        \t\t\tArray of block lengths to group the input (e.g. [4,2,2])\n\t * \t\t\t\t\t\t\t - delimiter:     \t\t\tString inserted between blocks (default: none)\n\t * \t\t\t\t\t\t\t - numericOnly:   \t\t\tBoolean, removes all non-digit characters\n\t * \t\t\t\t\t\t\t - date:          \t\t\tBoolean, enables smart date validation\n\t * \t\t\t\t\t\t\t - stripDelimiterOnSave:\tBoolean, if true delimiters are excluded in the saved data\n\t * \t\t\t\t\t\t\tExamples:\n\t * \t\t\t\t\t\t\t// Personnummer: 19900218-9999\n\t * \t\t\t\t\t\t\tinput: {\n\t * \t\t\t\t\t\t\t\ttype: \"text\",\n\t * \t\t\t\t\t\t\t\tformat: { blocks: [8, 4], delimiter: \"-\", numericOnly: true }\n\t * \t\t\t\t\t\t\t}\n\t * \t\t\t\t\t\t\t// Date (YYYY-MM-DD) with month/day clamping and leap-year handling\n\t * \t\t\t\t\t\t\tinput: {\n\t * \t\t\t\t\t\t\t\ttype: \"text\",\n\t * \t\t\t\t\t\t\t\tformat: { date: true, blocks: [4, 2, 2], delimiter: \"-\", numericOnly: true }\n\t * \t\t\t\t\t\t\t}\n\t * \t\t\t\t\t\t\t\n\t * \t\t\t\t\t\tmaxLength int Sets max-length for the string\t\t\t\t\t\t\t\n\t * \t\t\t\t\t----Properties specific to input \"textarea\"----\n\t * \t\t\t\t\t\tmaxHeight int Sets the max-height in pixels that it should be able to be resized to\n\t * \t\t\t\t\t----Properties specific to input \"file\"----\n\t * \t\t\t\t\t\tfileUploadHandler Function This callback will be triggered when the user does a file-upload.\n\t * \t\t\t\t\t\t\tArguments: 1:XMLHttpRequest - call open() on this to specify url and such,\n\t * \t\t\t\t\t\t\t2: The File-object, 3:schemaNode,4:rowData,5:mainIndex,6:instanceNode(if in details)\n\t * \t\t\t\t\t\tfileMetasToShow Object An object specifying which meta-bits to show. Default of all are true\n\t * \t\t\t\t\t\t\t{filename Bool, lastModified Bool, size Bool, type Bool}\n\t * \t\t\t\t\t\t\tMay also be set via opts->defaultFileMetasToShow\n\t * \t\t\t\t\t\topenHandler Function callback-function for when the open-button is pressed. It gets the\n\t * \t\t\t\t\t\t\tfollowing arguments passed to it: \n\t * \t\t\t\t\t\t\t1: Event, 2: File-object, 3:schemaNode,4:rowData,5:mainIndex,\n\t * \t\t\t\t\t\t\t6:instanceNode(if in details)\n\t * \t\t\t\t\t\tdeleteHandler Function callback-function for when the user deletes a file. It gets the \n\t * \t\t\t\t\t\t\tfollowing arguments passed to it:\n\t * \t\t\t\t\t\t\t1: Event, 2: File-object, 3:schemaNode,4:rowData,5:mainIndex,\n\t * \t\t\t\t\t\t\t6:instanceNode(if in details)\n\t * \t\t\t\t\t----Properties specific to input \"select\"----\n\t * \t\t\t\t\t\tminOptsFilter Integer - The minimum number of options required for the filter-input to\n\t * \t\t\t\t\t\t\tappear. Can also be set via param opts->defaultMinOptsFilter\n\t * \t\t\t\t\t\tnoResultsText String A string which is displayed when a user filters the \n\t * \t\t\t\t\t\t\toptions in a select and there are no results. \n\t * \t\t\t\t\t\t\tCan also be set globally via param opts->lang->selectNoResultsFound\n\t * \t\t\t\t\t\toptions: Array Each element should be an object: {\n\t * \t\t\t\t\t\t\tvalue * The value of the cell will be mapped to the option with the same value\n\t * \t\t\t\t\t\t\ttext String Unless a render-method has been set then this string will be shown\n\t * \t\t\t\t\t\t\tpinned Bool If true then this option will be pinned at the top. Default is false\n\t * \t\t\t\t\t\t\tcssClass: Css-classes to be added to the opt which actually is a li-element\n\t * \t\t\t\t\t\t}\n\t * \t\t\t\t\t\tallowCreateNew bool - Allows user to create new options.\n\t * \t\t\t\t\t\t\t\tIf this is true then minOptsFilter will be ignored, input-field is required anyway.\n\t * \t\t\t\t\t\tcreateNewOptionHandler Function - Callback which is called when the user creates a new \n\t * \t\t\t\t\t\t\toption, which can be done if allowCreateNew is true. It will get passed arguments \n\t * \t\t\t\t\t\t\t1:new option-object,2:event, 3:dataObject,4:mainDataIndex,\n\t * \t\t\t\t\t\t\t5:schemaNode,6:instanceNode(if inside details)\n\t * \t\t\t\t\t\tselectInputPlaceholder String - A placeholder for the input which is\n\t * \t\t\t\t\t\t\tvisible either if the number of options exceed minOptsFilter or allowCreateNew is true\n\t * \t\t\t\t\t}\n\t * \t\t\t\t\t----Properties specific to input \"button\"----\n\t * \t\t\t\t\t\tbtnText String If type is \"button\" then this will be the text on it\n\t * \t\t\t\t\t\tclickHandler Function A callback-function that will get called  when the button is pressed. \n\t * \t\t\t\t\t\t\tIt will get passed arguments 1:event, 2:dataObject\n\t * \t\t\t\t\t\t\t,3:mainDataIndex,4:schemaNode,5:instanceNode(if inside details)\n  \t * \t\t\t\t}\n\t * \t\t\t}\n\t * \t\t\t{\n  \t * \t\t\t\ttype:\"repeated\" Used for \"repeated\" sets of data. The same data-structure is repeated as many times \n\t * \t\t\t\t\tas there are data for it. This also allows adding/removing data on the fly and besides doing it \n\t * \t\t\t\t\tprogramatically there's a built in interface for the user to do that.\n\t * \t\t\t\t\tHaving a list-structure with a repeated->field basically works the same as having a list with\n\t * \t\t\t\t\tmultiple field-structures. List-structures can mix repeated(dynamic) and static fields.\n\t * \t\t\t\t\tThe structure could look something like:\n\t * \t\t\t\t\t\t\t\tlist\n\t * \t\t\t\t\t\t\t\t\trepeated\n\t * \t\t\t\t\t\t\t\t\t\tfield\n\t * \t\t\t\t\t\t\t\t\tfield1\n\t * \t\t\t\t\t\t\t\t\tfield2\n  \t * \t\t\t\tid String this should be the key of an array in the data where each object corresponds to each\n\t * \t\t\t\t\t\t\telement in this repeated rows.\n  \t * \t\t\t\tentry Object Any entry. May be item or list for instance. The data retrieved for these will be 1\n\t * \t\t\t\t\t\t\t\tlevel deeper so the path from the base would be idOfRepeatedRows->arrayIndex->*\n\t * \t\t\t\tcreate: Bool If true then there will be a user-interface for creating and deleting entries\n\t * \t\t\t\tonCreate Function Callback fired when the user has created an entry via the interface available if\n\t * \t\t\t\t\t\"create\" is true. It is considered committed when the cell-cursor has left the repeat-row after\n\t * \t\t\t\t\thaving created it. Receives a single object:\n\t * \t\t\t\t\t- newDataItem: the newly created data object\n\t * \t\t\t\t\t- dataContext: the object owning the repeated array (row-data or nested object)\n\t * \t\t\t\t\t- dataKey: key on dataContext for the repeated array (repeated schema id)\n\t * \t\t\t\t\t- dataArray: the array the item-data was inserted into\n\t * \t\t\t\t\t- itemIndex: index of the new item within dataArray\n\t * \t\t\t\t\t- repeatedSchemaNode: the repeated container schema node\n\t * \t\t\t\t\t- entrySchemaNode: the schema node for the created entry (often a group)\n\t * \t\t\t\t\t- newInstanceNode: the instance node for the created entry\n\t * \t\t\t\t\t- mainIndex: index of the root row\n\t * \t\t\t\t\t- bulkEdit: true if triggered from bulk-edit\n\t * \t\t\t\t\t- closestMeta: function(key) to read meta data closest to the schema node\n\t * \t\t\t\t\t- cancelCreate: function() to abort the creation (removes the new item)\n\t * \t\t\t\tonCreateOpen Function If the entry of the repeated is group and \"create\" is set to true, then this\n\t * \t\t\t\t\tcallback-function will be called when a new group is added, i.e. when the user interacts with\n\t * \t\t\t\t\tinsertNew-cell, not when the data is actually created, that triggers \"onCreate\".\n\t * \t\t\t\t\tIt will get passed arguments: 1:instanceNode of the repeated-object\n\t * \t\t\t\tonCreateCancel Function If the entry of the repeated is group and \"create\" is set to true, then this\n\t * \t\t\t\t\tcallback-function will be called when the creation of a new entry is canceled, either by leaving\n\t * \t\t\t\t\tthe group with no data inserted, or by pressing the delete/cancel-button.\n\t * \t\t\t\t\tIt will get passed arguments: 1:instanceNode of the repeated-object\n\t * \t\t\t\tonDelete Function Callback fired when the user has deleted an entry via the interface available if\n\t * \t\t\t\t\t\"create\" is true. It will get passed arguments: 1:rowData,2:instanceNode\n\t * \t\t\t\tsortCompare Function Passing in a function allows for sorting the entries. As expected this\n\t * \t\t\t\t\tfunction will get called multiple times to compare the entries to one another.\n\t * \t\t\t\t\tIt gets 4 arguments: 1: object A, 2: object B, 3: rowData, 4: instanceNode\n\t * \t\t\t\t\tReturn >0 to sort A after B, <0 to sort B after A, or ===0 to keep original order of A and B\n\t * \t\t\t\tcreationText String Used if \"create\" is true. the text of the creation-cell. Default is \"Insert new\"\n\t * \t\t\t\t\tMay also be set via opts->lang->insertNew\n\t * \t\t\t\tdeleteText String used if \"create\" is true. the text of the deletion-button. Default is \"Delete\"\n\t * \t\t\t\t\tcan also be set via param opts->lang->delete\n\t * \t\t\t\tdeleteAreYouSureText String Used if \"create\" is true. Text above yes/no-btns.\n\t * \t\t\t\t\tDefault is \"Are you sure?\". Can also be set via param opts->lang->deleteAreYouSure\n\t * \t\t\t\tareYouSureYesText String Used if \"create\" is true. Text of confirm-button for delete.\n\t * \t\t\t\t\tDefault is \"Yes\". Can also be set via param opts->lang->deleteAreYouSureYes\n\t * \t\t\t\tareYouSureNoText String Used if \"create\" is true. Text of cancel-button for delete. Default is \"No\"\n\t * \t\t\t\t\tCan also be set via param opts->lang->deleteAreYouSureNo\n\t * \t\t\t\tbulkEdit Bool If set to true then this will appear in the bulk-edit-area which allows editing\n\t * \t\t\t\t\trepeated data for multiple data-rows at once. Applying the data does not append the data but it\n\t * \t\t\t\t\treplaces it meaning the repeated rows already present in the selected rows are removed.\n  \t * \t\t\t}\n  \t * \t\t\t{\n  \t * \t\t\t\ttype \"group\" Used when a set of data should be grouped. An example is when having an address and\n\t * \t\t\t\t\tall the rows in it belongs together. The group also has to be entered/opened with enter/dblclick\n  \t * \t\t\t\ttitle String String displayed title if placed in a container which displays the title\n\t * \t\t\t\tcssClass String Css-classes to be added to the group\n  \t * \t\t\t\tentries Array Array of entries. fields, lists, etc.. \n\t * \t\t\t\tclosedRender Function pass a method here that will get the data for the group as first arg.\n\t * \t\t\t\t\t\t\t\tit needs to return a string which will replace the group-content when it is closed\n\t * \t\t\t\tcreationValidation Function If this group is placed within a repeated-container with create set to\n\t * \t\t\t\t\t\t\t\ttrue then this function will be executed upon commiting the creation. If the\n\t * \t\t\t\t\t\t\t\tfunction returns true then the validation succeeded and the group will be created.\n\t * \t\t\t\t\t\t\t\tIt will get passed the following arguments:\n\t * \t\t\t\t\t\t\t\t1: message-function - A function that that takes a message-string as its first\n\t * \t\t\t\t\t\t\t\t\targument. If it the validation didn't go through then this string will be\n\t * \t\t\t\t\t\t\t\t\tdisplayed to the user.\n\t * \t\t\t\t\t\t\t\t2:schemaNode, 3:rowData(all the entered data of the group), 4:mainIndex, \n\t * \t\t\t\t\t\t\t\t5:instanceNode\n\t * \t\t\t\tbulkEdit Bool Besides setting bulkEdit on input of fields it can also be set on containers which\n\t * \t\t\t\t\t\t\twill add the container to the bulk-edit-area. Any input-fields in the container that\n\t * \t\t\t\t\t\t\thave bulkEdit true will appear in the container there. Remember that both the container\n\t * \t\t\t\t\t\t\tand input of fields have to have true bulkEdit for this to work. These can also be\n\t * \t\t\t\t\t\t\tnested so if there's another group in the group where both have true bulkEdit and the\n\t * \t\t\t\t\t\t\tinner group has inputs with true bulkEdit as well then multi-level groups will be \n\t * \t\t\t\t\t\t\tadded to the bulk-edit-area. Containers in the bulk-edit-area appear as a normal cell\n\t * \t\t\t\t\t\t\tat first but by entering it a page dedicated to that container is changed to.\n\t * \t\t\t\tonOpen Function Function that fires when the group is opened, before it has been rendered.\n\t * \t\t\t\t\tGets passed the following arguments:\n\t * \t\t\t\t\t1: tablanceEvent-object. It has a preventDefault-function that can be called in order to\n\t * \t\t\t\t\tprevent the group from actually opening. 2: group-object\n\t * \t\t\t\tonOpenAfter Function Function that fires when the group is opened, but after it has been rendered.\n\t * \t\t\t\t\tGets passed the following arguments:\n\t * \t\t\t\t\t1: group-object\n\t * \t\t\t\tonClose Function Callback that is fired when the group closes. Gets passed the following arguments:\n\t * \t\t\t\t\t1: group-object\n  \t * \t\t\t}\n\t * \t@param\t{Object} opts An object where different options may be set. The following options/keys are valid:\n\t * \t\t\t\t\t\t\tsearchbar Bool that defaults to true. If true then there will be a searchbar that\n\t * \t\t\t\t\t\t\t\tcan be used to filter the data.\n\t * \t\t\t\t\t\t\tsortAscHtml String - html to be added to the end of the th-element when the column\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tis sorted in ascending order\n\t * \t\t\t\t\t\t\tsortDescHtml String - html to be added to the end of the th-element when the column\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tis sorted in descending order\n\t * \t\t\t\t\t\t\tsortNoneHtml String - html to be added to the end of the th-element when the column\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tis not sorted\n\t * \t\t\t\t\t\t\tdefaultMinOptsFilter Integer The minimum number of options required for the\n\t * \t\t\t\t\t\t\t\tfilter-input of input-type \"select\" to appear\n\t * \t\t\t\t\t\t\tdefaultFileMetasToShow Object Default meta-data for files to show.\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tSee prop fileMetasToShow in param details\n\t * \t\t\t\t\t\t\tlang Object {  Object to replace language-specific text. The strings may be html-code\n\t * \t\t\t\t\t\t\t\t\t\texcept for ones used as placeholders. Below are the keys and defaults.\n\t * \t\t\t\t\t\t\t\tfileName \"Filename\"\n\t * \t\t\t\t\t\t\t\tfileLastModified \"Last Modified\"\n\t * \t\t\t\t\t\t\t\tfileSize \"Size\"\n\t * \t\t\t\t\t\t\t\tfileType \"Type\"\n\t * \t\t\t\t\t\t\t\tfileUploadDone \"Done!\"\n\t * \t\t\t\t\t\t\t\tfileChooseOrDrag \"<b>Press to choose a file</b> or drag it here\"\n\t * \t\t\t\t\t\t\t\tfileDropToUpload \"<b>Drop to upload</b>\"\n\t *\t\t\t\t\t\t\t\tfilterPlaceholder \"Search\"\n\t * \t\t\t\t\t\t\t\tdelete \"Delete\" (used in the deletion of repeat-items or files)\n\t * \t\t\t\t\t\t\t\tdeleteAreYouSure \"Are you sure?\" (Used in the deletion of repeat-items or files)\n\t * \t\t\t\t\t\t\t\tdeleteAreYouSureYes \"Yes\"  (Used in the deletion of repeat-items or files)\n\t * \t\t\t\t\t\t\t\tdeleteAreYouSureNo\t\"No\" (Used in the deletion of repeat-items)\n\t * \t\t\t\t\t\t\t\tdatePlaceholder \"YYYY-MM-DD\"\n\t * \t\t\t\t\t\t\t\tselectNoResultsFound \"No results found\"\n\t * \t\t\t\t\t\t\t\tinsertNew \"Insert New\" (Used in repeat-schemaNode if create is set to true)\n\t * \t\t\t\t\t\t\t}\n\t * */\n\tconstructor(hostEl,schema,staticRowHeight=false,spreadsheet=false,opts=null){\n\t\tthis.hostEl=hostEl;\n\t\tconst rootEl=this.rootEl = document.createElement(\"div\");\n\t\tthis.hostEl.appendChild(this.rootEl);\n\t\tthis._spreadsheet=spreadsheet;\n\t\tthis._staticRowHeight=staticRowHeight;\n\t\tthis._opts=opts??{};\n\t\trootEl.classList.add(\"tablance\");\n\t\tthis._schema=this._buildSchemaFacade(schema);\n\t\tif (!schema.main?.columns) {\n\t\t\tthis._setupSpreadsheet(true);\n\t\t\tthis._onlyDetails=true;\n\t\t} else {\n\t\t\t// for (let col of this._schema.main.columns) {\n\t\t\t// \tlet processedCol={};\n\t\t\t// \tif ((col.type==\"expand\"||col.type==\"select\")&&!col.width)\n\t\t\t// \t\tprocessedCol.width=50;\n\t\t\t// \tfor (let [colKey,colVal] of Object.entries(col))\n\t\t\t// \t\t//if (allowedColProps.includes(colKey))\n\t\t\t// \t\t\tprocessedCol[colKey]=colVal;\n\t\t\t// \tthis._colSchemaNodes.push(processedCol);\n\t\t\t// }\n\t\t\tthis._colSchemaNodes=this._schema.main.columns;\n\t\t\tif (this._opts.searchbar!=false)\n\t\t\t\tthis._setupSearchbar();\n\t\t\tthis._createTableHeader();\n\t\t\tthis._createTableBody();\n\t\t\t(new ResizeObserver(this._updateSizesOfViewportAndCols.bind(this))).observe(hostEl);\n\t\t\tthis._setupSpreadsheet(false);\n\t\t\t\n\n\t\t\tif (this._opts.sortAscHtml==null)\n\t\t\t\tthis._opts.sortAscHtml='<svg viewBox=\"0 0 8 10\" style=\"height:1em\"><polygon style=\"fill:#ccc\" '\n\t\t\t\t\t\t\t\t\t+'points=\"4,0,8,4,0,4\"/><polygon style=\"fill:#000\" points=\"4,10,0,6,8,6\"/></svg>';\n\t\t\tif (this._opts.sortDescHtml==null)\n\t\t\t\tthis._opts.sortDescHtml='<svg viewBox=\"0 0 8 10\" style=\"height:1em\"><polygon style=\"fill:#000\" '\n\t\t\t\t\t\t\t\t\t+'points=\"4,0,8,4,0,4\"/><polygon style=\"fill:#ccc\" points=\"4,10,0,6,8,6\"/></svg>';\n\t\t\tif (this._opts.sortNoneHtml==null)\n\t\t\t\tthis._opts.sortNoneHtml='<svg viewBox=\"0 0 8 10\" style=\"height:1em\"><polygon style=\"fill:#ccc\" '\n\t\t\t\t\t\t\t\t\t+'points=\"4,0,8,4,0,4\"/><polygon style=\"fill:#ccc\" points=\"4,10,0,6,8,6\"/></svg>';\n\t\t\tthis._updateHeaderSortHtml();\n\t\t\tthis._buildDependencyGraph(this._schema);\n\t\t\tthis._createBulkEditArea(schema);//send in the raw schema for this one\n\t\t\tthis._updateSizesOfViewportAndCols();\n\t\t}\n\t}\n\n\t_createInstanceNode(parent=null,index=null) {\n\t\treturn Object.assign(Object.create(INSTANCE_NODE_PROTOTYPE),{parent,index});\n\t}\n\n\taddData(data, highlight=false) {\n\t\tif (this._onlyDetails)\n\t\t\treturn this._setDataForOnlyDetails(data)\n\t\tconst oldLen=this._data.length;\n\t\tif (highlight)\n\t\t\tthis._searchInput.value=this._filter=\"\";//remove any filter\n\t\tthis._data=this._allData=this._allData.concat(data);\n\t\t//this._data.push(...data);//much faster than above but causes \"Maximum call stack size exceeded\" for large data\n\t\tlet sortingOccured=this._sortData();\n\t\tif (this._filter)\n\t\t\tthis._filterData(this._filter);\n\t\telse {\n\t\t\tif (sortingOccured)\n\t\t\t\tthis._refreshTable();\n\t\t\telse\n\t\t\t\tthis._maybeAddTrs();\n\t\t\tconst numNewInData=this._data.length-oldLen;\n\t\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height||0)+numNewInData*this._rowHeight+\"px\";\n\t\t}\n\t\tif (highlight) {\n\t\t\tfor (let dataRow of data)\n\t\t\t\tthis._highlightRowIndex(this._data.indexOf(dataRow));\n\t\t\tthis.scrollToDataRow(data[0],false);//false for not highlighting, above line does the highlight anyway\n\t\t}\n\t}\n\n\t/**Change or add any data in the table\n\t * @param {int|object} dataRow_or_mainIndex Either the actual data-object that should be updated, or its index in\n\t * \t\t\t\t\t\t\t\t\t\t\tthe current view\n\t * @param {string|string[]} dataPath The path to the data-value that should be updated or added to. For a value in\n\t * \t\t\tthe base which is not nested within repeated-containers it should simply be the id of the property.\n\t * \t\t\tIt can either be a string of keys separated by dots(.) or an array where each element is a key.\n\t * \t\t\tFor repeated-arrays which data should be added to, \"[]\" can be used similiar to how it's done in PHP.\n\t * \t\t\tFor instance the path could be \"foo[]\" or \"foo[].bar\". Objects/arrays will be created recursively\n\t * \t\t\tif they don't yet exist.\n\t * @param {*} newData The actual data to be replaced with or added\n\t * @param {bool} scrollTo Whether the modified/added data should be scrolled to and highlighted.\n\t * @param {bool} onlyRefresh If true then no new data will be written and argument \"data\" will be ignored.\n\t * \t\t\t\t\t\t\tThe cell will only be refreshed with the value already present in the data.\n\t * @returns The tablance-object, for chaining*/\n\tupdateData(dataRow_or_mainIndex,dataPath,newData,scrollTo=false,onlyRefresh=false) {\n\t\tlet dataRow;//simply an element from #data, e.g. a whole dataset for a row of the maintable.\n\t\tlet mainIndx;//the index of dataRow\n\t\tlet updatedEls=[];\n\t\tif (!isNaN(dataRow_or_mainIndex))\n\t\t\tdataRow=this._data[mainIndx=dataRow_or_mainIndex];\n\t\telse //if (typeof dataRow_or_mainIndex==\"object\")\n\t\t\tmainIndx=this._data.indexOf(dataRow=dataRow_or_mainIndex);\n\t\tdataPath=typeof dataPath==\"string\"?dataPath.split(/\\.|(?=\\[\\d*\\])/):dataPath;\n\n\t\tif (!onlyRefresh) {//if we're not only refreshing the cell but actually modifying/adding data\n\t\t\t//update the actual data, deal with the dom later\n\t\t\tlet dataPortion=dataRow;//object that is going to have a property updated, or array that will be pushed to\n\t\t\tfor (let i=0; i<dataPath.length; i++) {\n\t\t\t\tconst key=i%2?dataPath[i].replace(/^\\[|\\]$/g,\"\"):dataPath[i];//get rid of brackets. \n\t\t\t\t//key is now either property-name, string-int for index, or empty string for pushing\n\t\t\t\tif (i==dataPath.length-1)//if last step\n\t\t\t\t\tdataPortion[key||dataPortion.length]=newData;//assign the data\n\t\t\t\telse if (!key)//not last step and empty string, meaning push\n\t\t\t\t\tdataPortion=dataPortion[dataPortion.length]={};//do push\n\t\t\t\telse//not last step and key is index or property-name\n\t\t\t\t\tdataPortion=dataPortion[key]??(dataPortion[key]=i%2?[]:{});\n\t\t\t}\n\t\t}\n\n\t\tif (mainIndx<this._scrollRowIndex||mainIndx>=this._scrollRowIndex+this._numRenderedRows)\n\t\t\treturn;//the row to be updated is outside of view. It'll be updated automatically if scrolled into view\n\t\t\n\t\t//is it a column of the main-table?\n\t\tif (dataPath.length==1) //it's possible only if the path is a single id-key. (but still not guaranteed)\n\t\t\tfor (let colI=-1,colSchemaNode;colSchemaNode=this._colSchemaNodes[++colI];)\n\t\t\t\tif (colSchemaNode.id==dataPath[0]) {//if true then yes, it was a column of main-table\n\t\t\t\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${mainIndx}\"]:not(.details)`);\n\t\t\t\t\treturn this._updateMainRowCell(tr.cells[colI],colSchemaNode);//update it and be done with this\n\t\t\t\t}\n\n\t\t//The data is somewhere in details\n\t\t\n\t\tlet nodeToUpdate=this._openDetailsPanes[mainIndx];//points to the instance-node that will be subject for update\n\t\tif (!nodeToUpdate)//if the updates details is not open\n\t\t\treturn;\n\n\t\t//look through the celObjToUpdate and its descendants-tree (currently set to whole details), following the\n\t\t//dataPath. At the end of this loop celObjToUpdate should be set to the deepest down object that dataPath points\n\t\t//to, and pathIndex should be the index in dataPath that is the last step pointing to celObjToUpdate.\n\t\t//When simply editing an already existing field then celObjToUpdate would be the container of that cell, and\n\t\t//pathIndex would be set to the index of the last element in dataPath\n\t\tfor (let i=0,instanceNodeId; instanceNodeId=dataPath[i]; i+=2) {\n\t\t\tconst arrayIndex=dataPath[i+1]?.replace(/^\\[|\\]$/g,\"\");\n\t\t\tnodeToUpdate=this._findDescendantInstanceNodeById(nodeToUpdate,instanceNodeId);\n\t\t\tif (nodeToUpdate.schemaNode.type==\"repeated\") {//should be true until possibly last iteration\n\t\t\t\tif (i==dataPath.length-1) {//final array-index not specified. replace all of the data in repeated\n\n\t\t\t\t\t//remove all the current entries. Do it backwards so that the remaining entries doesn't have to\n\t\t\t\t\t//have their index&path updates each time\n\t\t\t\t\tconst children=nodeToUpdate.children;\n\t\t\t\t\tfor (let entryI=children.length-!!nodeToUpdate.schemaNode.create,entry; entry=children[--entryI];)\n\t\t\t\t\t\tthis._deleteCell(entry,true);\n\n\t\t\t\t\t//insert all the new data\n\t\t\t\t\tnodeToUpdate.dataObj=nodeToUpdate.parent.dataObj[nodeToUpdate.schemaNode.id];\n\t\t\t\t\tnodeToUpdate.dataObj.forEach(\n\t\t\t\t\t\t\t\t\tdataEntry=>updatedEls.push(this._repeatInsert(nodeToUpdate,false,dataEntry)));\n\t\t\t\t\tbreak;\n\t\t\t\t} else if (arrayIndex) {//index pointing at existing repeated-child\n\t\t\t\t\tnodeToUpdate=nodeToUpdate.children[arrayIndex];\n\t\t\t\t} else {//[] - insert new\n\t\t\t\t\tupdatedEls.push(this._repeatInsert(nodeToUpdate,false,nodeToUpdate.dataObj.at(-1)));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (nodeToUpdate.schemaNode.type==\"field\")\n\t\t\tthis._updateDetailsCell(nodeToUpdate,dataRow);\n\t\tif (scrollTo) {\n\t\t\tnodeToUpdate.el.scrollIntoView({behavior:'smooth',block:\"center\"});\n\t\t\tupdatedEls.forEach(el=>this._highlightElements([el,...el.getElementsByTagName('*')]));\n\t\t}\n\t\tthis._adjustCursorPosSize(this._selectedCell,true);\n\t}\n\n\t/**\n\t * Build a wrapped-schema tree from the raw user schema.\n\t *\n\t * RULES:\n\t * - The raw schema is never cloned or mutated.\n\t * - Only schema-structure keys (main, details, columns, entry, entries) are recursed into.\n\t * - Config objects (input, meta, validators, etc.) are ignored and never wrapped.\n\t * - The wrapper tree mirrors schema structure but contains only:\n\t *       { raw: <raw node>, parent: <wrapped parent>, and wrapped children }\n\t * @param {*} rawSchema\tThe user-provided schema node.\n\t * @param {*} parentWrappedNode The wrapped parent, if any.\n\t * @returns {*}         The root wrapped schema-node.\n\t */\n\t_buildSchemaFacade(rawNode, parentWrappedNode=null) {\n\n\t\t// Reject null/undefined & non-objects. Could be left for isPojo-check but that throws error on undefined\n\t\tif (!rawNode || typeof rawNode!=\"object\")\n\t\t\treturn null;\n\n\t\t// Already wrapped? Return as-is to avoid double wrapping.\n\t\tif (rawNode[SCHEMA_WRAPPER_MARKER])\n\t\t\treturn rawNode;\n\n\t\t// Accept only POJOs and arrays.\n\t\t// This ensures we only traverse expected schema structures\n\t\t// and never recurse into exotic/custom objects.\n\t\tconst proto = Object.getPrototypeOf(rawNode);\n\t\tconst isPojo = proto===Object.prototype || proto===null;\n\t\tif (!isPojo && !Array.isArray(rawNode))\n\t\t\treturn null;\n\n\t\t//const wrappedNode = Object.assign(Object.create(null), {raw: rawNode,parent: parentWrappedNode});\n\t\tconst wrappedNode = createSchemaNodeFacade(rawNode, parentWrappedNode);\n\n\t\t// ---- CHILD NODE PROCESSING ----\n\t\t// We recurse ONLY into known schema-node containers.\n\t\t// Everything else inside the raw schema object is left untouched.\n\n\t\t// main\n\t\tif (rawNode.main && typeof rawNode.main==\"object\")\n\t\t\twrappedNode.main = this._buildSchemaFacade(rawNode.main, wrappedNode);\n\n\t\t// details\n\t\tif (rawNode.details && typeof rawNode.details==\"object\")\n\t\t\twrappedNode.details = this._buildSchemaFacade(rawNode.details, wrappedNode);\n\n\t\t// columns (array of schema-nodes)\n\t\tif (Array.isArray(rawNode.columns)) {\n\t\t\tconst cols = [];\n\t\t\tfor (const col of rawNode.columns) {\n\t\t\t\tconst wrappedCol = this._buildSchemaFacade(col, wrappedNode);\n\t\t\t\tif (wrappedCol)\n\t\t\t\t\tcols.push(wrappedCol);\n\t\t\t}\n\t\t\tif (cols.length)\n\t\t\t\twrappedNode.columns = cols;\n\t\t}\n\n\t\t// entry (single schema-node)\n\t\tif (rawNode.entry && typeof rawNode.entry==\"object\")\n\t\t\twrappedNode.entry = this._buildSchemaFacade(rawNode.entry, wrappedNode);\n\n\t\t// entries (multiple schema-nodes)\n\t\tif (Array.isArray(rawNode.entries)) {\n\t\t\tconst arr = [];\n\t\t\tfor (const child of rawNode.entries) {\n\t\t\t\tconst wrappedChild = this._buildSchemaFacade(child, wrappedNode);\n\t\t\t\tif (wrappedChild)\n\t\t\t\t\tarr.push(wrappedChild);\n\t\t\t}\n\t\t\twrappedNode.entries = arr;\n\t\t}\n\n\t\treturn wrappedNode;\n\n\t\tfunction createSchemaNodeFacade(rawNode, parentWrappedNode) {\n\t\t\tconst newWrapper = Object.assign(Object.create(null), {raw: rawNode, [SCHEMA_WRAPPER_MARKER]: true});\n\t\t\tif (parentWrappedNode)\n\t\t\t\tnewWrapper.parent = parentWrappedNode;\n\t\t\treturn new Proxy(newWrapper, {\n\t\t\t\tget:(target, prop)=>SCHEMA_WRAPPER_KEYS.has(prop)?target[prop]:target.raw[prop],\n\t\t\t\tset(target, prop, value) {\n\t\t\t\t\tif (SCHEMA_WRAPPER_KEYS.has(prop)) {\n\t\t\t\t\t\ttarget[prop] = value;\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\tthrow new Error(`Cannot write ${prop} to schema-node. Add it to SCHEMA_WRAPPER_KEYS if intended.`);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\n\n\t/**\n\t * Searches upward through schema-node parents to find a meta value.\n\t * @param {*} startNode  The schema-node where the search begins.\n\t * @param {string} metaKey  The meta key to look for.\n\t * @returns {*} The found value or undefined.\n\t */\n\t_closestMeta(startNode, metaKey) {\n\t\tfor (let node=startNode; node; node=node.parent)\n\t\t\tif (node.meta && metaKey in node.meta)\n\t\t\t\treturn node.meta[metaKey];\n\t}\n\n\t_findDescendantInstanceNodeById(searchInObj,idToFind) {\n\t\tfor (const child of searchInObj.children)\n\t\t\tif (child.schemaNode.id==idToFind)//if true then its the repeated-obj we're looking for\n\t\t\t\treturn child;\n\t\t\telse if (child.children) {//if container-obj\n\t\t\t\tconst result=this._findDescendantInstanceNodeById(child,idToFind);\n\t\t\t\tif (result)\n\t\t\t\t\treturn result;\n\t\t\t}\n\t}\n\n\t/**Expands a row and returns the details instance-tree root.\n\t * @param int mainIndex\n\t * @returns Object Root instance-node (outer-most instanceNode)*/\n\texpandRow(mainIndex) {\n\t\tif (this._onlyDetails)\n\t\t\treturn this._openDetailsPanes[0];\n\t\tlet tr=this._mainTbody.querySelector(`[data-data-row-index=\"${mainIndex}\"]`);\n\t\tif (!tr) {\n\t\t\tthis.scrollToDataRow(this._data[mainIndex],false,false);\n\t\t\tthis._scrollMethod();//needed to get everythig to render before having to wait for next frame\n\t\t\ttr=this._mainTbody.querySelector(`[data-data-row-index=\"${mainIndex}\"]`);\n\t\t}\n\t\tthis._expandRow(tr);\n\t\treturn this._openDetailsPanes[mainIndex];\n\t}\n\n\tscrollToDataRow(dataRow,highlight=true,smooth=true) {\n\t\tlet scrollY=0;\n\t\tfor (let i=-1,otherDataRow;otherDataRow=this._data[++i];) {\n\t\t\tif (otherDataRow==dataRow) {\n\t\t\t\tscrollY=scrollY-this._scrollBody.offsetHeight/2+this._rowHeight;\n\t\t\t\tthis._scrollBody.scrollTo({top:scrollY,behavior:smooth?\"smooth\":\"auto\"});\n\t\t\t\tif (highlight)\n\t\t\t\t\tthis._highlightRowIndex(i);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tscrollY+=this._rowMetaGet(i)?.h??this._rowHeight;\n\t\t}\n\t}\n\n\t/**Use this method to set neighbourTables automatically by just supplying all the other tables. It will figure out\n\t * in which order they appear in the html and set neighbourTables accordingly.\n\t * @param  {...Tablance} otherTablances */\n\tchainTables(...otherTablances) {\n\t\tconst tablances=[this,...otherTablances];\n\t\ttablances.sort(sort);\n\t\tfor (let i=-1,tablance;tablance=tablances[++i];)\n\t\t\ttablance.neighbourTables={up:tablances[i-1],down:tablances[i+1]};\n\t\tfunction sort(a,b) {\n\t\t\tlet elA=a.container, elB=b.container;\n\t\t\t//set elA to its (grand)parent which is the closest element where the parent also holds elB in its hiearchy\n\t\t\tfor (;!elA.parentElement.contains(elB);elA=elA.parentElement);\n\t\t\tconst commonCont=elA.parentElement;//the closest element that holds both elA and elB\n\t\t\t//set elB to the closest element that is a direct child of commonCont\n\t\t\tfor (;elA.parentElement!=elB.parentElement;elB=elB.parentElement);\n\t\t\treturn Array.from(commonCont.children).indexOf(elA)>Array.from(commonCont.children).indexOf(elB)?1:-1;\n\t\t}\n\t}\n\n\tselectTopBottomCellOnlyDetails(top) {\n\t\tthis._highlightOnFocus=false;\n\t\tthis._selectFirstSelectableDetailsCell(this._openDetailsPanes[0],top);\n\t}\n\n\t\n\t/**\n\t * Build a complete dependency graph and assign internal autoIds.\n\t *\n\t * This walks the wrapped schema tree (main.columns + details) and enriches each\n\t * schema-node with metadata needed for dependency resolution and runtime lookups.\n\t *\n\t * Permanent runtime metadata produced on wrapped schema-nodes:\n\t *  - dependencyPaths: UI-forward paths (dependee → dependent)\n\t *  - dependsOnCellPaths: reverse structural path(s) (exp→exp)\n\t *  - dependsOnDataPath: absolute data path for non-exp→exp deps\n\t *\n\t * Temporary builder-only metadata (removed in PASS 4):\n\t *  - _autoId\n\t *  - _path\n\t *  - _dataContextPath\n\t *  - _dataPath\n\t *\n\t * @param {*} schema\tRoot of the wrapped schema tree.\n\t */\n\t_buildDependencyGraph(schema) {\n\n\t\t//---- PASS 1 — Assign autoIds + collect ID maps ----\n\t\tconst ctx = this._dep_pass1_assignAutoIdsAndMaps(schema);\n\n\t\t//---- PASS 2 — Compute UI path & data paths ----\n\t\tthis._dep_pass2_assignPathsAndData(schema);\n\n\t\t//---- PASS 3 — Resolve dependsOn and build dependency metadata ----\n\t\tthis._dep_pass3_resolveDependencies(ctx);\n\n\t\t//---- PASS 4 — Cleanup: remove all temporary builder-only metadata ----\n\t\tthis._dep_pass4_cleanup(ctx);\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tPASS 1 — Assign autoIds + collect ID maps\n\t───────────────────────────────────────────────────────────*/\n\t_dep_pass1_assignAutoIdsAndMaps(wrappedSchema) {\n\t\tconst ctx = Object.create(null);\n\t\tctx.autoIdCounter      = 0;\n\t\tctx.explicitIdToAutoId = Object.create(null);\n\t\tctx.implicitIdToAutoId = Object.create(null);\n\t\tctx.schemaNodeByAutoId = Object.create(null);\n\t\tctx.seenCellIds        = Object.create(null);\n\n\t\tconst roots = [];\n\t\tconst cols = wrappedSchema.main && Array.isArray(wrappedSchema.main.columns)? wrappedSchema.main.columns: [];\n\t\tfor (let i = 0; i < cols.length; i++)\n\t\t\troots.push(cols[i]);\n\n\t\tif (wrappedSchema.details)\n\t\t\troots.push(wrappedSchema.details);\n\n\t\tctx.initialRoots = roots;\n\n\t\tlet stack = [...roots];\n\n\t\tfor (let schemaNode; schemaNode = stack.pop();) {\n\t\t\tconst autoId = ++ctx.autoIdCounter;\n\t\t\tschemaNode._autoId = autoId;\n\t\t\tctx.schemaNodeByAutoId[autoId] = schemaNode;\n\n\t\t\tif (schemaNode.cellId != null) {\n\t\t\t\tif (ctx.seenCellIds[schemaNode.cellId])\n\t\t\t\t\tthrow new Error(`Duplicate cellId \"${schemaNode.cellId}\".`);\n\t\t\t\tctx.seenCellIds[schemaNode.cellId] = true;\n\t\t\t\tctx.explicitIdToAutoId[schemaNode.cellId] = autoId;\n\t\t\t} else if (schemaNode.id != null)\n\t\t\t\tctx.implicitIdToAutoId[schemaNode.id] = autoId;\n\n\t\t\tstack.push(...this._dep_children(schemaNode));\n\t\t}\n\n\t\tctx.autoIdByName = Object.assign(\n\t\t\tObject.create(null),\n\t\t\tctx.implicitIdToAutoId,\n\t\t\tctx.explicitIdToAutoId\n\t\t);\n\n\t\treturn ctx;\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tPASS 2 — Assign _path, _dataContextPath, and _dataPath\n\t───────────────────────────────────────────────────────────*/\n\t_dep_pass2_assignPathsAndData(wrappedSchema) {\n\t\tif (wrappedSchema.details)\n\t\t\tthis._dep_assignPathsAndData(wrappedSchema.details, [], []);\n\n\t\tconst cols = wrappedSchema.main && Array.isArray(wrappedSchema.main.columns)? wrappedSchema.main.columns: [];\n\n\t\tfor (let i = 0; i < cols.length; i++)\n\t\t\tthis._dep_assignPathsAndData(cols[i], [\"m\", i], []);\n\t}\n\n\t_dep_assignPathsAndData(schemaNode, uiPath, parentCtx = []) {\n\t\tschemaNode._path = uiPath;\n\n\t\tlet myCtx=parentCtx;\n\t\tif (schemaNode.dataPath) {\n\t\t\tconst dataPathArr=Array.isArray(schemaNode.dataPath) ? schemaNode.dataPath\n\t\t\t\t: String(schemaNode.dataPath).split(\".\").filter(Boolean);\n\t\t\tmyCtx = [...parentCtx, ...dataPathArr];\n\t\t}\n\n\t\tschemaNode._dataContextPath = myCtx;\n\n\t\tif (schemaNode.id != null)\n\t\t\tschemaNode._dataPath = [...myCtx, String(schemaNode.id)];\n\n\t\tconst kids = this._dep_children(schemaNode);\n\n\t\tfor (let i = 0; i < kids.length; i++)\n\t\t\tthis._dep_assignPathsAndData(kids[i], [...uiPath, i], myCtx);\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tPASS 3 — Resolve dependsOn and build dependency metadata\n\t───────────────────────────────────────────────────────────*/\n\t_dep_pass3_resolveDependencies(ctx) {\n\t\tlet stack = [...ctx.initialRoots];\n\n\t\tfor (let schemaNode; schemaNode = stack.pop();) {\n\n\t\t\tif (schemaNode.dependsOn) {\n\t\t\t\tconst deps = Array.isArray(schemaNode.dependsOn) ? schemaNode.dependsOn : [schemaNode.dependsOn];\n\n\t\t\t\tconst dependentIsExp = schemaNode._path && schemaNode._path[0] !== \"m\";\n\t\t\t\tconst cellPaths = [];\n\t\t\t\tconst dataPaths = [];\n\n\t\t\t\tfor (const depName of deps) {\n\t\t\t\t\tconst depAutoId = ctx.autoIdByName[depName];\n\n\t\t\t\t\tif (depAutoId == null) {\n\t\t\t\t\t\tconsole.warn(`Unknown dependsOn \"${depName}\".`, schemaNode);\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst dependee = ctx.schemaNodeByAutoId[depAutoId];\n\t\t\t\t\tconst dependeeIsExp = dependee._path && dependee._path[0] !== \"m\";\n\n\t\t\t\t\tconst fwd = this._dep_computeForwardPath(dependee, schemaNode);\n\n\t\t\t\t\tif (fwd)\n\t\t\t\t\t\t(dependee.dependencyPaths ??= []).push(fwd);\n\n\t\t\t\t\tif (dependentIsExp && dependeeIsExp) {\n\t\t\t\t\t\tconst rev = this._dep_computeReversePath(schemaNode, dependee);\n\t\t\t\t\t\tif (rev && rev.length)\n\t\t\t\t\t\t\tcellPaths.push(rev);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (dependee._dataPath)\n\t\t\t\t\t\t\tdataPaths.push(dependee._dataPath);\n\t\t\t\t\t\telse if (dependee.id != null || dependee.cellId != null)\n\t\t\t\t\t\t\tconsole.warn(\"Dependee has no dataPath:\", dependee);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis._dep_finalizeDependency(schemaNode, cellPaths, dataPaths);\n\t\t\t}\n\n\t\t\tstack.push(...this._dep_children(schemaNode));\n\t\t}\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tPASS 4 — Cleanup: remove temporary builder-only metadata\n\t───────────────────────────────────────────────────────────*/\n\t_dep_pass4_cleanup(ctx) {\n\t\tlet stack = [...ctx.initialRoots];\n\n\t\tfor (let schemaNode; schemaNode = stack.pop();) {\n\t\t\tdelete schemaNode._autoId;\n\t\t\tdelete schemaNode._path;\n\t\t\tdelete schemaNode._dataContextPath;\n\t\t\tdelete schemaNode._dataPath;\n\t\t\tstack.push(...this._dep_children(schemaNode));\n\t\t}\n\t}\n\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Normalize schemaNode children\n\t\t- Skips nodes that only serve as wrappers (repeated)\n\t\t- Returns the \"real\" children array.\n\t───────────────────────────────────────────────────────────*/\n\t_dep_children(schemaNode) {\n\t\twhile (schemaNode.entry)\n\t\t\tschemaNode = schemaNode.entry;\n\t\tif (Array.isArray(schemaNode.entries))\n\t\t\treturn schemaNode.entries;\n\t\treturn [];\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Compute UI-forward dependency path\n\t───────────────────────────────────────────────────────────*/\n\t_dep_computeForwardPath(dependee, dependent) {\n\t\tconst from = dependee._path;\n\t\tconst to = dependent._path;\n\n\t\tif (!from || !to)\n\t\t\treturn null;\n\n\t\t// main → main\n\t\tif (from[0] === \"m\" && to[0] === \"m\")\n\t\t\treturn [\"m\", to[1]];\n\n\t\t// details → main\n\t\tif (from[0] !== \"m\" && to[0] === \"m\")\n\t\t\treturn [\"m\", to[1]];\n\n\t\t// main → details\n\t\tif (from[0] === \"m\" && to[0] !== \"m\")\n\t\t\treturn [\"e\", ...to];\n\n\t\t// details → details\n\t\tlet common = 0;\n\n\t\twhile (common < from.length && common < to.length && from[common] === to[common])\n\t\t\tcommon++;\n\n\t\tconst up   = Array(from.length - common).fill(\"..\");\n\t\tconst down = to.slice(common);\n\n\t\treturn [\"r\", ...up, ...down];\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Compute reverse dependency path (exp→exp)\n\t───────────────────────────────────────────────────────────*/\n\t_dep_computeReversePath(from, to) {\n\t\tif (!from._path || !to._path)\n\t\t\treturn null;\n\t\tif (from._path[0] === \"m\" || to._path[0] === \"m\")\n\t\t\treturn null;\n\n\t\tconst a = from._path;\n\t\tconst b = to._path;\n\n\t\tlet common = 0;\n\n\t\twhile (common < a.length && common < b.length && a[common] === b[common])\n\t\t\tcommon++;\n\n\t\tconst up   = Array(a.length - common).fill(\"..\");\n\t\tconst down = b.slice(common);\n\n\t\treturn [...up, ...down];\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Finalize dependency classification (exclusive)\n\t───────────────────────────────────────────────────────────*/\n\t_dep_finalizeDependency(schemaNode, cellPaths, dataPaths) {\n\n\t\tif (cellPaths.length) {\n\t\t\tschemaNode.dependsOnCellPaths = cellPaths;\n\t\t\tdelete schemaNode.dependsOnDataPath;\n\t\t\treturn;\n\t\t}\n\n\t\tif (dataPaths.length === 1) {\n\t\t\tschemaNode.dependsOnDataPath = dataPaths[0];\n\t\t\tdelete schemaNode.dependsOnCellPaths;\n\n\t\t\tif (!schemaNode._dataPath)\n\t\t\t\tschemaNode._dataPath = dataPaths[0];\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (dataPaths.length > 1) {\n\t\t\tconsole.warn(\"Multiple data dependencies not supported:\", schemaNode);\n\n\t\t\tschemaNode.dependsOnDataPath = dataPaths[0];\n\t\t\tdelete schemaNode.dependsOnCellPaths;\n\n\t\t\tif (!schemaNode._dataPath)\n\t\t\t\tschemaNode._dataPath = dataPaths[0];\n\t\t}\n\t}\n\n\n\n\n\n\t_updateViewportHeight = () => {\n\t\tthis._scrollBody.style.height = this.hostEl.clientHeight - this._headerTable.offsetHeight\n\t\t- (this._searchInput?.offsetHeight ?? 0) - this._bulkEditArea.offsetHeight + \"px\";\n\t}\n\n\t_attachInputFormatter(el, format) {\n\t\tformat = this._normalizeInputFormat(format);\n\t\n\t\t// Numeric filtering\n\t\tif (format.numericOnly) {\n\t\t\tel.addEventListener(\"beforeinput\", e => {\n\t\t\t\tif (e.data && /\\D/.test(e.data))\n\t\t\t\t\te.preventDefault();\n\t\t\t});\n\t\t\tel.setAttribute(\"inputmode\", \"numeric\");\n\t\t}\n\t\n\t\t// Backspace over delimiter\n\t\tel.addEventListener(\"keydown\", e => {\n\t\t\tif (e.key !== \"Backspace\" || !format.delimiter)\n\t\t\t\treturn;\n\t\n\t\t\tconst pos = el.selectionStart;\n\t\t\tif (pos > 0 && el.value[pos - 1] === format.delimiter) {\n\t\t\t\te.preventDefault();\n\t\t\t\tel.value = el.value.slice(0, pos - 2) + el.value.slice(pos);\n\t\t\t\tel.setSelectionRange(pos - 2, pos - 2);\n\t\t\t\tel.dispatchEvent(new Event(\"input\"));\n\t\t\t}\n\t\t});\n\t\n\t\t// Main formatting\n\t\tconst apply = () => {\n\t\t\tel.value = this._applyInputFormatting(el.value, format);\n\t\t};\n\t\n\t\tel.addEventListener(\"input\", apply);\n\t\tapply();\n\t}\n\t\n\t_normalizeInputFormat(format) {\n\t\tif (!format.date)\n\t\t\treturn format;\n\t\n\t\tformat = { ...format };\n\t\n\t\tif (format.blocks === undefined)\n\t\t\tformat.blocks = [4, 2, 2];\n\t\tif (format.delimiter === undefined)\n\t\t\tformat.delimiter = \"-\";\n\t\tif (format.numericOnly === undefined)\n\t\t\tformat.numericOnly = true;\n\t\n\t\treturn format;\n\t}\n\n\t_applyInputFormatting(value, format) {\n\t\tif (format.numericOnly)\n\t\t\tvalue = value.replace(/\\D/g, \"\");\n\t\n\t\t// Date mode\n\t\tif (format.date)\n\t\t\treturn this._formatDateValue(value, format);\n\t\n\t\t// Generic block formatting\n\t\tif (Array.isArray(format.blocks)) {\n\t\t\tlet out = \"\", i = 0;\n\t\t\tconst delim = format.delimiter ?? \"\";\n\t\t\tfor (const block of format.blocks) {\n\t\t\t\tconst part = value.slice(i, i + block);\n\t\t\t\tout += part;\n\t\t\t\ti += part.length;\n\t\t\t\tif (part.length === block && delim)\n\t\t\t\t\tout += delim;\n\t\t\t}\n\t\t\treturn out;\n\t\t}\n\t\n\t\treturn value;\n\t}\n\n\t_formatDateValue(digits, format) {\n\t\t// --- clamp month ---\n\t\tif (digits.length >= 5) {\n\t\t\tconst y = digits.slice(0, 4);\n\t\t\tlet m = digits.slice(4, 6);\n\t\n\t\t\tif (m.length === 1 && +m > 1)\n\t\t\t\tm = \"0\" + m;\n\t\t\telse if (m.length === 2) {\n\t\t\t\tlet mm = Math.min(Math.max(+m, 1), 12);\n\t\t\t\tm = String(mm).padStart(2, \"0\");\n\t\t\t}\n\t\t\tdigits = y + m + digits.slice(6);\n\t\t}\n\t\n\t\t// --- clamp day ---\n\t\tif (digits.length >= 7) {\n\t\t\tconst y = +digits.slice(0, 4);\n\t\t\tconst m = +digits.slice(4, 6);\n\t\t\tlet d = digits.slice(6, 8);\n\t\n\t\t\tif (d.length === 1 && +d > 3)\n\t\t\t\td = \"0\" + d;\n\t\t\telse if (d.length === 2) {\n\t\t\t\tlet dd = +d;\n\t\t\t\tconst max = new Date(y, m, 0).getDate();\n\t\t\t\td = String(Math.min(Math.max(dd, 1), max)).padStart(2, \"0\");\n\t\t\t}\n\t\t\tdigits = digits.slice(0, 6) + d + digits.slice(8);\n\t\t}\n\t\n\t\t// --- rebuild output ---\n\t\tconst blocks = format.blocks;\n\t\tconst delim  = format.delimiter ?? \"-\";\n\t\tlet out = \"\", i = 0;\n\t\n\t\tfor (let b = 0; b < blocks.length; b++) {\n\t\t\tconst part = digits.slice(i, i + blocks[b]);\n\t\t\tout += part;\n\t\t\ti += part.length;\n\t\t\tif (part.length === blocks[b] && b < blocks.length - 1)\n\t\t\t\tout += delim;\n\t\t}\n\t\n\t\treturn out;\n\t}\n\t\n\t\n\t\n\t\t\n\t\n\t_setupSearchbar() {\n\t\tthis._searchInput=this.rootEl.appendChild(document.createElement(\"input\"));\n\t\tthis._searchInput.type=this._searchInput.className=\"search\";\n\t\tthis._searchInput.placeholder=this._opts.lang?.filterPlaceholder??\"Search\";\n\t\tthis._searchInput.addEventListener(\"input\",e=>this._onSearchInput(e));\n\t}\n\n\t_onSearchInput(_e) {\n\t\tthis._filterData(this._searchInput.value);\n\t}\n\n\t_setupSpreadsheet(onlyDetails) {\n\t\tthis.rootEl.classList.add(\"spreadsheet\");\n\t\tthis._cellCursor=document.createElement(\"div\");\n\t\tthis._cellCursor.className=\"cell-cursor\";\n\t\tthis._cellCursor.style.display=\"none\";\n\t\tif (!onlyDetails) {\n\t\t\t//remove any border-spacing beacuse if spacing is clicked the target-element will be the table itself and\n\t\t\t//no cell will be selected which is bad user experience. Set it to 0 for headerTable too in order to match\n\t\t\tthis._mainTable.style.borderSpacing=this._headerTable.style.borderSpacing=this._borderSpacingY=0;\n\t\t}\n\t\tthis.rootEl.addEventListener(\"focus\",e=>this._spreadsheetOnFocus(e));\n\t\tthis.rootEl.addEventListener(\"blur\",e=>this._spreadsheetOnBlur(e));\n\t\tthis.rootEl.tabIndex=0;//so that the table can be tabbed to\n\t\tthis.rootEl.addEventListener(\"keydown\",e=>this._spreadsheetKeyDown(e));\n\t\tthis.rootEl.addEventListener(\"mousedown\",e=>this._spreadsheetMouseDown(e));\n\t\tthis._cellCursor.addEventListener(\"dblclick\",e=>this._enterCell(e));\n\n\t\tthis._tooltip=document.createElement(\"div\");\n\t\tthis._tooltip.classList.add(\"tooltip\");\n\t\tthis._tooltip.appendChild(document.createElement(\"span\"));\n\t}\n\n\t_rowMetaGet(dataIndex) {\n\t\treturn this._rowsMeta.vals[this._rowsMeta.keys.indexOf(this._data[dataIndex])];\n\t}\n\n\t_rowMetaSet(dataIndex,key,val) {\n\t\tconst linkIndex=this._rowsMeta.keys.indexOf(this._data[dataIndex]);\n\t\tif (linkIndex==-1&&val!=null) {\n\t\t\tthis._rowsMeta.vals.push({[key]:val});\n\t\t\tthis._rowsMeta.keys.push(this._data[dataIndex]);\n\t\t} else if (linkIndex!=-1&&val==null) {\n\t\t\tdelete this._rowsMeta.vals[linkIndex][key];\n\t\t\tif (!Object.keys(this._rowsMeta.vals[linkIndex]).length) {\n\t\t\t\tthis._rowsMeta.vals.splice(linkIndex,1);\n\t\t\t\tthis._rowsMeta.keys.splice(linkIndex,1);\n\t\t\t}\n\t\t} else if (linkIndex!=-1&&val!=null)\n\t\t\tthis._rowsMeta.vals[linkIndex][key]=val;\t\n\t\treturn val;\n\t}\n\n\t_spreadsheetOnFocus(_e) {\n\t\tconst tabbedTo=this._highlightOnFocus;\n\t\tif (this._mainRowIndex==null&&this._mainColIndex==null&&this._data.length&&tabbedTo)\n\t\t\t\tif (this._onlyDetails)\n\t\t\t\t\tthis.selectTopBottomCellOnlyDetails(true);\n\t\t\t\telse\n\t\t\t\t\tthis._selectMainTableCell(this._mainTbody.rows[0].cells[0]);\n\t\t//when the table is tabbed to, whatever focus-outline that the css has set for it should show, but then when the\n\t\t//user starts to navigate using the keyboard we want to hide it because it is a bit distracting when both it and\n\t\t//a cell is highlighted. Thats why #spreadsheetKeyDown sets outline to none, and this line undos that\n\t\t//also, we dont want it to show when focusing by mouse so we use #focusMethod (see its declaration)\n\t\tif (!this._onlyDetails&&this._highlightOnFocus)\n\t\t\tthis.rootEl.style.removeProperty(\"outline\");\n\t\telse\n\t\t\tthis.rootEl.style.outline=\"none\";\n\t\t\n\t\t//why is this needed? it messes things up when cellcursor is in mainpage of bulk-edit-area but hidden because\n\t\t//other page is open, and the tablance gets focus because then it will be visible through the active page\n\t\t//this._cellCursor.style.display=\"block\";\n\t\t\n\t\tif (tabbedTo)\n\t\t\tthis._scrollToCursor();\n\t}\n\n\t_spreadsheetOnBlur(_e) {\n\t\tsetTimeout(()=>{\n\t\t\tif (!this.rootEl.contains(document.activeElement)||this._bulkEditArea?.contains(document.activeElement)) {\n\t\t\t\tthis._highlightOnFocus=true;\n\t\t\t\t//if (this.neighbourTables&&Object.values(this.neighbourTables).filter(Boolean).length)\n\t\t\t\t\tthis._cellCursor.style.display=\"none\";\n\t\t\t}\n\t\t});\n\t}\n\n\t_moveCellCursor(hSign,vSign,e) {\n\t\t\n\t\tif (!this._exitEditMode(true))//try to exit-mode and commit any changes.\n\t\t\treturn false;//if exiting edit-mode was denied then do nothing more\n\t\t//it's important to run this here before deciding on the cell to move to, because exiting edit-mode may have\n\t\t//triggered visibleIf changes that may have changed which cells are selectable.\n\n\n\t\tif (this._mainRowIndex==null&&this._mainColIndex==null)//if table has focus but no cell is selected.\n\t\t\treturn;//can happen if table is clicked but not on a cell\n\t\te?.preventDefault();//to prevent native scrolling when pressing arrow-keys. Needed if #onlyDetails==true but\n\t\t\t\t\t\t\t//not otherwise. Seems the native scrolling is only done on the body and not scrollpane..?\n\t\t//const newColIndex=Math.min(this._cols.length-1,Math.max(0,this._cellCursorColIndex+numCols));\n\t\tif (!this._onlyDetails)\n\t\t\tthis._scrollToCursor();//need this first to make sure adjacent cell is even rendered\n\n\t\tif (this._activeDetailsCell?.parent?.schemaNode.type===\"lineup\")\n\t\t\tthis._moveInsideLineup(hSign,vSign);\n\t\telse if (vSign) {//moving up or down\n\t\t\tlet newColIndex=this._mainColIndex;\n\t\t\tif (this._activeDetailsCell) {//moving from inside details.might move to another cell inside,or outside\n\t\t\t\t\tthis._selectAdjacentDetailsCell(this._activeDetailsCell,vSign==1);\n\t\t\t} else if (vSign===1&&this._rowMetaGet(this._mainRowIndex)?.h){//moving down into details\n\t\t\t\tthis._selectFirstSelectableDetailsCell(this._openDetailsPanes[this._mainRowIndex],true);\n\t\t\t} else if (vSign===-1&&this._rowMetaGet(this._mainRowIndex-1)?.h){//moving up into details\n\t\t\t\tthis._selectFirstSelectableDetailsCell(this._openDetailsPanes[this._mainRowIndex-1],false);\n\t\t\t} else {//moving from and to maintable-cells\n\t\t\t\tthis._selectMainTableCell(\n\t\t\t\t\tthis._selectedCell.parentElement[(vSign>0?\"next\":\"previous\")+\"Sibling\"]?.cells[newColIndex]);\n\t\t\t}\n\t\t} else if (!this._activeDetailsCell)\n\t\t\tthis._selectMainTableCell(this._selectedCell[(hSign>0?\"next\":\"previous\")+\"Sibling\"]);\n\t\tif (this._onlyDetails&&this._mainRowIndex!=null)\n\t\t\tthis._scrollToCursor();\n\t}\n\n\t_moveInsideLineup(numCols,numRows) {\n\t\tconst currentCellX=this._activeDetailsCell.el.offsetLeft;\n\t\tconst currCelTop=this._activeDetailsCell.el.offsetTop;\n\t\tconst currCelBottom=currCelTop+this._activeDetailsCell.el.offsetHeight;\n\t\tif (numCols) {//moving left or right\n\t\t\tfor (let i=this._activeDetailsCell.index,nextCel;nextCel=this._activeDetailsCell.parent.children[i+=numCols];) {\n\t\t\t\tif (nextCel.el.offsetParent != null && (nextCel?.el.offsetLeft>currentCellX)==(numCols>0)) {\n\t\t\t\t\tif (currCelBottom>nextCel.el.offsetTop&&nextCel.el.offsetTop+nextCel.el.offsetHeight>currCelTop)\n\t\t\t\t\t\tthis._selectDetailsCell(nextCel);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {//moving up or down\n\t\t\tlet closestCell,closestCellX;\n\t\t\tconst siblings=this._activeDetailsCell.parent.children;\n\t\t\tfor (let i=this._activeDetailsCell.index,otherCell;otherCell=siblings[i+=numRows];) {\n\t\t\t\tconst skipCell=Math.max(otherCell.el.offsetTop,currCelTop) <= \t\t\t\t\t //cell is on the\n\t\t\t\t\t\t\t\tMath.min(otherCell.el.offsetTop+otherCell.el.offsetHeight,currCelBottom)//same line\n\t\t\t\t\t\t\t\t||otherCell.el.offsetParent == null;//cell is hidden\n\t\t\t\tif (skipCell)\n\t\t\t\t\tcontinue;\n\t\t\t\telse if (closestCell&&(otherCell.el.offsetLeft<closestCellX)===(numRows>0))//scrolled past whole row\n\t\t\t\t\tbreak;\n\t\t\t\tif (!closestCell||Math.abs(otherCell.el.offsetLeft-currentCellX)<Math.abs(closestCellX-currentCellX)) {\n\t\t\t\t\tclosestCell=otherCell;\n\t\t\t\t\tclosestCellX=closestCell.el.offsetLeft;\n\t\t\t\t} else//if further away than current closest one.\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (closestCell)\n\t\t\t\tthis._selectDetailsCell(closestCell);\n\t\t\telse\n\t\t\t\tthis._selectAdjacentDetailsCell(this._activeDetailsCell.parent,numRows==1?true:false);\n\t\t}\n\t}\n\n\t_selectAdjacentDetailsCell(instanceNode,isGoingDown) {\n\t\tlet cell=this._getAdjacentDetailsCell(instanceNode,isGoingDown);//repeat this line until valid cell is found?\n\t\tif (cell)\n\t\t\treturn this._selectDetailsCell(cell);\n\t\tif (!this._onlyDetails)\n\t\t\tthis._selectMainTableCell(this._mainTbody.querySelector(\n\t\t\t\t`[data-data-row-index=\"${this._mainRowIndex+isGoingDown}\"]`)?.cells[this._mainColIndex]);\n\t\telse {\n\t\t\tconst nextTable=this.neighbourTables?.[isGoingDown?\"down\":\"up\"];\n\t\t\tif (nextTable) {\n\t\t\t\tthis._mainColIndex=this._mainRowIndex=this._activeDetailsCell=null;\n\t\t\t\tnextTable.container.style.outline=this._cellCursor.style.display=\"none\";\n\t\t\t\tnextTable.selectTopBottomCellOnlyDetails(isGoingDown);\n\t\t\t}\n\t\t}\n\t}\n\t\n\t_getAdjacentDetailsCell (instanceNode,isGoingDown) {\n\t\tif (!instanceNode.parent)//parent is null if the class-instance is in the bulk-edit-area\n\t\t\treturn;\n\t\tconst siblings=instanceNode.parent.children;\n\t\tconst index=instanceNode.index;\n\t\tfor (let i=index+(isGoingDown||-1); i>=0&&i<siblings.length; i+=isGoingDown||-1) {\n\t\t\tconst sibling=siblings[i];\n\t\t\tif (sibling.hidden)\n\t\t\t\tcontinue;\n\t\t\tif (sibling.el)\n\t\t\t\treturn sibling;\n\t\t\t//else if sibling.children\n\t\t\tconst niece=this._getFirstSelectableDetailsCell(sibling,isGoingDown);\n\t\t\tif (niece)\n\t\t\t\treturn niece;\n\t\t}\n\t\tif (instanceNode.parent.parent)\n\t\t\treturn this._getAdjacentDetailsCell(instanceNode.parent,isGoingDown);\n\t}\n\n\t_selectFirstSelectableDetailsCell(instanceNode,isGoingDown,onlyGetChild=false) {\n\t\tconst newInstanceNode=this._getFirstSelectableDetailsCell(instanceNode,isGoingDown,onlyGetChild);\n\t\tif (newInstanceNode)\n\t\t\treturn this._selectDetailsCell(newInstanceNode);\n\t\tthis._selectMainTableCell(this._mainTbody.querySelector(\n\t\t\t\t`[data-data-row-index=\"${this._mainRowIndex+(isGoingDown||-1)}\"]`)?.cells[this._mainColIndex]);\n\t}\n\n\t/**Given an instanceNode, like the details of a row or any of its sub-containers, it will return the first\n\t * selectable cell from top or bottom\n\t * @param {*} instanceNode\n\t * @param {Boolean} isGoingDown \n\t * @param {Boolean} onlyGetChild if set to true then it will never return the passed in instanceNode and instead\n\t *\t\t\tonly look at its (grand)children. Used for groups where both itself and its children can be selected*/\n\t_getFirstSelectableDetailsCell(instanceNode,isGoingDown,onlyGetChild=false) {\n\t\tif (!onlyGetChild&&instanceNode.el)\n\t\t\treturn instanceNode;\n\t\tconst children=instanceNode.children;\n\t\tlet startI=isGoingDown?0:children.length-1;\n\t\tif (instanceNode.schemaNode.type===\"lineup\"&&!isGoingDown) {\n\t\t\tlet chosenCell;\n\t\t\tfor (let i=startI,otherCell;otherCell=children[i--];)\n\t\t\t\tif (otherCell.el.offsetParent)\n\t\t\t\t\tif (!chosenCell||otherCell.el.offsetLeft<chosenCell.el.offsetLeft)\n\t\t\t\t\t\tchosenCell=otherCell;\n\t\t\t\t\telse\n\t\t\t\t\t\tbreak;\n\t\t\tstartI=chosenCell.index;\n\t\t}\n\t\tfor (let childI=startI;childI>=0&&childI<children.length; childI+=isGoingDown||-1)\n\t\t\tif (!children[childI].hidden&&(children[childI].children||children[childI].select))\n\t\t\t\t return this._getFirstSelectableDetailsCell(children[childI],isGoingDown);\n\t}\n\t\n\t_spreadsheetKeyDown(e) {\n\t\t//prevent this from running in outer Tablance if an inner Tablance-instance is selected\n\t\tif (this._bulkEditArea?.contains(document.activeElement))\n\t\t\treturn;\n\t\tthis._tooltip.style.visibility=\"hidden\";\n\t\tif (this._inEditMode&&this._activeSchemaNode.input.type===\"date\") {\n\t\t\tif (e.key.slice(0,5)===\"Arrow\") {\n\t\t\t\tif (e.ctrlKey)\n\t\t\t\t\te.stopPropagation();//allow moving textcursor if ctrl is held so prevent date-change then\n\t\t\t\telse\n\t\t\t\t\te.preventDefault();//prevent textcursor from moving when arrowkey-selecting dates in date-picker\n\t\t\t} else if (e.key===\"Backspace\")\n\t\t\t\te.stopPropagation();\n\t\t}\n\t\tthis.rootEl.style.outline=\"none\";//see #spreadsheetOnFocus\n\t\tif (!this._inEditMode) {\n\t\t\tswitch (e.code) {\n\t\t\t\tcase \"ArrowUp\":\n\t\t\t\t\tthis._moveCellCursor(0,-1,e);\n\t\t\t\tbreak; case \"ArrowDown\":\n\t\t\t\t\tthis._moveCellCursor(0,1,e);\n\t\t\t\tbreak; case \"ArrowLeft\":\n\t\t\t\t\tthis._moveCellCursor(-1,0,e);\n\t\t\t\tbreak; case \"ArrowRight\":\n\t\t\t\t\tthis._moveCellCursor(1,0,e);\n\t\t\t\tbreak; case \"Escape\":\n\t\t\t\t\tthis._groupEscape();\n\t\t\t\tbreak; case \"NumpadAdd\":\n\t\t\t\t\tthis._scrollToCursor();\n\t\t\t\t\tthis. _expandRow(this._selectedCell.closest(\".main-table>tbody>tr\"));\n\t\t\t\tbreak; case \"NumpadSubtract\":\n\t\t\t\t\tthis._scrollToCursor();\n\t\t\t\t\tthis._contractRow(this._selectedCell.closest(\".main-table>tbody>tr\"));\n\t\t\t\tbreak; case \"Enter\": case \"NumpadEnter\": case \"Space\":\n\t\t\t\t\tif (e.code==\"Space\")\n\t\t\t\t\t\te.preventDefault();//prevent scrolling when pressing space\n\t\t\t\t\tthis._scrollToCursor();\n\t\t\t\t\tif (this._activeSchemaNode.type==\"expand\")\n\t\t\t\t\t\t// the preventDefault() above can SOMETIMES suppress transitionend;\n\t\t\t\t\t\t// deferring one frame ensures the animation completes and details is closed properly.\n\t\t\t\t\t\treturn requestAnimationFrame(()=>this._toggleRowExpanded(this._selectedCell.parentElement));\n\t\t\t\t\tif (this._activeSchemaNode.type==\"select\")\n\t\t\t\t\t\treturn this._rowCheckboxChange(this._selectedCell,e.shiftKey);\n\t\t\t\t\tif (e.code.endsWith(\"Enter\")||this._activeSchemaNode.input?.type===\"button\") {\n\t\t\t\t\t\te.preventDefault();//prevent newline from being entered into textareas\n\t\t\t\t\t\treturn this._enterCell(e);\n\t\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tswitch (e.key) {\n\t\t\t\tcase \"Enter\":\n\t\t\t\t\tthis._moveCellCursor(0,e.shiftKey?-1:1,e);\n\t\t\t\tbreak; case \"Escape\":\n\t\t\t\t\tthis._exitEditMode(false);\n\t\t\t}\n\t\t}\n\t}\n\n\t_groupEscape() {\n\t\tfor (let instanceNode=this._activeDetailsCell; instanceNode=instanceNode?.parent;)\n\t\t\tif (instanceNode.schemaNode.type===\"group\")\n\t\t\t\treturn this._selectDetailsCell(instanceNode);\n\t}\n\n\t_insertAtCursor(myField, myValue) {\n\t\t\n\t\tif (document.selection) {//IE support\n\t\t\tmyField.focus();\n\t\t\tconst sel = document.selection.createRange();\n\t\t\tsel.text = myValue;\n\t\t} else if (myField.selectionStart || myField.selectionStart == '0') {//MOZILLA and others\n\t\t\tvar startPos = myField.selectionStart;\n\t\t\tvar endPos = myField.selectionEnd;\n\t\t\tmyField.value = myField.value.substring(0, startPos)\n\t\t\t\t+ myValue\n\t\t\t\t+ myField.value.substring(endPos, myField.value.length);\n\t\t} else {\n\t\t\tmyField.value += myValue;\n\t\t}\n\t}\n\n\t_unsortCol(id,type) {\n\t\tfor (let sortCol,i=-1;sortCol=this._sortingCols[++i];)\n\t\t\tif (id&&id==sortCol.id||type&&type==sortCol.type) {\n\t\t\t\tthis._sortingCols.splice(i,1);\n\t\t\t\tthis._updateHeaderSortHtml();\n\t\t\t\treturn;\n\t\t\t}\n\t}\n\n\t/**Creates the actual content of a expanded row. When the user expands a row #expandRow is first called which in\n\t * turn calls this one. When scrolling and already expanded rows are found only this one needs to be called.\n\t * @param {*} tr \n\t * @param {*} rowIndex \n\t * @returns */\n\t_renderDetails(tr,rowIndex) {\n\t\ttr.classList.add(\"expanded\");\n\t\tconst detailsRow=tr.parentElement.insertRow(tr.rowIndex+1);\n\t\tdetailsRow.className=\"details\";\n\t\tdetailsRow.dataset.dataRowIndex=rowIndex;\n\t\tconst detailsCell=detailsRow.insertCell();\n\t\tdetailsCell.colSpan=this._cols.length;\n\t\tconst detailsDiv=detailsCell.appendChild(document.createElement(\"div\"));//single div inside td for animate\n\t\tdetailsDiv.style.height=\"auto\";\n\t\tdetailsDiv.className=\"content\";\n\t\tdetailsDiv.addEventListener(\"transitionend\",this._detailsAnimationEnd.bind(this));\n\t\tconst shadowLine=detailsDiv.appendChild(document.createElement(\"div\"));\n\t\tshadowLine.className=\"details-shadow\";\n\t\tconst instanceNode=this._openDetailsPanes[rowIndex]=this._createInstanceNode();\n\t\tthis._generateDetailsContent(this._schema.details,rowIndex,instanceNode,detailsDiv,[],this._data[rowIndex]);\n\t\tinstanceNode.rowIndex=rowIndex;\n\t\treturn detailsRow;\n\t}\n\n\t_detailsAnimationEnd(e) {\n\t\tif (e.currentTarget!==e.target)\n\t\t\treturn;//otherwise it will apply to transitions of child-elements as well\n\t\tif (parseInt(e.target.style.height)) {//if expand finished\n\n\t\t\te.target.style.height=\"auto\";\n\t\t} else {//if contract finished\n\n\t\t\tconst detailsTr=e.target.closest(\"tr\");\n\t\t\tconst mainTr=detailsTr.previousSibling;\n\t\t\tconst dataRowIndex=mainTr.dataset.dataRowIndex;\n\t\t\tmainTr.classList.remove(\"expanded\");\n\t\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)\n\t\t\t\t -this._rowMetaGet(dataRowIndex).h+this._rowHeight+\"px\";\n\t\t\tdetailsTr.remove();\n\t\t\tthis._rowMetaSet(dataRowIndex,\"h\",null);\n\t\t\tdelete this._openDetailsPanes[dataRowIndex];\n\t\t}\n\t}\n\n\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} schemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when child objects get created lazily during user input.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsContent(schemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tlet notYetCreated=_notYetCreated;\n\t\tlet scopedRowData=rowData;\n\t\tif (schemaNode.dataPath) {\n\t\t\tconst ctx=Array.isArray(schemaNode.dataPath)\n\t\t\t\t? schemaNode.dataPath\n\t\t\t\t: String(schemaNode.dataPath).split(\".\").filter(Boolean);\n\t\t\tlet target=scopedRowData;\n\t\t\tfor (const key of ctx) {\n\t\t\t\tif (!target[key]||typeof target[key]!=\"object\") {\n\t\t\t\t\ttarget[key]={};\n\t\t\t\t\tnotYetCreated=true;\n\t\t\t\t}\n\t\t\t\ttarget=target[key];\n\t\t\t}\n\t\t\tscopedRowData=target;\n\t\t}\n\t\tif (!path.length)\n\t\t\tinstanceNode.rowIndex=mainIndex;\n\t\tinstanceNode.path=[...path];\n\t\tinstanceNode.dataObj=scopedRowData;\n\t\tinstanceNode.schemaNode=schemaNode;\n\t\tif (schemaNode.visibleIf)\n\t\t\tthis._applyVisibleIf(instanceNode);\n\t\tswitch (schemaNode.type) {\n\t\t\tcase \"list\": return this._generateDetailsList(schemaNode,mainIndex,instanceNode,parentEl,path,scopedRowData,notYetCreated);\n\t\t\tcase \"field\": return this._generateField(schemaNode,mainIndex,instanceNode,parentEl,path,scopedRowData);\n\t\t\tcase \"group\": return this._generateDetailsGroup(schemaNode,mainIndex,instanceNode,parentEl,path,scopedRowData,notYetCreated);\n\t\t\tcase \"repeated\": return this._generateDetailsRepeated(schemaNode,mainIndex,instanceNode,parentEl,path,scopedRowData,notYetCreated);\n\t\t\tcase \"lineup\": return this._generateDetailsLineup(schemaNode,mainIndex,instanceNode,parentEl,path,scopedRowData,notYetCreated);\n\t\t}\n\t}\n\n\t_repeatedOnDelete=(e,data,index,schemaNode,cel)=>{\n\t\tthis._deleteCell(cel.parent.parent);\n\t\tcel.parent.parent.parent.schemaNode.onDelete?.(cel.parent.parent.dataObj,cel.parent.parent);\n\t}\n\n\t_fileOnDelete=(e,data,index,strct,cel)=>{\n\t\tconst fileCell=cel.parent.parent;\n\t\tconst inputSchemaNode=fileCell.fileInputSchemaNode;\n\t\tconst dataRow=fileCell.parent.dataObj;\n\t\tdelete dataRow[inputSchemaNode.id];\n\t\tconst fileTd=fileCell.el.parentElement;\n\t\tfileTd.innerHTML=\"\";\n\t\tfileTd.classList.remove(\"group-cell\");\n\t\tthis._generateDetailsContent(inputSchemaNode,index,fileCell,fileTd,fileCell.path,dataRow);\n\t\tinputSchemaNode.deleteHandler?.(e,data,inputSchemaNode,fileCell.parent.dataObj,index,fileCell);\n\t\tthis._selectDetailsCell(fileCell);\n\t}\n\n\t_onOpenCreationGroup=(e,groupObject)=>{\n\t\te.preventDefault();\n\t\tthis._repeatInsert(groupObject.parent,true,groupObject.parent.dataObj[groupObject.parent.dataObj.length]={});\n\t}\n\n\t/**\n\t * This is \"supposed\" to get called when a repeated-schemaNode is found however in #generateDetailsList,\n\t * repeated schema-nodes are looked for and handled by that method instead so that titles can be added to the list\n\t * which isn't handled by #generateDetailsContent but by the list-method itself\n\t *\n\t * @param {object} repeatedSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when child objects get created lazily during user input.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsRepeated(repeatedSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tinstanceNode.children=[];\n\t\tlet repeatData=instanceNode.dataObj=rowData[repeatedSchemaNode.id]??(rowData[repeatedSchemaNode.id]=[]);\n\t\tinstanceNode.insertionPoint=parentEl.appendChild(document.createComment(\"repeated-insert\"));\n\t\trepeatedSchemaNode.create&&this._generateRepeatedCreator(instanceNode);\n\t\trepeatData?.forEach(repeatData=>this._repeatInsert(instanceNode,false,repeatData));\n\t\treturn !!repeatData?.length||repeatedSchemaNode.create;\n\t}\n\n\t/**For repeated schema-nodes with create set to true (meaning users can create more entries via user-interface),\n\t * this method creates the last entry that the user interacts with to create another entry\n\t * @param {Object} repeatedObj The object representing the repeated-container*/\n\t_generateRepeatedCreator(repeatedObj) {\n\t\tconst creationTxt=repeatedObj.schemaNode.creationText??this._opts.lang?.insertNew??\"Insert new\";\n\t\tconst creationSchemaNode={type:\"group\",closedRender:()=>creationTxt,entries:[],\n\t\t\t\t\t\t\tcreator:true//used to know that this entry is the creator and that it should not be sorted\n\t\t\t\t\t\t\t,onOpen:this._onOpenCreationGroup,cssClass:\"repeat-insertion\"};\n\t\tconst wrappedCreationSchemaNode=this._buildSchemaFacade(creationSchemaNode);//WRAPPED\n\t\tconst el=this._repeatInsert(repeatedObj,false,{},wrappedCreationSchemaNode);\n\t\tel.parentElement.classList.add(\"empty\");//this will make it hidden if inside a group that is closed\n\t}\n\n\t_beginDeleteRepeated(e,data,mainIndex,schemaNode,cell) {\n\t\tif (!cell.parent.parent.creating) {\n\t\t\tcell.parent.containerEl.classList.add(\"delete-confirming\");\n\t\t\tthis._selectDetailsCell(cell.parent.children[1]);//select \"No\" button\n\t\t} else\n\t\t\tthis._deleteCell(cell.parent.parent);\n\t}\n\n\t_cancelDelete(e,data,mainIndex,schemaNode,cell) {\n\t\t\tcell.parent.containerEl.classList.remove(\"delete-confirming\");\n\t\t\tthis._selectDetailsCell(cell.parent.children[0]);\n\t}\n\n\t_schemaCopyWithDeleteButton(schemaNode,deleteHandler) {\n\t\tconst deleteControls={type:\"lineup\",cssClass:\"delete-controls\"\n\t\t\t,onBlur:cel=>cel.selEl.querySelector(\".lineup\").classList.remove(\"delete-confirming\")\n\t\t\t,entries:[{type:\"field\",input:{type:\"button\",\n\t\t\t\tbtnText:schemaNode.deleteText??this._opts.lang?.delete??\"Delete\"\n\t\t\t\t,clickHandler:this._beginDeleteRepeated.bind(this)},cssClass:\"delete\"},\n\t\t\t{type:\"field\",input:{type:\"button\"\n\t\t\t\t,btnText:schemaNode.areYouSureNoText??this._opts.lang?.deleteAreYouSureNo??\"No\",\n\t\t\t\tclickHandler:this._cancelDelete.bind(this)},cssClass:\"no\"\n\t\t\t\t,title:schemaNode.deleteAreYouSureText??this._opts.lang?.deleteAreYouSure??\"Are you sure?\"},\n\t\t\t{type:\"field\",input:{type:\"button\"\n\t\t\t\t,btnText:schemaNode.areYouSureYesText??this._opts.lang?.deleteAreYouSureYes??\"Yes\",\n\t\t\t\tclickHandler:deleteHandler},cssClass:\"yes\"}]};\n\t\tconst rawNode=schemaNode?.[SCHEMA_WRAPPER_MARKER]?schemaNode.raw:schemaNode;\n\t\tconst parentWrapped=schemaNode?.[SCHEMA_WRAPPER_MARKER]?schemaNode.parent:null;\n\t\tif (!rawNode)\n\t\t\treturn schemaNode;\n\t\tconst clonedEntries=[...(rawNode.entries??[]),deleteControls];\n\t\tconst clonedNode={...rawNode, entries:clonedEntries};\n\t\t// Wrap the cloned schema so delete controls can be injected without mutating the original schema tree.\n\t\tconst wrappedClone=this._buildSchemaFacade(clonedNode,parentWrapped);\n\t\tif (schemaNode?.[SCHEMA_WRAPPER_MARKER])\n\t\t\tthis._cloneDependencyMetadata(schemaNode,wrappedClone);\n\t\treturn wrappedClone;\n\t}\n\n\t_cloneDependencyMetadata(sourceNode,targetNode) {\n\t\t// Delete-button clones must preserve dependency metadata (forward/backward dep paths),\n\t\t// otherwise dependents stop updating because the cloned nodes never register dependencies.\n\t\tconst copyMeta=(srcVal)=>{\n\t\t\tif (Array.isArray(srcVal))\n\t\t\t\treturn srcVal.map(v=>Array.isArray(v)?[...v]:v);\n\t\t\tif (srcVal&&typeof srcVal===\"object\")\n\t\t\t\treturn {...srcVal};\n\t\t\treturn srcVal;\n\t\t};\n\t\tfor (const key of [\"dependencyPaths\",\"dependsOnCellPaths\",\"dependsOnDataPath\"])\n\t\t\tif (sourceNode?.[key]!==undefined)\n\t\t\t\ttargetNode[key]=copyMeta(sourceNode[key]);\n\t\tconst sourceChildren=this._dep_children(sourceNode);\n\t\tconst targetChildren=this._dep_children(targetNode);\n\t\tfor (let i=0;i<sourceChildren.length&&i<targetChildren.length;i++)\n\t\t\tthis._cloneDependencyMetadata(sourceChildren[i],targetChildren[i]);\n\t}\n\n\t_generateButton(schemaNode,mainIndex,parentEl,rowData,instanceNode=null) {\n\t\tconst btn=parentEl.appendChild(document.createElement(\"button\"));\n\t\tbtn.tabIndex=\"-1\";//so it can't be tabbed to\n\t\tbtn.innerHTML=schemaNode.input.btnText;\n\t\tbtn.addEventListener(\"click\",e=>schemaNode.input.clickHandler?.(e,rowData,mainIndex,schemaNode,instanceNode));\n\n\t\t//prevent gaining focus upon clicking it whhich would cause problems. It should be \"focused\" by having the\n\t\t//cellcursor on its cell which triggers it with enter-key anyway\n\t\tbtn.addEventListener(\"mousedown\",e=>e.preventDefault());\n\t\treturn true;\n\t}\n\n\t\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} groupSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when child objects get created lazily during user input.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsGroup(groupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,notYetCreated) {\n\t\tinstanceNode.select=()=>this._selectDetailsCell(instanceNode);\n\t\tconst groupTable=parentEl.appendChild(document.createElement(\"table\"));\n\t\tconst tbody=instanceNode.containerEl=groupTable.appendChild(document.createElement(\"tbody\"));\n\t\tgroupTable.dataset.path=path.join(\"-\");\n\t\tparentEl.classList.add(\"group-cell\");\n\t\tinstanceNode.el=groupTable;//so that the whole group-table can be selectedf\n\t\tthis._generateDetailsCollection(groupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData);\n\t\tgroupTable.className=\"details-group \"+(groupSchemaNode.cssClass??\"\");\n\t\tif (notYetCreated)\n\t\t\tinstanceNode.creating=true;\n\t\telse if (groupSchemaNode.closedRender) {\n\t\t\tgroupTable.classList.add(\"closed-render\");\n\t\t\tconst renderRow=tbody.insertRow();\n\t\t\trenderRow.dataset.path=path.join(\"-\");\n\t\t\trenderRow.className=\"group-render\";\n\t\t\tconst renderCell=renderRow.insertCell();\n\t\t\trenderCell.innerText=groupSchemaNode.closedRender(rowData);\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} listSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t* @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when child objects get created lazily during user input.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsList(listSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tconst listTable=parentEl.appendChild(document.createElement(\"table\"));\n\t\tinstanceNode.containerEl=listTable.appendChild(document.createElement(\"tbody\"));\n\t\tlistTable.className=\"details-list\";\n\t\tif (listSchemaNode.titlesColWidth!=false) {\n\t\t\tlet titlesCol=document.createElement(\"col\");\n\t\t\tlistTable.appendChild(document.createElement(\"colgroup\")).appendChild(titlesCol);\n\t\t\tif (listSchemaNode.titlesColWidth!=null)\n\t\t\t\ttitlesCol.style.width=listSchemaNode.titlesColWidth;\n\t\t}\n\t\treturn this._generateDetailsCollection(listSchemaNode,mainIndex,instanceNode,parentEl,path,rowData);\n\t}\n\n\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} lineupSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t* @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when child objects get created lazily during user input.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsLineup(lineupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tinstanceNode.containerEl=parentEl.appendChild(document.createElement(\"div\"));\n\t\tinstanceNode.containerEl.classList.add(\"lineup\",\"collection\",...lineupSchemaNode.cssClass?.split(\" \")??[]);\n\t\treturn this._generateDetailsCollection(lineupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData);\n\t}\n\n\t/**\n\t * Generates the children of a container schema node (list/lineup/group).\n\t * Handles repeated entries specially; otherwise delegates to _generateCollectionItem.\n\t */\n\t_generateDetailsCollection(containerSchemaNode,mainIndex,collectionObj,parentEl,path,rowData) {\n\t\t//allows for easily finding the outer-most parent of elements that are placed in collection\n\t\tcollectionObj.containerEl.classList.add(\"collection\");\n\n\t\tcollectionObj.children=[];\n\t\tfor (let entryI=-1,childSchemaNode; childSchemaNode=containerSchemaNode.entries[++entryI];) {\n\t\t\tif (childSchemaNode.type===\"repeated\") {\n\t\t\t\tconst repeatData=rowData[childSchemaNode.id]??(rowData[childSchemaNode.id]=[]);\n\t\t\t\tconst rptCelObj=collectionObj.children[entryI]=Object.assign(\n\t\t\t\t\tthis._createInstanceNode(collectionObj,entryI),\n\t\t\t\t\t{children:[],schemaNode:childSchemaNode,dataObj:repeatData,path:[...path,entryI]}\n\t\t\t\t);\n\t\t\t\trptCelObj.insertionPoint=collectionObj.containerEl.appendChild(document.createComment(\"repeat-insert\"));\n\t\t\t\tchildSchemaNode.create&&this._generateRepeatedCreator(rptCelObj);\n\t\t\t\trepeatData?.forEach(repeatData=>this._repeatInsert(rptCelObj,false,repeatData));\n\t\t\t} else\n\t\t\t\tthis._generateCollectionItem(childSchemaNode,mainIndex,collectionObj,path,rowData);\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * Build correct DOM structure for a collection item depending on collection type.\n\t * Returns both outermost element (outerContainerEl) and the inner element (containerEl)\n\t * where the content will be placed.\n\t * \n\t * Also sets special properties on itemObj for group items.\n\t */\n\t_buildCollectionItemDOM(schemaNode,collection,itemObj,title) {\n\t\tlet outerContainerEl,containerEl;\n\t\tconst type=collection.schemaNode.type;\n\n\t\t// LIST: Each item is a <tr> with title cell optionally + value cell\n\t\tif (type==\"list\") {\n\t\t\touterContainerEl=document.createElement(\"tr\");\n\t\t\tif (collection.schemaNode.titlesColWidth!=false) {\n\t\t\t\tconst td=outerContainerEl.insertCell();\n\t\t\t\ttd.className=\"title\";\n\t\t\t\ttd.innerText=schemaNode.title??\"\";\n\t\t\t}\n\t\t\tcontainerEl=outerContainerEl.insertCell();\n\t\t} else if (type==\"lineup\") {// LINEUP: Items rendered inline, outerContainerEl wraps title + inner content\n\t\t\touterContainerEl=document.createElement(\"span\");\n\t\t\tif (title)\n\t\t\t\touterContainerEl.appendChild(title);\n\t\t\tcontainerEl=itemObj.selEl=outerContainerEl.appendChild(document.createElement(\"div\"));\n\t\t} else if (type==\"group\") {//GROUP: More complex <tr> with special rules for empty/hiding and more\n\t\t\touterContainerEl=document.createElement(\"tr\");\n\t\t\touterContainerEl.className=\"empty\";\t// Will be hidden while group is closed until content becomes non-empty\n\n\t\t\tconst td=outerContainerEl.insertCell();\n\t\t\ttd.classList.toggle(\"disabled\",schemaNode.type==\"field\"&&!schemaNode.input);\n\n\t\t\t// Add separator for non-group members\n\t\t\tif (schemaNode.type!=\"group\")\n\t\t\t\ttd.appendChild(document.createElement(\"hr\")).className=\"separator\";\n\n\t\t\tif (title)\n\t\t\t\ttd.appendChild(title);\n\n\t\t\tcontainerEl=td.appendChild(document.createElement(\"div\"));\n\n\t\t\t// Track non-empty descendants so empty group rows can hide visually\n\t\t\tObject.assign(itemObj,{\n\t\t\t\tnonEmptyDescentants:0,\n\t\t\t\tgrpTr:outerContainerEl,\n\t\t\t\tselEl:td\n\t\t\t});\n\t\t} else\n\t\t\touterContainerEl=containerEl=document.createElement(\"div\");\n\t\treturn {outerContainerEl,containerEl};\n\t}\n\n\t/**\n\t * Insert the newly generated collection item into the DOM, either at end or at a precise insert position.\n\t * Handles \"repeated\" collections where insertion point is not always end of list.\n\t */\n\t_insertCollectionItem(schemaNode,index,itemObj,outerContainerEl,collectionOrRepeated,collectionEl) {\n\t\tlet siblingAfter=null;\n\n\t\t// For repeated collections: determine the real insertion position based on insertionPoint\n\t\tif (collectionOrRepeated.schemaNode.type==\"repeated\") {\n\t\t\tconst next=collectionOrRepeated.insertionPoint.nextSibling;\n\t\t\tconst base=collectionOrRepeated.children.length;\n\t\t\tconst pos=(next?.rowIndex??base)-base+index;\n\t\t\tsiblingAfter=collectionOrRepeated.children[pos];\n\t\t}\n\n\t\t// Where to insert in the DOM\n\t\tconst beforeEl=siblingAfter?.el.closest(\".collection>*\")?? collectionOrRepeated.insertionPoint;\n\n\t\tcollectionEl.insertBefore(outerContainerEl,beforeEl);\n\n\t\t// Insert into internal children array\n\t\tcollectionOrRepeated.children.splice(index,0,itemObj);\n\n\t\t// Extra CSS class if defined in schemaNode\n\t\tif (schemaNode.cssClass)\n\t\t\touterContainerEl.className+=\" \"+schemaNode.cssClass;\n\t}\n\t\n\t\n\n\t/**\n\t * Generate one item inside a collection or repeated block.\n\t * Creates DOM, updates indices, generates inner content, and inserts into DOM\n\t * only if details content was actually created (e.g., repeated with empty data should not add item).\n\t */\n\t_generateCollectionItem(schemaNode,mainIndex,collectionOrRepeated,path,data,index=null, creating=false) {\n\t\t// Determine actual collection (repeated uses parent collection visually)\n\t\tconst collection=collectionOrRepeated.schemaNode.type==\"repeated\"\n\t\t\t\t\t\t\t\t\t?collectionOrRepeated.parent:collectionOrRepeated;\n\n\t\tconst collectionEl=collection.containerEl;\n\t\tindex??=collectionOrRepeated.children.length;\n\n\t\t// Item object (holds metadata for this item)\n\t\tconst itemObj=this._createInstanceNode(collectionOrRepeated,index);\n\n\t\t// Optional title element\n\t\tlet title;\n\t\tif (schemaNode.title) {\n\t\t\ttitle=document.createElement(\"span\");\n\t\t\ttitle.className=\"title\";\n\t\t\ttitle.innerHTML=schemaNode.title;\n\t\t}\n\n\t\t// Build DOM structure for this item\n\t\tconst {outerContainerEl,containerEl}=this._buildCollectionItemDOM(schemaNode,collection,itemObj,title);\n\n\n\t\t// Visual CSS classes\n\t\tif (schemaNode.input&&schemaNode.input.type!=\"button\")\n\t\t\tcontainerEl.classList.add(\"input-cell\");\n\t\tcontainerEl.classList.add(\"value\");\n\t\tif (schemaNode.input)\n\t\t\touterContainerEl.classList.add((schemaNode.input.type??\"text\")+\"-container\");\n\n\t\t// If inserting in middle: update sibling item indices\n\t\tif (index<collectionOrRepeated.children.length)\n\t\t\tfor (let i=index-1,sibling; sibling=collectionOrRepeated.children[++i];)\n\t\t\t\tthis._changeInstanceNodeIndex(sibling,i+1);\n\n\t\tpath.push(index);\n\n\t\titemObj.outerContainerEl=outerContainerEl;//reference to outer-most container belonging exclusively to this item\n\n\t\t// Expand inner content; may return false if nothing should be rendered\n\t\tconst generated=this._generateDetailsContent(schemaNode,mainIndex,itemObj,containerEl,path,data,creating);\n\n\t\t// Only insert if it actually has content (important for sparse repeated arrays)\n\t\tif (generated)\n\t\t\tthis._insertCollectionItem(schemaNode,index,itemObj,outerContainerEl,collectionOrRepeated,collectionEl);\n\n\t\tpath.pop();\n\t\treturn itemObj;\n\t}\n\n\t_generateField(fieldSchemaNode,mainIndex,instanceNode,parentEl,path,rowData) {\n\t\tinstanceNode.select=()=>this._selectDetailsCell(instanceNode);\n\t\tinstanceNode.el=parentEl;\n\t\tthis._updateDetailsCell(instanceNode,rowData);\n\t\tinstanceNode[instanceNode.selEl?\"selEl\":\"el\"].dataset.path=path.join(\"-\");\n\t\treturn true;\n\t}\n\t\n\t_spreadsheetMouseDown(e) {\n\t\tthis._highlightOnFocus=false;//see decleration\n\t\tthis.rootEl.style.outline=\"none\";//see #spreadsheetOnFocus\n\t\tthis._tooltip.style.visibility=\"hidden\";\n\t\tif (Date.now()<this._ignoreClicksUntil)//see decleration of #ignoreClicksUntil\n\t\t\treturn;\n\t\tif (e.which===3)//if right click\n\t\t\treturn;\n\t\tconst mainTr=e.target.closest(\".main-table>tbody>tr\");\n\t\tif (this._onlyDetails||mainTr?.classList.contains(\"details\")) {//in details\n\t\t\tconst interactiveEl=e.target.closest('[data-path]');\n\t\t\tif (!interactiveEl)\n\t\t\t\treturn;\n\t\t\tlet instanceNode=this._openDetailsPanes[mainTr?.dataset.dataRowIndex??0];\n\t\t\tfor (let step of interactiveEl.dataset.path.split(\"-\")) {\n\t\t\t\tinstanceNode=instanceNode.children[step];\n\t\t\t\tif (instanceNode.schemaNode.type===\"group\"&&!instanceNode.el.classList.contains(\"open\"))\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tthis._selectDetailsCell(instanceNode);\n\t\t} else {//not in details\n\t\t\tconst td=e.target.closest(\".main-table>tbody>tr>td\");\n\t\t\tif (td?.classList.contains(\"expand-col\")||td?.classList.contains(\"select-col\")) {\n\t\t\t\tif (e.shiftKey)\n\t\t\t\t\te.preventDefault();//prevent text-selection when shift-clicking checkboxes\n\t\t\t\tif (this._mainRowIndex==null) {\n\t\t\t\t\tthis._selectMainTableCell(td);\n\t\t\t\t\tthis.rootEl.focus({preventScroll:true});\n\t\t\t\t}\n\t\t\t\tif (td.classList.contains(\"expand-col\"))\n\t\t\t\t\treturn this._toggleRowExpanded(td.parentElement);\n\t\t\t\treturn this._rowCheckboxChange(td,e.shiftKey);\n\t\t\t}\n\t\t\tthis._selectMainTableCell(td);\n\t\t}\n\t}\n\n\t_toggleRowExpanded(tr) {\n\t\tif (tr.classList.contains(\"expanded\"))\n\t\t\tthis._contractRow(tr);\n\t\telse\n\t\t\tthis._expandRow(tr);\n\t}\n\n\t_rowCheckboxChange(td,shift) {\n\t\tconst checked=!td.querySelector(\"input\").checked;\n\t\tconst mainIndex=parseInt(td.parentElement.dataset.dataRowIndex);\n\t\tif (!shift)//shift not held, \n\t\t\tthis._lastCheckedIndex=mainIndex;//set #lastCheckedIndex to the current index to both start and stop at it\n\t\tthis._toggleRowsSelected(checked,...[mainIndex,this._lastCheckedIndex??mainIndex].sort((a,b)=>a-b));\n\t\tthis._lastCheckedIndex=mainIndex;//if shift held next time then rows between this and new mainIndex are checked\n\t}\n\n\t_toggleRowsSelected(checked,fromIndex,toIndex) {\n\t\tthis._unsortCol(null,\"select\");\n\t\tfor (var i=fromIndex;i<=toIndex; i++){\n\t\t\tif (i>=this._scrollRowIndex&&i<this._scrollRowIndex+this._numRenderedRows) {\n\t\t\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${i}\"]`);\n\t\t\t\ttr.querySelector(\".select-col input\").checked=checked;\n\t\t\t\ttr.classList.toggle(\"selected\",checked);\n\t\t\t}\n\t\t\tif (checked&&this._selectedRows.indexOf(this._data[i])==-1) {\n\t\t\t\tthis._selectedRows.push(this._data[i]);\n\t\t\t\tthis._numRowsSelected++;\n\t\t\t\tthis._numRowsInViewSelected++;\n\t\t\t} else if (!checked&&this._selectedRows.indexOf(this._data[i])!=-1) {\n\t\t\t\tthis._selectedRows.splice(this._selectedRows.indexOf(this._data[i]),1);\n\t\t\t\tthis._numRowsSelected--;\n\t\t\t\tthis._numRowsInViewSelected--;\n\t\t\t}\n\t\t}\n\t\tthis._numberOfRowsSelectedSpan.innerText=this._numRowsSelected;\n\t\tthis._updateNumRowsSelectionState();\n\t\tthis._updateBulkEditAreaCells();\n\t}\n\n\t_updateNumRowsSelectionState() {\n\t\tconst checkbox=this._headerTr.querySelector(\".select-col input\");\n\t\tif (this._numRowsInViewSelected==this._data.length||!this._numRowsInViewSelected) {\n\t\t\tcheckbox.indeterminate=false;\n\t\t\tcheckbox.checked=this._numRowsInViewSelected;\n\t\t} else\n\t\t\tcheckbox.indeterminate=true;\n\t\tif (this._numRowsSelected^this._bulkEditAreaOpen) {\n\t\t\tthis._bulkEditAreaOpen=!!this._numRowsSelected;\n\t\t\tthis._bulkEditArea.style.height=this._bulkEditAreaOpen?this._bulkEditAreaHeightPx+\"px\":0;\n\t\t\tthis._animate(this._updateViewportHeight,Infinity,\"adjustViewportHeight\");\n\t\t}\n\t}\n\n\t_animate(func,runForMs,id) {\n\t\tconst runUntil=Date.now()+runForMs;\n\t\tconst animations=this._animations;\n\t\tif (!animations[id]) {\n\t\t\tanimations[id]=runUntil;\n\t\t\trequestAnimationFrame(frame);\n\t\t} else\n\t\t\tanimations[id]=runUntil;\n\t\tfunction frame() {\n\t\t\tfunc();\n\t\t\tif (Date.now()<animations[id])\n\t\t\t\trequestAnimationFrame(frame);\n\t\t\telse\n\t\t\t\tdelete animations[id];\n\t\t}\n\t}\n\n\t_autoTextAreaResize(e) {\n\t\tconst maxHeight=this._activeSchemaNode.maxHeight??Infinity;\n\t\t\n\t\t//__auto-resize__\n\t\t//first set height to auto.This won't make it auto-resize or anything but will rather set its height to about 40\n\t\te.target.style.height=\"auto\";\n\t\t//then set size of cellcursor, and also the underlying cell in order to make details-height adjust to scroll-\n\t\t//height of the textarea. Also add 1px because *sometimes* without logic the textarea would recieve a scrollbar\n\t\t//which can scroll about 1 px. Not sure if 1px is actually sufficent but let's start there.\n\t\tthis._cellCursor.style.height=this._selectedCell.style.height=Math.min(maxHeight,e.target.scrollHeight+1)+\"px\";\n\t\t//now set height of textarea to 100% of cellcursor which height is set with above line. this line and the one\n\t\t//setting it to auto \"could\" be skipped but that will result in the textarea not shrinking when needed.\n\t\te.target.style.height=\"100%\";\n\n\t\t//need to call this to make the height of the details adjust and reflect the change in size of the textarea\n\t\tthis._updateDetailsHeight(this._selectedCell.closest(\"tr.details\"));\n\t}\n\n\t_updateDetailsHeight(detailsTr) {\n\t\tconst contentDiv=detailsTr.querySelector(\".content\");\n\t\tconst mainRowIndex=parseInt(detailsTr.dataset.dataRowIndex);\n\t\tcontentDiv.style.height=\"auto\";//set to auto in case of in middle of animation, get correct height\n\t\tconst prevRowHeight=this._rowMetaGet(mainRowIndex).h;\n\t\tconst newRowHeight=this._rowHeight+detailsTr.offsetHeight+this._borderSpacingY;\n\t\tthis._rowMetaSet(mainRowIndex,\"h\",newRowHeight);\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)//adjust scroll-height reflect change...\n\t\t\t+newRowHeight-prevRowHeight+\"px\";//...in height of the table\n\t}\n\n\t_openDateEdit(e) {\n\t\tconst input=document.createElement(\"input\");\n\t\tlet pika,pikaContainer;\n\t\t//this._input.type=\"date\";//using Pikaday instead which I find more user-friendly. Calendar can be opened\n\t\t\t\t\t\t\t\t//up right away and typing manualy is still permitted\n\t\tthis._attachInputFormatter(input,{date:true});\n\t\tif (!window.Pikaday)\n\t\t\tconsole.warn(\"Pikaday-library not found\");\n\t\telse {\n\t\t\tpikaContainer=this._cellCursor.parentElement.appendChild(document.createElement(\"div\"));\n\t\t\tpikaContainer.className=\"pika-container\";\n\t\t\tpika=new Pikaday({field:input,\n\t\t\t\ttoString: d=>d.getFullYear()+\"-\"+('0'+(d.getMonth()+1)).slice(-2)+\"-\"+('0'+d.getDate()).slice(-2),\n\t\t\t\tonClose:()=>{\n\t\t\t\t\tpikaContainer.remove();\n\t\t\t\t\tpika.destroy();\n\t\t\t\t\tsetTimeout(()=>this._exitEditMode(true));\n\t\t\t\t},\n\t\t\t\tcontainer:pikaContainer,\n\t\t\t\tfirstDay:1,//week starts on monday\n\t\t\t\tshowWeekNumber:true,\n\t\t\t\tdefaultDate: this._selectedCellVal ? new Date(this._selectedCellVal) : undefined,\n\t\t\t\tsetDefaultDate:true,\n\t\t\t\ti18n: {\n\t\t\t\t\tpreviousMonth : 'Tidigare Månad',\n\t\t\t\t\tnextMonth     : 'Nästa Månad',\n\t\t\t\t\tmonths        : ['Januari','Februari','Mars','April','Maj','Juni','Juli','Augusti','September'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,'Oktober','November','December'],\n\t\t\t\t\tweekdays      : ['Söndag','Måndag','Tisdag','Onsdag','Torsdag','Fredag','Lördag'],\n\t\t\t\t\tweekdaysShort : ['Sön','Mån','Tis','Ons','Tor','Fre','Lör']\n\t\t\t\t},\n\t\t\t\tonOpen:()=>this._alignDropdown(pikaContainer),//have to wait until onOpen or size is 0\n\t\t\t\tonDraw: () => this._alignDropdown(pikaContainer)//not all months include the same number of weeks,\n\t\t\t\t\t\t\t\t//so sometimes the calendar gets taller or shorter and that's why we have to re-align\n\t\t\t});\n\t\t\tpika.el.style.position=\"static\";//otherwise size of pikaContainer will be 0 and alignDropdown wont work\n\t\t\tif (e instanceof KeyboardEvent)\n\t\t\t\te.stopPropagation();//otherwise the enter-press is propagated to Pikaday, immediately closing it\n\t\t\tinput.addEventListener(\"input\",onInput.bind(this));\n\t\t\tinput.addEventListener(\"change\",()=>this._inputVal=input.value);\n\t\t}\n\t\t\n\t\tthis._cellCursor.appendChild(input);\n\t\tinput.value=this._selectedCellVal??\"\";\n\t\tinput.placeholder=this._activeSchemaNode.input.placeholder??this._opts.lang?.datePlaceholder??\"YYYY-MM-DD\";\n\t\tinput.focus();\n\t\t\n\t\tfunction onInput(_e) {\n\t\t\tconst inputVal=input.value;\n\t\t\tpika.setDate(input.value);\n\t\t\t//the above line will change the text above by guessing where there should be zeroes and such so prevent\n\t\t\t//that by setting it back so that the user can type freely\n\t\t\tinput.value=inputVal;\n\t\t}\n\t}\n\n\t/**Aligns dropdowns like select and date-picker correctly by the cellcursor or any other target-element specified */\n\t_alignDropdown(dropdown,target=this._cellCursor) {\n\n\t\tconst alignmentContainer=this._dropdownAlignmentContainer;//container of the dropdown\n\t\tconst alignmentPos=this._getElPos(target);\n\t\tconst viewportPos=alignmentContainer===dropdown.offsetParent?alignmentPos\n\t\t\t\t\t\t\t:this._getElPos(target,alignmentContainer);\n\t\t\n\t\t//if target-element is below middle of viewport or if in bulk-edit-area\n\t\tdropdown.classList.remove(\"above\",\"below\",\"left\",\"right\");\n\t\tif (viewportPos.y+target.clientHeight/2>alignmentContainer.scrollTop+alignmentContainer.clientHeight/2) {\n\t\t\t//then place dropdown above target-element\n\t\t\tdropdown.style.top=alignmentPos.y-dropdown.offsetHeight+\"px\";\n\t\t\tdropdown.classList.add(\"above\");\n\t\t} else {\n\t\t\t//else place dropdown below target-element\n\t\t\tdropdown.style.top=alignmentPos.y+target.clientHeight+\"px\";\n\t\t\tdropdown.classList.add(\"below\");\n\t\t}\n\n\t\t//if there's enough space to the right of target-element\n\t\tif (alignmentContainer.clientWidth-viewportPos.x>dropdown.offsetWidth) {\n\t\t\t//then align the left of the dropdown with the left of the target-element\n\t\t\tdropdown.style.left=alignmentPos.x+\"px\";\n\t\t\tdropdown.classList.add(\"left\");\n\t\t} else {\n\t\t\t//otherwise align the right of the dropdown with the right of the target-element\n\t\t\tdropdown.style.left=alignmentPos.x-(dropdown.offsetWidth-target.offsetWidth)+\"px\";\n\t\t\tdropdown.classList.add(\"right\");\n\t\t}\n\t}\n\n\t_enterCell(e) {\n\t\tif (this._inEditMode||this._cellCursor.classList.contains(\"disabled\"))\n\t\t\treturn;\n\t\tif (this._activeSchemaNode.input) {\n\t\t\te.preventDefault();//prevent text selection upon entering editmode\n\t\t\tif (this._activeSchemaNode.input.type===\"button\")\n\t\t\t\treturn this._activeDetailsCell.el.click();\n\t\t\tthis._inputVal=this._selectedCellVal;\n\t\t\tthis._inEditMode=true;\n\t\t\tthis._cellCursor.classList.add(\"edit-mode\");\n\t\t\t({textarea:this._openTextAreaEdit,date:this._openDateEdit,select:this._openSelectEdit\n\t\t\t\t,file:this._openFileEdit}[this._activeSchemaNode.input.type]??this._openTextEdit).call(this,e);\n\t\t} else if (this._activeSchemaNode.type===\"group\") {\n\t\t\tthis._openGroup(this._activeDetailsCell);\n\t\t}\n\t}\n\n\t_openGroup(groupObj) {\n\t\tlet doOpen=true;\n\t\tgroupObj.schemaNode.onOpen?.({preventDefault:()=>doOpen=false},groupObj);\n\t\tif (!doOpen)\n\t\t\treturn;\n\t\tgroupObj.el.classList.add(\"open\");\n\t\tthis._selectDetailsCell(this._getFirstSelectableDetailsCell(groupObj,true,true));\n\t\tgroupObj.schemaNode.onOpenAfter?.(groupObj);\n\t\t\n\t}\n\n\t_closeGroup(groupObject) {\n\t\tif (groupObject.creating&&!this._closeRepeatedInsertion(groupObject))\n\t\t\treturn false;\n\t\tgroupObject.el.classList.remove(\"open\");\n\t\tthis._ignoreClicksUntil=Date.now()+500;\n\t\tif (groupObject.updateRenderOnClose) {//if group is flagged for having its closed-render updated on close\n\t\t\tdelete groupObject.updateRenderOnClose;//delete the flag so it doesn't get triggered again\n\t\t\tlet cell,renderText;\n\t\t\t//look for ancestor-cell with rowData which repeated rows have. It's a sub-data-row of #data.\n\t\t\t//if we got all the way to the root without finding any repeated-rows then use datarow directly from #data\n\t\t\tfor (cell=groupObject.parent;!cell.dataObj&&cell.parent;cell=cell.parent);//look for ancestor with rowData\n\t\t\trenderText=groupObject.schemaNode.closedRender(groupObject.dataObj);\n\t\t\tgroupObject.el.rows[groupObject.el.rows.length-1].cells[0].innerText=renderText;\n\t\t}\n\t\tgroupObject.schemaNode.onClose?.(groupObject);\n\t\treturn true;\n\t}\n\n\t_repeatInsert(repeated,creating,data,entrySchemaNode=null) {\n\t\t//normally entrySchemaNode should be the entry of repeated, \n\t\t// but schemaNode can be supplied for creating creation-entries\n\t\tentrySchemaNode??=repeated.schemaNode.entry;\n\n\t\tlet indexOfNew,rowIndex;\n\t\tif (!creating&&repeated.schemaNode.sortCompare&&!entrySchemaNode.creator) {\n\t\t\tfor (indexOfNew=0;indexOfNew<repeated.children.length-!!repeated.schemaNode.create; indexOfNew++)\n\t\t\t\tif (repeated.schemaNode.sortCompare(data,repeated.children[indexOfNew].dataObj)<0)\n\t\t\t\t\tbreak;\n\t\t} else\n\t\t\tindexOfNew=repeated.children.length-(repeated.schemaNode.create&&!entrySchemaNode.creator)//pos be4 creator\n\t\tfor (let root=repeated.parent; root.parent; root=root.parent,rowIndex=root.rowIndex);//get main-index\n\t\tlet entryNode=entrySchemaNode;\n\t\tif (repeated.schemaNode.create&&entrySchemaNode.type===\"group\")\n\t\t\tentryNode=this._schemaCopyWithDeleteButton(entrySchemaNode,this._repeatedOnDelete);\n\t\t\t//make a wrapped copy of the entry so delete-controls can be appended without touching the original\n\t\tconst newObj=this._generateCollectionItem(entryNode,rowIndex,repeated,repeated.path,data,indexOfNew,creating);\n\t\tif (creating) {\n\t\t\tnewObj.creating=true;//creating means it hasn't been commited yet.\n\t\t\tthis._selectFirstSelectableDetailsCell(newObj,true,true);\n\t\t\trepeated.schemaNode.onCreateOpen?.(repeated);\n\t\t}\n\t\treturn newObj.el;\n\t}\n\n\t_changeInstanceNodeIndex(instanceNode,newIndex) {\n\t\tinstanceNode.index=newIndex;\n\t\tconst level=instanceNode.path.length-1;\n\t\tfor (const pathEl of instanceNode.el.parentElement.querySelectorAll('[data-path]')) {\n\t\t\tconst path=pathEl.dataset.path.split(\"-\");\n\t\t\tpath[level]=newIndex;\n\t\t\tpathEl.dataset.path=path.join(\"-\");\n\t\t}\n\t\tfixObjPath(instanceNode,newIndex);\n\t\tfunction fixObjPath(instanceNode) {\n\t\t\tif (instanceNode.path)\n\t\t\t\tinstanceNode.path[level]=newIndex;\n\t\t\tinstanceNode.children?.forEach(fixObjPath);\n\t\t}\n\t}\n\n\t_deleteCell(instanceNode,programatically=false) {\n\t\tlet newSelectedCell;\n\t\tfor (let i=instanceNode.index,otherCell; otherCell=instanceNode.parent.children[++i];)\n\t\t\tthis._changeInstanceNodeIndex(otherCell,i-1)\n\t\tif (instanceNode.parent.children.length>=instanceNode.index+1)\n\t\t\tnewSelectedCell=instanceNode.parent.children[instanceNode.index+1];\n\t\telse if (instanceNode.parent.children.length>1)\n\t\t\tnewSelectedCell=instanceNode.parent.children[instanceNode.index-1];\n\t\tinstanceNode.parent.children.splice(instanceNode.index,1);\n\t\tif (!programatically)\n\t\t\tinstanceNode.parent.dataObj.splice(instanceNode.index,1);\n\t\tif (instanceNode.parent.schemaNode.type===\"repeated\"&&instanceNode.parent.parent.schemaNode.type===\"list\")\n\t\t\tinstanceNode.el.parentElement.parentElement.remove();\n\t\telse\n\t\t\tinstanceNode.el.parentElement.remove();\n\t\tthis._activeDetailsCell=null;//causes problem otherwise when #selectDetailsCell checks old cell\n\t\tif (!programatically)\n\t\t\tthis._selectDetailsCell(newSelectedCell??instanceNode.parent.parent);\n\t\tinstanceNode.creating&&instanceNode.parent.schemaNode.onCreateCancel?.(instanceNode.parent);\n\t}\n\n\t_openTextEdit() {\n\t\tconst input=this._cellCursor.appendChild(document.createElement(\"input\"));\n\n\t\t//for when blurring by clicking outside of table etc. exit edit-mode and commit the change but keep the cell\n\t\t//selected. not sure why the timeout is needed but it is.\n\t\tinput.addEventListener(\"blur\",()=>setTimeout(this._exitEditMode.bind(this,true)));\n\t\t\n\t\tinput.addEventListener(\"change\",()=>this._inputVal=input.value);\n\t\tinput.value=this._selectedCellVal??\"\";\n\t\tif (this._activeSchemaNode.input.format)\n\t\t\tthis._attachInputFormatter(input,this._activeSchemaNode.input.format);\n\t\tinput.focus();\n\t\tif (this._activeSchemaNode.input.maxLength)\n\t\t\tinput.maxLength=this._activeSchemaNode.input.maxLength;\n\t\tinput.placeholder=this._activeSchemaNode.input.placeholder??\"\";\n\t}\n\n\t_mapAdd(map,key,val) {\n\t\tmap.keys.push(key);\n\t\tmap.vals.push(val);\n\t}\n\n\t_mapGet(map,key) {\n\t\tconst index=map.keys.indexOf(key);\n\t\tif (index!=-1)\n\t\t\treturn map.vals[index];\n\t}\n\n\t_mapRemove(map,key) {\n\t\tconst index=map.keys.indexOf(key);\n\t\tmap.keys.splice(index,1);\n\t\tmap.vals.splice(index,1);\n\t}\n\n\n\t/**\n\t * Enter \"file edit mode\" for a file-input cell.\n\t *\n\t * This method is called when the user activates a file-input cell\n\t * (via Enter, double-click, etc). It temporarily replaces the cell\n\t * contents with an interactive file-drop zone that supports:\n\t *\n\t *   - Clicking or pressing Enter/Space to open the system file picker.\n\t *   - Drag-and-drop of a file directly onto the cell.\n\t *   - Visual feedback while dragging a file over the target.\n\t *\n\t * During this mode:\n\t *   - The cell is replaced with a small UI component containing\n\t *     a text prompt and a hidden <input type=\"file\">.\n\t *   - Once a file is selected or dropped, the event is forwarded to\n\t *     #processFileUpload(), which performs the actual upload logic.\n\t *\n\t * After a file is chosen, the edit mode automatically exits and\n\t * the details cell is re-selected.\n\t */\n\t_openFileEdit() {\n\t\twindow.getSelection().empty();\n\t\n\t\tconst fileDiv = this._cellCursor.appendChild(document.createElement(\"div\"));\n\t\tfileDiv.classList.add(\"file\");\n\t\tfileDiv.tabIndex = 0;\n\t\tfileDiv.focus();\n\t\n\t\tconst fileInput = fileDiv.appendChild(document.createElement(\"input\"));\n\t\tfileInput.type = \"file\";\n\t\n\t\tfileDiv.innerHTML = this._opts.lang?.fileChooseOrDrag ?? \"<b>Press to choose a file</b> or drag it here\";\n\t\n\t\tconst dropDiv = fileDiv.appendChild(document.createElement(\"div\"));\n\t\tdropDiv.classList.add(\"drop\");\n\t\tdropDiv.innerHTML = this._opts.lang?.fileDropToUpload ?? \"Drop to upload\";\n\t\n\t\t// Local small handler\n\t\tconst keydown = e => {\n\t\t\tif (e.key === \"Escape\")\n\t\t\t\treturn; // let Tablance handle it\n\t\t\t\n\t\t\te.stopPropagation();\n\t\n\t\t\tif (e.key.startsWith(\"Arrow\"))\n\t\t\t\te.preventDefault();\n\t\t\telse if (e.key === \"Enter\" || e.key === \" \") {\n\t\t\t\te.preventDefault();\n\t\t\t\tfileInput.click();\n\t\t\t}\n\t\t};\n\t\n\t\t// Bind handleFile to preserve `this`\n\t\tconst handleFile = this._processFileUpload.bind(this);\n\t\n\t\t// Events\n\t\tfileDiv.addEventListener(\"keydown\", keydown);\n\t\tfileDiv.addEventListener(\"click\", () => fileInput.click());\n\t\tfileDiv.addEventListener(\"dragenter\", () => dropDiv.style.display = \"block\");\n\t\tdropDiv.addEventListener(\"dragleave\", () => dropDiv.style.display = \"none\");\n\t\tdropDiv.addEventListener(\"dragover\", e => e.preventDefault());\n\t\tfileDiv.addEventListener(\"drop\", e => {\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t\thandleFile(e.dataTransfer.files[0]);\n\t\t});\n\t\tfileInput.addEventListener(\"change\", e => handleFile(e.target.files[0]));\n\t}\n\n\t/**\n\t * Called by #openFileEdit() after the user selects or drops a file.\n\t * Handle the actual upload of a selected file.\n\t *\n\t * This method:\n\t *\n\t *   1. Stores the file as the cell's input value.\n\t *   2. Creates and registers a metadata object for tracking:\n\t *        - uploadedBytes (updated during upload)\n\t *        - progress bars currently displayed for this file\n\t *   3. Initiates an XMLHttpRequest upload and wires up:\n\t *        - upload progress events (to update progress bars)\n\t *        - final load event (to mark completion and clean up metadata)\n\t *   4. Invokes the user-defined fileUploadHandler attached to the\n\t *      cell’s schemaNode, allowing full customization of how the file\n\t *      is handled on the server side.\n\t *   5. Sends the file using multipart/form-data via FormData.\n\t *\n\t * After initiating the upload:\n\t *   - The cell exits edit mode.\n\t *   - The original details cell is automatically re-selected.\n\t *\n\t * This method does not handle UI creation — only the upload workflow\n\t * and progress bookkeeping.\n\t */\n\t_processFileUpload(file) {\n\t\tthis._inputVal = file;\n\t\n\t\tconst meta = Object.assign(Object.create(null), {uploadedBytes: 0,bars: []});\n\t\tthis._mapAdd(this._filesMeta, file, meta);\n\n\t\tconst xhr = !this._opts.useFakeFileUploadTest ? new XMLHttpRequest()\n\t\t\t: new FakeXMLHttpRequest({totalBytes:file.size||1,rate:this._opts.fakeUploadRate,\n\t\t\t\tstartAt:this._opts.fakeUploadStartAt});\n\n\t\tconst updateProgressBars=(loaded,total)=>{\n\t\t\tfor (let i=0; i<meta.bars.length; i++) {\n\t\t\t\tconst bar=meta.bars[i];\n\t\t\t\tif (!bar.isConnected) {\n\t\t\t\t\tmeta.bars.splice(i--,1);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tmeta.uploadedBytes=loaded;\n\t\t\t\tconst pct=total?parseInt(loaded/total*100):0;\n\t\t\t\tbar.style.width=bar.firstChild.innerText=pct+\"%\";\n\t\t\t\t}\n\t\t};\n\t\tconst finalizeUpload=()=>{\n\t\t\tthis._mapRemove(this._filesMeta,file);\n\t\t\tfor (const bar of meta.bars)\n\t\t\t\tif (bar.isConnected) {\n\t\t\t\t\tbar.parentElement.classList.remove(\"active\");\n\t\t\t\t\tbar.firstChild.innerText=this._opts.lang?.fileUploadDone??\"Done!\";\n\t\t\t\t}\n\t\t};\n\t\tconst totalBytes=file.size||1;\n\t\txhr.upload.addEventListener(\"progress\", e=>updateProgressBars(e.loaded,e.total));\n\t\txhr.addEventListener(\"load\", () => {\n\t\t\tupdateProgressBars(totalBytes,totalBytes);\n\t\t\tfinalizeUpload();\n\t\t});\n\t\n\t\tthis._activeSchemaNode.input.fileUploadHandler?.(xhr,file,this._activeSchemaNode,this._cellCursorDataObj,\n\t\t\tthis._mainRowIndex,this._activeDetailsCell);\n\t\n\t\tconst formData = new FormData();\n\t\tformData.append(\"file\", file);\n\t\txhr.send(formData);\n\t\n\t\tthis._exitEditMode(true);\n\t\tthis._selectDetailsCell(this._activeDetailsCell);\n\t}\n\t\n\n\t_openTextAreaEdit() {\n\t\tconst textarea=this._cellCursor.appendChild(document.createElement(\"textarea\"));\n\t\ttextarea.addEventListener('input', this._autoTextAreaResize.bind(this));\n\n\t\t{\tconst {paddingLeft,paddingRight,paddingTop,paddingBottom}=window.getComputedStyle(this._selectedCell);\n\t\t\t//add the padding of the cell to the textarea for consistency\n\t\t\tObject.assign(textarea.style,{paddingLeft,paddingRight,paddingTop,paddingBottom});}\n\t\t\n\t\ttextarea.value=this._selectedCellVal??\"\";\n\t\ttextarea.addEventListener(\"keydown\",keydown.bind(this));\n\t\ttextarea.focus();\n\t\ttextarea.addEventListener(\"change\",_e=>this._inputVal=textarea.value);\n\t\tif (this._activeSchemaNode.input.maxLength)\n\t\t\ttextarea.maxLength=this._activeSchemaNode.input.maxLength;\n\t\ttextarea.placeholder=this._activeSchemaNode.input.placeholder??\"\";\n\t\tfunction keydown(e) {\n\t\t\tif (e.key===\"Enter\"&&e.ctrlKey) {\n\t\t\t\tthis._insertAtCursor(textarea,\"\\r\\n\");\n\t\t\t\ttextarea.dispatchEvent(new Event('input'));//trigger input so that autoTextAreaResize gets called\n\t\t\t\te.stopPropagation();\n\t\t\t} else if (e.key===\"Escape\") {\n\t\t\t\ttextarea.value=this._selectedCellVal??\"\";\n\t\t\t\ttextarea.dispatchEvent(new Event('input'));\n\t\t\t}\n\t\t}\n\t}\n\n\t\t/**\n\t * Render all select options into a given <ul> and update highlighted indices if the selected value is found.\n\t * @param {HTMLUListElement} ul\n\t * @param {Array} opts\n\t * @param {*} selectedVal\n\t * @param {Object} ctx\n\t * @returns {boolean} true if the selected option was found among opts\n\t */\n\t\t_renderSelectOptions(ul,opts,selectedVal,ctx) {\n\t\t\tlet foundSelected=false;\n\t\t\tul.innerHTML=\"\";\n\t\t\tfor (const opt of opts) {\n\t\t\t\tconst li=ul.appendChild(document.createElement(\"li\"));\n\t\t\t\tif (opt.cssClass)\n\t\t\t\t\tli.className=opt.cssClass;\n\t\t\t\tli.innerText=opt.text;\n\t\t\t\tif (selectedVal==opt) {\n\t\t\t\t\tfoundSelected=true;\n\t\t\t\t\tli.classList.add(\"selected\",\"highlighted\");\n\t\t\t\t\tctx.highlightLiIndex=ul.children.length-1;\n\t\t\t\t\tctx.highlightUlIndex=parseInt(ul.dataset.ulIndex);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn foundSelected;\n\t\t}\n\t\n\t\t/**\n\t\t * Highlight a specific option in one of the ULs and optionally scroll it into view when keyboard navigating.\n\t\t * @param {Object} ctx\n\t\t * @param {number} ulIndex 0 for pinned, 1 for main\n\t\t * @param {number} liIndex index within the selected UL\n\t\t * @param {boolean} keyboardNavigating whether the change came from arrow keys\n\t\t */\n\t\t_highlightSelectOption(ctx,ulIndex,liIndex,keyboardNavigating) {\n\t\t\tconst highlighted=ctx.ulDiv.getElementsByClassName(\"highlighted\")[0];\n\t\t\tif (highlighted)\n\t\t\t\thighlighted.classList.remove(\"highlighted\");\n\t\t\tconst ul=ctx.ulDiv.children[ctx.highlightUlIndex=ulIndex];\n\t\t\tconst li=ul.children[ctx.highlightLiIndex=liIndex];\n\t\t\tif (!li)\n\t\t\t\treturn;\n\t\t\tli.classList.add(\"highlighted\");\n\t\t\tif (ulIndex&&keyboardNavigating)\n\t\t\t\tul.scrollTop=li.offsetTop-ul.offsetTop+li.offsetHeight/2-ul.offsetHeight/2;\n\t\t}\n\t\n\t\t/**\n\t\t * Filter loose options based on the current input value and update rendered lists and create-option state.\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectInputChange(ctx) {\n\t\t\tconst value=ctx.input.value;\n\t\t\tconst hadFilter=!!ctx.filterText;\n\t\t\tconst filterChangedAtEdges=!value.includes(ctx.filterText)||!hadFilter;\n\t\t\tctx.canCreate=!!value;\n\t\t\tif (filterChangedAtEdges)\n\t\t\t\tctx.looseOpts.splice(0,Infinity,...ctx.strctInp.options);\n\t\t\tfor (let i=-1,opt; opt=ctx.looseOpts[++i];)\n\t\t\t\tif (!opt.text.includes(value)||opt.pinned)\n\t\t\t\t\tctx.looseOpts.splice(i--,1);\n\t\t\t\telse if (opt.text.toLowerCase()==value.toLowerCase())\n\t\t\t\t\tctx.canCreate=false;\n\t\t\tthis._updateCreateOptionVisibility(ctx);\n\t\t\tconst foundSelected=this._renderSelectOptions(ctx.mainUl,ctx.looseOpts,this._inputVal,ctx);\n\t\t\tif (foundSelected)\n\t\t\t\tctx.pinnedUl.querySelector(\".highlighted\")?.classList.remove(\"highlighted\");\n\t\t\telse if (ctx.highlightUlIndex) {\n\t\t\t\tif (ctx.looseOpts.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,1,0,true);\n\t\t\t\telse if (ctx.pinnedUl.children.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,0,0,true);\n\t\t\t}\n\t\t\tctx.noResults.style.display=ctx.looseOpts.length?\"none\":\"block\";\n\t\t\tctx.filterText=value;\n\t\t\tif (ctx.creationLi)\n\t\t\t\tctx.creationLi.innerText=`Create [${ctx.filterText}]`;\n\t\t}\n\t\n\t\t/**\n\t\t * Show or hide the \"create new option\" list item depending on ctx.canCreate and current DOM state.\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_updateCreateOptionVisibility(ctx) {\n\t\t\tif (!ctx.creationLi)\n\t\t\t\treturn;\n\t\t\tif (ctx.canCreate) {\n\t\t\t\tif (ctx.creationLi.parentElement!=ctx.pinnedUl)\n\t\t\t\t\tctx.pinnedUl.appendChild(ctx.creationLi);\n\t\t\t} else if (ctx.creationLi.parentElement==ctx.pinnedUl)\n\t\t\t\tctx.pinnedUl.removeChild(ctx.creationLi);\n\t\t}\n\t\n\t\t/**\n\t\t * Handle keyboard navigation and selection inside the open select dropdown.\n\t\t * @param {KeyboardEvent} e\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectKeyDown(e,ctx) {\n\t\t\tif (e.key===\"ArrowDown\"||e.key===\"ArrowUp\") {\n\t\t\t\te.preventDefault();\n\t\t\t\tconst direction=e.key===\"ArrowDown\"?1:-1;\n\t\t\t\tconst currentIndex=ctx.highlightLiIndex==null?0:ctx.highlightLiIndex;\n\t\t\t\tconst newIndex=currentIndex+direction;\n\t\t\t\tif (ctx.highlightUlIndex??true) {\n\t\t\t\t\tif (ctx.looseOpts.length&&newIndex<ctx.looseOpts.length&&newIndex>=0)\n\t\t\t\t\t\tthis._highlightSelectOption(ctx,1,newIndex,true);\n\t\t\t\t\telse if (newIndex==-1&&ctx.pinnedUl.children.length)\n\t\t\t\t\t\tthis._highlightSelectOption(ctx,0,ctx.pinnedUl.children.length-1,true);\n\t\t\t\t} else if (newIndex>=0&&newIndex<ctx.pinnedUl.children.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,0,newIndex,true);\n\t\t\t\telse if (newIndex>=ctx.pinnedUl.children.length&&ctx.looseOpts.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,1,0,true);\n\t\t\t} else if (e.key===\"Enter\") {\n\t\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t\t\tthis._moveCellCursor(0,e.shiftKey?-1:1);\n\t\t\t\te.stopPropagation();\n\t\t\t} else if (e.key===\"Escape\")\n\t\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t}\n\t\n\t\t/**\n\t\t * Handle mouse movement over list items by updating the highlighted option.\n\t\t * @param {MouseEvent} e\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectMouseMove(e,ctx) {\n\t\t\tconst li=e.target.closest(\"li\");\n\t\t\tif (!li)\n\t\t\t\treturn;\n\t\t\tconst ul=li.parentNode;\n\t\t\tconst ulIndex=parseInt(ul.dataset.ulIndex);\n\t\t\tconst liIndex=[...ul.children].indexOf(li);\n\t\t\tthis._highlightSelectOption(ctx,ulIndex,liIndex,false);\n\t\t}\n\t\n\t\t/**\n\t\t * Handle mouse click on a list item: select it, close the dropdown and exit edit mode.\n\t\t * @param {MouseEvent} e\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectClick(e,ctx) {\n\t\t\tconst li=e.target.closest(\"li\");\n\t\t\tif (!li)\n\t\t\t\treturn;\n\t\t\tconst ul=e.currentTarget;\n\t\t\tctx.highlightUlIndex=parseInt(ul.dataset.ulIndex);\n\t\t\tctx.highlightLiIndex=Array.prototype.indexOf.call(ul.children,li);\n\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t\tthis._exitEditMode(true);\n\t\t}\n\t\n\t\t/**\n\t\t * Create base DOM structure and context object for the select dropdown.\n\t\t * Splits options into pinned/loose arrays and prepares elements but does not attach listeners.\n\t\t * @param {Object} strctInp the input-definition object from the active cell schemaNode\n\t\t * @returns {Object} ctx a state container for the open select dropdown\n\t\t */\n\t\t_createSelectDropdownContext(strctInp) {\n\t\t\tconst selectContainer=document.createElement(\"div\");\n\t\t\tconst pinnedOpts=[];\n\t\t\tconst looseOpts=[];\n\t\t\tconst inputWrapper=selectContainer.appendChild(document.createElement(\"div\"));\n\t\t\tconst input=inputWrapper.appendChild(document.createElement(\"input\"));\n\t\t\tinputWrapper.classList.add(\"input-wrapper\");\n\t\t\tconst ulDiv=selectContainer.appendChild(document.createElement(\"div\"));\n\t\t\tconst pinnedUl=ulDiv.appendChild(document.createElement(\"ul\"));\n\t\t\tpinnedUl.classList.add(\"pinned\");\n\t\t\tconst mainUl=ulDiv.appendChild(document.createElement(\"ul\"));\n\t\t\tmainUl.classList.add(\"main\");\n\t\t\tconst noResults=selectContainer.appendChild(document.createElement(\"div\"));\n\t\t\tnoResults.innerHTML=strctInp.noResultsText??this._opts.lang?.selectNoResultsFound??\"No results found\";\n\t\t\tnoResults.className=\"no-results\";\n\t\t\tfor (const opt of strctInp.options) {\n\t\t\t\tconst visible=!opt.visibleIf || opt.visibleIf({dataContext:this._cellCursorDataObj,\n\t\t\t\t\tschemaNode:this._activeSchemaNode, rowIndex:this._mainRowIndex, \n\t\t\t\t\tinstanceNode:this._activeDetailsCell});\n\t\t\t\tif (visible)\n\t\t\t\t\t(opt.pinned?pinnedOpts:looseOpts).push(opt);\n\t\t\t}\n\t\t\tconst ctx=Object.assign(Object.create(null),{\n\t\t\t\tstrctInp,\n\t\t\t\tselectContainer,\n\t\t\t\tinputWrapper,\n\t\t\t\tinput,\n\t\t\t\tulDiv,\n\t\t\t\tpinnedUl,\n\t\t\t\tmainUl,\n\t\t\t\tnoResults,\n\t\t\t\tpinnedOpts,\n\t\t\t\tlooseOpts,\n\t\t\t\tcreationLi:null,\n\t\t\t\tcanCreate:false,\n\t\t\t\tfilterText:\"\",\n\t\t\t\thighlightLiIndex:null,\n\t\t\t\thighlightUlIndex:null,\n\t\t\t\twindowMouseDown:null\n\t\t\t});\n\t\t\treturn ctx;\n\t\t}\n\t\n\t\t/**\n\t\t * Close the select dropdown, update the current value (including create-new if applicable) \n\t\t * and clean up listeners.\n\t\t * @param {Object} ctx\n\t\t * @param {Event} e the event that triggered the close (click, keydown, etc.)\n\t\t */\n\t\t_closeSelectDropdown(ctx,e) {\n\t\t\tif (!ctx.selectContainer.parentElement)\n\t\t\t\treturn;\n\t\t\tif (!ctx.highlightUlIndex&&ctx.pinnedUl.children[ctx.highlightLiIndex]?.dataset.type==\"create\") {\n\t\t\t\tctx.filterText=ctx.filterText??ctx.input.value;\n\t\t\t\tthis._inputVal={text:ctx.filterText};\n\t\t\t\tctx.strctInp.options.push(this._inputVal);\n\t\t\t\tctx.strctInp.createNewOptionHandler?.(this._inputVal,e,this._cellCursorDataObj,this._mainRowIndex\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,this._activeSchemaNode,this._activeDetailsCell);\n\t\t\t} else\n\t\t\t\tthis._inputVal=(ctx.highlightUlIndex?ctx.looseOpts:ctx.pinnedOpts)[ctx.highlightLiIndex];\n\t\t\tctx.selectContainer.remove();\n\t\t\tif (ctx.windowMouseDown)\n\t\t\t\twindow.removeEventListener(\"mousedown\",ctx.windowMouseDown);\n\t\t}\n\t\n\t\t/**\n\t\t * Open edit mode for a cell that uses a select-input: creates the dropdown UI,\n\t\t * wires up filtering, keyboard navigation and mouse interaction, and focuses the input.\n\t\t */\n\t\t_openSelectEdit() {\n\t\t\tconst strctInp=this._activeSchemaNode.input;\n\t\t\tthis._inputVal=this._cellCursorDataObj[this._activeSchemaNode.id];\n\t\t\tconst ctx=this._createSelectDropdownContext(strctInp);\n\t\t\tthis._cellCursor.style.backgroundColor=\"transparent\";\n\t\t\tconst allowCreateNew=strctInp.allowCreateNew;\n\t\t\tif (allowCreateNew||ctx.looseOpts.length>=(strctInp.minOptsFilter??this._opts.defaultMinOptsFilter??5))\n\t\t\t\tctx.input.addEventListener(\"input\",()=>this._handleSelectInputChange(ctx));\n\t\t\telse\n\t\t\t\tctx.inputWrapper.classList.add(\"hide\");\n\t\t\tctx.input.addEventListener(\"keydown\",e=>this._handleSelectKeyDown(e,ctx));\n\t\t\tctx.input.placeholder=strctInp.selectInputPlaceholder??\"\";\n\t\t\tctx.input.addEventListener(\"blur\",ctx.input.focus);\n\t\t\tfor (let i=-1,ul;ul=[ctx.pinnedUl,ctx.mainUl][++i];) {\n\t\t\t\tul.dataset.ulIndex=i;\n\t\t\t\tul.addEventListener(\"mousemove\",e=>this._handleSelectMouseMove(e,ctx));\n\t\t\t\tul.addEventListener(\"click\",e=>this._handleSelectClick(e,ctx));\n\t\t\t}\n\t\t\tif (strctInp.allowCreateNew) {\n\t\t\t\tctx.creationLi=document.createElement(\"li\");\n\t\t\t\tctx.creationLi.dataset.type=\"create\";\n\t\t\t}\n\t\t\tthis._renderSelectOptions(ctx.pinnedUl,ctx.pinnedOpts,this._inputVal,ctx);\n\t\t\tthis._renderSelectOptions(ctx.mainUl,ctx.looseOpts,this._inputVal,ctx);\n\t\t\tthis._cellCursor.parentElement.appendChild(ctx.selectContainer);\n\t\t\tctx.selectContainer.className=\"tablance-select-container\";\n\t\t\tthis._alignDropdown(ctx.selectContainer);\n\t\t\tconst windowMouseDown=e=>{\n\t\t\t\tlet el=e.target;\n\t\t\t\twhile (el&&el!=ctx.selectContainer)\n\t\t\t\t\tel=el.parentElement;\n\t\t\t\tif (!el) {\n\t\t\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t\t\t\tthis._exitEditMode(false);\n\t\t\t\t}\n\t\t\t};\n\t\t\tctx.windowMouseDown=windowMouseDown;\n\t\t\twindow.addEventListener(\"mousedown\",windowMouseDown);\n\t\t\tctx.input.focus();\n\t\t}\n\t\n\n\t_validateInput(newVal) {\n\t\tlet message;\n\t\tconst input=this._cellCursor.querySelector(\"input\");\n\t\tconst doCommit=this._activeSchemaNode.input.validation(newVal,m=>message=m,this._activeSchemaNode\n\t\t\t\t\t\t\t\t\t\t\t\t,this._cellCursorDataObj,this._mainRowIndex,this._activeDetailsCell);\n\t\tif (doCommit)\n\t\t\treturn true;\n\t\tinput.focus();\n\t\tif (message)\n\t\t\tthis._showTooltip(message);\n\t}\n\n\t/**\n\t * Updates dependent cells when a cell's value changes.\n\t *\n\t * This method propagates changes from a modified cell to its dependent cells,\n\t * ensuring that the dependent cells are updated accordingly. It traverses the\n\t * hierarchical structure of cells and updates both details cells and main-row\n\t * cells as needed.\n\t *\n\t * @param {Object} editedCellSchemaNode - The schema-node of the cell that was edited.\n\t * @param {Object} [editedInstanceNode] - The instance-node representing the edited cell. This is used to determine\n\t *                                   the closest scope for dependency updates.\n\t */\n\t_updateDependentCells(editedCellSchemaNode, editedInstanceNode) {\n\t\tfor (const depPath of editedCellSchemaNode.dependencyPaths??[])\n\t\t\tif (depPath[0]===\"m\") {//if cell is in main row cell\n\t\t\t\t// Find the corresponding table row for the main data row\n\t\t\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${this._mainRowIndex}\"]:not(.details)`);\n\t\t\t\t// Update the content of the dependent cell in the main table\n\t\t\t\tthis._updateMainRowCell(tr.cells[depPath[1]], this._colSchemaNodes[depPath[1]]);\n\t\t\t} else if (this._openDetailsPanes[this._mainRowIndex]) {//if cell is in details and details is open\n\t\t\t\t//cells is an array that potentially can hold more than 1 cell. The reason is that when going into\n\t\t\t\t//repeated structures, it \"splits\" into multiple cells if there are multiple repeated-entries/instances\n\t\t\t\tlet cells=depPath[0]===\"r\"?[editedInstanceNode]:[this._openDetailsPanes[this._mainRowIndex]];\n\n\t\t\t\tfor (var step=1; depPath[step]===\"..\"; step++)//if there are any, iterate all the \"..\"\n\t\t\t\t\tcells[0] = cells[0].parent;//go up one level per \"..\". At this point cells will only have one cell\n\n\t\t\t\tfor (; step<depPath.length; step++) {//iterate the steps\n\t\t\t\t\tif (cells[0].schemaNode.type===\"repeated\") {\n\t\t\t\t\t\tconst newCells=[];//will hold the new set of cells after this step\n\t\t\t\t\t\tfor (const cell of cells)\n\t\t\t\t\t\t\tnewCells.push(...cell.children);//add all repeated-children of current cell\n\t\t\t\t\t\tcells=newCells;//set cells to the new set of cells\n\t\t\t\t\t}\n\t\t\t\t\tfor (let cellI=0; cellI<cells.length; cellI++)//iterate the cell(s)\n\t\t\t\t\t\tcells[cellI]=cells[cellI].children[depPath[step]];//and do the step\n\t\t\t\t}\n\t\t\t\tfor (const cell of cells)//iterate the cell(s) again\n\t\t\t\t\tthis._updateDetailsCell(cell,cell.dataObj);//and do the actual update\n\t\t\t}\n\t}\n\n\t_exitEditMode(save) {\n\t\tif (!this._inEditMode)\n\t\t\treturn true;\t\n\t\tconst input=this._cellCursor.querySelector(\"input\");\n\t\tif (this._activeSchemaNode.input.format?.stripDelimiterOnSave&&this._activeSchemaNode.input.format.delimiter)\n\t\t\tinput.value=input.value.replaceAll(this._activeSchemaNode.input.format.delimiter, \"\");\n\t\tif (this._activeSchemaNode.input.validation&&save&&!this._validateInput(input.value))\n\t\t\treturn false;\n\t\t//make the table focused again so that it accepts keystrokes and also trigger any blur-event on input-element\n\t\tthis.rootEl.focus({preventScroll:true});//so that #inputVal gets updated-\n\n\n\t\tthis._inEditMode=false;\n\t\tthis._cellCursor.classList.remove(\"edit-mode\");\n\t\tif (save&&this._inputVal!=this._selectedCellVal) {\n\t\t\tthis._doEditSave();\n\t\t}\n\t\tthis._cellCursor.innerHTML=\"\";\n\t\t//if (this._activeSchemaNode.input.type===\"textarea\")//also needed for file..\n\t\tthis._adjustCursorPosSize(this._selectedCell);\n\t\tthis._highlightOnFocus=false;\n\t\treturn true;\n\t}\n\n\t_showTooltip(message,target=this._cellCursor) {\n\t\tthis._cellCursor.parentElement.appendChild(this._tooltip);\n\t\tsetTimeout(()=>this._tooltip.style.visibility=\"visible\");//set it on a delay because mouseDownHandler might\n\t\t\t\t\t\t//otherwise immediately set it back to hidden when bubbling up depending on where the click was\n\t\tthis._tooltip.firstChild.innerText=message;\n\t\tthis._alignDropdown(this._tooltip,target);\n\t\tthis._scrollElementIntoView(this._tooltip);\n\t\treturn true;\n\t}\n\n\t_scrollElementIntoView(){}//default is to do nothing. Tablance (main) overrides this.\n\n\t_closeRepeatedInsertion(repeatEntry) {\n\t\tif (Object.values(repeatEntry.dataObj).filter(x=>x!=null).length) {\n\t\t\tlet message;//message to show to the user if creation was unsucessful\n\t\t\tfor (var root=repeatEntry; root.parent; root=root.parent);//get root-object in order to retrieve rowIndex\n\t\t\tlet doCreate=true;\n\t\t\tif (repeatEntry.schemaNode.creationValidation)\n\t\t\t\tdoCreate=repeatEntry.schemaNode.creationValidation(m=>message=m,repeatEntry.schemaNode\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,repeatEntry.dataObj,root.rowIndex,repeatEntry);\n\t\t\tif (!doCreate) {\n\t\t\t\tif (message)\n\t\t\t\t\tthis._showTooltip(message,repeatEntry.el);\n\t\t\t\treturn false;//prevent commiting/closing the group\n\t\t\t}\n\t\t\tconst creationContainer=repeatEntry.schemaNode.type==\"group\"?repeatEntry:repeatEntry.parent;\n\t\t\tconst repeatedContainer=creationContainer.parent;\n\t\t\tconst dataContext=repeatedContainer?.parent?.dataObj??this._data[root.rowIndex];\n\t\t\tconst payload={\n\t\t\t\tnewDataItem: repeatEntry.dataObj,\n\t\t\t\tdataContext,\n\t\t\t\tdataArray: repeatedContainer?.dataObj,\n\t\t\t\tdataKey: repeatedContainer?.schemaNode.id,\n\t\t\t\titemIndex: repeatEntry.index,\n\t\t\t\trepeatedSchemaNode: repeatedContainer?.schemaNode,\n\t\t\t\tentrySchemaNode: creationContainer.schemaNode,\n\t\t\t\tnewInstanceNode: repeatEntry,\n\t\t\t\tmainIndex: root.rowIndex,\n\t\t\t\tbulkEdit: false,\n\t\t\t\tclosestMeta: key => this._closestMeta(creationContainer.schemaNode, key),\n\t\t\t\tcancelCreate: ()=>doCreate=false\n\t\t\t};\n\t\t\trepeatEntry.creating=false;\n\t\t\tcreationContainer.schemaNode.onCreate?.(payload);\n\t\t\tif (!doCreate) {\n\t\t\t\tthis._deleteCell(repeatEntry);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else {\n\t\t\tthis._deleteCell(repeatEntry);\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\t_closeActiveDetailsCell() {\n\t\tif (this._activeDetailsCell) {\n\t\t\tfor (let oldCellParent=this._activeDetailsCell; oldCellParent=oldCellParent.parent;) {\n\t\t\t\tif (oldCellParent.schemaNode.type===\"group\") {\n\t\t\t\t\tif (!this._closeGroup(oldCellParent))//close any open group above old cell\n\t\t\t\t\t\treturn false;\n\t\t\t\t\tthis._ignoreClicksUntil=Date.now()+500;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\toldCellParent.schemaNode.onBlur?.(oldCellParent,this._mainRowIndex);\n\t\t\t}\n\t\t\tthis._activeDetailsCell=null;//should be null when not inside details\n\t\t}\n\t\treturn true;\n\t}\n\n\n\t_selectMainTableCell(cell) {\n\t\tif (!cell)\t//in case of trying to move up from top row etc,\n\t\t\treturn;\n\t\tif (!this._exitEditMode(true))//try to exit-mode and commit any changes.\n\t\t\treturn false;//if exiting edit-mode was denied then do nothing more\n\t\t\t\n\t\t\n\t\tthis._mainColIndex=cell.cellIndex;\n\t\tconst mainRowIndex=parseInt(cell.parentElement.dataset.dataRowIndex);//save it here rather than setting it \n\t\t\t\t\t//directly because we do not want it to change if #selectCell returns false, preventing the select\n\t\t\t\t\t\n\t\tif (this._closeActiveDetailsCell()) {\n\t\t\tthis._selectCell(cell,this._colSchemaNodes[this._mainColIndex],this._data[mainRowIndex]);\n\t\t\tthis._mainRowIndex=mainRowIndex;\n\t\t}\n\t}\n\n\t_selectDetailsCell(instanceNode) {\n\t\tif (!this._exitEditMode(true))//try to exit-mode and commit any changes.\n\t\t\treturn false;//if exiting edit-mode was denied then do nothing more\n\n\t\tconst oldExpCell=this._activeDetailsCell;//need to know the current/old details-cell if any for closing groups\n\t\t\t\t\t//etc but we can't just use this._activeDetailsCell because #selectCell changes it and we do want\n\t\t\t\t\t//to call #selectCell first in order to know if changing cell is being prevented by validation()\n\n\t\tfor (var root=instanceNode; root.parent; root=root.parent);\n\t\tconst mainRowIndex=root.rowIndex;\n\t\tif (oldExpCell)//changing from an old detailsCell\n\t\t\tfor (let oldParnt=oldExpCell; oldParnt=oldParnt?.parent;)//traverse parents of old cell\n\t\t\t\tif(oldParnt.schemaNode.type===\"group\"||oldParnt.schemaNode.onBlur||oldParnt.creating){//found group/cell\n\t\t\t\t\t//...with onBlur or cell that is being created. For any of these we want to observe the cell being\n\t\t\t\t\t//left so that appropriate action can be taken\n\t\t\t\t\tfor (let newParent=instanceNode; newParent=newParent.parent;)//traverse parents of new cell\n\t\t\t\t\t\tif (newParent===oldParnt) {//if this new parent-group is also part of old parents\n\t\t\t\t\t\t\toldParnt=null;//break out of outer loop\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\tif (oldParnt) {\n\t\t\t\t\t\tif (oldParnt.schemaNode.type===\"group\"&&!this._closeGroup(oldParnt))\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\tif (oldParnt.schemaNode.onBlur)\n\t\t\t\t\t\t\toldParnt.schemaNode.onBlur?.(oldParnt,mainRowIndex);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\tthis._selectCell(instanceNode.selEl??instanceNode.el,instanceNode.schemaNode,instanceNode.dataObj,false);\n\t\tthis._mainRowIndex=mainRowIndex;\n\n\t\t//in case this was called via instanceNode.select() it might be necessary to make sure parent-groups are open\n\t\tfor (let parentCell=instanceNode; parentCell=parentCell.parent;)\n\t\t\tif (parentCell.schemaNode.type==\"group\")\n\t\t\t\tparentCell.el.classList.add(\"open\");\n\n\t\tthis._adjustCursorPosSize(instanceNode.selEl??instanceNode.el);\n\t\tthis._activeDetailsCell=instanceNode;\n\t\treturn instanceNode;\n\t}\n\n\t_selectCell(cellEl,schemaNode,dataObj,adjustCursorPosSize=true) {\n\t\tthis.rootEl.focus({preventScroll:true});\n\t\tif (adjustCursorPosSize)\n\t\t\tthis._adjustCursorPosSize(cellEl);\n\t\tthis._cellCursor.classList.toggle(\"details\",cellEl.closest(\".details\"));\n\t\tthis._cellCursor.classList.toggle(\"disabled\",cellEl.classList.contains(\"disabled\"));\n\t\t(this._scrollingContent??this.rootEl).appendChild(this._cellCursor);\n\t\tthis._selectedCell=cellEl;\n\t\tthis._activeSchemaNode=schemaNode;\n\t\t//make cellcursor click-through if it's on an expand-row-button-td, select-row-button-td or button\n\t\tconst noPtrEvent=schemaNode.type===\"expand\"||schemaNode.type===\"select\"||schemaNode.input?.type===\"button\";\n\t\tthis._cellCursor.style.pointerEvents=noPtrEvent?\"none\":\"auto\";\n\t\tthis._cellCursor.style.removeProperty(\"background-color\");//select-input sets it to transparent, revert here\n\t\tthis._cellCursorDataObj=dataObj;\n\t\tthis._selectedCellVal=dataObj?.[schemaNode.id];\n\t}\n\n\t_getElPos(el,container) {\n\t\tconst cellPos=el.getBoundingClientRect();\n\t\tif (!container)\n\t\t\tcontainer=this._tableSizer??this.rootEl;\n\t\tconst contPos=container.getBoundingClientRect();\n\t\treturn {x:cellPos.x-contPos.x, y:cellPos.y-contPos.y+(this._tableSizer?.offsetTop??0)}\n\t}\n\n\t_adjustCursorPosSize(el,onlyPos=false) {\n\t\tif (!el)\n\t\t\treturn;\n\t\tconst elPos=this._getElPos(el);\n\t\tthis._cellCursor.style.top=elPos.y+\"px\";\n\t\tthis._cellCursor.style.left=elPos.x+\"px\";\n\t\tthis._cellCursor.style.display=\"block\";//it starts at display none since #setupSpreadsheet, so make visible now\n\t\tif (!onlyPos) {\n\t\t\tthis._cellCursor.style.height=el.offsetHeight+\"px\";\n\t\t\tthis._cellCursor.style.width=el.offsetWidth+\"px\";\n\t\t}\n\t}\n\n\t_createTableHeader() {\n\t\tthis._headerTable=this.rootEl.appendChild(document.createElement(\"table\"));\n\t\tthis._headerTable.classList.add(\"header-table\");\n\t\tconst thead=this._headerTable.appendChild(document.createElement(\"thead\"));\n\t\tthis._headerTr=thead.insertRow();\n\t\tfor (let col of this._colSchemaNodes) {\n\t\t\tlet th=this._headerTr.appendChild(document.createElement(\"th\"));\n\t\t\tth.addEventListener(\"click\",e=>this._onThClick(e));\n\t\t\tif (col.type==\"select\") {\n\t\t\t\tth.appendChild(this._createCheckbox());\n\t\t\t\tth.classList.add(\"select-col\");\n\t\t\t} else if (col.type==\"expand\") {\n\t\t\t\tconst expandDiv=th.appendChild(document.createElement(\"div\"));\n\t\t\t\texpandDiv.classList.add(\"expand-div\");//used to identify if expand-button was clicked in click-handler\n\t\t\t\t//expandDiv.appendChild(this._createExpandContractButton());//functionality not fully implemented yet\n\t\t\t\tth.classList.add(\"expand-col\");\n\t\t\t} else\n\t\t\t\tth.innerText=col.title??\"\\xa0\";//non breaking space if nothing else or else\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//sorting arrows wont be positioned correctly\n\n\t\t\t//create the divs used for showing html for sorting-up/down-arrow or whatever has been configured\n\t\t\tcol.sortDiv=th.appendChild(document.createElement(\"DIV\"));\n\t\t\tcol.sortDiv.className=\"sortSymbol\";\n\t\t}\n\t\tthis._headerTr.appendChild(document.createElement(\"th\"));\n\t}\n\n\t_onThClick(e) {\n\t\tconst clickedIndex=e.currentTarget.cellIndex;\n\t\tif (this._colSchemaNodes[clickedIndex].type==\"select\"&&e.target.tagName.toLowerCase()==\"input\")\n\t\t\treturn this._toggleRowsSelected(e.target.checked,0,this._data.length-1);\n\t\tif (e.target.closest(\".expand-div\"))\n\t\t\treturn this._expandOrContractAll(!e.target.closest(\"tr\").classList.contains(\"expanded\"));\n\t\tlet sortingColIndex=-1,sortingCol;\n\t\twhile (sortingCol=this._sortingCols[++sortingColIndex]) {\n\t\t\tif (sortingCol.index===clickedIndex) {\n\t\t\t\tif (e.shiftKey&&this._sortingCols.length>1&&sortingCol.order==\"desc\") {\n\t\t\t\t\tthis._sortingCols.splice(sortingColIndex,1);\n\t\t\t\t\tsortingColIndex=0;//to not make condition below loop fall true\n\t\t\t\t} else\n\t\t\t\t\tsortingCol.order=sortingCol.order==\"asc\"?\"desc\":\"asc\";\n\t\t\t\tif (!e.shiftKey)\n\t\t\t\t\tthis._sortingCols=[sortingCol];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (sortingColIndex==this._sortingCols.length) {//if the clicked header wasn't sorted upon at all\n\t\t\tconst {id,type}=this._colSchemaNodes[clickedIndex];\n\t\t\tconst sortCol={id,type,order:\"asc\",index:clickedIndex};\n\t\t\tif (!e.shiftKey)\n\t\t\t\tthis._sortingCols=[];\n\t\t\tthis._sortingCols.push(sortCol);\n\t\t}\n\t\tthis._updateHeaderSortHtml();\n\t\te.preventDefault();//prevent text-selection when shift-clicking and double-clicking\n\t\tthis._sortData();\n\t\tthis._refreshTable();\n\t}\n\n\t_expandOrContractAll(expand) {\n\t\tthis._scrollBody.scrollTop=0;\n\t\tthis._scrollMethod();\n\t\tlet rows;\n\t\tif (expand) {\n\t\t\trows=this._tableSizer.querySelectorAll(\".main-table>tbody>tr:not(.details):not(.expanded)\");\n\t\t\tfor (const row of rows)\n\t\t\t\tthis._expandRow(row);\n\t\t\tfor (const dataRow of this._data) {\n\t\t\t\tconst index=this._rowsMeta.keys.indexOf(dataRow);\n\t\t\t\tif (index!=-1) {\n\t\t\t\t\tthis._rowsMeta.vals[index].h??=-1;\n\t\t\t\t} else {\n\t\t\t\t\tthis._rowsMeta.keys.push(dataRow);\n\t\t\t\t\tthis._rowsMeta.vals.push({h:-1});\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t\t\n\n\t\t//#expandRow(tr,dataRowIndex) {\n\t}\n\n\t_updateHeaderSortHtml() {\n\t\tfor (let [thIndex,th] of Object.entries(this._headerTr.cells)) {\n\t\t\tif (thIndex==this._headerTr.cells.length-1)\n\t\t\t\tbreak;\n\t\t\tlet order=null;\n\t\t\tlet sortDiv=this._colSchemaNodes[thIndex].sortDiv;\n\t\t\tfor (let sortingCol of this._sortingCols) {\n\t\t\t\tif (sortingCol.index==thIndex) {\n\t\t\t\t\torder=sortingCol.order;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!order||th.classList.contains(order==\"asc\"?\"desc\":\"asc\"))\n\t\t\t\tth.classList.remove(\"asc\",\"desc\");\n\t\t\tif (order) {\n\t\t\t\tth.classList.add(order);\n\t\t\t\tsortDiv.innerHTML=(order==\"asc\"?this._opts?.sortAscHtml:this._opts?.sortDescHtml)??\"\";\n\t\t\t} else\n\t\t\t\tsortDiv.innerHTML=this._opts?.sortNoneHtml??\"\";\n\t\t}\n\t}\n\n\t_sortData() {\n\t\tconst sortCols=this._sortingCols;\n\t\tif (!sortCols.length)\n\t\t\treturn false;\n\t\tthis._data.sort(compare.bind(this));\n\t\tif (this._mainRowIndex>=0)//if there is a selected row\n\t\t\tthis._mainRowIndex=this._data.indexOf(this._cellCursorDataObj);//then find it's new pos\n\t\treturn true;\n\t\t\n\t\tfunction compare(a,b) {\n\t\t\tfor (let sortCol of sortCols) {\n\t\t\t\tif (sortCol.type===\"expand\") {\n\t\t\t\t\tlet aV;\n\t\t\t\t\tif ((aV=!!this._rowMetaGet(this._data.indexOf(a))?.h)!=!!this._rowMetaGet(this._data.indexOf(b))?.h)\n\t\t\t\t\t\treturn (aV?-1:1)*(sortCol.order==\"asc\"?1:-1);\n\t\t\t\t} else if (sortCol.type===\"select\") {\n\t\t\t\t\tlet aSel;\n\t\t\t\t\tif ((aSel=this._selectedRows.indexOf(a)!=-1)!=(this._selectedRows.indexOf(b)!=-1))\n\t\t\t\t\t\treturn (aSel?-1:1)*(sortCol.order==\"asc\"?1:-1);\n\t\t\t\t} else if (a[sortCol.id]!=b[sortCol.id])\n\t\t\t\t\treturn (a[sortCol.id]>b[sortCol.id]?1:-1)*(sortCol.order==\"asc\"?1:-1);\n\t\t\t}\n\t\t}\n\t}\n\n\t_createTableBody() {\n\t\tthis._scrollBody=this.rootEl.appendChild(document.createElement(\"div\"));\n\n\t\tif (this._staticRowHeight&&!this._schema.details)\n\t\t\tthis._scrollMethod=this._onScrollStaticRowHeightNoDetails;\n\t\telse if (this._staticRowHeight&&this._schema.details)\n\t\t\tthis._scrollMethod=this._onScrollStaticRowHeightDetails;\n\t\tthis._scrollBody.addEventListener(\"scroll\",e=>this._scrollMethod(e),{passive:true});\n\t\tthis._scrollBody.className=\"scroll-body\";\n\t\t\n\t\tthis._scrollingContent=this._scrollBody.appendChild(document.createElement(\"div\"));\n\t\tthis._scrollingContent.className=\"scrolling-content\";\n\n\t\tthis._tableSizer=this._scrollingContent.appendChild(document.createElement(\"div\"));\n\t\tthis._tableSizer.style.position=\"relative\";\n\t\tthis._tableSizer.style.top=\"0px\";//need to have so that scrolling works properly when reading parseInt of it\n\t\tthis._tableSizer.className=\"table-sizer\";\n\n\t\tthis._mainTable=this._tableSizer.appendChild(document.createElement(\"table\"));\n\t\tthis._mainTable.className=\"main-table\";\n\t\tthis._mainTbody=this._mainTable.appendChild(document.createElement(\"tbody\"));\n\t\tfor (let i = 0; i < this._colSchemaNodes.length; i++) {\n\t\t\tlet col=document.createElement(\"col\");\n\t\t\tthis._cols.push(col);\n\t\t\tthis._mainTable.appendChild(document.createElement(\"colgroup\")).appendChild(col);\n\t\t}\n\t\tthis._borderSpacingY=parseInt(window.getComputedStyle(this._mainTable)['border-spacing'].split(\" \")[1]);\n\t}\n\n\t_createBulkEditArea(schema) {\n\t\tthis._bulkEditArea=this.rootEl.appendChild(document.createElement(\"div\"));\n\t\tthis._bulkEditArea.classList.add(\"bulk-edit-area\");\n\t\tthis._bulkEditArea.addEventListener(\"transitionend\",()=>{\n\t\t\tdelete this._animations[\"adjustViewportHeight\"];\n\t\t\tif (this._bulkEditArea.style.height!=\"0px\")\n\t\t\tthis._bulkEditArea.style.overflow=\"visible\";//have to shift between hidden/visible because hidden is needed\n\t\t\t\t\t\t\t\t\t//for animation but visible is needed for dropdowns to be able to go outside of area\n\t\t});\n\n\t\t//extra div needed for having padding while also being able to animate height all the way to 0\n\t\tconst bulkContent=this._bulkEditArea.appendChild(document.createElement(\"div\"));\n\n\t\tconst numberOfRowsSelectedDiv=bulkContent.appendChild(document.createElement(\"div\"));\n\t\tnumberOfRowsSelectedDiv.innerText=\"Number of selected rows: \";\n\t\tthis._numberOfRowsSelectedSpan=numberOfRowsSelectedDiv.appendChild(document.createElement(\"span\"));\n\n\t\tconst pagesDiv=bulkContent.appendChild(document.createElement(\"div\"));//for having multiple pages\n\t\tpagesDiv.classList.add(\"pages\");\t\t\t\t\t\t\t\t\t\t//which is needed if having groups in it\n\t\t\n\t\tconst mainPage=pagesDiv.appendChild(document.createElement(\"div\"));\n\t\tconst tableContainer=mainPage.appendChild(document.createElement(\"div\"));\n\t\tmainPage.classList.add(\"main\");\n\t\tmainPage.style.display=\"block\";\n\n\t\tconst bulkEditFields=this._buildBulkEditSchemaNodes(schema.details);\n\t\tfor (const column of schema.main.columns)\n\t\t\tbulkEditFields.push(...this._buildBulkEditSchemaNodes(column));\n\n\t\t//Build schema for bulk-edit-area based on the real schema\n\t\tconst bulkSchema={details:{type:\"lineup\",entries:bulkEditFields}};//WRAP\n\n\t\tthis._bulkEditTable=new TablanceBulk(tableContainer,bulkSchema,null,true,null);\n\t\tthis._bulkEditTable.mainInstance=this;\n\t\tthis._bulkEditTable._dropdownAlignmentContainer=this._bulkEditArea;\n\t\tthis._bulkEditTable.addData([{}]);\n\n\t\tthis._bulkEditAreaHeightPx=this._bulkEditArea.firstChild.offsetHeight;\n\t\tthis._bulkEditArea.style.height=0;//start at height 0 before expanded. but do this after having measured above\n\t}\n\n\t_isObject(val) {\n\t\treturn val&&typeof val===\"object\"&&!Array.isArray(val);\n\t}\n\n\t/**Given a schemaNode like details or column, will add inputs to this._bulkEditSchemaNodes which later is iterated\n\t * and the contents added to the bulk-edit-area. \n\t * @param {*} schema Should be details or column when called from outside, but it calls itself recursively\n\t * \t\t\t\t\t\twhen hitting upon containers which then are passed to this param\n\t * @returns */\n\t_buildBulkEditSchemaNodes(schema) {\n\t\tconst result=[];\n\t\tif ((!schema.type||schema.type==\"field\")&&schema.bulkEdit) {\n\t\t\t//schema-nodes of main-columns don't need to specify this, but it's needed in details\n\t\t\tresult.push(Object.assign(Object.create(null), schema, {type:\"field\"}));\n\t\t} else if ((schema.entries?.length&&schema.bulkEdit)||schema===this._schema.details) {\n\t\t\tfor (const schemaNode of schema.entries)\n\t\t\t\tresult.push(...this._buildBulkEditSchemaNodes(schemaNode));//TODO this has to be fixed to deal with wrapped...\n\t\t}\n\t\treturn result;\n\t}\n\n\t/**Updates the displayed values in the bulk-edit-area */\n\t_updateBulkEditAreaCells(schemaNodesToUpdateCellsFor=this._bulkEditTable._schema.details.entries) {\n\t\tconst mixedText=\"(Mixed)\";\n\t\tfor (let multiCellI=-1, multiCellSchemaNode; multiCellSchemaNode=schemaNodesToUpdateCellsFor[++multiCellI];) {\n\n\t\t\t//work out if there are mixed values for this cell among the selected rows, or if all are same\n\t\t\tlet mixed=false;\n\t\t\tlet val,lastVal;\n\t\t\tfor (let rowI=-1,row; row=this._selectedRows[++rowI];) {\n\t\t\t\tval=row[multiCellSchemaNode.id];\n\t\t\t\tif (rowI&&val!=lastVal) {\n\t\t\t\t\tmixed=true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tlastVal=val;\n\t\t\t}\n\n\n\t\t\t//update both the data and the dom\n\t\t\tthis._bulkEditTable.updateData(0,multiCellSchemaNode.id,mixed?mixedText:val?.text??val??\"\");\n\t\t\tconst el=this._bulkEditTable._openDetailsPanes[0].children[multiCellI].el;\n\t\t\tel.innerText=mixed?mixedText:val?.text??val??\"\";\n\t\t\tthis._bulkEditTable._data[0][multiCellSchemaNode.id]=mixed?\"\":val;\n\t\t}\n\t}\n\n\t_updateSizesOfViewportAndCols() {\n\t\tif (this.hostEl.offsetHeight != this._containerHeight) {\n\t\t\tthis._updateViewportHeight();\n\t\t\tif (this.hostEl.offsetHeight > this._containerHeight)\n\t\t\t\tthis._maybeAddTrs();\n\t\t\telse\n\t\t\t\tthis._maybeRemoveTrs();\n\t\t\tthis._containerHeight = this.hostEl.offsetHeight;\n\t\t}\n\t\tthis._updateColsWidths();\n\t\tthis._headerTable.style.width = this._scrollBody.offsetWidth + \"px\";\n\t\tthis._adjustCursorPosSize(this._selectedCell);\n\t}\n\n\t_updateColsWidths() {\n\t\tif (this.rootEl.offsetWidth>this._containerWidth) {\n\t\t\tlet areaWidth=this._tableSizer.offsetWidth;\n\t\t\tconst percentageWidthRegex=/\\d+%/;\n\t\t\tlet totalFixedWidth=0;\n\t\t\tlet numUndefinedWidths=0;\n\t\t\tfor (let col of this._colSchemaNodes)\n\t\t\t\tif (!col.width)\n\t\t\t\t\tnumUndefinedWidths++;\n\t\t\t\telse if (!percentageWidthRegex.test(col))//if fixed width\n\t\t\t\t\ttotalFixedWidth+=(col.pxWidth=parseInt(col.width));\n\t\t\tlet sumFixedAndFlexibleWidth=totalFixedWidth;\n\t\t\tfor (let col of this._colSchemaNodes)\n\t\t\t\tif (col.width&&percentageWidthRegex.test(col))//if flexible width\n\t\t\t\t\tsumFixedAndFlexibleWidth+=(col.pxWidth=(areaWidth-totalFixedWidth)*parseFloat(col.width)/100);\n\t\t\tfor (let col of this._colSchemaNodes)\n\t\t\t\tif (!col.width)//if undefined width\n\t\t\t\t\tcol.pxWidth=(areaWidth-sumFixedAndFlexibleWidth)/numUndefinedWidths;\n\t\t\tfor (var colI=0; colI<this._colSchemaNodes.length; colI++) \n\t\t\t\tthis._cols[colI].style.width=this._headerTr.cells[colI].style.width\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t=this._colSchemaNodes[colI].pxWidth+\"px\";\n\t\t\t//last col is empty col with the width of table-scrollbar if its present in order to make the header span\n\t\t\t//the whole with while not actually using that last bit in the calculations for the normal cols\n\t\t\tthis._headerTr.cells[colI].style.width=this._scrollBody.offsetWidth-areaWidth+\"px\";\n\t\t}\n\t}\n\n\t_filterData(filterString) {\n\t\tthis._openDetailsPanes={};\n\t\tthis._rowsMeta={keys:[],vals:[]};\n\t\tfor (const tr of this._mainTbody.querySelectorAll(\"tr.details\"))\n\t\t \ttr.remove();\n\t\tthis._filter=filterString;\n\t\tconst colsToFilterBy=[];\n\t\tconst selectsOptsByVal={};//for each col that is of the select type, a entry will be placed in this with the\n\t\t\t//col-index as key and an object as val. the object holds all the options but they are keyed by teir value\n\t\t\t//rather than being in an indexed array.This is to simplify and likely improve speed of filtering by the col\n\n\t\tfor (let col of this._colSchemaNodes)\n\t\t\tif (col.type!==\"expand\"&&col.type!==\"select\") {\n\t\t\t\tif (col.input?.type==\"select\") {\n\t\t\t\t\tconst optsByVal=selectsOptsByVal[colsToFilterBy.length]={};\n\t\t\t\t\tfor (const opt of col.input.options)\n\t\t\t\t\t\toptsByVal[opt.value]=opt;\n\t\t\t\t}\n\t\t\t\tcolsToFilterBy.push(col);\n\t\t\t}\n\t\tif (filterString) {\n\t\t\tthis._data=[];\n\t\t\tfor (let dataRow of this._allData)\n\t\t\t\tfor (let colI=-1,col; col=colsToFilterBy[++colI];) {\n\t\t\t\t\tif (dataRow[col.id]!=null) {\n\t\t\t\t\t\tlet match=false;\n\t\t\t\t\t\tif (col.input?.type==\"select\") {\n\t\t\t\t\t\t\tif (typeof dataRow[col.id]==\"string\")\n\t\t\t\t\t\t\t\tmatch=selectsOptsByVal[dataRow[col.id]].text.includes(filterString);\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\tmatch=dataRow[col.id].text.includes(filterString);\n\t\t\t\t\t\t} else\n\t\t\t\t\t\t\tmatch=dataRow[col.id].includes(filterString);\n\t\t\t\t\t\tif (match) {\n\t\t\t\t\t\t\tthis._data.push(dataRow);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t} else\n\t\t\tthis._data=this._allData;\n\t\tthis._scrollRowIndex=0;\n\t\tthis._refreshTable();\n\t\tthis._refreshTableSizerNoDetails();\n\t}\n\n\t_setDataForOnlyDetails(data) {\n\t\tthis._allData=this._data=[data[data.length-1]];\n\t\tthis.rootEl.innerHTML=\"\";\n\t\tconst detailsDiv=this.rootEl.appendChild(document.createElement(\"div\"));\n\t\tdetailsDiv.classList.add(\"details\");\n\t\tthis._generateDetailsContent(this._schema.details,0,this._openDetailsPanes[0]=this._createInstanceNode(),detailsDiv,[],this._data[0]);\n\t}\n\n\t/**Refreshes the table-rows. Should be used after sorting or filtering or such.*/\n\t_refreshTable() {\n\t\t//In order to render everything correctly and know which rows should be rendered in the view we need to go from\n\t\t//top to bottom because the number of expanded rows above the view might have changed. So go to \n\t\t//#scrollRowIndex 0 to start at top row, also set #scrollY to 0 so the scrollMethod compares the current\n\t\t//scrollTop with 0.\n\t\tthis._scrollRowIndex=this._scrollY=0;\n\n\t\tthis._lastCheckedIndex=null;\n\n\t\t//adjust the sizer to what its top and height would be when scrolled all the way up.\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)+parseInt(this._tableSizer.style.top)+\"px\";\n\t\tthis._tableSizer.style.top=this._numRenderedRows=0;\n\n\t\t//its position and size needs to be udated.Hide for now and let #updateRowValues or #renderDetails add it back\n\t\tthis._cellCursor.style.display=\"none\";\n\n\t\tthis._mainTbody.replaceChildren();//remove all the tr-elements\n\t\tthis._maybeAddTrs();//add them again and with their correct data, at least based on them being the top rows \n\t\tthis._scrollMethod();//now scroll back to the real scroll-position\n\t}\n\n\t/**This onScroll-handler is used when rows are of static height and can't be expanded either.\n\t * It is the fastest scroll-method since row-heights are known and it is easy to calculate which rows should be\n\t * rendered even when scrolling more than a whole page at once as each row won't have to be iterated, and rows\n\t * will only have to be created or deleted if the table is resized so the same tr-elements are reused.* \n\t * @returns */\n\t_onScrollStaticRowHeightNoDetails() {\n\t\tconst scrY=Math.max(this._scrollBody.scrollTop-this._scrollMarginPx,0);\n\t\tconst newScrollRowIndex=Math.min(parseInt(scrY/this._rowHeight),this._data.length-this._mainTbody.rows.length);\n\t\t\n\t\tif (newScrollRowIndex==this._scrollRowIndex)\n\t\t\treturn;\n\t\tif(Math.abs(newScrollRowIndex-this._scrollRowIndex)>this._mainTbody.rows.length){//if scrolling by whole page(s)\n\t\t\tthis._scrollRowIndex=parseInt(scrY/this._rowHeight);\n\t\t\tthis._refreshTable();\n\t\t} else {\n\t\t\tconst scrollSignum=Math.sign(newScrollRowIndex-this._scrollRowIndex);//1 if moving down, -1 if up\n\t\t\tdo {\n\t\t\t\tthis._scrollRowIndex+=scrollSignum;\n\t\t\t\tif (scrollSignum==1) {//moving down\t\t\t\t\t\t\t\t\t\t\t\tmove top row to bottom\n\t\t\t\t\tconst dataIndex=this._scrollRowIndex+this._numRenderedRows-1;\n\t\t\t\t\tthis._updateRowValues(this._mainTbody.appendChild(this._mainTbody.firstChild),dataIndex);\n\t\t\t\t} else {//moving up\n\t\t\t\t\tlet trToMove=this._mainTbody.lastChild;\t\t\t\t\t\t\t\t\t//move bottom row to top\n\t\t\t\t\tthis._mainTbody.prepend(trToMove);\n\t\t\t\t\tthis._updateRowValues(trToMove,this._scrollRowIndex);\n\t\t\t\t}\n\t\t\t} while (this._scrollRowIndex!=newScrollRowIndex);\n\t\t}\n\t\tthis._refreshTableSizerNoDetails();\n\t}\n\n\t_onScrollStaticRowHeightDetails(_e) {\n\t\tconst newScrY=Math.max(this._scrollBody.scrollTop-this._scrollMarginPx,0);\n\t\tif (newScrY>parseInt(this._scrollY)) {//if scrolling down\n\t\t\twhile (newScrY-parseInt(this._tableSizer.style.top)\n\t\t\t>(this._rowMetaGet(this._scrollRowIndex)?.h??this._rowHeight)) {//if a whole top row is outside\n\t\t\t\tif (this._scrollRowIndex+this._numRenderedRows>this._data.length-1)\n\t\t\t\t\tbreak;\n\t\t\t\tlet topShift;//height of the row that is at the top before scroll and which will be removed which is the\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// amount of pixels the whole table is shiftet by\n\t\t\t\t//check if the top row (the one that is to be moved to the bottom) is expanded\n\t\t\t\tif (topShift=this._rowMetaGet(this._scrollRowIndex)?.h) {\n\t\t\t\t\tdelete this._openDetailsPanes[this._scrollRowIndex];\n\t\t\t\t\tthis._mainTbody.rows[1].remove();\n\t\t\t\t} else\n\t\t\t\t\ttopShift=this._rowHeight;\n\t\t\t\tconst dataIndex=this._numRenderedRows+this._scrollRowIndex;//the data-index of the new row\n\n\t\t\t\t//move the top row to bottom and update its values\n\t\t\t\tconst trToMove=this._updateRowValues(this._mainTbody.appendChild(this._mainTbody.firstChild),dataIndex);\n\n\t\t\t\t//move the table down by the height of the removed row to compensate,else the whole table would shift up\n\n\t\t\t\tthis._doRowScrollDetails(trToMove,dataIndex,this._scrollRowIndex,-topShift);\n\t\t\t\tthis._scrollRowIndex++;\n\t\t\t}\n\t\t} else if (newScrY<parseInt(this._scrollY)) {//if scrolling up\n\t\t\twhile (newScrY<parseInt(this._tableSizer.style.top)) {//while top row is below top of viewport\n\t\t\t\tthis._scrollRowIndex--;\n\n\t\t\t\t//check if the bottom row (the one that is to be moved to the top) is expanded\n\t\t\t\tif (this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows)?.h) {\n\t\t\t\t\tdelete this._openDetailsPanes[this._scrollRowIndex+this._numRenderedRows];\n\t\t\t\t\tthis._mainTbody.lastChild.remove();//remove the details-tr\n\t\t\t\t}\n\n\t\t\t\tlet trToMove=this._mainTbody.lastChild;\t\t\t\t\t\t\t\t\t//move bottom row to top\n\t\t\t\tthis._mainTbody.prepend(trToMove);\n\t\t\t\tthis._updateRowValues(trToMove,this._scrollRowIndex);//the data of the new row;\n\n\t\t\t\t//height of the row that is added at the top which is amount of pixels the whole table is shiftet by\n\t\t\t\tconst topShift=this._rowMetaGet(this._scrollRowIndex)?.h??this._rowHeight;\n\n\t\t\t\tthis._doRowScrollDetails(trToMove,this._scrollRowIndex,this._scrollRowIndex+this._numRenderedRows,topShift);\n\t\t\t}\n\t\t}\n\t\tthis._scrollY=newScrY;\n\t}\n\n\t/**Used by #onScrollStaticRowHeightDetails whenever a row is actually added/removed(or rather moved)*/\n\t_doRowScrollDetails(trToMove,newMainIndex,oldMainIndex,topShift) {\n\t\tconst detailsHeight=this._rowMetaGet(newMainIndex)?.h;\n\t\tif (detailsHeight>0) {\n\t\t\tthis._renderDetails(trToMove,newMainIndex);\n\t\t} else if (detailsHeight==-1) {\n\t\t\tthis._scrollBody.scrollTop+=this._expandRow(trToMove,false);\n\t\t} else\n\t\t\ttrToMove.classList.remove(\"expanded\");\n\t\t\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)+topShift+\"px\";\n\t\tthis._tableSizer.style.top=parseInt(this._tableSizer.style.top)-topShift+\"px\";\n\n\t\tif (oldMainIndex===this._mainRowIndex) {//cell-cursor is on moved row\n\t\t\tthis._selectedCell=null;\n\t\t\tfor (let cell=this._activeDetailsCell; cell&&(cell=cell.parent);)\n\t\t\t\tif (cell.creating) {\n\t\t\t\t\tcell.creating=false;//otherwise cell.select() below will not work\n\t\t\t\t\tthis._exitEditMode(false);//in case field is validated. Could prevent cell.select() too otherwise\n\t\t\t\t\tcell.parent.dataObj.splice(cell.parent.dataObj.indexOf(cell.dataObj),1);\n\t\t\t\t\twhile (cell&&(cell=cell.parent))\n\t\t\t\t\t\tif (cell.select) {\n\t\t\t\t\t\t\tcell.select();\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n\n\t\tthis._lookForActiveCellInRow(trToMove);//look for active cell (cellcursor) in the row. This is needed\n\t\t//in order to reassign the dom-element and such and also adjust the pos of the cellcursor in case\n\t\t//the pos of the cell is not the same due to sorting/filtering\n\t}\n\t\n\n\t/**This should be called on each row that is being scrolled into view that might hold the active cell in order\n\t * to set #selectedCell to the correct element\n\t * @param {HTMLTableRowElement} tr */\n\t_lookForActiveCellInRow(tr) {\n\t\tif (tr.dataset.dataRowIndex==this._mainRowIndex) {\n\t\t\tif (!this._activeDetailsCell)\n\t\t\t\tthis._selectedCell=tr.cells[this._mainColIndex];\n\t\t\telse {//if inside details\n\t\t\t\t//generate the path to the instanceNode in #activeDetailsCell by stepping through its parents to root\n\t\t\t\tlet path=[];\n\t\t\t\tfor (let instanceNode=this._activeDetailsCell; instanceNode.parent; instanceNode=instanceNode.parent)\n\t\t\t\t\tpath.unshift(instanceNode.index);\n\t\t\t\t//now follow the same path in the new #openDetailsNavMap[rowIndex], eg the instanceNodes..\n\t\t\t\tlet instanceNode=this._openDetailsPanes[this._mainRowIndex];\n\t\t\t\tfor (let step of path)\n\t\t\t\t\tinstanceNode=instanceNode.children[step];\n\t\t\t\tthis._selectedCell=instanceNode.el;\n\t\t\t\tthis._activeDetailsCell=instanceNode;//should be identical but this allows for the old one to be gc'd\n\t\t\t}\n\t\t\tthis._adjustCursorPosSize(this._selectedCell);\n\t\t}\n\t}\n\n\t_refreshTableSizerNoDetails() {\t\n\t\tthis._tableSizer.style.top=this._scrollRowIndex*this._rowHeight+\"px\";\n\t\tthis._tableSizer.style.height=(this._data.length-this._scrollRowIndex)*this._rowHeight+\"px\";\n\t}\n\n\t_createExpandContractButton() {\n\t\tconst a=document.createElement(\"a\");\n\t\ta.appendChild(document.createElement(\"span\"));\n\t\treturn a;\n\t}\n\n\t_createCheckbox(preventClickSelect) {\n\t\tconst checkbox=document.createElement(\"input\");\n\t\tcheckbox.type=\"checkbox\";\n\t\tcheckbox.tabIndex=\"-1\";\n\n\t\tif (preventClickSelect)//prevent checking and leave to #toggleRowSelected for consistant behavior when \n\t\t\tcheckbox.addEventListener(\"click\",this._preventDefault);//clicking checkbox vs clicking its cell\n\n\t\t//prevent gaining focus when clicking it. Otherwise it does gain focus despite tabIndex -1\n\t\tcheckbox.addEventListener(\"mousedown\",this._preventDefault);\n\n\t\treturn checkbox;\n\t}\n\n\t/**Should be called if tr-elements might need to be created which is when data is added or if table grows*/\n\t_maybeAddTrs() {\n\t\tlet lastTr=this._mainTbody.lastChild;\n\t\tconst scrH=this._scrollBody.offsetHeight+this._scrollMarginPx*2;\n\t\tconst dataLen=this._data.length;\n\t\t//if there are fewer trs than datarows, and if there is empty space below bottom tr\n\t\twhile ((this._numRenderedRows-1)*this._rowHeight<scrH&&this._scrollRowIndex+this._numRenderedRows<dataLen) {\n\t\t\tlastTr=this._mainTable.insertRow();\n\t\t\tthis._numRenderedRows++;\n\t\t\tfor (let i=0; i<this._colSchemaNodes.length; i++) {\n\t\t\t\tconst cell=lastTr.insertCell();\n\t\t\t\tconst div=cell.appendChild(document.createElement(\"div\"));//used to set height of cells\n\t\t\t\tdiv.style.height=this._rowInnerHeight||\"auto\";\t\t\t\t\n\t\t\t\tif (this._colSchemaNodes[i].type===\"expand\") {\n\t\t\t\t\tdiv.appendChild(this._createExpandContractButton());\n\t\t\t\t\tcell.classList.add(\"expand-col\");\n\t\t\t\t} else if (this._colSchemaNodes[i].type===\"select\") {\n\t\t\t\t\tdiv.appendChild(this._createCheckbox(true));\n\t\t\t\t\tcell.classList.add(\"select-col\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._updateRowValues(lastTr,this._scrollRowIndex+this._numRenderedRows-1);\n\t\t\tif (this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows-1)?.h)\n\t\t\t\tthis._renderDetails(lastTr,this._scrollRowIndex+this._numRenderedRows-1);\n\t\t\tthis._lookForActiveCellInRow(lastTr);//look for active cell (cellcursor) in the row\n\t\t\tif (!this._rowHeight) {//if there were no rows prior to this\n\t\t\t\tthis._rowHeight=lastTr.offsetHeight+this._borderSpacingY;\n\t\t\t\tconst tdComputedStyle=window.getComputedStyle(lastTr.firstChild);\n\t\t\t\tfor (let prop of [\"paddingTop\",\"paddingBottom\",\"borderBottomWidth\",\"borderTopWidth\"])\n\t\t\t\t\tthis._rowInnerHeight-=parseInt(tdComputedStyle[prop]);\n\t\t\t\tthis._rowInnerHeight=this._rowInnerHeight+lastTr.offsetHeight+\"px\";\n\t\t\t}\n\t\t}\n\t}\n\n\t_preventDefault(e){\n\t\te.preventDefault();\n\t}\n\n\t/**Should be called if tr-elements might need to be removed which is when table shrinks*/\n\t_maybeRemoveTrs() {\n\t\tconst scrH=this._scrollBody.offsetHeight+this._scrollMarginPx*2;\n\t\twhile ((this._numRenderedRows-2)*this._rowHeight>scrH) {\n\t\t\tif (this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows-1)?.h) {\n\t\t\t\tthis._mainTbody.lastChild.remove();\n\t\t\t\tdelete this._openDetailsPanes[this._scrollRowIndex+this._numRenderedRows];\n\t\t\t}\n\t\t\tthis._mainTbody.lastChild.remove();\n\t\t\tthis._numRenderedRows--;\n\t\t}\n\t}\n\n\t/**Update the values of a row in the table. The tr needs to be passed in as well as the index of the data in #data\n\t * The row needs to already have the right amount of td's.\n\t * @param {HTMLTableRowElement} tr The tr-element whose cells that should be updated*/\n\t_updateRowValues(tr,mainIndex) {\n\t\ttr.dataset.dataRowIndex=mainIndex;\n\t\tconst selected=this._selectedRows.indexOf(this._data[mainIndex])!=-1;\n\t\ttr.classList.toggle(\"selected\",!!selected);\n\t\tfor (let colI=0; colI<this._colSchemaNodes.length; colI++) {\n\t\t\tlet td=tr.cells[colI];\n\t\t\tlet colSchemaNode=this._colSchemaNodes[colI];\n\t\t\tif (colSchemaNode.type!=\"expand\"&&colSchemaNode.type!=\"select\")\n\t\t\t\tthis._updateMainRowCell(td,colSchemaNode);\n\t\t\telse if (colSchemaNode.type==\"select\")\n\t\t\t\ttd.querySelector(\"input\").checked=selected;\n\t\t}\n\t\tif (this._highlightRowsOnView[mainIndex]) {\n\t\t\tdelete this._highlightRowsOnView[mainIndex];\n\t\t\tthis._highlightRowIndex(mainIndex);\n\t\t}\n\t\treturn tr;\n\t}\n\n\t/**\n\t * Format bytes as human-readable text.\n\t * \n\t * @param bytes Number of bytes.\n\t * @param si True to use metric (SI) units, aka powers of 1000. False to use \n\t *           binary (IEC), aka powers of 1024.\n\t * @param dp Number of decimal places to display.\n\t * \n\t * @return Formatted string.\n\t */\n\t_humanFileSize(bytes, si=false, dp=1) {\n\t\tconst thresh = si ? 1000 : 1024;\n\t\n\t\tif (Math.abs(bytes) < thresh) {\n\t\treturn bytes + ' B';\n\t\t}\n\t\n\t\tconst units = si \n\t\t? ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'] \n\t\t: ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];\n\t\tlet u = -1;\n\t\tconst r = 10**dp;\n\t\n\t\tdo {\n\t\tbytes /= thresh;\n\t\t++u;\n\t\t} while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);\n\t\n\t\n\t\treturn bytes.toFixed(dp) + ' ' + units[u];\n\t}\n\n\t_generateFileCell(fileInstanceNode,cellEl,rowData,dataIndex) {\n\t\t//schemaNode of instanceNode will get overwritten. Save reference here.\n\t\tconst fileSchemaNode=fileInstanceNode.schemaNode;\n\n\t\t//saving this ref here which is used to revert with if user deletes file\n\t\tfileInstanceNode.fileInputSchemaNode=fileSchemaNode;\n\n\t\t//define all the file-meta-props\n\t\tconst lang=this._opts.lang??{};\n\t\tlet metaEntries=[{type:\"field\",title:lang.fileName??\"Filename\",id:\"name\"},\n\t\t\t{type:\"field\",title:lang.fileLastModified??\"Last Modified\",id:\"lastModified\",render:date=>\n\t\t\tnew Date(date).toISOString().slice(0, 16).replace('T', ' ')},\n\t\t\t{type:\"field\",title:lang.fileSize??\"Size\",id:\"size\",render:size=>this._humanFileSize(size)},\n\t\t\t{type:\"field\",title:lang.fileType??\"Type\",id:\"type\"}];\n\t\tfor (let metaI=-1,metaName; metaName=[\"filename\",\"lastModified\",\"size\",\"type\"][++metaI];)\n\t\t\tif(!(fileSchemaNode.input.fileMetasToShow?.[metaName]??this._opts.defaultFileMetasToShow?.[metaName]??true))\n\t\t\t\tmetaEntries.splice(metaI,1);//potentially remove (some of) them\n\t\t//define the group-structure for the file\n\t\t\n\t\tconst fileGroup=this._schemaCopyWithDeleteButton({type:\"group\",entries:[]},this._fileOnDelete);\n\t\tfileGroup.entries[0].entries.unshift({type:\"field\",input:{type:\"button\",btnText:\"Open\"\n\t\t\t\t,clickHandler:(e,file,mainIndex,schemaNode,btnObj)=>{\n\t\t\t\t\trowData??=this._data[mainIndex];\n\t\t\t\t\tfileSchemaNode.input.openHandler?.(e,file,fileSchemaNode,fileInstanceNode.dataObj,mainIndex,btnObj);\n\t\t\t}},\n\t\t});\n\t\tfileGroup.entries.push({type:\"lineup\",entries:metaEntries});\n\t\tconst wrappedFileGroup=this._buildSchemaFacade(fileGroup);//WRAPPED\n\t\t\n\t\tconst fileData=rowData[fileInstanceNode.schemaNode.id];\n\t\t//call _buildSchemaTreeFacade on fileGroup here?\n\t\tthis._generateDetailsContent(wrappedFileGroup,dataIndex,fileInstanceNode,cellEl,fileInstanceNode.path,fileData);\n\t\tconst fileMeta=this._mapGet(this._filesMeta,fileData);\n\t\tif (fileMeta!=null) {\n\t\t\tconst progressbarOuter=cellEl.appendChild(document.createElement(\"div\"));\n\t\t\tprogressbarOuter.classList.add(\"progressbar\",\"active\");\n\t\t\tconst progressbarInner=progressbarOuter.appendChild(document.createElement(\"div\"));\n\t\t\tprogressbarInner.style.transition=\"none\";//get to the current pos immediately in case running from before\n\t\t\tfileMeta.bars.push(progressbarInner);\n\t\t\tprogressbarInner.role=\"progressbar\";\n\t\t\tconst progressSpan=progressbarInner.appendChild(document.createElement(\"span\"));\n\t\t\tprogressbarInner.style.width=progressSpan.innerText=parseInt(fileMeta.uploadedBytes/fileData.size*100)+\"%\";\n\t\t\tprogressbarInner.style.removeProperty(\"transition\");//enable transitioning again, it was disabled above\n\t\t}\n\t}\n\n\n\t/**Updates the html-element of a cell inside an details. Also updates nonEmptyDescentants of the instanceNode of \n\t * \tgroup-rows as well as toggling the empty-class of them. Reports back whether visibility has been changed.\n\t * @param {*} instanceNode */\n\t_updateDetailsCell(instanceNode,rowData=null) {\n\t\tlet cellEl=instanceNode.el;\n\t\tif (instanceNode.schemaNode.maxHeight) {//if there's a maxHeight stated, which is used for textareas\n\t\t\tcellEl.innerHTML=\"\";//empty the cell, otherwise multiple calls to this would add more and more content to it\n\t\t\tcellEl=cellEl.appendChild(document.createElement(\"div\"));//then put a div inside and change cellEl to that\n\t\t\tcellEl.style.maxHeight=instanceNode.schemaNode.maxHeight;//then set its maxHeight\n\t\t\tcellEl.style.overflow=\"auto\";//and male it scrollable\n\t\t\t//can't make td directly scrollable which is why the div is needed\n\t\t}\n\t\tfor (var rootCell=instanceNode;rootCell.parent;rootCell=rootCell.parent);\n\t\tconst oldCellContent=cellEl.innerText;\n\t\tif (instanceNode.schemaNode.input?.type==\"file\"&&rowData[instanceNode.schemaNode.id]) {\n\t\t\tthis._generateFileCell(instanceNode,cellEl,rowData,rootCell.rowIndex);\n\t\t} else {\n\t\t\tif (instanceNode.schemaNode.visibleIf)\n\t\t\t\tthis._applyVisibleIf(instanceNode);\n\t\t\tthis._updateCell(instanceNode.schemaNode,cellEl,instanceNode.selEl,rowData,rootCell.rowIndex,instanceNode);\n\t\t\tif (instanceNode.schemaNode.input?.type!==\"button\") {\n\t\t\t\tconst newCellContent=cellEl.innerText;\n\t\t\t\tif (!newCellContent!=!oldCellContent) {\n\t\t\t\t\tfor (let cellI=instanceNode; cellI; cellI=cellI.parent)\n\t\t\t\t\t\tif (cellI.nonEmptyDescentants!=null)\n\t\t\t\t\t\t\tcellI.grpTr.classList.toggle(\"empty\",!(cellI.nonEmptyDescentants+=newCellContent?1:-1));\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t} else\n\t\t\t\tinstanceNode.el=instanceNode.selEl=instanceNode.el.querySelector(\"button\");\n\t\t}\n\t}\n\n\t_getValueByPath(obj, path) {\n\t\tlet cur = obj;\n\t\tfor (const key of path) {\n\t\t\tif (cur == null)\n\t\t\t\treturn undefined;\n\t\t\tcur = cur[key];\n\t\t}\n\t\treturn cur;\n\t}\n\n\t_resolveCellPaths(baseCell, path) {\n\t\tlet target = baseCell;\n\n\t\t// Step 1: go up for each \"..\"\n\t\tfor (var i=0; i < path.length && path[i] === \"..\"; i++) {\n\t\t\tif (!target?.parent)\n\t\t\t\treturn null;\n\t\t\ttarget = target.parent;\n\t\t}\n\n\t\t// Step 2: go down via the remaining indices\n\t\tfor (; i < path.length; i++) {\n\t\t\ttarget = target?.children?.[path[i]];\n\t\t\tif (!target)\n\t\t\t\treturn null;\n\t\t}\n\t\treturn target;\n\t}\n\n\t/**\n\t * Gets the value of a cell, pointed to by its ID, or if it depends on another cell, gets that value. The value\n\t * is the raw data from the data-object, not rendered.\n\t * @param {*} schemaNode \n\t * @param {*} rowData \n\t * @param {*} instanceNode \n\t * @returns \n\t */\n\t_getTargetVal(idOverDependee,schemaNode, instanceNode, rowData=instanceNode.dataObj) {\n\t\tif (idOverDependee&&schemaNode.id)\n\t\t\treturn rowData[schemaNode.id];\n\t\tif (schemaNode.dependsOnDataPath) {\n\t\t\tif (instanceNode)\n\t\t\t\tfor (var root=instanceNode; root.parent; root=root.parent,rowData=root.dataObj);\n\t\t\t return this._getValueByPath(rowData,schemaNode.dependsOnDataPath);\n\t\t}\n\t\tif (schemaNode.dependsOnCellPaths) {\n\t\t\tconst dependee=this._resolveCellPaths(instanceNode,schemaNode.dependsOnCellPaths[0]);\n\t\t\treturn dependee?.dataObj?.[dependee.schemaNode.id];\n\t\t}\n\t\treturn rowData[schemaNode.id];\n\t}\n\t\n\n\t_updateCell(schemaNode,el,selEl,rowData,mainIndex,instanceNode=null) {\n\t\tif (schemaNode.input?.type===\"button\") {\n\t\t\tthis._generateButton(schemaNode,mainIndex,el,rowData,instanceNode);\n\t\t} else {\n\t\t\tlet newCellContent;\n\t\t\tif (schemaNode.render||schemaNode.input?.type!=\"select\") {\n\t\t\t\tnewCellContent=this._getTargetVal(true,schemaNode, instanceNode, rowData);\n\t\t\t\tif (schemaNode.render)\n\t\t\t\t\tnewCellContent=schemaNode.render(newCellContent,rowData,schemaNode,mainIndex,instanceNode);\n\t\t\t} else { //if (schemaNode.input?.type===\"select\") {\n\t\t\t\tlet selOptObj=rowData[schemaNode.id];\n\t\t\t\tif (selOptObj&&typeof selOptObj!==\"object\")\n\t\t\t\t\tselOptObj=rowData[schemaNode.id]=schemaNode.input.options.find(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\topt=>opt.value==rowData[schemaNode.id]);\n\t\t\t\tnewCellContent=selOptObj?.text??\"\";\n\t\t\t}\n\t\t\tlet isDisabled=false;\n\t\t\tif (this._spreadsheet&&schemaNode.type!==\"expand\") {\n\t\t\t\tconst enabledFuncResult=schemaNode.input?.enabled?.(schemaNode,rowData,mainIndex,instanceNode);\n\t\t\t\tif (!schemaNode.input||enabledFuncResult==false||enabledFuncResult?.enabled==false)\n\t\t\t\t\tisDisabled=true;\n\t\t\t}\n\t\t\t(selEl??el).classList.toggle(\"disabled\",isDisabled);\n\t\t\tif (schemaNode.html)\n\t\t\t\tel.innerHTML=newCellContent??\"\";\n\t\t\telse\n\t\t\t\tel.innerText=newCellContent??\"\";\n\t\t}\n\t}\n\n\t/**Updates the html-element of a main-table-cell\n\t * @param {*} cellEl \n\t * @param {*} colSchemaNode */\n\t_updateMainRowCell(cellEl,colSchemaNode) {\n\t\tcellEl.firstChild.innerHTML=\"\";\n\t\tconst mainIndex=cellEl.closest(\".main-table>tbody>tr\").dataset.dataRowIndex;\n\t\tthis._updateCell(colSchemaNode,cellEl.firstChild,cellEl,this._data[mainIndex],mainIndex);\n\t}\n\n\t_highlightRowIndex(index) {\n\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${index}\"]`);\n\t\tif (tr)\n\t\t\tthis._highlightElements(tr.children);\n\t\telse\n\t\t\tthis._highlightRowsOnView[index]=true;\n\t}\n\n\t_highlightElements(elements) {\n\t\tconst origColors=[];\n\t\tfor (const el of elements) {\n\t\t\torigColors.push(window.getComputedStyle(el).backgroundColor);\n\t\t\tel.style.transition = \"none\";\n\t\t\tel.style.backgroundColor=\"blue\";\n\t\t}\n\t\tsetTimeout(()=>{\n\t\t\tfor (const el of elements) {\n\t\t\t\tel.style.transition=\"background-color 1s linear\";\n\t\t\t\tel.style.backgroundColor=origColors.shift();\n\t\t\t}\n\t\t});\n\t}\n\n\t_scrollToCursor(){}//default is to do nothing. Tablance (main) overrides this.\n\t_applyVisibleIf(){}//default is to do nothing. Tablance (main) overrides this.\n}\n\n// Test-only XMLHttpRequest stub to simulate slow uploads in a single spot.\nclass FakeXMLHttpRequest {\n\tconstructor({totalBytes,rate=1,startAt=0}) {\n\t\tthis.totalBytes=totalBytes||1;\n\t\tconst parsedRate=parseFloat(rate);\n\t\tthis.pctPerSecond=Math.max(0.0001,isNaN(parsedRate)?1:parsedRate);//avoid hangs at 0\n\t\tconst parsedStart=parseFloat(startAt);\n\t\tconst startPercent=isNaN(parsedStart)?0:parsedStart;\n\t\tthis.startPercent=Math.max(0,Math.min(100,startPercent));\n\t\tthis._listeners=Object.create(null);\n\t\tthis._uploadListeners=Object.create(null);\n\t\tthis.upload={addEventListener:(type,fn)=>this._addListener(this._uploadListeners,type,fn)};\n\t}\n\n\t_addListener(target,type,fn) {\n\t\t(target[type]??=[]).push(fn);\n\t}\n\n\taddEventListener(type,fn) { this._addListener(this._listeners,type,fn); }\n\topen() {}\n\tsetRequestHeader() {}\n\tabort() { this._clearTimer(); }\n\n\tsend() {\n\t\tlet loaded=this.totalBytes*this.startPercent/100;\n\t\tthis._emit(this._uploadListeners.progress,{loaded,total:this.totalBytes});\n\t\tif (loaded>=this.totalBytes) {\n\t\t\tPromise.resolve().then(()=>this._emit(this._listeners.load,{}));\n\t\t\treturn;\n\t\t}\n\t\tthis._timer=setInterval(()=>{\n\t\t\tloaded=Math.min(this.totalBytes,loaded+this.totalBytes*this.pctPerSecond/100);\n\t\t\tthis._emit(this._uploadListeners.progress,{loaded,total:this.totalBytes});\n\t\t\tif (loaded>=this.totalBytes) {\n\t\t\t\tthis._clearTimer();\n\t\t\t\tthis._emit(this._listeners.load,{});\n\t\t\t}\n\t\t},1000);\n\t}\n\n\t_emit(listeners,event) {\n\t\tif (!listeners)\n\t\t\treturn;\n\t\tfor (const fn of listeners)\n\t\t\tfn(event);\n\t}\n\n\t_clearTimer() {\n\t\tif (this._timer) {\n\t\t\tclearInterval(this._timer);\n\t\t\tthis._timer=null;\n\t\t}\n\t}\n}\n\n/**\n * Secondary Tablance used for the bulk-edit area.\n * Reflects and updates selected rows in the main Tablance instance.\n */\nclass TablanceBulk extends TablanceBase {\n\t/** @type {Tablance} main tablance owning this bulk instance */\n\tmainInstance;\n\t_dropdownAlignmentContainer=this.rootEl;\n\tconstructor() {\n\t\tsuper(...arguments);\n\t}\n\n\t\n\n\t_doEditSave() {\n\t\tconst inputVal=this._activeSchemaNode.input.type===\"select\"?this._inputVal.value:this._inputVal;\n\t\tthis._cellCursorDataObj[this._activeSchemaNode.id]=this._inputVal;\n\t\tfor (const selectedRow of this.mainInstance._selectedRows)\n\t\t\tselectedRow[this._activeSchemaNode.id]=inputVal;\n\t\tfor (const selectedTr of this.mainInstance._mainTbody.querySelectorAll(\"tr.selected\"))\n\t\t\tthis.mainInstance.updateData(selectedTr.dataset.dataRowIndex,this._activeSchemaNode.id,inputVal,false,true);\n\t\tthis._updateDetailsCell(this._activeDetailsCell,this._cellCursorDataObj);\n\t}\n}\n\n/**\n * Primary Tablance component representing the main interactive table.\n * Handles full data display, user interaction, editing, details, and rendering.\n */\nexport default class Tablance extends TablanceBase {\n\tstatic version=TABLANCE_VERSION;\n\tstatic build=TABLANCE_BUILD;\n\n\tconstructor() {\n\t\tsuper(...arguments);\n\t\tthis._dropdownAlignmentContainer=this._onlyDetails?this.rootEl:this._scrollBody;\n\t}\n\t\n\t_doEditSave() {\n\t\tlet doUpdate=true;//if false then the data will not actually change in either dataObject or the html\n\t\tconst inputVal=this._activeSchemaNode.input.type===\"select\"?this._inputVal.value:this._inputVal;\n\n\t\tthis._activeSchemaNode.input.onChange?.({\n\t\t\tnewValue: inputVal,\n\t\t\toldValue: this._selectedCellVal,\n\t\t\tdataKey: this._activeSchemaNode.id,\n\t\t\tdataContext: this._cellCursorDataObj,\n\t\t\tschemaNode: this._activeSchemaNode,\n\t\t\tinstanceNode: this._activeDetailsCell,\n\t\t\tclosestMeta: key => this._closestMeta(this._activeSchemaNode, key),\n\t\t\tcancelUpdate: () => doUpdate=false\n\t\t});\n\n\t\tif (doUpdate) {\n\t\t\tthis._cellCursorDataObj[this._activeSchemaNode.id]=this._inputVal;\n\t\t\tif (this._activeDetailsCell){\n\t\t\t\tconst doHeightUpdate=this._updateDetailsCell(this._activeDetailsCell,this._cellCursorDataObj);\n\t\t\t\tif (doHeightUpdate&&!this._onlyDetails)\n\t\t\t\t\tthis._updateDetailsHeight(this._selectedCell.closest(\"tr.details\"));\n\t\t\t\tfor (let cell=this._activeDetailsCell.parent; cell; cell=cell.parent)\n\t\t\t\t\tif (cell.schemaNode.closedRender)//found a group with a closed-group-render func\n\t\t\t\t\t\tcell.updateRenderOnClose=true;//update closed-group-render\n\t\t\t} else {\n\t\t\t\tthis._updateMainRowCell(this._selectedCell,this._activeSchemaNode);\n\t\t\t\tthis._unsortCol(this._activeSchemaNode.id);\n\t\t\t}\n\t\t\tif (this._selectedRows.indexOf(this._cellCursorDataObj)!=-1)//if edited row is checked/selected\n\t\t\t\tthis._updateBulkEditAreaCells([this._activeSchemaNode]);\n\t\t\tthis._updateDependentCells(this._activeSchemaNode,this._activeDetailsCell);\n\t\t} else\n\t\t\tthis._inputVal=this._selectedCellVal;\n\t\tthis._selectedCellVal=this._inputVal;\n\t}\n\n\t_scrollToCursor() {\n\t\tif (this._onlyDetails)\n\t\t\treturn this._cellCursor.scrollIntoView({block: \"center\"});\n\t\tconst distanceRatioDeadzone=.5;//when moving the cellcursor within this distance from center of view no \n\t\t\t\t\t\t\t\t\t\t//scrolling will be done. 0.5 is half of view, 1 is entire height of view\n\t\tconst distanceRatioCenteringTollerance=1;//if moving the cellcursor within this ratio, but outside of \n\t\t\t\t\t//distanceRatioDeadzone then minimum scrolling will occur only to get within distanceRatioDeadzone\n\t\tconst scrollPos=this._scrollBody.scrollTop;\n\t\tconst scrollHeight=this._scrollBody.offsetHeight;\n\t\tconst cursorY=parseInt(this._cellCursor.style.top);\n\t\tconst cursorHeight=this._cellCursor.offsetHeight;\n\t\tconst distanceFromCenter=cursorY+cursorHeight/2-scrollPos-scrollHeight/2;\n\t\tconst distanceFromCenterRatio=Math.abs(distanceFromCenter/scrollHeight);\n\t\tif (distanceFromCenterRatio>distanceRatioDeadzone/2) {\n\t\t\tif (distanceFromCenterRatio>distanceRatioCenteringTollerance/2)\n\t\t\t\tthis._scrollBody.scrollTop=cursorY-scrollHeight/2+this._rowHeight/2;\n\t\t\telse\n\t\t\t\tthis._scrollBody.scrollTop=cursorY-scrollHeight/2+cursorHeight/2\n\t\t\t\t\t\t\t\t+(distanceFromCenter<0?1:-1)*scrollHeight*distanceRatioDeadzone/2;\n\t\t}\n\t\t//need to call this manually so that elements that are expected to exist after scroll are guaranteed to do so.\n\t\t//changing this._scrollBody.scrollTop actually calls this method anyway but not until all other code as hun.\n\t\t//This will cause it to run it twice but it's not a big deal.\n\t\tthis._scrollMethod();\n\t}\n\n\t_expandRow(tr,animate=true) {\n\t\tconst dataRowIndex=parseInt(tr.dataset.dataRowIndex);\n\t\tif (!this._schema.details||this._rowMetaGet(dataRowIndex)?.h>0)\n\t\t\treturn;\n\t\tconst expRow=this._renderDetails(tr,dataRowIndex);\n\t\tconst expHeight=this._rowMetaSet(dataRowIndex,\"h\",this._rowHeight+expRow.offsetHeight+this._borderSpacingY);\n\t\tconst contentDiv=expRow.querySelector(\".content\");\n\t\tif (!this._detailsBordersHeight)//see declarataion of _detailsTopBottomBorderWidth\n\t\t\tthis._detailsBordersHeight=expHeight-contentDiv.offsetHeight;\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)//adjust scroll-height reflect change...\n\t\t\t+expHeight-this._rowHeight+\"px\";//...in height of the table\n\t\tif (animate) {\n\t\t\tthis._unsortCol(null,\"expand\");\n\t\t\tcontentDiv.style.transition=\"\";\n\t\t\tcontentDiv.style.height=\"0px\";//start at 0\n\t\t\tsetTimeout(()=>contentDiv.style.height=expHeight-this._detailsBordersHeight+\"px\");\n\t\t\tthis._animate(()=>this._adjustCursorPosSize(this._selectedCell,true),500,\"cellCursor\");\n\t\t} else {\n\t\t\tcontentDiv.style.transition=\"none\";\n\t\t\tcontentDiv.style.height=expHeight-this._detailsBordersHeight+\"px\";\n\t\t}\n\t\treturn expHeight;\n\t}\n\n\t_contractRow(tr) {\n\t\tif (tr.classList.contains(\"details\"))\n\t\t\ttr=tr.previousSibling;\n\t\tconst dataRowIndex=parseInt(tr.dataset.dataRowIndex);\n\t\tif (dataRowIndex==this._mainRowIndex&&this._activeDetailsCell)\n\t\t\tthis._exitEditMode(false);//cancel out of edit-mode so field-validation doesn't cause problems\n\t\tif (!this._schema.details||!this._rowMetaGet(dataRowIndex)?.h)\n\t\t\treturn;\n\t\tthis._unsortCol(null,\"expand\");\n\t\tif (this._mainRowIndex==dataRowIndex&&this._activeDetailsCell) {//if cell-cursor is inside the details\n\t\t\tthis._selectMainTableCell(tr.cells[this._mainColIndex]);//then move it out\n\t\t\tthis._scrollToCursor();\n\t\t}\n\t\tconst contentDiv=tr.nextSibling.querySelector(\".content\");\n\t\tif (contentDiv.style.height===\"auto\") {//if fully expanded\n\t\t\tcontentDiv.style.height=this._rowMetaGet(dataRowIndex).h-this._detailsBordersHeight+\"px\";\n\t\t\tsetTimeout(()=>contentDiv.style.height=0);\n\t\t} else if (parseInt(contentDiv.style.height)==0)//if previous closing-animation has reached 0 but transitionend \n\t\t//hasn't been called yet which happens easily, for instance by selecting expand-button and holding space/enter\n\t\t\tcontentDiv.dispatchEvent(new Event('transitionend'));\n\t\telse//if in the middle of animation, either expanding or contracting. make it head towards 0\n\t\t\tcontentDiv.style.height=0;\n\t\tthis._animate(()=>this._adjustCursorPosSize(this._selectedCell,true),500,\"cellCursor\");\n\t}\n\n\t_scrollElementIntoView(element) {\n\t\tif (!this._onlyDetails) {\n\t\t\tconst pos=this._getElPos(element);\n\t\t\tthis._scrollBody.scrollTop=pos.y+element.offsetHeight/2-this._scrollBody.offsetHeight/2;\n\t\t\tthis._scrollMethod();\n\t\t} else\n\t\t\tthis._tooltip.scrollIntoView({behavior:'smooth',block:\"center\"});\n\t}\n\n\t_applyVisibleIf(instanceNode,mainIndex) {\n\t\tconst schemaNode=instanceNode.schemaNode;\n\t\tlet val=this._getTargetVal(false,schemaNode,instanceNode);\n\t\tif (schemaNode.input?.type===\"select\"&&val?.value)\n\t\t\tval=val.value;\n\t\n\t\tinstanceNode.hidden = !!instanceNode.hidden;\n\t\n\t\t//the !! is needed or else undefined will be treated the same as true\n\t\tif (!!schemaNode.visibleIf(val,instanceNode.dataObj,schemaNode,mainIndex,instanceNode) == instanceNode.hidden) {\n\t\t\tinstanceNode.hidden=!instanceNode.hidden;\n\t\t\tinstanceNode.outerContainerEl.style.display=instanceNode.hidden?\"none\":\"\";\n\t\t}\n\t\n\t\treturn !instanceNode.hidden;\n\t}\n}\n"],"names":["SCHEMA_WRAPPER_MARKER","Symbol","SCHEMA_WRAPPER_KEYS","Set","INSTANCE_NODE_PROTOTYPE","Object","create","defineProperties","prevSibling","get","siblings","this","parent","children","Number","isInteger","index","undefined","nextSibling","TablanceBase","hostEl","rootEl","neighbourTables","_containerHeight","_containerWidth","_colSchemaNodes","_cols","_headerTr","_headerTable","_allData","_data","_scrollRowIndex","_scrollBody","_scrollingContent","_scrollMarginPx","_tableSizer","_mainTable","_mainTbody","_bulkEditArea","_bulkEditTable","_bulkEditAreaOpen","_bulkEditSchemaNodes","_bulkEditAreaHeightPx","_numberOfRowsSelectedSpan","_borderSpacingY","_rowHeight","_rowInnerHeight","_staticRowHeight","_spreadsheet","_opts","_sortingCols","_searchInput","_filter","_cellCursor","_mainRowIndex","_mainColIndex","_activeSchemaNode","_cellCursorDataObj","_selectedCellVal","_selectedCell","_inEditMode","_inputVal","_highlightOnFocus","_detailsBordersHeight","_scrollMethod","_rowsMeta","keys","vals","_filesMeta","_selectedRows","_scrollY","_numRenderedRows","_openDetailsPanes","_activeDetailsCell","_ignoreClicksUntil","_highlightRowsOnView","_lastCheckedIndex","_numRowsSelected","_numRowsInViewSelected","_animations","_onlyDetails","_tooltip","_dropdownAlignmentContainer","constructor","schema","staticRowHeight","spreadsheet","opts","document","createElement","appendChild","classList","add","_schema","_buildSchemaFacade","main","columns","searchbar","_setupSearchbar","_createTableHeader","_createTableBody","ResizeObserver","_updateSizesOfViewportAndCols","bind","observe","_setupSpreadsheet","sortAscHtml","sortDescHtml","sortNoneHtml","_updateHeaderSortHtml","_buildDependencyGraph","_createBulkEditArea","_createInstanceNode","assign","addData","data","highlight","_setDataForOnlyDetails","oldLen","length","value","concat","sortingOccured","_sortData","_filterData","_refreshTable","_maybeAddTrs","numNewInData","style","height","parseInt","dataRow","_highlightRowIndex","indexOf","scrollToDataRow","updateData","dataRow_or_mainIndex","dataPath","newData","scrollTo","onlyRefresh","mainIndx","updatedEls","isNaN","split","dataPortion","i","key","replace","colSchemaNode","colI","id","tr","querySelector","_updateMainRowCell","cells","nodeToUpdate","instanceNodeId","arrayIndex","_findDescendantInstanceNodeById","schemaNode","type","entry","entryI","_deleteCell","dataObj","forEach","dataEntry","push","_repeatInsert","at","_updateDetailsCell","el","scrollIntoView","behavior","block","_highlightElements","getElementsByTagName","_adjustCursorPosSize","rawNode","parentWrappedNode","proto","getPrototypeOf","prototype","Array","isArray","wrappedNode","newWrapper","raw","Proxy","target","prop","has","set","Error","createSchemaNodeFacade","details","cols","col","wrappedCol","entries","arr","child","wrappedChild","_closestMeta","startNode","metaKey","node","meta","searchInObj","idToFind","result","expandRow","mainIndex","_expandRow","smooth","scrollY","otherDataRow","offsetHeight","top","_rowMetaGet","h","chainTables","otherTablances","tablances","sort","a","b","elA","container","elB","parentElement","contains","commonCont","from","tablance","up","down","selectTopBottomCellOnlyDetails","_selectFirstSelectableDetailsCell","ctx","_dep_pass1_assignAutoIdsAndMaps","_dep_pass2_assignPathsAndData","_dep_pass3_resolveDependencies","_dep_pass4_cleanup","wrappedSchema","autoIdCounter","explicitIdToAutoId","implicitIdToAutoId","schemaNodeByAutoId","seenCellIds","roots","initialRoots","stack","pop","autoId","_autoId","cellId","_dep_children","autoIdByName","_dep_assignPathsAndData","uiPath","parentCtx","_path","myCtx","dataPathArr","String","filter","Boolean","_dataContextPath","_dataPath","kids","dependsOn","deps","dependentIsExp","cellPaths","dataPaths","depName","depAutoId","console","warn","dependee","dependeeIsExp","fwd","_dep_computeForwardPath","dependencyPaths","rev","_dep_computeReversePath","_dep_finalizeDependency","dependent","to","common","fill","slice","dependsOnCellPaths","dependsOnDataPath","_updateViewportHeight","clientHeight","_attachInputFormatter","format","_normalizeInputFormat","numericOnly","addEventListener","e","test","preventDefault","setAttribute","delimiter","pos","selectionStart","setSelectionRange","dispatchEvent","Event","apply","_applyInputFormatting","date","blocks","_formatDateValue","out","delim","part","digits","y","m","mm","Math","min","max","padStart","d","dd","Date","getDate","className","placeholder","lang","filterPlaceholder","_onSearchInput","_e","onlyDetails","display","borderSpacing","_spreadsheetOnFocus","_spreadsheetOnBlur","tabIndex","_spreadsheetKeyDown","_spreadsheetMouseDown","_enterCell","dataIndex","_rowMetaSet","val","linkIndex","splice","tabbedTo","_selectMainTableCell","rows","removeProperty","outline","_scrollToCursor","setTimeout","activeElement","_moveCellCursor","hSign","vSign","_exitEditMode","_moveInsideLineup","newColIndex","_selectAdjacentDetailsCell","numCols","numRows","currentCellX","offsetLeft","currCelTop","offsetTop","currCelBottom","nextCel","offsetParent","_selectDetailsCell","closestCell","closestCellX","otherCell","abs","instanceNode","isGoingDown","cell","_getAdjacentDetailsCell","nextTable","sibling","hidden","niece","_getFirstSelectableDetailsCell","onlyGetChild","newInstanceNode","startI","chosenCell","childI","select","visibility","input","ctrlKey","stopPropagation","shiftKey","code","_groupEscape","closest","_contractRow","requestAnimationFrame","_toggleRowExpanded","_rowCheckboxChange","endsWith","_insertAtCursor","myField","myValue","selection","focus","createRange","text","startPos","endPos","selectionEnd","substring","_unsortCol","sortCol","_renderDetails","rowIndex","detailsRow","insertRow","dataset","dataRowIndex","detailsCell","insertCell","colSpan","detailsDiv","_detailsAnimationEnd","_generateDetailsContent","currentTarget","detailsTr","mainTr","previousSibling","remove","parentEl","path","rowData","_notYetCreated","notYetCreated","scopedRowData","visibleIf","_applyVisibleIf","_generateDetailsList","_generateField","_generateDetailsGroup","_generateDetailsRepeated","_generateDetailsLineup","_repeatedOnDelete","cel","onDelete","_fileOnDelete","strct","fileCell","inputSchemaNode","fileInputSchemaNode","fileTd","innerHTML","deleteHandler","_onOpenCreationGroup","groupObject","repeatedSchemaNode","repeatData","insertionPoint","createComment","_generateRepeatedCreator","repeatedObj","creationTxt","creationText","insertNew","creationSchemaNode","closedRender","creator","onOpen","cssClass","wrappedCreationSchemaNode","_beginDeleteRepeated","creating","containerEl","_cancelDelete","_schemaCopyWithDeleteButton","deleteControls","onBlur","selEl","btnText","deleteText","delete","clickHandler","areYouSureNoText","deleteAreYouSureNo","title","deleteAreYouSureText","deleteAreYouSure","areYouSureYesText","deleteAreYouSureYes","parentWrapped","clonedEntries","clonedNode","wrappedClone","_cloneDependencyMetadata","sourceNode","targetNode","copyMeta","srcVal","map","v","sourceChildren","targetChildren","_generateButton","btn","groupSchemaNode","groupTable","tbody","join","_generateDetailsCollection","renderRow","innerText","listSchemaNode","listTable","titlesColWidth","titlesCol","width","lineupSchemaNode","containerSchemaNode","collectionObj","childSchemaNode","rptCelObj","_generateCollectionItem","_buildCollectionItemDOM","collection","itemObj","outerContainerEl","td","toggle","nonEmptyDescentants","grpTr","_insertCollectionItem","collectionOrRepeated","collectionEl","siblingAfter","next","base","beforeEl","insertBefore","_changeInstanceNodeIndex","fieldSchemaNode","now","which","interactiveEl","step","preventScroll","shift","checked","_toggleRowsSelected","fromIndex","toIndex","_updateNumRowsSelectionState","_updateBulkEditAreaCells","checkbox","indeterminate","_animate","Infinity","func","runForMs","runUntil","animations","frame","_autoTextAreaResize","maxHeight","scrollHeight","_updateDetailsHeight","contentDiv","mainRowIndex","prevRowHeight","newRowHeight","_openDateEdit","pika","pikaContainer","window","Pikaday","field","toString","getFullYear","getMonth","onClose","destroy","firstDay","showWeekNumber","defaultDate","setDefaultDate","i18n","previousMonth","nextMonth","months","weekdays","weekdaysShort","_alignDropdown","onDraw","position","KeyboardEvent","inputVal","setDate","datePlaceholder","dropdown","alignmentContainer","alignmentPos","_getElPos","viewportPos","scrollTop","clientWidth","x","offsetWidth","left","click","textarea","_openTextAreaEdit","_openSelectEdit","file","_openFileEdit","_openTextEdit","call","_openGroup","groupObj","doOpen","onOpenAfter","_closeGroup","_closeRepeatedInsertion","updateRenderOnClose","renderText","repeated","entrySchemaNode","indexOfNew","sortCompare","root","entryNode","newObj","onCreateOpen","newIndex","level","pathEl","querySelectorAll","fixObjPath","programatically","newSelectedCell","onCreateCancel","maxLength","_mapAdd","_mapGet","_mapRemove","getSelection","empty","fileDiv","fileInput","fileChooseOrDrag","dropDiv","fileDropToUpload","handleFile","_processFileUpload","startsWith","dataTransfer","files","uploadedBytes","bars","xhr","useFakeFileUploadTest","FakeXMLHttpRequest","totalBytes","size","rate","fakeUploadRate","startAt","fakeUploadStartAt","XMLHttpRequest","updateProgressBars","loaded","total","bar","isConnected","pct","firstChild","finalizeUpload","fileUploadDone","upload","fileUploadHandler","formData","FormData","append","send","paddingLeft","paddingRight","paddingTop","paddingBottom","getComputedStyle","_renderSelectOptions","ul","selectedVal","foundSelected","opt","li","highlightLiIndex","highlightUlIndex","ulIndex","_highlightSelectOption","liIndex","keyboardNavigating","highlighted","ulDiv","getElementsByClassName","_handleSelectInputChange","hadFilter","filterText","filterChangedAtEdges","includes","canCreate","looseOpts","strctInp","options","pinned","toLowerCase","_updateCreateOptionVisibility","mainUl","pinnedUl","noResults","creationLi","removeChild","_handleSelectKeyDown","direction","_closeSelectDropdown","_handleSelectMouseMove","parentNode","_handleSelectClick","_createSelectDropdownContext","selectContainer","pinnedOpts","inputWrapper","noResultsText","selectNoResultsFound","dataContext","windowMouseDown","createNewOptionHandler","removeEventListener","backgroundColor","allowCreateNew","minOptsFilter","defaultMinOptsFilter","selectInputPlaceholder","_validateInput","newVal","message","validation","_showTooltip","_updateDependentCells","editedCellSchemaNode","editedInstanceNode","depPath","newCells","cellI","save","stripDelimiterOnSave","replaceAll","_doEditSave","_scrollElementIntoView","repeatEntry","values","doCreate","creationValidation","creationContainer","repeatedContainer","payload","newDataItem","dataArray","dataKey","itemIndex","bulkEdit","closestMeta","cancelCreate","onCreate","_closeActiveDetailsCell","oldCellParent","cellIndex","_selectCell","oldExpCell","oldParnt","newParent","parentCell","cellEl","adjustCursorPosSize","noPtrEvent","pointerEvents","cellPos","getBoundingClientRect","contPos","onlyPos","elPos","thead","th","_onThClick","_createCheckbox","sortDiv","clickedIndex","tagName","_expandOrContractAll","sortingCol","sortingColIndex","order","expand","row","thIndex","sortCols","aV","aSel","_onScrollStaticRowHeightNoDetails","_onScrollStaticRowHeightDetails","passive","overflow","bulkContent","numberOfRowsSelectedDiv","pagesDiv","mainPage","tableContainer","bulkEditFields","_buildBulkEditSchemaNodes","column","bulkSchema","TablanceBulk","mainInstance","_isObject","schemaNodesToUpdateCellsFor","mixedText","multiCellSchemaNode","multiCellI","lastVal","mixed","rowI","_maybeRemoveTrs","_updateColsWidths","areaWidth","percentageWidthRegex","totalFixedWidth","numUndefinedWidths","pxWidth","sumFixedAndFlexibleWidth","parseFloat","filterString","colsToFilterBy","selectsOptsByVal","optsByVal","match","_refreshTableSizerNoDetails","replaceChildren","scrY","newScrollRowIndex","scrollSignum","sign","_updateRowValues","trToMove","lastChild","prepend","newScrY","topShift","_doRowScrollDetails","newMainIndex","oldMainIndex","detailsHeight","_lookForActiveCellInRow","unshift","_createExpandContractButton","preventClickSelect","_preventDefault","lastTr","scrH","dataLen","div","tdComputedStyle","selected","_humanFileSize","bytes","si","dp","thresh","units","u","r","round","toFixed","_generateFileCell","fileInstanceNode","fileSchemaNode","metaEntries","fileName","fileLastModified","render","toISOString","fileSize","fileType","metaName","metaI","fileMetasToShow","defaultFileMetasToShow","fileGroup","btnObj","openHandler","wrappedFileGroup","fileData","fileMeta","progressbarOuter","progressbarInner","transition","role","progressSpan","rootCell","oldCellContent","_updateCell","newCellContent","_getValueByPath","obj","cur","_resolveCellPaths","baseCell","_getTargetVal","idOverDependee","selOptObj","find","isDisabled","enabledFuncResult","enabled","html","elements","origColors","parsedRate","pctPerSecond","parsedStart","startPercent","_listeners","_uploadListeners","fn","_addListener","open","setRequestHeader","abort","_clearTimer","_emit","progress","Promise","resolve","then","load","_timer","setInterval","listeners","event","clearInterval","super","arguments","selectedRow","selectedTr","Tablance","static","doUpdate","onChange","newValue","oldValue","cancelUpdate","scrollPos","cursorY","cursorHeight","distanceFromCenter","distanceFromCenterRatio","distanceRatioDeadzone","distanceRatioCenteringTollerance","animate","expRow","expHeight","element"],"mappings":"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"}