{"version":3,"file":"tablance.esm.js","sources":["../src/tablance.js"],"sourcesContent":["\n/** Symbol used to tag wrapper objects to avoid ever double-wrapping. Symbol used over string but not really needed. */\nconst SCHEMA_WRAPPER_MARKER=Symbol(\"schemaWrapper\");\n/** Set of properties allowed on wrapper nodes; access outside this set is forwarded to the raw schema node. */\nconst SCHEMA_WRAPPER_KEYS=new Set([\"raw\", \"parent\", \"main\", \"details\", \"columns\", \"entry\", \"entries\", \"_autoId\",\n\t\"_path\", \"sortDiv\",\"_dataContextPath\",\"_dataPath\", \"dependencyPaths\", \"dependsOnCellPaths\", \"dependsOnDataPath\",\n\t\"pxWidth\", SCHEMA_WRAPPER_MARKER]);\n\nconst TABLANCE_VERSION = typeof __TABLANCE_VERSION__!==\"undefined\"?__TABLANCE_VERSION__:\"dev\";\nconst TABLANCE_BUILD = typeof __TABLANCE_BUILD__!==\"undefined\"?__TABLANCE_BUILD__:\"dev\";\n\n\n/** \n * Base class providing shared table logic, structure management,\n * data handling, and rendering helpers etc used by both Tablance and TablanceBulk.\n */\nclass TablanceBase {\n\thostEl;//the element that is passed to the constructor and which the table is added to\n\trootEl;//Readonly, container-element for table\n\tneighbourTables;//Object of other Tablance-instances. Possible keys are \"up\" and \"down\". If any of these are set\n\t\t\t\t//then if one keeps pressing up/down until there are no more cells then one will get o the next table.\n\t\t\t\t//Except for manually this can also be set via chainTables()\n\t_containerHeight=0;//height of #container. Used to keep track of if height shrinks or grows\n\t_containerWidth=0;//height of #container. Used to keep track of if width shrinks or grows\n\t_colSchemaNodes;//column-objects. Essentially the same as schema.main.columns but have been processed an may in\n\t\t// addition contain \"sortDiv\" reffering to the div with the sorting-html (see for example opts->sortAscHtml)\n\t_cols=[];//array of col-elements for each column\n\t_headerTr;//the tr for the top header-row\n\t_headerTable;//the tabe for the #headerTr. This table only contains that one row.\n\t_allData=[];//contains all, unfiltered data that has been added via addData()\n\t_data=[];//with no filter applied(empty seachbar) then this is reference to _allData, otherwise is a subset of it\n\t_scrollRowIndex=0;//the index in the #data of the top row in the view\n\t_scrollBody;//resides directly inside #container and is the element with the scrollbar. It contains #scrollingDiv\n\t_scrollingContent;//a div that is inside #scrollbody and holds #tablesizer and #cellCursor if spreadsheet\n\t\t\t\t\t//this is needed because putting #cellCursor directly inside #scrollBody will not make it scroll\n\t\t\t\t\t//because it has position absolute and needs that. And putting it inside #tableSizer will cause it\n\t\t\t\t\t//to jump up and down when pos and height of #tableSizer is adjusted to keep correct scroll-height\n\t_scrollMarginPx=150;//is used to allow for more rows to be rendered outside of the view so to speak. At least in\n\t\t\t\t\t\t//firefox when scrolling it is really noticable that the scrolling is done before the rows are\n\t\t\t\t\t\t//moved which reveals white area before the rows are rendered. Increasing this number will\n\t\t\t\t\t\t//basically add that many pixels to the height of the viewport on top and bottom. It will not\n\t\t\t\t\t\t//actually be higher but the scroll-method will see it as if it is higher than it is\n\t_tableSizer;//a div inside #scrollingDiv which wraps #mainTable. The purpose of it is to set its height to the \n\t\t\t\t//\"true\" height of the table so that the scrollbar reflects all the data that can be scrolled through\n\t_mainTable;//the actual main-table that contains the actual data. Resides inside #tableSizer\n\t_mainTbody;//tbody of #mainTable\n\n\t_bulkEditArea;//a div displayed under #scrollBody if rows are selected/checked using select-column. This \n\t\t\t\t\t\t//section is used to edit multiple rows at once\n\t_bulkEditTable;//this holds another instance of the Tablance class which is used inside the bulk-edit-area\n\t_bulkEditAreaOpen=false;//whether the section is currently open or not\n\t_bulkEditSchemaNodes;//Array of schema-nodes with inputs that are present in the bulk-edit-area\n\t_bulkEditAreaHeightPx;//height of bulk-edit-area in px. Used to animate from 0 to full height when opening/closing\n\t_numberOfRowsSelectedSpan;//resides in the bulk-edit-area. Should be set to the number of rows selected\n\t_borderSpacingY;//the border-spacing of #mainTable. This needs to be summed with offsetHeight of tr (#rowHeight) to \n\t\t\t\t\t//get real distance between the top of adjacent rows\n\t_rowHeight=0;//the height of (non expanded) rows with #borderSpacingY included. Assume 0 first until first row added\n\t_rowInnerHeight=0;//this is the height that the div inside main-tds should be set to. It's calculated from \n\t\t\t\t\t//#rowHeight minus top&bottom-padding minus #borderSpacingY of td. This is needed to make sure each\n\t\t\t\t\t//row is always of the same height and things don't get messed up because some row is heigher\n\t\t\t\t\t//because it has high content.\n\t_staticRowHeight;//This is set in the constructor. If it is true then all rows should be of same height which\n\t\t\t\t\t //improves performance.\n\t_spreadsheet;//whether the table is a spreadsheet, which is set in the constructor\n\t_opts; //reference to the object passed as opts in the constructor\n\t_sortingCols=[];//contains data on how the table currently is sorted. It is an array of \n\t\t\t\t\t\t\t\t\t\t//objects which each contain \"index\" which is the index of the column and\n\t\t\t\t\t\t\t\t\t\t//\"order\" which value should be either \"desc\" or \"asc\". The array may contain\n\t\t\t\t\t\t\t\t\t\t//multiple of these objects for having it sorted on multiple ones.\n\t_searchInput;//the input-element used for filtering data\n\t_filter;//the currently applied filter. Same as #searchInput.value but also used for comparing old & new values\n\t\n\t_cellCursor;//The element that for spreadsheets shows which cell is selected\n\t_mainRowIndex;//the index of the row that the cellcursor is at\n\t_mainColIndex;//the index of the column that the cellcursor is at.\n\t_activeSchemaNode;//reference to the schemaNode-object of the selcted cell. For cells in the maintable this would\n\t\t\t\t\t\t//point to an object in #colSchemaNodes, otherwise to the schemaNode-object of details-cells\n\t_cellCursorDataObj;//reference to the actual object holding the data that the cell-cursor currently is at.\n\t\t\t\t\t\t//Usually this will simply point to an object in #data but for data that is nested with\n\t\t\t\t\t\t//repeat-entries this will point to the correct inner object\n\t_selectedCellVal;//the value of the cell that the cellCursor is at\n\t_selectedCell;//the HTML-element of the cell-cursor. probably TD's most of the time.\n\t_inEditMode;//whether the user is currently in edit-mode\n\t//and values are px as ints. This is used to offset the position and adjust position of #cellCursor in order to\n\t//center it around the cell. It is also used in conjunction with cellCursorOutlineWidth to adjust margins of the\n\t//main-table in order to reveal the outermost line when an outermost cell is selected\n\t_inputVal;//the current val of the input when in edit-mode. Will be read and commited if cell is exited correctly\n\t_highlightOnFocus=true;//when the spreadsheet is focused  we want focus-outline to appear but only if focused by\n\t\t\t\t//keyboard-tabbing, and not when clicking or exiting out of edit-mode which again focuses the table.\n\t\t\t\t//By setting this to true in mouseDownEvent we can \n\t\t\t\t//check which input was used last when the focus-method is triggerd\n\t_detailsBordersHeight;//when animating details-pane for expanding/contracting the height of them fully\n\t\t\t//expanded needs to be known to know where to animate to and from. This is different from \n\t\t\t//#expandedRowIndicesHeights because that is the height of the whole row and not the div inside.\n\t\t\t//we could retrieve offsetheight of the div each time a row needs to be animated or instead we can get\n\t\t\t//the border-top-width + border-bottom-width once and then substract that from the value of  what's in\n\t\t\t//#expandedRowIndicesHeights instead\n\t_scrollMethod;//this will be set to a reference of the scroll-method that will be used. This depends on settings for\n\t\t\t\t//staticRowHeight and details\n\t_rowsMeta={keys:[],vals:[]};//This holds meta-data for the data-rows. The structure is essentially like a hashmap\n\t\t\t//from Java where objects are used as keys which in this case it is the data-row-object. This is done by\n\t\t\t//having 2 arrays: keys & vals. A references to a row is placed in \"keys\" and meta-data placed in \"vals\"\n\t\t\t//and index X in \"keys\" always corresponds to index X in \"values\". As for the meta-data itself this is\n\t\t\t//another object:\n\t\t\t//\th Integer \tIf this is present then the row is expanded, otherwise not. The value is the combined height\n\t\t\t//\t\t\t\tof the main row and its details-row.\n\t_filesMeta={keys:[],vals:[]};//Similiar to rowsMeta as it is structured the same but used for files that the user\n\t\t\t\t\t\t\t\t//has uploaded during the current session. This is to keep track of upload-progress.\n\t\t\t\t\t\t\t\t//keys are filled with File-objects while vals is filled with objects containing\n\t\t\t\t\t\t\t\t//metadata: uploadedBytes\n\t_selectedRows=[];//array of the actual data-objects of rows that are currently selected/checked using the select-col\n\t_scrollY=0;//this keeps track of the \"old\" scrollTop of the table when a scroll occurs to know \n\t_numRenderedRows=0;//number of tr-elements in the table excluding tr's that are details (details too are tr's)\n\t_openDetailsPanes={};//for any row that is expanded and also in view this will hold navigational data which\n\t\t\t\t\t\t//is read from when clicking or navigating using keyboard to know which cell is next, and\n\t\t\t\t\t\t//which elements even are selectable and so on. Keys are data-row-index. As soon as a row\n\t\t\t\t\t\t//is either contracted or scrolled out of view it is removed from here and then re-added\n\t\t\t\t\t\t//if expanded again or scrolled into view.\n\t\t\t\t\t\t//keys are rowDataindex and the values are instanceTrees rooted at an instance-node shaped as:\n\t\t\t\t\t\t//\tel: HTMLElement the cell-element itself\n\t\t\t\t\t\t//\tchildren: Array May be null but groups can have children which would be put in here\n\t\t\t\t\t\t//  \t\t\t\teach element would be another instance-node\n\t\t\t\t\t\t//\tparent: points to the parent instance-node. for non nested cells this would point to a\n\t\t\t\t\t\t//\t\t\t\t\t\troot instance-node. and for the root instance-node this would be null.\n\t\t\t\t\t\t//\t\t\t\t\t\tdespite the root being an instance-node it cant be naviagted to. \n\t\t\t\t\t\t//\t\t\t\t\t\tit simply holds the top instance-nodes\n\t\t\t\t\t\t//  index: the index of the node in the children-array of its parent\n\t\t\t\t\t\t//}\n\t_activeDetailsCell;\t//points to an object in #openDetailsNavMap and in extension the cell of an details.\n\t\t\t\t\t\t\t//If this is set then it means the cursor is inside an details.\n\t/* #generatingDetails=false;//this is a flag that gets set to true when a row gets expanded or an already expanded\n\t\t//row gets scrolled into view, in short whenever the details-elements are generated. Then it gets unset when\n\t\t//creation finishes. The reason for having this flag is so that update */\n\t_ignoreClicksUntil;//when being inside an open group and trying to double-click on another cell further down to\n\n\n\t\t//interact with it the first click will highlight it but then the current group closes and what's below it will\n\t\t//get shifted up and the second click hits something else. By setting this var to current time plus 500 ms\n\t\t//when a group closes and checking if current time is past this one in mouseDown handler we'll ignore the second\n\t\t//click which is better user-experience\n\t_highlightRowsOnView={};//Rows can be added to this object with rowindex in #data as key, value needs to be truthy.\n\t\t//Rows that are outside of view can be added and when scrolled into view they will be highlighted. \n\t_lastCheckedIndex;//This is the index of the row that was last (un)checked/selected, meaning the checkbox in the\n\t\t\t\t\t//select-column was interacted with. This is used if the user interacts with another checkbox while\n\t\t\t\t\t//shift is being held\n\t_numRowsSelected=0;//number of rows that are selected/checked using the select-column\n\t_numRowsInViewSelected=0;//number of rows in the current view/filter that are selected/checked using select-column\n\t_animations={};//keeps tracks of animations. Key is a unique id-string, identifying the animation so multiple\n\t\t\t\t\t//instances of the same animation can't run. Value is the end-time in ms since epoch.\n\t_onlyDetails;//If this is set to true then the table will not have any actual rows and will instead only have an\n\t\t\t\t\t// details specified in param details. It will also not have a scrollpane and the details will\n\t\t\t\t\t// always be expanded. Method addData is still used to add the actual data but it will only use the\n\t\t\t\t\t// last row sent. So adding multiple ones will cause it to discard all but the last.\n\t_tooltip;//reference to html-element used as tooltip\n\t_dropdownAlignmentContainer;\t\t\t\t\t\t\n\n\t/**\n\t * @param {HTMLElement} hostEl An element which the table is going to be added to\n\t * @param {{}[]} columns An array of objects where each object has the following structure: {\n\t * \t\t\tid String A unique identifier for the column. The value in the data that has this key will be used as\n\t * \t\t\t\tthe value in the cell.\n\t * \t\t\ttitle String The header-string of the column\n\t * \t\t\twidth String The width of the column. This can be in either px or % units.\n\t * \t\t\t\tIn case of % it will be calculated on the remaining space after all the fixed widths\n\t * \t\t\t\thave been accounted for.\n\t * \t\t\tinput: See param details -> input. This is the same as that one except textareas are only valid for\n\t * \t\t\t\t\t\t\t\t\t\t\t\tdetails-cells and not directly in a maintable-cell\n\t * \t\t\trender Function Function that can be set to render the content of the cell. The return-value is what\n\t * \t\t\t\t\twill be displayed in the cell. Similiarly to columns->render it gets passed the following:\n\t * \t\t\t\t\t1: The value from data pointed to by \"id\". If id is not set but dependsOn is then this will \n\t * \t\t\t\t\t\tinstead get passed the value that the id of the depended cell points to, \n\t * \t\t\t\t\t2: data-row, \n\t * \t\t\t\t\t3: schemaNode,\n\t * \t\t\t\t\t4: main-index \n\t * \t\t\thtml Bool Default is false. If true then the content of the cell will be rendered as html\n\t * 1: The value from data pointed to by \"id\", 2: data-row, 3: schemaNode,4: main-index, 5: instanceNode\n\t * \t\t\ttype String The default is \"data\". Possible values are:\n\t * \t\t\t\t\"data\" - As it it implies, simply to display data but also input-elements such as fields or buttons\n\t * \t\t\t\t\"expand\" - The column will be buttons used for expanding/contracting the rows. See param details\n\t * \t\t\t\t\"select\" - The column will be checkboxes used to (un)select rows\t\n\t * \t\t}\n\t * \t\t\t\n\t * \t@param\t{Boolean} staticRowHeight Set to true if all rows are of same height. With this option on, scrolling\n\t * \t\t\t\tquickly through large tables will be more performant.\n\t * \t@param\t{Boolean} spreadsheet If true then the table will work like a spreadsheet. Cells can be selected and the\n\t * \t\t\t\tkeyboard can be used for navigating the cell-selection.\n\t * \t@param\t{Object} details This allows for having rows that can be expanded to show more data. An \"entry\"-object\n\t * \t\t\tis expected and some of them can hold other entry-objects so that they can be nested.\n\t * \t\t\tProperties that are valid for all types of entries:\n\t * \t\t\t\t* title String displayed title if placed in a container which displays the title\n\t *\n\t * \t\t\t\t* visibleIf Function Optional callback that determines whether this entry should be visible.\n\t * \t\t\t\t\tThe function is called whenever the entry is rendered or any of its dependencies\n\t * \t\t\t\t\t(see `dependsOn`) change. It receives the following arguments:\n\t * \t\t\t\t\t\t(1: The value from data pointed to by \"id\"(or if dependsOn is set the value of that cell)\n\t * \t\t\t\t\t\t2: data-row, 3: schemaNode, 4: main-index, 5: instanceNode)\n\t * \t\t\t\t\tReturn `true` to make the entry visible, or `false` to hide it.\n\t *\n\t * \t\t\t\t\tWhen hidden:\n\t *   \t\t\t\t\t- The entry’s DOM element is not displayed.\n\t *   \t\t\t\t\t- `render` will not be called for this entry.\n\t *\n\t * \t\t\t\t\tVisibility state:\n\t *   \t\t\t\t\t- The instanceNode receives an internal `hidden` flag when the entry is hidden.\n\t *   \t\t\t\t\t- `hidden` is read-only and should not be modified manually.\n\t *   \t\t\t\t\t- If the entry is visible, no `hidden` property is present.\n\t *\n\t *\n\t * \t\t\t\t* dependsOn String Optional string identifying another entry that this entry depends on.\n\t * \t\t\t\t\tWhenever the referenced entry is edited, this entry automatically refreshes.\n\t * \t\t\t\t\tThe refresh cycle includes:\n \t *\t\t\t\t\t\t- Re-evaluating `visibleIf` (if provided).\n\t *\t\t\t\t\t\t- Re-rendering this entry (unless it is hidden).\n\t *\n \t *\t\t\t\t\tTargeting rules:\n\t * \t\t\t\t\t\t1. If `cellId` is set on the schemaNode of a field, that ID is the identifier of that entry.\n\t * \t\t\t\t\t\t2. If `id` is set (and `cellId` is not), the value of `id` becomes the entry’s identifier.\n\t * \t\t\t\t\t\t3. `dependsOn` must match the identifier of another entry. If both `id` and `cellId` exist,\n\t * \t\t\t\t\t\t\t`cellId` takes priority.\n\t * \t\t\tTypes of entries:\n\t * \t\t\t{\n  \t *\t\t\t\ttype \"list\" this is an entry that holds multiple rows laid out vertically, each item in the list \n\t *\t\t\t\t\t\t\tcan have a title on the left side by specifying \"title\" in each item within the list\n\t * \t\t\t\tentries Array each element should be another entry\n\t * \t\t\t\ttitlesColWidth:String Width of the column with the titles. Don't forget adding the unit.\n\t * \t\t\t\t\tDefault is null which enables setting the width via css.Setting 0/false turns it off completely.\n\t * \t\t\t\tonBlur: Function Callback fired when cellcursor goes from being inside the container to outside\n\t * \t\t\t\t\tIt will get passed arguments 1:instanceNode, 2:mainIndex\n\t * \t\t\t\tbulkEdit Bool Besides setting bulkEdit on input of fields it can also be set on containers which\n\t * \t\t\t\t\t\t\twill add the container to the bulk-edit-area. Any input-fields in the container that\n\t * \t\t\t\t\t\t\thave bulkEdit true will appear in the container there. Remember that both the container\n\t * \t\t\t\t\t\t\tand input of fields have to have true bulkEdit for this to work. These can also be\n\t * \t\t\t\t\t\t\tnested so if there's another group in the group where both have true bulkEdit and the\n\t * \t\t\t\t\t\t\tinner group has inputs with true bulkEdit as well then multi-level groups will be \n\t * \t\t\t\t\t\t\tadded to the bulk-edit-area. Containers in the bulk-edit-area appear as a normal cell\n\t * \t\t\t\t\t\t\tat first but by entering it a page dedicated to that container is changed to.\n\t * \t\t\t\tdependsOn String Can be set up to \n\t *\t\t\t}\n\t *\t\t\t{\t\n\t *\t\t\t\ttype \"lineup\" similiar to a list but each item is inlined, meaning they will be lined up\n\t *\t\t\t\t\t\t\t\t\tin a horizontal line and will also wrap to multiple lines if needed\n\t * \t\t\t\tentries Array each element should be another entry\n\t * \t\t\t\tcssClass String Css-classes to be added to the lineup-div\n\t * \t\t\t\tonBlur Function Callback fired when cellcursor goes from being inside the container to outside\n\t * \t\t\t\t\tIt will get passed arguments 1:instanceNode, 2:mainIndex\n\t * \t\t\t\tbulkEdit Bool Besides setting bulkEdit on input of fields it can also be set on containers which\n\t * \t\t\t\t\t\t\twill add the container to the bulk-edit-area. Any input-fields in the container that\n\t * \t\t\t\t\t\t\thave bulkEdit true will appear in the container there. Remember that both the container\n\t * \t\t\t\t\t\t\tand input of fields have to have true bulkEdit for this to work. These can also be\n\t * \t\t\t\t\t\t\tnested so if there's another group in the group where both have true bulkEdit and the\n\t * \t\t\t\t\t\t\tinner group has inputs with true bulkEdit as well then multi-level groups will be \n\t * \t\t\t\t\t\t\tadded to the bulk-edit-area. Containers in the bulk-edit-area appear as a normal cell\n\t * \t\t\t\t\t\t\tat first but by entering it a page dedicated to that container is changed to.\n\t *\t \t\t}\n\t *\t\t\t{\n  \t * \t\t\t\ttype \"field\" this is what will display data and which also can be editable by specifying \"input\"\n  \t * \t\t\t\tid String the key of the property in the data that the row should display\n\t * \t\t\t\tcssClass String Css-classes to be added to the field\n\t * \t\t\t\trender Function Function that can be set to render the content of the cell. The return-value is what\n\t * \t\t\t\t\twill be displayed in the cell. Similiarly to columns->render it gets passed the following:\n\t * \t\t\t\t\t1: The value from data pointed to by \"id\". If id is not set but dependsOn is then this will \n\t * \t\t\t\t\t\tinstead get passed the value that the id of the depended cell points to, \n\t * \t\t\t\t\t2: data-row, \n\t * \t\t\t\t\t3: schemaNode,\n\t * \t\t\t\t\t4: main-index, \n\t * \t\t\t\t\t5: instanceNode\n\t * \t\t\t\tinput Object field is editable if this object is supplied and its \"disabled\"-prop is not true\n\t * \t\t\t\t\t{\n\t * \t\t\t\t\ttype String This is mandatory and specifies the type of input. Se further down for properties \n\t * \t\t\t\t\t\tspecific to each type of input. The possible types are:\n\t * \t\t\t\t\t\t\t\"text\"(single line text),\n\t * \t\t\t\t\t\t\t\"textarea\"(multi-line text),\n\t * \t\t\t\t\t\t\t\"number\"(number with stepper),\n\t * \t\t\t\t\t\t\t\"date\"(a date and possibly time with a calendar),\n\t * \t\t\t\t\t\t\t\"select\"(selection from a list of items. The values for cells may either be the \"value\" \n\t * \t\t\t\t\t\t\t\t\t\tspecified in one the the options in \"options\", or it can be an actual \n\t * \t\t\t\t\t\t\t\t\t\treference to the option)\n\t * \t\t\t\t\t\t\t\"button\"(simple button)\n\t * \t\t\t\t\t\t\t\"file\" (An input for uploading files. The data for a file entry may be a \n\t * \t\t\t\t\t\t\t\tFile-object which it will be if the file has been uploaded during the current\n\t * \t\t\t\t\t\t\t\tsession. Or it may be an object which basically have the same properties\n\t * \t\t\t\t\t\t\t\tas File:lastModified, name, size, type altough none of those properties are\n\t * \t\t\t\t\t\t\t\tmandatory. Use property \"fileUploadHandler\" to handle the actual upload.)\n\t * \t\t\t\t\t----Properties valid for ALL types of inputs----\n\t * \t\t\t\t\t\tplaceholder String adds a placeholder-string to the input-element\n\t * \t\t\t\t\t\tvalidation Function A callback function which can be used to validate the data upon\n\t * \t\t\t\t\t\t\tcomitting it. Return true if validation was successfull.\n\t * \t\t\t\t\t\t\tIt gets passed the following arguments:\n\t * \t\t\t\t\t\t\t1:newValue, 2: message-function - A function that that takes a message-string as its\n\t * \t\t\t\t\t\t\tfirst argument. If it the validation didn't go through then this string will be\n\t * \t\t\t\t\t\t\tdisplayed to the user. 3:schemaNode, 4:rowData, 5:mainIndex, \n\t * \t\t\t\t\t\t\t6:instanceNode(if details-cell)\n\t *\t\t\t\t\t\ttitle String String displayed title if placed in a container which displays the title\n\t * \t\t\t\t\t\tbulkEdit Bool Whether this input should be editable via bulk-edit-area, the section that \n\t * \t\t\t\t\t\t\tappears when selecting/checking multiple rows using the select-col. Default is true if\n\t * \t\t\t\t\t\t\tnot in details, or false if in details.\n\t * \t\t\t\t\t\t\tContainers can too be added to the bulk-edit-area by setting bulkEdit on the container.\n\t * \t\t\t\t\t\tmultiCellWidth Int For inputs that are present in the bulk-edit-area. This property can be \n\t * \t\t\t\t\t\t\tused to specify the number of pixels in width of the cell in that section.\n\t * \t\t\t\t\t\tonChange Function Callback fired when the user has changed the value of the input.\n\t * \t\t\t\t\t\t\tIt receives a single object with:\n\t * \t\t\t\t\t\t\t- newValue: the incoming value\n\t * \t\t\t\t\t\t\t- oldValue: the previous value\n\t * \t\t\t\t\t\t\t- dataKey: schemaNode.id of the edited field\n\t * \t\t\t\t\t\t\t- dataContext: the data object being edited (row or nested object)\n\t * \t\t\t\t\t\t\t- schemaNode: schema node for the edited field\n\t * \t\t\t\t\t\t\t- instanceNode: the instance node if in details\n\t * \t\t\t\t\t\t\t- closestMeta: function(key) to read meta data closest to the schema node. In the schema\n\t * \t\t\t\t\t\t\t\tobjects may be specified via \"meta\" propert and this object may contain any custom\n\t * \t\t\t\t\t\t\t\tdata. This function allows reading that data easily. It traverses up the schema tree\n\t * \t\t\t\t\t\t\t\tuntil it finds a meta with the specified key or reaches the root.\n\t * \t\t\t\t\t\t\t- cancelUpdate: function() to prevent the value from being persisted\n\t * \t\t\t\t\t\tonBlur Function Callback fired when cellcursor goes from being inside the container\n\t * \t\t\t\t\t\t\tto outside. It will get passed arguments 1:instanceNode, 2:mainIndex\n\t * \t\t\t\t\t\tenabled Function - If present then this function will be run and if it returns falsey then\n\t * \t\t\t\t\t\t\tthe cell will not be editable. It may also return an object structured as:\n\t * \t\t\t\t\t\t\t{enabled:Bool, message:String}. The message will be displayed to the user \n\t * \t\t\t\t\t\t\tif edit is attempted and enabled is set to false, disabling the field\n\t * \t\t\t\t\t\t\tIt gets passed the following arguments - \n\t * \t\t\t\t\t\t\t1:schemaNode,2:rowData,3:mainIndex,4:instanceNode(if in details)\n\t * \t\t\t\t\t----Properties specific to input \"text\"----\n\t * \t\t\t\t\t\tformat object When defined, Tablance automatically applies the specified pattern to \n\t * \t\t\t\t\t\t\tthe <input> element as the user types. It can enforce numeric-only input, insert\n\t * \t\t\t\t\t\t\tdelimiters, and handle smart date validation.\n\t * \t\t\t\t\t\t\tSupported properties:\n\t * \t\t\t\t\t\t\t - blocks:        \t\t\tArray of block lengths to group the input (e.g. [4,2,2])\n\t * \t\t\t\t\t\t\t - delimiter:     \t\t\tString inserted between blocks (default: none)\n\t * \t\t\t\t\t\t\t - numericOnly:   \t\t\tBoolean, removes all non-digit characters\n\t * \t\t\t\t\t\t\t - date:          \t\t\tBoolean, enables smart date validation\n\t * \t\t\t\t\t\t\t - stripDelimiterOnSave:\tBoolean, if true delimiters are excluded in the saved data\n\t * \t\t\t\t\t\t\tExamples:\n\t * \t\t\t\t\t\t\t// Personnummer: 19900218-9999\n\t * \t\t\t\t\t\t\tinput: {\n\t * \t\t\t\t\t\t\t\ttype: \"text\",\n\t * \t\t\t\t\t\t\t\tformat: { blocks: [8, 4], delimiter: \"-\", numericOnly: true }\n\t * \t\t\t\t\t\t\t}\n\t * \t\t\t\t\t\t\t// Date (YYYY-MM-DD) with month/day clamping and leap-year handling\n\t * \t\t\t\t\t\t\tinput: {\n\t * \t\t\t\t\t\t\t\ttype: \"text\",\n\t * \t\t\t\t\t\t\t\tformat: { date: true, blocks: [4, 2, 2], delimiter: \"-\", numericOnly: true }\n\t * \t\t\t\t\t\t\t}\n\t * \t\t\t\t\t\t\t\n\t * \t\t\t\t\t\tmaxLength int Sets max-length for the string\t\t\t\t\t\t\t\n\t * \t\t\t\t\t----Properties specific to input \"textarea\"----\n\t * \t\t\t\t\t\tmaxHeight int Sets the max-height in pixels that it should be able to be resized to\n\t * \t\t\t\t\t----Properties specific to input \"file\"----\n\t * \t\t\t\t\t\tfileUploadHandler Function This callback will be triggered when the user does a file-upload.\n\t * \t\t\t\t\t\t\tArguments: 1:XMLHttpRequest - call open() on this to specify url and such,\n\t * \t\t\t\t\t\t\t2: The File-object, 3:schemaNode,4:rowData,5:mainIndex,6:instanceNode(if in details)\n\t * \t\t\t\t\t\tfileMetasToShow Object An object specifying which meta-bits to show. Default of all are true\n\t * \t\t\t\t\t\t\t{filename Bool, lastModified Bool, size Bool, type Bool}\n\t * \t\t\t\t\t\t\tMay also be set via opts->defaultFileMetasToShow\n\t * \t\t\t\t\t\topenHandler Function callback-function for when the open-button is pressed. It gets the\n\t * \t\t\t\t\t\t\tfollowing arguments passed to it: \n\t * \t\t\t\t\t\t\t1: Event, 2: File-object, 3:schemaNode,4:rowData,5:mainIndex,\n\t * \t\t\t\t\t\t\t6:instanceNode(if in details)\n\t * \t\t\t\t\t\tdeleteHandler Function callback-function for when the user deletes a file. It gets the \n\t * \t\t\t\t\t\t\tfollowing arguments passed to it:\n\t * \t\t\t\t\t\t\t1: Event, 2: File-object, 3:schemaNode,4:rowData,5:mainIndex,\n\t * \t\t\t\t\t\t\t6:instanceNode(if in details)\n\t * \t\t\t\t\t----Properties specific to input \"select\"----\n\t * \t\t\t\t\t\tminOptsFilter Integer - The minimum number of options required for the filter-input to\n\t * \t\t\t\t\t\t\tappear. Can also be set via param opts->defaultMinOptsFilter\n\t * \t\t\t\t\t\tnoResultsText String A string which is displayed when a user filters the \n\t * \t\t\t\t\t\t\toptions in a select and there are no results. \n\t * \t\t\t\t\t\t\tCan also be set globally via param opts->lang->selectNoResultsFound\n\t * \t\t\t\t\t\toptions: Array Each element should be an object: {\n\t * \t\t\t\t\t\t\tvalue * The value of the cell will be mapped to the option with the same value\n\t * \t\t\t\t\t\t\ttext String Unless a render-method has been set then this string will be shown\n\t * \t\t\t\t\t\t\tpinned Bool If true then this option will be pinned at the top. Default is false\n\t * \t\t\t\t\t\t\tcssClass: Css-classes to be added to the opt which actually is a li-element\n\t * \t\t\t\t\t\t}\n\t * \t\t\t\t\t\tallowCreateNew bool - Allows user to create new options.\n\t * \t\t\t\t\t\t\t\tIf this is true then minOptsFilter will be ignored, input-field is required anyway.\n\t * \t\t\t\t\t\tcreateNewOptionHandler Function - Callback which is called when the user creates a new \n\t * \t\t\t\t\t\t\toption, which can be done if allowCreateNew is true. It will get passed arguments \n\t * \t\t\t\t\t\t\t1:new option-object,2:event, 3:dataObject,4:mainDataIndex,\n\t * \t\t\t\t\t\t\t5:schemaNode,6:instanceNode(if inside details)\n\t * \t\t\t\t\t\tselectInputPlaceholder String - A placeholder for the input which is\n\t * \t\t\t\t\t\t\tvisible either if the number of options exceed minOptsFilter or allowCreateNew is true\n\t * \t\t\t\t\t}\n\t * \t\t\t\t\t----Properties specific to input \"button\"----\n\t * \t\t\t\t\t\tbtnText String If type is \"button\" then this will be the text on it\n\t * \t\t\t\t\t\tclickHandler Function A callback-function that will get called  when the button is pressed. \n\t * \t\t\t\t\t\t\tIt will get passed arguments 1:event, 2:dataObject\n\t * \t\t\t\t\t\t\t,3:mainDataIndex,4:schemaNode,5:instanceNode(if inside details)\n  \t * \t\t\t\t}\n\t * \t\t\t}\n\t * \t\t\t{\n  \t * \t\t\t\ttype:\"repeated\" Used for \"repeated\" sets of data. The same data-structure is repeated as many times \n\t * \t\t\t\t\tas there are data for it. This also allows adding/removing data on the fly and besides doing it \n\t * \t\t\t\t\tprogramatically there's a built in interface for the user to do that.\n\t * \t\t\t\t\tHaving a list-structure with a repeated->field basically works the same as having a list with\n\t * \t\t\t\t\tmultiple field-structures. List-structures can mix repeated(dynamic) and static fields.\n\t * \t\t\t\t\tThe structure could look something like:\n\t * \t\t\t\t\t\t\t\tlist\n\t * \t\t\t\t\t\t\t\t\trepeated\n\t * \t\t\t\t\t\t\t\t\t\tfield\n\t * \t\t\t\t\t\t\t\t\tfield1\n\t * \t\t\t\t\t\t\t\t\tfield2\n  \t * \t\t\t\tid String this should be the key of an array in the data where each object corresponds to each\n\t * \t\t\t\t\t\t\telement in this repeated rows.\n  \t * \t\t\t\tentry Object Any entry. May be item or list for instance. The data retrieved for these will be 1\n\t * \t\t\t\t\t\t\t\tlevel deeper so the path from the base would be idOfRepeatedRows->arrayIndex->*\n\t * \t\t\t\tcreate: Bool If true then there will be a user-interface for creating and deleting entries\n\t * \t\t\t\tonCreate Function Callback fired when the user has created an entry via the interface available if\n\t * \t\t\t\t\t\"create\" is true. It is considered committed when the cell-cursor has left the repeat-row after\n\t * \t\t\t\t\thaving created it. Receives a single object:\n\t * \t\t\t\t\t- newDataItem: the newly created data object\n\t * \t\t\t\t\t- dataContext: the object owning the repeated array (row-data or nested object)\n\t * \t\t\t\t\t- dataKey: key on dataContext for the repeated array (repeated schema id)\n\t * \t\t\t\t\t- dataArray: the array the item-data was inserted into\n\t * \t\t\t\t\t- itemIndex: index of the new item within dataArray\n\t * \t\t\t\t\t- repeatedSchemaNode: the repeated container schema node\n\t * \t\t\t\t\t- entrySchemaNode: the schema node for the created entry (often a group)\n\t * \t\t\t\t\t- newInstanceNode: the instance node for the created entry\n\t * \t\t\t\t\t- mainIndex: index of the root row\n\t * \t\t\t\t\t- bulkEdit: true if triggered from bulk-edit\n\t * \t\t\t\t\t- closestMeta: function(key) to read meta data closest to the schema node\n\t * \t\t\t\t\t- cancelCreate: function() to abort the creation (removes the new item)\n\t * \t\t\t\tonCreateOpen Function If the entry of the repeated is group and \"create\" is set to true, then this\n\t * \t\t\t\t\tcallback-function will be called when a new group is added, i.e. when the user interacts with\n\t * \t\t\t\t\tinsertNew-cell, not when the data is actually created, that triggers \"onCreate\".\n\t * \t\t\t\t\tIt will get passed arguments: 1:instanceNode of the repeated-object\n\t * \t\t\t\tonCreateCancel Function If the entry of the repeated is group and \"create\" is set to true, then this\n\t * \t\t\t\t\tcallback-function will be called when the creation of a new entry is canceled, either by leaving\n\t * \t\t\t\t\tthe group with no data inserted, or by pressing the delete/cancel-button.\n\t * \t\t\t\t\tIt will get passed arguments: 1:instanceNode of the repeated-object\n\t * \t\t\t\tonDelete Function Callback fired when the user has deleted an entry via the interface available if\n\t * \t\t\t\t\t\"create\" is true. It will get passed arguments: 1:rowData,2:instanceNode\n\t * \t\t\t\tsortCompare Function Passing in a function allows for sorting the entries. As expected this\n\t * \t\t\t\t\tfunction will get called multiple times to compare the entries to one another.\n\t * \t\t\t\t\tIt gets 4 arguments: 1: object A, 2: object B, 3: rowData, 4: instanceNode\n\t * \t\t\t\t\tReturn >0 to sort A after B, <0 to sort B after A, or ===0 to keep original order of A and B\n\t * \t\t\t\tcreationText String Used if \"create\" is true. the text of the creation-cell. Default is \"Insert new\"\n\t * \t\t\t\t\tMay also be set via opts->lang->insertNew\n\t * \t\t\t\tdeleteText String used if \"create\" is true. the text of the deletion-button. Default is \"Delete\"\n\t * \t\t\t\t\tcan also be set via param opts->lang->delete\n\t * \t\t\t\tdeleteAreYouSureText String Used if \"create\" is true. Text above yes/no-btns.\n\t * \t\t\t\t\tDefault is \"Are you sure?\". Can also be set via param opts->lang->deleteAreYouSure\n\t * \t\t\t\tareYouSureYesText String Used if \"create\" is true. Text of confirm-button for delete.\n\t * \t\t\t\t\tDefault is \"Yes\". Can also be set via param opts->lang->deleteAreYouSureYes\n\t * \t\t\t\tareYouSureNoText String Used if \"create\" is true. Text of cancel-button for delete. Default is \"No\"\n\t * \t\t\t\t\tCan also be set via param opts->lang->deleteAreYouSureNo\n\t * \t\t\t\tbulkEdit Bool If set to true then this will appear in the bulk-edit-area which allows editing\n\t * \t\t\t\t\trepeated data for multiple data-rows at once. Applying the data does not append the data but it\n\t * \t\t\t\t\treplaces it meaning the repeated rows already present in the selected rows are removed.\n  \t * \t\t\t}\n  \t * \t\t\t{\n  \t * \t\t\t\ttype \"group\" Used when a set of data should be grouped. An example is when having an address and\n\t * \t\t\t\t\tall the rows in it belongs together. The group also has to be entered/opened with enter/dblclick\n  \t * \t\t\t\ttitle String String displayed title if placed in a container which displays the title\n\t * \t\t\t\tcssClass String Css-classes to be added to the group\n  \t * \t\t\t\tentries Array Array of entries. fields, lists, etc.. \n\t * \t\t\t\tclosedRender Function pass a method here that will get the data for the group as first arg.\n\t * \t\t\t\t\t\t\t\tit needs to return a string which will replace the group-content when it is closed\n\t * \t\t\t\tcreationValidation Function If this group is placed within a repeated-container with create set to\n\t * \t\t\t\t\t\t\t\ttrue then this function will be executed upon commiting the creation. If the\n\t * \t\t\t\t\t\t\t\tfunction returns true then the validation succeeded and the group will be created.\n\t * \t\t\t\t\t\t\t\tIt will get passed the following arguments:\n\t * \t\t\t\t\t\t\t\t1: message-function - A function that that takes a message-string as its first\n\t * \t\t\t\t\t\t\t\t\targument. If it the validation didn't go through then this string will be\n\t * \t\t\t\t\t\t\t\t\tdisplayed to the user.\n\t * \t\t\t\t\t\t\t\t2:schemaNode, 3:rowData(all the entered data of the group), 4:mainIndex, \n\t * \t\t\t\t\t\t\t\t5:instanceNode\n\t * \t\t\t\tbulkEdit Bool Besides setting bulkEdit on input of fields it can also be set on containers which\n\t * \t\t\t\t\t\t\twill add the container to the bulk-edit-area. Any input-fields in the container that\n\t * \t\t\t\t\t\t\thave bulkEdit true will appear in the container there. Remember that both the container\n\t * \t\t\t\t\t\t\tand input of fields have to have true bulkEdit for this to work. These can also be\n\t * \t\t\t\t\t\t\tnested so if there's another group in the group where both have true bulkEdit and the\n\t * \t\t\t\t\t\t\tinner group has inputs with true bulkEdit as well then multi-level groups will be \n\t * \t\t\t\t\t\t\tadded to the bulk-edit-area. Containers in the bulk-edit-area appear as a normal cell\n\t * \t\t\t\t\t\t\tat first but by entering it a page dedicated to that container is changed to.\n\t * \t\t\t\tonOpen Function Function that fires when the group is opened, before it has been rendered.\n\t * \t\t\t\t\tGets passed the following arguments:\n\t * \t\t\t\t\t1: tablanceEvent-object. It has a preventDefault-function that can be called in order to\n\t * \t\t\t\t\tprevent the group from actually opening. 2: group-object\n\t * \t\t\t\tonOpenAfter Function Function that fires when the group is opened, but after it has been rendered.\n\t * \t\t\t\t\tGets passed the following arguments:\n\t * \t\t\t\t\t1: group-object\n\t * \t\t\t\tonClose Function Callback that is fired when the group closes. Gets passed the following arguments:\n\t * \t\t\t\t\t1: group-object\n  \t * \t\t\t}\n\t * \t@param\t{Object} opts An object where different options may be set. The following options/keys are valid:\n\t * \t\t\t\t\t\t\tsearchbar Bool that defaults to true. If true then there will be a searchbar that\n\t * \t\t\t\t\t\t\t\tcan be used to filter the data.\n\t * \t\t\t\t\t\t\tsortAscHtml String - html to be added to the end of the th-element when the column\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tis sorted in ascending order\n\t * \t\t\t\t\t\t\tsortDescHtml String - html to be added to the end of the th-element when the column\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tis sorted in descending order\n\t * \t\t\t\t\t\t\tsortNoneHtml String - html to be added to the end of the th-element when the column\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tis not sorted\n\t * \t\t\t\t\t\t\tdefaultMinOptsFilter Integer The minimum number of options required for the\n\t * \t\t\t\t\t\t\t\tfilter-input of input-type \"select\" to appear\n\t * \t\t\t\t\t\t\tdefaultFileMetasToShow Object Default meta-data for files to show.\n\t * \t\t\t\t\t\t\t\t\t\t\t\t\tSee prop fileMetasToShow in param details\n\t * \t\t\t\t\t\t\tlang Object {  Object to replace language-specific text. The strings may be html-code\n\t * \t\t\t\t\t\t\t\t\t\texcept for ones used as placeholders. Below are the keys and defaults.\n\t * \t\t\t\t\t\t\t\tfileName \"Filename\"\n\t * \t\t\t\t\t\t\t\tfileLastModified \"Last Modified\"\n\t * \t\t\t\t\t\t\t\tfileSize \"Size\"\n\t * \t\t\t\t\t\t\t\tfileType \"Type\"\n\t * \t\t\t\t\t\t\t\tfileUploadDone \"Done!\"\n\t * \t\t\t\t\t\t\t\tfileChooseOrDrag \"<b>Press to choose a file</b> or drag it here\"\n\t * \t\t\t\t\t\t\t\tfileDropToUpload \"<b>Drop to upload</b>\"\n\t *\t\t\t\t\t\t\t\tfilterPlaceholder \"Search\"\n\t * \t\t\t\t\t\t\t\tdelete \"Delete\" (used in the deletion of repeat-items or files)\n\t * \t\t\t\t\t\t\t\tdeleteAreYouSure \"Are you sure?\" (Used in the deletion of repeat-items or files)\n\t * \t\t\t\t\t\t\t\tdeleteAreYouSureYes \"Yes\"  (Used in the deletion of repeat-items or files)\n\t * \t\t\t\t\t\t\t\tdeleteAreYouSureNo\t\"No\" (Used in the deletion of repeat-items)\n\t * \t\t\t\t\t\t\t\tdatePlaceholder \"YYYY-MM-DD\"\n\t * \t\t\t\t\t\t\t\tselectNoResultsFound \"No results found\"\n\t * \t\t\t\t\t\t\t\tinsertNew \"Insert New\" (Used in repeat-schemaNode if create is set to true)\n\t * \t\t\t\t\t\t\t}\n\t * */\n\tconstructor(hostEl,schema,staticRowHeight=false,spreadsheet=false,opts=null){\n\t\tthis.hostEl=hostEl;\n\t\tconst rootEl=this.rootEl = document.createElement(\"div\");\n\t\tthis.hostEl.appendChild(this.rootEl);\n\t\tthis._spreadsheet=spreadsheet;\n\t\tthis._staticRowHeight=staticRowHeight;\n\t\tthis._opts=opts??{};\n\t\trootEl.classList.add(\"tablance\");\n\t\tthis._schema=this._buildSchemaFacade(schema);\n\t\tif (!schema.main?.columns) {\n\t\t\tthis._setupSpreadsheet(true);\n\t\t\tthis._onlyDetails=true;\n\t\t} else {\n\t\t\t// for (let col of this._schema.main.columns) {\n\t\t\t// \tlet processedCol={};\n\t\t\t// \tif ((col.type==\"expand\"||col.type==\"select\")&&!col.width)\n\t\t\t// \t\tprocessedCol.width=50;\n\t\t\t// \tfor (let [colKey,colVal] of Object.entries(col))\n\t\t\t// \t\t//if (allowedColProps.includes(colKey))\n\t\t\t// \t\t\tprocessedCol[colKey]=colVal;\n\t\t\t// \tthis._colSchemaNodes.push(processedCol);\n\t\t\t// }\n\t\t\tthis._colSchemaNodes=this._schema.main.columns;\n\t\t\tif (this._opts.searchbar!=false)\n\t\t\t\tthis._setupSearchbar();\n\t\t\tthis._createTableHeader();\n\t\t\tthis._createTableBody();\n\t\t\t(new ResizeObserver(this._updateSizesOfViewportAndCols.bind(this))).observe(hostEl);\n\t\t\tthis._setupSpreadsheet(false);\n\t\t\t\n\n\t\t\tif (this._opts.sortAscHtml==null)\n\t\t\t\tthis._opts.sortAscHtml='<svg viewBox=\"0 0 8 10\" style=\"height:1em\"><polygon style=\"fill:#ccc\" '\n\t\t\t\t\t\t\t\t\t+'points=\"4,0,8,4,0,4\"/><polygon style=\"fill:#000\" points=\"4,10,0,6,8,6\"/></svg>';\n\t\t\tif (this._opts.sortDescHtml==null)\n\t\t\t\tthis._opts.sortDescHtml='<svg viewBox=\"0 0 8 10\" style=\"height:1em\"><polygon style=\"fill:#000\" '\n\t\t\t\t\t\t\t\t\t+'points=\"4,0,8,4,0,4\"/><polygon style=\"fill:#ccc\" points=\"4,10,0,6,8,6\"/></svg>';\n\t\t\tif (this._opts.sortNoneHtml==null)\n\t\t\t\tthis._opts.sortNoneHtml='<svg viewBox=\"0 0 8 10\" style=\"height:1em\"><polygon style=\"fill:#ccc\" '\n\t\t\t\t\t\t\t\t\t+'points=\"4,0,8,4,0,4\"/><polygon style=\"fill:#ccc\" points=\"4,10,0,6,8,6\"/></svg>';\n\t\t\tthis._updateHeaderSortHtml();\n\t\t\tthis._buildDependencyGraph(this._schema);\n\t\t\tthis._createBulkEditArea(schema);//send in the raw schema for this one\n\t\t\tthis._updateSizesOfViewportAndCols();\n\t\t}\n\t}\n\n\taddData(data, highlight=false) {\n\t\tif (this._onlyDetails)\n\t\t\treturn this._setDataForOnlyDetails(data)\n\t\tconst oldLen=this._data.length;\n\t\tif (highlight)\n\t\t\tthis._searchInput.value=this._filter=\"\";//remove any filter\n\t\tthis._data=this._allData=this._allData.concat(data);\n\t\t//this._data.push(...data);//much faster than above but causes \"Maximum call stack size exceeded\" for large data\n\t\tlet sortingOccured=this._sortData();\n\t\tif (this._filter)\n\t\t\tthis._filterData(this._filter);\n\t\telse {\n\t\t\tif (sortingOccured)\n\t\t\t\tthis._refreshTable();\n\t\t\telse\n\t\t\t\tthis._maybeAddTrs();\n\t\t\tconst numNewInData=this._data.length-oldLen;\n\t\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height||0)+numNewInData*this._rowHeight+\"px\";\n\t\t}\n\t\tif (highlight) {\n\t\t\tfor (let dataRow of data)\n\t\t\t\tthis._highlightRowIndex(this._data.indexOf(dataRow));\n\t\t\tthis.scrollToDataRow(data[0],false);//false for not highlighting, above line does the highlight anyway\n\t\t}\n\t}\n\n\t/**Change or add any data in the table\n\t * @param {int|object} dataRow_or_mainIndex Either the actual data-object that should be updated, or its index in\n\t * \t\t\t\t\t\t\t\t\t\t\tthe current view\n\t * @param {string|string[]} dataPath The path to the data-value that should be updated or added to. For a value in\n\t * \t\t\tthe base which is not nested within repeated-containers it should simply be the id of the property.\n\t * \t\t\tIt can either be a string of keys separated by dots(.) or an array where each element is a key.\n\t * \t\t\tFor repeated-arrays which data should be added to, \"[]\" can be used similiar to how it's done in PHP.\n\t * \t\t\tFor instance the path could be \"foo[]\" or \"foo[].bar\". Objects/arrays will be created recursively\n\t * \t\t\tif they don't yet exist.\n\t * @param {*} newData The actual data to be replaced with or added\n\t * @param {bool} scrollTo Whether the modified/added data should be scrolled to and highlighted.\n\t * @param {bool} onlyRefresh If true then no new data will be written and argument \"data\" will be ignored.\n\t * \t\t\t\t\t\t\tThe cell will only be refreshed with the value already present in the data.\n\t * @returns The tablance-object, for chaining*/\n\tupdateData(dataRow_or_mainIndex,dataPath,newData,scrollTo=false,onlyRefresh=false) {\n\t\tlet dataRow;//simply an element from #data, e.g. a whole dataset for a row of the maintable.\n\t\tlet mainIndx;//the index of dataRow\n\t\tlet updatedEls=[];\n\t\tif (!isNaN(dataRow_or_mainIndex))\n\t\t\tdataRow=this._data[mainIndx=dataRow_or_mainIndex];\n\t\telse //if (typeof dataRow_or_mainIndex==\"object\")\n\t\t\tmainIndx=this._data.indexOf(dataRow=dataRow_or_mainIndex);\n\t\tdataPath=typeof dataPath==\"string\"?dataPath.split(/\\.|(?=\\[\\d*\\])/):dataPath;\n\n\t\tif (!onlyRefresh) {//if we're not only refreshing the cell but actually modifying/adding data\n\t\t\t//update the actual data, deal with the dom later\n\t\t\tlet dataPortion=dataRow;//object that is going to have a property updated, or array that will be pushed to\n\t\t\tfor (let i=0; i<dataPath.length; i++) {\n\t\t\t\tconst key=i%2?dataPath[i].replace(/^\\[|\\]$/g,\"\"):dataPath[i];//get rid of brackets. \n\t\t\t\t//key is now either property-name, string-int for index, or empty string for pushing\n\t\t\t\tif (i==dataPath.length-1)//if last step\n\t\t\t\t\tdataPortion[key||dataPortion.length]=newData;//assign the data\n\t\t\t\telse if (!key)//not last step and empty string, meaning push\n\t\t\t\t\tdataPortion=dataPortion[dataPortion.length]={};//do push\n\t\t\t\telse//not last step and key is index or property-name\n\t\t\t\t\tdataPortion=dataPortion[key]??(dataPortion[key]=i%2?[]:{});\n\t\t\t}\n\t\t}\n\n\t\tif (mainIndx<this._scrollRowIndex||mainIndx>=this._scrollRowIndex+this._numRenderedRows)\n\t\t\treturn;//the row to be updated is outside of view. It'll be updated automatically if scrolled into view\n\t\t\n\t\t//is it a column of the main-table?\n\t\tif (dataPath.length==1) //it's possible only if the path is a single id-key. (but still not guaranteed)\n\t\t\tfor (let colI=-1,colSchemaNode;colSchemaNode=this._colSchemaNodes[++colI];)\n\t\t\t\tif (colSchemaNode.id==dataPath[0]) {//if true then yes, it was a column of main-table\n\t\t\t\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${mainIndx}\"]:not(.details)`);\n\t\t\t\t\treturn this._updateMainRowCell(tr.cells[colI],colSchemaNode);//update it and be done with this\n\t\t\t\t}\n\n\t\t//The data is somewhere in details\n\t\t\n\t\tlet nodeToUpdate=this._openDetailsPanes[mainIndx];//points to the instance-node that will be subject for update\n\t\tif (!nodeToUpdate)//if the updates details is not open\n\t\t\treturn;\n\n\t\t//look through the celObjToUpdate and its descendants-tree (currently set to whole details), following the\n\t\t//dataPath. At the end of this loop celObjToUpdate should be set to the deepest down object that dataPath points\n\t\t//to, and pathIndex should be the index in dataPath that is the last step pointing to celObjToUpdate.\n\t\t//When simply editing an already existing field then celObjToUpdate would be the container of that cell, and\n\t\t//pathIndex would be set to the index of the last element in dataPath\n\t\tfor (let i=0,instanceNodeId; instanceNodeId=dataPath[i]; i+=2) {\n\t\t\tconst arrayIndex=dataPath[i+1]?.replace(/^\\[|\\]$/g,\"\");\n\t\t\tnodeToUpdate=this._findDescendantInstanceNodeById(nodeToUpdate,instanceNodeId);\n\t\t\tif (nodeToUpdate.schemaNode.type==\"repeated\") {//should be true until possibly last iteration\n\t\t\t\tif (i==dataPath.length-1) {//final array-index not specified. replace all of the data in repeated\n\n\t\t\t\t\t//remove all the current entries. Do it backwards so that the remaining entries doesn't have to\n\t\t\t\t\t//have their index&path updates each time\n\t\t\t\t\tconst children=nodeToUpdate.children;\n\t\t\t\t\tfor (let entryI=children.length-!!nodeToUpdate.schemaNode.create,entry; entry=children[--entryI];)\n\t\t\t\t\t\tthis._deleteCell(entry,true);\n\n\t\t\t\t\t//insert all the new data\n\t\t\t\t\tnodeToUpdate.dataObj=nodeToUpdate.parent.dataObj[nodeToUpdate.schemaNode.id];\n\t\t\t\t\tnodeToUpdate.dataObj.forEach(\n\t\t\t\t\t\t\t\t\tdataEntry=>updatedEls.push(this._repeatInsert(nodeToUpdate,false,dataEntry)));\n\t\t\t\t\tbreak;\n\t\t\t\t} else if (arrayIndex) {//index pointing at existing repeated-child\n\t\t\t\t\tnodeToUpdate=nodeToUpdate.children[arrayIndex];\n\t\t\t\t} else {//[] - insert new\n\t\t\t\t\tupdatedEls.push(this._repeatInsert(nodeToUpdate,false,nodeToUpdate.dataObj.at(-1)));\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (nodeToUpdate.schemaNode.type==\"field\")\n\t\t\tthis._updateDetailsCell(nodeToUpdate,dataRow);\n\t\tif (scrollTo) {\n\t\t\tnodeToUpdate.el.scrollIntoView({behavior:'smooth',block:\"center\"});\n\t\t\tupdatedEls.forEach(el=>this._highlightElements([el,...el.getElementsByTagName('*')]));\n\t\t}\n\t\tthis._adjustCursorPosSize(this._selectedCell,true);\n\t}\n\n\t/**\n\t * Build a wrapped-schema tree from the raw user schema.\n\t *\n\t * RULES:\n\t * - The raw schema is never cloned or mutated.\n\t * - Only schema-structure keys (main, details, columns, entry, entries) are recursed into.\n\t * - Config objects (input, meta, validators, etc.) are ignored and never wrapped.\n\t * - The wrapper tree mirrors schema structure but contains only:\n\t *       { raw: <raw node>, parent: <wrapped parent>, and wrapped children }\n\t * @param {*} rawSchema\tThe user-provided schema node.\n\t * @param {*} parentWrappedNode The wrapped parent, if any.\n\t * @returns {*}         The root wrapped schema-node.\n\t */\n\t_buildSchemaFacade(rawNode, parentWrappedNode=null) {\n\n\t\t// Reject null/undefined & non-objects. Could be left for isPojo-check but that throws error on undefined\n\t\tif (!rawNode || typeof rawNode!=\"object\")\n\t\t\treturn null;\n\n\t\t// Already wrapped? Return as-is to avoid double wrapping.\n\t\tif (rawNode[SCHEMA_WRAPPER_MARKER])\n\t\t\treturn rawNode;\n\n\t\t// Accept only POJOs and arrays.\n\t\t// This ensures we only traverse expected schema structures\n\t\t// and never recurse into exotic/custom objects.\n\t\tconst proto = Object.getPrototypeOf(rawNode);\n\t\tconst isPojo = proto===Object.prototype || proto===null;\n\t\tif (!isPojo && !Array.isArray(rawNode))\n\t\t\treturn null;\n\n\t\t//const wrappedNode = Object.assign(Object.create(null), {raw: rawNode,parent: parentWrappedNode});\n\t\tconst wrappedNode = createSchemaNodeFacade(rawNode, parentWrappedNode);\n\n\t\t// ---- CHILD NODE PROCESSING ----\n\t\t// We recurse ONLY into known schema-node containers.\n\t\t// Everything else inside the raw schema object is left untouched.\n\n\t\t// main\n\t\tif (rawNode.main && typeof rawNode.main==\"object\")\n\t\t\twrappedNode.main = this._buildSchemaFacade(rawNode.main, wrappedNode);\n\n\t\t// details\n\t\tif (rawNode.details && typeof rawNode.details==\"object\")\n\t\t\twrappedNode.details = this._buildSchemaFacade(rawNode.details, wrappedNode);\n\n\t\t// columns (array of schema-nodes)\n\t\tif (Array.isArray(rawNode.columns)) {\n\t\t\tconst cols = [];\n\t\t\tfor (const col of rawNode.columns) {\n\t\t\t\tconst wrappedCol = this._buildSchemaFacade(col, wrappedNode);\n\t\t\t\tif (wrappedCol)\n\t\t\t\t\tcols.push(wrappedCol);\n\t\t\t}\n\t\t\tif (cols.length)\n\t\t\t\twrappedNode.columns = cols;\n\t\t}\n\n\t\t// entry (single schema-node)\n\t\tif (rawNode.entry && typeof rawNode.entry==\"object\")\n\t\t\twrappedNode.entry = this._buildSchemaFacade(rawNode.entry, wrappedNode);\n\n\t\t// entries (multiple schema-nodes)\n\t\tif (Array.isArray(rawNode.entries)) {\n\t\t\tconst arr = [];\n\t\t\tfor (const child of rawNode.entries) {\n\t\t\t\tconst wrappedChild = this._buildSchemaFacade(child, wrappedNode);\n\t\t\t\tif (wrappedChild)\n\t\t\t\t\tarr.push(wrappedChild);\n\t\t\t}\n\t\t\twrappedNode.entries = arr;\n\t\t}\n\n\t\treturn wrappedNode;\n\n\t\tfunction createSchemaNodeFacade(rawNode, parentWrappedNode) {\n\t\t\tconst newWrapper = Object.assign(Object.create(null), {raw: rawNode, [SCHEMA_WRAPPER_MARKER]: true});\n\t\t\tif (parentWrappedNode)\n\t\t\t\tnewWrapper.parent = parentWrappedNode;\n\t\t\treturn new Proxy(newWrapper, {\n\t\t\t\tget:(target, prop)=>SCHEMA_WRAPPER_KEYS.has(prop)?target[prop]:target.raw[prop],\n\t\t\t\tset(target, prop, value) {\n\t\t\t\t\tif (SCHEMA_WRAPPER_KEYS.has(prop)) {\n\t\t\t\t\t\ttarget[prop] = value;\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\tthrow new Error(`Cannot write ${prop} to schema-node. Add it to SCHEMA_WRAPPER_KEYS if intended.`);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\n\n\t/**\n\t * Searches upward through schema-node parents to find a meta value.\n\t * @param {*} startNode  The schema-node where the search begins.\n\t * @param {string} metaKey  The meta key to look for.\n\t * @returns {*} The found value or undefined.\n\t */\n\t_closestMeta(startNode, metaKey) {\n\t\tfor (let node=startNode; node; node=node.parent)\n\t\t\tif (node.meta && metaKey in node.meta)\n\t\t\t\treturn node.meta[metaKey];\n\t}\n\n\t_findDescendantInstanceNodeById(searchInObj,idToFind) {\n\t\tfor (const child of searchInObj.children)\n\t\t\tif (child.schemaNode.id==idToFind)//if true then its the repeated-obj we're looking for\n\t\t\t\treturn child;\n\t\t\telse if (child.children) {//if container-obj\n\t\t\t\tconst result=this._findDescendantInstanceNodeById(child,idToFind);\n\t\t\t\tif (result)\n\t\t\t\t\treturn result;\n\t\t\t}\n\t}\n\n\t/**Expands a row and returns the details instance-tree root.\n\t * @param int mainIndex\n\t * @returns Object Root instance-node (outer-most instanceNode)*/\n\texpandRow(mainIndex) {\n\t\tif (this._onlyDetails)\n\t\t\treturn this._openDetailsPanes[0];\n\t\tlet tr=this._mainTbody.querySelector(`[data-data-row-index=\"${mainIndex}\"]`);\n\t\tif (!tr) {\n\t\t\tthis.scrollToDataRow(this._data[mainIndex],false,false);\n\t\t\tthis._scrollMethod();//needed to get everythig to render before having to wait for next frame\n\t\t\ttr=this._mainTbody.querySelector(`[data-data-row-index=\"${mainIndex}\"]`);\n\t\t}\n\t\tthis._expandRow(tr);\n\t\treturn this._openDetailsPanes[mainIndex];\n\t}\n\n\tscrollToDataRow(dataRow,highlight=true,smooth=true) {\n\t\tlet scrollY=0;\n\t\tfor (let i=-1,otherDataRow;otherDataRow=this._data[++i];) {\n\t\t\tif (otherDataRow==dataRow) {\n\t\t\t\tscrollY=scrollY-this._scrollBody.offsetHeight/2+this._rowHeight;\n\t\t\t\tthis._scrollBody.scrollTo({top:scrollY,behavior:smooth?\"smooth\":\"auto\"});\n\t\t\t\tif (highlight)\n\t\t\t\t\tthis._highlightRowIndex(i);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tscrollY+=this._rowMetaGet(i)?.h??this._rowHeight;\n\t\t}\n\t}\n\n\t/**Use this method to set neighbourTables automatically by just supplying all the other tables. It will figure out\n\t * in which order they appear in the html and set neighbourTables accordingly.\n\t * @param  {...Tablance} otherTablances */\n\tchainTables(...otherTablances) {\n\t\tconst tablances=[this,...otherTablances];\n\t\ttablances.sort(sort);\n\t\tfor (let i=-1,tablance;tablance=tablances[++i];)\n\t\t\ttablance.neighbourTables={up:tablances[i-1],down:tablances[i+1]};\n\t\tfunction sort(a,b) {\n\t\t\tlet elA=a.container, elB=b.container;\n\t\t\t//set elA to its (grand)parent which is the closest element where the parent also holds elB in its hiearchy\n\t\t\tfor (;!elA.parentElement.contains(elB);elA=elA.parentElement);\n\t\t\tconst commonCont=elA.parentElement;//the closest element that holds both elA and elB\n\t\t\t//set elB to the closest element that is a direct child of commonCont\n\t\t\tfor (;elA.parentElement!=elB.parentElement;elB=elB.parentElement);\n\t\t\treturn Array.from(commonCont.children).indexOf(elA)>Array.from(commonCont.children).indexOf(elB)?1:-1;\n\t\t}\n\t}\n\n\tselectTopBottomCellOnlyDetails(top) {\n\t\tthis._highlightOnFocus=false;\n\t\tthis._selectFirstSelectableDetailsCell(this._openDetailsPanes[0],top);\n\t}\n\n\t\n\t/**\n\t * Build a complete dependency graph and assign internal autoIds.\n\t *\n\t * This walks the wrapped schema tree (main.columns + details) and enriches each\n\t * schema-node with metadata needed for dependency resolution and runtime lookups.\n\t *\n\t * Permanent runtime metadata produced on wrapped schema-nodes:\n\t *  - dependencyPaths: UI-forward paths (dependee → dependent)\n\t *  - dependsOnCellPaths: reverse structural path(s) (exp→exp)\n\t *  - dependsOnDataPath: absolute data path for non-exp→exp deps\n\t *\n\t * Temporary builder-only metadata (removed in PASS 4):\n\t *  - _autoId\n\t *  - _path\n\t *  - _dataContextPath\n\t *  - _dataPath\n\t *\n\t * @param {*} schema\tRoot of the wrapped schema tree.\n\t */\n\t_buildDependencyGraph(schema) {\n\n\t\t//---- PASS 1 — Assign autoIds + collect ID maps ----\n\t\tconst ctx = this._dep_pass1_assignAutoIdsAndMaps(schema);\n\n\t\t//---- PASS 2 — Compute UI path & data paths ----\n\t\tthis._dep_pass2_assignPathsAndData(schema);\n\n\t\t//---- PASS 3 — Resolve dependsOn and build dependency metadata ----\n\t\tthis._dep_pass3_resolveDependencies(ctx);\n\n\t\t//---- PASS 4 — Cleanup: remove all temporary builder-only metadata ----\n\t\tthis._dep_pass4_cleanup(ctx);\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tPASS 1 — Assign autoIds + collect ID maps\n\t───────────────────────────────────────────────────────────*/\n\t_dep_pass1_assignAutoIdsAndMaps(wrappedSchema) {\n\t\tconst ctx = Object.create(null);\n\t\tctx.autoIdCounter      = 0;\n\t\tctx.explicitIdToAutoId = Object.create(null);\n\t\tctx.implicitIdToAutoId = Object.create(null);\n\t\tctx.schemaNodeByAutoId = Object.create(null);\n\t\tctx.seenCellIds        = Object.create(null);\n\n\t\tconst roots = [];\n\t\tconst cols = wrappedSchema.main && Array.isArray(wrappedSchema.main.columns)? wrappedSchema.main.columns: [];\n\t\tfor (let i = 0; i < cols.length; i++)\n\t\t\troots.push(cols[i]);\n\n\t\tif (wrappedSchema.details)\n\t\t\troots.push(wrappedSchema.details);\n\n\t\tctx.initialRoots = roots;\n\n\t\tlet stack = [...roots];\n\n\t\tfor (let schemaNode; schemaNode = stack.pop();) {\n\t\t\tconst autoId = ++ctx.autoIdCounter;\n\t\t\tschemaNode._autoId = autoId;\n\t\t\tctx.schemaNodeByAutoId[autoId] = schemaNode;\n\n\t\t\tif (schemaNode.cellId != null) {\n\t\t\t\tif (ctx.seenCellIds[schemaNode.cellId])\n\t\t\t\t\tthrow new Error(`Duplicate cellId \"${schemaNode.cellId}\".`);\n\t\t\t\tctx.seenCellIds[schemaNode.cellId] = true;\n\t\t\t\tctx.explicitIdToAutoId[schemaNode.cellId] = autoId;\n\t\t\t} else if (schemaNode.id != null)\n\t\t\t\tctx.implicitIdToAutoId[schemaNode.id] = autoId;\n\n\t\t\tstack.push(...this._dep_children(schemaNode));\n\t\t}\n\n\t\tctx.autoIdByName = Object.assign(\n\t\t\tObject.create(null),\n\t\t\tctx.implicitIdToAutoId,\n\t\t\tctx.explicitIdToAutoId\n\t\t);\n\n\t\treturn ctx;\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tPASS 2 — Assign _path, _dataContextPath, and _dataPath\n\t───────────────────────────────────────────────────────────*/\n\t_dep_pass2_assignPathsAndData(wrappedSchema) {\n\t\tif (wrappedSchema.details)\n\t\t\tthis._dep_assignPathsAndData(wrappedSchema.details, [], []);\n\n\t\tconst cols = wrappedSchema.main && Array.isArray(wrappedSchema.main.columns)? wrappedSchema.main.columns: [];\n\n\t\tfor (let i = 0; i < cols.length; i++)\n\t\t\tthis._dep_assignPathsAndData(cols[i], [\"m\", i], []);\n\t}\n\n\t_dep_assignPathsAndData(schemaNode, uiPath, parentCtx = []) {\n\t\tschemaNode._path = uiPath;\n\n\t\tlet myCtx=parentCtx;\n\t\tif (schemaNode.dataPath) {\n\t\t\tconst dataPathArr=Array.isArray(schemaNode.dataPath) ? schemaNode.dataPath\n\t\t\t\t: String(schemaNode.dataPath).split(\".\").filter(Boolean);\n\t\t\tmyCtx = [...parentCtx, ...dataPathArr];\n\t\t}\n\n\t\tschemaNode._dataContextPath = myCtx;\n\n\t\tif (schemaNode.id != null)\n\t\t\tschemaNode._dataPath = [...myCtx, String(schemaNode.id)];\n\n\t\tconst kids = this._dep_children(schemaNode);\n\n\t\tfor (let i = 0; i < kids.length; i++)\n\t\t\tthis._dep_assignPathsAndData(kids[i], [...uiPath, i], myCtx);\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tPASS 3 — Resolve dependsOn and build dependency metadata\n\t───────────────────────────────────────────────────────────*/\n\t_dep_pass3_resolveDependencies(ctx) {\n\t\tlet stack = [...ctx.initialRoots];\n\n\t\tfor (let schemaNode; schemaNode = stack.pop();) {\n\n\t\t\tif (schemaNode.dependsOn) {\n\t\t\t\tconst deps = Array.isArray(schemaNode.dependsOn) ? schemaNode.dependsOn : [schemaNode.dependsOn];\n\n\t\t\t\tconst dependentIsExp = schemaNode._path && schemaNode._path[0] !== \"m\";\n\t\t\t\tconst cellPaths = [];\n\t\t\t\tconst dataPaths = [];\n\n\t\t\t\tfor (const depName of deps) {\n\t\t\t\t\tconst depAutoId = ctx.autoIdByName[depName];\n\n\t\t\t\t\tif (depAutoId == null) {\n\t\t\t\t\t\tconsole.warn(`Unknown dependsOn \"${depName}\".`, schemaNode);\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst dependee = ctx.schemaNodeByAutoId[depAutoId];\n\t\t\t\t\tconst dependeeIsExp = dependee._path && dependee._path[0] !== \"m\";\n\n\t\t\t\t\tconst fwd = this._dep_computeForwardPath(dependee, schemaNode);\n\n\t\t\t\t\tif (fwd)\n\t\t\t\t\t\t(dependee.dependencyPaths ??= []).push(fwd);\n\n\t\t\t\t\tif (dependentIsExp && dependeeIsExp) {\n\t\t\t\t\t\tconst rev = this._dep_computeReversePath(schemaNode, dependee);\n\t\t\t\t\t\tif (rev && rev.length)\n\t\t\t\t\t\t\tcellPaths.push(rev);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (dependee._dataPath)\n\t\t\t\t\t\t\tdataPaths.push(dependee._dataPath);\n\t\t\t\t\t\telse if (dependee.id != null || dependee.cellId != null)\n\t\t\t\t\t\t\tconsole.warn(\"Dependee has no dataPath:\", dependee);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis._dep_finalizeDependency(schemaNode, cellPaths, dataPaths);\n\t\t\t}\n\n\t\t\tstack.push(...this._dep_children(schemaNode));\n\t\t}\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tPASS 4 — Cleanup: remove temporary builder-only metadata\n\t───────────────────────────────────────────────────────────*/\n\t_dep_pass4_cleanup(ctx) {\n\t\tlet stack = [...ctx.initialRoots];\n\n\t\tfor (let schemaNode; schemaNode = stack.pop();) {\n\t\t\tdelete schemaNode._autoId;\n\t\t\tdelete schemaNode._path;\n\t\t\tdelete schemaNode._dataContextPath;\n\t\t\tdelete schemaNode._dataPath;\n\t\t\tstack.push(...this._dep_children(schemaNode));\n\t\t}\n\t}\n\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Normalize schemaNode children\n\t\t- Skips nodes that only serve as wrappers (repeated)\n\t\t- Returns the \"real\" children array.\n\t───────────────────────────────────────────────────────────*/\n\t_dep_children(schemaNode) {\n\t\twhile (schemaNode.entry)\n\t\t\tschemaNode = schemaNode.entry;\n\t\tif (Array.isArray(schemaNode.entries))\n\t\t\treturn schemaNode.entries;\n\t\treturn [];\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Compute UI-forward dependency path\n\t───────────────────────────────────────────────────────────*/\n\t_dep_computeForwardPath(dependee, dependent) {\n\t\tconst from = dependee._path;\n\t\tconst to = dependent._path;\n\n\t\tif (!from || !to)\n\t\t\treturn null;\n\n\t\t// main → main\n\t\tif (from[0] === \"m\" && to[0] === \"m\")\n\t\t\treturn [\"m\", to[1]];\n\n\t\t// details → main\n\t\tif (from[0] !== \"m\" && to[0] === \"m\")\n\t\t\treturn [\"m\", to[1]];\n\n\t\t// main → details\n\t\tif (from[0] === \"m\" && to[0] !== \"m\")\n\t\t\treturn [\"e\", ...to];\n\n\t\t// details → details\n\t\tlet common = 0;\n\n\t\twhile (common < from.length && common < to.length && from[common] === to[common])\n\t\t\tcommon++;\n\n\t\tconst up   = Array(from.length - common).fill(\"..\");\n\t\tconst down = to.slice(common);\n\n\t\treturn [\"r\", ...up, ...down];\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Compute reverse dependency path (exp→exp)\n\t───────────────────────────────────────────────────────────*/\n\t_dep_computeReversePath(from, to) {\n\t\tif (!from._path || !to._path)\n\t\t\treturn null;\n\t\tif (from._path[0] === \"m\" || to._path[0] === \"m\")\n\t\t\treturn null;\n\n\t\tconst a = from._path;\n\t\tconst b = to._path;\n\n\t\tlet common = 0;\n\n\t\twhile (common < a.length && common < b.length && a[common] === b[common])\n\t\t\tcommon++;\n\n\t\tconst up   = Array(a.length - common).fill(\"..\");\n\t\tconst down = b.slice(common);\n\n\t\treturn [...up, ...down];\n\t}\n\n\t/*───────────────────────────────────────────────────────────\n\t\tHelper: Finalize dependency classification (exclusive)\n\t───────────────────────────────────────────────────────────*/\n\t_dep_finalizeDependency(schemaNode, cellPaths, dataPaths) {\n\n\t\tif (cellPaths.length) {\n\t\t\tschemaNode.dependsOnCellPaths = cellPaths;\n\t\t\tdelete schemaNode.dependsOnDataPath;\n\t\t\treturn;\n\t\t}\n\n\t\tif (dataPaths.length === 1) {\n\t\t\tschemaNode.dependsOnDataPath = dataPaths[0];\n\t\t\tdelete schemaNode.dependsOnCellPaths;\n\n\t\t\tif (!schemaNode._dataPath)\n\t\t\t\tschemaNode._dataPath = dataPaths[0];\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (dataPaths.length > 1) {\n\t\t\tconsole.warn(\"Multiple data dependencies not supported:\", schemaNode);\n\n\t\t\tschemaNode.dependsOnDataPath = dataPaths[0];\n\t\t\tdelete schemaNode.dependsOnCellPaths;\n\n\t\t\tif (!schemaNode._dataPath)\n\t\t\t\tschemaNode._dataPath = dataPaths[0];\n\t\t}\n\t}\n\n\n\n\n\n\t_updateViewportHeight = () => {\n\t\tthis._scrollBody.style.height = this.hostEl.clientHeight - this._headerTable.offsetHeight\n\t\t- (this._searchInput?.offsetHeight ?? 0) - this._bulkEditArea.offsetHeight + \"px\";\n\t}\n\n\t_attachInputFormatter(el, format) {\n\t\tformat = this._normalizeInputFormat(format);\n\t\n\t\t// Numeric filtering\n\t\tif (format.numericOnly) {\n\t\t\tel.addEventListener(\"beforeinput\", e => {\n\t\t\t\tif (e.data && /\\D/.test(e.data))\n\t\t\t\t\te.preventDefault();\n\t\t\t});\n\t\t\tel.setAttribute(\"inputmode\", \"numeric\");\n\t\t}\n\t\n\t\t// Backspace over delimiter\n\t\tel.addEventListener(\"keydown\", e => {\n\t\t\tif (e.key !== \"Backspace\" || !format.delimiter)\n\t\t\t\treturn;\n\t\n\t\t\tconst pos = el.selectionStart;\n\t\t\tif (pos > 0 && el.value[pos - 1] === format.delimiter) {\n\t\t\t\te.preventDefault();\n\t\t\t\tel.value = el.value.slice(0, pos - 2) + el.value.slice(pos);\n\t\t\t\tel.setSelectionRange(pos - 2, pos - 2);\n\t\t\t\tel.dispatchEvent(new Event(\"input\"));\n\t\t\t}\n\t\t});\n\t\n\t\t// Main formatting\n\t\tconst apply = () => {\n\t\t\tel.value = this._applyInputFormatting(el.value, format);\n\t\t};\n\t\n\t\tel.addEventListener(\"input\", apply);\n\t\tapply();\n\t}\n\t\n\t_normalizeInputFormat(format) {\n\t\tif (!format.date)\n\t\t\treturn format;\n\t\n\t\tformat = { ...format };\n\t\n\t\tif (format.blocks === undefined)\n\t\t\tformat.blocks = [4, 2, 2];\n\t\tif (format.delimiter === undefined)\n\t\t\tformat.delimiter = \"-\";\n\t\tif (format.numericOnly === undefined)\n\t\t\tformat.numericOnly = true;\n\t\n\t\treturn format;\n\t}\n\n\t_applyInputFormatting(value, format) {\n\t\tif (format.numericOnly)\n\t\t\tvalue = value.replace(/\\D/g, \"\");\n\t\n\t\t// Date mode\n\t\tif (format.date)\n\t\t\treturn this._formatDateValue(value, format);\n\t\n\t\t// Generic block formatting\n\t\tif (Array.isArray(format.blocks)) {\n\t\t\tlet out = \"\", i = 0;\n\t\t\tconst delim = format.delimiter ?? \"\";\n\t\t\tfor (const block of format.blocks) {\n\t\t\t\tconst part = value.slice(i, i + block);\n\t\t\t\tout += part;\n\t\t\t\ti += part.length;\n\t\t\t\tif (part.length === block && delim)\n\t\t\t\t\tout += delim;\n\t\t\t}\n\t\t\treturn out;\n\t\t}\n\t\n\t\treturn value;\n\t}\n\n\t_formatDateValue(digits, format) {\n\t\t// --- clamp month ---\n\t\tif (digits.length >= 5) {\n\t\t\tconst y = digits.slice(0, 4);\n\t\t\tlet m = digits.slice(4, 6);\n\t\n\t\t\tif (m.length === 1 && +m > 1)\n\t\t\t\tm = \"0\" + m;\n\t\t\telse if (m.length === 2) {\n\t\t\t\tlet mm = Math.min(Math.max(+m, 1), 12);\n\t\t\t\tm = String(mm).padStart(2, \"0\");\n\t\t\t}\n\t\t\tdigits = y + m + digits.slice(6);\n\t\t}\n\t\n\t\t// --- clamp day ---\n\t\tif (digits.length >= 7) {\n\t\t\tconst y = +digits.slice(0, 4);\n\t\t\tconst m = +digits.slice(4, 6);\n\t\t\tlet d = digits.slice(6, 8);\n\t\n\t\t\tif (d.length === 1 && +d > 3)\n\t\t\t\td = \"0\" + d;\n\t\t\telse if (d.length === 2) {\n\t\t\t\tlet dd = +d;\n\t\t\t\tconst max = new Date(y, m, 0).getDate();\n\t\t\t\td = String(Math.min(Math.max(dd, 1), max)).padStart(2, \"0\");\n\t\t\t}\n\t\t\tdigits = digits.slice(0, 6) + d + digits.slice(8);\n\t\t}\n\t\n\t\t// --- rebuild output ---\n\t\tconst blocks = format.blocks;\n\t\tconst delim  = format.delimiter ?? \"-\";\n\t\tlet out = \"\", i = 0;\n\t\n\t\tfor (let b = 0; b < blocks.length; b++) {\n\t\t\tconst part = digits.slice(i, i + blocks[b]);\n\t\t\tout += part;\n\t\t\ti += part.length;\n\t\t\tif (part.length === blocks[b] && b < blocks.length - 1)\n\t\t\t\tout += delim;\n\t\t}\n\t\n\t\treturn out;\n\t}\n\t\n\t\n\t\n\t\t\n\t\n\t_setupSearchbar() {\n\t\tthis._searchInput=this.rootEl.appendChild(document.createElement(\"input\"));\n\t\tthis._searchInput.type=this._searchInput.className=\"search\";\n\t\tthis._searchInput.placeholder=this._opts.lang?.filterPlaceholder??\"Search\";\n\t\tthis._searchInput.addEventListener(\"input\",e=>this._onSearchInput(e));\n\t}\n\n\t_onSearchInput(_e) {\n\t\tthis._filterData(this._searchInput.value);\n\t}\n\n\t_setupSpreadsheet(onlyDetails) {\n\t\tthis.rootEl.classList.add(\"spreadsheet\");\n\t\tthis._cellCursor=document.createElement(\"div\");\n\t\tthis._cellCursor.className=\"cell-cursor\";\n\t\tthis._cellCursor.style.display=\"none\";\n\t\tif (!onlyDetails) {\n\t\t\t//remove any border-spacing beacuse if spacing is clicked the target-element will be the table itself and\n\t\t\t//no cell will be selected which is bad user experience. Set it to 0 for headerTable too in order to match\n\t\t\tthis._mainTable.style.borderSpacing=this._headerTable.style.borderSpacing=this._borderSpacingY=0;\n\t\t}\n\t\tthis.rootEl.addEventListener(\"focus\",e=>this._spreadsheetOnFocus(e));\n\t\tthis.rootEl.addEventListener(\"blur\",e=>this._spreadsheetOnBlur(e));\n\t\tthis.rootEl.tabIndex=0;//so that the table can be tabbed to\n\t\tthis.rootEl.addEventListener(\"keydown\",e=>this._spreadsheetKeyDown(e));\n\t\tthis.rootEl.addEventListener(\"mousedown\",e=>this._spreadsheetMouseDown(e));\n\t\tthis._cellCursor.addEventListener(\"dblclick\",e=>this._enterCell(e));\n\n\t\tthis._tooltip=document.createElement(\"div\");\n\t\tthis._tooltip.classList.add(\"tooltip\");\n\t\tthis._tooltip.appendChild(document.createElement(\"span\"));\n\t}\n\n\t_rowMetaGet(dataIndex) {\n\t\treturn this._rowsMeta.vals[this._rowsMeta.keys.indexOf(this._data[dataIndex])];\n\t}\n\n\t_rowMetaSet(dataIndex,key,val) {\n\t\tconst linkIndex=this._rowsMeta.keys.indexOf(this._data[dataIndex]);\n\t\tif (linkIndex==-1&&val!=null) {\n\t\t\tthis._rowsMeta.vals.push({[key]:val});\n\t\t\tthis._rowsMeta.keys.push(this._data[dataIndex]);\n\t\t} else if (linkIndex!=-1&&val==null) {\n\t\t\tdelete this._rowsMeta.vals[linkIndex][key];\n\t\t\tif (!Object.keys(this._rowsMeta.vals[linkIndex]).length) {\n\t\t\t\tthis._rowsMeta.vals.splice(linkIndex,1);\n\t\t\t\tthis._rowsMeta.keys.splice(linkIndex,1);\n\t\t\t}\n\t\t} else if (linkIndex!=-1&&val!=null)\n\t\t\tthis._rowsMeta.vals[linkIndex][key]=val;\t\n\t\treturn val;\n\t}\n\n\t_spreadsheetOnFocus(_e) {\n\t\tconst tabbedTo=this._highlightOnFocus;\n\t\tif (this._mainRowIndex==null&&this._mainColIndex==null&&this._data.length&&tabbedTo)\n\t\t\t\tif (this._onlyDetails)\n\t\t\t\t\tthis.selectTopBottomCellOnlyDetails(true);\n\t\t\t\telse\n\t\t\t\t\tthis._selectMainTableCell(this._mainTbody.rows[0].cells[0]);\n\t\t//when the table is tabbed to, whatever focus-outline that the css has set for it should show, but then when the\n\t\t//user starts to navigate using the keyboard we want to hide it because it is a bit distracting when both it and\n\t\t//a cell is highlighted. Thats why #spreadsheetKeyDown sets outline to none, and this line undos that\n\t\t//also, we dont want it to show when focusing by mouse so we use #focusMethod (see its declaration)\n\t\tif (!this._onlyDetails&&this._highlightOnFocus)\n\t\t\tthis.rootEl.style.removeProperty(\"outline\");\n\t\telse\n\t\t\tthis.rootEl.style.outline=\"none\";\n\t\t\n\t\t//why is this needed? it messes things up when cellcursor is in mainpage of bulk-edit-area but hidden because\n\t\t//other page is open, and the tablance gets focus because then it will be visible through the active page\n\t\t//this._cellCursor.style.display=\"block\";\n\t\t\n\t\tif (tabbedTo)\n\t\t\tthis._scrollToCursor();\n\t}\n\n\t_spreadsheetOnBlur(_e) {\n\t\tsetTimeout(()=>{\n\t\t\tif (!this.rootEl.contains(document.activeElement)||this._bulkEditArea?.contains(document.activeElement)) {\n\t\t\t\tthis._highlightOnFocus=true;\n\t\t\t\t//if (this.neighbourTables&&Object.values(this.neighbourTables).filter(Boolean).length)\n\t\t\t\t\tthis._cellCursor.style.display=\"none\";\n\t\t\t}\n\t\t});\n\t}\n\n\t_moveCellCursor(hSign,vSign,e) {\n\t\t\n\t\tif (!this._exitEditMode(true))//try to exit-mode and commit any changes.\n\t\t\treturn false;//if exiting edit-mode was denied then do nothing more\n\t\t//it's important to run this here before deciding on the cell to move to, because exiting edit-mode may have\n\t\t//triggered visibleIf changes that may have changed which cells are selectable.\n\n\n\t\tif (this._mainRowIndex==null&&this._mainColIndex==null)//if table has focus but no cell is selected.\n\t\t\treturn;//can happen if table is clicked but not on a cell\n\t\te?.preventDefault();//to prevent native scrolling when pressing arrow-keys. Needed if #onlyDetails==true but\n\t\t\t\t\t\t\t//not otherwise. Seems the native scrolling is only done on the body and not scrollpane..?\n\t\t//const newColIndex=Math.min(this._cols.length-1,Math.max(0,this._cellCursorColIndex+numCols));\n\t\tif (!this._onlyDetails)\n\t\t\tthis._scrollToCursor();//need this first to make sure adjacent cell is even rendered\n\n\t\tif (this._activeDetailsCell?.parent?.schemaNode.type===\"lineup\")\n\t\t\tthis._moveInsideLineup(hSign,vSign);\n\t\telse if (vSign) {//moving up or down\n\t\t\tlet newColIndex=this._mainColIndex;\n\t\t\tif (this._activeDetailsCell) {//moving from inside details.might move to another cell inside,or outside\n\t\t\t\t\tthis._selectAdjacentDetailsCell(this._activeDetailsCell,vSign==1);\n\t\t\t} else if (vSign===1&&this._rowMetaGet(this._mainRowIndex)?.h){//moving down into details\n\t\t\t\tthis._selectFirstSelectableDetailsCell(this._openDetailsPanes[this._mainRowIndex],true);\n\t\t\t} else if (vSign===-1&&this._rowMetaGet(this._mainRowIndex-1)?.h){//moving up into details\n\t\t\t\tthis._selectFirstSelectableDetailsCell(this._openDetailsPanes[this._mainRowIndex-1],false);\n\t\t\t} else {//moving from and to maintable-cells\n\t\t\t\tthis._selectMainTableCell(\n\t\t\t\t\tthis._selectedCell.parentElement[(vSign>0?\"next\":\"previous\")+\"Sibling\"]?.cells[newColIndex]);\n\t\t\t}\n\t\t} else if (!this._activeDetailsCell)\n\t\t\tthis._selectMainTableCell(this._selectedCell[(hSign>0?\"next\":\"previous\")+\"Sibling\"]);\n\t\tif (this._onlyDetails&&this._mainRowIndex!=null)\n\t\t\tthis._scrollToCursor();\n\t}\n\n\t_moveInsideLineup(numCols,numRows) {\n\t\tconst currentCellX=this._activeDetailsCell.el.offsetLeft;\n\t\tconst currCelTop=this._activeDetailsCell.el.offsetTop;\n\t\tconst currCelBottom=currCelTop+this._activeDetailsCell.el.offsetHeight;\n\t\tif (numCols) {//moving left or right\n\t\t\tfor (let i=this._activeDetailsCell.index,nextCel;nextCel=this._activeDetailsCell.parent.children[i+=numCols];) {\n\t\t\t\tif (nextCel.el.offsetParent != null && (nextCel?.el.offsetLeft>currentCellX)==(numCols>0)) {\n\t\t\t\t\tif (currCelBottom>nextCel.el.offsetTop&&nextCel.el.offsetTop+nextCel.el.offsetHeight>currCelTop)\n\t\t\t\t\t\tthis._selectDetailsCell(nextCel);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {//moving up or down\n\t\t\tlet closestCell,closestCellX;\n\t\t\tconst siblings=this._activeDetailsCell.parent.children;\n\t\t\tfor (let i=this._activeDetailsCell.index,otherCell;otherCell=siblings[i+=numRows];) {\n\t\t\t\tconst skipCell=Math.max(otherCell.el.offsetTop,currCelTop) <= \t\t\t\t\t //cell is on the\n\t\t\t\t\t\t\t\tMath.min(otherCell.el.offsetTop+otherCell.el.offsetHeight,currCelBottom)//same line\n\t\t\t\t\t\t\t\t||otherCell.el.offsetParent == null;//cell is hidden\n\t\t\t\tif (skipCell)\n\t\t\t\t\tcontinue;\n\t\t\t\telse if (closestCell&&(otherCell.el.offsetLeft<closestCellX)===(numRows>0))//scrolled past whole row\n\t\t\t\t\tbreak;\n\t\t\t\tif (!closestCell||Math.abs(otherCell.el.offsetLeft-currentCellX)<Math.abs(closestCellX-currentCellX)) {\n\t\t\t\t\tclosestCell=otherCell;\n\t\t\t\t\tclosestCellX=closestCell.el.offsetLeft;\n\t\t\t\t} else//if further away than current closest one.\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (closestCell)\n\t\t\t\tthis._selectDetailsCell(closestCell);\n\t\t\telse\n\t\t\t\tthis._selectAdjacentDetailsCell(this._activeDetailsCell.parent,numRows==1?true:false);\n\t\t}\n\t}\n\n\t_selectAdjacentDetailsCell(instanceNode,isGoingDown) {\n\t\tlet cell=this._getAdjacentDetailsCell(instanceNode,isGoingDown);//repeat this line until valid cell is found?\n\t\tif (cell)\n\t\t\treturn this._selectDetailsCell(cell);\n\t\tif (!this._onlyDetails)\n\t\t\tthis._selectMainTableCell(this._mainTbody.querySelector(\n\t\t\t\t`[data-data-row-index=\"${this._mainRowIndex+isGoingDown}\"]`)?.cells[this._mainColIndex]);\n\t\telse {\n\t\t\tconst nextTable=this.neighbourTables?.[isGoingDown?\"down\":\"up\"];\n\t\t\tif (nextTable) {\n\t\t\t\tthis._mainColIndex=this._mainRowIndex=this._activeDetailsCell=null;\n\t\t\t\tnextTable.container.style.outline=this._cellCursor.style.display=\"none\";\n\t\t\t\tnextTable.selectTopBottomCellOnlyDetails(isGoingDown);\n\t\t\t}\n\t\t}\n\t}\n\t\n\t_getAdjacentDetailsCell (instanceNode,isGoingDown) {\n\t\tif (!instanceNode.parent)//parent is null if the class-instance is in the bulk-edit-area\n\t\t\treturn;\n\t\tconst siblings=instanceNode.parent.children;\n\t\tconst index=instanceNode.index;\n\t\tfor (let i=index+(isGoingDown||-1); i>=0&&i<siblings.length; i+=isGoingDown||-1) {\n\t\t\tconst sibling=siblings[i];\n\t\t\tif (sibling.hidden)\n\t\t\t\tcontinue;\n\t\t\tif (sibling.el)\n\t\t\t\treturn sibling;\n\t\t\t//else if sibling.children\n\t\t\tconst niece=this._getFirstSelectableDetailsCell(sibling,isGoingDown);\n\t\t\tif (niece)\n\t\t\t\treturn niece;\n\t\t}\n\t\tif (instanceNode.parent.parent)\n\t\t\treturn this._getAdjacentDetailsCell(instanceNode.parent,isGoingDown);\n\t}\n\n\t_selectFirstSelectableDetailsCell(instanceNode,isGoingDown,onlyGetChild=false) {\n\t\tconst newInstanceNode=this._getFirstSelectableDetailsCell(instanceNode,isGoingDown,onlyGetChild);\n\t\tif (newInstanceNode)\n\t\t\treturn this._selectDetailsCell(newInstanceNode);\n\t\tthis._selectMainTableCell(this._mainTbody.querySelector(\n\t\t\t\t`[data-data-row-index=\"${this._mainRowIndex+(isGoingDown||-1)}\"]`)?.cells[this._mainColIndex]);\n\t}\n\n\t/**Given an instanceNode, like the details of a row or any of its sub-containers, it will return the first\n\t * selectable cell from top or bottom\n\t * @param {*} instanceNode\n\t * @param {Boolean} isGoingDown \n\t * @param {Boolean} onlyGetChild if set to true then it will never return the passed in instanceNode and instead\n\t *\t\t\tonly look at its (grand)children. Used for groups where both itself and its children can be selected*/\n\t_getFirstSelectableDetailsCell(instanceNode,isGoingDown,onlyGetChild=false) {\n\t\tif (!onlyGetChild&&instanceNode.el)\n\t\t\treturn instanceNode;\n\t\tconst children=instanceNode.children;\n\t\tlet startI=isGoingDown?0:children.length-1;\n\t\tif (instanceNode.schemaNode.type===\"lineup\"&&!isGoingDown) {\n\t\t\tlet chosenCell;\n\t\t\tfor (let i=startI,otherCell;otherCell=children[i--];)\n\t\t\t\tif (otherCell.el.offsetParent)\n\t\t\t\t\tif (!chosenCell||otherCell.el.offsetLeft<chosenCell.el.offsetLeft)\n\t\t\t\t\t\tchosenCell=otherCell;\n\t\t\t\t\telse\n\t\t\t\t\t\tbreak;\n\t\t\tstartI=chosenCell.index;\n\t\t}\n\t\tfor (let childI=startI;childI>=0&&childI<children.length; childI+=isGoingDown||-1)\n\t\t\tif (!children[childI].hidden&&(children[childI].children||children[childI].select))\n\t\t\t\t return this._getFirstSelectableDetailsCell(children[childI],isGoingDown);\n\t}\n\t\n\t_spreadsheetKeyDown(e) {\n\t\t//prevent this from running in outer Tablance if an inner Tablance-instance is selected\n\t\tif (this._bulkEditArea?.contains(document.activeElement))\n\t\t\treturn;\n\t\tthis._tooltip.style.visibility=\"hidden\";\n\t\tif (this._inEditMode&&this._activeSchemaNode.input.type===\"date\") {\n\t\t\tif (e.key.slice(0,5)===\"Arrow\") {\n\t\t\t\tif (e.ctrlKey)\n\t\t\t\t\te.stopPropagation();//allow moving textcursor if ctrl is held so prevent date-change then\n\t\t\t\telse\n\t\t\t\t\te.preventDefault();//prevent textcursor from moving when arrowkey-selecting dates in date-picker\n\t\t\t} else if (e.key===\"Backspace\")\n\t\t\t\te.stopPropagation();\n\t\t}\n\t\tthis.rootEl.style.outline=\"none\";//see #spreadsheetOnFocus\n\t\tif (!this._inEditMode) {\n\t\t\tswitch (e.code) {\n\t\t\t\tcase \"ArrowUp\":\n\t\t\t\t\tthis._moveCellCursor(0,-1,e);\n\t\t\t\tbreak; case \"ArrowDown\":\n\t\t\t\t\tthis._moveCellCursor(0,1,e);\n\t\t\t\tbreak; case \"ArrowLeft\":\n\t\t\t\t\tthis._moveCellCursor(-1,0,e);\n\t\t\t\tbreak; case \"ArrowRight\":\n\t\t\t\t\tthis._moveCellCursor(1,0,e);\n\t\t\t\tbreak; case \"Escape\":\n\t\t\t\t\tthis._groupEscape();\n\t\t\t\tbreak; case \"NumpadAdd\":\n\t\t\t\t\tthis._scrollToCursor();\n\t\t\t\t\tthis. _expandRow(this._selectedCell.closest(\".main-table>tbody>tr\"));\n\t\t\t\tbreak; case \"NumpadSubtract\":\n\t\t\t\t\tthis._scrollToCursor();\n\t\t\t\t\tthis._contractRow(this._selectedCell.closest(\".main-table>tbody>tr\"));\n\t\t\t\tbreak; case \"Enter\": case \"NumpadEnter\": case \"Space\":\n\t\t\t\t\tif (e.code==\"Space\")\n\t\t\t\t\t\te.preventDefault();//prevent scrolling when pressing space\n\t\t\t\t\tthis._scrollToCursor();\n\t\t\t\t\tif (this._activeSchemaNode.type==\"expand\")\n\t\t\t\t\t\t// the preventDefault() above can SOMETIMES suppress transitionend;\n\t\t\t\t\t\t// deferring one frame ensures the animation completes and details is closed properly.\n\t\t\t\t\t\treturn requestAnimationFrame(()=>this._toggleRowExpanded(this._selectedCell.parentElement));\n\t\t\t\t\tif (this._activeSchemaNode.type==\"select\")\n\t\t\t\t\t\treturn this._rowCheckboxChange(this._selectedCell,e.shiftKey);\n\t\t\t\t\tif (e.code.endsWith(\"Enter\")||this._activeSchemaNode.input?.type===\"button\") {\n\t\t\t\t\t\te.preventDefault();//prevent newline from being entered into textareas\n\t\t\t\t\t\treturn this._enterCell(e);\n\t\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tswitch (e.key) {\n\t\t\t\tcase \"Enter\":\n\t\t\t\t\tthis._moveCellCursor(0,e.shiftKey?-1:1,e);\n\t\t\t\tbreak; case \"Escape\":\n\t\t\t\t\tthis._exitEditMode(false);\n\t\t\t}\n\t\t}\n\t}\n\n\t_groupEscape() {\n\t\tfor (let instanceNode=this._activeDetailsCell; instanceNode=instanceNode?.parent;)\n\t\t\tif (instanceNode.schemaNode.type===\"group\")\n\t\t\t\treturn this._selectDetailsCell(instanceNode);\n\t}\n\n\t_insertAtCursor(myField, myValue) {\n\t\t\n\t\tif (document.selection) {//IE support\n\t\t\tmyField.focus();\n\t\t\tconst sel = document.selection.createRange();\n\t\t\tsel.text = myValue;\n\t\t} else if (myField.selectionStart || myField.selectionStart == '0') {//MOZILLA and others\n\t\t\tvar startPos = myField.selectionStart;\n\t\t\tvar endPos = myField.selectionEnd;\n\t\t\tmyField.value = myField.value.substring(0, startPos)\n\t\t\t\t+ myValue\n\t\t\t\t+ myField.value.substring(endPos, myField.value.length);\n\t\t} else {\n\t\t\tmyField.value += myValue;\n\t\t}\n\t}\n\n\t_unsortCol(id,type) {\n\t\tfor (let sortCol,i=-1;sortCol=this._sortingCols[++i];)\n\t\t\tif (id&&id==sortCol.id||type&&type==sortCol.type) {\n\t\t\t\tthis._sortingCols.splice(i,1);\n\t\t\t\tthis._updateHeaderSortHtml();\n\t\t\t\treturn;\n\t\t\t}\n\t}\n\n\t/**Creates the actual content of a expanded row. When the user expands a row #expandRow is first called which in\n\t * turn calls this one. When scrolling and already expanded rows are found only this one needs to be called.\n\t * @param {*} tr \n\t * @param {*} rowIndex \n\t * @returns */\n\t_renderDetails(tr,rowIndex) {\n\t\ttr.classList.add(\"expanded\");\n\t\tconst detailsRow=tr.parentElement.insertRow(tr.rowIndex+1);\n\t\tdetailsRow.className=\"details\";\n\t\tdetailsRow.dataset.dataRowIndex=rowIndex;\n\t\tconst detailsCell=detailsRow.insertCell();\n\t\tdetailsCell.colSpan=this._cols.length;\n\t\tconst detailsDiv=detailsCell.appendChild(document.createElement(\"div\"));//single div inside td for animate\n\t\tdetailsDiv.style.height=\"auto\";\n\t\tdetailsDiv.className=\"content\";\n\t\tdetailsDiv.addEventListener(\"transitionend\",this._detailsAnimationEnd.bind(this));\n\t\tconst shadowLine=detailsDiv.appendChild(document.createElement(\"div\"));\n\t\tshadowLine.className=\"details-shadow\";\n\t\tconst instanceNode=this._openDetailsPanes[rowIndex]={};\n\t\tthis._generateDetailsContent(this._schema.details,rowIndex,instanceNode,detailsDiv,[],this._data[rowIndex]);\n\t\tinstanceNode.rowIndex=rowIndex;\n\t\treturn detailsRow;\n\t}\n\n\t_detailsAnimationEnd(e) {\n\t\tif (e.currentTarget!==e.target)\n\t\t\treturn;//otherwise it will apply to transitions of child-elements as well\n\t\tif (parseInt(e.target.style.height)) {//if expand finished\n\n\t\t\te.target.style.height=\"auto\";\n\t\t} else {//if contract finished\n\n\t\t\tconst detailsTr=e.target.closest(\"tr\");\n\t\t\tconst mainTr=detailsTr.previousSibling;\n\t\t\tconst dataRowIndex=mainTr.dataset.dataRowIndex;\n\t\t\tmainTr.classList.remove(\"expanded\");\n\t\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)\n\t\t\t\t -this._rowMetaGet(dataRowIndex).h+this._rowHeight+\"px\";\n\t\t\tdetailsTr.remove();\n\t\t\tthis._rowMetaSet(dataRowIndex,\"h\",null);\n\t\t\tdelete this._openDetailsPanes[dataRowIndex];\n\t\t}\n\t}\n\n\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} schemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when child objects get created lazily during user input.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsContent(schemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tlet notYetCreated=_notYetCreated;\n\t\tlet scopedRowData=rowData;\n\t\tif (schemaNode.dataPath) {\n\t\t\tconst ctx=Array.isArray(schemaNode.dataPath)\n\t\t\t\t? schemaNode.dataPath\n\t\t\t\t: String(schemaNode.dataPath).split(\".\").filter(Boolean);\n\t\t\tlet target=scopedRowData;\n\t\t\tfor (const key of ctx) {\n\t\t\t\tif (!target[key]||typeof target[key]!=\"object\") {\n\t\t\t\t\ttarget[key]={};\n\t\t\t\t\tnotYetCreated=true;\n\t\t\t\t}\n\t\t\t\ttarget=target[key];\n\t\t\t}\n\t\t\tscopedRowData=target;\n\t\t}\n\t\tif (!path.length)\n\t\t\tinstanceNode.rowIndex=mainIndex;\n\t\tinstanceNode.path=[...path];\n\t\tinstanceNode.dataObj=scopedRowData;\n\t\tinstanceNode.schemaNode=schemaNode;\n\t\tif (schemaNode.visibleIf)\n\t\t\tthis._applyVisibleIf(instanceNode);\n\t\tswitch (schemaNode.type) {\n\t\t\tcase \"list\": return this._generateDetailsList(schemaNode,mainIndex,instanceNode,parentEl,path,scopedRowData,notYetCreated);\n\t\t\tcase \"field\": return this._generateField(schemaNode,mainIndex,instanceNode,parentEl,path,scopedRowData);\n\t\t\tcase \"group\": return this._generateDetailsGroup(schemaNode,mainIndex,instanceNode,parentEl,path,scopedRowData,notYetCreated);\n\t\t\tcase \"repeated\": return this._generateDetailsRepeated(schemaNode,mainIndex,instanceNode,parentEl,path,scopedRowData,notYetCreated);\n\t\t\tcase \"lineup\": return this._generateDetailsLineup(schemaNode,mainIndex,instanceNode,parentEl,path,scopedRowData,notYetCreated);\n\t\t}\n\t}\n\n\t_repeatedOnDelete=(e,data,index,schemaNode,cel)=>{\n\t\tthis._deleteCell(cel.parent.parent);\n\t\tcel.parent.parent.parent.schemaNode.onDelete?.(cel.parent.parent.dataObj,cel.parent.parent);\n\t}\n\n\t_fileOnDelete=(e,data,index,strct,cel)=>{\n\t\tconst fileCell=cel.parent.parent;\n\t\tconst inputSchemaNode=fileCell.fileInputSchemaNode;\n\t\tconst dataRow=fileCell.parent.dataObj;\n\t\tdelete dataRow[inputSchemaNode.id];\n\t\tconst fileTd=fileCell.el.parentElement;\n\t\tfileTd.innerHTML=\"\";\n\t\tfileTd.classList.remove(\"group-cell\");\n\t\tthis._generateDetailsContent(inputSchemaNode,index,fileCell,fileTd,fileCell.path,dataRow);\n\t\tinputSchemaNode.deleteHandler?.(e,data,inputSchemaNode,fileCell.parent.dataObj,index,fileCell);\n\t\tthis._selectDetailsCell(fileCell);\n\t}\n\n\t_onOpenCreationGroup=(e,groupObject)=>{\n\t\te.preventDefault();\n\t\tthis._repeatInsert(groupObject.parent,true,groupObject.parent.dataObj[groupObject.parent.dataObj.length]={});\n\t}\n\n\t/**\n\t * This is \"supposed\" to get called when a repeated-schemaNode is found however in #generateDetailsList,\n\t * repeated schema-nodes are looked for and handled by that method instead so that titles can be added to the list\n\t * which isn't handled by #generateDetailsContent but by the list-method itself\n\t *\n\t * @param {object} repeatedSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when child objects get created lazily during user input.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsRepeated(repeatedSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tinstanceNode.children=[];\n\t\tlet repeatData=instanceNode.dataObj=rowData[repeatedSchemaNode.id]??(rowData[repeatedSchemaNode.id]=[]);\n\t\tinstanceNode.insertionPoint=parentEl.appendChild(document.createComment(\"repeated-insert\"));\n\t\trepeatedSchemaNode.create&&this._generateRepeatedCreator(instanceNode);\n\t\trepeatData?.forEach(repeatData=>this._repeatInsert(instanceNode,false,repeatData));\n\t\treturn !!repeatData?.length||repeatedSchemaNode.create;\n\t}\n\n\t/**For repeated schema-nodes with create set to true (meaning users can create more entries via user-interface),\n\t * this method creates the last entry that the user interacts with to create another entry\n\t * @param {Object} repeatedObj The object representing the repeated-container*/\n\t_generateRepeatedCreator(repeatedObj) {\n\t\tconst creationTxt=repeatedObj.schemaNode.creationText??this._opts.lang?.insertNew??\"Insert new\";\n\t\tconst creationSchemaNode={type:\"group\",closedRender:()=>creationTxt,entries:[],\n\t\t\t\t\t\t\tcreator:true//used to know that this entry is the creator and that it should not be sorted\n\t\t\t\t\t\t\t,onOpen:this._onOpenCreationGroup,cssClass:\"repeat-insertion\"};\n\t\tconst wrappedCreationSchemaNode=this._buildSchemaFacade(creationSchemaNode);//WRAPPED\n\t\tconst el=this._repeatInsert(repeatedObj,false,{},wrappedCreationSchemaNode);\n\t\tel.parentElement.classList.add(\"empty\");//this will make it hidden if inside a group that is closed\n\t}\n\n\t_beginDeleteRepeated(e,data,mainIndex,schemaNode,cell) {\n\t\tif (!cell.parent.parent.creating) {\n\t\t\tcell.parent.containerEl.classList.add(\"delete-confirming\");\n\t\t\tthis._moveInsideLineup(1);//move away from the delete-button which now dissapeared, to the next btn\n\t\t} else\n\t\t\tthis._deleteCell(cell.parent.parent);\n\t}\n\n\t_cancelDelete(e,data,mainIndex,schemaNode,cell) {\n\t\t\tcell.parent.containerEl.classList.remove(\"delete-confirming\");\n\t\t\tthis._selectDetailsCell(cell.parent.children[0]);\n\t}\n\n\t_schemaCopyWithDeleteButton(schemaNode,deleteHandler) {\n\t\tconst deleteControls={type:\"lineup\",cssClass:\"delete-controls\"\n\t\t\t,onBlur:cel=>cel.selEl.querySelector(\".lineup\").classList.remove(\"delete-confirming\")\n\t\t\t,entries:[{type:\"field\",input:{type:\"button\",\n\t\t\t\tbtnText:schemaNode.deleteText??this._opts.lang?.delete??\"Delete\"\n\t\t\t\t,clickHandler:this._beginDeleteRepeated.bind(this)},cssClass:\"delete\"},\n\t\t\t{type:\"field\",input:{type:\"button\"\n\t\t\t\t,btnText:schemaNode.areYouSureNoText??this._opts.lang?.deleteAreYouSureNo??\"No\",\n\t\t\t\tclickHandler:this._cancelDelete.bind(this)},cssClass:\"no\"\n\t\t\t\t,title:schemaNode.deleteAreYouSureText??this._opts.lang?.deleteAreYouSure??\"Are you sure?\"},\n\t\t\t{type:\"field\",input:{type:\"button\"\n\t\t\t\t,btnText:schemaNode.areYouSureYesText??this._opts.lang?.deleteAreYouSureYes??\"Yes\",\n\t\t\t\tclickHandler:deleteHandler},cssClass:\"yes\"}]};\n\t\tconst rawNode=schemaNode?.[SCHEMA_WRAPPER_MARKER]?schemaNode.raw:schemaNode;\n\t\tconst parentWrapped=schemaNode?.[SCHEMA_WRAPPER_MARKER]?schemaNode.parent:null;\n\t\tif (!rawNode)\n\t\t\treturn schemaNode;\n\t\tconst clonedEntries=[...(rawNode.entries??[]),deleteControls];\n\t\tconst clonedNode={...rawNode, entries:clonedEntries};\n\t\treturn this._buildSchemaFacade(clonedNode,parentWrapped);\n\t}\n\n\t_generateButton(schemaNode,mainIndex,parentEl,rowData,instanceNode=null) {\n\t\tconst btn=parentEl.appendChild(document.createElement(\"button\"));\n\t\tbtn.tabIndex=\"-1\";//so it can't be tabbed to\n\t\tbtn.innerHTML=schemaNode.input.btnText;\n\t\tbtn.addEventListener(\"click\",e=>schemaNode.input.clickHandler?.(e,rowData,mainIndex,schemaNode,instanceNode));\n\n\t\t//prevent gaining focus upon clicking it whhich would cause problems. It should be \"focused\" by having the\n\t\t//cellcursor on its cell which triggers it with enter-key anyway\n\t\tbtn.addEventListener(\"mousedown\",e=>e.preventDefault());\n\t\treturn true;\n\t}\n\n\t\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} groupSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t * @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when child objects get created lazily during user input.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsGroup(groupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,notYetCreated) {\n\t\tinstanceNode.select=()=>this._selectDetailsCell(instanceNode);\n\t\tconst groupTable=parentEl.appendChild(document.createElement(\"table\"));\n\t\tconst tbody=instanceNode.containerEl=groupTable.appendChild(document.createElement(\"tbody\"));\n\t\tgroupTable.dataset.path=path.join(\"-\");\n\t\tparentEl.classList.add(\"group-cell\");\n\t\tinstanceNode.el=groupTable;//so that the whole group-table can be selectedf\n\t\tthis._generateDetailsCollection(groupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData);\n\t\tgroupTable.className=\"details-group \"+(groupSchemaNode.cssClass??\"\");\n\t\tif (notYetCreated)\n\t\t\tinstanceNode.creating=true;\n\t\telse if (groupSchemaNode.closedRender) {\n\t\t\tgroupTable.classList.add(\"closed-render\");\n\t\t\tconst renderRow=tbody.insertRow();\n\t\t\trenderRow.dataset.path=path.join(\"-\");\n\t\t\trenderRow.className=\"group-render\";\n\t\t\tconst renderCell=renderRow.insertCell();\n\t\t\trenderCell.innerText=groupSchemaNode.closedRender(rowData);\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} listSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t* @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when child objects get created lazily during user input.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsList(listSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tconst listTable=parentEl.appendChild(document.createElement(\"table\"));\n\t\tinstanceNode.containerEl=listTable.appendChild(document.createElement(\"tbody\"));\n\t\tlistTable.className=\"details-list\";\n\t\tif (listSchemaNode.titlesColWidth!=false) {\n\t\t\tlet titlesCol=document.createElement(\"col\");\n\t\t\tlistTable.appendChild(document.createElement(\"colgroup\")).appendChild(titlesCol);\n\t\t\tif (listSchemaNode.titlesColWidth!=null)\n\t\t\t\ttitlesCol.style.width=listSchemaNode.titlesColWidth;\n\t\t}\n\t\treturn this._generateDetailsCollection(listSchemaNode,mainIndex,instanceNode,parentEl,path,rowData);\n\t}\n\n\t/**\n\t * Creates details content based on the provided structure.\n\t *\n\t * @param {object} lineupSchemaNode Structure object defining what to create.\n\t * @param {number} mainIndex Index of the main data row that this details belongs to.\n\t * @param {object} instanceNode The object representing the cell that is being created.\n\t * @param {HTMLElement} parentEl The parent element to which the created elements should be appended.\n\t * @param {number[]} path Keeps track of the \"path\" by adding and removing index numbers when entering and leaving \n\t * \t\tnesting levels. This path is added as a data attribute to interactive cells so that the corresponding cell\n\t * \t\tobject can later be retrieved.\n\t * @param {object} rowData The actual data object that this details is representing.\n\t* @param {boolean} notYetCreated True if the instanceNode points to data within objects that do not yet exist.\n\t * \t\tThis happens when child objects get created lazily during user input.\n\t * @returns {boolean} True if any content was created; false if nothing was created (for example, an empty repeated\n\t * \t\tschemaNode with no create option).\n\t */\n\t_generateDetailsLineup(lineupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData,_notYetCreated) {\n\t\tinstanceNode.containerEl=parentEl.appendChild(document.createElement(\"div\"));\n\t\tinstanceNode.containerEl.classList.add(\"lineup\",\"collection\",...lineupSchemaNode.cssClass?.split(\" \")??[]);\n\t\treturn this._generateDetailsCollection(lineupSchemaNode,mainIndex,instanceNode,parentEl,path,rowData);\n\t}\n\n\t/**\n\t * Generates the children of a container schema node (list/lineup/group).\n\t * Handles repeated entries specially; otherwise delegates to _generateCollectionItem.\n\t */\n\t_generateDetailsCollection(containerSchemaNode,mainIndex,collectionObj,parentEl,path,rowData) {\n\t\t//allows for easily finding the outer-most parent of elements that are placed in collection\n\t\tcollectionObj.containerEl.classList.add(\"collection\");\n\n\t\tcollectionObj.children=[];\n\t\tfor (let entryI=-1,childSchemaNode; childSchemaNode=containerSchemaNode.entries[++entryI];) {\n\t\t\tif (childSchemaNode.type===\"repeated\") {\n\t\t\t\tconst repeatData=rowData[childSchemaNode.id]??(rowData[childSchemaNode.id]=[]);\n\t\t\t\tconst rptCelObj=collectionObj.children[entryI]={parent:collectionObj,index:entryI,children:[]\n\t\t\t\t\t\t\t\t\t\t\t\t,schemaNode:childSchemaNode,dataObj:repeatData,path:[...path,entryI]};\n\t\t\t\trptCelObj.insertionPoint=collectionObj.containerEl.appendChild(document.createComment(\"repeat-insert\"));\n\t\t\t\tchildSchemaNode.create&&this._generateRepeatedCreator(rptCelObj);\n\t\t\t\trepeatData?.forEach(repeatData=>this._repeatInsert(rptCelObj,false,repeatData));\n\t\t\t} else\n\t\t\t\tthis._generateCollectionItem(childSchemaNode,mainIndex,collectionObj,path,rowData);\n\t\t}\n\t\treturn true;\n\t}\n\n\t/**\n\t * Build correct DOM structure for a collection item depending on collection type.\n\t * Returns both outermost element (outerContainerEl) and the inner element (containerEl)\n\t * where the content will be placed.\n\t * \n\t * Also sets special properties on itemObj for group items.\n\t */\n\t_buildCollectionItemDOM(schemaNode,collection,itemObj,title) {\n\t\tlet outerContainerEl,containerEl;\n\t\tconst type=collection.schemaNode.type;\n\n\t\t// LIST: Each item is a <tr> with title cell optionally + value cell\n\t\tif (type==\"list\") {\n\t\t\touterContainerEl=document.createElement(\"tr\");\n\t\t\tif (collection.schemaNode.titlesColWidth!=false) {\n\t\t\t\tconst td=outerContainerEl.insertCell();\n\t\t\t\ttd.className=\"title\";\n\t\t\t\ttd.innerText=schemaNode.title??\"\";\n\t\t\t}\n\t\t\tcontainerEl=outerContainerEl.insertCell();\n\t\t} else if (type==\"lineup\") {// LINEUP: Items rendered inline, outerContainerEl wraps title + inner content\n\t\t\touterContainerEl=document.createElement(\"span\");\n\t\t\tif (title)\n\t\t\t\touterContainerEl.appendChild(title);\n\t\t\tcontainerEl=itemObj.selEl=outerContainerEl.appendChild(document.createElement(\"div\"));\n\t\t} else if (type==\"group\") {//GROUP: More complex <tr> with special rules for empty/hiding and more\n\t\t\touterContainerEl=document.createElement(\"tr\");\n\t\t\touterContainerEl.className=\"empty\";\t// Will be hidden while group is closed until content becomes non-empty\n\n\t\t\tconst td=outerContainerEl.insertCell();\n\t\t\ttd.classList.toggle(\"disabled\",schemaNode.type==\"field\"&&!schemaNode.input);\n\n\t\t\t// Add separator for non-group members\n\t\t\tif (schemaNode.type!=\"group\")\n\t\t\t\ttd.appendChild(document.createElement(\"hr\")).className=\"separator\";\n\n\t\t\tif (title)\n\t\t\t\ttd.appendChild(title);\n\n\t\t\tcontainerEl=td.appendChild(document.createElement(\"div\"));\n\n\t\t\t// Track non-empty descendants so empty group rows can hide visually\n\t\t\tObject.assign(itemObj,{\n\t\t\t\tnonEmptyDescentants:0,\n\t\t\t\tgrpTr:outerContainerEl,\n\t\t\t\tselEl:td\n\t\t\t});\n\t\t} else\n\t\t\touterContainerEl=containerEl=document.createElement(\"div\");\n\t\treturn {outerContainerEl,containerEl};\n\t}\n\n\t/**\n\t * Insert the newly generated collection item into the DOM, either at end or at a precise insert position.\n\t * Handles \"repeated\" collections where insertion point is not always end of list.\n\t */\n\t_insertCollectionItem(schemaNode,index,itemObj,outerContainerEl,collectionOrRepeated,collectionEl) {\n\t\tlet siblingAfter=null;\n\n\t\t// For repeated collections: determine the real insertion position based on insertionPoint\n\t\tif (collectionOrRepeated.schemaNode.type==\"repeated\") {\n\t\t\tconst next=collectionOrRepeated.insertionPoint.nextSibling;\n\t\t\tconst base=collectionOrRepeated.children.length;\n\t\t\tconst pos=(next?.rowIndex??base)-base+index;\n\t\t\tsiblingAfter=collectionOrRepeated.children[pos];\n\t\t}\n\n\t\t// Where to insert in the DOM\n\t\tconst beforeEl=siblingAfter?.el.closest(\".collection>*\")?? collectionOrRepeated.insertionPoint;\n\n\t\tcollectionEl.insertBefore(outerContainerEl,beforeEl);\n\n\t\t// Insert into internal children array\n\t\tcollectionOrRepeated.children.splice(index,0,itemObj);\n\n\t\t// Extra CSS class if defined in schemaNode\n\t\tif (schemaNode.cssClass)\n\t\t\touterContainerEl.className+=\" \"+schemaNode.cssClass;\n\t}\n\t\n\t\n\n\t/**\n\t * Generate one item inside a collection or repeated block.\n\t * Creates DOM, updates indices, generates inner content, and inserts into DOM\n\t * only if details content was actually created (e.g., repeated with empty data should not add item).\n\t */\n\t_generateCollectionItem(schemaNode,mainIndex,collectionOrRepeated,path,data,index=null, creating=false) {\n\t\t// Determine actual collection (repeated uses parent collection visually)\n\t\tconst collection=collectionOrRepeated.schemaNode.type==\"repeated\"\n\t\t\t\t\t\t\t\t\t?collectionOrRepeated.parent:collectionOrRepeated;\n\n\t\tconst collectionEl=collection.containerEl;\n\t\tindex??=collectionOrRepeated.children.length;\n\n\t\t// Item object (holds metadata for this item)\n\t\tconst itemObj=Object.assign(Object.create(null),{parent:collectionOrRepeated,index:index});\n\n\t\t// Optional title element\n\t\tlet title;\n\t\tif (schemaNode.title) {\n\t\t\ttitle=document.createElement(\"span\");\n\t\t\ttitle.className=\"title\";\n\t\t\ttitle.innerHTML=schemaNode.title;\n\t\t}\n\n\t\t// Build DOM structure for this item\n\t\tconst {outerContainerEl,containerEl}=this._buildCollectionItemDOM(schemaNode,collection,itemObj,title);\n\n\n\t\t// Visual CSS classes\n\t\tif (schemaNode.input&&schemaNode.input.type!=\"button\")\n\t\t\tcontainerEl.classList.add(\"input-cell\");\n\t\tcontainerEl.classList.add(\"value\");\n\t\tif (schemaNode.input)\n\t\t\touterContainerEl.classList.add((schemaNode.input.type??\"text\")+\"-container\");\n\n\t\t// If inserting in middle: update sibling item indices\n\t\tif (index<collectionOrRepeated.children.length)\n\t\t\tfor (let i=index-1,sibling; sibling=collectionOrRepeated.children[++i];)\n\t\t\t\tthis._changeInstanceNodeIndex(sibling,i+1);\n\n\t\tpath.push(index);\n\n\t\titemObj.outerContainerEl=outerContainerEl;//reference to outer-most container belonging exclusively to this item\n\n\t\t// Expand inner content; may return false if nothing should be rendered\n\t\tconst generated=this._generateDetailsContent(schemaNode,mainIndex,itemObj,containerEl,path,data,creating);\n\n\t\t// Only insert if it actually has content (important for sparse repeated arrays)\n\t\tif (generated)\n\t\t\tthis._insertCollectionItem(schemaNode,index,itemObj,outerContainerEl,collectionOrRepeated,collectionEl);\n\n\t\tpath.pop();\n\t\treturn itemObj;\n\t}\n\n\t_generateField(fieldSchemaNode,mainIndex,instanceNode,parentEl,path,rowData) {\n\t\tinstanceNode.select=()=>this._selectDetailsCell(instanceNode);\n\t\tinstanceNode.el=parentEl;\n\t\tthis._updateDetailsCell(instanceNode,rowData);\n\t\tinstanceNode[instanceNode.selEl?\"selEl\":\"el\"].dataset.path=path.join(\"-\");\n\t\treturn true;\n\t}\n\t\n\t_spreadsheetMouseDown(e) {\n\t\tthis._highlightOnFocus=false;//see decleration\n\t\tthis.rootEl.style.outline=\"none\";//see #spreadsheetOnFocus\n\t\tthis._tooltip.style.visibility=\"hidden\";\n\t\tif (Date.now()<this._ignoreClicksUntil)//see decleration of #ignoreClicksUntil\n\t\t\treturn;\n\t\tif (e.which===3)//if right click\n\t\t\treturn;\n\t\tconst mainTr=e.target.closest(\".main-table>tbody>tr\");\n\t\tif (this._onlyDetails||mainTr?.classList.contains(\"details\")) {//in details\n\t\t\tconst interactiveEl=e.target.closest('[data-path]');\n\t\t\tif (!interactiveEl)\n\t\t\t\treturn;\n\t\t\tlet instanceNode=this._openDetailsPanes[mainTr?.dataset.dataRowIndex??0];\n\t\t\tfor (let step of interactiveEl.dataset.path.split(\"-\")) {\n\t\t\t\tinstanceNode=instanceNode.children[step];\n\t\t\t\tif (instanceNode.schemaNode.type===\"group\"&&!instanceNode.el.classList.contains(\"open\"))\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tthis._selectDetailsCell(instanceNode);\n\t\t} else {//not in details\n\t\t\tconst td=e.target.closest(\".main-table>tbody>tr>td\");\n\t\t\tif (td?.classList.contains(\"expand-col\")||td?.classList.contains(\"select-col\")) {\n\t\t\t\tif (e.shiftKey)\n\t\t\t\t\te.preventDefault();//prevent text-selection when shift-clicking checkboxes\n\t\t\t\tif (this._mainRowIndex==null) {\n\t\t\t\t\tthis._selectMainTableCell(td);\n\t\t\t\t\tthis.rootEl.focus({preventScroll:true});\n\t\t\t\t}\n\t\t\t\tif (td.classList.contains(\"expand-col\"))\n\t\t\t\t\treturn this._toggleRowExpanded(td.parentElement);\n\t\t\t\treturn this._rowCheckboxChange(td,e.shiftKey);\n\t\t\t}\n\t\t\tthis._selectMainTableCell(td);\n\t\t}\n\t}\n\n\t_toggleRowExpanded(tr) {\n\t\tif (tr.classList.contains(\"expanded\"))\n\t\t\tthis._contractRow(tr);\n\t\telse\n\t\t\tthis._expandRow(tr);\n\t}\n\n\t_rowCheckboxChange(td,shift) {\n\t\tconst checked=!td.querySelector(\"input\").checked;\n\t\tconst mainIndex=parseInt(td.parentElement.dataset.dataRowIndex);\n\t\tif (!shift)//shift not held, \n\t\t\tthis._lastCheckedIndex=mainIndex;//set #lastCheckedIndex to the current index to both start and stop at it\n\t\tthis._toggleRowsSelected(checked,...[mainIndex,this._lastCheckedIndex??mainIndex].sort((a,b)=>a-b));\n\t\tthis._lastCheckedIndex=mainIndex;//if shift held next time then rows between this and new mainIndex are checked\n\t}\n\n\t_toggleRowsSelected(checked,fromIndex,toIndex) {\n\t\tthis._unsortCol(null,\"select\");\n\t\tfor (var i=fromIndex;i<=toIndex; i++){\n\t\t\tif (i>=this._scrollRowIndex&&i<this._scrollRowIndex+this._numRenderedRows) {\n\t\t\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${i}\"]`);\n\t\t\t\ttr.querySelector(\".select-col input\").checked=checked;\n\t\t\t\ttr.classList.toggle(\"selected\",checked);\n\t\t\t}\n\t\t\tif (checked&&this._selectedRows.indexOf(this._data[i])==-1) {\n\t\t\t\tthis._selectedRows.push(this._data[i]);\n\t\t\t\tthis._numRowsSelected++;\n\t\t\t\tthis._numRowsInViewSelected++;\n\t\t\t} else if (!checked&&this._selectedRows.indexOf(this._data[i])!=-1) {\n\t\t\t\tthis._selectedRows.splice(this._selectedRows.indexOf(this._data[i]),1);\n\t\t\t\tthis._numRowsSelected--;\n\t\t\t\tthis._numRowsInViewSelected--;\n\t\t\t}\n\t\t}\n\t\tthis._numberOfRowsSelectedSpan.innerText=this._numRowsSelected;\n\t\tthis._updateNumRowsSelectionState();\n\t\tthis._updateBulkEditAreaCells();\n\t}\n\n\t_updateNumRowsSelectionState() {\n\t\tconst checkbox=this._headerTr.querySelector(\".select-col input\");\n\t\tif (this._numRowsInViewSelected==this._data.length||!this._numRowsInViewSelected) {\n\t\t\tcheckbox.indeterminate=false;\n\t\t\tcheckbox.checked=this._numRowsInViewSelected;\n\t\t} else\n\t\t\tcheckbox.indeterminate=true;\n\t\tif (this._numRowsSelected^this._bulkEditAreaOpen) {\n\t\t\tthis._bulkEditAreaOpen=!!this._numRowsSelected;\n\t\t\tthis._bulkEditArea.style.height=this._bulkEditAreaOpen?this._bulkEditAreaHeightPx+\"px\":0;\n\t\t\tthis._animate(this._updateViewportHeight,Infinity,\"adjustViewportHeight\");\n\t\t}\n\t}\n\n\t_animate(func,runForMs,id) {\n\t\tconst runUntil=Date.now()+runForMs;\n\t\tconst animations=this._animations;\n\t\tif (!animations[id]) {\n\t\t\tanimations[id]=runUntil;\n\t\t\trequestAnimationFrame(frame);\n\t\t} else\n\t\t\tanimations[id]=runUntil;\n\t\tfunction frame() {\n\t\t\tfunc();\n\t\t\tif (Date.now()<animations[id])\n\t\t\t\trequestAnimationFrame(frame);\n\t\t\telse\n\t\t\t\tdelete animations[id];\n\t\t}\n\t}\n\n\t_autoTextAreaResize(e) {\n\t\tconst maxHeight=this._activeSchemaNode.maxHeight??Infinity;\n\t\t\n\t\t//__auto-resize__\n\t\t//first set height to auto.This won't make it auto-resize or anything but will rather set its height to about 40\n\t\te.target.style.height=\"auto\";\n\t\t//then set size of cellcursor, and also the underlying cell in order to make details-height adjust to scroll-\n\t\t//height of the textarea. Also add 1px because *sometimes* without logic the textarea would recieve a scrollbar\n\t\t//which can scroll about 1 px. Not sure if 1px is actually sufficent but let's start there.\n\t\tthis._cellCursor.style.height=this._selectedCell.style.height=Math.min(maxHeight,e.target.scrollHeight+1)+\"px\";\n\t\t//now set height of textarea to 100% of cellcursor which height is set with above line. this line and the one\n\t\t//setting it to auto \"could\" be skipped but that will result in the textarea not shrinking when needed.\n\t\te.target.style.height=\"100%\";\n\n\t\t//need to call this to make the height of the details adjust and reflect the change in size of the textarea\n\t\tthis._updateDetailsHeight(this._selectedCell.closest(\"tr.details\"));\n\t}\n\n\t_updateDetailsHeight(detailsTr) {\n\t\tconst contentDiv=detailsTr.querySelector(\".content\");\n\t\tconst mainRowIndex=parseInt(detailsTr.dataset.dataRowIndex);\n\t\tcontentDiv.style.height=\"auto\";//set to auto in case of in middle of animation, get correct height\n\t\tconst prevRowHeight=this._rowMetaGet(mainRowIndex).h;\n\t\tconst newRowHeight=this._rowHeight+detailsTr.offsetHeight+this._borderSpacingY;\n\t\tthis._rowMetaSet(mainRowIndex,\"h\",newRowHeight);\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)//adjust scroll-height reflect change...\n\t\t\t+newRowHeight-prevRowHeight+\"px\";//...in height of the table\n\t}\n\n\t_openDateEdit(e) {\n\t\tconst input=document.createElement(\"input\");\n\t\tlet pika,pikaContainer;\n\t\t//this._input.type=\"date\";//using Pikaday instead which I find more user-friendly. Calendar can be opened\n\t\t\t\t\t\t\t\t//up right away and typing manualy is still permitted\n\t\tthis._attachInputFormatter(input,{date:true});\n\t\tif (!window.Pikaday)\n\t\t\tconsole.warn(\"Pikaday-library not found\");\n\t\telse {\n\t\t\tpikaContainer=this._cellCursor.parentElement.appendChild(document.createElement(\"div\"));\n\t\t\tpikaContainer.className=\"pika-container\";\n\t\t\tpika=new Pikaday({field:input,\n\t\t\t\ttoString: d=>d.getFullYear()+\"-\"+('0'+(d.getMonth()+1)).slice(-2)+\"-\"+('0'+d.getDate()).slice(-2),\n\t\t\t\tonClose:()=>{\n\t\t\t\t\tpikaContainer.remove();\n\t\t\t\t\tpika.destroy();\n\t\t\t\t\tsetTimeout(()=>this._exitEditMode(true));\n\t\t\t\t},\n\t\t\t\tcontainer:pikaContainer,\n\t\t\t\tfirstDay:1,//week starts on monday\n\t\t\t\tshowWeekNumber:true,\n\t\t\t\tdefaultDate: this._selectedCellVal ? new Date(this._selectedCellVal) : undefined,\n\t\t\t\tsetDefaultDate:true,\n\t\t\t\ti18n: {\n\t\t\t\t\tpreviousMonth : 'Tidigare Månad',\n\t\t\t\t\tnextMonth     : 'Nästa Månad',\n\t\t\t\t\tmonths        : ['Januari','Februari','Mars','April','Maj','Juni','Juli','Augusti','September'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,'Oktober','November','December'],\n\t\t\t\t\tweekdays      : ['Söndag','Måndag','Tisdag','Onsdag','Torsdag','Fredag','Lördag'],\n\t\t\t\t\tweekdaysShort : ['Sön','Mån','Tis','Ons','Tor','Fre','Lör']\n\t\t\t\t},\n\t\t\t\tonOpen:()=>this._alignDropdown(pikaContainer),//have to wait until onOpen or size is 0\n\t\t\t\tonDraw: () => this._alignDropdown(pikaContainer)//not all months include the same number of weeks,\n\t\t\t\t\t\t\t\t//so sometimes the calendar gets taller or shorter and that's why we have to re-align\n\t\t\t});\n\t\t\tpika.el.style.position=\"static\";//otherwise size of pikaContainer will be 0 and alignDropdown wont work\n\t\t\tif (e instanceof KeyboardEvent)\n\t\t\t\te.stopPropagation();//otherwise the enter-press is propagated to Pikaday, immediately closing it\n\t\t\tinput.addEventListener(\"input\",onInput.bind(this));\n\t\t\tinput.addEventListener(\"change\",()=>this._inputVal=input.value);\n\t\t}\n\t\t\n\t\tthis._cellCursor.appendChild(input);\n\t\tinput.value=this._selectedCellVal??\"\";\n\t\tinput.placeholder=this._activeSchemaNode.input.placeholder??this._opts.lang?.datePlaceholder??\"YYYY-MM-DD\";\n\t\tinput.focus();\n\t\t\n\t\tfunction onInput(_e) {\n\t\t\tconst inputVal=input.value;\n\t\t\tpika.setDate(input.value);\n\t\t\t//the above line will change the text above by guessing where there should be zeroes and such so prevent\n\t\t\t//that by setting it back so that the user can type freely\n\t\t\tinput.value=inputVal;\n\t\t}\n\t}\n\n\t/**Aligns dropdowns like select and date-picker correctly by the cellcursor or any other target-element specified */\n\t_alignDropdown(dropdown,target=this._cellCursor) {\n\n\t\tconst alignmentContainer=this._dropdownAlignmentContainer;//container of the dropdown\n\t\tconst alignmentPos=this._getElPos(target);\n\t\tconst viewportPos=alignmentContainer===dropdown.offsetParent?alignmentPos\n\t\t\t\t\t\t\t:this._getElPos(target,alignmentContainer);\n\t\t\n\t\t//if target-element is below middle of viewport or if in bulk-edit-area\n\t\tdropdown.classList.remove(\"above\",\"below\",\"left\",\"right\");\n\t\tif (viewportPos.y+target.clientHeight/2>alignmentContainer.scrollTop+alignmentContainer.clientHeight/2) {\n\t\t\t//then place dropdown above target-element\n\t\t\tdropdown.style.top=alignmentPos.y-dropdown.offsetHeight+\"px\";\n\t\t\tdropdown.classList.add(\"above\");\n\t\t} else {\n\t\t\t//else place dropdown below target-element\n\t\t\tdropdown.style.top=alignmentPos.y+target.clientHeight+\"px\";\n\t\t\tdropdown.classList.add(\"below\");\n\t\t}\n\n\t\t//if there's enough space to the right of target-element\n\t\tif (alignmentContainer.clientWidth-viewportPos.x>dropdown.offsetWidth) {\n\t\t\t//then align the left of the dropdown with the left of the target-element\n\t\t\tdropdown.style.left=alignmentPos.x+\"px\";\n\t\t\tdropdown.classList.add(\"left\");\n\t\t} else {\n\t\t\t//otherwise align the right of the dropdown with the right of the target-element\n\t\t\tdropdown.style.left=alignmentPos.x-(dropdown.offsetWidth-target.offsetWidth)+\"px\";\n\t\t\tdropdown.classList.add(\"right\");\n\t\t}\n\t}\n\n\t_enterCell(e) {\n\t\tif (this._inEditMode||this._cellCursor.classList.contains(\"disabled\"))\n\t\t\treturn;\n\t\tif (this._activeSchemaNode.input) {\n\t\t\te.preventDefault();//prevent text selection upon entering editmode\n\t\t\tif (this._activeSchemaNode.input.type===\"button\")\n\t\t\t\treturn this._activeDetailsCell.el.click();\n\t\t\tthis._inputVal=this._selectedCellVal;\n\t\t\tthis._inEditMode=true;\n\t\t\tthis._cellCursor.classList.add(\"edit-mode\");\n\t\t\t({textarea:this._openTextAreaEdit,date:this._openDateEdit,select:this._openSelectEdit\n\t\t\t\t,file:this._openFileEdit}[this._activeSchemaNode.input.type]??this._openTextEdit).call(this,e);\n\t\t} else if (this._activeSchemaNode.type===\"group\") {\n\t\t\tthis._openGroup(this._activeDetailsCell);\n\t\t}\n\t}\n\n\t_openGroup(groupObj) {\n\t\tlet doOpen=true;\n\t\tgroupObj.schemaNode.onOpen?.({preventDefault:()=>doOpen=false},groupObj);\n\t\tif (!doOpen)\n\t\t\treturn;\n\t\tgroupObj.el.classList.add(\"open\");\n\t\tthis._selectDetailsCell(this._getFirstSelectableDetailsCell(groupObj,true,true));\n\t\tgroupObj.schemaNode.onOpenAfter?.(groupObj);\n\t\t\n\t}\n\n\t_closeGroup(groupObject) {\n\t\tif (groupObject.creating&&!this._closeRepeatedInsertion(groupObject))\n\t\t\treturn false;\n\t\tgroupObject.el.classList.remove(\"open\");\n\t\tthis._ignoreClicksUntil=Date.now()+500;\n\t\tif (groupObject.updateRenderOnClose) {//if group is flagged for having its closed-render updated on close\n\t\t\tdelete groupObject.updateRenderOnClose;//delete the flag so it doesn't get triggered again\n\t\t\tlet cell,renderText;\n\t\t\t//look for ancestor-cell with rowData which repeated rows have. It's a sub-data-row of #data.\n\t\t\t//if we got all the way to the root without finding any repeated-rows then use datarow directly from #data\n\t\t\tfor (cell=groupObject.parent;!cell.dataObj&&cell.parent;cell=cell.parent);//look for ancestor with rowData\n\t\t\trenderText=groupObject.schemaNode.closedRender(groupObject.dataObj);\n\t\t\tgroupObject.el.rows[groupObject.el.rows.length-1].cells[0].innerText=renderText;\n\t\t}\n\t\tgroupObject.schemaNode.onClose?.(groupObject);\n\t\treturn true;\n\t}\n\n\t_repeatInsert(repeated,creating,data,entrySchemaNode=null) {\n\t\t//normally entrySchemaNode should be the entry of repeated, \n\t\t// but schemaNode can be supplied for creating creation-entries\n\t\tentrySchemaNode??=repeated.schemaNode.entry;\n\n\t\tlet indexOfNew,rowIndex;\n\t\tif (!creating&&repeated.schemaNode.sortCompare&&!entrySchemaNode.creator) {\n\t\t\tfor (indexOfNew=0;indexOfNew<repeated.children.length-!!repeated.schemaNode.create; indexOfNew++)\n\t\t\t\tif (repeated.schemaNode.sortCompare(data,repeated.children[indexOfNew].dataObj)<0)\n\t\t\t\t\tbreak;\n\t\t} else\n\t\t\tindexOfNew=repeated.children.length-(repeated.schemaNode.create&&!entrySchemaNode.creator)//pos be4 creator\n\t\tfor (let root=repeated.parent; root.parent; root=root.parent,rowIndex=root.rowIndex);//get main-index\n\t\tlet entryNode=entrySchemaNode;\n\t\tif (repeated.schemaNode.create&&entrySchemaNode.type===\"group\")\n\t\t\tentryNode=this._schemaCopyWithDeleteButton(entrySchemaNode,this._repeatedOnDelete);\n\t\t\t//make a wrapped copy of the entry so delete-controls can be appended without touching the original\n\t\tconst newObj=this._generateCollectionItem(entryNode,rowIndex,repeated,repeated.path,data,indexOfNew,creating);\n\t\tif (creating) {\n\t\t\tnewObj.creating=true;//creating means it hasn't been commited yet.\n\t\t\tthis._selectFirstSelectableDetailsCell(newObj,true,true);\n\t\t\trepeated.schemaNode.onCreateOpen?.(repeated);\n\t\t}\n\t\treturn newObj.el;\n\t}\n\n\t_changeInstanceNodeIndex(instanceNode,newIndex) {\n\t\tinstanceNode.index=newIndex;\n\t\tconst level=instanceNode.path.length-1;\n\t\tfor (const pathEl of instanceNode.el.parentElement.querySelectorAll('[data-path]')) {\n\t\t\tconst path=pathEl.dataset.path.split(\"-\");\n\t\t\tpath[level]=newIndex;\n\t\t\tpathEl.dataset.path=path.join(\"-\");\n\t\t}\n\t\tfixObjPath(instanceNode,newIndex);\n\t\tfunction fixObjPath(instanceNode) {\n\t\t\tif (instanceNode.path)\n\t\t\t\tinstanceNode.path[level]=newIndex;\n\t\t\tinstanceNode.children?.forEach(fixObjPath);\n\t\t}\n\t}\n\n\t_deleteCell(instanceNode,programatically=false) {\n\t\tlet newSelectedCell;\n\t\tfor (let i=instanceNode.index,otherCell; otherCell=instanceNode.parent.children[++i];)\n\t\t\tthis._changeInstanceNodeIndex(otherCell,i-1)\n\t\tif (instanceNode.parent.children.length>=instanceNode.index+1)\n\t\t\tnewSelectedCell=instanceNode.parent.children[instanceNode.index+1];\n\t\telse if (instanceNode.parent.children.length>1)\n\t\t\tnewSelectedCell=instanceNode.parent.children[instanceNode.index-1];\n\t\tinstanceNode.parent.children.splice(instanceNode.index,1);\n\t\tif (!programatically)\n\t\t\tinstanceNode.parent.dataObj.splice(instanceNode.index,1);\n\t\tif (instanceNode.parent.schemaNode.type===\"repeated\"&&instanceNode.parent.parent.schemaNode.type===\"list\")\n\t\t\tinstanceNode.el.parentElement.parentElement.remove();\n\t\telse\n\t\t\tinstanceNode.el.parentElement.remove();\n\t\tthis._activeDetailsCell=null;//causes problem otherwise when #selectDetailsCell checks old cell\n\t\tif (!programatically)\n\t\t\tthis._selectDetailsCell(newSelectedCell??instanceNode.parent.parent);\n\t\tinstanceNode.creating&&instanceNode.parent.schemaNode.onCreateCancel?.(instanceNode.parent);\n\t}\n\n\t_openTextEdit() {\n\t\tconst input=this._cellCursor.appendChild(document.createElement(\"input\"));\n\n\t\t//for when blurring by clicking outside of table etc. exit edit-mode and commit the change but keep the cell\n\t\t//selected. not sure why the timeout is needed but it is.\n\t\tinput.addEventListener(\"blur\",()=>setTimeout(this._exitEditMode.bind(this,true)));\n\t\t\n\t\tinput.addEventListener(\"change\",()=>this._inputVal=input.value);\n\t\tinput.value=this._selectedCellVal??\"\";\n\t\tif (this._activeSchemaNode.input.format)\n\t\t\tthis._attachInputFormatter(input,this._activeSchemaNode.input.format);\n\t\tinput.focus();\n\t\tif (this._activeSchemaNode.input.maxLength)\n\t\t\tinput.maxLength=this._activeSchemaNode.input.maxLength;\n\t\tinput.placeholder=this._activeSchemaNode.input.placeholder??\"\";\n\t}\n\n\t_mapAdd(map,key,val) {\n\t\tmap.keys.push(key);\n\t\tmap.vals.push(val);\n\t}\n\n\t_mapGet(map,key) {\n\t\tconst index=map.keys.indexOf(key);\n\t\tif (index!=-1)\n\t\t\treturn map.vals[index];\n\t}\n\n\t_mapRemove(map,key) {\n\t\tconst index=map.keys.indexOf(key);\n\t\tmap.keys.splice(index,1);\n\t\tmap.vals.splice(index,1);\n\t}\n\n\n\t/**\n\t * Enter \"file edit mode\" for a file-input cell.\n\t *\n\t * This method is called when the user activates a file-input cell\n\t * (via Enter, double-click, etc). It temporarily replaces the cell\n\t * contents with an interactive file-drop zone that supports:\n\t *\n\t *   - Clicking or pressing Enter/Space to open the system file picker.\n\t *   - Drag-and-drop of a file directly onto the cell.\n\t *   - Visual feedback while dragging a file over the target.\n\t *\n\t * During this mode:\n\t *   - The cell is replaced with a small UI component containing\n\t *     a text prompt and a hidden <input type=\"file\">.\n\t *   - Once a file is selected or dropped, the event is forwarded to\n\t *     #processFileUpload(), which performs the actual upload logic.\n\t *\n\t * After a file is chosen, the edit mode automatically exits and\n\t * the details cell is re-selected.\n\t */\n\t_openFileEdit() {\n\t\twindow.getSelection().empty();\n\t\n\t\tconst fileDiv = this._cellCursor.appendChild(document.createElement(\"div\"));\n\t\tfileDiv.classList.add(\"file\");\n\t\tfileDiv.tabIndex = 0;\n\t\tfileDiv.focus();\n\t\n\t\tconst fileInput = fileDiv.appendChild(document.createElement(\"input\"));\n\t\tfileInput.type = \"file\";\n\t\n\t\tfileDiv.innerHTML = this._opts.lang?.fileChooseOrDrag ?? \"<b>Press to choose a file</b> or drag it here\";\n\t\n\t\tconst dropDiv = fileDiv.appendChild(document.createElement(\"div\"));\n\t\tdropDiv.classList.add(\"drop\");\n\t\tdropDiv.innerHTML = this._opts.lang?.fileDropToUpload ?? \"Drop to upload\";\n\t\n\t\t// Local small handler\n\t\tconst keydown = e => {\n\t\t\tif (e.key === \"Escape\")\n\t\t\t\treturn; // let Tablance handle it\n\t\t\t\n\t\t\te.stopPropagation();\n\t\n\t\t\tif (e.key.startsWith(\"Arrow\"))\n\t\t\t\te.preventDefault();\n\t\t\telse if (e.key === \"Enter\" || e.key === \" \") {\n\t\t\t\te.preventDefault();\n\t\t\t\tfileInput.click();\n\t\t\t}\n\t\t};\n\t\n\t\t// Bind handleFile to preserve `this`\n\t\tconst handleFile = this._processFileUpload.bind(this);\n\t\n\t\t// Events\n\t\tfileDiv.addEventListener(\"keydown\", keydown);\n\t\tfileDiv.addEventListener(\"click\", () => fileInput.click());\n\t\tfileDiv.addEventListener(\"dragenter\", () => dropDiv.style.display = \"block\");\n\t\tdropDiv.addEventListener(\"dragleave\", () => dropDiv.style.display = \"none\");\n\t\tdropDiv.addEventListener(\"dragover\", e => e.preventDefault());\n\t\tfileDiv.addEventListener(\"drop\", e => {\n\t\t\te.preventDefault();\n\t\t\te.stopPropagation();\n\t\t\thandleFile(e.dataTransfer.files[0]);\n\t\t});\n\t\tfileInput.addEventListener(\"change\", e => handleFile(e.target.files[0]));\n\t}\n\n\t/**\n\t * Called by #openFileEdit() after the user selects or drops a file.\n\t * Handle the actual upload of a selected file.\n\t *\n\t * This method:\n\t *\n\t *   1. Stores the file as the cell's input value.\n\t *   2. Creates and registers a metadata object for tracking:\n\t *        - uploadedBytes (updated during upload)\n\t *        - progress bars currently displayed for this file\n\t *   3. Initiates an XMLHttpRequest upload and wires up:\n\t *        - upload progress events (to update progress bars)\n\t *        - final load event (to mark completion and clean up metadata)\n\t *   4. Invokes the user-defined fileUploadHandler attached to the\n\t *      cell’s schemaNode, allowing full customization of how the file\n\t *      is handled on the server side.\n\t *   5. Sends the file using multipart/form-data via FormData.\n\t *\n\t * After initiating the upload:\n\t *   - The cell exits edit mode.\n\t *   - The original details cell is automatically re-selected.\n\t *\n\t * This method does not handle UI creation — only the upload workflow\n\t * and progress bookkeeping.\n\t */\n\t_processFileUpload(file) {\n\t\tthis._inputVal = file;\n\t\n\t\tconst meta = Object.assign(Object.create(null), {uploadedBytes: 0,bars: []});\n\t\tthis._mapAdd(this._filesMeta, file, meta);\n\n\t\tconst xhr = !this._opts.useFakeFileUploadTest ? new XMLHttpRequest()\n\t\t\t: new FakeXMLHttpRequest({totalBytes:file.size||1,rate:this._opts.fakeUploadRate,\n\t\t\t\tstartAt:this._opts.fakeUploadStartAt});\n\n\t\tconst updateProgressBars=(loaded,total)=>{\n\t\t\tfor (let i=0; i<meta.bars.length; i++) {\n\t\t\t\tconst bar=meta.bars[i];\n\t\t\t\tif (!bar.isConnected) {\n\t\t\t\t\tmeta.bars.splice(i--,1);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tmeta.uploadedBytes=loaded;\n\t\t\t\tconst pct=total?parseInt(loaded/total*100):0;\n\t\t\t\tbar.style.width=bar.firstChild.innerText=pct+\"%\";\n\t\t\t\t}\n\t\t};\n\t\tconst finalizeUpload=()=>{\n\t\t\tthis._mapRemove(this._filesMeta,file);\n\t\t\tfor (const bar of meta.bars)\n\t\t\t\tif (bar.isConnected) {\n\t\t\t\t\tbar.parentElement.classList.remove(\"active\");\n\t\t\t\t\tbar.firstChild.innerText=this._opts.lang?.fileUploadDone??\"Done!\";\n\t\t\t\t}\n\t\t};\n\t\tconst totalBytes=file.size||1;\n\t\txhr.upload.addEventListener(\"progress\", e=>updateProgressBars(e.loaded,e.total));\n\t\txhr.addEventListener(\"load\", () => {\n\t\t\tupdateProgressBars(totalBytes,totalBytes);\n\t\t\tfinalizeUpload();\n\t\t});\n\t\n\t\tthis._activeSchemaNode.input.fileUploadHandler?.(xhr,file,this._activeSchemaNode,this._cellCursorDataObj,\n\t\t\tthis._mainRowIndex,this._activeDetailsCell);\n\t\n\t\tconst formData = new FormData();\n\t\tformData.append(\"file\", file);\n\t\txhr.send(formData);\n\t\n\t\tthis._exitEditMode(true);\n\t\tthis._selectDetailsCell(this._activeDetailsCell);\n\t}\n\t\n\n\t_openTextAreaEdit() {\n\t\tconst textarea=this._cellCursor.appendChild(document.createElement(\"textarea\"));\n\t\ttextarea.addEventListener('input', this._autoTextAreaResize.bind(this));\n\n\t\t{\tconst {paddingLeft,paddingRight,paddingTop,paddingBottom}=window.getComputedStyle(this._selectedCell);\n\t\t\t//add the padding of the cell to the textarea for consistency\n\t\t\tObject.assign(textarea.style,{paddingLeft,paddingRight,paddingTop,paddingBottom});}\n\t\t\n\t\ttextarea.value=this._selectedCellVal??\"\";\n\t\ttextarea.addEventListener(\"keydown\",keydown.bind(this));\n\t\ttextarea.focus();\n\t\ttextarea.addEventListener(\"change\",_e=>this._inputVal=textarea.value);\n\t\tif (this._activeSchemaNode.input.maxLength)\n\t\t\ttextarea.maxLength=this._activeSchemaNode.input.maxLength;\n\t\ttextarea.placeholder=this._activeSchemaNode.input.placeholder??\"\";\n\t\tfunction keydown(e) {\n\t\t\tif (e.key===\"Enter\"&&e.ctrlKey) {\n\t\t\t\tthis._insertAtCursor(textarea,\"\\r\\n\");\n\t\t\t\ttextarea.dispatchEvent(new Event('input'));//trigger input so that autoTextAreaResize gets called\n\t\t\t\te.stopPropagation();\n\t\t\t} else if (e.key===\"Escape\") {\n\t\t\t\ttextarea.value=this._selectedCellVal??\"\";\n\t\t\t\ttextarea.dispatchEvent(new Event('input'));\n\t\t\t}\n\t\t}\n\t}\n\n\t\t/**\n\t * Render all select options into a given <ul> and update highlighted indices if the selected value is found.\n\t * @param {HTMLUListElement} ul\n\t * @param {Array} opts\n\t * @param {*} selectedVal\n\t * @param {Object} ctx\n\t * @returns {boolean} true if the selected option was found among opts\n\t */\n\t\t_renderSelectOptions(ul,opts,selectedVal,ctx) {\n\t\t\tlet foundSelected=false;\n\t\t\tul.innerHTML=\"\";\n\t\t\tfor (const opt of opts) {\n\t\t\t\tconst li=ul.appendChild(document.createElement(\"li\"));\n\t\t\t\tif (opt.cssClass)\n\t\t\t\t\tli.className=opt.cssClass;\n\t\t\t\tli.innerText=opt.text;\n\t\t\t\tif (selectedVal==opt) {\n\t\t\t\t\tfoundSelected=true;\n\t\t\t\t\tli.classList.add(\"selected\",\"highlighted\");\n\t\t\t\t\tctx.highlightLiIndex=ul.children.length-1;\n\t\t\t\t\tctx.highlightUlIndex=parseInt(ul.dataset.ulIndex);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn foundSelected;\n\t\t}\n\t\n\t\t/**\n\t\t * Highlight a specific option in one of the ULs and optionally scroll it into view when keyboard navigating.\n\t\t * @param {Object} ctx\n\t\t * @param {number} ulIndex 0 for pinned, 1 for main\n\t\t * @param {number} liIndex index within the selected UL\n\t\t * @param {boolean} keyboardNavigating whether the change came from arrow keys\n\t\t */\n\t\t_highlightSelectOption(ctx,ulIndex,liIndex,keyboardNavigating) {\n\t\t\tconst highlighted=ctx.ulDiv.getElementsByClassName(\"highlighted\")[0];\n\t\t\tif (highlighted)\n\t\t\t\thighlighted.classList.remove(\"highlighted\");\n\t\t\tconst ul=ctx.ulDiv.children[ctx.highlightUlIndex=ulIndex];\n\t\t\tconst li=ul.children[ctx.highlightLiIndex=liIndex];\n\t\t\tif (!li)\n\t\t\t\treturn;\n\t\t\tli.classList.add(\"highlighted\");\n\t\t\tif (ulIndex&&keyboardNavigating)\n\t\t\t\tul.scrollTop=li.offsetTop-ul.offsetTop+li.offsetHeight/2-ul.offsetHeight/2;\n\t\t}\n\t\n\t\t/**\n\t\t * Filter loose options based on the current input value and update rendered lists and create-option state.\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectInputChange(ctx) {\n\t\t\tconst value=ctx.input.value;\n\t\t\tconst hadFilter=!!ctx.filterText;\n\t\t\tconst filterChangedAtEdges=!value.includes(ctx.filterText)||!hadFilter;\n\t\t\tctx.canCreate=!!value;\n\t\t\tif (filterChangedAtEdges)\n\t\t\t\tctx.looseOpts.splice(0,Infinity,...ctx.strctInp.options);\n\t\t\tfor (let i=-1,opt; opt=ctx.looseOpts[++i];)\n\t\t\t\tif (!opt.text.includes(value)||opt.pinned)\n\t\t\t\t\tctx.looseOpts.splice(i--,1);\n\t\t\t\telse if (opt.text.toLowerCase()==value.toLowerCase())\n\t\t\t\t\tctx.canCreate=false;\n\t\t\tthis._updateCreateOptionVisibility(ctx);\n\t\t\tconst foundSelected=this._renderSelectOptions(ctx.mainUl,ctx.looseOpts,this._inputVal,ctx);\n\t\t\tif (foundSelected)\n\t\t\t\tctx.pinnedUl.querySelector(\".highlighted\")?.classList.remove(\"highlighted\");\n\t\t\telse if (ctx.highlightUlIndex) {\n\t\t\t\tif (ctx.looseOpts.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,1,0,true);\n\t\t\t\telse if (ctx.pinnedUl.children.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,0,0,true);\n\t\t\t}\n\t\t\tctx.noResults.style.display=ctx.looseOpts.length?\"none\":\"block\";\n\t\t\tctx.filterText=value;\n\t\t\tif (ctx.creationLi)\n\t\t\t\tctx.creationLi.innerText=`Create [${ctx.filterText}]`;\n\t\t}\n\t\n\t\t/**\n\t\t * Show or hide the \"create new option\" list item depending on ctx.canCreate and current DOM state.\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_updateCreateOptionVisibility(ctx) {\n\t\t\tif (!ctx.creationLi)\n\t\t\t\treturn;\n\t\t\tif (ctx.canCreate) {\n\t\t\t\tif (ctx.creationLi.parentElement!=ctx.pinnedUl)\n\t\t\t\t\tctx.pinnedUl.appendChild(ctx.creationLi);\n\t\t\t} else if (ctx.creationLi.parentElement==ctx.pinnedUl)\n\t\t\t\tctx.pinnedUl.removeChild(ctx.creationLi);\n\t\t}\n\t\n\t\t/**\n\t\t * Handle keyboard navigation and selection inside the open select dropdown.\n\t\t * @param {KeyboardEvent} e\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectKeyDown(e,ctx) {\n\t\t\tif (e.key===\"ArrowDown\"||e.key===\"ArrowUp\") {\n\t\t\t\te.preventDefault();\n\t\t\t\tconst direction=e.key===\"ArrowDown\"?1:-1;\n\t\t\t\tconst currentIndex=ctx.highlightLiIndex==null?0:ctx.highlightLiIndex;\n\t\t\t\tconst newIndex=currentIndex+direction;\n\t\t\t\tif (ctx.highlightUlIndex??true) {\n\t\t\t\t\tif (ctx.looseOpts.length&&newIndex<ctx.looseOpts.length&&newIndex>=0)\n\t\t\t\t\t\tthis._highlightSelectOption(ctx,1,newIndex,true);\n\t\t\t\t\telse if (newIndex==-1&&ctx.pinnedUl.children.length)\n\t\t\t\t\t\tthis._highlightSelectOption(ctx,0,ctx.pinnedUl.children.length-1,true);\n\t\t\t\t} else if (newIndex>=0&&newIndex<ctx.pinnedUl.children.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,0,newIndex,true);\n\t\t\t\telse if (newIndex>=ctx.pinnedUl.children.length&&ctx.looseOpts.length)\n\t\t\t\t\tthis._highlightSelectOption(ctx,1,0,true);\n\t\t\t} else if (e.key===\"Enter\") {\n\t\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t\t\tthis._moveCellCursor(0,e.shiftKey?-1:1);\n\t\t\t\te.stopPropagation();\n\t\t\t} else if (e.key===\"Escape\")\n\t\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t}\n\t\n\t\t/**\n\t\t * Handle mouse movement over list items by updating the highlighted option.\n\t\t * @param {MouseEvent} e\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectMouseMove(e,ctx) {\n\t\t\tconst li=e.target.closest(\"li\");\n\t\t\tif (!li)\n\t\t\t\treturn;\n\t\t\tconst ul=li.parentNode;\n\t\t\tconst ulIndex=parseInt(ul.dataset.ulIndex);\n\t\t\tconst liIndex=[...ul.children].indexOf(li);\n\t\t\tthis._highlightSelectOption(ctx,ulIndex,liIndex,false);\n\t\t}\n\t\n\t\t/**\n\t\t * Handle mouse click on a list item: select it, close the dropdown and exit edit mode.\n\t\t * @param {MouseEvent} e\n\t\t * @param {Object} ctx\n\t\t */\n\t\t_handleSelectClick(e,ctx) {\n\t\t\tconst li=e.target.closest(\"li\");\n\t\t\tif (!li)\n\t\t\t\treturn;\n\t\t\tconst ul=e.currentTarget;\n\t\t\tctx.highlightUlIndex=parseInt(ul.dataset.ulIndex);\n\t\t\tctx.highlightLiIndex=Array.prototype.indexOf.call(ul.children,li);\n\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t\tthis._exitEditMode(true);\n\t\t}\n\t\n\t\t/**\n\t\t * Create base DOM structure and context object for the select dropdown.\n\t\t * Splits options into pinned/loose arrays and prepares elements but does not attach listeners.\n\t\t * @param {Object} strctInp the input-definition object from the active cell schemaNode\n\t\t * @returns {Object} ctx a state container for the open select dropdown\n\t\t */\n\t\t_createSelectDropdownContext(strctInp) {\n\t\t\tconst selectContainer=document.createElement(\"div\");\n\t\t\tconst pinnedOpts=[];\n\t\t\tconst looseOpts=[];\n\t\t\tconst inputWrapper=selectContainer.appendChild(document.createElement(\"div\"));\n\t\t\tconst input=inputWrapper.appendChild(document.createElement(\"input\"));\n\t\t\tinputWrapper.classList.add(\"input-wrapper\");\n\t\t\tconst ulDiv=selectContainer.appendChild(document.createElement(\"div\"));\n\t\t\tconst pinnedUl=ulDiv.appendChild(document.createElement(\"ul\"));\n\t\t\tpinnedUl.classList.add(\"pinned\");\n\t\t\tconst mainUl=ulDiv.appendChild(document.createElement(\"ul\"));\n\t\t\tmainUl.classList.add(\"main\");\n\t\t\tconst noResults=selectContainer.appendChild(document.createElement(\"div\"));\n\t\t\tnoResults.innerHTML=strctInp.noResultsText??this._opts.lang?.selectNoResultsFound??\"No results found\";\n\t\t\tnoResults.className=\"no-results\";\n\t\t\tfor (const opt of strctInp.options)\n\t\t\t\t(opt.pinned?pinnedOpts:looseOpts).push(opt);\n\t\t\tconst ctx=Object.assign(Object.create(null),{\n\t\t\t\tstrctInp,\n\t\t\t\tselectContainer,\n\t\t\t\tinputWrapper,\n\t\t\t\tinput,\n\t\t\t\tulDiv,\n\t\t\t\tpinnedUl,\n\t\t\t\tmainUl,\n\t\t\t\tnoResults,\n\t\t\t\tpinnedOpts,\n\t\t\t\tlooseOpts,\n\t\t\t\tcreationLi:null,\n\t\t\t\tcanCreate:false,\n\t\t\t\tfilterText:\"\",\n\t\t\t\thighlightLiIndex:null,\n\t\t\t\thighlightUlIndex:null,\n\t\t\t\twindowMouseDown:null\n\t\t\t});\n\t\t\treturn ctx;\n\t\t}\n\t\n\t\t/**\n\t\t * Close the select dropdown, update the current value (including create-new if applicable) \n\t\t * and clean up listeners.\n\t\t * @param {Object} ctx\n\t\t * @param {Event} e the event that triggered the close (click, keydown, etc.)\n\t\t */\n\t\t_closeSelectDropdown(ctx,e) {\n\t\t\tif (!ctx.selectContainer.parentElement)\n\t\t\t\treturn;\n\t\t\tif (!ctx.highlightUlIndex&&ctx.pinnedUl.children[ctx.highlightLiIndex]?.dataset.type==\"create\") {\n\t\t\t\tctx.filterText=ctx.filterText??ctx.input.value;\n\t\t\t\tthis._inputVal={text:ctx.filterText};\n\t\t\t\tctx.strctInp.options.push(this._inputVal);\n\t\t\t\tctx.strctInp.createNewOptionHandler?.(this._inputVal,e,this._cellCursorDataObj,this._mainRowIndex\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,this._activeSchemaNode,this._activeDetailsCell);\n\t\t\t} else\n\t\t\t\tthis._inputVal=(ctx.highlightUlIndex?ctx.looseOpts:ctx.pinnedOpts)[ctx.highlightLiIndex];\n\t\t\tctx.selectContainer.remove();\n\t\t\tif (ctx.windowMouseDown)\n\t\t\t\twindow.removeEventListener(\"mousedown\",ctx.windowMouseDown);\n\t\t}\n\t\n\t\t/**\n\t\t * Open edit mode for a cell that uses a select-input: creates the dropdown UI,\n\t\t * wires up filtering, keyboard navigation and mouse interaction, and focuses the input.\n\t\t */\n\t\t_openSelectEdit() {\n\t\t\tconst strctInp=this._activeSchemaNode.input;\n\t\t\tthis._inputVal=this._cellCursorDataObj[this._activeSchemaNode.id];\n\t\t\tconst ctx=this._createSelectDropdownContext(strctInp);\n\t\t\tthis._cellCursor.style.backgroundColor=\"transparent\";\n\t\t\tconst allowCreateNew=strctInp.allowCreateNew;\n\t\t\tif (allowCreateNew||ctx.looseOpts.length>=(strctInp.minOptsFilter??this._opts.defaultMinOptsFilter??5))\n\t\t\t\tctx.input.addEventListener(\"input\",()=>this._handleSelectInputChange(ctx));\n\t\t\telse\n\t\t\t\tctx.inputWrapper.classList.add(\"hide\");\n\t\t\tctx.input.addEventListener(\"keydown\",e=>this._handleSelectKeyDown(e,ctx));\n\t\t\tctx.input.placeholder=strctInp.selectInputPlaceholder??\"\";\n\t\t\tctx.input.addEventListener(\"blur\",ctx.input.focus);\n\t\t\tfor (let i=-1,ul;ul=[ctx.pinnedUl,ctx.mainUl][++i];) {\n\t\t\t\tul.dataset.ulIndex=i;\n\t\t\t\tul.addEventListener(\"mousemove\",e=>this._handleSelectMouseMove(e,ctx));\n\t\t\t\tul.addEventListener(\"click\",e=>this._handleSelectClick(e,ctx));\n\t\t\t}\n\t\t\tif (strctInp.allowCreateNew) {\n\t\t\t\tctx.creationLi=document.createElement(\"li\");\n\t\t\t\tctx.creationLi.dataset.type=\"create\";\n\t\t\t}\n\t\t\tthis._renderSelectOptions(ctx.pinnedUl,ctx.pinnedOpts,this._inputVal,ctx);\n\t\t\tthis._renderSelectOptions(ctx.mainUl,ctx.looseOpts,this._inputVal,ctx);\n\t\t\tthis._cellCursor.parentElement.appendChild(ctx.selectContainer);\n\t\t\tctx.selectContainer.className=\"tablance-select-container\";\n\t\t\tthis._alignDropdown(ctx.selectContainer);\n\t\t\tconst windowMouseDown=e=>{\n\t\t\t\tlet el=e.target;\n\t\t\t\twhile (el&&el!=ctx.selectContainer)\n\t\t\t\t\tel=el.parentElement;\n\t\t\t\tif (!el) {\n\t\t\t\t\tthis._closeSelectDropdown(ctx,e);\n\t\t\t\t\tthis._exitEditMode(false);\n\t\t\t\t}\n\t\t\t};\n\t\t\tctx.windowMouseDown=windowMouseDown;\n\t\t\twindow.addEventListener(\"mousedown\",windowMouseDown);\n\t\t\tctx.input.focus();\n\t\t}\n\t\n\n\t_validateInput(newVal) {\n\t\tlet message;\n\t\tconst input=this._cellCursor.querySelector(\"input\");\n\t\tconst doCommit=this._activeSchemaNode.input.validation(newVal,m=>message=m,this._activeSchemaNode\n\t\t\t\t\t\t\t\t\t\t\t\t,this._cellCursorDataObj,this._mainRowIndex,this._activeDetailsCell);\n\t\tif (doCommit)\n\t\t\treturn true;\n\t\tinput.focus();\n\t\tif (message)\n\t\t\tthis._showTooltip(message);\n\t}\n\n\t/**\n\t * Updates dependent cells when a cell's value changes.\n\t *\n\t * This method propagates changes from a modified cell to its dependent cells,\n\t * ensuring that the dependent cells are updated accordingly. It traverses the\n\t * hierarchical structure of cells and updates both details cells and main-row\n\t * cells as needed.\n\t *\n\t * @param {Object} editedCellSchemaNode - The schema-node of the cell that was edited.\n\t * @param {Object} [editedInstanceNode] - The instance-node representing the edited cell. This is used to determine\n\t *                                   the closest scope for dependency updates.\n\t */\n\t_updateDependentCells(editedCellSchemaNode, editedInstanceNode) {\n\t\tfor (const depPath of editedCellSchemaNode.dependencyPaths??[])\n\t\t\tif (depPath[0]===\"m\") {//if cell is in main row cell\n\t\t\t\t// Find the corresponding table row for the main data row\n\t\t\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${this._mainRowIndex}\"]:not(.details)`);\n\t\t\t\t// Update the content of the dependent cell in the main table\n\t\t\t\tthis._updateMainRowCell(tr.cells[depPath[1]], this._colSchemaNodes[depPath[1]]);\n\t\t\t} else if (this._openDetailsPanes[this._mainRowIndex]) {//if cell is in details and details is open\n\t\t\t\t//cells is an array that potentially can hold more than 1 cell. The reason is that when going into\n\t\t\t\t//repeated structures, it \"splits\" into multiple cells if there are multiple repeated-entries/instances\n\t\t\t\tlet cells=depPath[0]===\"r\"?[editedInstanceNode]:[this._openDetailsPanes[this._mainRowIndex]];\n\n\t\t\t\tfor (var step=1; depPath[step]===\"..\"; step++)//if there are any, iterate all the \"..\"\n\t\t\t\t\tcells[0] = cells[0].parent;//go up one level per \"..\". At this point cells will only have one cell\n\n\t\t\t\tfor (; step<depPath.length; step++) {//iterate the steps\n\t\t\t\t\tif (cells[0].schemaNode.type===\"repeated\") {\n\t\t\t\t\t\tconst newCells=[];//will hold the new set of cells after this step\n\t\t\t\t\t\tfor (const cell of cells)\n\t\t\t\t\t\t\tnewCells.push(...cell.children);//add all repeated-children of current cell\n\t\t\t\t\t\tcells=newCells;//set cells to the new set of cells\n\t\t\t\t\t}\n\t\t\t\t\tfor (let cellI=0; cellI<cells.length; cellI++)//iterate the cell(s)\n\t\t\t\t\t\tcells[cellI]=cells[cellI].children[depPath[step]];//and do the step\n\t\t\t\t}\n\t\t\t\tfor (const cell of cells)//iterate the cell(s) again\n\t\t\t\t\tthis._updateDetailsCell(cell,cell.dataObj);//and do the actual update\n\t\t\t}\n\t}\n\n\t_exitEditMode(save) {\n\t\tif (!this._inEditMode)\n\t\t\treturn true;\t\n\t\tconst input=this._cellCursor.querySelector(\"input\");\n\t\tif (this._activeSchemaNode.input.format?.stripDelimiterOnSave&&this._activeSchemaNode.input.format.delimiter)\n\t\t\tinput.value=input.value.replaceAll(this._activeSchemaNode.input.format.delimiter, \"\");\n\t\tif (this._activeSchemaNode.input.validation&&save&&!this._validateInput(input.value))\n\t\t\treturn false;\n\t\t//make the table focused again so that it accepts keystrokes and also trigger any blur-event on input-element\n\t\tthis.rootEl.focus({preventScroll:true});//so that #inputVal gets updated-\n\n\n\t\tthis._inEditMode=false;\n\t\tthis._cellCursor.classList.remove(\"edit-mode\");\n\t\tif (save&&this._inputVal!=this._selectedCellVal) {\n\t\t\tthis._doEditSave();\n\t\t}\n\t\tthis._cellCursor.innerHTML=\"\";\n\t\t//if (this._activeSchemaNode.input.type===\"textarea\")//also needed for file..\n\t\tthis._adjustCursorPosSize(this._selectedCell);\n\t\tthis._highlightOnFocus=false;\n\t\treturn true;\n\t}\n\n\t_showTooltip(message,target=this._cellCursor) {\n\t\tthis._cellCursor.parentElement.appendChild(this._tooltip);\n\t\tsetTimeout(()=>this._tooltip.style.visibility=\"visible\");//set it on a delay because mouseDownHandler might\n\t\t\t\t\t\t//otherwise immediately set it back to hidden when bubbling up depending on where the click was\n\t\tthis._tooltip.firstChild.innerText=message;\n\t\tthis._alignDropdown(this._tooltip,target);\n\t\tthis._scrollElementIntoView(this._tooltip);\n\t\treturn true;\n\t}\n\n\t_scrollElementIntoView(){}//default is to do nothing. Tablance (main) overrides this.\n\n\t_closeRepeatedInsertion(repeatEntry) {\n\t\tif (Object.values(repeatEntry.dataObj).filter(x=>x!=null).length) {\n\t\t\tlet message;//message to show to the user if creation was unsucessful\n\t\t\tfor (var root=repeatEntry; root.parent; root=root.parent);//get root-object in order to retrieve rowIndex\n\t\t\tlet doCreate=true;\n\t\t\tif (repeatEntry.schemaNode.creationValidation)\n\t\t\t\tdoCreate=repeatEntry.schemaNode.creationValidation(m=>message=m,repeatEntry.schemaNode\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t,repeatEntry.dataObj,root.rowIndex,repeatEntry);\n\t\t\tif (!doCreate) {\n\t\t\t\tif (message)\n\t\t\t\t\tthis._showTooltip(message,repeatEntry.el);\n\t\t\t\treturn false;//prevent commiting/closing the group\n\t\t\t}\n\t\t\tconst creationContainer=repeatEntry.schemaNode.type==\"group\"?repeatEntry:repeatEntry.parent;\n\t\t\tconst repeatedContainer=creationContainer.parent;\n\t\t\tconst dataContext=repeatedContainer?.parent?.dataObj??this._data[root.rowIndex];\n\t\t\tconst payload={\n\t\t\t\tnewDataItem: repeatEntry.dataObj,\n\t\t\t\tdataContext,\n\t\t\t\tdataArray: repeatedContainer?.dataObj,\n\t\t\t\tdataKey: repeatedContainer?.schemaNode.id,\n\t\t\t\titemIndex: repeatEntry.index,\n\t\t\t\trepeatedSchemaNode: repeatedContainer?.schemaNode,\n\t\t\t\tentrySchemaNode: creationContainer.schemaNode,\n\t\t\t\tnewInstanceNode: repeatEntry,\n\t\t\t\tmainIndex: root.rowIndex,\n\t\t\t\tbulkEdit: false,\n\t\t\t\tclosestMeta: key => this._closestMeta(creationContainer.schemaNode, key),\n\t\t\t\tcancelCreate: ()=>doCreate=false\n\t\t\t};\n\t\t\trepeatEntry.creating=false;\n\t\t\tcreationContainer.schemaNode.onCreate?.(payload);\n\t\t\tif (!doCreate) {\n\t\t\t\tthis._deleteCell(repeatEntry);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t} else {\n\t\t\tthis._deleteCell(repeatEntry);\n\t\t\treturn false;\n\t\t}\n\t\treturn true;\n\t}\n\n\t_closeActiveDetailsCell() {\n\t\tif (this._activeDetailsCell) {\n\t\t\tfor (let oldCellParent=this._activeDetailsCell; oldCellParent=oldCellParent.parent;) {\n\t\t\t\tif (oldCellParent.schemaNode.type===\"group\") {\n\t\t\t\t\tif (!this._closeGroup(oldCellParent))//close any open group above old cell\n\t\t\t\t\t\treturn false;\n\t\t\t\t\tthis._ignoreClicksUntil=Date.now()+500;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\toldCellParent.schemaNode.onBlur?.(oldCellParent,this._mainRowIndex);\n\t\t\t}\n\t\t\tthis._activeDetailsCell=null;//should be null when not inside details\n\t\t}\n\t\treturn true;\n\t}\n\n\n\t_selectMainTableCell(cell) {\n\t\tif (!cell)\t//in case of trying to move up from top row etc,\n\t\t\treturn;\n\t\tif (!this._exitEditMode(true))//try to exit-mode and commit any changes.\n\t\t\treturn false;//if exiting edit-mode was denied then do nothing more\n\t\t\t\n\t\t\n\t\tthis._mainColIndex=cell.cellIndex;\n\t\tconst mainRowIndex=parseInt(cell.parentElement.dataset.dataRowIndex);//save it here rather than setting it \n\t\t\t\t\t//directly because we do not want it to change if #selectCell returns false, preventing the select\n\t\t\t\t\t\n\t\tif (this._closeActiveDetailsCell()) {\n\t\t\tthis._selectCell(cell,this._colSchemaNodes[this._mainColIndex],this._data[mainRowIndex]);\n\t\t\tthis._mainRowIndex=mainRowIndex;\n\t\t}\n\t}\n\n\t_selectDetailsCell(instanceNode) {\n\t\tif (!this._exitEditMode(true))//try to exit-mode and commit any changes.\n\t\t\treturn false;//if exiting edit-mode was denied then do nothing more\n\n\t\tconst oldExpCell=this._activeDetailsCell;//need to know the current/old details-cell if any for closing groups\n\t\t\t\t\t//etc but we can't just use this._activeDetailsCell because #selectCell changes it and we do want\n\t\t\t\t\t//to call #selectCell first in order to know if changing cell is being prevented by validation()\n\n\t\tfor (var root=instanceNode; root.parent; root=root.parent);\n\t\tconst mainRowIndex=root.rowIndex;\n\t\tif (oldExpCell)//changing from an old detailsCell\n\t\t\tfor (let oldParnt=oldExpCell; oldParnt=oldParnt?.parent;)//traverse parents of old cell\n\t\t\t\tif(oldParnt.schemaNode.type===\"group\"||oldParnt.schemaNode.onBlur||oldParnt.creating){//found group/cell\n\t\t\t\t\t//...with onBlur or cell that is being created. For any of these we want to observe the cell being\n\t\t\t\t\t//left so that appropriate action can be taken\n\t\t\t\t\tfor (let newParent=instanceNode; newParent=newParent.parent;)//traverse parents of new cell\n\t\t\t\t\t\tif (newParent===oldParnt) {//if this new parent-group is also part of old parents\n\t\t\t\t\t\t\toldParnt=null;//break out of outer loop\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\tif (oldParnt) {\n\t\t\t\t\t\tif (oldParnt.schemaNode.type===\"group\"&&!this._closeGroup(oldParnt))\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\tif (oldParnt.schemaNode.onBlur)\n\t\t\t\t\t\t\toldParnt.schemaNode.onBlur?.(oldParnt,mainRowIndex);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\tthis._selectCell(instanceNode.selEl??instanceNode.el,instanceNode.schemaNode,instanceNode.dataObj,false);\n\t\tthis._mainRowIndex=mainRowIndex;\n\n\t\t//in case this was called via instanceNode.select() it might be necessary to make sure parent-groups are open\n\t\tfor (let parentCell=instanceNode; parentCell=parentCell.parent;)\n\t\t\tif (parentCell.schemaNode.type==\"group\")\n\t\t\t\tparentCell.el.classList.add(\"open\");\n\n\t\tthis._adjustCursorPosSize(instanceNode.selEl??instanceNode.el);\n\t\tthis._activeDetailsCell=instanceNode;\n\t\treturn instanceNode;\n\t}\n\n\t_selectCell(cellEl,schemaNode,dataObj,adjustCursorPosSize=true) {\n\t\tthis.rootEl.focus({preventScroll:true});\n\t\tif (adjustCursorPosSize)\n\t\t\tthis._adjustCursorPosSize(cellEl);\n\t\tthis._cellCursor.classList.toggle(\"details\",cellEl.closest(\".details\"));\n\t\tthis._cellCursor.classList.toggle(\"disabled\",cellEl.classList.contains(\"disabled\"));\n\t\t(this._scrollingContent??this.rootEl).appendChild(this._cellCursor);\n\t\tthis._selectedCell=cellEl;\n\t\tthis._activeSchemaNode=schemaNode;\n\t\t//make cellcursor click-through if it's on an expand-row-button-td, select-row-button-td or button\n\t\tconst noPtrEvent=schemaNode.type===\"expand\"||schemaNode.type===\"select\"||schemaNode.input?.type===\"button\";\n\t\tthis._cellCursor.style.pointerEvents=noPtrEvent?\"none\":\"auto\";\n\t\tthis._cellCursor.style.removeProperty(\"background-color\");//select-input sets it to transparent, revert here\n\t\tthis._cellCursorDataObj=dataObj;\n\t\tthis._selectedCellVal=dataObj?.[schemaNode.id];\n\t}\n\n\t_getElPos(el,container) {\n\t\tconst cellPos=el.getBoundingClientRect();\n\t\tif (!container)\n\t\t\tcontainer=this._tableSizer??this.rootEl;\n\t\tconst contPos=container.getBoundingClientRect();\n\t\treturn {x:cellPos.x-contPos.x, y:cellPos.y-contPos.y+(this._tableSizer?.offsetTop??0)}\n\t}\n\n\t_adjustCursorPosSize(el,onlyPos=false) {\n\t\tif (!el)\n\t\t\treturn;\n\t\tconst elPos=this._getElPos(el);\n\t\tthis._cellCursor.style.top=elPos.y+\"px\";\n\t\tthis._cellCursor.style.left=elPos.x+\"px\";\n\t\tthis._cellCursor.style.display=\"block\";//it starts at display none since #setupSpreadsheet, so make visible now\n\t\tif (!onlyPos) {\n\t\t\tthis._cellCursor.style.height=el.offsetHeight+\"px\";\n\t\t\tthis._cellCursor.style.width=el.offsetWidth+\"px\";\n\t\t}\n\t}\n\n\t_createTableHeader() {\n\t\tthis._headerTable=this.rootEl.appendChild(document.createElement(\"table\"));\n\t\tthis._headerTable.classList.add(\"header-table\");\n\t\tconst thead=this._headerTable.appendChild(document.createElement(\"thead\"));\n\t\tthis._headerTr=thead.insertRow();\n\t\tfor (let col of this._colSchemaNodes) {\n\t\t\tlet th=this._headerTr.appendChild(document.createElement(\"th\"));\n\t\t\tth.addEventListener(\"click\",e=>this._onThClick(e));\n\t\t\tif (col.type==\"select\") {\n\t\t\t\tth.appendChild(this._createCheckbox());\n\t\t\t\tth.classList.add(\"select-col\");\n\t\t\t} else if (col.type==\"expand\") {\n\t\t\t\tconst expandDiv=th.appendChild(document.createElement(\"div\"));\n\t\t\t\texpandDiv.classList.add(\"expand-div\");//used to identify if expand-button was clicked in click-handler\n\t\t\t\t//expandDiv.appendChild(this._createExpandContractButton());//functionality not fully implemented yet\n\t\t\t\tth.classList.add(\"expand-col\");\n\t\t\t} else\n\t\t\t\tth.innerText=col.title??\"\\xa0\";//non breaking space if nothing else or else\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//sorting arrows wont be positioned correctly\n\n\t\t\t//create the divs used for showing html for sorting-up/down-arrow or whatever has been configured\n\t\t\tcol.sortDiv=th.appendChild(document.createElement(\"DIV\"));\n\t\t\tcol.sortDiv.className=\"sortSymbol\";\n\t\t}\n\t\tthis._headerTr.appendChild(document.createElement(\"th\"));\n\t}\n\n\t_onThClick(e) {\n\t\tconst clickedIndex=e.currentTarget.cellIndex;\n\t\tif (this._colSchemaNodes[clickedIndex].type==\"select\"&&e.target.tagName.toLowerCase()==\"input\")\n\t\t\treturn this._toggleRowsSelected(e.target.checked,0,this._data.length-1);\n\t\tif (e.target.closest(\".expand-div\"))\n\t\t\treturn this._expandOrContractAll(!e.target.closest(\"tr\").classList.contains(\"expanded\"));\n\t\tlet sortingColIndex=-1,sortingCol;\n\t\twhile (sortingCol=this._sortingCols[++sortingColIndex]) {\n\t\t\tif (sortingCol.index===clickedIndex) {\n\t\t\t\tif (e.shiftKey&&this._sortingCols.length>1&&sortingCol.order==\"desc\") {\n\t\t\t\t\tthis._sortingCols.splice(sortingColIndex,1);\n\t\t\t\t\tsortingColIndex=0;//to not make condition below loop fall true\n\t\t\t\t} else\n\t\t\t\t\tsortingCol.order=sortingCol.order==\"asc\"?\"desc\":\"asc\";\n\t\t\t\tif (!e.shiftKey)\n\t\t\t\t\tthis._sortingCols=[sortingCol];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (sortingColIndex==this._sortingCols.length) {//if the clicked header wasn't sorted upon at all\n\t\t\tconst {id,type}=this._colSchemaNodes[clickedIndex];\n\t\t\tconst sortCol={id,type,order:\"asc\",index:clickedIndex};\n\t\t\tif (!e.shiftKey)\n\t\t\t\tthis._sortingCols=[];\n\t\t\tthis._sortingCols.push(sortCol);\n\t\t}\n\t\tthis._updateHeaderSortHtml();\n\t\te.preventDefault();//prevent text-selection when shift-clicking and double-clicking\n\t\tthis._sortData();\n\t\tthis._refreshTable();\n\t}\n\n\t_expandOrContractAll(expand) {\n\t\tthis._scrollBody.scrollTop=0;\n\t\tthis._scrollMethod();\n\t\tlet rows;\n\t\tif (expand) {\n\t\t\trows=this._tableSizer.querySelectorAll(\".main-table>tbody>tr:not(.details):not(.expanded)\");\n\t\t\tfor (const row of rows)\n\t\t\t\tthis._expandRow(row);\n\t\t\tfor (const dataRow of this._data) {\n\t\t\t\tconst index=this._rowsMeta.keys.indexOf(dataRow);\n\t\t\t\tif (index!=-1) {\n\t\t\t\t\tthis._rowsMeta.vals[index].h??=-1;\n\t\t\t\t} else {\n\t\t\t\t\tthis._rowsMeta.keys.push(dataRow);\n\t\t\t\t\tthis._rowsMeta.vals.push({h:-1});\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t\t\n\n\t\t//#expandRow(tr,dataRowIndex) {\n\t}\n\n\t_updateHeaderSortHtml() {\n\t\tfor (let [thIndex,th] of Object.entries(this._headerTr.cells)) {\n\t\t\tif (thIndex==this._headerTr.cells.length-1)\n\t\t\t\tbreak;\n\t\t\tlet order=null;\n\t\t\tlet sortDiv=this._colSchemaNodes[thIndex].sortDiv;\n\t\t\tfor (let sortingCol of this._sortingCols) {\n\t\t\t\tif (sortingCol.index==thIndex) {\n\t\t\t\t\torder=sortingCol.order;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!order||th.classList.contains(order==\"asc\"?\"desc\":\"asc\"))\n\t\t\t\tth.classList.remove(\"asc\",\"desc\");\n\t\t\tif (order) {\n\t\t\t\tth.classList.add(order);\n\t\t\t\tsortDiv.innerHTML=(order==\"asc\"?this._opts?.sortAscHtml:this._opts?.sortDescHtml)??\"\";\n\t\t\t} else\n\t\t\t\tsortDiv.innerHTML=this._opts?.sortNoneHtml??\"\";\n\t\t}\n\t}\n\n\t_sortData() {\n\t\tconst sortCols=this._sortingCols;\n\t\tif (!sortCols.length)\n\t\t\treturn false;\n\t\tthis._data.sort(compare.bind(this));\n\t\tif (this._mainRowIndex>=0)//if there is a selected row\n\t\t\tthis._mainRowIndex=this._data.indexOf(this._cellCursorDataObj);//then find it's new pos\n\t\treturn true;\n\t\t\n\t\tfunction compare(a,b) {\n\t\t\tfor (let sortCol of sortCols) {\n\t\t\t\tif (sortCol.type===\"expand\") {\n\t\t\t\t\tlet aV;\n\t\t\t\t\tif ((aV=!!this._rowMetaGet(this._data.indexOf(a))?.h)!=!!this._rowMetaGet(this._data.indexOf(b))?.h)\n\t\t\t\t\t\treturn (aV?-1:1)*(sortCol.order==\"asc\"?1:-1);\n\t\t\t\t} else if (sortCol.type===\"select\") {\n\t\t\t\t\tlet aSel;\n\t\t\t\t\tif ((aSel=this._selectedRows.indexOf(a)!=-1)!=(this._selectedRows.indexOf(b)!=-1))\n\t\t\t\t\t\treturn (aSel?-1:1)*(sortCol.order==\"asc\"?1:-1);\n\t\t\t\t} else if (a[sortCol.id]!=b[sortCol.id])\n\t\t\t\t\treturn (a[sortCol.id]>b[sortCol.id]?1:-1)*(sortCol.order==\"asc\"?1:-1);\n\t\t\t}\n\t\t}\n\t}\n\n\t_createTableBody() {\n\t\tthis._scrollBody=this.rootEl.appendChild(document.createElement(\"div\"));\n\n\t\tif (this._staticRowHeight&&!this._schema.details)\n\t\t\tthis._scrollMethod=this._onScrollStaticRowHeightNoDetails;\n\t\telse if (this._staticRowHeight&&this._schema.details)\n\t\t\tthis._scrollMethod=this._onScrollStaticRowHeightDetails;\n\t\tthis._scrollBody.addEventListener(\"scroll\",e=>this._scrollMethod(e),{passive:true});\n\t\tthis._scrollBody.className=\"scroll-body\";\n\t\t\n\t\tthis._scrollingContent=this._scrollBody.appendChild(document.createElement(\"div\"));\n\t\tthis._scrollingContent.className=\"scrolling-content\";\n\n\t\tthis._tableSizer=this._scrollingContent.appendChild(document.createElement(\"div\"));\n\t\tthis._tableSizer.style.position=\"relative\";\n\t\tthis._tableSizer.style.top=\"0px\";//need to have so that scrolling works properly when reading parseInt of it\n\t\tthis._tableSizer.className=\"table-sizer\";\n\n\t\tthis._mainTable=this._tableSizer.appendChild(document.createElement(\"table\"));\n\t\tthis._mainTable.className=\"main-table\";\n\t\tthis._mainTbody=this._mainTable.appendChild(document.createElement(\"tbody\"));\n\t\tfor (let i = 0; i < this._colSchemaNodes.length; i++) {\n\t\t\tlet col=document.createElement(\"col\");\n\t\t\tthis._cols.push(col);\n\t\t\tthis._mainTable.appendChild(document.createElement(\"colgroup\")).appendChild(col);\n\t\t}\n\t\tthis._borderSpacingY=parseInt(window.getComputedStyle(this._mainTable)['border-spacing'].split(\" \")[1]);\n\t}\n\n\t_createBulkEditArea(schema) {\n\t\tthis._bulkEditArea=this.rootEl.appendChild(document.createElement(\"div\"));\n\t\tthis._bulkEditArea.classList.add(\"bulk-edit-area\");\n\t\tthis._bulkEditArea.addEventListener(\"transitionend\",()=>{\n\t\t\tdelete this._animations[\"adjustViewportHeight\"];\n\t\t\tif (this._bulkEditArea.style.height!=\"0px\")\n\t\t\tthis._bulkEditArea.style.overflow=\"visible\";//have to shift between hidden/visible because hidden is needed\n\t\t\t\t\t\t\t\t\t//for animation but visible is needed for dropdowns to be able to go outside of area\n\t\t});\n\n\t\t//extra div needed for having padding while also being able to animate height all the way to 0\n\t\tconst bulkContent=this._bulkEditArea.appendChild(document.createElement(\"div\"));\n\n\t\tconst numberOfRowsSelectedDiv=bulkContent.appendChild(document.createElement(\"div\"));\n\t\tnumberOfRowsSelectedDiv.innerText=\"Number of selected rows: \";\n\t\tthis._numberOfRowsSelectedSpan=numberOfRowsSelectedDiv.appendChild(document.createElement(\"span\"));\n\n\t\tconst pagesDiv=bulkContent.appendChild(document.createElement(\"div\"));//for having multiple pages\n\t\tpagesDiv.classList.add(\"pages\");\t\t\t\t\t\t\t\t\t\t//which is needed if having groups in it\n\t\t\n\t\tconst mainPage=pagesDiv.appendChild(document.createElement(\"div\"));\n\t\tconst tableContainer=mainPage.appendChild(document.createElement(\"div\"));\n\t\tmainPage.classList.add(\"main\");\n\t\tmainPage.style.display=\"block\";\n\n\t\tconst bulkEditFields=this._buildBulkEditSchemaNodes(schema.details);\n\t\tfor (const column of schema.main.columns)\n\t\t\tbulkEditFields.push(...this._buildBulkEditSchemaNodes(column));\n\n\t\t//Build schema for bulk-edit-area based on the real schema\n\t\tconst bulkSchema={details:{type:\"lineup\",entries:bulkEditFields}};//WRAP\n\n\t\tthis._bulkEditTable=new TablanceBulk(tableContainer,bulkSchema,null,true,null);\n\t\tthis._bulkEditTable.mainInstance=this;\n\t\tthis._bulkEditTable._dropdownAlignmentContainer=this._bulkEditArea;\n\t\tthis._bulkEditTable.addData([{}]);\n\n\t\tthis._bulkEditAreaHeightPx=this._bulkEditArea.firstChild.offsetHeight;\n\t\tthis._bulkEditArea.style.height=0;//start at height 0 before expanded. but do this after having measured above\n\t}\n\n\t_isObject(val) {\n\t\treturn val&&typeof val===\"object\"&&!Array.isArray(val);\n\t}\n\n\t/**Given a schemaNode like details or column, will add inputs to this._bulkEditSchemaNodes which later is iterated\n\t * and the contents added to the bulk-edit-area. \n\t * @param {*} schema Should be details or column when called from outside, but it calls itself recursively\n\t * \t\t\t\t\t\twhen hitting upon containers which then are passed to this param\n\t * @returns */\n\t_buildBulkEditSchemaNodes(schema) {\n\t\tconst result=[];\n\t\tif ((!schema.type||schema.type==\"field\")&&schema.bulkEdit) {\n\t\t\t//schema-nodes of main-columns don't need to specify this, but it's needed in details\n\t\t\tresult.push(Object.assign(Object.create(null), schema, {type:\"field\"}));\n\t\t} else if ((schema.entries?.length&&schema.bulkEdit)||schema===this._schema.details) {\n\t\t\tfor (const schemaNode of schema.entries)\n\t\t\t\tresult.push(...this._buildBulkEditSchemaNodes(schemaNode));//TODO this has to be fixed to deal with wrapped...\n\t\t}\n\t\treturn result;\n\t}\n\n\t/**Updates the displayed values in the bulk-edit-area */\n\t_updateBulkEditAreaCells(schemaNodesToUpdateCellsFor=this._bulkEditTable._schema.details.entries) {\n\t\tconst mixedText=\"(Mixed)\";\n\t\tfor (let multiCellI=-1, multiCellSchemaNode; multiCellSchemaNode=schemaNodesToUpdateCellsFor[++multiCellI];) {\n\n\t\t\t//work out if there are mixed values for this cell among the selected rows, or if all are same\n\t\t\tlet mixed=false;\n\t\t\tlet val,lastVal;\n\t\t\tfor (let rowI=-1,row; row=this._selectedRows[++rowI];) {\n\t\t\t\tval=row[multiCellSchemaNode.id];\n\t\t\t\tif (rowI&&val!=lastVal) {\n\t\t\t\t\tmixed=true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tlastVal=val;\n\t\t\t}\n\n\n\t\t\t//update both the data and the dom\n\t\t\tthis._bulkEditTable.updateData(0,multiCellSchemaNode.id,mixed?mixedText:val?.text??val??\"\");\n\t\t\tconst el=this._bulkEditTable._openDetailsPanes[0].children[multiCellI].el;\n\t\t\tel.innerText=mixed?mixedText:val?.text??val??\"\";\n\t\t\tthis._bulkEditTable._data[0][multiCellSchemaNode.id]=mixed?\"\":val;\n\t\t}\n\t}\n\n\t_updateSizesOfViewportAndCols() {\n\t\tif (this.hostEl.offsetHeight != this._containerHeight) {\n\t\t\tthis._updateViewportHeight();\n\t\t\tif (this.hostEl.offsetHeight > this._containerHeight)\n\t\t\t\tthis._maybeAddTrs();\n\t\t\telse\n\t\t\t\tthis._maybeRemoveTrs();\n\t\t\tthis._containerHeight = this.hostEl.offsetHeight;\n\t\t}\n\t\tthis._updateColsWidths();\n\t\tthis._headerTable.style.width = this._scrollBody.offsetWidth + \"px\";\n\t\tthis._adjustCursorPosSize(this._selectedCell);\n\t}\n\n\t_updateColsWidths() {\n\t\tif (this.rootEl.offsetWidth>this._containerWidth) {\n\t\t\tlet areaWidth=this._tableSizer.offsetWidth;\n\t\t\tconst percentageWidthRegex=/\\d+%/;\n\t\t\tlet totalFixedWidth=0;\n\t\t\tlet numUndefinedWidths=0;\n\t\t\tfor (let col of this._colSchemaNodes)\n\t\t\t\tif (!col.width)\n\t\t\t\t\tnumUndefinedWidths++;\n\t\t\t\telse if (!percentageWidthRegex.test(col))//if fixed width\n\t\t\t\t\ttotalFixedWidth+=(col.pxWidth=parseInt(col.width));\n\t\t\tlet sumFixedAndFlexibleWidth=totalFixedWidth;\n\t\t\tfor (let col of this._colSchemaNodes)\n\t\t\t\tif (col.width&&percentageWidthRegex.test(col))//if flexible width\n\t\t\t\t\tsumFixedAndFlexibleWidth+=(col.pxWidth=(areaWidth-totalFixedWidth)*parseFloat(col.width)/100);\n\t\t\tfor (let col of this._colSchemaNodes)\n\t\t\t\tif (!col.width)//if undefined width\n\t\t\t\t\tcol.pxWidth=(areaWidth-sumFixedAndFlexibleWidth)/numUndefinedWidths;\n\t\t\tfor (var colI=0; colI<this._colSchemaNodes.length; colI++) \n\t\t\t\tthis._cols[colI].style.width=this._headerTr.cells[colI].style.width\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t=this._colSchemaNodes[colI].pxWidth+\"px\";\n\t\t\t//last col is empty col with the width of table-scrollbar if its present in order to make the header span\n\t\t\t//the whole with while not actually using that last bit in the calculations for the normal cols\n\t\t\tthis._headerTr.cells[colI].style.width=this._scrollBody.offsetWidth-areaWidth+\"px\";\n\t\t}\n\t}\n\n\t_filterData(filterString) {\n\t\tthis._openDetailsPanes={};\n\t\tthis._rowsMeta={keys:[],vals:[]};\n\t\tfor (const tr of this._mainTbody.querySelectorAll(\"tr.details\"))\n\t\t \ttr.remove();\n\t\tthis._filter=filterString;\n\t\tconst colsToFilterBy=[];\n\t\tconst selectsOptsByVal={};//for each col that is of the select type, a entry will be placed in this with the\n\t\t\t//col-index as key and an object as val. the object holds all the options but they are keyed by teir value\n\t\t\t//rather than being in an indexed array.This is to simplify and likely improve speed of filtering by the col\n\n\t\tfor (let col of this._colSchemaNodes)\n\t\t\tif (col.type!==\"expand\"&&col.type!==\"select\") {\n\t\t\t\tif (col.input?.type==\"select\") {\n\t\t\t\t\tconst optsByVal=selectsOptsByVal[colsToFilterBy.length]={};\n\t\t\t\t\tfor (const opt of col.input.options)\n\t\t\t\t\t\toptsByVal[opt.value]=opt;\n\t\t\t\t}\n\t\t\t\tcolsToFilterBy.push(col);\n\t\t\t}\n\t\tif (filterString) {\n\t\t\tthis._data=[];\n\t\t\tfor (let dataRow of this._allData)\n\t\t\t\tfor (let colI=-1,col; col=colsToFilterBy[++colI];) {\n\t\t\t\t\tif (dataRow[col.id]!=null) {\n\t\t\t\t\t\tlet match=false;\n\t\t\t\t\t\tif (col.input?.type==\"select\") {\n\t\t\t\t\t\t\tif (typeof dataRow[col.id]==\"string\")\n\t\t\t\t\t\t\t\tmatch=selectsOptsByVal[dataRow[col.id]].text.includes(filterString);\n\t\t\t\t\t\t\telse\n\t\t\t\t\t\t\t\tmatch=dataRow[col.id].text.includes(filterString);\n\t\t\t\t\t\t} else\n\t\t\t\t\t\t\tmatch=dataRow[col.id].includes(filterString);\n\t\t\t\t\t\tif (match) {\n\t\t\t\t\t\t\tthis._data.push(dataRow);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t} else\n\t\t\tthis._data=this._allData;\n\t\tthis._scrollRowIndex=0;\n\t\tthis._refreshTable();\n\t\tthis._refreshTableSizerNoDetails();\n\t}\n\n\t_setDataForOnlyDetails(data) {\n\t\tthis._allData=this._data=[data[data.length-1]];\n\t\tthis.rootEl.innerHTML=\"\";\n\t\tconst detailsDiv=this.rootEl.appendChild(document.createElement(\"div\"));\n\t\tdetailsDiv.classList.add(\"details\");\n\t\tthis._generateDetailsContent(this._schema.details,0,this._openDetailsPanes[0]={},detailsDiv,[],this._data[0]);\n\t}\n\n\t/**Refreshes the table-rows. Should be used after sorting or filtering or such.*/\n\t_refreshTable() {\n\t\t//In order to render everything correctly and know which rows should be rendered in the view we need to go from\n\t\t//top to bottom because the number of expanded rows above the view might have changed. So go to \n\t\t//#scrollRowIndex 0 to start at top row, also set #scrollY to 0 so the scrollMethod compares the current\n\t\t//scrollTop with 0.\n\t\tthis._scrollRowIndex=this._scrollY=0;\n\n\t\tthis._lastCheckedIndex=null;\n\n\t\t//adjust the sizer to what its top and height would be when scrolled all the way up.\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)+parseInt(this._tableSizer.style.top)+\"px\";\n\t\tthis._tableSizer.style.top=this._numRenderedRows=0;\n\n\t\t//its position and size needs to be udated.Hide for now and let #updateRowValues or #renderDetails add it back\n\t\tthis._cellCursor.style.display=\"none\";\n\n\t\tthis._mainTbody.replaceChildren();//remove all the tr-elements\n\t\tthis._maybeAddTrs();//add them again and with their correct data, at least based on them being the top rows \n\t\tthis._scrollMethod();//now scroll back to the real scroll-position\n\t}\n\n\t/**This onScroll-handler is used when rows are of static height and can't be expanded either.\n\t * It is the fastest scroll-method since row-heights are known and it is easy to calculate which rows should be\n\t * rendered even when scrolling more than a whole page at once as each row won't have to be iterated, and rows\n\t * will only have to be created or deleted if the table is resized so the same tr-elements are reused.* \n\t * @returns */\n\t_onScrollStaticRowHeightNoDetails() {\n\t\tconst scrY=Math.max(this._scrollBody.scrollTop-this._scrollMarginPx,0);\n\t\tconst newScrollRowIndex=Math.min(parseInt(scrY/this._rowHeight),this._data.length-this._mainTbody.rows.length);\n\t\t\n\t\tif (newScrollRowIndex==this._scrollRowIndex)\n\t\t\treturn;\n\t\tif(Math.abs(newScrollRowIndex-this._scrollRowIndex)>this._mainTbody.rows.length){//if scrolling by whole page(s)\n\t\t\tthis._scrollRowIndex=parseInt(scrY/this._rowHeight);\n\t\t\tthis._refreshTable();\n\t\t} else {\n\t\t\tconst scrollSignum=Math.sign(newScrollRowIndex-this._scrollRowIndex);//1 if moving down, -1 if up\n\t\t\tdo {\n\t\t\t\tthis._scrollRowIndex+=scrollSignum;\n\t\t\t\tif (scrollSignum==1) {//moving down\t\t\t\t\t\t\t\t\t\t\t\tmove top row to bottom\n\t\t\t\t\tconst dataIndex=this._scrollRowIndex+this._numRenderedRows-1;\n\t\t\t\t\tthis._updateRowValues(this._mainTbody.appendChild(this._mainTbody.firstChild),dataIndex);\n\t\t\t\t} else {//moving up\n\t\t\t\t\tlet trToMove=this._mainTbody.lastChild;\t\t\t\t\t\t\t\t\t//move bottom row to top\n\t\t\t\t\tthis._mainTbody.prepend(trToMove);\n\t\t\t\t\tthis._updateRowValues(trToMove,this._scrollRowIndex);\n\t\t\t\t}\n\t\t\t} while (this._scrollRowIndex!=newScrollRowIndex);\n\t\t}\n\t\tthis._refreshTableSizerNoDetails();\n\t}\n\n\t_onScrollStaticRowHeightDetails(_e) {\n\t\tconst newScrY=Math.max(this._scrollBody.scrollTop-this._scrollMarginPx,0);\n\t\tif (newScrY>parseInt(this._scrollY)) {//if scrolling down\n\t\t\twhile (newScrY-parseInt(this._tableSizer.style.top)\n\t\t\t>(this._rowMetaGet(this._scrollRowIndex)?.h??this._rowHeight)) {//if a whole top row is outside\n\t\t\t\tif (this._scrollRowIndex+this._numRenderedRows>this._data.length-1)\n\t\t\t\t\tbreak;\n\t\t\t\tlet topShift;//height of the row that is at the top before scroll and which will be removed which is the\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// amount of pixels the whole table is shiftet by\n\t\t\t\t//check if the top row (the one that is to be moved to the bottom) is expanded\n\t\t\t\tif (topShift=this._rowMetaGet(this._scrollRowIndex)?.h) {\n\t\t\t\t\tdelete this._openDetailsPanes[this._scrollRowIndex];\n\t\t\t\t\tthis._mainTbody.rows[1].remove();\n\t\t\t\t} else\n\t\t\t\t\ttopShift=this._rowHeight;\n\t\t\t\tconst dataIndex=this._numRenderedRows+this._scrollRowIndex;//the data-index of the new row\n\n\t\t\t\t//move the top row to bottom and update its values\n\t\t\t\tconst trToMove=this._updateRowValues(this._mainTbody.appendChild(this._mainTbody.firstChild),dataIndex);\n\n\t\t\t\t//move the table down by the height of the removed row to compensate,else the whole table would shift up\n\n\t\t\t\tthis._doRowScrollDetails(trToMove,dataIndex,this._scrollRowIndex,-topShift);\n\t\t\t\tthis._scrollRowIndex++;\n\t\t\t}\n\t\t} else if (newScrY<parseInt(this._scrollY)) {//if scrolling up\n\t\t\twhile (newScrY<parseInt(this._tableSizer.style.top)) {//while top row is below top of viewport\n\t\t\t\tthis._scrollRowIndex--;\n\n\t\t\t\t//check if the bottom row (the one that is to be moved to the top) is expanded\n\t\t\t\tif (this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows)?.h) {\n\t\t\t\t\tdelete this._openDetailsPanes[this._scrollRowIndex+this._numRenderedRows];\n\t\t\t\t\tthis._mainTbody.lastChild.remove();//remove the details-tr\n\t\t\t\t}\n\n\t\t\t\tlet trToMove=this._mainTbody.lastChild;\t\t\t\t\t\t\t\t\t//move bottom row to top\n\t\t\t\tthis._mainTbody.prepend(trToMove);\n\t\t\t\tthis._updateRowValues(trToMove,this._scrollRowIndex);//the data of the new row;\n\n\t\t\t\t//height of the row that is added at the top which is amount of pixels the whole table is shiftet by\n\t\t\t\tconst topShift=this._rowMetaGet(this._scrollRowIndex)?.h??this._rowHeight;\n\n\t\t\t\tthis._doRowScrollDetails(trToMove,this._scrollRowIndex,this._scrollRowIndex+this._numRenderedRows,topShift);\n\t\t\t}\n\t\t}\n\t\tthis._scrollY=newScrY;\n\t}\n\n\t/**Used by #onScrollStaticRowHeightDetails whenever a row is actually added/removed(or rather moved)*/\n\t_doRowScrollDetails(trToMove,newMainIndex,oldMainIndex,topShift) {\n\t\tconst detailsHeight=this._rowMetaGet(newMainIndex)?.h;\n\t\tif (detailsHeight>0) {\n\t\t\tthis._renderDetails(trToMove,newMainIndex);\n\t\t} else if (detailsHeight==-1) {\n\t\t\tthis._scrollBody.scrollTop+=this._expandRow(trToMove,false);\n\t\t} else\n\t\t\ttrToMove.classList.remove(\"expanded\");\n\t\t\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)+topShift+\"px\";\n\t\tthis._tableSizer.style.top=parseInt(this._tableSizer.style.top)-topShift+\"px\";\n\n\t\tif (oldMainIndex===this._mainRowIndex) {//cell-cursor is on moved row\n\t\t\tthis._selectedCell=null;\n\t\t\tfor (let cell=this._activeDetailsCell; cell&&(cell=cell.parent);)\n\t\t\t\tif (cell.creating) {\n\t\t\t\t\tcell.creating=false;//otherwise cell.select() below will not work\n\t\t\t\t\tthis._exitEditMode(false);//in case field is validated. Could prevent cell.select() too otherwise\n\t\t\t\t\tcell.parent.dataObj.splice(cell.parent.dataObj.indexOf(cell.dataObj),1);\n\t\t\t\t\twhile (cell&&(cell=cell.parent))\n\t\t\t\t\t\tif (cell.select) {\n\t\t\t\t\t\t\tcell.select();\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t}\n\t\t}\n\n\t\tthis._lookForActiveCellInRow(trToMove);//look for active cell (cellcursor) in the row. This is needed\n\t\t//in order to reassign the dom-element and such and also adjust the pos of the cellcursor in case\n\t\t//the pos of the cell is not the same due to sorting/filtering\n\t}\n\t\n\n\t/**This should be called on each row that is being scrolled into view that might hold the active cell in order\n\t * to set #selectedCell to the correct element\n\t * @param {HTMLTableRowElement} tr */\n\t_lookForActiveCellInRow(tr) {\n\t\tif (tr.dataset.dataRowIndex==this._mainRowIndex) {\n\t\t\tif (!this._activeDetailsCell)\n\t\t\t\tthis._selectedCell=tr.cells[this._mainColIndex];\n\t\t\telse {//if inside details\n\t\t\t\t//generate the path to the instanceNode in #activeDetailsCell by stepping through its parents to root\n\t\t\t\tlet path=[];\n\t\t\t\tfor (let instanceNode=this._activeDetailsCell; instanceNode.parent; instanceNode=instanceNode.parent)\n\t\t\t\t\tpath.unshift(instanceNode.index);\n\t\t\t\t//now follow the same path in the new #openDetailsNavMap[rowIndex], eg the instanceNodes..\n\t\t\t\tlet instanceNode=this._openDetailsPanes[this._mainRowIndex];\n\t\t\t\tfor (let step of path)\n\t\t\t\t\tinstanceNode=instanceNode.children[step];\n\t\t\t\tthis._selectedCell=instanceNode.el;\n\t\t\t\tthis._activeDetailsCell=instanceNode;//should be identical but this allows for the old one to be gc'd\n\t\t\t}\n\t\t\tthis._adjustCursorPosSize(this._selectedCell);\n\t\t}\n\t}\n\n\t_refreshTableSizerNoDetails() {\t\n\t\tthis._tableSizer.style.top=this._scrollRowIndex*this._rowHeight+\"px\";\n\t\tthis._tableSizer.style.height=(this._data.length-this._scrollRowIndex)*this._rowHeight+\"px\";\n\t}\n\n\t_createExpandContractButton() {\n\t\tconst a=document.createElement(\"a\");\n\t\ta.appendChild(document.createElement(\"span\"));\n\t\treturn a;\n\t}\n\n\t_createCheckbox(preventClickSelect) {\n\t\tconst checkbox=document.createElement(\"input\");\n\t\tcheckbox.type=\"checkbox\";\n\t\tcheckbox.tabIndex=\"-1\";\n\n\t\tif (preventClickSelect)//prevent checking and leave to #toggleRowSelected for consistant behavior when \n\t\t\tcheckbox.addEventListener(\"click\",this._preventDefault);//clicking checkbox vs clicking its cell\n\n\t\t//prevent gaining focus when clicking it. Otherwise it does gain focus despite tabIndex -1\n\t\tcheckbox.addEventListener(\"mousedown\",this._preventDefault);\n\n\t\treturn checkbox;\n\t}\n\n\t/**Should be called if tr-elements might need to be created which is when data is added or if table grows*/\n\t_maybeAddTrs() {\n\t\tlet lastTr=this._mainTbody.lastChild;\n\t\tconst scrH=this._scrollBody.offsetHeight+this._scrollMarginPx*2;\n\t\tconst dataLen=this._data.length;\n\t\t//if there are fewer trs than datarows, and if there is empty space below bottom tr\n\t\twhile ((this._numRenderedRows-1)*this._rowHeight<scrH&&this._scrollRowIndex+this._numRenderedRows<dataLen) {\n\t\t\tlastTr=this._mainTable.insertRow();\n\t\t\tthis._numRenderedRows++;\n\t\t\tfor (let i=0; i<this._colSchemaNodes.length; i++) {\n\t\t\t\tconst cell=lastTr.insertCell();\n\t\t\t\tconst div=cell.appendChild(document.createElement(\"div\"));//used to set height of cells\n\t\t\t\tdiv.style.height=this._rowInnerHeight||\"auto\";\t\t\t\t\n\t\t\t\tif (this._colSchemaNodes[i].type===\"expand\") {\n\t\t\t\t\tdiv.appendChild(this._createExpandContractButton());\n\t\t\t\t\tcell.classList.add(\"expand-col\");\n\t\t\t\t} else if (this._colSchemaNodes[i].type===\"select\") {\n\t\t\t\t\tdiv.appendChild(this._createCheckbox(true));\n\t\t\t\t\tcell.classList.add(\"select-col\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._updateRowValues(lastTr,this._scrollRowIndex+this._numRenderedRows-1);\n\t\t\tif (this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows-1)?.h)\n\t\t\t\tthis._renderDetails(lastTr,this._scrollRowIndex+this._numRenderedRows-1);\n\t\t\tthis._lookForActiveCellInRow(lastTr);//look for active cell (cellcursor) in the row\n\t\t\tif (!this._rowHeight) {//if there were no rows prior to this\n\t\t\t\tthis._rowHeight=lastTr.offsetHeight+this._borderSpacingY;\n\t\t\t\tconst tdComputedStyle=window.getComputedStyle(lastTr.firstChild);\n\t\t\t\tfor (let prop of [\"paddingTop\",\"paddingBottom\",\"borderBottomWidth\",\"borderTopWidth\"])\n\t\t\t\t\tthis._rowInnerHeight-=parseInt(tdComputedStyle[prop]);\n\t\t\t\tthis._rowInnerHeight=this._rowInnerHeight+lastTr.offsetHeight+\"px\";\n\t\t\t}\n\t\t}\n\t}\n\n\t_preventDefault(e){\n\t\te.preventDefault();\n\t}\n\n\t/**Should be called if tr-elements might need to be removed which is when table shrinks*/\n\t_maybeRemoveTrs() {\n\t\tconst scrH=this._scrollBody.offsetHeight+this._scrollMarginPx*2;\n\t\twhile ((this._numRenderedRows-2)*this._rowHeight>scrH) {\n\t\t\tif (this._rowMetaGet(this._scrollRowIndex+this._numRenderedRows-1)?.h) {\n\t\t\t\tthis._mainTbody.lastChild.remove();\n\t\t\t\tdelete this._openDetailsPanes[this._scrollRowIndex+this._numRenderedRows];\n\t\t\t}\n\t\t\tthis._mainTbody.lastChild.remove();\n\t\t\tthis._numRenderedRows--;\n\t\t}\n\t}\n\n\t/**Update the values of a row in the table. The tr needs to be passed in as well as the index of the data in #data\n\t * The row needs to already have the right amount of td's.\n\t * @param {HTMLTableRowElement} tr The tr-element whose cells that should be updated*/\n\t_updateRowValues(tr,mainIndex) {\n\t\ttr.dataset.dataRowIndex=mainIndex;\n\t\tconst selected=this._selectedRows.indexOf(this._data[mainIndex])!=-1;\n\t\ttr.classList.toggle(\"selected\",!!selected);\n\t\tfor (let colI=0; colI<this._colSchemaNodes.length; colI++) {\n\t\t\tlet td=tr.cells[colI];\n\t\t\tlet colSchemaNode=this._colSchemaNodes[colI];\n\t\t\tif (colSchemaNode.type!=\"expand\"&&colSchemaNode.type!=\"select\")\n\t\t\t\tthis._updateMainRowCell(td,colSchemaNode);\n\t\t\telse if (colSchemaNode.type==\"select\")\n\t\t\t\ttd.querySelector(\"input\").checked=selected;\n\t\t}\n\t\tif (this._highlightRowsOnView[mainIndex]) {\n\t\t\tdelete this._highlightRowsOnView[mainIndex];\n\t\t\tthis._highlightRowIndex(mainIndex);\n\t\t}\n\t\treturn tr;\n\t}\n\n\t/**\n\t * Format bytes as human-readable text.\n\t * \n\t * @param bytes Number of bytes.\n\t * @param si True to use metric (SI) units, aka powers of 1000. False to use \n\t *           binary (IEC), aka powers of 1024.\n\t * @param dp Number of decimal places to display.\n\t * \n\t * @return Formatted string.\n\t */\n\t_humanFileSize(bytes, si=false, dp=1) {\n\t\tconst thresh = si ? 1000 : 1024;\n\t\n\t\tif (Math.abs(bytes) < thresh) {\n\t\treturn bytes + ' B';\n\t\t}\n\t\n\t\tconst units = si \n\t\t? ['kB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'] \n\t\t: ['KiB', 'MiB', 'GiB', 'TiB', 'PiB', 'EiB', 'ZiB', 'YiB'];\n\t\tlet u = -1;\n\t\tconst r = 10**dp;\n\t\n\t\tdo {\n\t\tbytes /= thresh;\n\t\t++u;\n\t\t} while (Math.round(Math.abs(bytes) * r) / r >= thresh && u < units.length - 1);\n\t\n\t\n\t\treturn bytes.toFixed(dp) + ' ' + units[u];\n\t}\n\n\t_generateFileCell(fileInstanceNode,cellEl,rowData,dataIndex) {\n\t\t//schemaNode of instanceNode will get overwritten. Save reference here.\n\t\tconst fileSchemaNode=fileInstanceNode.schemaNode;\n\n\t\t//saving this ref here which is used to revert with if user deletes file\n\t\tfileInstanceNode.fileInputSchemaNode=fileSchemaNode;\n\n\t\t//define all the file-meta-props\n\t\tconst lang=this._opts.lang??{};\n\t\tlet metaEntries=[{type:\"field\",title:lang.fileName??\"Filename\",id:\"name\"},\n\t\t\t{type:\"field\",title:lang.fileLastModified??\"Last Modified\",id:\"lastModified\",render:date=>\n\t\t\tnew Date(date).toISOString().slice(0, 16).replace('T', ' ')},\n\t\t\t{type:\"field\",title:lang.fileSize??\"Size\",id:\"size\",render:size=>this._humanFileSize(size)},\n\t\t\t{type:\"field\",title:lang.fileType??\"Type\",id:\"type\"}];\n\t\tfor (let metaI=-1,metaName; metaName=[\"filename\",\"lastModified\",\"size\",\"type\"][++metaI];)\n\t\t\tif(!(fileSchemaNode.input.fileMetasToShow?.[metaName]??this._opts.defaultFileMetasToShow?.[metaName]??true))\n\t\t\t\tmetaEntries.splice(metaI,1);//potentially remove (some of) them\n\t\t//define the group-structure for the file\n\t\t\n\t\tconst fileGroup=this._schemaCopyWithDeleteButton({type:\"group\",entries:[]},this._fileOnDelete);\n\t\tfileGroup.entries[0].entries.unshift({type:\"field\",input:{type:\"button\",btnText:\"Open\"\n\t\t\t\t,clickHandler:(e,file,mainIndex,schemaNode,btnObj)=>{\n\t\t\t\t\trowData??=this._data[mainIndex];\n\t\t\t\t\tfileSchemaNode.input.openHandler?.(e,file,fileSchemaNode,fileInstanceNode.dataObj,mainIndex,btnObj);\n\t\t\t}},\n\t\t});\n\t\tfileGroup.entries.push({type:\"lineup\",entries:metaEntries});\n\t\tconst wrappedFileGroup=this._buildSchemaFacade(fileGroup);//WRAPPED\n\t\t\n\t\tconst fileData=rowData[fileInstanceNode.schemaNode.id];\n\t\t//call _buildSchemaTreeFacade on fileGroup here?\n\t\tthis._generateDetailsContent(wrappedFileGroup,dataIndex,fileInstanceNode,cellEl,fileInstanceNode.path,fileData);\n\t\tconst fileMeta=this._mapGet(this._filesMeta,fileData);\n\t\tif (fileMeta!=null) {\n\t\t\tconst progressbarOuter=cellEl.appendChild(document.createElement(\"div\"));\n\t\t\tprogressbarOuter.classList.add(\"progressbar\",\"active\");\n\t\t\tconst progressbarInner=progressbarOuter.appendChild(document.createElement(\"div\"));\n\t\t\tprogressbarInner.style.transition=\"none\";//get to the current pos immediately in case running from before\n\t\t\tfileMeta.bars.push(progressbarInner);\n\t\t\tprogressbarInner.role=\"progressbar\";\n\t\t\tconst progressSpan=progressbarInner.appendChild(document.createElement(\"span\"));\n\t\t\tprogressbarInner.style.width=progressSpan.innerText=parseInt(fileMeta.uploadedBytes/fileData.size*100)+\"%\";\n\t\t\tprogressbarInner.style.removeProperty(\"transition\");//enable transitioning again, it was disabled above\n\t\t}\n\t}\n\n\n\t/**Updates the html-element of a cell inside an details. Also updates nonEmptyDescentants of the instanceNode of \n\t * \tgroup-rows as well as toggling the empty-class of them. Reports back whether visibility has been changed.\n\t * @param {*} instanceNode */\n\t_updateDetailsCell(instanceNode,rowData=null) {\n\t\tlet cellEl=instanceNode.el;\n\t\tif (instanceNode.schemaNode.maxHeight) {//if there's a maxHeight stated, which is used for textareas\n\t\t\tcellEl.innerHTML=\"\";//empty the cell, otherwise multiple calls to this would add more and more content to it\n\t\t\tcellEl=cellEl.appendChild(document.createElement(\"div\"));//then put a div inside and change cellEl to that\n\t\t\tcellEl.style.maxHeight=instanceNode.schemaNode.maxHeight;//then set its maxHeight\n\t\t\tcellEl.style.overflow=\"auto\";//and male it scrollable\n\t\t\t//can't make td directly scrollable which is why the div is needed\n\t\t}\n\t\tfor (var rootCell=instanceNode;rootCell.parent;rootCell=rootCell.parent);\n\t\tconst oldCellContent=cellEl.innerText;\n\t\tif (instanceNode.schemaNode.input?.type==\"file\"&&rowData[instanceNode.schemaNode.id]) {\n\t\t\tthis._generateFileCell(instanceNode,cellEl,rowData,rootCell.rowIndex);\n\t\t} else {\n\t\t\tif (instanceNode.schemaNode.visibleIf)\n\t\t\t\tthis._applyVisibleIf(instanceNode);\n\t\t\tthis._updateCell(instanceNode.schemaNode,cellEl,instanceNode.selEl,rowData,rootCell.rowIndex,instanceNode);\n\t\t\tif (instanceNode.schemaNode.input?.type!==\"button\") {\n\t\t\t\tconst newCellContent=cellEl.innerText;\n\t\t\t\tif (!newCellContent!=!oldCellContent) {\n\t\t\t\t\tfor (let cellI=instanceNode; cellI; cellI=cellI.parent)\n\t\t\t\t\t\tif (cellI.nonEmptyDescentants!=null)\n\t\t\t\t\t\t\tcellI.grpTr.classList.toggle(\"empty\",!(cellI.nonEmptyDescentants+=newCellContent?1:-1));\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t} else\n\t\t\t\tinstanceNode.el=instanceNode.selEl=instanceNode.el.querySelector(\"button\");\n\t\t}\n\t}\n\n\t_getValueByPath(obj, path) {\n\t\tlet cur = obj;\n\t\tfor (const key of path) {\n\t\t\tif (cur == null)\n\t\t\t\treturn undefined;\n\t\t\tcur = cur[key];\n\t\t}\n\t\treturn cur;\n\t}\n\n\t_resolveCellPaths(baseCell, path) {\n\t\tlet target = baseCell;\n\n\t\t// Step 1: go up for each \"..\"\n\t\tfor (var i=0; i < path.length && path[i] === \"..\"; i++) {\n\t\t\tif (!target?.parent)\n\t\t\t\treturn null;\n\t\t\ttarget = target.parent;\n\t\t}\n\n\t\t// Step 2: go down via the remaining indices\n\t\tfor (; i < path.length; i++) {\n\t\t\ttarget = target?.children?.[path[i]];\n\t\t\tif (!target)\n\t\t\t\treturn null;\n\t\t}\n\t\treturn target;\n\t}\n\n\t/**\n\t * Gets the value of a cell, pointed to by its ID, or if it depends on another cell, gets that value. The value\n\t * is the raw data from the data-object, not rendered.\n\t * @param {*} schemaNode \n\t * @param {*} rowData \n\t * @param {*} instanceNode \n\t * @returns \n\t */\n\t_getTargetVal(idOverDependee,schemaNode, instanceNode, rowData=instanceNode.dataObj) {\n\t\tif (idOverDependee&&schemaNode.id)\n\t\t\treturn rowData[schemaNode.id];\n\t\tif (schemaNode.dependsOnDataPath) {\n\t\t\tif (instanceNode)\n\t\t\t\tfor (var root=instanceNode; root.parent; root=root.parent,rowData=root.dataObj);\n\t\t\t return this._getValueByPath(rowData,schemaNode.dependsOnDataPath);\n\t\t}\n\t\tif (schemaNode.dependsOnCellPaths) {\n\t\t\tconst dependee=this._resolveCellPaths(instanceNode,schemaNode.dependsOnCellPaths[0]);\n\t\t\treturn dependee?.dataObj?.[dependee.schemaNode.id];\n\t\t}\n\t\treturn rowData[schemaNode.id];\n\t}\n\t\n\n\t_updateCell(schemaNode,el,selEl,rowData,mainIndex,instanceNode=null) {\n\t\tif (schemaNode.input?.type===\"button\") {\n\t\t\tthis._generateButton(schemaNode,mainIndex,el,rowData,instanceNode);\n\t\t} else {\n\t\t\tlet newCellContent;\n\t\t\tif (schemaNode.render||schemaNode.input?.type!=\"select\") {\n\t\t\t\tnewCellContent=this._getTargetVal(true,schemaNode, instanceNode, rowData);\n\t\t\t\tif (schemaNode.render)\n\t\t\t\t\tnewCellContent=schemaNode.render(newCellContent,rowData,schemaNode,mainIndex,instanceNode);\n\t\t\t} else { //if (schemaNode.input?.type===\"select\") {\n\t\t\t\tlet selOptObj=rowData[schemaNode.id];\n\t\t\t\tif (selOptObj&&typeof selOptObj!==\"object\")\n\t\t\t\t\tselOptObj=rowData[schemaNode.id]=schemaNode.input.options.find(\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\topt=>opt.value==rowData[schemaNode.id]);\n\t\t\t\tnewCellContent=selOptObj?.text??\"\";\n\t\t\t}\n\t\t\tlet isDisabled=false;\n\t\t\tif (this._spreadsheet&&schemaNode.type!==\"expand\") {\n\t\t\t\tconst enabledFuncResult=schemaNode.input?.enabled?.(schemaNode,rowData,mainIndex,instanceNode);\n\t\t\t\tif (!schemaNode.input||enabledFuncResult==false||enabledFuncResult?.enabled==false)\n\t\t\t\t\tisDisabled=true;\n\t\t\t}\n\t\t\t(selEl??el).classList.toggle(\"disabled\",isDisabled);\n\t\t\tif (schemaNode.html)\n\t\t\t\tel.innerHTML=newCellContent??\"\";\n\t\t\telse\n\t\t\t\tel.innerText=newCellContent??\"\";\n\t\t}\n\t}\n\n\t/**Updates the html-element of a main-table-cell\n\t * @param {*} cellEl \n\t * @param {*} colSchemaNode */\n\t_updateMainRowCell(cellEl,colSchemaNode) {\n\t\tcellEl.firstChild.innerHTML=\"\";\n\t\tconst mainIndex=cellEl.closest(\".main-table>tbody>tr\").dataset.dataRowIndex;\n\t\tthis._updateCell(colSchemaNode,cellEl.firstChild,cellEl,this._data[mainIndex],mainIndex);\n\t}\n\n\t_highlightRowIndex(index) {\n\t\tconst tr=this._mainTbody.querySelector(`[data-data-row-index=\"${index}\"]`);\n\t\tif (tr)\n\t\t\tthis._highlightElements(tr.children);\n\t\telse\n\t\t\tthis._highlightRowsOnView[index]=true;\n\t}\n\n\t_highlightElements(elements) {\n\t\tconst origColors=[];\n\t\tfor (const el of elements) {\n\t\t\torigColors.push(window.getComputedStyle(el).backgroundColor);\n\t\t\tel.style.transition = \"none\";\n\t\t\tel.style.backgroundColor=\"blue\";\n\t\t}\n\t\tsetTimeout(()=>{\n\t\t\tfor (const el of elements) {\n\t\t\t\tel.style.transition=\"background-color 1s linear\";\n\t\t\t\tel.style.backgroundColor=origColors.shift();\n\t\t\t}\n\t\t});\n\t}\n\n\t_scrollToCursor(){}//default is to do nothing. Tablance (main) overrides this.\n\t_applyVisibleIf(){}//default is to do nothing. Tablance (main) overrides this.\n}\n\n// Test-only XMLHttpRequest stub to simulate slow uploads in a single spot.\nclass FakeXMLHttpRequest {\n\tconstructor({totalBytes,rate=1,startAt=0}) {\n\t\tthis.totalBytes=totalBytes||1;\n\t\tconst parsedRate=parseFloat(rate);\n\t\tthis.pctPerSecond=Math.max(0.0001,isNaN(parsedRate)?1:parsedRate);//avoid hangs at 0\n\t\tconst parsedStart=parseFloat(startAt);\n\t\tconst startPercent=isNaN(parsedStart)?0:parsedStart;\n\t\tthis.startPercent=Math.max(0,Math.min(100,startPercent));\n\t\tthis._listeners=Object.create(null);\n\t\tthis._uploadListeners=Object.create(null);\n\t\tthis.upload={addEventListener:(type,fn)=>this._addListener(this._uploadListeners,type,fn)};\n\t}\n\n\t_addListener(target,type,fn) {\n\t\t(target[type]??=[]).push(fn);\n\t}\n\n\taddEventListener(type,fn) { this._addListener(this._listeners,type,fn); }\n\topen() {}\n\tsetRequestHeader() {}\n\tabort() { this._clearTimer(); }\n\n\tsend() {\n\t\tlet loaded=this.totalBytes*this.startPercent/100;\n\t\tthis._emit(this._uploadListeners.progress,{loaded,total:this.totalBytes});\n\t\tif (loaded>=this.totalBytes) {\n\t\t\tPromise.resolve().then(()=>this._emit(this._listeners.load,{}));\n\t\t\treturn;\n\t\t}\n\t\tthis._timer=setInterval(()=>{\n\t\t\tloaded=Math.min(this.totalBytes,loaded+this.totalBytes*this.pctPerSecond/100);\n\t\t\tthis._emit(this._uploadListeners.progress,{loaded,total:this.totalBytes});\n\t\t\tif (loaded>=this.totalBytes) {\n\t\t\t\tthis._clearTimer();\n\t\t\t\tthis._emit(this._listeners.load,{});\n\t\t\t}\n\t\t},1000);\n\t}\n\n\t_emit(listeners,event) {\n\t\tif (!listeners)\n\t\t\treturn;\n\t\tfor (const fn of listeners)\n\t\t\tfn(event);\n\t}\n\n\t_clearTimer() {\n\t\tif (this._timer) {\n\t\t\tclearInterval(this._timer);\n\t\t\tthis._timer=null;\n\t\t}\n\t}\n}\n\n/**\n * Secondary Tablance used for the bulk-edit area.\n * Reflects and updates selected rows in the main Tablance instance.\n */\nclass TablanceBulk extends TablanceBase {\n\t/** @type {Tablance} main tablance owning this bulk instance */\n\tmainInstance;\n\t_dropdownAlignmentContainer=this.rootEl;\n\tconstructor() {\n\t\tsuper(...arguments);\n\t}\n\n\t\n\n\t_doEditSave() {\n\t\tconst inputVal=this._activeSchemaNode.input.type===\"select\"?this._inputVal.value:this._inputVal;\n\t\tthis._cellCursorDataObj[this._activeSchemaNode.id]=this._inputVal;\n\t\tfor (const selectedRow of this.mainInstance._selectedRows)\n\t\t\tselectedRow[this._activeSchemaNode.id]=inputVal;\n\t\tfor (const selectedTr of this.mainInstance._mainTbody.querySelectorAll(\"tr.selected\"))\n\t\t\tthis.mainInstance.updateData(selectedTr.dataset.dataRowIndex,this._activeSchemaNode.id,inputVal,false,true);\n\t\tthis._updateDetailsCell(this._activeDetailsCell,this._cellCursorDataObj);\n\t}\n}\n\n/**\n * Primary Tablance component representing the main interactive table.\n * Handles full data display, user interaction, editing, details, and rendering.\n */\nexport default class Tablance extends TablanceBase {\n\tstatic version=TABLANCE_VERSION;\n\tstatic build=TABLANCE_BUILD;\n\n\tconstructor() {\n\t\tsuper(...arguments);\n\t\tthis._dropdownAlignmentContainer=this._onlyDetails?this.rootEl:this._scrollBody;\n\t}\n\t\n\t_doEditSave() {\n\t\tlet doUpdate=true;//if false then the data will not actually change in either dataObject or the html\n\t\tconst inputVal=this._activeSchemaNode.input.type===\"select\"?this._inputVal.value:this._inputVal;\n\n\t\tthis._activeSchemaNode.input.onChange?.({\n\t\t\tnewValue: inputVal,\n\t\t\toldValue: this._selectedCellVal,\n\t\t\tdataKey: this._activeSchemaNode.id,\n\t\t\tdataContext: this._cellCursorDataObj,\n\t\t\tschemaNode: this._activeSchemaNode,\n\t\t\tinstanceNode: this._activeDetailsCell,\n\t\t\tclosestMeta: key => this._closestMeta(this._activeSchemaNode, key),\n\t\t\tcancelUpdate: () => doUpdate=false\n\t\t});\n\n\t\tif (doUpdate) {\n\t\t\tthis._cellCursorDataObj[this._activeSchemaNode.id]=this._inputVal;\n\t\t\tif (this._activeDetailsCell){\n\t\t\t\tconst doHeightUpdate=this._updateDetailsCell(this._activeDetailsCell,this._cellCursorDataObj);\n\t\t\t\tif (doHeightUpdate&&!this._onlyDetails)\n\t\t\t\t\tthis._updateDetailsHeight(this._selectedCell.closest(\"tr.details\"));\n\t\t\t\tfor (let cell=this._activeDetailsCell.parent; cell; cell=cell.parent)\n\t\t\t\t\tif (cell.schemaNode.closedRender)//found a group with a closed-group-render func\n\t\t\t\t\t\tcell.updateRenderOnClose=true;//update closed-group-render\n\t\t\t} else {\n\t\t\t\tthis._updateMainRowCell(this._selectedCell,this._activeSchemaNode);\n\t\t\t\tthis._unsortCol(this._activeSchemaNode.id);\n\t\t\t}\n\t\t\tif (this._selectedRows.indexOf(this._cellCursorDataObj)!=-1)//if edited row is checked/selected\n\t\t\t\tthis._updateBulkEditAreaCells([this._activeSchemaNode]);\n\t\t\tthis._updateDependentCells(this._activeSchemaNode,this._activeDetailsCell);\n\t\t} else\n\t\t\tthis._inputVal=this._selectedCellVal;\n\t\tthis._selectedCellVal=this._inputVal;\n\t}\n\n\t_scrollToCursor() {\n\t\tif (this._onlyDetails)\n\t\t\treturn this._cellCursor.scrollIntoView({block: \"center\"});\n\t\tconst distanceRatioDeadzone=.5;//when moving the cellcursor within this distance from center of view no \n\t\t\t\t\t\t\t\t\t\t//scrolling will be done. 0.5 is half of view, 1 is entire height of view\n\t\tconst distanceRatioCenteringTollerance=1;//if moving the cellcursor within this ratio, but outside of \n\t\t\t\t\t//distanceRatioDeadzone then minimum scrolling will occur only to get within distanceRatioDeadzone\n\t\tconst scrollPos=this._scrollBody.scrollTop;\n\t\tconst scrollHeight=this._scrollBody.offsetHeight;\n\t\tconst cursorY=parseInt(this._cellCursor.style.top);\n\t\tconst cursorHeight=this._cellCursor.offsetHeight;\n\t\tconst distanceFromCenter=cursorY+cursorHeight/2-scrollPos-scrollHeight/2;\n\t\tconst distanceFromCenterRatio=Math.abs(distanceFromCenter/scrollHeight);\n\t\tif (distanceFromCenterRatio>distanceRatioDeadzone/2) {\n\t\t\tif (distanceFromCenterRatio>distanceRatioCenteringTollerance/2)\n\t\t\t\tthis._scrollBody.scrollTop=cursorY-scrollHeight/2+this._rowHeight/2;\n\t\t\telse\n\t\t\t\tthis._scrollBody.scrollTop=cursorY-scrollHeight/2+cursorHeight/2\n\t\t\t\t\t\t\t\t+(distanceFromCenter<0?1:-1)*scrollHeight*distanceRatioDeadzone/2;\n\t\t}\n\t\t//need to call this manually so that elements that are expected to exist after scroll are guaranteed to do so.\n\t\t//changing this._scrollBody.scrollTop actually calls this method anyway but not until all other code as hun.\n\t\t//This will cause it to run it twice but it's not a big deal.\n\t\tthis._scrollMethod();\n\t}\n\n\t_expandRow(tr,animate=true) {\n\t\tconst dataRowIndex=parseInt(tr.dataset.dataRowIndex);\n\t\tif (!this._schema.details||this._rowMetaGet(dataRowIndex)?.h>0)\n\t\t\treturn;\n\t\tconst expRow=this._renderDetails(tr,dataRowIndex);\n\t\tconst expHeight=this._rowMetaSet(dataRowIndex,\"h\",this._rowHeight+expRow.offsetHeight+this._borderSpacingY);\n\t\tconst contentDiv=expRow.querySelector(\".content\");\n\t\tif (!this._detailsBordersHeight)//see declarataion of _detailsTopBottomBorderWidth\n\t\t\tthis._detailsBordersHeight=expHeight-contentDiv.offsetHeight;\n\t\tthis._tableSizer.style.height=parseInt(this._tableSizer.style.height)//adjust scroll-height reflect change...\n\t\t\t+expHeight-this._rowHeight+\"px\";//...in height of the table\n\t\tif (animate) {\n\t\t\tthis._unsortCol(null,\"expand\");\n\t\t\tcontentDiv.style.transition=\"\";\n\t\t\tcontentDiv.style.height=\"0px\";//start at 0\n\t\t\tsetTimeout(()=>contentDiv.style.height=expHeight-this._detailsBordersHeight+\"px\");\n\t\t\tthis._animate(()=>this._adjustCursorPosSize(this._selectedCell,true),500,\"cellCursor\");\n\t\t} else {\n\t\t\tcontentDiv.style.transition=\"none\";\n\t\t\tcontentDiv.style.height=expHeight-this._detailsBordersHeight+\"px\";\n\t\t}\n\t\treturn expHeight;\n\t}\n\n\t_contractRow(tr) {\n\t\tif (tr.classList.contains(\"details\"))\n\t\t\ttr=tr.previousSibling;\n\t\tconst dataRowIndex=parseInt(tr.dataset.dataRowIndex);\n\t\tif (dataRowIndex==this._mainRowIndex&&this._activeDetailsCell)\n\t\t\tthis._exitEditMode(false);//cancel out of edit-mode so field-validation doesn't cause problems\n\t\tif (!this._schema.details||!this._rowMetaGet(dataRowIndex)?.h)\n\t\t\treturn;\n\t\tthis._unsortCol(null,\"expand\");\n\t\tif (this._mainRowIndex==dataRowIndex&&this._activeDetailsCell) {//if cell-cursor is inside the details\n\t\t\tthis._selectMainTableCell(tr.cells[this._mainColIndex]);//then move it out\n\t\t\tthis._scrollToCursor();\n\t\t}\n\t\tconst contentDiv=tr.nextSibling.querySelector(\".content\");\n\t\tif (contentDiv.style.height===\"auto\") {//if fully expanded\n\t\t\tcontentDiv.style.height=this._rowMetaGet(dataRowIndex).h-this._detailsBordersHeight+\"px\";\n\t\t\tsetTimeout(()=>contentDiv.style.height=0);\n\t\t} else if (parseInt(contentDiv.style.height)==0)//if previous closing-animation has reached 0 but transitionend \n\t\t//hasn't been called yet which happens easily, for instance by selecting expand-button and holding space/enter\n\t\t\tcontentDiv.dispatchEvent(new Event('transitionend'));\n\t\telse//if in the middle of animation, either expanding or contracting. make it head towards 0\n\t\t\tcontentDiv.style.height=0;\n\t\tthis._animate(()=>this._adjustCursorPosSize(this._selectedCell,true),500,\"cellCursor\");\n\t}\n\n\t_scrollElementIntoView(element) {\n\t\tif (!this._onlyDetails) {\n\t\t\tconst pos=this._getElPos(element);\n\t\t\tthis._scrollBody.scrollTop=pos.y+element.offsetHeight/2-this._scrollBody.offsetHeight/2;\n\t\t\tthis._scrollMethod();\n\t\t} else\n\t\t\tthis._tooltip.scrollIntoView({behavior:'smooth',block:\"center\"});\n\t}\n\n\t_applyVisibleIf(instanceNode,mainIndex) {\n\t\tconst schemaNode=instanceNode.schemaNode;\n\t\tlet val=this._getTargetVal(false,schemaNode,instanceNode);\n\t\tif (schemaNode.input?.type===\"select\"&&val?.value)\n\t\t\tval=val.value;\n\t\n\t\tinstanceNode.hidden = !!instanceNode.hidden;\n\t\n\t\t//the !! is needed or else undefined will be treated the same as true\n\t\tif (!!schemaNode.visibleIf(val,instanceNode.dataObj,schemaNode,mainIndex,instanceNode) == instanceNode.hidden) {\n\t\t\tinstanceNode.hidden=!instanceNode.hidden;\n\t\t\tinstanceNode.outerContainerEl.style.display=instanceNode.hidden?\"none\":\"\";\n\t\t}\n\t\n\t\treturn !instanceNode.hidden;\n\t}\n}\n"],"names":["SCHEMA_WRAPPER_MARKER","Symbol","SCHEMA_WRAPPER_KEYS","Set","TablanceBase","hostEl","rootEl","neighbourTables","_containerHeight","_containerWidth","_colSchemaNodes","_cols","_headerTr","_headerTable","_allData","_data","_scrollRowIndex","_scrollBody","_scrollingContent","_scrollMarginPx","_tableSizer","_mainTable","_mainTbody","_bulkEditArea","_bulkEditTable","_bulkEditAreaOpen","_bulkEditSchemaNodes","_bulkEditAreaHeightPx","_numberOfRowsSelectedSpan","_borderSpacingY","_rowHeight","_rowInnerHeight","_staticRowHeight","_spreadsheet","_opts","_sortingCols","_searchInput","_filter","_cellCursor","_mainRowIndex","_mainColIndex","_activeSchemaNode","_cellCursorDataObj","_selectedCellVal","_selectedCell","_inEditMode","_inputVal","_highlightOnFocus","_detailsBordersHeight","_scrollMethod","_rowsMeta","keys","vals","_filesMeta","_selectedRows","_scrollY","_numRenderedRows","_openDetailsPanes","_activeDetailsCell","_ignoreClicksUntil","_highlightRowsOnView","_lastCheckedIndex","_numRowsSelected","_numRowsInViewSelected","_animations","_onlyDetails","_tooltip","_dropdownAlignmentContainer","constructor","schema","staticRowHeight","spreadsheet","opts","this","document","createElement","appendChild","classList","add","_schema","_buildSchemaFacade","main","columns","searchbar","_setupSearchbar","_createTableHeader","_createTableBody","ResizeObserver","_updateSizesOfViewportAndCols","bind","observe","_setupSpreadsheet","sortAscHtml","sortDescHtml","sortNoneHtml","_updateHeaderSortHtml","_buildDependencyGraph","_createBulkEditArea","addData","data","highlight","_setDataForOnlyDetails","oldLen","length","value","concat","sortingOccured","_sortData","_filterData","_refreshTable","_maybeAddTrs","numNewInData","style","height","parseInt","dataRow","_highlightRowIndex","indexOf","scrollToDataRow","updateData","dataRow_or_mainIndex","dataPath","newData","scrollTo","onlyRefresh","mainIndx","updatedEls","isNaN","split","dataPortion","i","key","replace","colSchemaNode","colI","id","tr","querySelector","_updateMainRowCell","cells","nodeToUpdate","instanceNodeId","arrayIndex","_findDescendantInstanceNodeById","schemaNode","type","children","entry","entryI","create","_deleteCell","dataObj","parent","forEach","dataEntry","push","_repeatInsert","at","_updateDetailsCell","el","scrollIntoView","behavior","block","_highlightElements","getElementsByTagName","_adjustCursorPosSize","rawNode","parentWrappedNode","proto","Object","getPrototypeOf","prototype","Array","isArray","wrappedNode","newWrapper","assign","raw","Proxy","get","target","prop","has","set","Error","createSchemaNodeFacade","details","cols","col","wrappedCol","entries","arr","child","wrappedChild","_closestMeta","startNode","metaKey","node","meta","searchInObj","idToFind","result","expandRow","mainIndex","_expandRow","smooth","scrollY","otherDataRow","offsetHeight","top","_rowMetaGet","h","chainTables","otherTablances","tablances","sort","a","b","elA","container","elB","parentElement","contains","commonCont","from","tablance","up","down","selectTopBottomCellOnlyDetails","_selectFirstSelectableDetailsCell","ctx","_dep_pass1_assignAutoIdsAndMaps","_dep_pass2_assignPathsAndData","_dep_pass3_resolveDependencies","_dep_pass4_cleanup","wrappedSchema","autoIdCounter","explicitIdToAutoId","implicitIdToAutoId","schemaNodeByAutoId","seenCellIds","roots","initialRoots","stack","pop","autoId","_autoId","cellId","_dep_children","autoIdByName","_dep_assignPathsAndData","uiPath","parentCtx","_path","myCtx","dataPathArr","String","filter","Boolean","_dataContextPath","_dataPath","kids","dependsOn","deps","dependentIsExp","cellPaths","dataPaths","depName","depAutoId","console","warn","dependee","dependeeIsExp","fwd","_dep_computeForwardPath","dependencyPaths","rev","_dep_computeReversePath","_dep_finalizeDependency","dependent","to","common","fill","slice","dependsOnCellPaths","dependsOnDataPath","_updateViewportHeight","clientHeight","_attachInputFormatter","format","_normalizeInputFormat","numericOnly","addEventListener","e","test","preventDefault","setAttribute","delimiter","pos","selectionStart","setSelectionRange","dispatchEvent","Event","apply","_applyInputFormatting","date","undefined","blocks","_formatDateValue","out","delim","part","digits","y","m","mm","Math","min","max","padStart","d","dd","Date","getDate","className","placeholder","lang","filterPlaceholder","_onSearchInput","_e","onlyDetails","display","borderSpacing","_spreadsheetOnFocus","_spreadsheetOnBlur","tabIndex","_spreadsheetKeyDown","_spreadsheetMouseDown","_enterCell","dataIndex","_rowMetaSet","val","linkIndex","splice","tabbedTo","_selectMainTableCell","rows","removeProperty","outline","_scrollToCursor","setTimeout","activeElement","_moveCellCursor","hSign","vSign","_exitEditMode","_moveInsideLineup","newColIndex","_selectAdjacentDetailsCell","numCols","numRows","currentCellX","offsetLeft","currCelTop","offsetTop","currCelBottom","nextCel","index","offsetParent","_selectDetailsCell","closestCell","closestCellX","siblings","otherCell","abs","instanceNode","isGoingDown","cell","_getAdjacentDetailsCell","nextTable","sibling","hidden","niece","_getFirstSelectableDetailsCell","onlyGetChild","newInstanceNode","startI","chosenCell","childI","select","visibility","input","ctrlKey","stopPropagation","shiftKey","code","_groupEscape","closest","_contractRow","requestAnimationFrame","_toggleRowExpanded","_rowCheckboxChange","endsWith","_insertAtCursor","myField","myValue","selection","focus","createRange","text","startPos","endPos","selectionEnd","substring","_unsortCol","sortCol","_renderDetails","rowIndex","detailsRow","insertRow","dataset","dataRowIndex","detailsCell","insertCell","colSpan","detailsDiv","_detailsAnimationEnd","_generateDetailsContent","currentTarget","detailsTr","mainTr","previousSibling","remove","parentEl","path","rowData","_notYetCreated","notYetCreated","scopedRowData","visibleIf","_applyVisibleIf","_generateDetailsList","_generateField","_generateDetailsGroup","_generateDetailsRepeated","_generateDetailsLineup","_repeatedOnDelete","cel","onDelete","_fileOnDelete","strct","fileCell","inputSchemaNode","fileInputSchemaNode","fileTd","innerHTML","deleteHandler","_onOpenCreationGroup","groupObject","repeatedSchemaNode","repeatData","insertionPoint","createComment","_generateRepeatedCreator","repeatedObj","creationTxt","creationText","insertNew","creationSchemaNode","closedRender","creator","onOpen","cssClass","wrappedCreationSchemaNode","_beginDeleteRepeated","creating","containerEl","_cancelDelete","_schemaCopyWithDeleteButton","deleteControls","onBlur","selEl","btnText","deleteText","delete","clickHandler","areYouSureNoText","deleteAreYouSureNo","title","deleteAreYouSureText","deleteAreYouSure","areYouSureYesText","deleteAreYouSureYes","parentWrapped","clonedEntries","clonedNode","_generateButton","btn","groupSchemaNode","groupTable","tbody","join","_generateDetailsCollection","renderRow","innerText","listSchemaNode","listTable","titlesColWidth","titlesCol","width","lineupSchemaNode","containerSchemaNode","collectionObj","childSchemaNode","rptCelObj","_generateCollectionItem","_buildCollectionItemDOM","collection","itemObj","outerContainerEl","td","toggle","nonEmptyDescentants","grpTr","_insertCollectionItem","collectionOrRepeated","collectionEl","siblingAfter","next","nextSibling","base","beforeEl","insertBefore","_changeInstanceNodeIndex","fieldSchemaNode","now","which","interactiveEl","step","preventScroll","shift","checked","_toggleRowsSelected","fromIndex","toIndex","_updateNumRowsSelectionState","_updateBulkEditAreaCells","checkbox","indeterminate","_animate","Infinity","func","runForMs","runUntil","animations","frame","_autoTextAreaResize","maxHeight","scrollHeight","_updateDetailsHeight","contentDiv","mainRowIndex","prevRowHeight","newRowHeight","_openDateEdit","pika","pikaContainer","window","Pikaday","field","toString","getFullYear","getMonth","onClose","destroy","firstDay","showWeekNumber","defaultDate","setDefaultDate","i18n","previousMonth","nextMonth","months","weekdays","weekdaysShort","_alignDropdown","onDraw","position","KeyboardEvent","inputVal","setDate","datePlaceholder","dropdown","alignmentContainer","alignmentPos","_getElPos","viewportPos","scrollTop","clientWidth","x","offsetWidth","left","click","textarea","_openTextAreaEdit","_openSelectEdit","file","_openFileEdit","_openTextEdit","call","_openGroup","groupObj","doOpen","onOpenAfter","_closeGroup","_closeRepeatedInsertion","updateRenderOnClose","renderText","repeated","entrySchemaNode","indexOfNew","sortCompare","root","entryNode","newObj","onCreateOpen","newIndex","level","pathEl","querySelectorAll","fixObjPath","programatically","newSelectedCell","onCreateCancel","maxLength","_mapAdd","map","_mapGet","_mapRemove","getSelection","empty","fileDiv","fileInput","fileChooseOrDrag","dropDiv","fileDropToUpload","handleFile","_processFileUpload","startsWith","dataTransfer","files","uploadedBytes","bars","xhr","useFakeFileUploadTest","FakeXMLHttpRequest","totalBytes","size","rate","fakeUploadRate","startAt","fakeUploadStartAt","XMLHttpRequest","updateProgressBars","loaded","total","bar","isConnected","pct","firstChild","finalizeUpload","fileUploadDone","upload","fileUploadHandler","formData","FormData","append","send","paddingLeft","paddingRight","paddingTop","paddingBottom","getComputedStyle","_renderSelectOptions","ul","selectedVal","foundSelected","opt","li","highlightLiIndex","highlightUlIndex","ulIndex","_highlightSelectOption","liIndex","keyboardNavigating","highlighted","ulDiv","getElementsByClassName","_handleSelectInputChange","hadFilter","filterText","filterChangedAtEdges","includes","canCreate","looseOpts","strctInp","options","pinned","toLowerCase","_updateCreateOptionVisibility","mainUl","pinnedUl","noResults","creationLi","removeChild","_handleSelectKeyDown","direction","_closeSelectDropdown","_handleSelectMouseMove","parentNode","_handleSelectClick","_createSelectDropdownContext","selectContainer","pinnedOpts","inputWrapper","noResultsText","selectNoResultsFound","windowMouseDown","createNewOptionHandler","removeEventListener","backgroundColor","allowCreateNew","minOptsFilter","defaultMinOptsFilter","selectInputPlaceholder","_validateInput","newVal","message","validation","_showTooltip","_updateDependentCells","editedCellSchemaNode","editedInstanceNode","depPath","newCells","cellI","save","stripDelimiterOnSave","replaceAll","_doEditSave","_scrollElementIntoView","repeatEntry","values","doCreate","creationValidation","creationContainer","repeatedContainer","dataContext","payload","newDataItem","dataArray","dataKey","itemIndex","bulkEdit","closestMeta","cancelCreate","onCreate","_closeActiveDetailsCell","oldCellParent","cellIndex","_selectCell","oldExpCell","oldParnt","newParent","parentCell","cellEl","adjustCursorPosSize","noPtrEvent","pointerEvents","cellPos","getBoundingClientRect","contPos","onlyPos","elPos","thead","th","_onThClick","_createCheckbox","sortDiv","clickedIndex","tagName","_expandOrContractAll","sortingCol","sortingColIndex","order","expand","row","thIndex","sortCols","aV","aSel","_onScrollStaticRowHeightNoDetails","_onScrollStaticRowHeightDetails","passive","overflow","bulkContent","numberOfRowsSelectedDiv","pagesDiv","mainPage","tableContainer","bulkEditFields","_buildBulkEditSchemaNodes","column","bulkSchema","TablanceBulk","mainInstance","_isObject","schemaNodesToUpdateCellsFor","mixedText","multiCellSchemaNode","multiCellI","lastVal","mixed","rowI","_maybeRemoveTrs","_updateColsWidths","areaWidth","percentageWidthRegex","totalFixedWidth","numUndefinedWidths","pxWidth","sumFixedAndFlexibleWidth","parseFloat","filterString","colsToFilterBy","selectsOptsByVal","optsByVal","match","_refreshTableSizerNoDetails","replaceChildren","scrY","newScrollRowIndex","scrollSignum","sign","_updateRowValues","trToMove","lastChild","prepend","newScrY","topShift","_doRowScrollDetails","newMainIndex","oldMainIndex","detailsHeight","_lookForActiveCellInRow","unshift","_createExpandContractButton","preventClickSelect","_preventDefault","lastTr","scrH","dataLen","div","tdComputedStyle","selected","_humanFileSize","bytes","si","dp","thresh","units","u","r","round","toFixed","_generateFileCell","fileInstanceNode","fileSchemaNode","metaEntries","fileName","fileLastModified","render","toISOString","fileSize","fileType","metaName","metaI","fileMetasToShow","defaultFileMetasToShow","fileGroup","btnObj","openHandler","wrappedFileGroup","fileData","fileMeta","progressbarOuter","progressbarInner","transition","role","progressSpan","rootCell","oldCellContent","_updateCell","newCellContent","_getValueByPath","obj","cur","_resolveCellPaths","baseCell","_getTargetVal","idOverDependee","selOptObj","find","isDisabled","enabledFuncResult","enabled","html","elements","origColors","parsedRate","pctPerSecond","parsedStart","startPercent","_listeners","_uploadListeners","fn","_addListener","open","setRequestHeader","abort","_clearTimer","_emit","progress","Promise","resolve","then","load","_timer","setInterval","listeners","event","clearInterval","super","arguments","selectedRow","selectedTr","Tablance","static","doUpdate","onChange","newValue","oldValue","cancelUpdate","scrollPos","cursorY","cursorHeight","distanceFromCenter","distanceFromCenterRatio","distanceRatioDeadzone","distanceRatioCenteringTollerance","animate","expRow","expHeight","element"],"mappings":"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"}